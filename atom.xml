<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Obito Blog</title>
  
  
  <link href="http://www.obito.top/atom.xml" rel="self"/>
  
  <link href="http://www.obito.top/"/>
  <updated>2024-12-26T08:48:58.901Z</updated>
  <id>http://www.obito.top/</id>
  
  <author>
    <name>Obito</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æœ¬åœ°å®‰è£…MySQLæ•°æ®åº“ä»¥åŠåœ¨Qtä¸­çš„ä½¿ç”¨</title>
    <link href="http://www.obito.top/2024/12/26/%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BB%A5%E5%8F%8A%E5%9C%A8Qt%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://www.obito.top/2024/12/26/%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BB%A5%E5%8F%8A%E5%9C%A8Qt%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2024-12-26T08:47:21.000Z</published>
    <updated>2024-12-26T08:48:58.901Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æœ¬åœ°å®‰è£…mysqlæ•°æ®åº“ä»¥åŠåœ¨qtä¸­çš„ä½¿ç”¨">æœ¬åœ°å®‰è£…MySQLæ•°æ®åº“ä»¥åŠåœ¨Qtä¸­çš„ä½¿ç”¨</h1><h2 id="æœ¬åœ°å®‰è£…-mysql-è¿‡ç¨‹">æœ¬åœ°å®‰è£… MySQL è¿‡ç¨‹</h2><h3 id="1-å®‰è£…-mysql">1. å®‰è£… MySQL</h3><p>ä¸‹è½½åœ°å€ï¼š</p><blockquote><p>MySQL å®˜ç½‘ï¼š<a href="https://dev.mysql.com/downloads/mysql/">https://dev.mysql.com/downloads/mysql/</a></p></blockquote><p>Windows å¯ä»¥é€‰æ‹©ä¸¤ç§ï¼šmsi å’Œ zipï¼Œä»¥ä¸‹è¿‡ç¨‹æ˜¯ zip æ–¹æ³•ï¼š</p><h3 id="2-æ–°å»ºé…ç½®æ–‡ä»¶">2. æ–°å»ºé…ç½®æ–‡ä»¶</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># è®¾ç½®3306ç«¯å£</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"><span class="comment"># è®¾ç½®mysqlçš„å®‰è£…ç›®å½•   ----------æ˜¯ä½ çš„æ–‡ä»¶è·¯å¾„-------------</span></span><br><span class="line"><span class="attr">basedir</span>=H:\mysql-<span class="number">9.1</span>.<span class="number">0</span>-winx64</span><br><span class="line"><span class="comment"># è®¾ç½®mysqlæ•°æ®åº“çš„æ•°æ®çš„å­˜æ”¾ç›®å½•  ---------æ˜¯ä½ çš„æ–‡ä»¶è·¯å¾„dataæ–‡ä»¶å¤¹è‡ªè¡Œåˆ›å»º</span></span><br><span class="line"><span class="comment"># è®¾ç½® mysqlæ•°æ®åº“çš„æ•°æ®çš„å­˜æ”¾ç›®å½•ï¼ŒMySQL 8+ ä¸éœ€è¦ä»¥ä¸‹é…ç½®ï¼Œç³»ç»Ÿè‡ªå·±ç”Ÿæˆå³å¯ï¼Œå¦åˆ™æœ‰å¯èƒ½æŠ¥é”™</span></span><br><span class="line"><span class="comment">#datadir=H:\mysql-9.1.0-winx64\data</span></span><br><span class="line"><span class="comment"># å…è®¸æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line"><span class="attr">max_connections</span>=<span class="number">200</span></span><br><span class="line"><span class="comment"># å…è®¸è¿æ¥å¤±è´¥çš„æ¬¡æ•°ã€‚</span></span><br><span class="line"><span class="attr">max_connect_errors</span>=<span class="number">10</span></span><br><span class="line"><span class="comment"># æœåŠ¡ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†é»˜è®¤ä¸ºutf8mb4</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8mb4</span><br><span class="line"><span class="comment"># åˆ›å»ºæ–°è¡¨æ—¶å°†ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨å¼•æ“</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=INNODB</span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="comment"># è®¾ç½®mysqlå®¢æˆ·ç«¯é»˜è®¤å­—ç¬¦é›†</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8mb4</span><br><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="comment"># è®¾ç½®mysqlå®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯æ—¶é»˜è®¤ä½¿ç”¨çš„ç«¯å£</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8mb4</span><br></pre></td></tr></table></figure><h3 id="3-åˆå§‹åŒ–-mysql-æ•°æ®åº“">3. åˆå§‹åŒ–  MySQL æ•°æ®åº“</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">H:\mysql-9.1.0-winx64\bin&gt;mysqld --initialize --console</span><br><span class="line">2024-12-25T07:24:13.742985Z 0 [System] [MY-015017] [Server] MySQL Server Initialization - start.</span><br><span class="line">2024-12-25T07:24:13.747449Z 0 [System] [MY-013169] [Server] H:\mysql-9.1.0-winx64\bin\mysqld.exe (mysqld 9.1.0) initializing of server in progress as process 18948</span><br><span class="line">2024-12-25T07:24:13.761946Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.</span><br><span class="line">2024-12-25T07:24:13.938955Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.</span><br><span class="line">2024-12-25T07:24:15.411887Z 6 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: -M6xjww6A:jl</span><br><span class="line">2024-12-25T07:24:17.307449Z 0 [System] [MY-015018] [Server] MySQL Server Initialization - end.</span><br></pre></td></tr></table></figure><p>å…ˆå¤åˆ¶å¥½è¿™ä¸ªåˆå§‹åŒ–å¯†ç ï¼šM6xjww6A:jl</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2024-12-25T07:24:15.411887Z 6 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: -M6xjww6A:jl</span><br></pre></td></tr></table></figure><p>å¦‚æœå·²ç»åˆå§‹åŒ–åˆ é™¤ data ç›®å½•é‡æ–°åˆå§‹åŒ–å³å¯ã€‚</p><h4 id="4-å®‰è£…-mysql-æœåŠ¡å¹¶å¯åŠ¨">4. å®‰è£… MySQL æœåŠ¡å¹¶å¯åŠ¨</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --install mysql</span><br></pre></td></tr></table></figure><h4 id="5-å¯åŠ¨-mysql-æœåŠ¡">5. å¯åŠ¨ MySQL æœåŠ¡</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net start mysql</span><br></pre></td></tr></table></figure><h4 id="6-è¿æ¥-mysql">6. è¿æ¥ MySQL</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u ç”¨æˆ·å -p</span><br></pre></td></tr></table></figure><p>é¦–æ¬¡ç™»å½•ï¼šå›è½¦åè¾“å…¥åˆå§‹åŒ–åŒ–å¯†ç å³å¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">H:\mysql-9.1.0-winx64\bin&gt;mysql -uroot -p</span><br><span class="line">Enter password: ************</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 10</span><br><span class="line">Server version: 9.1.0</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2024, Oracle and/or its affiliates.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br></pre></td></tr></table></figure><h4 id="7-ä¿®æ”¹å¯†ç ">7. ä¿®æ”¹å¯†ç </h4><p>è¿æ¥å®Œæˆåæ‰èƒ½ä¿®æ”¹å¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;æ–°å¯†ç &#x27;;</span><br></pre></td></tr></table></figure><h4 id="8-æ–­å¼€è¿æ¥">8. æ–­å¼€è¿æ¥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">quit </span><br><span class="line">or</span><br><span class="line">exit</span><br></pre></td></tr></table></figure><h4 id="9-å¸¸ç”¨å‘½ä»¤">9. å¸¸ç”¨å‘½ä»¤</h4><p><strong>å‘½ä»¤åè®°å¾—åŠ ä¸Šåˆ†å·ã€‚</strong></p><p>æ˜¾ç¤ºæ•°æ®åº“åˆ—è¡¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show databases; </span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ•°æ®åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database database_name;</span><br></pre></td></tr></table></figure><p>å»ºè¡¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table table_name(value_name value_form, value_name value_form, ...);</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¡¨å­—èŠ‚æ®µï¼ˆæŸ¥çœ‹å€¼çš„å±æ€§ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc table_name;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¡¨ä¸­å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from table_name;</span><br></pre></td></tr></table></figure><h4 id="10-ä¿®æ”¹ä¸ºæ‰‹åŠ¨å¯åŠ¨">10. ä¿®æ”¹ä¸ºæ‰‹åŠ¨å¯åŠ¨</h4><p><img src="image-20241226162111749.png" alt="image-20241226162111749"></p><h2 id="qt-ä½¿ç”¨">Qt ä½¿ç”¨</h2><h3 id="1-ç¼–è¯‘é©±åŠ¨">1. ç¼–è¯‘é©±åŠ¨</h3><p>MySQL å®‰è£…å®Œæˆä¹‹åï¼Œå°† <code>H:\mysql-9.1.0-winx64\lib</code> ä¸‹çš„ <code>libmysql.dll</code> æ–‡ä»¶å¤åˆ¶ç²˜è´´åˆ°å¯¹åº”çš„ Qt å®‰è£…ç›®å½•ä¸‹çš„ <code>C:\Qt\Qt5.14.2\5.14.2\mingw73_64\bin</code> ï¼Œçœ‹ä½ ç”¨ä»€ä¹ˆç¼–è¯‘å™¨ï¼Œå¦å¤–éœ€è¦æ³¨æ„ MySQL å’Œç¼–è¯‘å™¨çš„ä½æ•°è¦ç›¸åŒã€‚</p><p><img src="image-20241225163213239.png" alt="image-20241225163213239"></p><p>pro æ–‡ä»¶ä¸­æ·»åŠ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QT       += sql</span><br></pre></td></tr></table></figure><p>è¿æ¥æ•°æ®åº“å¾—ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">chart::connect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿æ¥æ•°æ®åº“</span></span><br><span class="line">    db = QSqlDatabase::<span class="built_in">addDatabase</span>(<span class="string">&quot;QMYSQL&quot;</span>, <span class="string">&quot;connection&quot;</span>); <span class="comment">// éœ€è¦ä½¿ç”¨çš„æ•°æ®åº“é©±åŠ¨å’Œè”æ£€å»ºç«‹çš„åç§°</span></span><br><span class="line">    db.<span class="built_in">setHostName</span>(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">    db.<span class="built_in">setUserName</span>(<span class="string">&quot;root&quot;</span>); <span class="comment">// æ•°æ®åº“ç”¨æˆ·    // ä¿®æ”¹</span></span><br><span class="line">    db.<span class="built_in">setPassword</span>(<span class="string">&quot;123456&quot;</span>);   <span class="comment">// ç”¨æˆ·å¯†ç  // ä¿®æ”¹</span></span><br><span class="line">    db.<span class="built_in">setDatabaseName</span>(<span class="string">&quot;student&quot;</span>);  <span class="comment">// éœ€è¦ç”¨åˆ°çš„æ•°æ®åº“ // ä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">if</span>(!db.<span class="built_in">open</span>()) &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;open failed...&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;open successfully...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿æ¥æ—¶å‘ç°å‡ºç°é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QSqlDatabase: QMYSQL driver not loaded</span><br><span class="line">QSqlDatabase: available drivers: QSQLITE QODBC QODBC3 QPSQL QPSQL7</span><br><span class="line">open failed...</span><br><span class="line">QSqlQuery::exec: database not open</span><br><span class="line">QSqlQuery::prepare: database not open</span><br><span class="line">QSqlError(&quot;&quot;, &quot;Driver not loaded&quot;, &quot;Driver not loaded&quot;)</span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯ï¼šæœªèƒ½åŠ è½½ QMYSQL é©±åŠ¨</p><blockquote><p>ä½¿ç”¨ Qt sql æ¨¡å—æ¥æ“ä½œ MySQL æ•°æ®åº“ï¼Œéœ€è¦ä¸‰ä¸ªåº“æ–‡ä»¶æ¥æ”¯æŒï¼Œåˆ†åˆ«ä¸ºï¼š<code>libmysql.dll</code>ã€<code>qsqlmysql.dll</code> å’Œ <code>qsqlmysqld.dll</code> ï¼Œä¸‰ä¸ªæ–‡ä»¶ç¼ºä¸€ä¸å¯ã€‚</p><p><a href="https://www.cnblogs.com/bluejade/p/18556703">QT5.15.2 è¿æ¥MySQL é©±åŠ¨é—®é¢˜è§£å†³æ–¹æ¡ˆ,æ— è®ºèœé¸ŸğŸ¦ï¸è¿˜æ˜¯è€é¸ŸğŸ¦œï¼Œè§£å†³äº†å°±æ˜¯å¥½é¸ŸğŸ¦š - bluejade2024 - åšå®¢å›­ (cnblogs.com)</a></p></blockquote><p>å¥½åƒæ˜¯ä½ç‰ˆæœ¬ Qt æ²¡æœ‰ç¼–è¯‘ mysql é©±åŠ¨ï¼Œæ‰€ä»¥ <code>C:\Qt\Qt5.14.2\5.14.2\mingw73_64\plugins\sqldrivers</code> ç›®å½•ä¸‹æ²¡æœ‰ <code>qsqlmysql.dll</code>å’Œ <code>qsqlmysqld.dll</code>ï¼Œåªæœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–‡ä»¶ï¼š</p><p><img src="image-20241225160615720.png" alt="image-20241225160615720"></p><p>æ‰€ä»¥éœ€è¦æ‰‹åŠ¨è¿›è¡Œç¼–è¯‘ï¼Œæ‰“å¼€ <code>C:\Qt\Qt5.14.2\5.14.2\Src\qtbase\src\plugins\sqldrivers\mysql</code> çš„ <a href="http://mysql.pro">mysql.pro</a> å·¥ç¨‹ï¼Œè¿›è¡Œä»¥ä¸‹ä¸€äº›ä¿®æ”¹ï¼š</p><p>ä¿®æ”¹ <code>qsqldriverbase.pri</code> æ–‡ä»¶ï¼š</p><p><img src="image-20241225161526609.png" alt="image-20241225161526609"></p><p>ä¿®æ”¹ <code>mysql.pro</code> æ–‡ä»¶ï¼š</p><p><img src="image-20241225162047205.png" alt="image-20241225162047205"></p><p>æ¥ç€å°±å¯ä»¥ç¼–è¯‘äº†ï¼Œç¼–è¯‘åå¾—åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š</p><p><img src="image-20241225162130818.png" alt="image-20241225162130818"></p><p>å°†è¿™ä¸¤ä¸ªæ–‡ä»¶å¤åˆ¶ç²˜è´´åˆ° <code>C:\Qt\Qt5.14.2\5.14.2\mingw73_64\plugins\sqldrivers</code> ç›®å½•ä¸‹å³å¯ã€‚</p><h3 id="2-é…ç½®qté¡¹ç›®">2. é…ç½®Qté¡¹ç›®</h3><p>.pro å·¥ç¨‹æ–‡ä»¶æ·»åŠ ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QT       += sql</span><br></pre></td></tr></table></figure><p>æ·»åŠ å¤´æ–‡ä»¶ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QSqlDatabase&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QSqlQuery&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QSqlError&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QMessageBox&gt;</span><span class="comment">// è°ƒè¯•ä½¿ç”¨</span></span></span><br></pre></td></tr></table></figure><h3 id="3-è¿æ¥mysqlæ•°æ®åº“">3. è¿æ¥MySQLæ•°æ®åº“</h3><h4 id="3-1-åŠ è½½mysqlé©±åŠ¨">3. 1. åŠ è½½MySQLé©±åŠ¨</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•ä¸ªæ•°æ®åº“</span></span><br><span class="line">QSqlDatabase db = QSqlDatabase::<span class="built_in">addDatabase</span>(<span class="string">&quot;QMYSQL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤šä¸ªæ•°æ®åº“æŒ‡å®šåç§°</span></span><br><span class="line">QSqlDatabase db = QSqlDatabase::<span class="built_in">addDatabase</span>(<span class="string">&quot;QMYSQL&quot;</span>, <span class="string">&quot;æ•°æ®åº“çš„åç§°&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="3-2-è®¾ç½®æ•°æ®åº“è¿æ¥å‚æ•°">3.2. è®¾ç½®æ•°æ®åº“è¿æ¥å‚æ•°</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="built_in">setHostName</span>(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">db.<span class="built_in">setDatabaseName</span>(<span class="string">&quot;your_database_name&quot;</span>);</span><br><span class="line">db.<span class="built_in">setUserName</span>(<span class="string">&quot;your_username&quot;</span>);</span><br><span class="line">db.<span class="built_in">setPassword</span>(<span class="string">&quot;your_password&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="3-3-æ‰“å¼€æ•°æ®åº“è¿æ¥">3.3. æ‰“å¼€æ•°æ®åº“è¿æ¥</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!db.<span class="built_in">open</span>()) &#123;</span><br><span class="line">     QMessageBox::<span class="built_in">critical</span>(<span class="literal">nullptr</span>, <span class="string">&quot;Database Error&quot;</span>, db.<span class="built_in">lastError</span>().<span class="built_in">text</span>());</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-æ•°æ®åº“æ“ä½œ">4. æ•°æ®åº“æ“ä½œ</h3><h4 id="4-1-æ’å…¥æ•°æ®-å¢">4.1. æ’å…¥æ•°æ®ï¼ˆå¢ï¼‰</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!query.<span class="built_in">exec</span>(<span class="string">&quot;INSERT INTO your_table (column1, column2) VALUES (&#x27;value1&#x27;, &#x27;value2&#x27;)&quot;</span>)) &#123;</span><br><span class="line">     QMessageBox::<span class="built_in">critical</span>(<span class="literal">nullptr</span>, <span class="string">&quot;Insert Error&quot;</span>, query.<span class="built_in">lastError</span>().<span class="built_in">text</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-åˆ é™¤æ•°æ®-åˆ ">4.2. åˆ é™¤æ•°æ®ï¼ˆåˆ ï¼‰</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!query.<span class="built_in">exec</span>(<span class="string">&quot;DELETE FROM your_table WHERE column1 = &#x27;some_value&#x27;&quot;</span>)) &#123;</span><br><span class="line"> QMessageBox::<span class="built_in">critical</span>(<span class="literal">nullptr</span>, <span class="string">&quot;Delete Error&quot;</span>, query.<span class="built_in">lastError</span>().<span class="built_in">text</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-æ›´æ–°æ•°æ®-æ”¹">4.3. æ›´æ–°æ•°æ®ï¼ˆæ”¹ï¼‰</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!query.<span class="built_in">exec</span>(<span class="string">&quot;UPDATE your_table SET column1 = &#x27;new_value&#x27; WHERE column2 = &#x27;some_value&#x27;&quot;</span>)) &#123;</span><br><span class="line"> QMessageBox::<span class="built_in">critical</span>(<span class="literal">nullptr</span>, <span class="string">&quot;Update Error&quot;</span>, query.<span class="built_in">lastError</span>().<span class="built_in">text</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-4-æŸ¥è¯¢æ•°æ®-æŸ¥">4.4. æŸ¥è¯¢æ•°æ®ï¼ˆæŸ¥ï¼‰</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">QSqlQuery query;</span><br><span class="line"><span class="keyword">if</span> (query.<span class="built_in">exec</span>(<span class="string">&quot;SELECT * FROM your_table&quot;</span>)) &#123;</span><br><span class="line"> <span class="keyword">while</span> (query.<span class="built_in">next</span>()) &#123;</span><br><span class="line">     QString data = query.<span class="built_in">value</span>(<span class="string">&quot;column_name&quot;</span>).<span class="built_in">toString</span>();</span><br><span class="line">     <span class="comment">// å¤„ç†æŸ¥è¯¢ç»“æœ</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     QMessageBox::<span class="built_in">critical</span>(<span class="literal">nullptr</span>, <span class="string">&quot;Query Error&quot;</span>, query.<span class="built_in">lastError</span>().<span class="built_in">text</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-ç¤ºä¾‹ä»£ç ">5. ç¤ºä¾‹ä»£ç </h4><p>ä¿®æ”¹æ•°æ®åº“åç§°å’Œè´¦å·å¯†ç ã€‚æ•°æ®åº“éœ€è¦å…ˆåœ¨å‘½ä»¤è¡Œåˆ›å»ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net start mysql</span><br><span class="line">mysql -u ç”¨æˆ·å -p</span><br><span class="line">create database test;</span><br></pre></td></tr></table></figure><p>æ¥ç€ä½¿ç”¨ä¸€ä¸‹ä»£ç è¿è¡Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QSqlDatabase&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QSqlQuery&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QSqlError&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QMessageBox&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">    QSqlDatabase db = QSqlDatabase::<span class="built_in">addDatabase</span>(<span class="string">&quot;QMYSQL&quot;</span>);</span><br><span class="line">    db.<span class="built_in">setHostName</span>(<span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">    db.<span class="built_in">setDatabaseName</span>(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    db.<span class="built_in">setUserName</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    db.<span class="built_in">setPassword</span>(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!db.<span class="built_in">open</span>()) &#123;</span><br><span class="line">        QMessageBox::<span class="built_in">critical</span>(<span class="literal">nullptr</span>, <span class="string">&quot;Database Error&quot;</span>, db.<span class="built_in">lastError</span>().<span class="built_in">text</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    QMessageBox::<span class="built_in">information</span>(<span class="literal">nullptr</span>, <span class="string">&quot;æ ‡é¢˜&quot;</span>, <span class="string">&quot;Open Sucessfully&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå®Œæˆå‡ºç°å¼¹çª—ï¼šOpen Sucessfullyï¼Œå³ä¸ºæˆåŠŸã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æœ¬åœ°å®‰è£…mysqlæ•°æ®åº“ä»¥åŠåœ¨qtä¸­çš„ä½¿ç”¨&quot;&gt;æœ¬åœ°å®‰è£…MySQLæ•°æ®åº“ä»¥åŠåœ¨Qtä¸­çš„ä½¿ç”¨&lt;/h1&gt;
&lt;h2 id=&quot;æœ¬åœ°å®‰è£…-mysql-è¿‡ç¨‹&quot;&gt;æœ¬åœ°å®‰è£… MySQL è¿‡ç¨‹&lt;/h2&gt;
&lt;h3 id=&quot;1-å®‰è£…-mysql&quot;&gt;1. å®‰è£… MySQL&lt;/h3&gt;
&lt;p&gt;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>é‡è£…ç³»ç»Ÿåé‡æ–°é…ç½®hexoå’Œdocsifyç¯å¢ƒ</title>
    <link href="http://www.obito.top/2024/12/21/%E9%87%8D%E8%A3%85%E7%B3%BB%E7%BB%9F%E5%90%8E%E9%87%8D%E6%96%B0%E9%85%8D%E7%BD%AEhexo%E5%92%8Cdocsify%E7%8E%AF%E5%A2%83/"/>
    <id>http://www.obito.top/2024/12/21/%E9%87%8D%E8%A3%85%E7%B3%BB%E7%BB%9F%E5%90%8E%E9%87%8D%E6%96%B0%E9%85%8D%E7%BD%AEhexo%E5%92%8Cdocsify%E7%8E%AF%E5%A2%83/</id>
    <published>2024-12-21T13:59:07.000Z</published>
    <updated>2024-12-24T09:24:05.709Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é‡è£…ç³»ç»Ÿåé‡æ–°é…ç½®hexoå’Œdocsifyç¯å¢ƒ">é‡è£…ç³»ç»Ÿåé‡æ–°é…ç½®hexoå’Œdocsifyç¯å¢ƒ</h1><h2 id="åºè¨€">åºè¨€</h2><p>ç”µè„‘é‡è£…ç³»ç»Ÿå hexo å’Œ docsify ç¯å¢ƒæ²¡äº†ï¼Œä½†è¿˜ç•™ç€ä¸¤ä¸ªç¯å¢ƒçš„æœ¬åœ°ç›®å½•ï¼Œå°±ä¸ç”¨é‡å¤´æ¥è¿‡äº†ï¼Œåªéœ€è¦é…ç½®ä¸€ä¸‹åŸºç¡€ç¯å¢ƒå°±å¯ä»¥ç»§ç»­ç©è€äº†ã€‚</p><h2 id="è¿‡ç¨‹">è¿‡ç¨‹</h2><h3 id="1-å®‰è£…-git-bash-å’Œ-node-js">1. å®‰è£… git bash å’Œ Node.js</h3><p>å®‰è£… git bashï¼š</p><blockquote><p><a href="https://git-scm.com/downloads/win">Git - Downloading Package (git-scm.com)</a></p></blockquote><p>å®‰è£… node.js</p><blockquote><p><a href="https://nodejs.org/zh-cn">Node.js â€” åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œ JavaScript (nodejs.org)</a></p></blockquote><p>æŸ¥çœ‹ç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v </span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure><p>npm æ¢é•œåƒæºï¼ˆé•œåƒæºæ‰¾æœ€æ–°å¯ç”¨çš„ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> registry https:<span class="comment">//registry.npmmirror.com</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://blog.csdn.net/qq_43940789/article/details/131449710">å›½å†…npmæºé•œåƒï¼ˆnpmåŠ é€Ÿä¸‹è½½ï¼‰ æŒ‡å®šnpmé•œåƒ_npm å›½å†…é•œåƒ-CSDNåšå®¢</a></p></blockquote><h3 id="2-å®‰è£…-hexo-å’Œ-docsify">2. å®‰è£… hexo å’Œ docsify</h3><p>å®‰è£… hexo ç¯å¢ƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™åœ¨åŸæ¥ç›®å½•å³å¯ä½¿ç”¨å‘½ä»¤è¿è¡Œé¢„è§ˆç½‘ç«™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo c &amp;&amp; hexo g &amp;&amp; hexo s</span><br></pre></td></tr></table></figure><p>å®‰è£… docsify ç¯å¢ƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i docsify-cli -g</span><br></pre></td></tr></table></figure><p>å¦‚æœåªæœ‰æ–‡æ¡£ä½†æ²¡æœ‰åŸæ¥ docsify çš„æ–‡ä»¶ï¼Œå°±éœ€è¦å…ˆåˆå§‹åŒ–ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docsify init ç›®å½•å</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–å®Œä¼šæœ‰ä¸‰ä¸ªé»˜è®¤æ–‡ä»¶ï¼š</p><ul><li>index.htmlï¼šç½‘ç«™å…¥å£æ–‡ä»¶</li><li><a href="http://README.md">README.md</a>ï¼šåšä¸ºä¸»é¡µå†…å®¹æ¸²æŸ“</li><li>.nojekyllï¼šç”¨äºé˜»æ­¢ GitHub Pages å¿½ç•¥æ‰ä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶</li></ul><p>åœ¨ç›®å½•ä¸‹æœ¬åœ°è¿è¡Œé¢„è§ˆç½‘ç«™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docsify serve</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ä¸¤ä¸ªæœ¬åœ°ç¯å¢ƒéƒ½æ­å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å®Œå–„ä¸€ä¸‹ git é…ç½®äº†ã€‚</p><h3 id="3-git-é…ç½®å’Œ-ssh">3. git é…ç½®å’Œ SSH</h3><p>git configï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;GitHubè´¦æˆ·å&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;GitHubæ³¨å†Œé‚®ç®±&quot;</span></span><br></pre></td></tr></table></figure><p>é…ç½® SSH KEYï¼Œåœ¨ <code>C:\Users\ç”¨æˆ·å\.ssh</code> ç›®å½•ä¸‹æ‰“å¼€ git bashï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">&quot;GitHubæ³¨å†Œé‚®ç®±&quot;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ cat å‘½ä»¤è¾“å‡º <code>id_rsa.pub</code> æ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> id_rsa.pub</span><br></pre></td></tr></table></figure><p>è¿›å…¥ GitHub ä¸»é¡µæ–°å»º SSH KEYï¼ŒKey ç²˜è´´ cat è¾“å‡ºå†…å®¹ã€‚</p><p>æµ‹è¯•æ˜¯å¦æˆåŠŸï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure><h3 id="4-é…ç½®è¿œç¨‹ä»“åº“">4. é…ç½®è¿œç¨‹ä»“åº“</h3><h4 id="4-1-hexo">4.1. hexo</h4><p>é˜²æ­¢è¯¯åˆ è¯·æå‰å¤‡ä»½ï¼åˆ é™¤æœ¬åœ°æ–‡ä»¶ä¸­çš„ <code>.deploy_git</code>ã€<code>.git</code>ã€<code>public</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf .deploy_git</span><br><span class="line"><span class="built_in">rm</span> -rf .git</span><br><span class="line"><span class="built_in">rm</span> -rf public</span><br></pre></td></tr></table></figure><p>å»ºç«‹æœ¬åœ°ä»“åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git remote add åˆ«å ä»“åº“git</span><br></pre></td></tr></table></figure><p>ç”±äºæ˜¯åˆæ¬¡å»ºç«‹ä»“åº“ï¼Œé»˜è®¤åˆ†æ”¯åæ˜¯ masterï¼Œå¦‚æœéœ€è¦æ”¹å˜åˆ†æ”¯åï¼Œéœ€è¦å…ˆéšä¾¿æäº¤ä¸€ä¸‹åˆå§‹åŒ–ä»“åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add .æˆ–è€…éšä¾¿æ–‡ä»¶</span><br><span class="line">git commit -m <span class="string">&quot;xxx&quot;</span></span><br></pre></td></tr></table></figure><p>ç”±äº hexo è‡ªå¸¦è‡ªåŠ¨éƒ¨ç½²ï¼Œä»¥åæ¯æ¬¡åªéœ€è¦ hexo d å°±å¯ä»¥è‡ªåŠ¨ä¸Šä¼ äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo c &amp;&amp; hexo g &amp;&amp; hexo d</span><br></pre></td></tr></table></figure><h4 id="4-2-docsify">4.2. docsify</h4><p>åˆ é™¤ <code>.git</code> ç›®å½•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf .git</span><br></pre></td></tr></table></figure><p>å»ºç«‹æœ¬åœ°ä»“åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git remote add åˆ«å ä»“åº“git</span><br></pre></td></tr></table></figure><p>ç”±äº docsfiy æ²¡æœ‰è‡ªåŠ¨éƒ¨ç½²ï¼Œæ‰€ä»¥æ¯æ¬¡ä¸Šä¼ éœ€è¦ä½¿ç”¨ git çš„åŸºæœ¬ä¸Šä¼ æµç¨‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;xxx&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;é‡è£…ç³»ç»Ÿåé‡æ–°é…ç½®hexoå’Œdocsifyç¯å¢ƒ&quot;&gt;é‡è£…ç³»ç»Ÿåé‡æ–°é…ç½®hexoå’Œdocsifyç¯å¢ƒ&lt;/h1&gt;
&lt;h2 id=&quot;åºè¨€&quot;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;ç”µè„‘é‡è£…ç³»ç»Ÿå hexo å’Œ docsify ç¯å¢ƒæ²¡äº†ï¼Œä½†è¿˜ç•™ç€ä¸¤ä¸ªç¯å¢ƒçš„æœ¬åœ°ç›®å½•ï¼Œå°±ä¸ç”¨é‡å¤´æ¥è¿‡äº†ï¼Œåªéœ€è¦é…</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Qt-Androidç¯å¢ƒæ­å»º</title>
    <link href="http://www.obito.top/2024/12/21/Qt-Android%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <id>http://www.obito.top/2024/12/21/Qt-Android%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</id>
    <published>2024-12-21T13:44:27.000Z</published>
    <updated>2024-12-21T13:44:59.528Z</updated>
    
    <content type="html"><![CDATA[<h1 id="qt-å®‰å“ç¯å¢ƒæ­å»º">Qt å®‰å“ç¯å¢ƒæ­å»º</h1><h2 id="åºè¨€">åºè¨€</h2><p>Qt å¼€å‘ Android éœ€è¦ jdkã€ndkã€sdk ä¸‰ä¸ªåŒ…ï¼Œå¹¶ä¸” Qt çš„ç‰ˆæœ¬è¦ä¸è¿™äº›åŒ…çš„ç‰ˆæœ¬å¯¹åº”ï¼Œå¦åˆ™ä¼šå‡ºç°ä¸€å †å¥‡æ€ªçš„ bugï¼Œæˆ‘çš„ç¯å¢ƒå¦‚ä¸‹ï¼š</p><ul><li>qt ç‰ˆæœ¬ï¼š5.14.2</li><li>JDKï¼š1.8.0_172</li><li>NDKï¼šr20b</li><li>SDKï¼š24.4.1</li></ul><p>å®‰è£…æ—¶æ³¨æ„å®‰è£…ç›®å½•ä¸èƒ½æœ‰ä¸­æ–‡ï¼Œè¿™ä¸€ç‚¹ä¸ç”¨å¤šè¯´ï¼Œç½‘ä¸Šæœ‰äº›è¯´ä¸èƒ½å¸¦ç©ºæ ¼ï¼Œä½†æˆ‘æ˜¯ç›´æ¥ä½¿ç”¨é»˜è®¤å®‰è£…ç›®å½•çš„ï¼Œè€Œé»˜è®¤ç›®å½•æ˜¯æœ‰ç©ºæ ¼çš„ï¼Œæ‰€ä»¥è¿™ä¸ªåº”è¯¥ä¸æ˜¯å¤§é—®é¢˜ï¼Œæœ€ç»ˆæˆ‘ä½¿ç”¨é»˜è®¤ç›®å½•ä¹Ÿå¯ä»¥æˆåŠŸã€‚</p><p>Qt å’Œ Android ç‰ˆæœ¬ä¾èµ–å…³ç³»ï¼š</p><blockquote><p><a href="https://doc.qt.io/qt-5/android-getting-started.html">Getting Started with Qt for Android | Qt 5.15</a></p></blockquote><p><img src="image-20241221181401964.png" alt="image-20241221181401964"></p><h2 id="æ­å»ºè¿‡ç¨‹">æ­å»ºè¿‡ç¨‹</h2><blockquote><p><a href="https://blog.51cto.com/u_15950551/6032388">Qt | Qt For Androidã€Qt5.14.2å®‰å“å¼€å‘ç¯å¢ƒæ­å»ºè¯¦ç»†æ­¥éª¤_è§‰çš‡ä¸ç§ƒå¤´çš„æŠ€æœ¯åšå®¢_51CTOåšå®¢</a></p></blockquote><h3 id="1-å®‰è£…-qt">1. å®‰è£… qt</h3><p>æˆ‘é€‰æ‹©çš„ç‰ˆæœ¬ä¸ºï¼š5.14.2ï¼Œå‹¾ä¸Š Android ç»„ä»¶ï¼Œå…¶ä»–æŒ‰éœ€é€‰æ‹©å³å¯ï¼Œ</p><p>ä¸‹è½½åœ°å€ï¼ˆè¿™ä¸ªå¯èƒ½éœ€è¦å¼€æ¢¯å­ï¼Œé•œåƒæºä¸­æ²¡æ‰¾åˆ°è¿™ä¸ªç‰ˆæœ¬ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥å¼€æ¢¯å­ä¸‹è½½äº†ï¼‰ï¼š</p><blockquote><p><a href="https://download.qt.io/archive/qt/5.14/5.14.2/">Index of /archive/qt/5.14/5.14.2</a></p></blockquote><h3 id="2-å®‰è£…-java-jdk">2. å®‰è£… JAVA JDK</h3><p>æˆ‘é€‰æ‹©çš„ç‰ˆæœ¬ä¸ºï¼šJDKï¼š1.8.0_172ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ä½¿ç”¨ exe ç¨‹åºå®‰è£…çš„ï¼Œå®‰è£…è¿‡ç¨‹ä¼šè‡ªåŠ¨é…ç½®ç¯å¢ƒå˜é‡ï¼Œå°±ä¸ç”¨å†æ‰‹åŠ¨é…ç½®ç¯å¢ƒå˜é‡äº†ã€‚</p><p>å®‰è£…å®Œä½¿ç”¨å‘½ä»¤æŸ¥çœ‹ç‰ˆæœ¬ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;java <span class="literal">-version</span></span><br><span class="line">java version <span class="string">&quot;1.8.0_172&quot;</span></span><br><span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span>.<span class="number">0</span>_172<span class="literal">-b11</span>)</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span><span class="literal">-Bit</span> Server VM (build <span class="number">25.172</span><span class="literal">-b11</span>, mixed mode)</span><br></pre></td></tr></table></figure><p>JDK ä¸‹è½½é•œåƒç½‘ç«™ï¼š</p><blockquote><p><a href="https://repo.huaweicloud.com/java/jdk/">Index of java-local/jdk (huaweicloud.com)</a></p></blockquote><h3 id="3-ndk">3. NDK</h3><p>æˆ‘é€‰æ‹©çš„ç‰ˆæœ¬ä¸ºï¼šr20bï¼Œä¸‹è½½å®Œè§£å‹åˆ°æ²¡æœ‰ä¸­æ–‡çš„è‹±æ–‡ç›®å½•å³å¯ï¼ˆæœ€å¥½ä¹Ÿåˆ«å¸¦ç©ºæ ¼ï¼Œæ²¡è¯•è¿‡ï¼‰ã€‚</p><p>ä¸‹è½½ Android NDKï¼š</p><blockquote><p><a href="https://github.com/android/ndk/wiki/Unsupported-Downloads">Unsupported Downloads Â· android/ndk Wiki Â· GitHub</a></p></blockquote><h3 id="4-å®‰è£…-android-studio">4. å®‰è£… Android Studio</h3><p>å®‰è£… Android Studio è½¯ä»¶ï¼Œè¿™ä¸ªè½¯ä»¶æ˜¯ä¸“é—¨ç”¨æ¥å¼€å‘ Android çš„ï¼Œè¿™é‡Œä¸»è¦å€Ÿç”¨å…¶æ¥å®‰è£… Android SDKã€‚ä¸ºä»€ä¹ˆè¦å€Ÿç”¨è¿™ä¸ªè½¯ä»¶å‘¢ï¼šåŸå› æ˜¯æˆ‘ç›´æ¥ä½¿ç”¨ SDK Manager å·¥å…·æ¥å®‰è£…ç»„ä»¶æ—¶ï¼Œä¸€ç›´å‡ºç°ç½‘ç»œé—®é¢˜è·å–ä¸åˆ°åº“ï¼ˆæ”¾åœ¨ Google ä¸Šçš„ï¼‰ï¼Œä½¿ç”¨æ¢¯å­å’Œé•œåƒæºéƒ½ä¸èƒ½è§£å†³ï¼Œæ‰€ä»¥æœ€ç»ˆé€‰æ‹©è¿™ç§æ–¹æ³•ã€‚</p><p>ä¸‹è½½åœ°å€ï¼š</p><blockquote><p><a href="https://developer.android.google.cn/studio?hl=zh-cn#downloads">ä¸‹è½½ Android Studio å’Œåº”ç”¨å·¥å…· - Android å¼€å‘è€…  | Android Developers (google.cn)</a></p></blockquote><p>å®‰è£…æ•™ç¨‹ï¼š</p><blockquote><p><a href="https://blog.csdn.net/Y74364/article/details/96121530">android studioå®‰è£…æ•™ç¨‹(æŒç»­æ›´æ–°ä¸­ï¼ŒåŒ…å®‰è£…æˆåŠŸï¼Œä¸æˆåŠŸä½ æ‰¾æˆ‘)-CSDNåšå®¢</a></p></blockquote><h3 id="5-qt-é…ç½®-android-ç¯å¢ƒ">5. Qt é…ç½® Android ç¯å¢ƒ</h3><p>å‰é¢éƒ½å®‰è£…å®Œåï¼Œè¿›å…¥åˆ° Qt Creator è¿›è¡Œé…ç½® Android ç¯å¢ƒï¼š</p><p><img src="image-20241221175614105.png" alt="image-20241221175614105"></p><p>è¿™æ˜¯æœ€åæˆåŠŸçš„æƒ…å†µï¼Œæˆ‘ä½¿ç”¨ Android Studio è½¯ä»¶ä¸‹è½½å®‰è£…åç»„ä»¶æ—¶ï¼ŒQt è¿™é‡Œè¿˜æ˜¯å‡ºç° SDK tools installed å’Œ Platform SDK installed è¿™ä¸¤ä¸ªé€‰é¡¹æ‰“Ã—çš„æƒ…å†µï¼ŒæŸ¥æ‰¾èµ„æ–™å‘ç°æ˜¯ SDK ç›®å½•ä¸‹ç¼ºå°‘ tools ç›®å½•ï¼ˆAndroid Studio è½¯ä»¶å¯èƒ½ä¸éœ€è¦ç”¨åˆ°è¿™ä¸ª tools ç›®å½•æˆ–è€…æ˜¯æ”¾åœ¨å…¶ä»–ç›®å½•ï¼Œæˆ‘ä»¬åªæ˜¯å€Ÿå…¶ä¸‹è½½å®‰è£…ç»„ä»¶ï¼Œæ‰€ä»¥æ‰‹åŠ¨ä¸‹è½½ tools å³å¯ï¼‰ã€‚</p><blockquote><p><a href="https://blog.csdn.net/qq_43265832/article/details/124518165">Qt6.3.0å®‰å“é…ç½®æç¤ºç¼ºå°‘Platform SDK installed-CSDNåšå®¢</a></p></blockquote><p>äºæ˜¯å°±å»æ‰‹åŠ¨ä¸‹è½½ SDK Toolsï¼Œå¹¶æ¥å‹ç¼©åŒ…å†…çš„ Tools ç›®å½•å¤åˆ¶åˆ°åŸæ¥çš„ SDK ç›®å½•ä¸‹ï¼Œå³å¯è§£å†³ã€‚</p><blockquote><p><a href="https://www.androiddevtools.cn/">AndroidDevTools - Androidå¼€å‘å·¥å…· Android SDKä¸‹è½½ Android Studioä¸‹è½½ Gradleä¸‹è½½ SDK Toolsä¸‹è½½</a></p></blockquote><p>Qt é…ç½® Android ç¯å¢ƒçš„é€‰é¡¹ï¼š</p><blockquote><p><a href="https://blog.csdn.net/qq_56857879/article/details/139290052">Qt5.14.2 for Android ç¯å¢ƒé…ç½®åŠå¼€å‘_qt 5.14 android-CSDNåšå®¢</a></p></blockquote><h2 id="å‡ºç°çš„é—®é¢˜">å‡ºç°çš„é—®é¢˜</h2><p>ä¸‹è½½ gradle æ—¶å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨ä¸‹è½½æ”¾åˆ°å¯¹åº”ç›®å½•æˆ–è€…ä¿®æ”¹é•œåƒæºï¼š</p><p>Gradle ä¸‹è½½ï¼š</p><blockquote><p><a href="https://services.gradle.org/distributions/">https://services.gradle.org/distributions/</a></p></blockquote><p>jdk ç‰ˆæœ¬ä¸å¯¹åº”å‡ºç°é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NoClassDefFoundError: Could not initialize class org.codehaus.groovy.vmplugin.v7.Java7</span><br><span class="line">at org.codehaus.groovy.vmplugin.VMPluginFactory.&lt;clinit&gt;(VMPluginFactory.java:43)</span><br><span class="line">at org.codehaus.groovy.reflection.GroovyClassValueFactory.&lt;clinit&gt;(GroovyClassValueFactory.java:35)</span><br><span class="line">at org.codehaus.groovy.reflection.ClassInfo.&lt;clinit&gt;(ClassInfo.java:109)</span><br><span class="line">at org.codehaus.groovy.reflection.ReflectionCache.getCachedClass(ReflectionCache.java:95)</span><br><span class="line">at org.codehaus.groovy.reflection.ReflectionCache.&lt;clinit&gt;(ReflectionCache.java:39)</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">at java.base/jdk.internal.reflect.MethodHandleAccessorFactory.ensureClassInitialized(Unknown Source)</span><br><span class="line">at java.base/jdk.internal.reflect.MethodHandleAccessorFactory.newConstructorAccessor(Unknown Source)</span><br><span class="line">at java.base/jdk.internal.reflect.ReflectionFactory.newConstructorAccessor(Unknown Source)</span><br><span class="line">at java.base/java.lang.reflect.Constructor.acquireConstructorAccessor(Unknown Source)</span><br><span class="line">at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Unknown Source)</span><br><span class="line">at java.base/java.lang.reflect.ReflectAccess.newInstance(Unknown Source)</span><br><span class="line">at java.base/jdk.internal.reflect.ReflectionFactory.newInstance(Unknown Source)</span><br><span class="line">at java.base/java.lang.Class.newInstance(Unknown Source)</span><br><span class="line">at org.codehaus.groovy.vmplugin.VMPluginFactory.createPlugin(VMPluginFactory.java:57)</span><br><span class="line">at org.codehaus.groovy.vmplugin.VMPluginFactory.&lt;clinit&gt;(VMPluginFactory.java:39)</span><br><span class="line">... 119 more</span><br><span class="line"></span><br><span class="line">FAILURE: Build failed with an exception.</span><br><span class="line"></span><br><span class="line">* What went wrong:</span><br><span class="line">Could not initialize class org.codehaus.groovy.reflection.ReflectionCache</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Exception java.lang.NoClassDefFoundError: Could not initialize class org.codehaus.groovy.vmplugin.v7.Java7 [<span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span>]</span></span><br><span class="line"></span><br><span class="line">* Try:</span><br><span class="line">Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.</span><br><span class="line"></span><br><span class="line">* Get more help at https://help.gradle.org</span><br><span class="line"></span><br><span class="line">BUILD FAILED in 1s</span><br><span class="line">  -- Skipping C:/Qt/Qt5.14.2/5.14.2/android/plugins/iconengines/libplugins_iconengines_qsvgicon_armeabi-v7a.so. It has unmet dependencies: lib/libQt5Svg_armeabi-v7a.so.</span><br><span class="line">  -- Skipping C:/Qt/Qt5.14.2/5.14.2/android/plugins/imageformats/libplugins_imageformats_qsvg_armeabi-v7a.so. It has unmet dependencies: lib/libQt5Svg_armeabi-v7a.so.</span><br><span class="line">Skipping createRCC</span><br><span class="line">Building the android package failed!</span><br><span class="line">  -- For more information, run this command with --verbose.</span><br><span class="line">15:06:47: è¿›ç¨‹&quot;C:\Qt\Qt5.14.2\5.14.2\android\bin\androiddeployqt.exe&quot;é€€å‡ºï¼Œé€€å‡ºä»£ç  14 ã€‚</span><br><span class="line">Error while building/deploying project untitled (kit: Android for armeabi-v7a,arm64-v8a,x86,x86_64 (Clang Qt 5.14.2 for Android))</span><br><span class="line">When executing step &quot;Build Android APK&quot;</span><br></pre></td></tr></table></figure><p>Android SDK ç‰ˆæœ¬å¤ªé«˜äº†ï¼Œä½†é¡¹ç›®ä¾èµ–çš„å·¥å…·æˆ–åº“ä¸å…¼å®¹ã€‚sdk tools ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯ 24.4.1ï¼Œä½†æ˜¯è¿™é‡Œç”¨äº† android-35ï¼Œç‰ˆæœ¬ä¸å¯¹åº”å‡ºé”™ï¼Œåé¢æ”¹æˆ android-29 å¯è§£å†³ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">FAILURE: Build failed with an exception.</span><br><span class="line"></span><br><span class="line">* What went wrong:</span><br><span class="line">Execution failed for task &#x27;:processDebugResources&#x27;.</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">A failure occurred <span class="keyword">while</span> executing com.android.build.gradle.internal.tasks.Workers<span class="variable">$ActionFacade</span></span></span><br><span class="line"><span class="meta prompt_">   &gt; </span><span class="language-bash">Android resource linking failed</span></span><br><span class="line">     AAPT: aapt2.exe E 12-21 15:11:16 17732 10564 LoadedArsc.cpp:112] RES_TABLE_TYPE_TYPE entry offsets overlap actual entry data.</span><br><span class="line">     aapt2.exe E 12-21 15:11:16 17732 10564 ApkAssets.cpp:157] Failed to load &#x27;resources.arsc&#x27; in APK &#x27;C:\Users\Administrator\AppData\Local\Android\Sdk\platforms\android-35\android.jar&#x27;.</span><br><span class="line">     error: failed to load include path C:\Users\Administrator\AppData\Local\Android\Sdk\platforms\android-35\android.jar.</span><br><span class="line">     </span><br><span class="line">         </span><br><span class="line"></span><br><span class="line">* Try:</span><br><span class="line">Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.</span><br><span class="line"></span><br><span class="line">* Get more help at https://help.gradle.org</span><br><span class="line"></span><br><span class="line">BUILD FAILED in 24s</span><br><span class="line">19 actionable tasks: 19 executed</span><br><span class="line">Building the android package failed!</span><br><span class="line">  -- For more information, run this command with --verbose.</span><br><span class="line">15:11:17: è¿›ç¨‹&quot;C:\Qt\Qt5.14.2\5.14.2\android\bin\androiddeployqt.exe&quot;é€€å‡ºï¼Œé€€å‡ºä»£ç  14 ã€‚</span><br><span class="line">Error while building/deploying project untitled1 (kit: Android for armeabi-v7a,arm64-v8a,x86,x86_64 (Clang Qt 5.14.2 for Android))</span><br><span class="line">When executing step &quot;Build Android APK&quot;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æ—¶å‡ºç°æ¶æ„ä¸å¯¹ï¼Œéœ€è¦é€‰æ‹© ABIs æ”¯æŒçš„æ¶æ„ï¼Œå¯å•é€‰æˆ–å¤šé€‰ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb: failed to install Failure [INSTALL_FAILED_NO_MATCHING_ABIS: INSTALL_FAILED_NO_MATCHING_ABIS: Failed to extract native libraries, res=-113] Installing to device failed! 13:19:31: The process &quot;C:\Qt\Qt5.14.2\5.14.2\android\bin\androiddeployqt.exe&quot; exited with code 16.</span><br></pre></td></tr></table></figure><p><img src="image-20241221184344322.png" alt="image-20241221184344322"></p><p>æ„å»ºæ—¶è¿˜ä¼šå‡ºç°ç›®å½•åå¤ªé•¿çš„æƒ…å†µï¼Œåœ¨ Qt å†…æ‰‹åŠ¨ä¿®æ”¹å‡å°‘ç›®å½•åå­—å³å¯ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;qt-å®‰å“ç¯å¢ƒæ­å»º&quot;&gt;Qt å®‰å“ç¯å¢ƒæ­å»º&lt;/h1&gt;
&lt;h2 id=&quot;åºè¨€&quot;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;Qt å¼€å‘ Android éœ€è¦ jdkã€ndkã€sdk ä¸‰ä¸ªåŒ…ï¼Œå¹¶ä¸” Qt çš„ç‰ˆæœ¬è¦ä¸è¿™äº›åŒ…çš„ç‰ˆæœ¬å¯¹åº”ï¼Œå¦åˆ™ä¼šå‡ºç°ä¸€å †å¥‡æ€ªçš„ bugï¼Œæˆ‘çš„ç¯å¢ƒå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>æ­å»ºTeamSpeakæœåŠ¡å™¨</title>
    <link href="http://www.obito.top/2024/09/25/%E6%90%AD%E5%BB%BATeamSpeak%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>http://www.obito.top/2024/09/25/%E6%90%AD%E5%BB%BATeamSpeak%E6%9C%8D%E5%8A%A1%E5%99%A8/</id>
    <published>2024-09-25T08:18:47.000Z</published>
    <updated>2024-10-26T13:21:21.942Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ­å»ºteamspeakæœåŠ¡å™¨">æ­å»ºTeamSpeakæœåŠ¡å™¨</h1><p>éœ€è¦ä¸€å°é•¿æ—¶é—´å¼€æœºä»¥åŠæ‹¥æœ‰å…¬ç½‘ IP çš„ç”µè„‘ï¼Œå› ä¸ºæ²¡æœ‰å…¬ç½‘ IPï¼Œæ‰€ä»¥è¿™é‡Œå°±è´­ä¹°äº†äº‘æœåŠ¡å™¨è¿›è¡Œæ­å»ºï¼Œç»è¿‡ä»·æ ¼å¯¹æ¯”æœ€ç»ˆé€‰æ‹©äº†[è…¾è®¯äº‘](<a href="https://cloud.tencent.com/">è…¾è®¯äº‘ äº§ä¸šæ™ºå˜Â·äº‘å¯æœªæ¥ - è…¾è®¯ (tencent.com)</a>)æœåŠ¡å™¨ï¼Œåˆæ¬¡è´­ä¹°ä¼˜æƒ ä¸€å¹´ 79 å…ƒï¼Œ2 æ ¸ 2 Gã€ç³»ç»Ÿç›˜ 50 Gã€æµé‡åŒ… 300 GB/æœˆã€å¸¦å®½ 4 Mbpsã€‚</p><h2 id="linux-ç¯å¢ƒå®‰è£…æœåŠ¡å™¨">Linux ç¯å¢ƒå®‰è£…æœåŠ¡å™¨</h2><h3 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h3><p>è€ƒè™‘åˆ°å®‰å…¨æ€§ï¼Œè¿™é‡Œæ–°å»ºä¸€ä¸ªç”¨æˆ·å­˜æ”¾æœåŠ¡å™¨æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd teamspeak</span><br></pre></td></tr></table></figure><p>ä¸‹è½½å’Œè§£å‹å‹ç¼©åŒ…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://files.teamspeak-services.com/releases/server/3.13.7/teamspeak3-server_linux_amd64-3.13.7.tar.bz2</span><br><span class="line"></span><br><span class="line">tar -xvf teamspeak3-server_linux_amd64-3.13.7.tar.bz2</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸‹ç›®å½•å</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv teamspeak3-server_linux_amd64-3.13.7 teamspeak3</span><br></pre></td></tr></table></figure><p>èµ‹äºˆç›®å½•ç»™æ–°å»ºçš„ç”¨æˆ·æƒé™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R teamspeak:teamspeak teamspeak3</span><br><span class="line">cd teamspeak3</span><br></pre></td></tr></table></figure><p>åŒæ„è®¸å¯æ¡æ¬¾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch .ts3server_license_accepted</span><br></pre></td></tr></table></figure><p>æ•°æ®åº“é…ç½®ï¼ŒTeamSpeak é»˜è®¤ä½¿ç”¨ SQLiteï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œ<strong>è‡ªåŠ¨é…ç½®å¹¶å¯åŠ¨æœåŠ¡å™¨</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ts3server_startscript.sh start</span><br></pre></td></tr></table></figure><p>æ‰“å°ä¿¡æ¯ï¼Œ<strong>ä¿å­˜ token å’Œ ç®¡ç†å‘˜è´¦å·å’Œå¯†ç ã€‚</strong></p><p><img src="image-20240925163621472.png" alt="image-20240925163621472"></p><h3 id="è®¾ç½®è‡ªå¯åŠ¨">è®¾ç½®è‡ªå¯åŠ¨</h3><p>åˆ›å»ºå¹¶ç¼–è¾‘æ–‡ä»¶ï¼š<code>/lib/systemd/system/teamspeak.service</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /lib/systemd/system/teamspeak.service</span><br></pre></td></tr></table></figure><p>æ·»åŠ å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Teamspeak, The most superior online voice communication solution.</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=syslog.target network.target network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=teamspeak</span><br><span class="line">Group=teamspeak</span><br><span class="line">WorkingDirectory=/home/teamspeak/teamspeak3</span><br><span class="line">ExecStart=/home/teamspeak/teamspeak3/ts3server_startscript.sh start</span><br><span class="line">ExecStop=/home/teamspeak/teamspeak3/ts3server_startscript.sh stop</span><br><span class="line">PIDFile=/home/teamspeak/teamspeak3/ts3server.pid</span><br><span class="line">Type=forking</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ul><li>Userå’Œ Group ä¸ºå‰é¢è®¾ç½®çš„ç”¨æˆ·åŠç”¨æˆ·æ‰€åœ¨ç»„ã€‚</li><li>WorkingDirectoryï¼šå·¥ä½œç›®å½•</li><li>ExecStartï¼šå¯åŠ¨å‘½ä»¤</li><li>ExecStopï¼šæ¥æ”¶å‘½ä»¤</li><li><strong>ç›®å½•è·¯å¾„å¿…é¡»ä¿®æ”¹ä¸ºç›´æ¥æœåŠ¡å™¨æ–‡ä»¶å­˜æ”¾ä½ç½®</strong></li></ul><p>é‡æ–°åŠ è½½ systemdï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>å¼€å¯è‡ªå¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable teamspeak.service</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ TeamSpeakï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start teamspeak.service</span><br></pre></td></tr></table></figure><p>åœæ­¢ TeamSpeakï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop teamspeak.service</span><br></pre></td></tr></table></figure><p>é‡å¯TeamSpeakï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart teamspeak.service</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://www.wevg.org/archives/teamspeak-server-build/#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5">TeamSpeak æœåŠ¡å™¨æ­å»ºæ–¹æ³• | Vigorous Pro (wevg.org)</a></p></blockquote><h3 id="ç§»æ¤æœåŠ¡å™¨">ç§»æ¤æœåŠ¡å™¨</h3><p>ç§»æ¤å‰å…ˆä¿å­˜å¿…è¦æ–‡ä»¶ï¼Œç„¶ååœ¨æ–°çš„æœåŠ¡å™¨é‡æ–°å®‰è£… ts æœåŠ¡å™¨å°†æ–‡ä»¶æ”¾åˆ°ç›®å½•ä¸‹å¹¶é‡æ–°æ·»åŠ  license è®¸å¯è¯å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚</p><h4 id="é‡è¦æ–‡ä»¶">é‡è¦æ–‡ä»¶</h4><p>æŸ¥è¯¢æ¥å£çš„ç™½åå• IPï¼š<code>query_ip_allowlist.txt</code></p><p>æŸ¥è¯¢æ¥å£çš„é»‘åå• IPï¼š<code>query_ip_denylist.txt</code></p><p>æ•°æ®åº“ï¼š<code>ts3server.sqlitedb </code></p><p>å¯†é’¥ï¼š<code>ssh_host_rsa_key</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv query_ip_* ts3server.sqlitedb ssh_host_rsa_key æœåŠ¡å™¨ç›®å½•ä¸‹</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦é¢‘é“æœ‰å›¾æ ‡æˆ–æ–‡ä»¶ï¼Œåˆ™éœ€è¦ä¿å­˜ <code>file</code> ç›®å½•ã€‚</p><p>è‹¥æœ‰é…ç½® tsdnsï¼Œåˆ™è¿˜éœ€è¦ä¿å­˜ <code>tsdns/tsdns_settings.ini</code>ã€‚</p><blockquote><p><a href="https://www.bilibili.com/read/cv36119499/?jump_opus=1">ã€æ˜Ÿè§ç’ƒæœã€‘TeamspeakæœåŠ¡å™¨æ­å»ºã€ç»‘å®šåŸŸåã€è¿ç§» - å“”å“©å“”å“© (bilibili.com)</a></p></blockquote><h2 id="tsaudioboot">TSAudioboot</h2><p>ç›´æ¥ä½¿ç”¨ linux æ­å»ºåï¼Œwyy api ç”¨ä¸äº†ï¼Œæ”¹æˆ docker ç›®å‰å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚</p><p>åˆå§‹åŒ–ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --rm --mount type=bind,source=&quot;$(pwd)/data&quot;,target=/app/data -it ancieque/ts3audiobot:0.12.0</span><br></pre></td></tr></table></figure><p>è¿è¡Œå¯åŠ¨ï¼Œå¿…é¡»<strong>æ·»åŠ æ˜ å°„ç«¯å£ 58913</strong>ï¼Œå¦åˆ™ç½‘é¡µæ‰“ä¸å¼€ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --name ts3audiobot -d -p 58913:58913 --mount type=bind,source=&quot;$(pwd)/data&quot;,target=/app/data ancieque/ts3audiobot:0.12.0</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://github.com/getdrunkonmovies-com/TS3AudioBot_docker?tab=readme-ov-file">getdrunkonmovies-com/TS3AudioBot_docker (github.com)</a></p></blockquote><h3 id="tsaudioboot-å››ä¸ªé‡è¦é…ç½®æ–‡ä»¶">TSAudioboot å››ä¸ªé‡è¦é…ç½®æ–‡ä»¶</h3><ul><li>ts3audiobot.dbï¼šbot çš„æ•°æ®åº“ã€‚</li><li>ts3audiobot.tomlï¼šé…ç½®æ–‡ä»¶ï¼Œé‡Œé¢æœ‰ web çš„ç½‘é¡µé…ç½®ä¿¡æ¯ã€‚</li><li>rights.tomlï¼šç”¨æˆ·æƒé™å‚æ•°è®¾ç½®ï¼Œåœ¨ userid æ·»åŠ è‡ªå·±çš„ uidã€‚</li><li>bot/default/bot.tomlï¼šå­˜æ”¾ bot è¿æ¥çš„æœåŠ¡å™¨å’Œé¢‘é“ä¿¡æ¯ã€‚</li></ul><p>bot/default/bot.toml éœ€è¦è‡ªå·±åˆ›å»ºï¼Œæ·»åŠ ä¸€ä¸‹å†…å®¹ï¼ˆæƒé™éœ€è¦æ”¹ä¸º docker ç”¨æˆ·ï¼‰ï¼šæ·»åŠ æœåŠ¡å™¨åœ°å€å’Œå¯†ç </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Starts the instance when the TS3AudioBot is launched.</span></span><br><span class="line">run = true</span><br><span class="line"></span><br><span class="line">[commands]</span><br><span class="line"></span><br><span class="line">[commands.alias]</span><br><span class="line"></span><br><span class="line">[connect]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">The server password. Leave empty <span class="keyword">for</span> none.</span></span><br><span class="line">server_password = &#123; pw = &quot;æœåŠ¡å™¨å¯†ç &quot; &#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">The default channel password. Leave empty <span class="keyword">for</span> none.</span></span><br><span class="line">channel_password = &#123;  &#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Overrides the displayed version <span class="keyword">for</span> the ts3 client. Leave empty <span class="keyword">for</span> default.</span></span><br><span class="line">client_version = &#123;  &#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">The address, ip or nickname (and port; default: 9987) of the TeamSpeak3 server</span></span><br><span class="line">address = &quot;ip:port&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Client nickname when connecting.</span></span><br><span class="line">name = &quot;Music Bot&quot;</span><br><span class="line"></span><br><span class="line">[connect.identity]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">||| DO NOT MAKE THIS KEY PUBLIC ||| The client identity. You can import a teamspeak3 identity here too.</span></span><br><span class="line">key = &quot;MCoDAgbAAgEgAiEAijUpF210Wd4+9/07+43GcLC02o09gEqxkNvBC3fq38U=&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">The client identity offset determining the security level.</span></span><br><span class="line">offset = 249</span><br><span class="line"></span><br><span class="line">[reconnect]</span><br><span class="line"></span><br><span class="line">[audio]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">When a new song starts the volume will be trimmed to between min and max.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">When the current volume already is between min and max nothing will happen.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">To completely or partially <span class="built_in">disable</span> this feature, <span class="built_in">set</span> min to 0 and/or max to 100.</span></span><br><span class="line">volume = &#123;  &#125;</span><br><span class="line"></span><br><span class="line">[playlists]</span><br><span class="line"></span><br><span class="line">[history]</span><br><span class="line"></span><br><span class="line">[events]</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://www.bilibili.com/read/cv12676008/">TS3AudioBotå®‰è£…é…ç½®æ•™ç¨‹ - å“”å“©å“”å“© (bilibili.com)</a></p></blockquote><p>å¯ä»¥æ‰“å¼€ç½‘é¡µæ‰‹åŠ¨æ·»åŠ æœ¬åœ°éŸ³ä¹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ dockerï¼Œæ‰€ä»¥<strong>æ·»åŠ æ—¶éœ€è¦æ˜¯ docker çš„ç›®å½•</strong>ã€‚</p><p>ä¾‹å¦‚æˆ‘å®¿ä¸»æœºæœ¬åœ°ç›®å½•ä¸º <code>/home/teamspeak/ts3AudioBot/data</code>ï¼ŒæŒ‚è½½ docker å®¹å™¨çš„ç›®å½•ä¸º <code>/app/data</code>ï¼Œæ‰€ä»¥å°†åœ¨æœ¬åœ°ç›®å½•åˆ›å»º music ç›®å½•åï¼Œåœ¨ docker å®¹å™¨ä¸‹çš„ç›®å½•åº”è¯¥ä¸º <code>/app/data/music</code>ï¼Œegï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å®¿ä¸»æœºç›®å½•ï¼š/home/teamspeak/ts3AudioBot/data/music/test.mp3</span><br><span class="line">dockerå®¹å™¨ç›®å½•ï¼š/app/data/music/test.mp3</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è„šæœ¬æ‰¹é‡æ·»åŠ éŸ³ä¹ï¼ˆè¿˜æœªå°è¯•ï¼‰ï¼š</p><blockquote><p><a href="https://www.bilibili.com/video/BV19M4m1f7HV/?spm_id_from=333.1007.top_right_bar_window_history.content.click&amp;vd_source=170970c6528ce8b04fb449814b901de5">https://www.bilibili.com/video/BV19M4m1f7HV/?spm_id_from=333.1007.top_right_bar_window_history.content.click&amp;vd_source=170970c6528ce8b04fb449814b901de5</a></p></blockquote><h3 id="wyy-api">WYY API</h3><p>åˆ—å‡ºå½“å‰ plugin å’ŒåŠ è½½ pluginã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!plugin list</span><br><span class="line"></span><br><span class="line">!plugin load 0</span><br></pre></td></tr></table></figure><p>å‘½ä»¤ä½¿ç”¨æ–¹æ³•ï¼š</p><blockquote><p><a href="https://blog.csdn.net/weixin_46419890/article/details/139286994">å…³äºTeamSpeak3-ç½‘æ˜“éŸ³ä¹æœºå™¨äººçš„åŸºç¡€ä½¿ç”¨æ–¹æ³•ï¼ˆèƒæ•™çº§æ•™ç¨‹ï¼‰_ts3audiobot-CSDNåšå®¢</a></p></blockquote><p>æ¥å£è§£æï¼š</p><blockquote><p><a href="https://binaryify.github.io/NeteaseCloudMusicApi/#/?id=%E8%BF%90%E8%A1%8C">ç½‘æ˜“äº‘éŸ³ä¹ NodeJS ç‰ˆ API (binaryify.github.io)</a></p></blockquote><p>æ’ä»¶ windows ç‰ˆæœ¬çš„ï¼Œé‡Œé¢åˆ†æ”¯æœ‰ linux ç‰ˆæœ¬çš„ï¼Œå‡ºç°é—®é¢˜çœ‹ä¸€ä¸‹ tissueã€‚</p><blockquote><p><a href="https://github.com/ZHANGTIANYAO1/TS3AudioBot-NetEaseCloudmusic-plugin?tab=readme-ov-file">ZHANGTIANYAO1/TS3AudioBot-NetEaseCloudmusic-plugin: è¿™æ˜¯ä¸€ä¸ªç”¨C#ç»™TS3AudioBotç¼–å†™ç½‘æ˜“äº‘æ’ä»¶,è®©ä½ çš„TSå¯ä»¥æœ‰ä¸€ä¸ªéŸ³ä¹æœºå™¨äººã€‚å¦‚æœè§‰å¾—å¥½çš„è¯ï¼Œè¿˜è¯·ç»™ä¸ªæ˜Ÿæ˜Ÿæ”¯æŒä¸€ä¸‹ (github.com)</a></p></blockquote><p>linux ç‰ˆæœ¬çš„ï¼š</p><blockquote><p><a href="https://github.com/FiveHair/TS3AudioBot-NetEaseCloudmusic-plugin-UNM">FiveHair/TS3AudioBot-NetEaseCloudmusic-plugin-UNM: é‡æ„ZHANGTIANYAO1çš„TS3AudioBotç½‘æ˜“äº‘æ’ä»¶ï¼Œæ”¯æŒWindowsã€Dockerå’ŒLinuxï¼Œæ”¯æŒæ— ç‰ˆæƒæ­Œæ›²è§£é”ã€‚ (github.com)</a></p></blockquote><h3 id="linux-å‘½ä»¤-docker">linux å‘½ä»¤ &amp; docker</h3><p>åœ¨æ­å»ºçš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦æŸ¥çœ‹ç«¯å£æ˜¯å¦å¼€æ”¾ï¼Œä½¿ç”¨ netstat å‘½ä»¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// t:tcp u:tdp l:è¡¨ç¤ºä»…æ˜¾ç¤ºç›‘å¬çš„ç«¯å£ n:æ•°å­—å½¢å¼æ˜¾ç¤ºç«¯å£å·</span><br><span class="line">netstat -tuln</span><br><span class="line">// ä½¿ç”¨ grep æŸ¥æ‰¾å…·ä½“</span><br><span class="line">netstat -tuln | grep :80</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/oldboyedu1/article/details/142386143">Linuxå¦‚ä½•æŸ¥çœ‹ç«¯å£æ˜¯å¦å¼€æ”¾?-CSDNåšå®¢</a></p><p>docker run åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨</p><p>å½“ä½¿ç”¨ docker run å‘½ä»¤æ—¶ï¼Œé™¤äº†å¸¸è§å‚æ•° -dï¼ˆåå°è¿è¡Œï¼‰å’Œ -pï¼ˆç«¯å£æ˜ å°„ï¼‰ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–å¸¸ç”¨å‚æ•°ï¼š</p><ul><li>-vï¼šæŒ‚è½½ä¸»æœºç›®å½•åˆ°å®¹å™¨å†…éƒ¨ï¼Œç”¨äºæ•°æ®æŒä¹…åŒ–ã€‚</li><li>-eï¼šè®¾ç½®å®¹å™¨å†…çš„ç¯å¢ƒå˜é‡ã€‚</li><li>â€“nameï¼šä¸ºå®¹å™¨æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰çš„åç§°ã€‚</li><li>-iï¼šå¯åŠ¨ä¸€ä¸ªäº¤äº’å¼å®¹å™¨ã€‚</li><li>-tï¼šä¸ºå®¹å™¨åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ã€‚</li><li>â€“restartï¼šæŒ‡å®šå®¹å™¨é€€å‡ºæ—¶çš„é‡å¯ç­–ç•¥ã€‚</li><li>â€“networkï¼šæŒ‡å®šå®¹å™¨æ‰€å±çš„ç½‘ç»œæ¨¡å¼ã€‚</li><li>â€“linkï¼šé“¾æ¥å¦ä¸€ä¸ªå®¹å™¨ã€‚</li></ul><p>docker start å¯åŠ¨å®¹å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start å®¹å™¨å</span><br></pre></td></tr></table></figure><p>docker stop åœæ­¢å®¹å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop å®¹å™¨å</span><br></pre></td></tr></table></figure><p>docker restart é‡å¯å®¹å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart å®¹å™¨å</span><br></pre></td></tr></table></figure><p>docker rm åˆ é™¤å®¹å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm å®¹å™¨å</span><br></pre></td></tr></table></figure><p>docker logs æŸ¥çœ‹å®¹å™¨æ—¥å¿—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker logs å®¹å™¨å</span><br><span class="line"></span><br><span class="line">// å®æ—¶æ˜¾ç¤º</span><br><span class="line">docker logs -f å®¹å™¨å</span><br></pre></td></tr></table></figure><p>docker images æŸ¥çœ‹å·²ä¸‹è½½çš„ docker é•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure><p>è¿›å…¥ docker å®¹å™¨çš„ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it å®¹å™¨å /bin/bash</span><br><span class="line">or</span><br><span class="line">docker exec -it å®¹å™¨å sh</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://blog.csdn.net/xuzhengzhe/article/details/136248661">ã€Dockerã€‘åˆå­¦è€… Docker åŸºç¡€æ“ä½œæŒ‡å—ï¼šä»æ‹‰å–é•œåƒåˆ°è¿è¡Œã€åœæ­¢ã€åˆ é™¤å®¹å™¨_dockeråœæ­¢ä¸€ä¸ªé•œåƒçš„æ‹‰å–-CSDNåšå®¢</a></p></blockquote><h3 id="è®¾ç½®dockerä»¥åŠå®¹å™¨å¼€æœºè‡ªå¯åŠ¨">è®¾ç½®dockerä»¥åŠå®¹å™¨å¼€æœºè‡ªå¯åŠ¨</h3><h4 id="docker">docker</h4><p>docker è®¾ç½®å¼€æœºå¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable docker.service</span><br></pre></td></tr></table></figure><p>docker å…³é—­å¼€æœºå¯åŠ¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl disable docker.service</span><br></pre></td></tr></table></figure><p>é‡æ–°è®¾ç½® docker åœ¨ç³»ç»Ÿä¸­çš„è‡ªå¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reenable docker.service</span><br></pre></td></tr></table></figure><h4 id="å®¹å™¨">å®¹å™¨</h4><p>åˆ›å»ºæ—¶è®¾ç½®è‡ªå¯åŠ¨åœ¨ docker run ä¸­æ·»åŠ é€‰é¡¹ --restart=always</p><p>å¦‚æœå·²ç»åˆ›å»ºçš„å®¹å™¨ï¼Œåˆ™ä½¿ç”¨ update å‘½ä»¤è¿›è¡Œæ›´æ–°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update --restart=always å®¹å™¨åæˆ–è€…id</span><br></pre></td></tr></table></figure><p>å–æ¶ˆå®¹å™¨å¼€æœºè‡ªå¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update --restart=no å®¹å™¨åæˆ–è€…id</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://blog.csdn.net/qq_45558497/article/details/123970473">ubuntuä¸­è®¾ç½®dockerä»¥åŠå®¹å™¨å¼€æœºè‡ªå¯_ubuntu docker å¼€æœºå¯åŠ¨-CSDNåšå®¢</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;æ­å»ºteamspeakæœåŠ¡å™¨&quot;&gt;æ­å»ºTeamSpeakæœåŠ¡å™¨&lt;/h1&gt;
&lt;p&gt;éœ€è¦ä¸€å°é•¿æ—¶é—´å¼€æœºä»¥åŠæ‹¥æœ‰å…¬ç½‘ IP çš„ç”µè„‘ï¼Œå› ä¸ºæ²¡æœ‰å…¬ç½‘ IPï¼Œæ‰€ä»¥è¿™é‡Œå°±è´­ä¹°äº†äº‘æœåŠ¡å™¨è¿›è¡Œæ­å»ºï¼Œç»è¿‡ä»·æ ¼å¯¹æ¯”æœ€ç»ˆé€‰æ‹©äº†[è…¾è®¯äº‘](&lt;a href=&quot;https://cloud.ten</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linuxå†…æ ¸é”æœºåˆ¶</title>
    <link href="http://www.obito.top/2024/08/24/Linux%E5%86%85%E6%A0%B8%E9%94%81%E6%9C%BA%E5%88%B6/"/>
    <id>http://www.obito.top/2024/08/24/Linux%E5%86%85%E6%A0%B8%E9%94%81%E6%9C%BA%E5%88%B6/</id>
    <published>2024-08-24T07:59:39.000Z</published>
    <updated>2024-09-16T07:59:59.463Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linuxå†…æ ¸é”æœºåˆ¶">Linuxå†…æ ¸é”æœºåˆ¶</h1><h2 id="linux-å¹¶å‘ä¸ç«äº‰">Linux å¹¶å‘ä¸ç«äº‰</h2><p><strong>å¹¶å‘</strong>ï¼šLinux ç³»ç»Ÿæ˜¯ä¸ªå¤šä»»åŠ¡æ“ä½œç³»ç»Ÿï¼Œä¼šå­˜åœ¨<strong>å¤šä¸ªä»»åŠ¡åŒæ—¶è®¿é—®åŒä¸€ç‰‡å†…å­˜ç©ºé—´</strong>ï¼Œè¿™äº›ä»»åŠ¡å¯èƒ½ä¼šç›¸äº’è¦†ç›–è¿™æ®µå†…å­˜ä¸­æ•°æ®ï¼Œé€ æˆå†…å­˜æ•°æ®æ··ä¹±ã€‚</p><p><strong>å¹¶å‘è®¿é—®å¸¦æ¥çš„é—®é¢˜å°±æ˜¯ç«äº‰</strong>ï¼Œç«äº‰å¹¶å‘çš„æ‰§è¡Œå•å…ƒå¯¹å…±äº«èµ„æºï¼ˆç¡¬ä»¶èµ„æºå’Œè½¯ä»¶ä¸Šçš„å…¨å±€å˜é‡ï¼‰çš„è®¿é—®è€Œå¯¼è‡´çš„ç«äº‰çŠ¶æ€ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦<strong>å¯¹å…±äº«æ•°æ®è¿›è¡Œä¿æŠ¤å¤„ç†ï¼Œé˜²æ­¢å¤šä¸ªä»»åŠ¡åŒæ—¶è®¿é—®å®ƒ</strong>ã€‚</p><p>å¹¶å‘çš„åŸå› ä¸€èˆ¬æœ‰ï¼š</p><ul><li>å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ï¼šLinux æ˜¯å¤šä»»åŠ¡ï¼ˆçº¿ç¨‹ï¼‰çš„ç³»ç»Ÿï¼Œå¤šçº¿ç¨‹è®¿é—®æ˜¯æœ€åŸºæœ¬çš„åŸå› ã€‚</li><li>æŠ¢å å¼å¹¶å‘è®¿é—®ï¼šLinux å†…æ ¸æ”¯æŒæŠ¢å ï¼Œè°ƒåº¦ç¨‹åºå¯ä»¥åœ¨ä»»æ„æ—¶åˆ»æŠ¢å æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œä»è€Œè¿è¡Œå…¶ä»–çš„çº¿ç¨‹ã€‚</li><li>ä¸­æ–­ç¨‹åºå¹¶å‘è®¿é—®ï¼šç¡¬ä»¶ä¸­æ–­çš„ä¼˜å…ˆçº§å¾ˆé«˜ã€‚</li><li>SMPï¼ˆå¤šæ ¸ï¼‰æ ¸é—´å¹¶å‘è®¿é—®ï¼šå¤šä¸ª CPU æ ¸å­˜åœ¨æ ¸é—´å¹¶å‘è®¿é—®ã€‚</li></ul><p><strong>ä¸´ç•Œèµ„æº</strong>ï¼šå¤šä¸ªè¿›ç¨‹è®¿é—®çš„èµ„æºï¼Œå…±äº«æ•°æ®æ®µã€‚</p><p><strong>ä¸´ç•ŒåŒº</strong>ï¼šå¤šä¸ªè¿›ç¨‹è®¿é—®çš„ä»£ç æ®µã€‚</p><h2 id="linux-å†…æ ¸é”æœºåˆ¶">Linux å†…æ ¸é”æœºåˆ¶</h2><p>Linux å†…æ ¸æä¾›è§£å†³ç«äº‰çš„æ‰‹æ®µæœ‰å¦‚ä¸‹å‡ ä¸ªæ–¹æ³•ï¼šåŸå­æ“ä½œã€è‡ªæ—‹é”ã€ä¿¡å·é‡ã€äº’æ–¥ä½“ã€‚</p><h3 id="åŸå­æ“ä½œ">åŸå­æ“ä½œ</h3><p>åŸå­æ“ä½œæ˜¯æŒ‡<strong>ä¸èƒ½å†è¿›ä¸€æ­¥åˆ†å‰²çš„æ“ä½œ</strong>ï¼Œä¸€èˆ¬åŸå­æ“ä½œç”¨äº<strong>æ•´å‹å˜é‡æˆ–è€…ä½æ“ä½œ</strong></p><p>ä¾‹å¦‚ C è¯­è¨€ä¸­çš„æ•´å‹å˜é‡ a è¿›è¡Œèµ‹å€¼æ“ä½œï¼ŒC è¯­è¨€ç¼–è¯‘è½¬æ¢ä¸ºæ±‡ç¼–æŒ‡ä»¤ï¼Œä½† ARM æ¶æ„ä¸æ”¯æŒç›´æ¥å¯¹å¯„å­˜å™¨è¿›è¡Œè¯»å†™æ“ä½œï¼Œéœ€è¦å€ŸåŠ©å¯„å­˜å™¨æ¥å®Œæˆèµ‹å€¼æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cè¯­è¨€</span></span><br><span class="line">a = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯èƒ½è½¬æ¢æˆå¦‚ä¸‹æ±‡ç¼–æŒ‡ä»¤</span></span><br><span class="line">ldr r0, = <span class="number">0x30000000</span></span><br><span class="line">ldr r1, = <span class="number">3</span></span><br><span class="line">str r1, [r0]</span><br></pre></td></tr></table></figure><p>å‡è®¾ç°åœ¨çº¿ç¨‹ A è¦å‘ a å˜é‡å†™å…¥ 10 è¿™ä¸ªå€¼ï¼Œè€Œçº¿ç¨‹ B ä¹Ÿè¦å‘ a å˜é‡å†™å…¥ 20 è¿™ä¸ªå€¼ï¼Œç†æƒ³æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š</p><p><img src="image-20240701134438484.png" alt="image-20240701134438484"></p><p>ä½†å®é™…æƒ…å†µå¯èƒ½å¦‚ä¸‹ï¼š</p><p><img src="image-20240701134503941.png" alt="image-20240701134503941"></p><p>ä¸ºäº†é˜²æ­¢å‡ºç°è¯¥é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦<strong>ä¿è¯è¿™ä¸‰è¡Œæ±‡ç¼–æŒ‡ä»¤ä½œä¸ºä¸€ä¸ªæ•´ä½“è¿è¡Œ</strong>ã€‚</p><p>Linux å†…æ ¸å®šä¹‰äº†å«åš <code>atomic_t</code> ç»“æ„ä½“æ¥<strong>å®Œæˆæ•´å‹æ•°æ®çš„åŸå­æ“ä½œ</strong>ï¼Œåœ¨ä½¿ç”¨ä¸­<strong>ç”¨åŸå­å˜é‡ä»£æ›¿æ•´å‹å˜é‡</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  include/linux/types.h </span></span><br><span class="line"><span class="comment">// 32ä½</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> counter;</span><br><span class="line">&#125; <span class="type">atomic_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 64ä½</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> counter;</span><br><span class="line">&#125; <span class="type">atomic64_t</span>;</span><br></pre></td></tr></table></figure><p>åŸå­æ“ä½œçš„ API å‡½æ•°ï¼š</p><p><img src="image-20240701135113024.png" alt="image-20240701135113024"></p><p>åŸå­ä½æ“ä½œçš„ API å‡½æ•°ï¼šåŸå­ä½æ“ä½œæ˜¯ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œ</p><p><img src="image-20240701135255467.png" alt="image-20240701135255467"></p><p>egï¼šä½¿ç”¨åŸå­å˜é‡ lockï¼Œç”¨æ¥å®ç°ä¸€æ¬¡åªèƒ½ä¸€ä¸ªåº”ç”¨ç¨‹åºè®¿é—® LEDã€‚</p><ul><li>é©±åŠ¨å…¥å£å‡½æ•°å°† lock å€¼è®¾ç½®ä¸º 1</li><li>æ‰“å¼€é©±åŠ¨è®¾å¤‡æ—¶ç”¨ <code>atomic_dec_and_test</code> å‡½æ•°å°† lock å‡ 1ï¼Œ<code>atomic_dec_and_test</code> å‡½æ•°è¿”å›å€¼ä¸ºçœŸå°±è¡¨ç¤º lock å½“å‰å€¼ä¸º 0ï¼Œè¡¨ç¤ºè®¾å¤‡å¯ç”¨</li><li>qè‹¥è¿”å›å€¼ä¸ºå‡ï¼Œè¡¨ç¤º lock å‡ 1 ä¹‹åä¸ºè´Ÿæ•°ï¼Œå³æœ‰å…¶ä»–è®¾å¤‡å°†æ­£åœ¨ä½¿ç”¨ LED ä½¿å¾— lock ä¸º 0ï¼›éœ€è¦å°† lock åŠ  1ï¼Œä½¿å¾— lock ä¸º 0 è¡¨ç¤ºè®¾å¤‡æ­£åœ¨ä½¿ç”¨ï¼Œå¹¶è¿”å› -EBUSY</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">atomic_t</span> lock;<span class="comment">/* åŸå­å˜é‡ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* é€šè¿‡åˆ¤æ–­åŸå­å˜é‡çš„å€¼æ¥æ£€æŸ¥LEDæœ‰æ²¡æœ‰è¢«åˆ«çš„åº”ç”¨ä½¿ç”¨ */</span></span><br><span class="line"><span class="keyword">if</span> (!atomic_dec_and_test(&amp;lock)) </span><br><span class="line">&#123;</span><br><span class="line"><span class="type">atomic_inc</span>(&amp;lock);<span class="comment">/* å°äº0çš„è¯å°±åŠ 1,ä½¿å…¶åŸå­å˜é‡ç­‰äº0 */</span></span><br><span class="line"><span class="keyword">return</span> -EBUSY;<span class="comment">/* LEDè¢«ä½¿ç”¨ï¼Œè¿”å›å¿™ */</span></span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* å…³é—­é©±åŠ¨æ–‡ä»¶çš„æ—¶å€™é‡Šæ”¾åŸå­å˜é‡ */</span></span><br><span class="line"><span class="type">atomic_inc</span>(&amp;lock);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–åŸå­å˜é‡ */</span></span><br><span class="line"><span class="type">atomic_set</span>(&amp;lock, <span class="number">1</span>);<span class="comment">/* åŸå­å˜é‡åˆå§‹å€¼ä¸º1 */</span></span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è‡ªæ—‹é”">è‡ªæ—‹é”</h3><p>åŸå­æ“ä½œåªèƒ½å¯¹æ•´å‹å˜é‡æˆ–è€…ä½è¿›è¡Œä¿æŠ¤ï¼Œè‡ªæ—‹é”å¯ä»¥å¯¹æ›´å¤šçš„èµ„æºè¿›è¡Œä¿æŠ¤ã€‚</p><p>å¦‚æœè‡ªæ—‹é”æ­£åœ¨è¢«çº¿ç¨‹ A æŒæœ‰ï¼Œè€Œçº¿ç¨‹ B æƒ³è¦è·å–è‡ªæ—‹é”ï¼Œé‚£ä¹ˆçº¿ç¨‹ B å°±ä¼šå¤„äº<strong>å¿™å¾ªç¯â€”æ—‹è½¬â€”ç­‰å¾…çŠ¶æ€</strong>ï¼Œçº¿ç¨‹ B <strong>ä¸ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€æˆ–è€…è¯´å»åšå…¶ä»–çš„å¤„ç†</strong>ï¼Œç›´åˆ°çº¿ç¨‹ A é‡Šæ”¾è‡ªæ—‹é”ï¼Œçº¿ç¨‹ B æ‰å¯ä»¥è®¿é—®å…±äº«èµ„æºã€‚</p><ul><li>è‡ªæ—‹é”é€‚ç”¨äºçŸ­æ—¶æœŸçš„è½»é‡çº§åŠ é”ï¼Œå¦åˆ™ä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚</li><li>è¢«è‡ªæ—‹é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºä¸€å®šä¸èƒ½è°ƒç”¨ç¡çœ å’Œé˜»å¡çš„å‡½æ•°ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´æ­»é”ç°è±¡ã€‚</li><li>è·å–é”ä¹‹å‰è¦ç¦æ­¢æœ¬åœ°ä¸­æ–­ï¼Œé˜²æ­¢æ­»é”ç°è±¡ã€‚å¦‚ä¸€ä¸ªçº¿ç¨‹è·å–é”ä¹‹åè¢«ä¸­æ–­æ‰“æ–­ï¼Œè€Œè¿™ä¸ªä¸­æ–­è¦æƒ³ç”³è¯·è¯¥é”ï¼Œåˆ™ä¼šå‘é€æ­»é”ç°è±¡ã€‚</li></ul><p>Linux å†…æ ¸å®šä¹‰äº† <code>spinlock_t</code> ç»“æ„ä½“è¡¨ç¤ºè‡ªæ—‹é”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">raw_spinlock</span> <span class="title">rlock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCK_PADSIZE (offsetof(struct raw_spinlock, dep_map))</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            u8 __padding[LOCK_PADSIZE];</span><br><span class="line"></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">dep_map</span>;</span></span><br><span class="line">        &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125; <span class="type">spinlock_t</span>;</span><br></pre></td></tr></table></figure><p><img src="image-20240701143902523.png" alt="image-20240701143902523"></p><p>egï¼šä½¿ç”¨è‡ªæ—‹é”ï¼Œç”¨æ¥å®ç°ä¸€æ¬¡åªèƒ½ä¸€ä¸ªåº”ç”¨ç¨‹åºè®¿é—® LEDã€‚</p><ul><li>dev_stats è¡¨ç¤ºè®¾å¤‡ä½¿ç”¨çŠ¶æ€ï¼Œ0ï¼šè®¾å¤‡æœªä½¿ç”¨ï¼› &gt;0ï¼šè®¾å¤‡å·²ç»è¢«ä½¿ç”¨</li><li>é©±åŠ¨å…¥å£å‡½æ•°<strong>åˆå§‹åŒ–è‡ªæ—‹é”</strong></li><li>æ‰“å¼€é©±åŠ¨è®¾å¤‡æ—¶è°ƒç”¨ <code>spin_lock_irqsave</code> å‡½æ•°<strong>è·å–è‡ªæ—‹é”</strong>ï¼Œä¿å­˜æœ¬åœ°ä¸­æ–­çŠ¶æ€</li><li>åˆ¤æ–­ dev_stats æ˜¯å¦å¤§äº 0ï¼Œè‹¥è®¾å¤‡å·²è¢«ä½¿ç”¨ï¼Œåˆ™è°ƒç”¨ <code>spin_unlock_irqrestore</code> å‡½æ•°<strong>è§£é”</strong>å¹¶è¿”å› -EBUSY</li><li>è‹¥è®¾å¤‡æœªè¢«ä½¿ç”¨ï¼Œdev_stats åŠ  1ï¼Œè¡¨ç¤ºè®¾å¤‡å¼€å§‹ä½¿ç”¨äº†ï¼Œæ¥ç€è°ƒç”¨ <code>spin_unlock_irqrestore</code> å‡½æ•°<strong>è§£é”</strong></li><li>é€€å‡ºé©±åŠ¨è®¾å¤‡å°† dev_stats å‡ 1ï¼Œè¡¨ç¤ºè®¾å¤‡é‡Šæ”¾</li><li>è¿™é‡Œçš„<strong>è‡ªæ—‹é”çš„å·¥ä½œå°±æ˜¯ä¿æŠ¤ dev_stats å˜é‡ä¸è¢«å…¶ä»–ç¨‹åºè®¿é—®ä¿®æ”¹</strong>ï¼Œè¿™é‡Œçš„ dev_stats æ˜¯è¯¥æ–‡ä»¶çš„å…¨å±€å˜é‡ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªå˜é‡å¯èƒ½ä¼šè¢«å„ç§æ–‡ä»¶ä½¿ç”¨ï¼Œå› æ­¤éœ€è¦ç”¨è‡ªæ—‹é”å¯ä»¥ç”¨æ¥ä¿æŠ¤å…¶ä¸è¢«è®¿é—®ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> dev_stats;<span class="comment">/* è®¾å¤‡ä½¿ç”¨çŠ¶æ€ï¼Œ0ï¼Œè®¾å¤‡æœªä½¿ç”¨;&gt;0,è®¾å¤‡å·²ç»è¢«ä½¿ç”¨ */</span></span><br><span class="line"><span class="type">spinlock_t</span> lock;<span class="comment">/* è‡ªæ—‹é” */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">spin_lock_irqsave(&amp;lock, flags);<span class="comment">/* ä¸Šé” */</span></span><br><span class="line"><span class="keyword">if</span> (dev_stats) </span><br><span class="line">&#123;<span class="comment">/* å¦‚æœè®¾å¤‡è¢«ä½¿ç”¨äº† */</span></span><br><span class="line">spin_unlock_irqrestore(&amp;lock, flags);<span class="comment">/* è§£é” */</span></span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line">&#125;</span><br><span class="line">dev_stats++;<span class="comment">/* å¦‚æœè®¾å¤‡æ²¡æœ‰æ‰“å¼€ï¼Œé‚£ä¹ˆå°±æ ‡è®°å·²ç»æ‰“å¼€äº† */</span></span><br><span class="line">spin_unlock_irqrestore(&amp;lock, flags);<span class="comment">/* è§£é” */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* å…³é—­é©±åŠ¨æ–‡ä»¶çš„æ—¶å€™å°†dev_statså‡1 */</span></span><br><span class="line">spin_lock_irqsave(&amp;lock, flags);<span class="comment">/* ä¸Šé” */</span></span><br><span class="line"><span class="keyword">if</span> (dev_stats) </span><br><span class="line">&#123;</span><br><span class="line">dev_stats--;</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irqrestore(&amp;lock, flags);<span class="comment">/* è§£é” */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/*  åˆå§‹åŒ–è‡ªæ—‹é” */</span></span><br><span class="line">spin_lock_init(&amp;lock);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¿¡å·é‡">ä¿¡å·é‡</h3><p>Linux å†…æ ¸æä¾›äº†ä¿¡å·é‡æœºåˆ¶ï¼Œä¿¡å·é‡å¸¸å¸¸ç”¨äº<strong>æ§åˆ¶å¯¹å…±äº«èµ„æºçš„è®¿é—®</strong>ã€‚å®ƒæ˜¯ä¸€ä¸ª<strong>è®¡æ•°å™¨</strong>ï¼Œå¸¸ç”¨äºå®ç°è¿›ç¨‹é—´çš„äº’æ–¥ä¸åŒæ­¥ï¼Œè€Œä¸æ˜¯ç”¨äºå­˜å‚¨è¿›ç¨‹é—´é€šä¿¡æ•°æ®ã€‚<strong>ç›¸æ¯”äºè‡ªæ—‹é”ï¼Œä¿¡å·é‡å¯ä»¥ä½¿çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€</strong></p><ul><li>å› ä¸ºä¿¡å·é‡å¯ä»¥ä½¿ç­‰å¾…èµ„æºçº¿ç¨‹è¿›å…¥<strong>ä¼‘çœ çŠ¶æ€</strong>ï¼Œå› æ­¤é€‚ç”¨äºé‚£äº›å ç”¨èµ„æºæ¯”è¾ƒä¹…çš„åœºåˆã€‚</li><li>å› æ­¤ä¿¡å·é‡<strong>ä¸èƒ½ç”¨äºä¸­æ–­ä¸­</strong>ï¼Œå› ä¸ºä¿¡å·é‡ä¼šå¼•èµ·ä¼‘çœ ï¼Œä¸­æ–­ä¸èƒ½ä¼‘çœ ã€‚</li><li>å¦‚æœå…±äº«èµ„æºçš„æŒæœ‰æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œé‚£å°±ä¸é€‚åˆä½¿ç”¨ä¿¡å·é‡äº†ï¼Œå› ä¸ºé¢‘ç¹çš„ä¼‘çœ ã€åˆ‡æ¢çº¿ç¨‹å¼•èµ·çš„å¼€é”€è¦è¿œå¤§äºä¿¡å·é‡å¸¦æ¥çš„é‚£ç‚¹ä¼˜åŠ¿ã€‚</li></ul><blockquote><p>æ¯”å¦‚ A ä¸ Bã€C åˆç§Ÿäº†ä¸€å¥—æˆ¿å­ï¼Œè¿™ä¸ªæˆ¿å­åªæœ‰ä¸€ä¸ªå•æ‰€ï¼Œä¸€æ¬¡åªèƒ½ä¸€ä¸ªäººä½¿ç”¨ã€‚æŸä¸€å¤©æ—©ä¸Š A å»ä¸Šå•æ‰€äº†ï¼Œè¿‡äº†ä¸€ä¼š B ä¹Ÿæƒ³ç”¨å•æ‰€ï¼Œå› ä¸º A åœ¨å•æ‰€é‡Œé¢ï¼Œæ‰€ä»¥ B åªèƒ½ç­‰åˆ° A ç”¨æ¥äº†æ‰èƒ½è¿›å»ã€‚B è¦ä¹ˆå°±ä¸€ç›´åœ¨å•æ‰€é—¨å£ç­‰ç€ï¼Œç­‰ A å‡ºæ¥ï¼Œè¿™ä¸ªæ—¶å€™å°±ç›¸å½“äºè‡ªæ—‹é”ã€‚B ä¹Ÿå¯ä»¥å‘Šè¯‰ Aï¼Œè®© A å‡ºæ¥ä»¥åé€šçŸ¥ä»–ä¸€ä¸‹ï¼Œç„¶å B ç»§ç»­å›æˆ¿é—´ç¡è§‰ï¼Œè¿™ä¸ªæ—¶å€™ç›¸å½“äºä¿¡å·é‡ã€‚å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ä¿¡å·é‡ä¼šæé«˜å¤„ç†å™¨çš„ä½¿ç”¨æ•ˆç‡ï¼Œæ¯•ç«Ÿä¸ç”¨ä¸€ç›´å‚»ä¹ä¹çš„åœ¨é‚£é‡Œâ€œè‡ªæ—‹â€ç­‰å¾…ã€‚ä½†æ˜¯ï¼Œä¿¡å·é‡çš„å¼€é”€è¦æ¯”è‡ªæ—‹é”å¤§ï¼Œå› ä¸ºä¿¡å·é‡ä½¿çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ä»¥åä¼šåˆ‡æ¢çº¿ç¨‹ï¼Œåˆ‡æ¢çº¿ç¨‹å°±ä¼šæœ‰å¼€é”€ã€‚</p></blockquote><p>Linux å†…æ ¸ä½¿ç”¨ <code>semaphore</code> ç»“æ„ä½“è¡¨ç¤ºä¿¡å·é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> &#123;</span></span><br><span class="line">    <span class="type">raw_spinlock_t</span> lock;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">wait_list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="image-20240701145543856.png" alt="image-20240701145543856"></p><p>egï¼š</p><ul><li>ä¿¡å·é‡ sem ä¸º1 çš„æ—¶å€™è¡¨ç¤º LED ç¯è¿˜æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åº A è¦ä½¿ç”¨ LED ç¯ï¼Œå…ˆè°ƒç”¨ open å‡½æ•°æ‰“å¼€è®¾å¤‡èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™ä¼šè·å–ä¿¡å·é‡ semï¼Œè·å–æˆåŠŸä»¥å sem çš„å€¼å‡ 1 å˜ä¸º 0ã€‚</li><li>å¦‚æœæ­¤æ—¶åº”ç”¨ç¨‹åº B ä¹Ÿè¦ä½¿ç”¨ LED ç¯ï¼Œè°ƒç”¨ open å‡½æ•°æ‰“å¼€è®¾å¤‡èŠ‚ç‚¹å°±ä¼š<strong>å› ä¸ºä¿¡å·é‡æ— æ•ˆ(å€¼ä¸º 0)è€Œè¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚</strong></li><li>å½“åº”ç”¨ç¨‹åº A è¿è¡Œå®Œæ¯•ï¼Œ<strong>è°ƒç”¨ close å‡½æ•°çš„æ—¶å€™å°±ä¼šé‡Šæ”¾ä¿¡å·é‡ sem</strong>ï¼Œæ­¤æ—¶ä¿¡å·é‡ sem çš„å€¼å°±ä¼šåŠ  1ï¼Œå˜ä¸º 1ã€‚</li><li>ä¿¡å·é‡ sem å†æ¬¡æœ‰æ•ˆï¼Œè¡¨ç¤ºå…¶ä»–åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ LED ç¯äº†ï¼Œæ­¤æ—¶åœ¨ä¼‘çœ çŠ¶æ€çš„åº”ç”¨ç¨‹åº B å°±ä¼šè·å–åˆ°ä¿¡å·é‡ semï¼Œè·å–æˆåŠŸä»¥åå°±å¼€å§‹ä½¿ç”¨ LED ç¯ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> <span class="title">sem</span>;</span><span class="comment">/* ä¿¡å·é‡ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* è·å–ä¿¡å·é‡ */</span></span><br><span class="line"><span class="keyword">if</span> (down_interruptible(&amp;sem)) &#123; <span class="comment">/* è·å–ä¿¡å·é‡,è¿›å…¥ä¼‘çœ çŠ¶æ€çš„è¿›ç¨‹å¯ä»¥è¢«ä¿¡å·æ‰“æ–­ */</span></span><br><span class="line"><span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">down(&amp;sem);<span class="comment">/* ä¸èƒ½è¢«ä¿¡å·æ‰“æ–­ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">up(&amp;sem);<span class="comment">/* é‡Šæ”¾ä¿¡å·é‡ï¼Œä¿¡å·é‡å€¼åŠ 1 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–ä¿¡å·é‡ å€¼ä¸º1 å³äºŒå€¼ä¿¡å·é‡ */</span></span><br><span class="line">sema_init(&amp;sem, <span class="number">1</span>);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äº’æ–¥ä½“">äº’æ–¥ä½“</h3><p>å°†ä¿¡å·é‡çš„å€¼è®¾ç½®ä¸º 1 ä¹Ÿå¯ä»¥ä½¿ç”¨ä¿¡å·é‡è¿›è¡Œäº’æ–¥ï¼Œä½†æ˜¯ Linux å†…æ ¸æä¾›äº†ä¸€ä¸ªæ›´ä¸“ä¸šçš„æœºåˆ¶æ¥è¿›è¡Œäº’æ–¥â€”â€”äº’æ–¥ä½“ï¼ˆmutexï¼‰ã€‚äº’æ–¥è®¿é—®è¡¨ç¤º<strong>ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹</strong>å¯ä»¥è®¿é—®å…±äº«èµ„æºï¼Œä¸èƒ½é€’å½’ç”³è¯·äº’æ–¥ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> &#123;</span></span><br><span class="line">    <span class="comment">/* 1: unlocked, 0: locked, negative: locked, possible waiters */</span></span><br><span class="line">    <span class="type">atomic_t</span> count;</span><br><span class="line">    <span class="type">spinlock_t</span> wait_lock;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>mutex å¯ä»¥å¯¼è‡´ä¼‘çœ ï¼Œä¸èƒ½ä¸­æ–­ä¸­ä½¿ç”¨ mutexï¼Œ<strong>ä¸­æ–­ä¸­åªèƒ½ä½¿ç”¨è‡ªæ—‹é”</strong>ã€‚</li><li>åŒä¿¡å·é‡ä¸€æ ·ï¼Œmutex ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¯ä»¥è°ƒç”¨å¼•èµ·é˜»å¡çš„ API å‡½æ•°ã€‚</li><li>ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŒæœ‰ mutexï¼Œå› æ­¤ <strong>mutex çš„æŒæœ‰è€…å¿…é¡»è‡ªå·±é‡Šæ”¾ mutex</strong>ï¼Œå¹¶ä¸” mutex ä¸èƒ½é€’å½’ä¸Šé”å’Œè§£é”ã€‚</li></ul><p><img src="image-20240701150632326.png" alt="image-20240701150632326"></p><p>egï¼šè¿‡ç¨‹è·Ÿä½¿ç”¨äºŒå€¼ä¿¡å·é‡ä¸€æ ·ï¼Œ<strong>ä¿¡å·é‡ä¸ºäºŒå€¼ä¿¡å·é‡æ—¶å°±æ˜¯äº’æ–¥ä½“</strong>ï¼Œåªä¸è¿‡äº’æ–¥ä½“æ˜¯ä¸“é—¨ç”¨æ¥äº’æ–¥çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span><span class="comment">/* äº’æ–¥ä½“ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* è·å–äº’æ–¥ä½“,å¯ä»¥è¢«ä¿¡å·æ‰“æ–­ */</span></span><br><span class="line"><span class="keyword">if</span> (mutex_lock_interruptible(&amp;lock)) &#123;</span><br><span class="line"><span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">mutex_lock(&amp;lock);<span class="comment">/* ä¸èƒ½è¢«ä¿¡å·æ‰“æ–­ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"><span class="comment">/* é‡Šæ”¾äº’æ–¥é” */</span></span><br><span class="line">mutex_unlock(&amp;lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–äº’æ–¥ä½“ */</span></span><br><span class="line">mutex_init(&amp;lock);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linuxå†…æ ¸é”æœºåˆ¶&quot;&gt;Linuxå†…æ ¸é”æœºåˆ¶&lt;/h1&gt;
&lt;h2 id=&quot;linux-å¹¶å‘ä¸ç«äº‰&quot;&gt;Linux å¹¶å‘ä¸ç«äº‰&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;å¹¶å‘&lt;/strong&gt;ï¼šLinux ç³»ç»Ÿæ˜¯ä¸ªå¤šä»»åŠ¡æ“ä½œç³»ç»Ÿï¼Œä¼šå­˜åœ¨&lt;strong&gt;å¤šä¸ªä»»åŠ¡åŒæ—¶è®¿é—®åŒä¸€ç‰‡å†…å­˜ç©º</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux åµŒå…¥å¼" scheme="http://www.obito.top/tags/Linux-%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Linux-V4L2-USB-Camera</title>
    <link href="http://www.obito.top/2024/08/11/Linux-V4L2-USB-Camera/"/>
    <id>http://www.obito.top/2024/08/11/Linux-V4L2-USB-Camera/</id>
    <published>2024-08-11T14:48:46.000Z</published>
    <updated>2024-08-23T07:38:21.457Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux-v4l2-usb-camera">Linux-V4L2-USB-Camera</h1><h2 id="åºè¨€">åºè¨€</h2><p>åœ¨ Linux å¼€å‘æ¿ä¸Šä½¿ç”¨ V4L2 æ¡†æ¶é©±åŠ¨ usb æ‘„åƒå¤´ã€‚</p><h2 id="v4l2-ç®€è¿°">V4L2 ç®€è¿°</h2><p>V4L2ï¼ˆVideo for Linux 2ï¼‰æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºè§†é¢‘æ•è·è®¾å¤‡çš„ä¸€ä¸ª APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰ï¼Œå®ƒæä¾›äº†ä¸€å¥—æ ‡å‡†çš„æ–¹æ³•æ¥è®¿é—®å’Œæ§åˆ¶è§†é¢‘æ•è·ç¡¬ä»¶ï¼Œå¦‚æ‘„åƒå¤´ã€è§†é¢‘ç¼–ç å™¨ç­‰ã€‚</p><p>å¸‚é¢ä¸Šæœ‰å„ç§å‹å·å„ç§å‚å•†çš„æ‘„åƒå¤´ï¼Œé©±åŠ¨éœ€è¦ä¸€ä¸ªä¸€ä¸ªå†™å¾ˆéº»çƒ¦ï¼Œäºæ˜¯å‡ºç°äº† v4l2 æ¡†æ¶ã€‚ç°åœ¨å¤§å¤šæ•°æ‘„åƒå¤´éƒ½é€‚é… v4l2 æ¡†æ¶ï¼Œä½¿ç”¨ v4l2 æ¡†æ¶å¯ä»¥å¾ˆæ–¹ä¾¿åœ°é©±åŠ¨å„ç§æ¥å£çš„æ‘„åƒå¤´ã€‚</p><p>V4L2 åœ¨<code>include/uapi/linux/videodev2.h</code> æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€äº›é‡è¦çš„æ•°æ®ç»“æ„ï¼Œåœ¨é‡‡é›†å›¾åƒçš„è¿‡ç¨‹ä¸­ï¼Œå°±æ˜¯é€šè¿‡å¯¹è¿™äº›æ•°æ®çš„æ“ä½œæ¥è·å¾—æœ€ç»ˆçš„å›¾åƒæ•°æ®ã€‚</p><p>V4L2 æ”¯æŒä¸¤ç§æ–¹å¼æ¥é‡‡é›†å›¾åƒï¼šå†…å­˜æ˜ å°„æ–¹å¼(mmap)å’Œç›´æ¥è¯»å–æ–¹å¼(read)ï¼Œå‰è€…ä¸€èˆ¬ç”¨äºè¿ç»­è§†é¢‘æ•°æ®çš„é‡‡é›†ï¼Œåè€…å¸¸ç”¨äºé™æ€å›¾ç‰‡æ•°æ®çš„é‡‡é›†ï¼Œæœ¬æ¬¡æ˜¯ç”¨æ‘„åƒå¤´è¿›è¡Œè§†é¢‘é‡‡é›†æ‰€ä»¥ä½¿ç”¨ mmap çš„æ–¹å¼ã€‚</p><h3 id="åº”ç”¨ç¨‹åºé€šè¿‡-v4l2-æ¥å£é‡‡é›†è§†é¢‘æ•°æ®æ­¥éª¤ï¼š">åº”ç”¨ç¨‹åºé€šè¿‡ V4L2 æ¥å£é‡‡é›†è§†é¢‘æ•°æ®æ­¥éª¤ï¼š</h3><ol><li>æ‰“å¼€è§†é¢‘è®¾å¤‡æ–‡ä»¶(/dev/videoX)ï¼Œè¿›è¡Œè§†é¢‘é‡‡é›†çš„å‚æ•°åˆå§‹åŒ–ï¼Œé€šè¿‡ V4L2 æ¥å£è®¾ç½®è§†é¢‘å›¾åƒçš„é‡‡é›†çª—å£ã€é‡‡é›†çš„ç‚¹é˜µå¤§å°å’Œæ ¼å¼;</li><li>ç”³è¯·è‹¥å¹²è§†é¢‘é‡‡é›†çš„å¸§ç¼“å†²åŒºï¼Œå¹¶å°†è¿™äº›å¸§ç¼“å†²åŒºä»å†…æ ¸ç©ºé—´æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¾¿äºåº”ç”¨ç¨‹åºè¯»å–/å¤„ç†è§†é¢‘æ•°æ®;</li><li>å°†ç”³è¯·åˆ°çš„å¸§ç¼“å†²åŒºåœ¨è§†é¢‘é‡‡é›†è¾“å…¥é˜Ÿåˆ—æ’é˜Ÿï¼Œå¹¶å¯åŠ¨è§†é¢‘é‡‡é›†;</li><li>é©±åŠ¨å¼€å§‹è§†é¢‘æ•°æ®çš„é‡‡é›†ï¼Œåº”ç”¨ç¨‹åºä»è§†é¢‘é‡‡é›†è¾“å‡ºé˜Ÿåˆ—å–å‡ºå¸§ç¼“å†²åŒºï¼Œå¤„ç†å®Œåï¼Œå°†å¸§ç¼“å†²åŒºé‡æ–°æ”¾å…¥è§†é¢‘é‡‡é›†è¾“å…¥é˜Ÿåˆ—ï¼Œå¾ªç¯å¾€å¤é‡‡é›†è¿ç»­çš„è§†é¢‘æ•°æ®;</li><li>åœæ­¢è§†é¢‘é‡‡é›†ã€‚</li></ol><p>å…·ä½“çš„ç¨‹åºå®ç°æµç¨‹å¯ä»¥å‚è€ƒä¸‹é¢çš„æµç¨‹å›¾:</p><p><img src="image-20240812142300309.png" alt="image-20240812142300309"></p><p>å®ç°æ–¹å¼åŸºæœ¬å°±æ˜¯<strong>ä½¿ç”¨ ioctl å‡½æ•°å»è®¾ç½®å’Œè·å–å‚æ•°</strong>ã€‚</p><p>æœ€é‡è¦çš„æ˜¯ç¼“å†²åŒºçš„ç®¡ç†ï¼Œæ‘„åƒå¤´å¯åŠ¨è§†é¢‘é‡‡é›†åï¼Œé©±åŠ¨ç¨‹åºå¼€å§‹<strong>é‡‡é›†ä¸€å¸§æ•°æ®</strong>ï¼ŒæŠŠé‡‡é›†çš„æ•°æ®æ”¾å…¥<strong>è§†é¢‘é‡‡é›†è¾“å…¥é˜Ÿåˆ—</strong>çš„ç¬¬ä¸€ä¸ª<strong>å¸§ç¼“å†²åŒº</strong>ï¼Œä¸€å¸§æ•°æ®<strong>é‡‡é›†å®Œæˆ</strong>ï¼ˆç¬¬ä¸€ä¸ªå¸§ç¼“å†²åŒºå­˜æ”¾ä¸€å¸§æ•°æ®ï¼‰ï¼Œ<strong>é©±åŠ¨ç¨‹åº</strong>å°†è¯¥<strong>å¸§ç¼“å†²åŒº</strong>ç§»è‡³<strong>è§†é¢‘é‡‡é›†è¾“å‡ºé˜Ÿåˆ—</strong>ï¼Œ<strong>ç­‰å¾…åº”ç”¨ç¨‹åºä»è¾“å‡ºé˜Ÿåˆ—å–å‡º</strong>ã€‚é©±åŠ¨ç¨‹åºæ¥ä¸‹æ¥é‡‡é›†ä¸‹ä¸€å¸§æ•°æ®ï¼Œæ”¾å…¥ç¬¬äºŒä¸ªå¸§ç¼“å†²åŒºï¼ŒåŒæ ·å¸§ç¼“å†²åŒºå­˜æ»¡ä¸‹ä¸€å¸§æ•°æ®åï¼Œå°±è¢«æ”¾å…¥è§†é¢‘é‡‡é›†è¾“å‡ºé˜Ÿåˆ—ã€‚</p><p><strong>åº”ç”¨ç¨‹åº</strong>ä»<strong>è§†é¢‘é‡‡é›†è¾“å‡ºé˜Ÿåˆ—ä¸­å–å‡º</strong>å«æœ‰è§†é¢‘æ•°æ®çš„<strong>å¸§ç¼“å†²åŒº</strong>ï¼Œå¤„ç†å¸§ç¼“å†²åŒºä¸­çš„è§†é¢‘æ•°æ®ï¼Œå¦‚å­˜å‚¨æˆ–å‹ç¼©ã€‚</p><p>æœ€åï¼Œåº”ç”¨ç¨‹åºå°†å¤„ç†å®Œæ•°æ®çš„å¸§ç¼“å†²åŒº<strong>é‡æ–°æ”¾å…¥è§†é¢‘é‡‡é›†è¾“å…¥é˜Ÿåˆ—</strong>ï¼Œè¿™æ ·å¯ä»¥å¾ªç¯é‡‡é›†ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="image-20240812142848398.png" alt="image-20240812142848398"></p><p><img src="image-20240812143030377.png" alt="image-20240812143030377"></p><h3 id="v4l2-ä½¿ç”¨">V4L2 ä½¿ç”¨</h3><p>åº”ç”¨ç¨‹åºä½¿ç”¨ V4L2 è·å–è§†é¢‘æ•°æ®çš„è¿‡ç¨‹éƒ½æ˜¯é€šè¿‡ ioctl å‘½ä»¤ä¸é©±åŠ¨ç¨‹åºè¿›è¡Œäº¤äº’ï¼Œv4l2 å¸¸ç”¨çš„ ioctl æ§åˆ¶ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">VIDIOC_QUERYCAP     <span class="comment">/* è·å–è®¾å¤‡æ”¯æŒçš„æ“ä½œ */</span></span><br><span class="line">VIDIOC_G_FMT        <span class="comment">/* è·å–è®¾ç½®æ”¯æŒçš„è§†é¢‘æ ¼å¼ */</span></span><br><span class="line">VIDIOC_S_FMT        <span class="comment">/* è®¾ç½®æ•è·è§†é¢‘çš„æ ¼å¼ */</span></span><br><span class="line">VIDIOC_REQBUFS      <span class="comment">/* å‘é©±åŠ¨æå‡ºç”³è¯·å†…å­˜çš„è¯·æ±‚ */</span></span><br><span class="line">VIDIOC_QUERYBUF     <span class="comment">/* å‘é©±åŠ¨æŸ¥è¯¢ç”³è¯·åˆ°çš„å†…å­˜ */</span></span><br><span class="line">VIDIOC_QBUF         <span class="comment">/* å°†ç©ºé—²çš„å†…å­˜åŠ å…¥å¯æ•è·è§†é¢‘çš„é˜Ÿåˆ— */</span></span><br><span class="line">VIDIOC_DQBUF        <span class="comment">/* å°†å·²ç»æ•è·å¥½è§†é¢‘çš„å†…å­˜æ‹‰å‡ºå·²æ•è·è§†é¢‘çš„é˜Ÿåˆ— */</span></span><br><span class="line">VIDIOC_STREAMON     <span class="comment">/* æ‰“å¼€è§†é¢‘æµ */</span></span><br><span class="line">VIDIOC_STREAMOFF    <span class="comment">/* å…³é—­è§†é¢‘æµ */</span></span><br><span class="line">VIDIOC_QUERYCTRL    <span class="comment">/* æŸ¥è¯¢é©±åŠ¨æ˜¯å¦æ”¯æŒè¯¥å‘½ä»¤ */</span></span><br><span class="line">VIDIOC_G_CTRL       <span class="comment">/* è·å–å½“å‰å‘½ä»¤å€¼ */</span></span><br><span class="line">VIDIOC_S_CTRL       <span class="comment">/* è®¾ç½®æ–°çš„å‘½ä»¤å€¼ */</span></span><br><span class="line">VIDIOC_G_TUNER      <span class="comment">/* è·å–è°ƒè°å™¨ä¿¡æ¯ */</span></span><br><span class="line">VIDIOC_S_TUNER      <span class="comment">/* è®¾ç½®è°ƒè°å™¨ä¿¡æ¯ */</span></span><br><span class="line">VIDIOC_G_FREQUENCY  <span class="comment">/* è·å–è°ƒè°å™¨é¢‘ç‡ */</span></span><br><span class="line">VIDIOC_S_FREQUENCY  <span class="comment">/* è®¾ç½®è°ƒè°å™¨é¢‘ç‡ */</span></span><br></pre></td></tr></table></figure><h4 id="æ‰“å¼€-å…³é—­æ‘„åƒå¤´">æ‰“å¼€/å…³é—­æ‘„åƒå¤´</h4><p>open æ‰“å¼€æ‘„åƒå¤´è®¾å¤‡èŠ‚ç‚¹ <code>/dev/videoX</code></p><p>close å…³é—­æ‘„åƒå¤´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fd=open(â€œ/dev/videoXâ€, O_RDWR);<span class="comment">// æ‰“å¼€è®¾å¤‡</span></span><br><span class="line">close(fd);<span class="comment">// å…³é—­è®¾å¤‡</span></span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢è®¾å¤‡èƒ½åŠ›">æŸ¥è¯¢è®¾å¤‡èƒ½åŠ›</h4><p><code>VIDIOC_QUERYCAP</code>ï¼šQuery Capabilityï¼ŒæŸ¥çœ‹æ˜¯å¦ä¸ºæ•è·è®¾å¤‡ï¼Œæ˜¯å¦æ”¯æŒ mmap æ“ä½œè¿˜æ˜¯ä»…æ”¯æŒ read/write æ“ä½œã€‚</p><p>v4l2_capability ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * struct v4l2_capability - Describes V4L2 device caps returned by VIDIOC_QUERYCAP</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @driver:   name of the driver module (e.g. &quot;bttv&quot;)</span></span><br><span class="line"><span class="comment">  * @card:   name of the card (e.g. &quot;Hauppauge WinTV&quot;)</span></span><br><span class="line"><span class="comment">  * @bus_info:   name of the bus (e.g. &quot;PCI:&quot; + pci_name(pci_dev) )</span></span><br><span class="line"><span class="comment">  * @version:   KERNEL_VERSION</span></span><br><span class="line"><span class="comment">  * @capabilities: capabilities of the physical device as a whole</span></span><br><span class="line"><span class="comment">  * @device_caps:  capabilities accessed via this particular device (node)</span></span><br><span class="line"><span class="comment">  * @reserved:   reserved fields for future extensions</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_capability</span> &#123;</span></span><br><span class="line">__u8driver[<span class="number">16</span>];</span><br><span class="line">__u8card[<span class="number">32</span>];</span><br><span class="line">__u8bus_info[<span class="number">32</span>];</span><br><span class="line">__u32   version;</span><br><span class="line">__u32capabilities;</span><br><span class="line">__u32device_caps;</span><br><span class="line">__u32reserved[<span class="number">3</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢æ”¯æŒå¸§æ ¼å¼">æŸ¥è¯¢æ”¯æŒå¸§æ ¼å¼</h4><p><code>VIDIOC_ENUM_FMT</code> æšä¸¾æ‘„åƒå¤´æ”¯æŒçš„æ ¼å¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *F O R M A T   E N U M E R A T I O N</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_fmtdesc</span> &#123;</span></span><br><span class="line">__u32    index;             <span class="comment">/* Format number      */</span></span><br><span class="line">__u32    type;              <span class="comment">/* enum v4l2_buf_type */</span></span><br><span class="line">__u32               flags;</span><br><span class="line">__u8    description[<span class="number">32</span>];   <span class="comment">/* Description string */</span></span><br><span class="line">__u32    pixelformat;       <span class="comment">/* Format fourcc      */</span></span><br><span class="line">__u32    reserved[<span class="number">4</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="è®¾ç½®å¸§æ ¼å¼">è®¾ç½®å¸§æ ¼å¼</h4><p><code>VIDIOC_G_FMT</code>  å’Œ <code>VIDIOC_S_FMT</code>ï¼Œv4l2_format ç»“æ„ä½“å­˜æ”¾è§†é¢‘æ ¼å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct v4l2_format - stream data format</span></span><br><span class="line"><span class="comment"> * @type:enum v4l2_buf_type; type of the data stream</span></span><br><span class="line"><span class="comment"> * @pix:definition of an image format</span></span><br><span class="line"><span class="comment"> * @pix_mp:definition of a multiplanar image format</span></span><br><span class="line"><span class="comment"> * @win:definition of an overlaid image</span></span><br><span class="line"><span class="comment"> * @vbi:raw VBI capture or output parameters</span></span><br><span class="line"><span class="comment"> * @sliced:sliced VBI capture or output parameters</span></span><br><span class="line"><span class="comment"> * @raw_data:placeholder for future extensions and custom formats</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_format</span> &#123;</span></span><br><span class="line">__u32 type;</span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_pix_format</span><span class="title">pix</span>;</span>     <span class="comment">/* V4L2_BUF_TYPE_VIDEO_CAPTURE */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_pix_format_mplane</span><span class="title">pix_mp</span>;</span>  <span class="comment">/* V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_window</span><span class="title">win</span>;</span>     <span class="comment">/* V4L2_BUF_TYPE_VIDEO_OVERLAY */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_vbi_format</span><span class="title">vbi</span>;</span>     <span class="comment">/* V4L2_BUF_TYPE_VBI_CAPTURE */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_sliced_vbi_format</span><span class="title">sliced</span>;</span>  <span class="comment">/* V4L2_BUF_TYPE_SLICED_VBI_CAPTURE */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_sdr_format</span><span class="title">sdr</span>;</span>     <span class="comment">/* V4L2_BUF_TYPE_SDR_CAPTURE */</span></span><br><span class="line">__u8raw_data[<span class="number">200</span>];                   <span class="comment">/* user-defined */</span></span><br><span class="line">&#125; fmt;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>type ä¸ºæšä¸¾ä½“ v4l2_buf_type çš„ä¸€é¡¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">v4l2_buf_type</span> &#123;</span></span><br><span class="line">V4L2_BUF_TYPE_VIDEO_CAPTURE        = <span class="number">1</span>,</span><br><span class="line">V4L2_BUF_TYPE_VIDEO_OUTPUT         = <span class="number">2</span>,</span><br><span class="line">V4L2_BUF_TYPE_VIDEO_OVERLAY        = <span class="number">3</span>,</span><br><span class="line">V4L2_BUF_TYPE_VBI_CAPTURE          = <span class="number">4</span>,</span><br><span class="line">V4L2_BUF_TYPE_VBI_OUTPUT           = <span class="number">5</span>,</span><br><span class="line">V4L2_BUF_TYPE_SLICED_VBI_CAPTURE   = <span class="number">6</span>,</span><br><span class="line">V4L2_BUF_TYPE_SLICED_VBI_OUTPUT    = <span class="number">7</span>,</span><br><span class="line">V4L2_BUF_TYPE_VIDEO_OUTPUT_OVERLAY = <span class="number">8</span>,</span><br><span class="line">V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE = <span class="number">9</span>,</span><br><span class="line">V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE  = <span class="number">10</span>,</span><br><span class="line">V4L2_BUF_TYPE_SDR_CAPTURE          = <span class="number">11</span>,</span><br><span class="line">V4L2_BUF_TYPE_SDR_OUTPUT           = <span class="number">12</span>,</span><br><span class="line"><span class="comment">/* Deprecated, do not use */</span></span><br><span class="line">V4L2_BUF_TYPE_PRIVATE              = <span class="number">0x80</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>v4l2_pix_format ç»“æ„ä½“å­˜æ”¾æ•è·è®¾å¤‡çš„å¸§æ ¼å¼å±æ€§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *V I D E O   I M A G E   F O R M A T</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_pix_format</span> &#123;</span></span><br><span class="line">__u32         width;</span><br><span class="line">__u32height;</span><br><span class="line">__u32pixelformat;</span><br><span class="line">__u32field;<span class="comment">/* enum v4l2_field */</span></span><br><span class="line">__u32            bytesperline;<span class="comment">/* for padding, zero if unused */</span></span><br><span class="line">__u32          sizeimage;</span><br><span class="line">__u32colorspace;<span class="comment">/* enum v4l2_colorspace */</span></span><br><span class="line">__u32priv;<span class="comment">/* private data, depends on pixelformat */</span></span><br><span class="line">__u32flags;<span class="comment">/* format flags (V4L2_PIX_FMT_FLAG_*) */</span></span><br><span class="line">__u32ycbcr_enc;<span class="comment">/* enum v4l2_ycbcr_encoding */</span></span><br><span class="line">__u32quantization;<span class="comment">/* enum v4l2_quantization */</span></span><br><span class="line">__u32xfer_func;<span class="comment">/* enum v4l2_xfer_func */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="ç”³è¯·ç¼“å†²åŒº">ç”³è¯·ç¼“å†²åŒº</h4><p><code>VIDIOC_REQBUFS</code> ç”³è¯·ç¼“å†²åŒºéœ€è¦åº”ç”¨ç¨‹åºæ¥åšï¼Œå¯ä»¥ç”³è¯·å¤šä¸ª bufferï¼Œä½†é©±åŠ¨ç¨‹åºä¸ä¸€å®šèƒ½ç”³è¯·åˆ°ã€‚é€šè¿‡ç»“æ„ä½“ v4l2_requestbuffers è¯·æ±‚é©±åŠ¨ç”³è¯·ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç”¨äºç¼“å­˜è§†é¢‘ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *M E M O R Y - M A P P I N G   B U F F E R S</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_requestbuffers</span> &#123;</span></span><br><span class="line">__u32count;<span class="comment">// ç¼“å†²åŒºå†…ç¼“å†²å¸§çš„æ•°ç›®</span></span><br><span class="line">__u32type;<span class="comment">/* enum v4l2_buf_type ç¼“å†²å¸§æ•°æ®æ ¼å¼ */</span></span><br><span class="line">__u32memory;<span class="comment">/* enum v4l2_memory åŒºåˆ«æ˜¯å†…å­˜æ˜ å°„è¿˜æ˜¯ç”¨æˆ·æŒ‡é’ˆæ–¹å¼ */</span></span><br><span class="line">__u32reserved[<span class="number">2</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æšä¸¾ä½“ v4l2_memoryï¼Œä¸€èˆ¬ä½¿ç”¨ mmap æ–¹å¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">v4l2_memory</span> &#123;</span></span><br><span class="line">V4L2_MEMORY_MMAP             = <span class="number">1</span>,</span><br><span class="line">V4L2_MEMORY_USERPTR          = <span class="number">2</span>,</span><br><span class="line">V4L2_MEMORY_OVERLAY          = <span class="number">3</span>,</span><br><span class="line">V4L2_MEMORY_DMABUF           = <span class="number">4</span>,<span class="comment">// è¿™ä¸ªåº”è¯¥æ˜¯æ–°ç‰ˆæœ¬çš„</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æŸ¥è¯¢ç¼“å†²åŒº">æŸ¥è¯¢ç¼“å†²åŒº</h4><p><code>VIDIOC_QUERYBUF</code> æŸ¥è¯¢ buffer ä¿¡æ¯ï¼Œå¦‚æœç”³è¯·äº† N ä¸ª bufferï¼Œioctl å°±åº”è¯¥æ‰§è¡Œ N æ¬¡ï¼Œæ‰§è¡Œ mmap åï¼Œåº”ç”¨ç¨‹åºå°±å¯ä»¥ç›´æ¥è¯»å†™è¿™äº› buffer äº†ã€‚</p><p>v4l2_buffer ç»“æ„ä½“å­˜æ”¾ buffer çš„ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct v4l2_buffer - video buffer info</span></span><br><span class="line"><span class="comment"> * @index:id number of the buffer</span></span><br><span class="line"><span class="comment"> * @type:enum v4l2_buf_type; buffer type (type == *_MPLANE for</span></span><br><span class="line"><span class="comment"> *multiplanar buffers);</span></span><br><span class="line"><span class="comment"> * @bytesused:number of bytes occupied by data in the buffer (payload);</span></span><br><span class="line"><span class="comment"> *unused (set to 0) for multiplanar buffers</span></span><br><span class="line"><span class="comment"> * @flags:buffer informational flags</span></span><br><span class="line"><span class="comment"> * @field:enum v4l2_field; field order of the image in the buffer</span></span><br><span class="line"><span class="comment"> * @timestamp:frame timestamp</span></span><br><span class="line"><span class="comment"> * @timecode:frame timecode</span></span><br><span class="line"><span class="comment"> * @sequence:sequence count of this frame</span></span><br><span class="line"><span class="comment"> * @memory:enum v4l2_memory; the method, in which the actual video data is</span></span><br><span class="line"><span class="comment"> *passed</span></span><br><span class="line"><span class="comment"> * @offset:for non-multiplanar buffers with memory == V4L2_MEMORY_MMAP;</span></span><br><span class="line"><span class="comment"> *offset from the start of the device memory for this plane,</span></span><br><span class="line"><span class="comment"> *(or a &quot;cookie&quot; that should be passed to mmap() as offset)</span></span><br><span class="line"><span class="comment"> * @userptr:for non-multiplanar buffers with memory == V4L2_MEMORY_USERPTR;</span></span><br><span class="line"><span class="comment"> *a userspace pointer pointing to this buffer</span></span><br><span class="line"><span class="comment"> * @fd:for non-multiplanar buffers with memory == V4L2_MEMORY_DMABUF;</span></span><br><span class="line"><span class="comment"> *a userspace file descriptor associated with this buffer</span></span><br><span class="line"><span class="comment"> * @planes:for multiplanar buffers; userspace pointer to the array of plane</span></span><br><span class="line"><span class="comment"> *info structs for this buffer</span></span><br><span class="line"><span class="comment"> * @length:size in bytes of the buffer (NOT its payload) for single-plane</span></span><br><span class="line"><span class="comment"> *buffers (when type != *_MPLANE); number of elements in the</span></span><br><span class="line"><span class="comment"> *planes array for multi-plane buffers</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Contains data exchanged by application and driver using one of the Streaming</span></span><br><span class="line"><span class="comment"> * I/O methods.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_buffer</span> &#123;</span></span><br><span class="line">__u32index;</span><br><span class="line">__u32type;</span><br><span class="line">__u32bytesused;</span><br><span class="line">__u32flags;</span><br><span class="line">__u32field;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span><span class="title">timestamp</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_timecode</span><span class="title">timecode</span>;</span></span><br><span class="line">__u32sequence;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* memory location */</span></span><br><span class="line">__u32memory;</span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">__u32           offset;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span>   userptr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">v4l2_plane</span> *<span class="title">planes</span>;</span></span><br><span class="line">__s32fd;</span><br><span class="line">&#125; m;</span><br><span class="line">__u32length;</span><br><span class="line">__u32reserved2;</span><br><span class="line">__u32reserved;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æ”¾å…¥-å–å‡ºé˜Ÿåˆ—">æ”¾å…¥/å–å‡ºé˜Ÿåˆ—</h4><p><code>VIDIOC_QBUF</code> æŠŠ buffer æ”¾å…¥é˜Ÿåˆ—ï¼Œå¦‚æœç”³è¯·äº† N ä¸ª bufferï¼Œioctl å°±åº”è¯¥æ‰§è¡Œ N æ¬¡ã€‚</p><p><code>VIDIOC_DQBUF</code> æŠŠ buffer ä»é˜Ÿåˆ—ä¸­å–å‡ºã€‚</p><h4 id="å¯åŠ¨-åœæ­¢æ‘„åƒå¤´æ•°æ®æµ">å¯åŠ¨/åœæ­¢æ‘„åƒå¤´æ•°æ®æµ</h4><p><code>VIDIOC_STREAMON</code> å’Œ <code>VIDIOC_STREAMOFF</code>ï¼Œå¼€å¯æ‘„åƒå¤´æ•°æ®æµåä¸€èˆ¬æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä½¿ç”¨ poll/select ç›‘æµ‹ buffer æ˜¯å¦æœ‰æ•°æ®ï¼Œç„¶åä»è¾“å‡ºé˜Ÿåˆ—ä¸­å–å‡º bufferï¼Œå¤„ç†åå†æ”¾å…¥è¾“å…¥é˜Ÿåˆ—ã€‚</p><blockquote><p><a href="https://blog.csdn.net/eastmoon502136/article/details/8190262">å’Œèœé¸Ÿä¸€èµ·å­¦linuxä¹‹V4L2æ‘„åƒå¤´åº”ç”¨æµç¨‹-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/g_salamander/article/details/8107692">v4l2 ç¼–ç¨‹æ¥å£(ä¸€) â€” ioctl_v4l2 å¸§id-CSDNåšå®¢</a></p></blockquote><h2 id="é…ç½®å†…æ ¸æ”¯æŒ-usb-æ‘„åƒå¤´">é…ç½®å†…æ ¸æ”¯æŒ USB æ‘„åƒå¤´</h2><p>æ‘„åƒå¤´æœ‰å¤šç§æ¥å£ MIPIã€DVPã€USB ç­‰ï¼Œè¿™é‡Œå…ˆä½¿ç”¨äº† USB æ‘„åƒå¤´ä¸Šæ‰‹ä¸€ä¸‹ï¼Œåç»­å†æ”¹ç”¨å…¶ä»–æ¥å£çš„æ‘„åƒå¤´ã€‚ä½¿ç”¨ USB æ‘„åƒå¤´æ˜¯å› ä¸ºæ”¯æŒ UVCï¼ˆUSB Video Captureï¼‰åè®®ï¼Œå¯ä»¥ä¸ç”¨å†™é©±åŠ¨æ–‡ä»¶å…ˆç†Ÿæ‚‰ä¸‹ v4l2 æ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ USB å…é©±ã€‚</p><h3 id="ä½¿èƒ½-uvc-é©±åŠ¨">ä½¿èƒ½ UVC é©±åŠ¨</h3><p>Linux å†…æ ¸å·²ç»å¸®æˆ‘ä»¬å†™å¥½äº† UVC é©±åŠ¨ï¼Œæˆ‘ä»¬åªéœ€è¦<strong>åœ¨ Linux å†…æ ¸é…ç½®ä¸­ä½¿èƒ½ UVC é©±åŠ¨</strong>å³å¯ã€‚</p><p>è¿›å…¥ Linux å†…æ ¸å›¾å½¢é…ç½®ç•Œé¢</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line"></span><br><span class="line">Device Drivers -&gt;</span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">Multimedia Support</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">Media USB Adapters--</span></span><br><span class="line"><span class="meta prompt_">-&gt;</span><span class="language-bash">USB Video Class(UVC)</span></span><br></pre></td></tr></table></figure><p><img src="image-20240812151124836.png" alt="image-20240812151124836"></p><p>è‹¥æ²¡æœ‰ USB Video Classï¼ˆUVCï¼‰è¿™ä¸€é¡¹ï¼Œåˆ™æœç´¢ <code>USB_VIDEO_CLASS</code> æŸ¥çœ‹å…¶ä¾èµ–é¡¹ï¼Œç„¶åå°†å…¶ä¾èµ–é¡¹éƒ½é€‰æ‹©ï¼Œä¿å­˜åé‡æ–°æ‰“å¼€ã€‚</p><p><img src="image-20240812151323053.png" alt="image-20240812151323053"></p><p>æ¥ç€æ‰“å¼€ <code>Soc camera support</code> å’Œ <code>platform camera support</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Device Drivers -&gt;</span><br><span class="line">-&gt;Multimedia Support</span><br><span class="line">-&gt;Media USB Adapters--</span><br><span class="line">-&gt;V4L platform devices</span><br></pre></td></tr></table></figure><p><img src="image-20240812151643873.png" alt="image-20240812151643873"></p><h3 id="æ·»åŠ æ‘„åƒå¤´çš„-pid-å’Œ-vid">æ·»åŠ æ‘„åƒå¤´çš„ PID å’Œ VID</h3><p>å°†æ‘„åƒå¤´æ’ä¸Šç”µè„‘ä¸Šï¼Œæ‰“å¼€è®¾å¤‡ç®¡ç†å™¨æŸ¥çœ‹æ‘„åƒå¤´çš„ PID å’Œ VIDï¼š</p><p><img src="image-20240812151947981.png" alt="image-20240812151947981"></p><p>æ‰“å¼€å†…æ ¸æ–‡ä»¶ä¸­çš„ <code>drivers/media/usb/uvc/uvc_driver.c</code>ï¼Œæ‰¾åˆ°ç»“æ„ä½“ <code>uvc_ids</code> ä»¿ç…§å…¶ä»–æ‘„åƒå¤´çš„ä»£ç ï¼Œæ·»åŠ æ‘„åƒå¤´çš„ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* add my camera modify your pid and vid */</span></span><br><span class="line">        &#123; .match_flags          = USB_DEVICE_ID_MATCH_DEVICE</span><br><span class="line">                                | USB_DEVICE_ID_MATCH_INT_INFO,</span><br><span class="line">          .idVendor             = <span class="number">0x1bcf</span>,</span><br><span class="line">          .idProduct            = <span class="number">0x0b09</span>,</span><br><span class="line">          .bInterfaceClass      = USB_CLASS_VIDEO,</span><br><span class="line">          .bInterfaceSubClass   = <span class="number">1</span>,</span><br><span class="line">          .bInterfaceProtocol   = <span class="number">0</span>,</span><br><span class="line">          .driver_info          = UVC_QUIRK_RESTRICT_FRAME_RATE &#125;,</span><br></pre></td></tr></table></figure><p>æœ€åé‡æ–°ç¼–è¯‘å†…æ ¸å¹¶å°†æ–°å†…æ ¸é‡æ–°çƒ§å½•åˆ°å¼€å‘æ¿ä¸Šï¼Œæ’ä¸Šæ‘„åƒå¤´å°±å¯ä»¥æ£€æµ‹æ­é…è®¾å¤‡äº†ã€‚</p><p><img src="image-20240812153137246.png" alt="image-20240812153137246"></p><p>æˆ‘çš„å¼€å‘æ¿ä¸Šé»˜è®¤æœ‰ <code>/dev/video0</code> è¿™ä¸ªèŠ‚ç‚¹äº†ï¼Œæ‰€ä»¥æ’å…¥æ‘„åƒå¤´åæ˜¯ <code>/dev/video1</code>ã€‚</p><h2 id="ç¼–å†™åº”ç”¨ç¨‹åºæµ‹è¯•">ç¼–å†™åº”ç”¨ç¨‹åºæµ‹è¯•</h2><p>å¯å‚è€ƒ mjpg-streamer é¡¹ç›®ä¸­çš„ <code>plugins/input_uvc</code> ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚</p><blockquote><p><a href="https://github.com/jacksonliam/mjpg-streamer/tree/master">jacksonliam/mjpg-streamer: Fork of http://sourceforge.net/projects/mjpg-streamer/ (github.com)</a></p></blockquote><p>uvc_camera_capture.h æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> UVC_CAMERA_CAPTURE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UVC_CAMERA_CAPTURE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/videodev2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jpeglib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBG(...) printf(__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBG(...)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NB_BUFFER 4</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vdIn</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">char</span> *videodevice;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_fmtdesc</span> <span class="title">fmtdesc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_frmsizeenum</span> <span class="title">frmsizeenum</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_streamparm</span> <span class="title">streamparm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_capability</span> <span class="title">cap</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_format</span> <span class="title">fmt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_buffer</span> <span class="title">buf</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">v4l2_requestbuffers</span> <span class="title">rb</span>;</span></span><br><span class="line">    <span class="type">void</span> *mem[NB_BUFFER];</span><br><span class="line">    <span class="type">int</span> width;</span><br><span class="line">    <span class="type">int</span> height;</span><br><span class="line">    <span class="type">int</span> fps;</span><br><span class="line">    <span class="type">int</span> formatIn;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lcdFramebuffer</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">var</span>;</span>   <span class="comment">/* LCDå¯å˜å‚æ•° */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *base;          <span class="comment">/* Framebufferæ˜ å°„åŸºåœ°å€ */</span>   </span><br><span class="line">    <span class="type">int</span> width, height;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>uvc_camera_capture.c æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;uvc_camera_capture.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;time.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">jpeg_to_rgb</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *jpegData, <span class="type">char</span> *rgbData, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">clock_t</span> start_time, end_time;</span><br><span class="line">    start_time = clock();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">jpeg_error_mgr</span> <span class="title">jerr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">jpeg_decompress_struct</span> <span class="title">cinfo</span>;</span></span><br><span class="line">cinfo.err = jpeg_std_error(&amp;jerr);</span><br><span class="line"><span class="comment">// 1. åˆ›å»ºè§£ç å¯¹è±¡å¹¶ä¸”åˆå§‹åŒ–</span></span><br><span class="line">jpeg_create_decompress(&amp;cinfo);</span><br><span class="line"><span class="comment">// 2. è£…å¤‡è§£ç çš„æ•°æ®</span></span><br><span class="line"><span class="comment">//jpeg_stdio_src(&amp;cinfo, infile);</span></span><br><span class="line">jpeg_mem_src(&amp;cinfo, jpegData, size);</span><br><span class="line"><span class="comment">// 3. è·å–jpegå›¾ç‰‡æ–‡ä»¶çš„å‚æ•°</span></span><br><span class="line">jpeg_read_header(&amp;cinfo, TRUE);</span><br><span class="line"><span class="comment">/* Step 4: set parameters for decompression */</span></span><br><span class="line"><span class="comment">// 5. å¼€å§‹è§£ç </span></span><br><span class="line">jpeg_start_decompress(&amp;cinfo);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">è°ƒç”¨jpeg_start_decompresså‡½æ•°ä¹‹åï¼ŒJPEGè§£å‹å¯¹è±¡dinfoä¸­</span></span><br><span class="line"><span class="comment">ä¸‹é¢è¿™å‡ ä¸ªå­—æ®µ(æˆå‘˜å˜é‡)å°†ä¼šæ¯”è¾ƒæœ‰ç”¨ï¼š</span></span><br><span class="line"><span class="comment">dinfo.output_width: å›¾åƒè¾“å‡ºå®½åº¦ï¼Œä¸€è¡Œå å¤šå°‘ä¸ªåƒç´ ç‚¹</span></span><br><span class="line"><span class="comment">dinfo.output_height:å›¾åƒè¾“å‡ºé«˜åº¦ï¼Œå å¤šå°‘è¡Œ</span></span><br><span class="line"><span class="comment">dinfo.output_components:  æ¯ä¸ªåƒç´ ç‚¹çš„åˆ†é‡æ•°ï¼Œæ¯ä¸ªåƒç´ ç‚¹å å¤šå°‘ä¸ªå­—èŠ‚</span></span><br><span class="line"><span class="comment">3ï¼š R G B</span></span><br><span class="line"><span class="comment">4ï¼šA R G B</span></span><br><span class="line"><span class="comment">width * height * components</span></span><br><span class="line"><span class="comment">åœ¨è°ƒç”¨jpeg_start_decompressä¹‹åï¼Œå¾€å¾€éœ€è¦ä¸ºè§£å‹åçš„æ‰«æçº¿ä¸Šçš„</span></span><br><span class="line"><span class="comment">æ‰€æœ‰åƒç´ ç‚¹åˆ†é…å­˜å‚¨ç©ºé—´ï¼š </span></span><br><span class="line"><span class="comment">å­˜ä¸€è¡Œï¼š output_width * output_components</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 6.ç”³è¯·å­˜å‚¨ä¸€è¡Œæ•°æ®çš„å†…å­˜ç©ºé—´</span></span><br><span class="line"><span class="type">int</span> row_stride = cinfo.output_width * cinfo.output_components;</span><br><span class="line">    <span class="comment">//printf(&quot;output_width: %d, output_components: %d\n&quot;, cinfo.output_width, cinfo.output_components);</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *buffer = <span class="built_in">malloc</span>(row_stride);</span><br><span class="line">    <span class="comment">// dinfo.output_scanline , è¡¨ç¤ºçš„æ„æ€æ˜¯ï¼Œå·²ç»æ‰«æäº†å¤šå°‘è¡Œ</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (cinfo.output_scanline &lt; cinfo.output_height) &#123;</span><br><span class="line">        jpeg_read_scanlines(&amp;cinfo, &amp;buffer, <span class="number">1</span>); </span><br><span class="line">    <span class="built_in">memcpy</span>(rgbData + i * <span class="number">640</span> * <span class="number">3</span>, buffer, row_stride);</span><br><span class="line">i++;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">å¯¹æ‰«æçº¿çš„è¯»å–æ˜¯æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºè¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å›¾åƒæœ€ä¸Šæ–¹çš„æ‰«æçº¿æœ€å…ˆ</span></span><br><span class="line"><span class="comment">è¢«jpeg_read_scanlines()è¯»å…¥åˆ°å­˜å‚¨ç©ºé—´ä¸­ï¼Œç´§æ¥ç€æ˜¯ç¬¬äºŒè¡Œæ‰«æçº¿ï¼Œæœ€åæ˜¯</span></span><br><span class="line"><span class="comment">å›¾åƒåº•è¾¹çš„æ‰«æçº¿è¢«è¯»å…¥åˆ°å­˜å‚¨ç©ºé—´ä¸­å»ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 7.è§£ç å®Œæˆ</span></span><br><span class="line">jpeg_finish_decompress(&amp;cinfo);</span><br><span class="line"><span class="comment">// 8.é‡Šæ”¾è§£ç å¯¹è±¡</span></span><br><span class="line">jpeg_destroy_decompress(&amp;cinfo);</span><br><span class="line">    <span class="built_in">free</span>(buffer);</span><br><span class="line"></span><br><span class="line">    end_time = clock();</span><br><span class="line">    DBG(<span class="string">&quot;mjpeg to rgb waste time %f s\n&quot;</span>, (<span class="type">double</span>)(end_time - start_time)/CLOCKS_PER_SEC);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†æ•°æ®æµä»¥3å­—èŠ‚ä¸ºå•ä½æ‹·è´åˆ°rgbæ˜¾å­˜ä¸­</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">lcd_show_rgb</span><span class="params">(<span class="keyword">struct</span> lcdFramebuffer *lfb, <span class="type">unsigned</span> <span class="type">char</span> *rgbData, <span class="type">int</span> width ,<span class="type">int</span> height)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">clock_t</span> start_time, end_time;</span><br><span class="line">    start_time = clock();</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *row_start = lfb-&gt;base; </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *ptr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *srcData = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> r, g, b;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; height; i++)&#123;</span><br><span class="line">        ptr = row_start;     <span class="comment">// æ¯æ¬¡æŒ‡å‘å½“å‰è¡Œçš„èµ·å§‹åœ°å€</span></span><br><span class="line">        srcData = rgbData;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; width; j++)&#123;</span><br><span class="line">            <span class="comment">// r = *srcData++;</span></span><br><span class="line">            <span class="comment">// g = *srcData++;</span></span><br><span class="line">            <span class="comment">// b = *srcData++;</span></span><br><span class="line">            <span class="comment">// *ptr++ = (0xFF &lt;&lt; 24) | ((unsigned int)r &lt;&lt; 16) |</span></span><br><span class="line">            <span class="comment">//          ((unsigned int)g &lt;&lt; 8) | (unsigned int)b;</span></span><br><span class="line">            *ptr++ = (<span class="number">0xFF</span> &lt;&lt; <span class="number">24</span>) | ((*srcData++) &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">                     ((*srcData++) &lt;&lt; <span class="number">8</span>) | (*srcData++);</span><br><span class="line">        &#125;</span><br><span class="line">        rgbData += width * <span class="number">3</span>;      <span class="comment">// å›¾åƒå¤§å°çš„åç§»</span></span><br><span class="line">        row_start += lfb-&gt;width;   <span class="comment">// å±å¹•å¤§å°çš„åç§»</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    end_time = clock();</span><br><span class="line">    DBG(<span class="string">&quot;Write fb waste time %f s\n&quot;</span>, (<span class="type">double</span>)(end_time - start_time)/CLOCKS_PER_SEC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* fcc2s - convert pixelformat to string</span></span><br><span class="line"><span class="comment">* (Obtained from vtl-utils: v4l2-ctl.cpp)</span></span><br><span class="line"><span class="comment">* args:</span></span><br><span class="line"><span class="comment">* fmsString - char* to hold string</span></span><br><span class="line"><span class="comment">* size - size of allocated memory for string</span></span><br><span class="line"><span class="comment">* pixelformat - v4l2 pixel format identidifier</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">fcc2s</span><span class="params">(<span class="type">char</span>* fmtString, <span class="type">unsigned</span> <span class="type">int</span> size, <span class="type">unsigned</span> <span class="type">int</span> pixelformat)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size &lt; <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    fmtString[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  fmtString[<span class="number">0</span>] = pixelformat &amp; <span class="number">0x7f</span>;</span><br><span class="line">  fmtString[<span class="number">1</span>] = (pixelformat &gt;&gt;  <span class="number">8</span> ) &amp; <span class="number">0x7f</span>;</span><br><span class="line">  fmtString[<span class="number">2</span>] = (pixelformat &gt;&gt;  <span class="number">16</span> ) &amp; <span class="number">0x7f</span>;</span><br><span class="line">  fmtString[<span class="number">3</span>] = (pixelformat &gt;&gt; <span class="number">24</span> ) &amp; <span class="number">0x7f</span>;</span><br><span class="line">  <span class="keyword">if</span> (pixelformat &amp; (<span class="number">1</span> &lt;&lt; <span class="number">31</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    fmtString[<span class="number">4</span>] = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">    fmtString[<span class="number">5</span>] = <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">    fmtString[<span class="number">6</span>] = <span class="string">&#x27;E&#x27;</span>;</span><br><span class="line">    fmtString[<span class="number">7</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    fmtString[<span class="number">4</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">init_v4l2</span><span class="params">(<span class="keyword">struct</span> vdIn *vd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> pixelFromatNum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> formatFrameSizeNum = <span class="number">0</span>;</span><br><span class="line">    vd-&gt;fd = open(vd-&gt;videodevice, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(vd-&gt;fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;ERROR opening V4L interface&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ‘„åƒå¤´èƒ½åŠ›</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;vd-&gt;cap, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> v4l2_capability));</span><br><span class="line">    ret = ioctl(vd-&gt;fd, VIDIOC_QUERYCAP, &amp;vd-&gt;cap);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error opening device %s: unable to query deivce.\n&quot;</span>, vd-&gt;videodevice);</span><br><span class="line">        <span class="keyword">goto</span> fatal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DBG(<span class="string">&quot;driver:\t\t%s\n&quot;</span>, vd-&gt;cap.driver);</span><br><span class="line">    DBG(<span class="string">&quot;card:\t\t%s\n&quot;</span>, vd-&gt;cap.card);</span><br><span class="line">    DBG(<span class="string">&quot;bus_info:\t%s\n&quot;</span>, vd-&gt;cap.bus_info);</span><br><span class="line">    DBG(<span class="string">&quot;version:\t%d\n&quot;</span>, vd-&gt;cap.version);</span><br><span class="line">    DBG(<span class="string">&quot;capabilities:\t%x\n&quot;</span>, vd-&gt;cap.capabilities);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>((vd-&gt;cap.capabilities &amp; V4L2_CAP_VIDEO_CAPTURE) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Error opening device %s: video capture not supported.\n&quot;</span>,</span><br><span class="line">                vd-&gt;videodevice);</span><br><span class="line">        <span class="keyword">goto</span> fatal;;</span><br><span class="line">    &#125;</span><br><span class="line">    DBG(<span class="string">&quot;%s supports capture.\n&quot;</span>, vd-&gt;videodevice);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(vd-&gt;cap.capabilities &amp; V4L2_CAP_STREAMING == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s does not support streaming i/o\n&quot;</span>, vd-&gt;videodevice);</span><br><span class="line">            <span class="keyword">goto</span> fatal;</span><br><span class="line">    &#125;</span><br><span class="line">    DBG(<span class="string">&quot;%s supports streaming.\n&quot;</span>, vd-&gt;videodevice);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–cameraä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;vd-&gt;fmtdesc, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> v4l2_fmtdesc));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;vd-&gt;streamparm, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> v4l2_streamparm));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;vd-&gt;frmsizeenum, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> v4l2_frmsizeenum));</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;   </span><br><span class="line">        vd-&gt;fmtdesc.index = pixelFromatNum++;</span><br><span class="line">        vd-&gt;fmtdesc.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;     <span class="comment">// è®¾ç½®è§†é¢‘é‡‡é›†è®¾å¤‡ç±»å‹</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–æ‘„åƒå¤´æ”¯æŒçš„æ ¼å¼</span></span><br><span class="line">        ret = ioctl(vd-&gt;fd, VIDIOC_ENUM_FMT, &amp;vd-&gt;fmtdesc);</span><br><span class="line">        <span class="keyword">if</span>(ret != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// è·å–é»˜è®¤å¸§ç‡</span></span><br><span class="line">        vd-&gt;streamparm.type = V4L2_BUF_TYPE_VIDEO_CAPTURE; <span class="comment">// è®¾ç½®è§†é¢‘é‡‡é›†è®¾å¤‡ç±»å‹</span></span><br><span class="line">        ret = ioctl(vd-&gt;fd, VIDIOC_G_PARM, &amp;vd-&gt;streamparm);</span><br><span class="line">        <span class="keyword">if</span>(ret == <span class="number">0</span>)</span><br><span class="line">            DBG(<span class="string">&quot;Default FPS: %d fps\n&quot;</span>, vd-&gt;streamparm.parm.capture.timeperframe.denominator);</span><br><span class="line">           </span><br><span class="line">        <span class="comment">// åˆ—å‡ºè¯¥æ ¼å¼ä¸‹æ”¯æŒçš„åˆ†è¾¨ç‡</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            vd-&gt;frmsizeenum.index = formatFrameSizeNum++;</span><br><span class="line">            vd-&gt;frmsizeenum.pixel_format = vd-&gt;fmtdesc.pixelformat;</span><br><span class="line">            </span><br><span class="line">            ret = ioctl(vd-&gt;fd, VIDIOC_ENUM_FRAMESIZES, &amp;vd-&gt;frmsizeenum);</span><br><span class="line">            <span class="keyword">if</span>(ret == <span class="number">0</span>)</span><br><span class="line">                DBG(<span class="string">&quot;Support Format:%s, %d, FrameSize %d: %d x %d\n&quot;</span>, vd-&gt;fmtdesc.description, vd-&gt;fmtdesc.pixelformat,</span><br><span class="line">                        formatFrameSizeNum, vd-&gt;frmsizeenum.discrete.width, vd-&gt;frmsizeenum.discrete.height);</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        formatFrameSizeNum = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é‡‡é›†æ ¼å¼</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;vd-&gt;fmt, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> v4l2_format));</span><br><span class="line">    vd-&gt;fmt.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;</span><br><span class="line">    vd-&gt;fmt.fmt.pix.width = vd-&gt;width;</span><br><span class="line">    vd-&gt;fmt.fmt.pix.height = vd-&gt;height;</span><br><span class="line">    vd-&gt;fmt.fmt.pix.pixelformat = vd-&gt;formatIn;</span><br><span class="line">    vd-&gt;fmt.fmt.pix.field = V4L2_FIELD_ANY;</span><br><span class="line">    ret = ioctl(vd-&gt;fd, VIDIOC_S_FMT, &amp;vd-&gt;fmt);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Unable to set format: %d res: %dx%d\n&quot;</span>, vd-&gt;formatIn, vd-&gt;width, vd-&gt;height);</span><br><span class="line">        <span class="keyword">goto</span> fatal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥è®¾ç½®åˆ†è¾¨ç‡æ˜¯å¦æ­£ç¡® é”™è¯¯åˆ™è‡ªåŠ¨è®¾ç½®</span></span><br><span class="line">    <span class="keyword">if</span>((vd-&gt;fmt.fmt.pix.width != vd-&gt;width) || (vd-&gt;fmt.fmt.pix.height != vd-&gt;height))&#123;</span><br><span class="line">        vd-&gt;width = vd-&gt;fmt.fmt.pix.width;</span><br><span class="line">        vd-&gt;height = vd-&gt;fmt.fmt.pix.height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥é‡‡é›†çš„åƒç´ æ ¼å¼æ˜¯å¦æ­£ç¡® é”™è¯¯åˆ™è‡ªåŠ¨è®¾ç½®</span></span><br><span class="line">    <span class="keyword">if</span>(vd-&gt;formatIn != vd-&gt;fmt.fmt.pix.pixelformat)&#123;</span><br><span class="line">        <span class="type">char</span> fmtStringRequested[<span class="number">8</span>];</span><br><span class="line">        <span class="type">char</span> fmtStringObtained[<span class="number">8</span>];</span><br><span class="line">        fcc2s(fmtStringObtained, <span class="number">8</span>, vd-&gt;fmt.fmt.pix.pixelformat);</span><br><span class="line">        fcc2s(fmtStringRequested, <span class="number">8</span>, vd-&gt;formatIn);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot; i: Could not obtain the requested pixelformat: %s , driver gave us: %s\n&quot;</span>,fmtStringRequested, fmtStringObtained);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot; i: The specified resolution is unavailable, using: width %d height %d instead \n&quot;</span>, vd-&gt;fmt.fmt.pix.width, vd-&gt;fmt.fmt.pix.height);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span>(vd-&gt;fmt.fmt.pix.pixelformat)&#123;</span><br><span class="line">            <span class="keyword">case</span> V4L2_PIX_FMT_JPEG:</span><br><span class="line">            <span class="comment">// Fall-through intentional</span></span><br><span class="line">            <span class="keyword">case</span> V4L2_PIX_FMT_MJPEG:</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;    ... Falling back to the faster MJPG mode (consider changing cmd line options).\n&quot;</span>);</span><br><span class="line">                vd-&gt;formatIn = vd-&gt;fmt.fmt.pix.pixelformat;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> V4L2_PIX_FMT_YUYV:</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;    ... Falling back to YUV mode (consider using -yuv option). Note that this requires much more CPU power\n&quot;</span>);</span><br><span class="line">                vd-&gt;formatIn = vd-&gt;fmt.fmt.pix.pixelformat;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> V4L2_PIX_FMT_UYVY:</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;    ... Falling back to UYVY mode (consider using -uyvy option). Note that this requires much more CPU power\n&quot;</span>);</span><br><span class="line">                vd-&gt;formatIn = vd-&gt;fmt.fmt.pix.pixelformat;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> V4L2_PIX_FMT_RGB24:</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;    ... Falling back to RGB24 mode (consider using -fourcc RGB24 option). Note that this requires much more CPU power\n&quot;</span>);</span><br><span class="line">                vd-&gt;formatIn = vd-&gt;fmt.fmt.pix.pixelformat;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> V4L2_PIX_FMT_RGB565:</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;    ... Falling back to RGB565 mode (consider using -fourcc RGBP option). Note that this requires much more CPU power\n&quot;</span>);</span><br><span class="line">                vd-&gt;formatIn = vd-&gt;fmt.fmt.pix.pixelformat;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">goto</span> fatal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> fmtStringRequested[<span class="number">8</span>];</span><br><span class="line">    fcc2s(fmtStringRequested, <span class="number">8</span>, vd-&gt;formatIn);</span><br><span class="line">    DBG(<span class="string">&quot;Set Format: %s, FrameSize: %d x %d\n&quot;</span>, fmtStringRequested, vd-&gt;width, vd-&gt;height);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;vd-&gt;rb, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> v4l2_requestbuffers));</span><br><span class="line">    vd-&gt;rb.count = NB_BUFFER;</span><br><span class="line">    vd-&gt;rb.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;</span><br><span class="line">    vd-&gt;rb.memory = V4L2_MEMORY_MMAP;   <span class="comment">// mmapæ–¹å¼</span></span><br><span class="line">    ret = ioctl(vd-&gt;fd, VIDIOC_REQBUFS, &amp;vd-&gt;rb);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;Unable to allocate buffers&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> fatal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mmapå†…å­˜</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NB_BUFFER; i++)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;vd-&gt;buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> v4l2_buffer));</span><br><span class="line">        vd-&gt;buf.index = i;</span><br><span class="line">        vd-&gt;buf.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;</span><br><span class="line">        vd-&gt;buf.memory = V4L2_MEMORY_MMAP;   <span class="comment">// mmapæ–¹å¼</span></span><br><span class="line"></span><br><span class="line">        ret = ioctl(vd-&gt;fd, VIDIOC_QUERYBUF, &amp;vd-&gt;buf); <span class="comment">// æŸ¥çœ‹buffer</span></span><br><span class="line">        <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;Unable to query buffer&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> fatal;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        vd-&gt;mem[i] = mmap(<span class="number">0</span>, vd-&gt;buf.length, PROT_READ | PROT_WRITE, </span><br><span class="line">                          MAP_SHARED, vd-&gt;fd, vd-&gt;buf.m.offset);</span><br><span class="line">        <span class="keyword">if</span>(vd-&gt;mem[i] == MAP_FAILED)&#123;</span><br><span class="line">            perror(<span class="string">&quot;Unable to map buffer&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> fatal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; NB_BUFFER; i++)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;vd-&gt;buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> v4l2_buffer));</span><br><span class="line">        vd-&gt;buf.index = i;</span><br><span class="line">        vd-&gt;buf.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;</span><br><span class="line">        vd-&gt;buf.memory = V4L2_MEMORY_MMAP;   <span class="comment">// mmapæ–¹å¼</span></span><br><span class="line">        ret = ioctl(vd-&gt;fd, VIDIOC_QBUF, &amp;vd-&gt;buf);</span><br><span class="line">        <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;Unable to queue buffer&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> fatal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fatal:</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Init v4L2 failed !! exit fatal\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">init_videoIn</span><span class="params">(<span class="keyword">struct</span> vdIn *vd, <span class="type">char</span> *device, <span class="type">int</span> width, </span></span><br><span class="line"><span class="params">                     <span class="type">int</span> height, <span class="type">int</span> fps, <span class="type">int</span> format)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(vd == <span class="literal">NULL</span> || device == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(width == <span class="number">0</span> || height == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    vd-&gt;videodevice = (<span class="type">char</span> *)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">16</span> * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">snprintf</span>(vd-&gt;videodevice, (<span class="number">16</span> - <span class="number">1</span>), <span class="string">&quot;%s&quot;</span>, device) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">free</span>(vd-&gt;videodevice);</span><br><span class="line">        vd-&gt;videodevice = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vd-&gt;width = width;</span><br><span class="line">    vd-&gt;height = height;</span><br><span class="line">    vd-&gt;fps = fps;</span><br><span class="line">    vd-&gt;formatIn = format;</span><br><span class="line">    <span class="keyword">if</span>(init_v4l2(vd) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// error</span></span><br><span class="line">        <span class="built_in">free</span>(vd-&gt;videodevice);</span><br><span class="line">        vd-&gt;videodevice = <span class="literal">NULL</span>;</span><br><span class="line">        close(vd-&gt;fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free(vd-&gt;videodevice);</span></span><br><span class="line">    <span class="comment">// close(vd-&gt;fd);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">video_enable</span><span class="params">(<span class="keyword">struct</span> vdIn *vd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> type = V4L2_BUF_TYPE_VIDEO_CAPTURE;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = ioctl(vd-&gt;fd, VIDIOC_STREAMON, &amp;type);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Unable to start capture&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//vd-&gt;streamingState = STREAMING_ON;</span></span><br><span class="line">    DBG(<span class="string">&quot;Starting capture\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">video_disable</span><span class="params">(<span class="keyword">struct</span> vdIn *vd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> type = V4L2_BUF_TYPE_VIDEO_CAPTURE;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = ioctl(vd-&gt;fd, VIDIOC_STREAMOFF, &amp;type);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Unable to stop capture&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    DBG(<span class="string">&quot;Stopping capture\n&quot;</span>);</span><br><span class="line">    <span class="comment">//vd-&gt;streamingState = disabledState;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">video_handle</span><span class="params">(<span class="keyword">struct</span> vdIn *vd, <span class="keyword">struct</span> lcdFramebuffer *lfb)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span>[1];</span></span><br><span class="line">    <span class="type">char</span> filename[<span class="number">128</span>];</span><br><span class="line">    <span class="type">int</span> file_cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰ä¸€ä¸ªç©ºé—´å­˜å‚¨è§£ç åçš„rgb</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> rgbData[<span class="number">640</span> * <span class="number">480</span> * <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">clock_t</span> start_time, end_time;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        start_time = clock();</span><br><span class="line">        <span class="comment">// 1.poll</span></span><br><span class="line">        <span class="built_in">memset</span>(fds, <span class="number">0</span>, <span class="keyword">sizeof</span>(fds));</span><br><span class="line">        fds[<span class="number">0</span>].fd = vd-&gt;fd;</span><br><span class="line">        fds[<span class="number">0</span>].events = POLLIN;</span><br><span class="line">        <span class="keyword">if</span>(poll(fds, <span class="number">1</span>, <span class="number">-1</span>) &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 2.æŠŠbufferå–å‡ºé˜Ÿåˆ—</span></span><br><span class="line">            <span class="built_in">memset</span>(&amp;vd-&gt;buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> v4l2_buffer));</span><br><span class="line">            vd-&gt;buf.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;</span><br><span class="line">            vd-&gt;buf.memory = V4L2_MEMORY_MMAP;   <span class="comment">// mmapæ–¹å¼</span></span><br><span class="line"></span><br><span class="line">            ret = ioctl(vd-&gt;fd, VIDIOC_DQBUF, &amp;vd-&gt;buf);</span><br><span class="line">            <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;Unable to dequeue buffer&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// // 3.å¤„ç†æ•°æ®ï¼Œè¿™é‡Œå°†bufferæ•°æ®å­˜å‚¨ä¸ºæ–‡ä»¶</span></span><br><span class="line">            <span class="comment">// sprintf(filename, &quot;video_raw_data_%04d.jpg&quot;, file_cnt++);</span></span><br><span class="line">            <span class="comment">// int fd_file = open(filename, O_RDWR | O_CREAT, 0666);</span></span><br><span class="line">            <span class="comment">// if(fd_file &lt; 0)</span></span><br><span class="line">            <span class="comment">// &#123;</span></span><br><span class="line">            <span class="comment">//     perror(&quot;create file error&quot;);</span></span><br><span class="line">            <span class="comment">//     close(fd);</span></span><br><span class="line">            <span class="comment">//     return -1;</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">            <span class="comment">// write(fd_file, userbuf[buffer.index], buffer.bytesused);</span></span><br><span class="line">            <span class="comment">// close(fd_file);</span></span><br><span class="line">            <span class="comment">// printf(&quot;create %s&quot;, filename);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.mjpgè½¬æ¢ä¸ºrgbå¹¶æ˜¾ç¤ºåœ¨lcdå±å¹•</span></span><br><span class="line">            jpeg_to_rgb(vd-&gt;mem[vd-&gt;buf.index], rgbData, vd-&gt;buf.length);</span><br><span class="line">            <span class="comment">//read_JPEG_file(vd-&gt;mem[vd-&gt;buf.index], rgbData, vd-&gt;buf.length);</span></span><br><span class="line">            lcd_show_rgb(lfb, rgbData, <span class="number">640</span>, <span class="number">480</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.æŠŠbufferæ”¾å…¥é˜Ÿåˆ—</span></span><br><span class="line">            ret = ioctl(vd-&gt;fd, VIDIOC_QBUF, &amp;vd-&gt;buf);</span><br><span class="line">            <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;Unable to queue buffer&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;</span><br><span class="line">        end_time = clock();</span><br><span class="line">        DBG(<span class="string">&quot;Each frame waste time: %f s\n&quot;</span>, (<span class="type">double</span>)(end_time - start_time)/CLOCKS_PER_SEC);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">init_framebuffer</span><span class="params">(<span class="keyword">struct</span> lcdFramebuffer *lfb, <span class="type">int</span> width, <span class="type">int</span> height)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(lfb == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€LCD</span></span><br><span class="line">    lfb-&gt;fd = open(<span class="string">&quot;/dev/fb0&quot;</span>, O_RDWR); </span><br><span class="line">    <span class="keyword">if</span>(lfb-&gt;fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;/dev/fb0&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–LCDå±å¹•ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (ioctl(lfb-&gt;fd, FBIOGET_VSCREENINFO, &amp;lfb-&gt;var))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;Unable to get fb_var_screeninfo&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fbæ˜ å°„ 4ä¸ªå­—èŠ‚ ARGB 8888</span></span><br><span class="line">    lfb-&gt;base = (<span class="type">unsigned</span> <span class="type">int</span>*)mmap(<span class="literal">NULL</span>, width * height * <span class="number">4</span>, </span><br><span class="line">                                    PROT_READ | PROT_WRITE, MAP_SHARED, lfb-&gt;fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(lfb-&gt;base == MAP_FAILED)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;Unable to map buffer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vdIn</span> *<span class="title">vd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lcdFramebuffer</span> *<span class="title">lfb</span>;</span></span><br><span class="line">    lfb = (<span class="keyword">struct</span> lcdFramebuffer *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> lcdFramebuffer));</span><br><span class="line">    vd = (<span class="keyword">struct</span> vdIn *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> vdIn));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ç»“æ„ä½“</span></span><br><span class="line">    init_videoIn(vd, <span class="string">&quot;/dev/video1&quot;</span>, <span class="number">640</span>, <span class="number">480</span>, <span class="number">30</span>, V4L2_PIX_FMT_MJPEG);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€æ‘„åƒå¤´</span></span><br><span class="line">    video_enable(vd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–fb</span></span><br><span class="line">    lfb-&gt;width = <span class="number">1024</span>;</span><br><span class="line">    lfb-&gt;height = <span class="number">600</span>;</span><br><span class="line">    init_framebuffer(lfb, <span class="number">1024</span>, <span class="number">600</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†æ•°æ®</span></span><br><span class="line">    video_handle(vd, lfb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”€æ¯videoå†…å­˜</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NB_BUFFER; i++) &#123;</span><br><span class="line">        munmap(vd-&gt;mem[i], vd-&gt;buf.length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(vd-&gt;videodevice);</span><br><span class="line">    vd-&gt;videodevice = <span class="literal">NULL</span>;</span><br><span class="line">    video_disable(vd);</span><br><span class="line">    close(vd-&gt;fd);</span><br><span class="line">    <span class="built_in">free</span>(vd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é”€æ¯fbå†…å­˜</span></span><br><span class="line">    munmap(lfb-&gt;base, lfb-&gt;width * lfb-&gt;height);</span><br><span class="line">    <span class="built_in">free</span>(lfb);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ—¥å¿—ï¼š</p><p><img src="image-20240813163957328.png" alt="image-20240813163957328"></p><p>æœ€ç»ˆæ˜¾ç¤ºåˆ†è¾¨ç‡ 640x480ï¼Œå¸§æ•° 25 ä¸Šä¸‹æµ®åŠ¨ï¼Œmjpeg è½¬ä¸º rgb æ ¼å¼æ¶ˆè€—æ—¶é—´å æ¯”è¾ƒå¤§ã€‚</p><p>ç”±äºæ‰‹ä¸Šçš„å±å¹•åˆ†è¾¨ç‡ä¸º 1024 * 600ï¼Œå…¶ä½™ä¸¤ç§å›¾åƒåˆ†è¾¨ç‡ä¸º 1280 x 720 å’Œ 1920 x 1080 ä¸èƒ½ç›´æ¥å†™å…¥ fb è¿›è¡Œæ˜¾ç¤ºï¼Œéœ€è¦å¯¹é‡‡é›†åˆ°çš„å›¾åƒåˆ†è¾¨ç‡è¿›è¡Œæ”¾å¤§ç¼©å°ç­‰æ“ä½œï¼Œè¾ƒä¸ºéº»çƒ¦ï¼Œåç»­ä½¿ç”¨ OpenCV åº“æ¥è¯•è¯•æ°´ã€‚</p><blockquote><p><a href="https://blog.csdn.net/small_po_kid/article/details/119931147">åœ¨linuxè™šæ‹Ÿæœºä¸Šæ˜¾ç¤ºæ‘„åƒå¤´è§†é¢‘ï¼ˆV4L2ç¼–ç¨‹ï¼‰_v4l2å‘½ä»¤è¡Œæ˜¾ç¤ºè§†é¢‘-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/small_po_kid/article/details/119932202">åµŒå…¥å¼linuxä¹‹åœ¨lcdä¸Šæ˜¾ç¤ºæ‘„åƒå¤´å›¾åƒ_esp32æ‘„åƒå¤´æ˜¾ç¤ºåœ¨lcdä¸Š-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/qq_41248872/article/details/83031000">V4L2å›¾åƒé‡‡é›†+å›¾ç‰‡æ ¼å¼è½¬æ¢ï¼ˆYUYVã€RGBã€JPEGï¼‰_qtä¸­ä½¿ç”¨v4l2å°†jpegæ ¼å¼çš„å›¾åƒè½¬åŒ–ä¸ºrbg-CSDNåšå®¢</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linux-v4l2-usb-camera&quot;&gt;Linux-V4L2-USB-Camera&lt;/h1&gt;
&lt;h2 id=&quot;åºè¨€&quot;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;åœ¨ Linux å¼€å‘æ¿ä¸Šä½¿ç”¨ V4L2 æ¡†æ¶é©±åŠ¨ usb æ‘„åƒå¤´ã€‚&lt;/p&gt;
&lt;h2 id=&quot;v4l2-ç®€è¿°&quot;&gt;V4L2</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux" scheme="http://www.obito.top/tags/Linux/"/>
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨EMQXæ­å»ºMQTTæœåŠ¡å™¨</title>
    <link href="http://www.obito.top/2024/07/22/%E4%BD%BF%E7%94%A8EMQX%E6%90%AD%E5%BB%BAMQTT%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>http://www.obito.top/2024/07/22/%E4%BD%BF%E7%94%A8EMQX%E6%90%AD%E5%BB%BAMQTT%E6%9C%8D%E5%8A%A1%E5%99%A8/</id>
    <published>2024-07-22T14:37:13.000Z</published>
    <updated>2024-12-21T10:51:02.725Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä½¿ç”¨emqxæ­å»ºmqttæœåŠ¡å™¨">ä½¿ç”¨EMQXæ­å»ºMQTTæœåŠ¡å™¨</h1><h2 id="åºè¨€">åºè¨€</h2><p>æ—©åˆæ˜¯ä½¿ç”¨é˜¿é‡Œäº‘å’Œ OneNET å¹³å°ä½œä¸º MQTT æœåŠ¡å™¨è¿›è¡Œä½¿ç”¨ï¼Œä½†æœ‰äº›åŠŸèƒ½éœ€è¦ moneyï¼Œæ‰€ä»¥å°±æƒ³ç€èƒ½ä¸èƒ½è‡ªå·±æ­å»ºä¸ªç®€æ˜“çš„æœåŠ¡å™¨æ¥è€è€ï¼ŒæŸ¥æ‰¾èµ„æ–™æ‰¾åˆ° EMQX å¾ˆç¬¦åˆè‡ªå·±çš„éœ€æ±‚ã€‚</p><p><a href="https://www.emqx.io/?__hstc=3614191.5d3d4ec83da83fa7c0c3952401d96e93.1717152719095.1717658001243.1721659210194.3&amp;__hssc=3614191.2.1721659210194&amp;__hsfp=886808949">EMQX</a> æ˜¯ä¸€æ¬¾å¤§è§„æ¨¡å¯å¼¹æ€§ä¼¸ç¼©çš„äº‘åŸç”Ÿåˆ†å¸ƒå¼ç‰©è”ç½‘ <a href="https://mqtt.org/">MQTT</a> æ¶ˆæ¯æœåŠ¡å™¨ã€‚</p><p>ä½œä¸ºå…¨çƒæœ€å…·æ‰©å±•æ€§çš„ MQTT æ¶ˆæ¯æœåŠ¡å™¨ï¼ŒEMQX æä¾›äº†é«˜æ•ˆå¯é æµ·é‡ç‰©è”ç½‘è®¾å¤‡è¿æ¥ï¼Œèƒ½å¤Ÿé«˜æ€§èƒ½å®æ—¶ç§»åŠ¨ä¸å¤„ç†æ¶ˆæ¯å’Œäº‹ä»¶æµæ•°æ®ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿæ„å»ºå…³é”®ä¸šåŠ¡çš„ç‰©è”ç½‘å¹³å°ä¸åº”ç”¨ã€‚</p><p>EMQX åˆ†ä¸ºä¸¤ä¸ªç‰ˆæœ¬ï¼šå¼€æºç‰ˆå’Œå•†ä¸šç‰ˆï¼Œè¿™é‡Œä½œä¸ºå­¦ä¹ ä½¿ç”¨ï¼Œä½¿ç”¨å¼€æºç‰ˆå³å¯ï¼Œæ–‡æ¡£å¦‚ä¸‹ï¼š</p><blockquote><p><a href="https://docs.emqx.com/zh/emqx/v5.0/">äº§å“æ¦‚è§ˆ | EMQX 5.0 æ–‡æ¡£</a></p></blockquote><h2 id="windowså®‰è£…emqx">Windowså®‰è£…EMQX</h2><p>EMQX æ”¯æŒå¤šå¹³å°å®‰è£…ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨ Windows æ¥å®‰è£…ï¼Œä¸‹è½½åœ°å€ï¼š</p><blockquote><p><a href="https://github.com/emqx/emqx/releases/tag/v5.3.2">Release EMQX v5.3.2 Â· emqx/emqx (github.com)</a></p></blockquote><p>ç›®å‰ä¸€äº›è¾ƒæ–°çš„ç‰ˆæœ¬å¥½åƒæ²¡æœ‰ Windows ç‰ˆæœ¬çš„ã€‚</p><p>è§£å‹å¾—åˆ°ï¼š</p><p><img src="image-20240722225644937.png" alt="image-20240722225644937"></p><p>å½“å‰ç›®å½•ä¸‹æ‰“å¼€ <code>Windows PowerShell</code> å‘½ä»¤è¡Œçª—å£ï¼Œè¾“å…¥å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\bin\emqx start</span><br></pre></td></tr></table></figure><p>å¯åŠ¨çš„æ—¶å€™ä¼šå¼¹å‡ºé˜²ç«å¢™æç¤ºçª—å£ï¼Œç‚¹å‡»å…è®¸è®¿é—®ã€‚æˆåŠŸä¼šæç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EMQX_NODE__DB_ROLE [node.role]: core</span><br><span class="line">EMQX_NODE__DB_BACKEND [node.db_backend]: mnesia</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.\bin\emqx start    å¯åŠ¨</span><br><span class="line">.\bin\emqx stop     åœæ­¢</span><br><span class="line">.\bin\emqx restart  é‡å¯ </span><br></pre></td></tr></table></figure><p>æ›´å¤šå‘½ä»¤ï¼š</p><blockquote><p><a href="https://docs.emqx.com/zh/emqx/v5.0/admin/cli.html#%E5%91%BD%E4%BB%A4%E8%A1%8C">å‘½ä»¤è¡Œ | EMQX 5.0 æ–‡æ¡£</a></p></blockquote><h2 id="é…ç½®emqxæœåŠ¡å™¨">é…ç½®EMQXæœåŠ¡å™¨</h2><h3 id="ç™»å½•ç®¡ç†æ§åˆ¶å°">ç™»å½•ç®¡ç†æ§åˆ¶å°</h3><p>å¯åŠ¨åï¼Œæµè§ˆå™¨è¾“å…¥ <code>127.0.0.1:18083</code> å°±å¯ä»¥è®¿é—® EMQX çš„åå°ç®¡ç†ç•Œé¢ã€‚</p><p>é»˜è®¤ç”¨æˆ·åï¼šadminï¼Œå¯†ç ï¼špublicï¼Œç¬¬ä¸€æ¬¡ç™»å½•ä¼šæç¤ºä¿®æ”¹å¯†ç ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡ã€‚</p><p><img src="image-20240723001904503.png" alt="image-20240723001904503"></p><h3 id="mqtt-é…ç½®">MQTT é…ç½®</h3><p>å¯ä»¥è‡ªå®šä¹‰è®¾ç½® MQTT çš„å‚æ•°ï¼ˆ<code>http://127.0.0.1:18083/#/mqtt/general</code>ï¼‰ï¼š</p><p><img src="image-20240723002354191.png" alt="image-20240723002354191"></p><h3 id="æµ‹è¯•-mqtt-é€šä¿¡">æµ‹è¯• MQTT é€šä¿¡</h3><p>æµ‹è¯• MQTT é€šä¿¡ï¼šæ‰“å¼€ WebSocket å®¢æˆ·ç«¯ï¼ˆ<code>http://127.0.0.1:18083/#/websocket</code>ï¼‰ï¼Œç‚¹å‡»è¿æ¥â€”â€”è®¢é˜…â€”â€”å‘å¸ƒï¼Œæ˜¾ç¤ºæ¥æ”¶æ¶ˆæ¯è¡¨ç¤ºé€šä¿¡æ­£å¸¸ã€‚</p><p><img src="image-20240723002109740.png" alt="image-20240723002109740"></p><p>ä¸»é¢˜å‘å¸ƒå’Œä¸»é¢˜è®¢é˜…çš„æ ¼å¼å¯ä»¥è‡ªå®šä¹‰ã€‚</p><h3 id="qt-mqtt-å®¢æˆ·ç«¯æµ‹è¯•">QT-mqtt å®¢æˆ·ç«¯æµ‹è¯•</h3><p>å¯ä»¥çœ‹åˆ°è‡ªå·±çš„å®¢æˆ·ç«¯èƒ½å¤Ÿæ¥æ”¶è®¢é˜…ä¸»é¢˜å‘å¸ƒçš„æ¶ˆæ¯å’Œå‘å¸ƒæ¶ˆæ¯åˆ°å¯¹åº”ä¸»é¢˜ã€‚</p><p><img src="image-20240723004943925.png" alt="image-20240723004943925"></p><p><img src="image-20240723004956314.png" alt="image-20240723004956314"></p><p><code>http://127.0.0.1:18083/#/clients</code> å¯ä»¥æŸ¥çœ‹è¿æ¥çš„è®¾å¤‡ï¼š</p><p><img src="image-20240723005005465.png" alt="image-20240723005005465"></p><h3 id="è®¾ç½®å®¢æˆ·ç«¯è®¤è¯">è®¾ç½®å®¢æˆ·ç«¯è®¤è¯</h3><p>EMQX é»˜è®¤é…ç½®ä¸­å¯ç”¨äº†åŒ¿åè®¤è¯ï¼Œä»»ä½•å®¢æˆ·ç«¯éƒ½èƒ½æ¥å…¥ EMQXï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®å®¢æˆ·ç«¯è®¤è¯ï¼ˆ<code>http://127.0.0.1:18083/#/authentication</code>ï¼‰ï¼Œè®¾ç½®è®¤è¯æ–¹å¼ä¸º <code>Password-Based</code>ï¼Œæ•°æ®æºä¸ºå†…ç½®æ•°æ®åº“ã€‚</p><p><img src="image-20240723005332343.png" alt="image-20240723005332343"></p><p>åˆ›å»ºå®Œæˆåæ·»åŠ ç”¨æˆ·</p><p><img src="image-20240723005622147.png" alt="image-20240723005622147"></p><p>å†æ¬¡ä½¿ç”¨å®¢æˆ·ç«¯æµ‹è¯•ï¼š</p><p><img src="image-20240723005701911.png" alt="image-20240723005701911"></p><p>æ²¡æœ‰ä½¿ç”¨åˆ›å»ºå¥½çš„ç”¨æˆ·è¿›è¡Œè¿æ¥ï¼Œè¿æ¥å¤±è´¥ï¼Œä¿®æ”¹æ·»åŠ çš„ç”¨æˆ·ä¿¡æ¯å†æ¬¡è¿æ¥ï¼š</p><p><img src="image-20240723005806009.png" alt="image-20240723005806009"></p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>EMQX è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š</p><ul><li>è®¾ç½®æ¯ä¸ªå®¢æˆ·ç«¯çš„æƒé™ï¼Œé™åˆ¶å®ƒæ˜¯å¦å¯ä»¥å‘å¸ƒä¸»é¢˜å’Œè®¢é˜…ä¸»é¢˜ï¼›</li><li>æ•°æ®è½¬å‘ï¼Œå°†æ•°æ®å¦†å‘åˆ°è‡ªå·±çš„ HTTP æœåŠ¡å™¨æˆ–è€…å…¶ä»–çš„ MQTT æœåŠ¡å™¨ã€‚</li></ul><p>æˆ‘ç›®å‰æš‚æ—¶åªéœ€è¦ç”¨åˆ°æ–‡ä¸­ä»‹ç»çš„åŠŸèƒ½ï¼Œåšä¸ªè®°å½•ã€‚</p><blockquote><p><a href="https://xiaolong.blog.csdn.net/article/details/134280836">æ­å»ºè‡ªå·±çš„MQTTæœåŠ¡å™¨ã€å®ç°è®¾å¤‡ä¸Šäº‘(Windows+EMQX)_mqttæœåŠ¡å™¨æ­å»º-CSDNåšå®¢</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä½¿ç”¨emqxæ­å»ºmqttæœåŠ¡å™¨&quot;&gt;ä½¿ç”¨EMQXæ­å»ºMQTTæœåŠ¡å™¨&lt;/h1&gt;
&lt;h2 id=&quot;åºè¨€&quot;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;æ—©åˆæ˜¯ä½¿ç”¨é˜¿é‡Œäº‘å’Œ OneNET å¹³å°ä½œä¸º MQTT æœåŠ¡å™¨è¿›è¡Œä½¿ç”¨ï¼Œä½†æœ‰äº›åŠŸèƒ½éœ€è¦ moneyï¼Œæ‰€ä»¥å°±æƒ³ç€èƒ½ä¸èƒ½è‡ªå·±æ­å»ºä¸ªç®€æ˜“çš„æœåŠ¡å™¨æ¥è€è€</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>äº¤å‰ç¼–è¯‘QT-MQTTåº“</title>
    <link href="http://www.obito.top/2024/07/22/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91QT-MQTT%E5%BA%93/"/>
    <id>http://www.obito.top/2024/07/22/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91QT-MQTT%E5%BA%93/</id>
    <published>2024-07-22T12:42:20.000Z</published>
    <updated>2024-07-22T14:31:11.154Z</updated>
    
    <content type="html"><![CDATA[<h1 id="äº¤å‰ç¼–è¯‘qt-mqttåº“">äº¤å‰ç¼–è¯‘QT-MQTTåº“</h1><h2 id="åºè¨€">åºè¨€</h2><p>å‰ç½®æ¡ä»¶ï¼šéœ€è¦æœ‰äº¤å‰ç¼–è¯‘å¥½çš„ arm ç¯å¢ƒçš„ qt å·¥å…·ï¼Œæœ¬æ–‡ä¸æ¶‰åŠã€‚</p><p>äº¤å‰ç¼–è¯‘ qt-mqtt åº“åœ¨ arm å¼€å‘æ¿ä¸Šè¿è¡Œ mqtt å®¢æˆ·ç«¯è¿æ¥ mqtt æœåŠ¡å™¨ã€‚</p><h2 id="äº¤å‰ç¼–è¯‘è¿‡ç¨‹">äº¤å‰ç¼–è¯‘è¿‡ç¨‹</h2><p>ç¼–è¯‘å‡ºæ¥çš„ Qt Mqtt åº“ï¼Œè¦ä½¿ç”¨å®ƒæœ‰ä¸¤ç§æ–¹å¼ï¼Œ</p><ul><li>ä¸€ç§æ˜¯ç›´æ¥åœ¨é¡¹ç›®ä¸­å¯¼å…¥å¤–éƒ¨åº“å’Œå¤´æ–‡ä»¶</li><li>ä¸€ç§æ˜¯å°†å…¶ä»¥æ¨¡å—çš„å½¢å¼éƒ¨ç½²åˆ° Qt çš„å®‰è£…ç›®å½•ï¼Œè¿™é‡Œé‡‡ç”¨è¿™ç§ï¼Œä¸éœ€è¦æ¯æ¬¡å¯¼å…¥å¤–éƒ¨åº“</li></ul><p>ä¸‹è½½ qt-mqtt æºç ï¼Œç‰ˆæœ¬éœ€è¦ä¸ qt ç‰ˆæœ¬ç›¸åŒï¼Œä¸‹è½½åœ°å€ï¼š</p><blockquote><p><a href="https://github.com/qt/qtmqtt">qt/qtmqtt: Qt Module to implement MQTT protocol version 3.1 and 3.1.1 http://mqtt.org/ (github.com)</a></p></blockquote><h3 id="è§£å‹å¾—åˆ°ä¸‹åˆ—æ–‡ä»¶ï¼š">è§£å‹å¾—åˆ°ä¸‹åˆ—æ–‡ä»¶ï¼š</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router2@ubuntu:~/third_lib/qtmqtt-5.15$ ls</span><br><span class="line">dist      LICENSE.GPL3         qtmqtt.pro  sync.profile</span><br><span class="line">examples  LICENSE.GPL3-EXCEPT  src         tests</span><br></pre></td></tr></table></figure><h3 id="å¤åˆ¶å¤´æ–‡ä»¶">å¤åˆ¶å¤´æ–‡ä»¶</h3><p>å…ˆæŠŠ <code>qtmqtt-5.15/src/mqtt</code> ç›®å½•ä¸­çš„æ‰€æœ‰ <code>.h</code> æ–‡ä»¶å¤åˆ¶åˆ° qt æºç çš„ <code>include</code> ç›®å½•ä¸­çš„ <code>QtMqtt</code> ç›®å½•ï¼Œ<strong>QtMqtt ç›®å½•æ˜¯è‡ªè¡Œåˆ›å»ºçš„</strong>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/router2/Third-party-library/QT/qt-5.15.13/include/QtMqtt</span><br><span class="line"></span><br><span class="line">cp src/mqtt/*.h /home/router2/Third-party-library/QT/qt-5.15.13/include/QtMqtt</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘">ç¼–è¯‘</h3><p>ä½¿ç”¨ qmake è¿›è¡Œé…ç½®ç”Ÿæˆ Makefile æ–‡ä»¶ï¼Œç„¶åè¿›è¡Œç¼–è¯‘ç”Ÿæˆ lib åº“æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/home/router2/Third-party-library/QT/qt-5.15.13/bin/qmake </span><br><span class="line"></span><br><span class="line">make</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router2@ubuntu:~/third_lib/qtmqtt-5.15$ ls</span><br><span class="line">bin       include       LICENSE.GPL3-EXCEPT  qtmqtt.pro    tests</span><br><span class="line">dist      lib           Makefile             src</span><br><span class="line">examples  LICENSE.GPL3  mkspecs              sync.profile</span><br></pre></td></tr></table></figure><h3 id="å¤åˆ¶åº“æ–‡ä»¶">å¤åˆ¶åº“æ–‡ä»¶</h3><p>å°†ç¼–è¯‘ç”Ÿæˆ lib åº“æ–‡ä»¶å¤åˆ¶åˆ° qt æºç çš„ lib ç›®å½•ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rfa lib/libQt5Mqtt.* /home/router2/Third-party-library/QT/qt-5.15.13/lib/</span><br></pre></td></tr></table></figure><h3 id="å¤åˆ¶æ¨¡å—é…ç½®æ–‡ä»¶">å¤åˆ¶æ¨¡å—é…ç½®æ–‡ä»¶</h3><p>å°† <code>mkspecs/</code> ä¸‹çš„ç›®å½•éƒ½å¤åˆ¶åˆ° qt æºç çš„ <code>mkspecs/</code> ç›®å½•ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rfa mkspecs/* /home/router2/Third-party-library/QT/qt-5.15.13/mkspecs/</span><br></pre></td></tr></table></figure><p>æ‰“å¼€ <code>mkspecs/modules/qt_lib_mqtt.pri</code> å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QT_MODULE_BIN_BASE = /home/router2/third_lib/qtmqtt-5.15/bin</span><br><span class="line">QT_MODULE_INCLUDE_BASE = /home/router2/third_lib/qtmqtt-5.15/include</span><br><span class="line">QT_MODULE_LIB_BASE = /home/router2/third_lib/qtmqtt-5.15/lib</span><br><span class="line">QT_MODULE_HOST_LIB_BASE = /home/router2/third_lib/qtmqtt-5.15/lib</span><br><span class="line">include(/home/router2/third_lib/qtmqtt-5.15/mkspecs/modules-inst/qt_lib_mqtt.pri)</span><br><span class="line">QT.mqtt.priority = 1</span><br><span class="line">include(/home/router2/third_lib/qtmqtt-5.15/mkspecs/modules-inst/qt_lib_mqtt_private.pri)</span><br><span class="line">QT.mqtt_private.priority = 1</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„è·¯å¾„è¿˜æ˜¯ä½¿ç”¨æœªå¤åˆ¶å‰çš„è·¯å¾„ï¼Œé¿å…ä»¥åè¯¯åˆ ï¼Œè¿™é‡Œä¿®æ”¹ä¸€ä¸‹è·¯å¾„ä¸ºå½“å‰å­˜æ”¾çš„è·¯å¾„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">QT_MODULE_BIN_BASE = /home/router2/Third-party-library/QT/qt-5.15.13/bin</span><br><span class="line">QT_MODULE_INCLUDE_BASE = /home/router2/Third-party-library/QT/qt-5.15.13/include</span><br><span class="line">QT_MODULE_LIB_BASE = /home/router2/Third-party-library/QT/qt-5.15.13/lib</span><br><span class="line">QT_MODULE_HOST_LIB_BASE = /home/router2/Third-party-library/QT/qt-5.15.13/lib</span><br><span class="line">include(/home/router2/Third-party-library/QT/qt-5.15.13/mkspecs/modules-inst/qt_lib_mqtt.pri)</span><br><span class="line">QT.mqtt.priority = 1</span><br><span class="line">include(/home/router2/Third-party-library/QT/qt-5.15.13/mkspecs/modules-inst/qt_lib_mqtt_private.pri)</span><br><span class="line">QT.mqtt_private.priority = 1</span><br></pre></td></tr></table></figure><p>ä¹‹åæ–°å»ºå·¥ç¨‹æ—¶ç›´æ¥åœ¨ .pro æ–‡ä»¶æ·»åŠ  mqtt æ¨¡å—å³å¯ã€‚</p><h2 id="æµ‹è¯•">æµ‹è¯•</h2><p>å°† mqtt æºç çš„ lib åº“æ–‡ä»¶ç§»æ¤åˆ°å¼€å‘æ¿ä¸­ï¼Œæµ‹è¯•çš„æ—¶å€™ç”±äºéœ€è¦è¿æ¥æœåŠ¡å™¨ï¼Œæ‰€ä»¥<strong>å¼€å‘æ¿éœ€è¦èƒ½è®¿é—®ç½‘ç»œ</strong>ã€‚</p><p>ä½¿ç”¨ qt mqtt æºç ä¸­è‡ªå¸¦çš„ä¾‹å­æ¥ç¼–è¯‘è¿è¡Œï¼Œæ‰“å¼€ <code>example/mqtt/simpleclient</code></p><p><code>.pro</code> æ–‡ä»¶ä¿®æ”¹ï¼Œå°†ä¸‹åˆ—å†…å®¹æ³¨é‡Šæ‰ï¼Œå¦åˆ™æ— æ³•ç‹¬ç«‹è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">target.path = $$[QT_INSTALL_EXAMPLES]/mqtt/simpleclient</span><br><span class="line">INSTALLS += target</span><br></pre></td></tr></table></figure><p><code>mainwindow.h</code> æ–‡ä»¶ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************************************************************************</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** Copyright (C) 2017 The Qt Company Ltd.</span></span><br><span class="line"><span class="comment">** Contact: https://www.qt.io/licensing/</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** This file is part of the examples of the Qt Toolkit.</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** $QT_BEGIN_LICENSE:BSD$</span></span><br><span class="line"><span class="comment">** Commercial License Usage</span></span><br><span class="line"><span class="comment">** Licensees holding valid commercial Qt licenses may use this file in</span></span><br><span class="line"><span class="comment">** accordance with the commercial license agreement provided with the</span></span><br><span class="line"><span class="comment">** Software or, alternatively, in accordance with the terms contained in</span></span><br><span class="line"><span class="comment">** a written agreement between you and The Qt Company. For licensing terms</span></span><br><span class="line"><span class="comment">** and conditions see https://www.qt.io/terms-conditions. For further</span></span><br><span class="line"><span class="comment">** information use the contact form at https://www.qt.io/contact-us.</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** BSD License Usage</span></span><br><span class="line"><span class="comment">** Alternatively, you may use this file under the terms of the BSD license</span></span><br><span class="line"><span class="comment">** as follows:</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** &quot;Redistribution and use in source and binary forms, with or without</span></span><br><span class="line"><span class="comment">** modification, are permitted provided that the following conditions are</span></span><br><span class="line"><span class="comment">** met:</span></span><br><span class="line"><span class="comment">**   * Redistributions of source code must retain the above copyright</span></span><br><span class="line"><span class="comment">**     notice, this list of conditions and the following disclaimer.</span></span><br><span class="line"><span class="comment">**   * Redistributions in binary form must reproduce the above copyright</span></span><br><span class="line"><span class="comment">**     notice, this list of conditions and the following disclaimer in</span></span><br><span class="line"><span class="comment">**     the documentation and/or other materials provided with the</span></span><br><span class="line"><span class="comment">**     distribution.</span></span><br><span class="line"><span class="comment">**   * Neither the name of The Qt Company Ltd nor the names of its</span></span><br><span class="line"><span class="comment">**     contributors may be used to endorse or promote products derived</span></span><br><span class="line"><span class="comment">**     from this software without specific prior written permission.</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></span><br><span class="line"><span class="comment">** &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></span><br><span class="line"><span class="comment">** LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></span><br><span class="line"><span class="comment">** A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></span><br><span class="line"><span class="comment">** OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></span><br><span class="line"><span class="comment">** SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></span><br><span class="line"><span class="comment">** LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></span><br><span class="line"><span class="comment">** DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></span><br><span class="line"><span class="comment">** THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></span><br><span class="line"><span class="comment">** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></span><br><span class="line"><span class="comment">** OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&quot;</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** $QT_END_LICENSE$</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MAINWINDOW_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAINWINDOW_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QMainWindow&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtMqtt/qmqttclient.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">QT_BEGIN_NAMESPACE</span><br><span class="line"><span class="keyword">namespace</span> Ui &#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainWindow</span>;</span><br><span class="line">&#125;</span><br><span class="line">QT_END_NAMESPACE</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainWindow</span> : <span class="keyword">public</span> QMainWindow</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">MainWindow</span><span class="params">(QWidget *parent = <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">    ~<span class="built_in">MainWindow</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setClientPort</span><span class="params">(<span class="type">int</span> p)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">on_buttonConnect_clicked</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">on_buttonQuit_clicked</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">updateLogStateChange</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">brokerDisconnected</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">on_buttonPublish_clicked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">on_buttonSubscribe_clicked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Ui::MainWindow *ui;</span><br><span class="line">    QMqttClient *m_client;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// MAINWINDOW_H</span></span></span><br></pre></td></tr></table></figure><p><code>mainwindow.cpp</code> æ–‡ä»¶ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************************************************************************</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** Copyright (C) 2017 The Qt Company Ltd.</span></span><br><span class="line"><span class="comment">** Contact: https://www.qt.io/licensing/</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** This file is part of the examples of the Qt Toolkit.</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** $QT_BEGIN_LICENSE:BSD$</span></span><br><span class="line"><span class="comment">** Commercial License Usage</span></span><br><span class="line"><span class="comment">** Licensees holding valid commercial Qt licenses may use this file in</span></span><br><span class="line"><span class="comment">** accordance with the commercial license agreement provided with the</span></span><br><span class="line"><span class="comment">** Software or, alternatively, in accordance with the terms contained in</span></span><br><span class="line"><span class="comment">** a written agreement between you and The Qt Company. For licensing terms</span></span><br><span class="line"><span class="comment">** and conditions see https://www.qt.io/terms-conditions. For further</span></span><br><span class="line"><span class="comment">** information use the contact form at https://www.qt.io/contact-us.</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** BSD License Usage</span></span><br><span class="line"><span class="comment">** Alternatively, you may use this file under the terms of the BSD license</span></span><br><span class="line"><span class="comment">** as follows:</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** &quot;Redistribution and use in source and binary forms, with or without</span></span><br><span class="line"><span class="comment">** modification, are permitted provided that the following conditions are</span></span><br><span class="line"><span class="comment">** met:</span></span><br><span class="line"><span class="comment">**   * Redistributions of source code must retain the above copyright</span></span><br><span class="line"><span class="comment">**     notice, this list of conditions and the following disclaimer.</span></span><br><span class="line"><span class="comment">**   * Redistributions in binary form must reproduce the above copyright</span></span><br><span class="line"><span class="comment">**     notice, this list of conditions and the following disclaimer in</span></span><br><span class="line"><span class="comment">**     the documentation and/or other materials provided with the</span></span><br><span class="line"><span class="comment">**     distribution.</span></span><br><span class="line"><span class="comment">**   * Neither the name of The Qt Company Ltd nor the names of its</span></span><br><span class="line"><span class="comment">**     contributors may be used to endorse or promote products derived</span></span><br><span class="line"><span class="comment">**     from this software without specific prior written permission.</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></span><br><span class="line"><span class="comment">** &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></span><br><span class="line"><span class="comment">** LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></span><br><span class="line"><span class="comment">** A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></span><br><span class="line"><span class="comment">** OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></span><br><span class="line"><span class="comment">** SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></span><br><span class="line"><span class="comment">** LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></span><br><span class="line"><span class="comment">** DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></span><br><span class="line"><span class="comment">** THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></span><br><span class="line"><span class="comment">** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></span><br><span class="line"><span class="comment">** OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&quot;</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** $QT_END_LICENSE$</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mainwindow.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ui_mainwindow.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtCore/QDateTime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtMqtt/qmqttclient.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtWidgets/QMessageBox&gt;</span></span></span><br><span class="line"></span><br><span class="line">MainWindow::<span class="built_in">MainWindow</span>(QWidget *parent) :</span><br><span class="line">    <span class="built_in">QMainWindow</span>(parent),</span><br><span class="line">    <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::MainWindow)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    m_client = <span class="keyword">new</span> <span class="built_in">QMqttClient</span>(<span class="keyword">this</span>);</span><br><span class="line">    m_client-&gt;<span class="built_in">setHostname</span>(ui-&gt;lineEditHost-&gt;<span class="built_in">text</span>());</span><br><span class="line">    m_client-&gt;<span class="built_in">setPort</span>(ui-&gt;spinBoxPort-&gt;<span class="built_in">value</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(m_client, &amp;QMqttClient::stateChanged, <span class="keyword">this</span>, &amp;MainWindow::updateLogStateChange);</span><br><span class="line">    <span class="built_in">connect</span>(m_client, &amp;QMqttClient::disconnected, <span class="keyword">this</span>, &amp;MainWindow::brokerDisconnected);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(m_client, &amp;QMqttClient::messageReceived, <span class="keyword">this</span>, [<span class="keyword">this</span>](<span class="type">const</span> QByteArray &amp;message, <span class="type">const</span> QMqttTopicName &amp;topic) &#123;</span><br><span class="line">        <span class="type">const</span> QString content = QDateTime::<span class="built_in">currentDateTime</span>().<span class="built_in">toString</span>()</span><br><span class="line">                    + <span class="built_in">QLatin1String</span>(<span class="string">&quot; Received Topic: &quot;</span>)</span><br><span class="line">                    + topic.<span class="built_in">name</span>()</span><br><span class="line">                    + <span class="built_in">QLatin1String</span>(<span class="string">&quot; Message: &quot;</span>)</span><br><span class="line">                    + message</span><br><span class="line">                    + <span class="built_in">QLatin1Char</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        ui-&gt;editLog-&gt;<span class="built_in">insertPlainText</span>(content);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(m_client, &amp;QMqttClient::pingResponseReceived, <span class="keyword">this</span>, [<span class="keyword">this</span>]() &#123;</span><br><span class="line">        <span class="type">const</span> QString content = QDateTime::<span class="built_in">currentDateTime</span>().<span class="built_in">toString</span>()</span><br><span class="line">                    + <span class="built_in">QLatin1String</span>(<span class="string">&quot; PingResponse&quot;</span>)</span><br><span class="line">                    + <span class="built_in">QLatin1Char</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        ui-&gt;editLog-&gt;<span class="built_in">insertPlainText</span>(content);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">connect</span>(ui-&gt;lineEditHost, &amp;QLineEdit::textChanged, m_client, &amp;QMqttClient::setHostname);</span><br><span class="line">    <span class="built_in">connect</span>(ui-&gt;spinBoxPort, QOverload&lt;<span class="type">int</span>&gt;::<span class="built_in">of</span>(&amp;QSpinBox::valueChanged), <span class="keyword">this</span>, &amp;MainWindow::setClientPort);</span><br><span class="line">    <span class="built_in">updateLogStateChange</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MainWindow::~<span class="built_in">MainWindow</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">delete</span> ui;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::on_buttonConnect_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_client-&gt;<span class="built_in">state</span>() == QMqttClient::Disconnected) &#123;</span><br><span class="line">        ui-&gt;lineEditHost-&gt;<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">        ui-&gt;spinBoxPort-&gt;<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line">        ui-&gt;buttonConnect-&gt;<span class="built_in">setText</span>(<span class="built_in">tr</span>(<span class="string">&quot;Disconnect&quot;</span>));</span><br><span class="line">        m_client-&gt;<span class="built_in">connectToHost</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ui-&gt;lineEditHost-&gt;<span class="built_in">setEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">        ui-&gt;spinBoxPort-&gt;<span class="built_in">setEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">        ui-&gt;buttonConnect-&gt;<span class="built_in">setText</span>(<span class="built_in">tr</span>(<span class="string">&quot;Connect&quot;</span>));</span><br><span class="line">        m_client-&gt;<span class="built_in">disconnectFromHost</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::on_buttonQuit_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    QApplication::<span class="built_in">quit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::updateLogStateChange</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> QString content = QDateTime::<span class="built_in">currentDateTime</span>().<span class="built_in">toString</span>()</span><br><span class="line">                    + <span class="built_in">QLatin1String</span>(<span class="string">&quot;: State Change&quot;</span>)</span><br><span class="line">                    + QString::<span class="built_in">number</span>(m_client-&gt;<span class="built_in">state</span>())</span><br><span class="line">                    + <span class="built_in">QLatin1Char</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    ui-&gt;editLog-&gt;<span class="built_in">insertPlainText</span>(content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::brokerDisconnected</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ui-&gt;lineEditHost-&gt;<span class="built_in">setEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">    ui-&gt;spinBoxPort-&gt;<span class="built_in">setEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">    ui-&gt;buttonConnect-&gt;<span class="built_in">setText</span>(<span class="built_in">tr</span>(<span class="string">&quot;Connect&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::setClientPort</span><span class="params">(<span class="type">int</span> p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_client-&gt;<span class="built_in">setPort</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::on_buttonPublish_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_client-&gt;<span class="built_in">publish</span>(ui-&gt;lineEditTopic-&gt;<span class="built_in">text</span>(), ui-&gt;lineEditMessage-&gt;<span class="built_in">text</span>().<span class="built_in">toUtf8</span>()) == <span class="number">-1</span>)</span><br><span class="line">        QMessageBox::<span class="built_in">critical</span>(<span class="keyword">this</span>, <span class="built_in">QLatin1String</span>(<span class="string">&quot;Error&quot;</span>), <span class="built_in">QLatin1String</span>(<span class="string">&quot;Could not publish message&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MainWindow::on_buttonSubscribe_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> subscription = m_client-&gt;<span class="built_in">subscribe</span>(ui-&gt;lineEditTopic-&gt;<span class="built_in">text</span>());</span><br><span class="line">    <span class="keyword">if</span> (!subscription) &#123;</span><br><span class="line">        QMessageBox::<span class="built_in">critical</span>(<span class="keyword">this</span>, <span class="built_in">QLatin1String</span>(<span class="string">&quot;Error&quot;</span>), <span class="built_in">QLatin1String</span>(<span class="string">&quot;Could not subscribe. Is there a valid connection?&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ ui æ–‡ä»¶ï¼Œå…ˆè®¾ç½®ä¸ºå¦‚ä¸‹è¿›è¡Œæµ‹è¯•ï¼š</p><p><img src="image-20240722222448401.png" alt="image-20240722222448401"></p><p>ç‚¹å‡» Connectï¼Œç‚¹å‡» Subscribeï¼Œç„¶åç‚¹å‡» Publish è¿è¡Œï¼š</p><p><img src="image-20240722222858919.png" alt="image-20240722222858919"></p><p>State Change2 è¡¨ç¤ºè¿æ¥æˆåŠŸ</p><blockquote><p><a href="https://blog.csdn.net/2301_76250105/article/details/136272584?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0-136272584-blog-116145847.235%5Ev43%5Epc_blog_bottom_relevance_base4&amp;spm=1001.2101.3001.4242.1&amp;utm_relevant_index=3">å®ç°å…·æœ‰mqtté€šä¿¡åŠŸèƒ½çš„qtç¨‹åºåœ¨armå¼€å‘æ¿ä¸Šè¿è¡Œ ï¼Œç¡¬ä»¶å¹³å°æ˜¯linux arm å¼€å‘æ¿imx6ull pro_arm linux mqtt-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/luoyayun361/article/details/104671603">Qtå¼€å‘MQTTï¼ˆä¸€ï¼‰ ä¹‹Qtå®˜æ–¹Qt MQTT-CSDNåšå®¢</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;äº¤å‰ç¼–è¯‘qt-mqttåº“&quot;&gt;äº¤å‰ç¼–è¯‘QT-MQTTåº“&lt;/h1&gt;
&lt;h2 id=&quot;åºè¨€&quot;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;å‰ç½®æ¡ä»¶ï¼šéœ€è¦æœ‰äº¤å‰ç¼–è¯‘å¥½çš„ arm ç¯å¢ƒçš„ qt å·¥å…·ï¼Œæœ¬æ–‡ä¸æ¶‰åŠã€‚&lt;/p&gt;
&lt;p&gt;äº¤å‰ç¼–è¯‘ qt-mqtt åº“åœ¨ arm å¼€å‘æ¿ä¸Šè¿è¡Œ mqtt å®¢æˆ·</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux" scheme="http://www.obito.top/tags/Linux/"/>
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Linux-éŸ³é¢‘é©±åŠ¨</title>
    <link href="http://www.obito.top/2024/07/18/Linux-%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8/"/>
    <id>http://www.obito.top/2024/07/18/Linux-%E9%9F%B3%E9%A2%91%E9%A9%B1%E5%8A%A8/</id>
    <published>2024-07-18T09:02:31.000Z</published>
    <updated>2024-07-19T12:21:46.972Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux-éŸ³é¢‘é©±åŠ¨">Linux-éŸ³é¢‘é©±åŠ¨</h1><h2 id="åºè¨€">åºè¨€</h2><p>ç§»æ¤äº† mplayer æ’­æ”¾å™¨ï¼Œæ’­æ”¾è§†é¢‘æ—¶å‘ç°æ²¡æœ‰å£°éŸ³ï¼ŒåŸæ¥æ˜¯éŸ³é¢‘é©±åŠ¨è¿˜æ²¡ç§»æ¤ã€‚100ask å¼€å‘æ¿ä½¿ç”¨åˆ°çš„éŸ³é¢‘èŠ¯ç‰‡ä¸º WM8690ï¼ŒLinux å†…æ ¸å·²ç»æœ‰è¯¥é©±åŠ¨æ–‡ä»¶äº†ï¼Œæˆ‘ä»¬ä»…ä»…åªéœ€è¦ä½¿èƒ½é©±åŠ¨å’Œä¿®æ”¹è®¾å¤‡æ ‘ã€‚</p><p>éŸ³é¢‘è¿™ä¸€éƒ¨åˆ†å¯¹äºç›®å‰çš„è‡ªå·±æœ‰ç‚¹å›°éš¾äº†ï¼Œç½‘ä¸Šé½å…¨çš„èµ„æ–™ä¹Ÿè¾ƒå°‘ï¼Œè¿™é‡Œæœ€ååœ¨å¼€å‘æ¿ä¸Šä½¿ç”¨ aplay ä¸èƒ½æ­£å¸¸æ’­æ”¾éŸ³é¢‘æ–‡ä»¶ï¼Œä½†æ˜¯ä½¿ç”¨ mplayer å¯ä»¥æ­£å¸¸æ’­æ”¾è§†é¢‘å¸¦æœ‰éŸ³é¢‘ä¹Ÿèƒ½æ­£å¸¸å•ç‹¬æ’­æ”¾éŸ³é¢‘ï¼Œå€’ä¹Ÿæ˜¯è§£å†³äº†ç›®å‰çš„éœ€æ±‚ï¼Œåç»­æœ‰èƒ½åŠ›å†å›å¤´çœ‹èƒ½ä¸èƒ½è§£å†³ aplay çš„é—®é¢˜ã€‚</p><h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2><h3 id="ç¡¬ä»¶ç¯å¢ƒ">ç¡¬ä»¶ç¯å¢ƒ</h3><ul><li><strong>å¼€å‘æ¿å‹å·</strong>ï¼š <a href="https://blog.csdn.net/thisway_diy/article/details/109841372">100ask_imx6ull_pro å¼€å‘æ¿</a></li><li><strong>å¤„ç†å™¨ç±»å‹</strong>ï¼šNXP IMX6ULL</li><li>**å¤„ç†å™¨æ¶æ„ï¼š**æ©å•æ ¸ Cortex-A7</li><li>**å¤„ç†å™¨ä¸»é¢‘ï¼š**800MHZ</li><li><strong>å†…å­˜å®¹é‡</strong>ï¼š512 MB DDR3</li><li><strong>å­˜å‚¨ä»‹è´¨</strong>ï¼š4GB eMMC</li><li><strong>æœ¬æ¬¡æµ‹è¯•çš„é©±åŠ¨</strong>ï¼šéŸ³é¢‘èŠ¯ç‰‡ WM8690</li></ul><h3 id="è½¯ä»¶ç¯å¢ƒ">è½¯ä»¶ç¯å¢ƒ</h3><ul><li>å®¿ä¸»æœº<ul><li><strong>å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ</strong>ï¼šUbuntu 18.04</li><li><strong>äº¤å‰ç¼–è¯‘å™¨</strong>ï¼š100ask æä¾›çš„å·¥å…·é“¾ arm-buildroot-linux-gnueabihf- <strong>æ”¯æŒçš„æœ€ä½å†…æ ¸ç‰ˆæœ¬</strong>ï¼š4.9.0</li></ul></li><li>å¼€å‘æ¿<ul><li><strong>U-Boot</strong>ï¼šä¸€å¼€å§‹ç”¨çš„ NXP å®˜æ–¹æä¾›çš„ç‰ˆæœ¬ä½†ä¸èƒ½æ­£å¸¸å¯åŠ¨å†…æ ¸ï¼Œåæ”¹ä¸º 100ask æä¾›çš„ç‰ˆæœ¬</li><li><strong>å†…æ ¸ç‰ˆæœ¬</strong>ï¼š <a href="https://github.com/nxp-imx/linux-imx/tree/imx_4.9.88_2.0.0_ga">NXP æä¾›çš„ 4.9.88 ç‰ˆæœ¬</a></li><li><strong>æ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹</strong>ï¼š<a href="https://busybox.net/downloads/">BusyBox 1.29.0</a></li></ul></li><li>éŸ³é¢‘ç›¸å…³è½¯ä»¶<ul><li><strong>ALSA åº“ç‰ˆæœ¬</strong>ï¼š1.0.29 ç‰ˆæœ¬</li><li><strong>ALSA-Utils ç‰ˆæœ¬</strong>ï¼š1.0.29 ç‰ˆæœ¬</li><li><strong>éŸ³é¢‘æ’­æ”¾å™¨</strong>ï¼šmplayer 1.1 ç‰ˆæœ¬</li></ul></li></ul><h2 id="éŸ³é¢‘æ¥å£ç®€ä»‹">éŸ³é¢‘æ¥å£ç®€ä»‹</h2><h2 id="ç§»æ¤éŸ³é¢‘é©±åŠ¨">ç§»æ¤éŸ³é¢‘é©±åŠ¨</h2><p>åªéœ€è¦ä¿®æ”¹è®¾å¤‡æ ‘å’Œä½¿èƒ½å†…æ ¸éŸ³é¢‘é©±åŠ¨å³å¯ã€‚</p><h3 id="ä¿®æ”¹è®¾å¤‡æ ‘">ä¿®æ”¹è®¾å¤‡æ ‘</h3><h4 id="i2c-æ¥å£">I2C æ¥å£</h4><p>i2c2 æ¥å£æ·»åŠ å­èŠ‚ç‚¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c2 &#123;</span><br><span class="line">clock_frequency = &lt;100000&gt;;</span><br><span class="line">pinctrl-names = &quot;default&quot;;</span><br><span class="line">pinctrl-0 = &lt;&amp;pinctrl_i2c2&gt;;</span><br><span class="line">status = &quot;okay&quot;;</span><br><span class="line"></span><br><span class="line">codec: wm8960@1a &#123;</span><br><span class="line">compatible = &quot;wlf,wm8960&quot;;</span><br><span class="line">reg = &lt;0x1a&gt;;</span><br><span class="line">clocks = &lt;&amp;clks IMX6UL_CLK_SAI2&gt;;</span><br><span class="line">clock-names = &quot;mclk&quot;;</span><br><span class="line">wlf,shared-lrclk;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="sai-æ¥å£">SAI æ¥å£</h4><p>sai2 èŠ‚ç‚¹æ·»åŠ ä¸€äº›å±æ€§ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&amp;sai2 &#123;</span><br><span class="line">pinctrl-names = &quot;default&quot;;</span><br><span class="line">pinctrl-0 = &lt;&amp;pinctrl_sai2</span><br><span class="line">     &amp;pinctrl_sai2_hp_det_b&gt;;</span><br><span class="line"></span><br><span class="line">assigned-clocks = &lt;&amp;clks IMX6UL_CLK_SAI2_SEL&gt;,</span><br><span class="line">  &lt;&amp;clks IMX6UL_CLK_SAI2&gt;;</span><br><span class="line">assigned-clock-parents = &lt;&amp;clks IMX6UL_CLK_PLL4_AUDIO_DIV&gt;;</span><br><span class="line">assigned-clock-rates = &lt;0&gt;, &lt;12288000&gt;;</span><br><span class="line"></span><br><span class="line">status = &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>sai2 æ¥å£çš„ IO é…ç½®ï¼š<code>pinctrl_sai2</code> å’Œ <code>pinctrl_sai2_hp_det_b</code>ï¼š</p><p><code>iomuxc</code> èŠ‚ç‚¹ä¸‹çš„ <code>imx6u-evk</code> å­èŠ‚ç‚¹æ·»åŠ ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_sai2: sai2grp &#123;</span><br><span class="line">fsl,pins = &lt;</span><br><span class="line">MX6UL_PAD_JTAG_TDI__SAI2_TX_BCLK0x17088</span><br><span class="line">MX6UL_PAD_JTAG_TDO__SAI2_TX_SYNC0x17088</span><br><span class="line">MX6UL_PAD_JTAG_TRST_B__SAI2_TX_DATA0x11088</span><br><span class="line">MX6UL_PAD_JTAG_TCK__SAI2_RX_DATA0x11088</span><br><span class="line">MX6UL_PAD_JTAG_TMS__SAI2_MCLK0x17088</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>iomuxc_snvs</code> èŠ‚ç‚¹æ·»åŠ ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_sai2_hp_det_b: sai2_hp_det_grp &#123;</span><br><span class="line">fsl,pins = &lt;</span><br><span class="line">MX6ULL_PAD_SNVS_TAMPER4__GPIO5_IO04   0x17059</span><br><span class="line">&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>pinctrl_sai2_hp_det_b</code> æè¿°çš„æ˜¯è€³æœºæ’å…¥æ£€æµ‹å¼•è„šï¼Œwm8960 æ”¯æŒè€³æœºæ’å…¥æ£€æµ‹ï¼Œå½“è€³æœºæ’å…¥å°±é€šè¿‡è€³æœºè¾“å‡ºéŸ³é¢‘ï¼Œæ— è€³æœºæ—¶é€šè¿‡å–‡å­æ’­æ”¾éŸ³ä¹ã€‚</li></ul><p><em><strong>PSï¼š100ask å¼€å‘æ¿æ·»åŠ è¯¥å¼•è„šä¼šæŠ¥é”™ï¼ŒæŸ¥çœ‹è®¾å¤‡æ ‘ä¹Ÿæ²¡æœ‰å…¶ä»–èŠ‚ç‚¹ç”¨åˆ°è¯¥å¼•è„šï¼Œå…·ä½“åŸå› ä¸çŸ¥ï¼Œäºæ˜¯æŠŠè¯¥èŠ‚ç‚¹ç§»é™¤å¯æ­£å¸¸å·¥ä½œï¼Œä¸å½±å“åç»­æ“ä½œã€‚</strong></em></p><h4 id="sound-èŠ‚ç‚¹">sound èŠ‚ç‚¹</h4><p>æ ¹èŠ‚ç‚¹ <code>\</code> ä¸‹æ·»åŠ èŠ‚ç‚¹ <code>sound</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">sound &#123;</span><br><span class="line">compatible = &quot;fsl,imx6ul-evk-wm8960&quot;,</span><br><span class="line">   &quot;fsl,imx-audio-wm8960&quot;;</span><br><span class="line">model = &quot;wm8960-audio&quot;;</span><br><span class="line">cpu-dai = &lt;&amp;sai2&gt;;</span><br><span class="line">audio-codec = &lt;&amp;codec&gt;;</span><br><span class="line">asrc-controller = &lt;&amp;asrc&gt;;</span><br><span class="line">codec-master;</span><br><span class="line">gpr = &lt;&amp;gpr 4 0x100000 0x100000&gt;;</span><br><span class="line">/*</span><br><span class="line">         * hp-det = &lt;hp-det-pin hp-det-polarity&gt;;</span><br><span class="line"> * hp-det-pin: JD1 JD2  or JD3</span><br><span class="line"> * hp-det-polarity = 0: hp detect high for headphone</span><br><span class="line"> * hp-det-polarity = 1: hp detect high for speaker</span><br><span class="line"> */</span><br><span class="line">hp-det = &lt;3 0&gt;;</span><br><span class="line">// hp-det-gpios = &lt;&amp;gpio5 4 0&gt;;</span><br><span class="line">// mic-det-gpios = &lt;&amp;gpio5 4 0&gt;;</span><br><span class="line">audio-routing =</span><br><span class="line">&quot;Headphone Jack&quot;, &quot;HP_L&quot;,</span><br><span class="line">&quot;Headphone Jack&quot;, &quot;HP_R&quot;,</span><br><span class="line">&quot;Ext Spk&quot;, &quot;SPK_LP&quot;,</span><br><span class="line">&quot;Ext Spk&quot;, &quot;SPK_LN&quot;,</span><br><span class="line">&quot;Ext Spk&quot;, &quot;SPK_RP&quot;,</span><br><span class="line">&quot;Ext Spk&quot;, &quot;SPK_RN&quot;,</span><br><span class="line">&quot;LINPUT2&quot;, &quot;Mic Jack&quot;,</span><br><span class="line">&quot;LINPUT3&quot;, &quot;Mic Jack&quot;,</span><br><span class="line">&quot;RINPUT1&quot;, &quot;Main MIC&quot;,</span><br><span class="line">&quot;RINPUT2&quot;, &quot;Main MIC&quot;,</span><br><span class="line">&quot;Mic Jack&quot;, &quot;MICB&quot;,</span><br><span class="line">&quot;Main MIC&quot;, &quot;MICB&quot;,</span><br><span class="line">&quot;CPU-Playback&quot;, &quot;ASRC-Playback&quot;,</span><br><span class="line">&quot;Playback&quot;, &quot;CPU-Playback&quot;,</span><br><span class="line">&quot;ASRC-Capture&quot;, &quot;CPU-Capture&quot;,</span><br><span class="line">&quot;CPU-Capture&quot;, &quot;Capture&quot;;</span><br><span class="line">status = &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="å†…æ ¸ä½¿èƒ½é©±åŠ¨">å†…æ ¸ä½¿èƒ½é©±åŠ¨</h3><p>è®¾å¤‡æ ‘é…ç½®å®Œæˆä»¥åå°±å¯ä»¥ä½¿èƒ½å†…æ ¸è‡ªå¸¦çš„ WM8960 é©±åŠ¨ï¼Œä¸€èˆ¬æ˜¯é»˜è®¤æ‰“å¼€çš„è¿™é‡Œæ£€æŸ¥ä¸€ä¸‹ï¼Œæ‰“å¼€ linux å†…æ ¸çš„å›¾å½¢åŒ–é…ç½®ç•Œé¢ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p>ç¡®ä¿è¿™ä¸¤é¡¹ <code>OSS Mixer API</code> å’Œ <code>OSS PCM (digital audio) API</code> ä¸é€‰æ‹©ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Device Drivers</span></span><br><span class="line">    -&gt; Sound card support (SOUND [=y])</span><br><span class="line">        -&gt; Advanced Linux Sound Architecture (SND [=y])</span><br><span class="line">            -&gt; &lt;&gt; OSS Mixer API //ä¸é€‰æ‹©</span><br><span class="line">            -&gt; &lt;&gt; OSS PCM (digital audio) API //ä¸é€‰æ‹©</span><br></pre></td></tr></table></figure><p><img src="image-20240718211018169.png" alt="image-20240718211018169"></p><p>ä½¿èƒ½ WM8690 é©±åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Device Drivers</span></span><br><span class="line">    -&gt; Sound card support (SOUND [=y])</span><br><span class="line">        -&gt; Advanced Linux Sound Architecture (SND [=y])</span><br><span class="line">            -&gt; ALSA for SoC audio support (SND_SOC [=y])</span><br><span class="line">                -&gt; SoC Audio for Freescale CPUs</span><br><span class="line">                    -&gt; &lt;*&gt; Asynchronous Sample Rate Converter (ASRC) module support //é€‰ä¸­</span><br><span class="line">                    -&gt; &lt;*&gt; SoC Audio support for i.MX boards with wm8960 //é€‰ä¸­</span><br></pre></td></tr></table></figure><p><img src="image-20240719165711761.png" alt="image-20240719165711761"></p><p>ç¼–è¯‘ä½¿ç”¨æ–°çš„å†…æ ¸å¯åŠ¨å¼€å‘æ¿å¯åŠ¨è¿‡ç¨‹æç¤ºï¼šåœ¨ ALSA è®¾å¤‡åˆ—è¡¨ä¸­å°±ä¼šæ‰¾åˆ° <code>wm8960-audio</code> è¿™ä¸ªå£°å¡ï¼Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALSA device list:</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">0: wm8960-audio</span></span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸€ä¸‹ <code>/dev/snd</code> ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[@obito:/]# ls /dev/snd/</span><br><span class="line">controlC0  pcmC0D0c   pcmC0D0p   pcmC0D1c   pcmC0D1p   timer</span><br></pre></td></tr></table></figure><ul><li>controlC0ï¼šç”¨äºå£°å¡æ§åˆ¶ï¼ŒC0 è¡¨ç¤ºå£°å¡ 0ã€‚</li><li>pcmC0D0c å’Œ pcmC0D1cï¼šç”¨äº<strong>å½•éŸ³</strong>çš„ pcm è®¾å¤‡ï¼Œå…¶ä¸­çš„â€œCOD0â€å’Œâ€œC0D1â€åˆ†åˆ«è¡¨ç¤ºå£°å¡ 0 ä¸­çš„è®¾å¤‡ 0 å’Œè®¾å¤‡ 1ï¼Œæœ€åé¢çš„â€œcâ€æ˜¯ capture çš„ç¼©å†™ï¼Œè¡¨ç¤ºå½•éŸ³ã€‚</li><li>pcmC0D0p å’Œ pcmC0D1pï¼šç”¨äº<strong>æ’­æ”¾</strong>çš„pcm è®¾å¤‡ï¼Œå…¶ä¸­çš„â€œCOD0â€å’Œâ€œC0D1â€åˆ†åˆ«è¡¨ç¤ºå£°å¡ 0 ä¸­çš„è®¾å¤‡ 0 å’Œè®¾å¤‡ 1ï¼Œæœ€åé¢çš„â€œpâ€æ˜¯ playback çš„ç¼©å†™ï¼Œè¡¨ç¤ºæ”¾éŸ³ã€‚</li><li>timerï¼šå®šæ—¶å™¨ã€‚</li></ul><h2 id="äº¤å‰ç¼–è¯‘-alsa">äº¤å‰ç¼–è¯‘ alsa</h2><p>è¿™ä¸ªåº“äº¤å‰ç¼–è¯‘ mplayer æ—¶å·²ç»äº¤å‰ç¼–è¯‘å¥½äº†ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥äº¤å‰ç¼–è¯‘ alsa-utilsã€‚</p><h2 id="äº¤å‰ç¼–è¯‘-alsa-utils">äº¤å‰ç¼–è¯‘ alsa-utils</h2><p><strong>ç”±äºå¼€å‘æ¿ä¸Šçš„å£°å¡é…ç½®é»˜è®¤æ˜¯å…³é—­çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ <code>alsa-utils</code> å·¥å…·é›†æ¥è®¾ç½®å£°å¡é…ç½®ã€‚</strong></p><p>alsa-utils æ˜¯ç”¨æ¥æ“ä½œ alsa æ¡†æ¶éŸ³é¢‘çš„å·¥å…·é›†ï¼Œå› æ­¤å¾—å…ˆäº¤å‰ç¼–è¯‘ alsa åº“ã€‚</p><p>ä¸‹è½½åœ°å€ï¼šä¸‹è½½ç‰ˆæœ¬æœ€å¥½ä¸ alsa åº“ç‰ˆæœ¬ç›¸åŒï¼Œå¦åˆ™å¯èƒ½æç¤ºç‰ˆæœ¬ä¸ç¬¦åˆçš„é”™è¯¯</p><blockquote><p><a href="https://github.com/alsa-project/alsa-utils/tree/v1.0.29">https://github.com/alsa-project/alsa-utils/tree/v1.0.29</a></p></blockquote><p>è§£å‹å®Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">router2@ubuntu:~/third_lib/alsa-utils-1.2.2$ ls</span><br><span class="line">acinclude.m4  alsamixer  axfer         gitcompile  Makefile.am   TODO</span><br><span class="line">alsaconf      alsaucm    bat           iecset      po            topology</span><br><span class="line">alsactl       amidi      ChangeLog     include     README.md     utils</span><br><span class="line">alsa-info     amixer     configure.ac  INSTALL     seq</span><br><span class="line">alsaloop      aplay      COPYING       m4          speaker-test</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>aclocal</code> å‘½ä»¤ï¼Œæç¤º <code>warning: macro 'AM_PATH_ALSA' not found in library</code>ï¼Œè¿™æ˜¯å› ä¸ºæ²¡æŠŠäº¤å‰ç¼–è¯‘ alsa ç”Ÿæˆçš„ m4 æ–‡ä»¶æ”¾åˆ°ç³»ç»Ÿç›®å½•ã€‚ä¸ºäº†ä¸ä¸å®¿ä¸»æœº x86 ç»“æ„ç›¸æ··ä¹±ï¼Œ<strong>æ·»åŠ  -I é€‰é¡¹æ·»åŠ é¢å¤–çš„æœç´¢ç›®å½•</strong>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router2@ubuntu:~/third_lib/alsa-utils-1.2.2$ aclocal </span><br><span class="line">configure.ac:22: warning: macro &#x27;AM_PATH_ALSA&#x27; not found in library</span><br><span class="line">router2@ubuntu:~/third_lib/alsa-utils-1.2.2$ ls</span><br><span class="line">acinclude.m4  alsamixer       axfer         iecset       README.md</span><br><span class="line">aclocal.m4    alsaucm         bat           include      seq</span><br><span class="line">alsaconf      amidi           ChangeLog     INSTALL      speaker-test</span><br><span class="line">alsactl       amixer          configure.ac  m4           TODO</span><br><span class="line">alsa-info     aplay           COPYING       Makefile.am  topology</span><br><span class="line">alsaloop      autom4te.cache  gitcompile    po           utils</span><br></pre></td></tr></table></figure><p>æ·»åŠ  aclocal æœç´¢è·¯å¾„ï¼Œå‰é¢äº¤å‰ç¼–è¯‘å¥½çš„ alsa åº“ä¸­çš„ .m4 æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aclocal -I /home/router2/third_lib/tmp/arm-libalsa-1.0.29/share/aclocal</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç›®å½•æ˜¯äº¤å‰ç¼–è¯‘ alsa åº“ç”Ÿæˆçš„ï¼Œé‡Œé¢æœ‰ <code>alsa.m4</code> æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router2@ubuntu:~/third_lib/tmp/arm-libalsa-1.0.29$ ls share/aclocal/</span><br><span class="line">alsa.m4</span><br></pre></td></tr></table></figure><p>gettextize åˆå§‹åŒ– GNU gettext æ”¯æŒï¼Œç”¨äºå¤šè¯­è¨€æ”¯æŒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gettextize </span><br></pre></td></tr></table></figure><p>autoheader ç”Ÿæˆ <code>config.h.in</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoheader</span><br></pre></td></tr></table></figure><p>æŠ¥é”™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">configure.ac:356: error: `po/Makefile.in&#x27; is already registered with AC_CONFIG_FILES.</span><br><span class="line">../../lib/autoconf/status.m4:288: AC_CONFIG_FILES is expanded from...</span><br><span class="line">configure.ac:356: the top level</span><br><span class="line">autom4te: /usr/bin/m4 failed with exit status: 1</span><br><span class="line">autoheader: &#x27;/usr/bin/autom4te&#x27; failed with exit status: 1</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ <code>configure.ac</code> æ–‡ä»¶å‘ç° <code>AC_OUTPUT</code> å‡ºç°äº†ä¸¤æ¬¡ <code>po/Makefile.in </code>ï¼Œåˆ é™¤å…¶ä¸­ä¸€ä¸ªå³å¯ã€‚è¿™ä¸€ä¸ªé”™è¯¯æ‰¾äº†å°†è¿‘ 2 ä¸ªå°æ—¶ï¼Œæœç´¢ç½‘ä¸Šçš„èµ„æ–™ä¹Ÿéƒ½æœªæ‰¾åˆ°åˆé€‚çš„è§£å†³æ–¹æ³•ã€‚</p><p><img src="image-20240719003003493.png" alt="image-20240719003003493"></p><p>åˆ é™¤åå†æ¬¡æ‰§è¡Œ autoheader æˆåŠŸï¼Œæ‰§è¡Œ autoconf ç”Ÿæˆ <code>configure</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoconf</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>automake</code> å‘½ä»¤ç”Ÿæˆ <code>Makefile.in</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">automake --foreign --copy --add-missing</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥æ‰§è¡Œ configure è„šæœ¬æ–‡ä»¶ç”Ÿæˆ Makefile æ–‡ä»¶äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --host=arm-buildroot-linux-gnueabihf --prefix=/home/router2/third_lib/tmp/alsa-utils --with-alsa-inc-prefix=/home/router2/third_lib/tmp/arm-libalsa-1.0.29/include/ --with-alsaprefix=/home/router2/third_lib/tmp/arm-libalsa-1.0.29/lib/ --disable-alsamixer --disable-xmlto</span><br></pre></td></tr></table></figure><p>æœ€åæ‰§è¡Œ make å’Œ make install ä¹Ÿæ²¡å‡ºç°ä»€ä¹ˆé—®é¢˜äº†ï¼Œmake install éœ€è¦ sudo åŠ æƒé™å¦åˆ™ä¼šæŠ¥é”™ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>ç§»æ¤åœ¨å¼€å‘æ¿æµ‹è¯•æ—¶å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALSA lib conf.c:3512:(snd_config_hook_load) cannot stat file/directory /home/router2/third_lib/tmp/arm-libalsa-1.0.29/share/alsa/cards/aliases.conf</span><br><span class="line">ALSA lib pcm.c:2267:(snd_pcm_open_noupdate) Unknown PCM cards.pcm.default</span><br><span class="line">aplay: main:722: audio open error: No such file or directory</span><br></pre></td></tr></table></figure><p>åæŸ¥èµ„æ–™å‘ç°æ˜¯ç”±äºå‰é¢äº¤å‰ç¼–è¯‘ <code>alsa</code> æ—¶æœªæ­£å¸¸è®¾ç½®é…ç½®æ–‡ä»¶å‡ºç°çš„é”™è¯¯ï¼Œå› æ­¤éœ€è¦é‡æ–°äº¤å‰ç¼–è¯‘ <code>alsa</code> é…ç½®æ—¶åŠ ä¸Š <code>--with-configdir=/usr/share/arm-alsa</code> ï¼Œé…ç½®æ–‡ä»¶ä¹Ÿæ”¾åœ¨å¼€å‘æ¿çš„æ­¤è·¯å¾„å³å¯ã€‚</p><h3 id="å£°å¡è®¾ç½®ä¸æµ‹è¯•">å£°å¡è®¾ç½®ä¸æµ‹è¯•</h3><p>alsa-utils è‡ªå¸¦äº† amixer è¿™ä¸ªå£°å¡è®¾ç½®å·¥å…·ï¼Œamixer è½¯ä»¶å‘½ä»¤åˆ†ä¸ºä¸¤ç»„ï¼Œscontrolsã€scontentsã€sset å’Œ sget ä¸ºä¸€ç»„ã€‚controlsã€contentsã€cset å’Œ cget ä¸ºå¦ä¸€ç»„ï¼Œå¸¦ s çš„æ˜¯ç®€åŒ–ç‰ˆã€‚</p><h4 id="ç®€å•ä½¿ç”¨æ–¹æ³•">ç®€å•ä½¿ç”¨æ–¹æ³•</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// æŸ¥çœ‹amixer å¸®åŠ©ä¿¡æ¯</span><br><span class="line">amixer --help</span><br><span class="line"></span><br><span class="line">// æŸ¥çœ‹æ‰€æœ‰è®¾ç½®é¡¹</span><br><span class="line">amixer scontrols</span><br><span class="line"></span><br><span class="line">// æŸ¥çœ‹æ‰€æœ‰è®¾ç½®é¡¹</span><br><span class="line">amixer controls</span><br><span class="line"></span><br><span class="line">// æŸ¥çœ‹è®¾ç½®å€¼</span><br><span class="line">amixer scontents</span><br><span class="line"></span><br><span class="line">// è®¾ç½®å£°å¡</span><br><span class="line">amixer sset è®¾ç½®é¡¹ç›® è®¾ç½®å€¼</span><br><span class="line">amixer cset è®¾ç½®é¡¹ç›® è®¾ç½®å€¼</span><br><span class="line"></span><br><span class="line">// è·å–å£°å¡è®¾ç½®å€¼</span><br><span class="line">amixer sget è®¾ç½®é¡¹ç›®</span><br><span class="line">amixer cget è®¾ç½®é¡¹ç›®</span><br></pre></td></tr></table></figure><h4 id="éŸ³ä¹æ’­æ”¾æµ‹è¯•">éŸ³ä¹æ’­æ”¾æµ‹è¯•</h4><p>ç”±äº 100ask å¼€å‘æ¿æ²¡æœ‰æ¿è½½å–‡å­ä½†æœ‰é¢„ç•™æ¥å£ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç›´æ¥å¤–æ”¾ï¼Œéœ€è¦<strong>æ’å…¥æœ‰çº¿è€³æœºæˆ–è€…æ’ä¸Šå–‡å­æ¥å£</strong>ã€‚</p><p>è®¾ç½®å£°å¡ï¼Œæ‰“å¼€è€³æœºå’Œå–‡å­ï¼Œå¹¶ä¸”è®¾ç½®å…¶éŸ³é‡ï¼Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">amixer sset Headphone 100,100</span><br><span class="line">amixer sset Speaker 120,120</span><br><span class="line">amixer sset &#x27;Right Output Mixer PCM&#x27; on</span><br><span class="line">amixer sset &#x27;Left Output Mixer PCM&#x27; on</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ aplay è½¯ä»¶æ’­æ”¾ wav æ ¼å¼éŸ³ä¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aplay test.wav</span><br></pre></td></tr></table></figure><p>æç¤ºé”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aplay: set_params:1305: Can&#x27;t use period equal to buffer size (0 == 0)</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸‹æ–¹åšå®¢æä¾›æ–¹æ³•é‡æ–°ç¼–è¯‘ alsa-libï¼Œä»æ— æ³•è§£å†³ï¼š</p><blockquote><p><a href="https://blog.csdn.net/zmlovelx/article/details/105091875">æ’­æ”¾æ—¶alsaå‡ºé”™Canâ€™t use period equal to buffer size (0 == 0)_signed 16 bit little endian, rate 44100 hz, stereo-CSDNåšå®¢</a></p></blockquote><p>é—®é¢˜å¾…è§£å†³ã€‚</p><h4 id="è®¾ç½®å£°å¡é…ç½®æ–‡ä»¶ï¼š">è®¾ç½®å£°å¡é…ç½®æ–‡ä»¶ï¼š</h4><p>ä½¿ç”¨æ­£ç‚¹åŸå­æä¾›çš„å£°å¡é…ç½®æ–‡ä»¶ï¼šå†™å…¥è„šæœ¬æ–‡ä»¶æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ­£ç‚¹åŸå­@ALIENTEK</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è®¾ç½®æ•è·çš„éŸ³é‡</span></span><br><span class="line">amixer cset name=&#x27;Capture Volume&#x27; 90,90</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">PCM</span></span><br><span class="line">amixer sset &#x27;PCM Playback&#x27; on</span><br><span class="line">amixer sset &#x27;Playback&#x27; 256</span><br><span class="line">amixer sset &#x27;Right Output Mixer PCM&#x27; on</span><br><span class="line">amixer sset &#x27;Left Output Mixer PCM&#x27; on</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ADC PCM</span></span><br><span class="line">amixer sset &#x27;ADC PCM&#x27; 200</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è€³æœº/å–‡å­ï¼ˆæ‰¬å£°å™¨ï¼‰è®¾ç½®æ’­æ”¾éŸ³é‡ï¼Œç›´æµ/äº¤æµ</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Turn on Headphone</span></span><br><span class="line">amixer sset &#x27;Headphone Playback ZC&#x27; on</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Set the volume of your headphones(98% volumeï¼Œ127 is the MaxVolume)</span></span><br><span class="line">amixer sset Headphone 125,125</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Turn on the speaker</span></span><br><span class="line">amixer sset &#x27;Speaker Playback ZC&#x27; on</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Set the volume of your Speaker(98% volumeï¼Œ127 is the MaxVolume)</span></span><br><span class="line">amixer sset Speaker 125,125</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Set the volume of your Speaker AC(80% volumeï¼Œ100 is the MaxVolume)</span></span><br><span class="line">amixer sset &#x27;Speaker AC&#x27; 4</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Set the volume of your Speaker AC(80% volumeï¼Œ5 is the MaxVolume)</span></span><br><span class="line">amixer sset &#x27;Speaker DC&#x27; 4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">éŸ³é¢‘è¾“å…¥ï¼Œå·¦å£°é“ç®¡ç†</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Turn on Left Input Mixer Boost</span></span><br><span class="line">amixer sset &#x27;Left Input Mixer Boost&#x27; off</span><br><span class="line">amixer sset &#x27;Left Boost Mixer LINPUT1&#x27; off</span><br><span class="line">amixer sset &#x27;Left Input Boost Mixer LINPUT1&#x27; 0</span><br><span class="line">amixer sset &#x27;Left Boost Mixer LINPUT2&#x27; off</span><br><span class="line">amixer sset &#x27;Left Input Boost Mixer LINPUT2&#x27; 0</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Turn off Left Boost Mixer LINPUT3</span></span><br><span class="line">amixer sset &#x27;Left Boost Mixer LINPUT3&#x27; off</span><br><span class="line">amixer sset &#x27;Left Input Boost Mixer LINPUT3&#x27; 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">éŸ³é¢‘è¾“å…¥ï¼Œå³å£°é“ç®¡ç†ï¼Œå…¨éƒ¨å…³é—­</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Turn on Right Input Mixer Boost</span></span><br><span class="line">amixer sset &#x27;Right Input Mixer Boost&#x27; on</span><br><span class="line">amixer sset &#x27;Right Boost Mixer RINPUT1&#x27; off</span><br><span class="line">amixer sset &#x27;Right Input Boost Mixer RINPUT2&#x27; 0</span><br><span class="line">amixer sset &#x27;Right Boost Mixer RINPUT2&#x27; on</span><br><span class="line">amixer sset &#x27;Right Input Boost Mixer RINPUT2&#x27; 127</span><br><span class="line">amixer sset &#x27;Right Boost Mixer RINPUT3&#x27; off</span><br><span class="line">amixer sset &#x27;Right Input Boost Mixer RINPUT3&#x27; 0</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨-arecord-å½•åˆ¶éŸ³é¢‘">ä½¿ç”¨ arecord å½•åˆ¶éŸ³é¢‘</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arecord -f cd -d 10 record.wav</span><br></pre></td></tr></table></figure><p>åˆ·å±æç¤ºé”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[@obito:/music]# arecord -f cd -d 10 record.wav</span><br><span class="line">Recording WAVE &#x27;record.wav&#x27; : Signed 16 bit Little Endian, Rate 44100 Hz, Stereo</span><br><span class="line">overrun!!! (at least 3.360 ms long)</span><br><span class="line">overrun!!! (at least 3.064 ms long)</span><br><span class="line">overrun!!! (at least 2.956 ms long)</span><br><span class="line">overrun!!! (at least 3.157 ms long)</span><br><span class="line">overrun!!! (at least 2.959 ms long)</span><br><span class="line">overrun!!! (at least 3.087 ms long)</span><br><span class="line">overrun!!! (at least 2.956 ms long)</span><br><span class="line">overrun!!! (at least 2.950 ms long)</span><br><span class="line">overrun!!! (at least 3.026 ms long)</span><br></pre></td></tr></table></figure><p>é—®é¢˜å¾…è§£å†³ã€‚</p><h4 id="å†æ¬¡æµ‹è¯•-mplayer">å†æ¬¡æµ‹è¯• mplayer</h4><p>ä½¿ç”¨ mplayer èƒ½å¤Ÿæ­£å¸¸æ’­æ”¾éŸ³é¢‘å’Œè§†é¢‘ï¼Œè§†é¢‘è¾“å‡ºç”»é¢å’ŒéŸ³é¢‘éƒ½æ­£å¸¸ã€‚</p><h4 id="ä¿å­˜å£°å¡é…ç½®æ–‡ä»¶">ä¿å­˜å£°å¡é…ç½®æ–‡ä»¶</h4><p>ä½¿ç”¨ <code>alsa-utils</code> å·¥å…·é›†ä¸­çš„ <code>alsactl</code> å·¥å…·ä¿å­˜å£°å¡é…ç½®ï¼Œé»˜è®¤ä¿å­˜åœ¨ <code>/var/lib/alsa</code> ç›®å½•ä¸‹ï¼Œå…ˆåˆ›å»ºè¯¥ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/alsa -p</span><br></pre></td></tr></table></figure><p>ä¿å­˜å£°å¡é…ç½®æç¤ºé”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[@obito:/music]# alsactl -f /var/lib/alsa/asound.state store</span><br><span class="line">alsactl: state_lock:125: file /var/lib/alsa/asound.state lock error: No such file or directory</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢èµ„æ–™å¾—çŸ¥æ˜¯ï¼šåˆ¶ä½œæ ¹æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™æ²¡æœ‰ <code>/var/lock</code> çš„ç›®å½•ï¼Œalsactl é»˜è®¤ä¼šåœ¨ <code>/var/lock</code> ç›®å½•æ“ä½œï¼Œæ‰€ä»¥å°±ä¼šå¤±è´¥ã€‚</p><blockquote><p><a href="https://blog.csdn.net/JasonTD/article/details/131927546">alsactl: state_lock:125: file /var/lib/alsa/asound.state lock error: No such file or directory_asound.state.lock-CSDNåšå®¢</a></p></blockquote><p>æ–°å»ºç›®å½•é‡æ–°ä¿å­˜æˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lock</span><br><span class="line">alsactl -f /var/lib/alsa/asound.state store</span><br></pre></td></tr></table></figure><p>ä»¥åå°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ¢å¤å£°å¡é…ç½®äº†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alsactl -f /var/lib/alsa/asound.state restore</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å¼€æœºè‡ªåŠ¨è®¾ç½®å£°å¡ï¼Œå°†å…¶å†™å…¥ <code>/etc/init.d/rcS</code> æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if [ -f &quot;/var/lib/alsa/asound.state&quot; ]; then</span><br><span class="line">    echo &quot;ALSA: Restoring mixer setting......&quot;</span><br><span class="line">    /sbin/alsactl -f /var/lib/alsa/asound.state restore &amp;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå†è¿›è¡Œæ¢å¤ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>ç§»æ¤ WM8690 é©±åŠ¨æˆåŠŸï¼Œaplay å’Œ arecord é—®é¢˜å¾…è§£å†³ï¼Œmplayer èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linux-éŸ³é¢‘é©±åŠ¨&quot;&gt;Linux-éŸ³é¢‘é©±åŠ¨&lt;/h1&gt;
&lt;h2 id=&quot;åºè¨€&quot;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;ç§»æ¤äº† mplayer æ’­æ”¾å™¨ï¼Œæ’­æ”¾è§†é¢‘æ—¶å‘ç°æ²¡æœ‰å£°éŸ³ï¼ŒåŸæ¥æ˜¯éŸ³é¢‘é©±åŠ¨è¿˜æ²¡ç§»æ¤ã€‚100ask å¼€å‘æ¿ä½¿ç”¨åˆ°çš„éŸ³é¢‘èŠ¯ç‰‡ä¸º WM8690ï¼ŒLinux å†…æ ¸å·²ç»æœ‰è¯¥é©±åŠ¨</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux" scheme="http://www.obito.top/tags/Linux/"/>
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>autotoolsè‡ªåŠ¨ç”ŸæˆMakefile</title>
    <link href="http://www.obito.top/2024/07/18/autotools%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90Makefile/"/>
    <id>http://www.obito.top/2024/07/18/autotools%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90Makefile/</id>
    <published>2024-07-18T08:20:22.000Z</published>
    <updated>2024-07-18T08:27:11.278Z</updated>
    
    <content type="html"><![CDATA[<h1 id="autotools-è‡ªåŠ¨ç”Ÿæˆ-makefile">autotools è‡ªåŠ¨ç”Ÿæˆ Makefile</h1><p>Makefile å¯ä»¥å¤§å¤§æé«˜ç¼–è¯‘ç¨‹åºçš„æ•ˆç‡ï¼Œæ‰‹å†™ Makefile ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥æ¯”è¾ƒå¤§çš„é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨ autotools å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆ Makefileã€‚</p><p>æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><p><img src="20150708225200452.jpeg" alt="img"></p><blockquote><p><a href="https://blog.csdn.net/initphp/article/details/7692923">Linux c å¼€å‘ - Makefileå·¥å…·-CSDNåšå®¢</a></p></blockquote><blockquote><p><a href="https://blog.csdn.net/weixin_38233274/article/details/80077707">Linuxä¸­ä½¿ç”¨autotoolsè‡ªåŠ¨ç”ŸæˆMakefile_automake --add-missing automake: warnings are trea-CSDNåšå®¢</a></p></blockquote><blockquote><p><a href="https://blog.csdn.net/weixin_42050875/article/details/97113411">automakeâ€”configure.in/configure.amå’Œmakefile.amç¼–å†™-CSDNåšå®¢</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;autotools-è‡ªåŠ¨ç”Ÿæˆ-makefile&quot;&gt;autotools è‡ªåŠ¨ç”Ÿæˆ Makefile&lt;/h1&gt;
&lt;p&gt;Makefile å¯ä»¥å¤§å¤§æé«˜ç¼–è¯‘ç¨‹åºçš„æ•ˆç‡ï¼Œæ‰‹å†™ Makefile ä¹Ÿæ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥æ¯”è¾ƒå¤§çš„é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨ autotools å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆ Mak</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>IMX6ULL-äº¤å‰ç¼–è¯‘Mplayer</title>
    <link href="http://www.obito.top/2024/07/17/IMX6ULL-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91Mplayer/"/>
    <id>http://www.obito.top/2024/07/17/IMX6ULL-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91Mplayer/</id>
    <published>2024-07-17T05:45:12.000Z</published>
    <updated>2024-07-22T12:12:40.642Z</updated>
    
    <content type="html"><![CDATA[<h1 id="imx6ull-äº¤å‰ç¼–è¯‘mplayer">IMX6ULL-äº¤å‰ç¼–è¯‘Mplayer</h1><h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2><h3 id="ç¡¬ä»¶ç¯å¢ƒ">ç¡¬ä»¶ç¯å¢ƒ</h3><ul><li><strong>å¼€å‘æ¿å‹å·</strong>ï¼š <a href="https://blog.csdn.net/thisway_diy/article/details/109841372">100ask_imx6ull_pro å¼€å‘æ¿</a></li><li><strong>å¤„ç†å™¨ç±»å‹</strong>ï¼šNXP IMX6ULL</li><li>**å¤„ç†å™¨æ¶æ„ï¼š**æ©å•æ ¸ Cortex-A7</li><li>**å¤„ç†å™¨ä¸»é¢‘ï¼š**800MHZ</li><li><strong>å†…å­˜å®¹é‡</strong>ï¼š512 MB DDR3</li><li><strong>å­˜å‚¨ä»‹è´¨</strong>ï¼š4GB eMMC</li></ul><h3 id="è½¯ä»¶ç¯å¢ƒ">è½¯ä»¶ç¯å¢ƒ</h3><ul><li>å®¿ä¸»æœº<ul><li><strong>å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ</strong>ï¼šUbuntu 18.04</li><li><strong>äº¤å‰ç¼–è¯‘å™¨</strong>ï¼š100ask æä¾›çš„å·¥å…·é“¾ arm-buildroot-linux-gnueabihf- <strong>æ”¯æŒçš„æœ€ä½å†…æ ¸ç‰ˆæœ¬</strong>ï¼š4.9.0</li></ul></li><li>å¼€å‘æ¿<ul><li>**U-Bootï¼š**ä¸€å¼€å§‹ç”¨çš„ NXP å®˜æ–¹æä¾›çš„ç‰ˆæœ¬ä½†ä¸èƒ½æ­£å¸¸å¯åŠ¨å†…æ ¸ï¼Œåæ”¹ä¸º 100ask æä¾›çš„ç‰ˆæœ¬</li><li><strong>å†…æ ¸ç‰ˆæœ¬</strong>ï¼š <a href="https://github.com/nxp-imx/linux-imx/tree/imx_4.9.88_2.0.0_ga">NXP æä¾›çš„ 4.9.88 ç‰ˆæœ¬</a></li><li><strong>æ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹</strong>ï¼š<a href="https://busybox.net/downloads/">BusyBox 1.29.0</a></li></ul></li></ul><h2 id="ç¼–è¯‘è¿‡ç¨‹">ç¼–è¯‘è¿‡ç¨‹</h2><p>mplayer ä¾èµ– alsa åº“ï¼ˆéŸ³é¢‘ï¼‰å’Œ libmad åº“ï¼ˆå¯¹ MP3 è¿›è¡Œè§£ç ï¼‰ï¼Œæ‰€ä»¥å…ˆäº¤å‰ç¼–è¯‘ mplayer å’Œ libmadï¼Œ</p><h3 id="äº¤å‰ç¼–è¯‘-libmad">äº¤å‰ç¼–è¯‘ libmad</h3><p>libmad æ˜¯ä¸€ä¸ªå¼€æºçš„ MP3 è§£ç åº“ï¼Œmplayer ä½¿ç”¨ libmad è¿›è¡Œå¯¹ MP3 çš„æ”¯æŒã€‚</p><p>ä¸‹è½½åœ°å€ï¼š</p><blockquote><p><a href="https://github.com/sezero/libmad/tags">Tags Â· sezero/libmad (github.com)</a></p></blockquote><p>è§£å‹å‹ç¼©åŒ…æœ‰ä»¥ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">acconfig.h    CREDITS    global.h       layer3.c      stamp-h.in  VERSION</span><br><span class="line">bit.c         D.dat      huffman.c      layer3.h      stream.c    version.c</span><br><span class="line">bit.h         decoder.c  huffman.h      mad.h.sed     stream.h    version.h</span><br><span class="line">CHANGES       decoder.h  imdct_l_arm.S  Makefile.am   synth.c</span><br><span class="line">config.h.in   fixed.c    imdct_s.dat    qc_table.dat  synth.h</span><br><span class="line">configure.in  fixed.h    INSTALL        README        timer.c</span><br><span class="line">COPYING       frame.c    layer12.c      rq_table.dat  timer.h</span><br><span class="line">COPYRIGHT     frame.h    layer12.h      sf_table.dat  TODO</span><br></pre></td></tr></table></figure><p>å¯è§æœ‰ <a href="http://configure.in">configure.in</a> å’Œ <a href="http://Makefile.am">Makefile.am</a> æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆ configure å’Œ <a href="http://Makefile.in">Makefile.in</a> æ–‡ä»¶æ‰èƒ½ç”Ÿæˆ Makefileã€‚</p><p>æ‰§è¡Œ <code>aclocal</code> ï¼Œç”Ÿæˆ <code>aclocal.m4</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aclocal</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>autoconf</code>ï¼Œ ç”Ÿæˆ <code>configure</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoconf</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>libtoolize</code>ï¼Œç”Ÿæˆ<code>ltmain.sh</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libtoolize</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>autoheader</code> ï¼Œç”Ÿæˆ <code>config.h.in</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoheader</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>automake</code>å‘½ä»¤ï¼Œç”Ÿæˆ <code>Makefile.in</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">automake --add-missing</span><br></pre></td></tr></table></figure><p>å‡ºç°é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">automake: warning: autoconf input should be named &#x27;configure.ac&#x27;, not &#x27;configure.in&#x27;</span><br><span class="line">configure.in:25: warning: AM_INIT_AUTOMAKE: two- and three-arguments forms are deprecated.  For more info, see:</span><br><span class="line">configure.in:25: http://www.gnu.org/software/automake/manual/automake.html#Modernize-AM_005fINIT_005fAUTOMAKE-invocation</span><br><span class="line">Makefile.am:50: warning: &#x27;INCLUDES&#x27; is the old name for &#x27;AM_CPPFLAGS&#x27; (or &#x27;*_CPPFLAGS&#x27;)</span><br><span class="line">Makefile.am: error: required file &#x27;./NEWS&#x27; not found</span><br><span class="line">Makefile.am: error: required file &#x27;./AUTHORS&#x27; not found</span><br><span class="line">Makefile.am: error: required file &#x27;./ChangeLog&#x27; not found</span><br><span class="line">automake: warning: autoconf input should be named &#x27;configure.ac&#x27;, not &#x27;configure.in&#x27;</span><br><span class="line">/usr/share/automake-1.15/am/depend2.am: error: am__fastdepCCAS does not appear in AM_CONDITIONAL</span><br><span class="line">/usr/share/automake-1.15/am/depend2.am:   The usual way to define &#x27;am__fastdepCCAS&#x27; is to add &#x27;AM_PROG_AS&#x27;</span><br><span class="line">/usr/share/automake-1.15/am/depend2.am:   to &#x27;configure.in&#x27; and run &#x27;aclocal&#x27; and &#x27;autoconf&#x27; again</span><br><span class="line">Makefile.am: error: Preprocessed Assembler source seen but &#x27;CCAS&#x27; is undefined</span><br><span class="line">Makefile.am:   The usual way to define &#x27;CCAS&#x27; is to add &#x27;AM_PROG_AS&#x27;</span><br><span class="line">Makefile.am:   to &#x27;configure.in&#x27; and run &#x27;aclocal&#x27; and &#x27;autoconf&#x27; again.</span><br><span class="line">Makefile.am: error: Preprocessed Assembler source seen but &#x27;CCASFLAGS&#x27; is undefined</span><br><span class="line">Makefile.am:   The usual way to define &#x27;CCASFLAGS&#x27; is to add &#x27;AM_PROG_AS&#x27;</span><br><span class="line">Makefile.am:   to &#x27;configure.in&#x27; and run &#x27;aclocal&#x27; and &#x27;autoconf&#x27; again.</span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰ä¸¤ç±»é”™è¯¯ï¼šä¸€ç±»æ˜¯ç¼ºå°‘æ–‡ä»¶ï¼Œä¸€ç§æ˜¯å®å®šä¹‰ç¼ºå¤±ã€‚</p><p>ç¬¬ä¸€ç±»é”™è¯¯ï¼šåŠ ä¸Šé€‰é¡¹ <code>--add-missing</code> ä¼šè‡ªåŠ¨ç”Ÿæˆç¼ºå°‘çš„æ–‡ä»¶ï¼Œä½†æ˜¯è¿è¡Œä¹‹åæ²¡æœ‰ç”Ÿæˆç¼ºå°‘çš„æ–‡ä»¶ï¼Œè¿™æ—¶æˆ‘ä»¬å†æ‰‹åŠ¨åˆ›å»ºä»¥ä¸‹ï¼š</p><p>æ‰‹åŠ¨åˆ›å»ºå…¶ä»–ç¼ºå°‘çš„æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch NEWS AUTHORS ChangeLog</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç±»é”™è¯¯ï¼šåœ¨ <a href="http://configure.in">configure.in</a> æ–‡ä»¶ä¸­æ·»åŠ  AM_PROG_AS ï¼š</p><p><img src="image-20240717162519222.png" alt="image-20240717162519222"></p><p>æ·»åŠ å®Œé‡æ–°è¿è¡Œ <code>acloca</code>l æ›´æ–° <code>aclocal.m4</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aclocal</span><br></pre></td></tr></table></figure><p>è¿è¡Œ <code>autoconf</code> æ›´æ–° <code>configure</code> è„šæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoconf</span><br></pre></td></tr></table></figure><p>è¿è¡Œ <code>automake</code> ç”Ÿæˆ <code>Makefile.in</code> æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">automake --add-missing</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æ‰€æœ‰æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">acconfig.h      configure     frame.h        ltmain.sh     stream.h</span><br><span class="line">aclocal.m4      configure.in  global.h       mad.h.sed     synth.c</span><br><span class="line">AUTHORS         COPYING       huffman.c      Makefile.am   synth.h</span><br><span class="line">autom4te.cache  COPYRIGHT     huffman.h      Makefile.in   timer.c</span><br><span class="line">bit.c           CREDITS       imdct_l_arm.S  missing       timer.h</span><br><span class="line">bit.h           D.dat         imdct_s.dat    NEWS          TODO</span><br><span class="line">ChangeLog       decoder.c     INSTALL        qc_table.dat  VERSION</span><br><span class="line">CHANGES         decoder.h     install-sh     README        version.c</span><br><span class="line">compile         depcomp       layer12.c      rq_table.dat  version.h</span><br><span class="line">config.guess    fixed.c       layer12.h      sf_table.dat</span><br><span class="line">config.h.in     fixed.h       layer3.c       stamp-h.in</span><br><span class="line">config.sub      frame.c       layer3.h       stream.c</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ configure è„šæœ¬æ–‡ä»¶ç”Ÿæˆ Makefile æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --host=arm-linux CC=arm-buildroot-linux-gnueabihf-gcc --prefix=/home/router2/third_lib/tmp/arm-libmad-0.14.2b --disable-debugging --enable-static --enable-shared</span><br></pre></td></tr></table></figure><p>make å‘½ä»¤ç¼–è¯‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j8</span><br></pre></td></tr></table></figure><p>æç¤ºé”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc: error: unrecognized command line option â€˜-fforce-memâ€™; did you mean â€˜-fforce-addrâ€™?</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ Makefile æ–‡ä»¶ï¼ŒæŸ¥æ‰¾ <code>-fforce-mem</code> ï¼Œå°†å…¶åˆ é™¤å³å¯ã€‚</p><p>å†æ¬¡ç¼–è¯‘å°±èƒ½æˆåŠŸäº†ï¼Œæœ€åè¿›è¡Œ make install ç”Ÿæˆç›®æ ‡æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="äº¤å‰ç¼–è¯‘-libalsa">äº¤å‰ç¼–è¯‘ libalsa</h3><p>libalsa æ˜¯</p><p>ä¸‹è½½åœ°å€ï¼š</p><blockquote><p><a href="https://github.com/alsa-project/alsa-lib/tags?after=v1.1.1">Tags Â· alsa-project/alsa-lib (github.com)</a></p></blockquote><p>è§£å‹å¾—åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">acinclude.m4  ChangeLog     doc         INSTALL      MEMORY-LEAK  src   utils</span><br><span class="line">alsalisp      configure.ac  gitcompile  m4           modules      test</span><br><span class="line">aserver       COPYING       include     Makefile.am  NOTES        TODO</span><br></pre></td></tr></table></figure><p>å¯è§æœ‰ <a href="http://configure.ac">configure.ac</a>ï¼ˆè·Ÿ <a href="http://configure.in">configure.in</a> ç›¸åŒï¼Œåªæ˜¯ automake ç‰ˆæœ¬ä¸åŒçš„åŸå› ï¼‰ å’Œ <a href="http://Makefile.am">Makefile.am</a> æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ç”Ÿæˆ configure å’Œ <a href="http://Makefile.in">Makefile.in</a> æ–‡ä»¶æ‰èƒ½ç”Ÿæˆ Makefileã€‚</p><p>æ‰§è¡Œ <code>aclocal</code> ï¼Œç”Ÿæˆ <code>aclocal.m4</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aclocal</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>autoconf</code>ï¼Œ ç”Ÿæˆ <code>configure</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoconf</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>libtoolize</code>ï¼Œç”Ÿæˆ<code>ltmain.sh</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libtoolize</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>autoheader</code> ï¼Œç”Ÿæˆ <code>config.h.in</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoheader</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ <code>automake</code>å‘½ä»¤ï¼Œç”Ÿæˆ<code>Makefile.in</code> æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">automake --add-missing</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ configure è„šæœ¬æ–‡ä»¶ç”Ÿæˆ Makefile æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --host=arm-linux CC=arm-buildroot-linux-gnueabihf-gcc --prefix=/home/router2/third_lib/tmp/arm-libalsa-1.0.29 --with-configdir=/usr/share/arm-alsa --disable-python --enable-shared</span><br></pre></td></tr></table></figure><p>éœ€è¦æ·»åŠ  <code>--with-configdir</code> é€‰é¡¹è®¾ç½® alsa ç¼–è¯‘å‡ºæ¥çš„é…ç½®æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼Œä¿è¯ ubuntu å’Œå¼€å‘æ¿æ ¹æ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„ä¸€è‡´ã€‚å¦åˆ™ç§»æ¤åˆ°å¼€å‘æ¿æ—¶ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALSA lib conf.c:3512:(snd_config_hook_load) cannot stat file/directory /home/router2/third_lib/tmp/arm-libalsa-1.0.29/share/alsa/cards/aliases.conf</span><br><span class="line">ALSA lib pcm.c:2267:(snd_pcm_open_noupdate) Unknown PCM cards.pcm.default</span><br></pre></td></tr></table></figure><p>æœ€åç¼–è¯‘å®‰è£…å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j8 </span><br><span class="line">make install </span><br></pre></td></tr></table></figure><p>å‡ºç°è¯¥é”™è¯¯ï¼š</p><p><img src="image-20240719021112805.png" alt="image-20240719021112805"></p><p>è§£å†³æ–¹æ³•æ˜¯åˆ‡æ¢åˆ°åˆ‡æ¢åˆ° root ç”¨æˆ·é‡æ–° make install å³å¯è§£å†³ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="äº¤å‰ç¼–è¯‘-mplayer">äº¤å‰ç¼–è¯‘ Mplayer</h3><p>MPlayeræ˜¯ä¸€æ¬¾å¼€æºå¤šåª’ä½“æ’­æ”¾å™¨ï¼ŒMPlayeråŸºäºå‘½ä»¤è¡Œç•Œé¢ï¼Œåœ¨å„æ“ä½œç³»ç»Ÿä¹Ÿå¯é€‰æ‹©å®‰è£…ä¸åŒçš„å›¾å½¢ç•Œé¢ã€‚mplaye rçš„å¦ä¸€ä¸ªå¤§çš„ç‰¹è‰²æ˜¯å¹¿æ³›çš„è¾“å‡ºè®¾å¤‡æ”¯æŒã€‚å®ƒå¯ä»¥åœ¨ X11ã€Xvã€DGAã€OpenGLã€SVGAlibã€fbdevã€AAlibã€DirectFB ä¸‹å·¥ä½œï¼Œæˆ‘ä»¬ä½¿ç”¨å¼€å‘æ¿çš„è¯ï¼Œé€‰æ‹©ä½¿ç”¨ fbdev è¾“å‡ºå³å¯ã€‚</p><p>ä¸‹è½½åœ°å€ï¼š</p><blockquote><p><a href="http://www.mplayerhq.hu/MPlayer/releases/">Index of /MPlayer/releases (mplayerhq.hu)</a></p></blockquote><p>è§£å‹ä¹‹åæœ‰ç°æˆçš„ configure æ–‡ä»¶ï¼Œä¸ç”¨å†ç”¨ automake å’Œ autoconf ç”Ÿæˆäº†ã€‚</p><p>é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/home/router2/third_lib/tmp/arm-libmplayer-1.1 --cc=arm-buildroot-linux-gnueabihf-gcc --host-cc=gcc --target=arm-linux --disable-mencoder --disable-live --disable-mp3lib --disable-win32dll --disable-dvb --disable-dvdread --disable-dvdnav --disable-dvdread-internal --disable-tv --disable-ivtv --enable-fbdev --disable-sdl --enable-mad --enable-alsa --enable-cross-compile --enable-armv5te --extra-cflags=&quot;-I /home/router2/third_lib/tmp/arm-libalsa-1.0.29/include -I /home/router2/third_lib/tmp/arm-libmad-0.14.2b/include&quot; --extra-ldflags=&quot;-L /home/router2/third_lib/tmp/arm-libalsa-1.0.29/lib -L /home/router2/third_lib/tmp/arm-libmad-0.14.2b/lib&quot; </span><br></pre></td></tr></table></figure><ul><li><code>--host-cc=gcc</code>ï¼šæŒ‡å®šå®¿ä¸»ç³»ç»Ÿçš„ C ç¼–è¯‘å™¨ä¸º gccï¼Œå³ç›®å‰ä½¿ç”¨çš„ Ubuntu çš„ç¼–è¯‘å™¨</li><li><code>--target=arm-linux</code>ï¼šæŒ‡å®šç›®æ ‡å¹³å°ä¸º ARM æ¶æ„çš„ Linux</li><li>è¿™é‡Œæ˜¯ -cc ä¹‹å‰æ˜¯ CCï¼Œè¿™ä¸ªå¾—çœ‹ configure æ–‡ä»¶çš„å®šä¹‰</li><li><code>--extra-cflags</code>  ä¾èµ–çš„å¤´æ–‡ä»¶ç›®å½•</li><li><code>--extra-ldflags</code>ï¼šä¾èµ–çš„åº“æ–‡ä»¶ç›®å½•</li></ul><p>configure å‚æ•°çš„å«ä¹‰å¯æŸ¥çœ‹ configure æ–‡ä»¶ï¼Œè¿™é‡Œçš„å‚æ•°æ·»åŠ å‚è€ƒï¼š</p><blockquote><p><a href="https://blog.csdn.net/qq_40792874/article/details/120094678?spm=1001.2014.3001.5502">IMX6ULL-äº¤å‰ç¼–è¯‘Mplayer_imx6ul äº¤å‰ç¼–è¯‘ mplayer-CSDNåšå®¢</a></p></blockquote><p>AI ç”Ÿæˆï¼š</p><blockquote><p>æ‚¨æä¾›çš„æ˜¯ä¸€ç³»åˆ—é…ç½®é€‰é¡¹ï¼Œç”¨äºç¼–è¯‘ MPlayer æ—¶ç¦ç”¨å’Œå¯ç”¨ç‰¹å®šçš„åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯æ¯ä¸ªé€‰é¡¹çš„ç®€è¦è¯´æ˜å’Œå®ƒä»¬å¯èƒ½çš„ç”¨é€”ï¼š</p><ul><li><code>--disable-mencoder</code>ï¼šç¦ç”¨ MEncoder çš„ç¼–è¯‘ï¼ŒMEncoder æ˜¯ä¸€ä¸ªè§†é¢‘ç¼–ç å™¨ã€‚</li><li><code>--disable-live</code>ï¼šç¦ç”¨ LIVE555 Streaming Media çš„æ”¯æŒã€‚</li><li><code>--disable-mp3lib</code>ï¼šç¦ç”¨å†…ç½®çš„ mp3libã€‚</li><li><code>--disable-win32dll</code>ï¼šç¦ç”¨ Win32 DLL æ”¯æŒï¼Œè¿™é€šå¸¸ç”¨äº Windows ç³»ç»Ÿã€‚</li><li><code>--disable-dvb</code>ï¼šç¦ç”¨ DVB è§†é¢‘è¾“å‡ºï¼ŒDVB æ˜¯ä¸€ç§æ•°å­—è§†é¢‘å¹¿æ’­æ ‡å‡†ã€‚</li><li><code>--disable-dvdread</code>ï¼šç¦ç”¨ libdvdread æ”¯æŒï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºè¯»å– DVD çš„åº“ã€‚</li><li><code>--disable-dvdnav</code>ï¼šç¦ç”¨ libdvdnav æ”¯æŒï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºå¤„ç† DVD å¯¼èˆªçš„åº“ã€‚</li><li><code>--disable-dvdread-internal</code>ï¼šç¦ç”¨å†…éƒ¨ libdvdread æ”¯æŒã€‚</li><li><code>--disable-tv</code>ï¼šç¦ç”¨ç”µè§†æ¥å£ï¼ŒåŒ…æ‹¬ TV/DVB grabbersã€‚</li><li><code>--disable-ivtv</code>ï¼šç¦ç”¨ IVTV TV-Out è§†é¢‘è¾“å‡ºã€‚</li><li><code>--enable-fbdev</code>ï¼šå¯ç”¨ FBDev è§†é¢‘è¾“å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ª Linux å¸§ç¼“å†²è®¾å¤‡ã€‚</li><li><code>--disable-sdl</code>ï¼šç¦ç”¨ SDL è§†é¢‘è¾“å‡ºï¼ŒSDL æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„å¤šåª’ä½“åº“ã€‚</li><li><code>--cc=arm-none-linux-gnueabi-gcc</code>ï¼šæŒ‡å®šç”¨äºç¼–è¯‘çš„ C ç¼–è¯‘å™¨ä¸º ARM æ¶æ„çš„äº¤å‰ç¼–è¯‘å™¨ã€‚</li><li><code>--host-cc=gcc</code>ï¼šæŒ‡å®šå®¿ä¸»ç³»ç»Ÿçš„ C ç¼–è¯‘å™¨ä¸º gccã€‚</li><li><code>--target=arm-linux</code>ï¼šæŒ‡å®šç›®æ ‡å¹³å°ä¸º ARM æ¶æ„çš„ Linuxã€‚</li><li><code>--enable-mad</code>ï¼šå¯ç”¨ libmad æ”¯æŒï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºè§£ç  MPEG éŸ³é¢‘çš„åº“ã€‚</li><li><code>--enable-alsa</code>ï¼šå¯ç”¨ ALSA éŸ³é¢‘è¾“å‡ºï¼ŒALSA æ˜¯ Linux ç³»ç»Ÿä¸­çš„æ ‡å‡†éŸ³é¢‘ç³»ç»Ÿã€‚</li><li><code>--enable-cross-compile</code>ï¼šå¯ç”¨äº¤å‰ç¼–è¯‘ï¼Œå…è®¸åœ¨ä¸åŒå¹³å°ä¹‹é—´ç¼–è¯‘è½¯ä»¶ã€‚</li><li><code>--enable-armv5te</code>ï¼šå¯ç”¨ ARMv5TE æ”¯æŒï¼ŒARMv5TE æ˜¯ ARM æ¶æ„çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¸¦æœ‰ DSP æ‰©å±•ã€‚</li></ul><p>è¿™äº›é€‰é¡¹è¡¨æ˜æ‚¨å¯èƒ½æ­£åœ¨ä¸º ARM æ¶æ„çš„ Linux ç³»ç»Ÿäº¤å‰ç¼–è¯‘ MPlayerï¼Œå¹¶æ ¹æ®æ‚¨çš„ç‰¹å®šéœ€æ±‚å¯ç”¨æˆ–ç¦ç”¨äº†æŸäº›åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½ä¸éœ€è¦å¤„ç† DVD æˆ– DVB å†…å®¹ï¼Œä½†éœ€è¦æ”¯æŒ ALSA éŸ³é¢‘å’Œ MPEG éŸ³é¢‘è§£ç ã€‚ä½¿ç”¨è¿™äº›é€‰é¡¹ï¼Œæ‚¨å¯ä»¥å®šåˆ¶ MPlayer çš„æ„å»ºä»¥é€‚åº”æ‚¨çš„ç¡¬ä»¶å’Œè½¯ä»¶ç¯å¢ƒã€‚</p></blockquote><p>è¿è¡Œ configure è„šæœ¬æ–‡ä»¶åæç¤ºé”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error: yasm not found, use --yasm=&#x27;&#x27; if you really want to compile without</span><br><span class="line"></span><br><span class="line">Check &quot;config.log&quot; if you do not understand why it failed.</span><br></pre></td></tr></table></figure><p>æŸ¥èµ„æ–™è¯´æ˜¯ç¼ºå°‘ yasm ç¯å¢ƒï¼Œå®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install yasm  </span><br></pre></td></tr></table></figure><blockquote><p><a href="https://blog.csdn.net/head_main/article/details/7787152">mplayerçš„ç¼–è¯‘å®‰è£…_error: yasm not found, use --yasm=â€™â€™ if you really-CSDNåšå®¢</a></p></blockquote><p>å†æ¬¡è¿è¡ŒæˆåŠŸï¼Œè¿›è¡Œç¼–è¯‘å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j8</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>å‡ºç°é”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">install -m 755 -s mplayer /home/router2/third_lib/tmp/arm-libmplayer-1.1/bin</span><br><span class="line">strip: Unable to recognise the format of the input file `/home/router2/third_lib/tmp/arm-libmplayer-1.1/bin/mplayer&#x27;</span><br><span class="line">install: strip process terminated abnormally</span><br><span class="line">Makefile:913: recipe for target &#x27;install-mplayer&#x27; failed</span><br><span class="line">make: *** [install-mplayer] Error 1</span><br></pre></td></tr></table></figure><p>éœ€è¦ä¿®æ”¹ <code>config.mak</code> æ–‡ä»¶ï¼ŒæŸ¥æ‰¾ <code>INSTALLSTRIP</code> å°†åé¢çš„<code> -s</code> åˆ é™¤ï¼Œå†æ¬¡ç¼–è¯‘å®‰è£…å³å¯æˆåŠŸã€‚</p><p>ç”Ÿæˆæ–‡ä»¶å¦‚ä¸‹ï¼Œ<strong>bin ç›®å½•æœ‰å¯æ‰§è¡Œæ–‡ä»¶ mplayer</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router2@ubuntu:~/third_lib/tmp/arm-libmplayer-1.1$ ls</span><br><span class="line">bin  etc  lib  share</span><br><span class="line">router2@ubuntu:~/third_lib/tmp/arm-libmplayer-1.1$ ls bin/</span><br><span class="line">mplayer</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ–‡ä»¶å±æ€§æ˜¯å¦ä¸º arm æ¶æ„çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router2@ubuntu:~/third_lib/tmp/arm-libmplayer-1.1$ file bin/mplayer </span><br><span class="line">bin/mplayer: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-armhf.so.3, for GNU/Linux 4.9.0, with debug_info, not stripped</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://blog.csdn.net/qq_40792874/article/details/120094678?spm=1001.2014.3001.5502">IMX6ULL-äº¤å‰ç¼–è¯‘Mplayer_imx6ul äº¤å‰ç¼–è¯‘ mplayer-CSDNåšå®¢</a></p></blockquote><h2 id="æµ‹è¯•">æµ‹è¯•</h2><p>å°† mad å’Œ alsa çš„ <code>lib</code> ç›®å½•ä¸‹çš„æ–‡ä»¶æ”¾å…¥å¼€å‘æ¿çš„ <code>/usr/lib</code> ç›®å½•ä¸‹</p><p>æ–‡ä»¶æœ‰å¦‚ä¸‹ï¼š</p><p><img src="image-20240717172124384.png" alt="image-20240717172124384"></p><p>å°† alsa çš„ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ç›®å½• <code>/usr/shar/arm-alsa</code> æ”¾åˆ°å¼€å‘æ¿ç›¸åŒç›®å½•ä¸‹ã€‚</p><p><img src="image-20240719161355385.png" alt="image-20240719161355385"></p><p>æ‰“å¼€å¼€å‘æ¿æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ <code>/etc/profile</code> æ–‡ä»¶æ·»åŠ ä»¥ä¸‹ä¿¡æ¯æŒ‡å®š alsa çš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ALSA_CONFIG_PATH=/usr/share/arm-alsa/alsa.conf</span><br></pre></td></tr></table></figure><p>å°†å¯æ‰§è¡Œæ–‡ä»¶ mplayer æ”¾è¿›å¼€å‘æ¿çš„ <code>/bin</code> ç›®å½•ã€‚</p><p>ä½¿ç”¨ mplayer æµ‹è¯•èƒ½å¦æ­£å¸¸æ’­æ”¾ï¼šå‘ç°åªæœ‰ç”»é¢æ²¡æœ‰å£°éŸ³è¾“å‡ºï¼Œåå‘ç°æ˜¯æ²¡æœ‰ç§»æ¤å¥½éŸ³é¢‘é©±åŠ¨çš„åŸå› ï¼Œåé¢å†ç§»æ¤éŸ³é¢‘é©±åŠ¨ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;imx6ull-äº¤å‰ç¼–è¯‘mplayer&quot;&gt;IMX6ULL-äº¤å‰ç¼–è¯‘Mplayer&lt;/h1&gt;
&lt;h2 id=&quot;ç¯å¢ƒ&quot;&gt;ç¯å¢ƒ&lt;/h2&gt;
&lt;h3 id=&quot;ç¡¬ä»¶ç¯å¢ƒ&quot;&gt;ç¡¬ä»¶ç¯å¢ƒ&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å¼€å‘æ¿å‹å·&lt;/strong&gt;ï¼š &lt;a href=&quot;</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux" scheme="http://www.obito.top/tags/Linux/"/>
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>modprobeåŠ è½½é©±åŠ¨é—®é¢˜</title>
    <link href="http://www.obito.top/2024/07/13/modprobe%E5%8A%A0%E8%BD%BD%E9%A9%B1%E5%8A%A8%E9%97%AE%E9%A2%98/"/>
    <id>http://www.obito.top/2024/07/13/modprobe%E5%8A%A0%E8%BD%BD%E9%A9%B1%E5%8A%A8%E9%97%AE%E9%A2%98/</id>
    <published>2024-07-13T02:55:20.000Z</published>
    <updated>2024-07-13T03:18:43.007Z</updated>
    
    <content type="html"><![CDATA[<h1 id="modprobe-åŠ è½½é©±åŠ¨é—®é¢˜">modprobe åŠ è½½é©±åŠ¨é—®é¢˜</h1><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œé©±åŠ¨åŠ è½½æ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼š<strong>é™æ€åŠ è½½å’ŒåŠ¨æ€åŠ è½½</strong>ã€‚é™æ€åŠ è½½å°±æ˜¯æŠŠé©±åŠ¨ç¨‹åºæ”¾è¿›å†…æ ¸ä¸€èµ·ç¼–è¯‘ï¼Œç³»ç»Ÿå¯åŠ¨åä¹‹é—´è¢«è°ƒç”¨ã€‚é™æ€åŠ è½½çš„ç¼ºç‚¹å°±æ˜¯è°ƒè¯•å›°éš¾ï¼Œä¸€èˆ¬éƒ½æ˜¯é©±åŠ¨ç¨‹åºè°ƒè¯•ç¨³å®šåå†å°†å…¶æ”¾è¿›å†…æ ¸ä¸€èµ·ç¼–è¯‘ã€‚åŠ¨æ€åŠ è½½æ˜¯åˆ©ç”¨ Linux çš„ module ç‰¹æ€§ï¼Œå¯ä»¥å†ç³»ç»Ÿå¯åŠ¨åä½¿ç”¨ insmod å‘½ä»¤æˆ– modprobe å‘½ä»¤æŠŠé©±åŠ¨ç¨‹åºï¼ˆ.ko æ–‡ä»¶ï¼‰æ‰‹åŠ¨æ·»åŠ è¿›å†…æ ¸ã€‚</p><h2 id="insmod">insmod</h2><p>insmod åŠ è½½æ¨¡å—æ—¶ï¼Œéœ€è¦æŒ‡å®šå®Œæ•´çš„è·¯å¾„å’Œæ¨¡å—åå­—ï¼Œä¸€èˆ¬æ˜¯åœ¨æ¨¡å—å½“å‰è·¯å¾„ç›´æ¥åŠ è½½ã€‚ä¸ä¼šè‡ªåŠ¨å¤„ç†æ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œå¦‚æœå½“å‰åŠ è½½çš„æ¨¡å—ä¾èµ–å…¶ä»–æ¨¡å—ï¼Œåˆ™ä¼šæŠ¥é”™ï¼Œéœ€è¦æ‰‹åŠ¨åŠ è½½è¿™äº›ä¾èµ–æ¨¡å—ã€‚</p><h2 id="modprobe">modprobe</h2><p>modprobe åŠ è½½æ¨¡å—æ—¶ï¼Œä¸éœ€è¦æŒ‡å®šè·¯å¾„ï¼Œå®ƒä¼šåˆ°é»˜è®¤ç›®å½•ä¸‹ä¾‹å¦‚ï¼š <code>/lib/modules/$(uname -r)/</code> è¿›è¡ŒæŸ¥æ‰¾æ¨¡å—ã€‚å¯ä»¥è‡ªåŠ¨åŠ è½½æ‰€éœ€è¦çš„ä¾èµ–æ¨¡å—ã€‚</p><p>æ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯æ–°çš„è¯ï¼Œå¯èƒ½æ²¡æœ‰è¿™ä¸ªé»˜è®¤ç›®å½•ï¼Œæˆ‘ä»¬ä½¿ç”¨ modprobe åŠ è½½æ—¶ä¼šæç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/24_gt911 # modprobe gt911.ko</span><br><span class="line">modprobe: can&#x27;t change directory to &#x27;/lib/modules&#x27;: No such file or directory</span><br></pre></td></tr></table></figure><p>åˆ›å»ºç›®å½•å†æ¬¡è¿è¡Œæç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/24_gt911 # mkdir /lib/modules</span><br><span class="line">/24_gt911 # modprobe gt911.ko</span><br><span class="line">modprobe: can&#x27;t change directory to &#x27;4.9.88&#x27;: No such file or directory</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç›®å½•å¯¹åº”å†…æ ¸çš„ç‰ˆæœ¬ï¼Œå†æ¬¡åˆ›å»ºç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/24_gt911 # mkdir /lib/modules/4.9.88</span><br><span class="line">/24_gt911 # modprobe gt911.ko</span><br><span class="line">modprobe: can&#x27;t open &#x27;modules.dep&#x27;: No such file or directory</span><br></pre></td></tr></table></figure><p>æç¤ºæ‰¾ä¸åˆ° modules.dep æ–‡ä»¶ï¼Œè¿™æ—¶ä¸ç”¨æ‰‹åŠ¨åˆ›å»ºè¯¥æ–‡ä»¶ï¼Œä½¿ç”¨ depmod å‘½ä»¤å³å¯è‡ªåŠ¨ç”Ÿæˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/24_gt911 # depmod</span><br><span class="line">/24_gt911 # ls /lib/modules/4.9.88/</span><br><span class="line">modules.alias    modules.dep      modules.symbols</span><br></pre></td></tr></table></figure><p>å†æ¬¡åŠ è½½å‡ºç°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/24_gt911 # modprobe gt911.ko</span><br><span class="line">modprobe: module gt911.ko not found in modules.dep</span><br></pre></td></tr></table></figure><p>æç¤º modules.dep æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°éœ€è¦åŠ è½½çš„ ko æ–‡ä»¶ï¼ŒæŸ¥çœ‹ä¸‹ modules.dep çš„å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/24_gt911 # more modules.dep</span><br><span class="line">/24_gt911 # </span><br></pre></td></tr></table></figure><p>modules.dep å†…å®¹ä¸ºç©ºï¼Œéœ€è¦å°†è¦åŠ è½½çš„ ko æ–‡ä»¶å¤åˆ¶åˆ° <code>/lib/modules/$(uname -r)/</code> ä¸‹ï¼Œå†æ‰§è¡Œ depmod å‘½ä»¤ï¼Œdepmod æŒ‡ä»¤ä¼šè‡ªåŠ¨åˆ†æ <code>/lib/modules/$(uname -r)</code> ç›®å½•ä¸‹çš„å¯åŠ è½½æ¨¡å—ï¼Œå¹¶æŒ‰ç…§å›ºå®šçš„æ ¼å¼å¡«å…¥modules.dep ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/24_gt911 # cp gt911.ko /lib/modules/4.9.88/</span><br><span class="line">/24_gt911 # depmod</span><br><span class="line">/24_gt911 # more modules.dep</span><br><span class="line">gt911.ko </span><br></pre></td></tr></table></figure><p>modules.dep ä¸­å·²ç»æœ‰æˆ‘ä»¬éœ€è¦åŠ è½½çš„æ¨¡å—äº†ï¼Œæœ€åå†æ¬¡åŠ è½½æ¨¡å—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/24_gt911 # modprobe gt911.ko</span><br><span class="line">gt911 init</span><br><span class="line">gt911_probe</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://blog.csdn.net/qq_39101111/article/details/78773362">modprobeåŠ è½½é©±åŠ¨é—®é¢˜_modprobe: canâ€™t open â€˜modules.depâ€™: no such file o-CSDNåšå®¢</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;modprobe-åŠ è½½é©±åŠ¨é—®é¢˜&quot;&gt;modprobe åŠ è½½é©±åŠ¨é—®é¢˜&lt;/h1&gt;
&lt;p&gt;åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œé©±åŠ¨åŠ è½½æ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼š&lt;strong&gt;é™æ€åŠ è½½å’ŒåŠ¨æ€åŠ è½½&lt;/strong&gt;ã€‚é™æ€åŠ è½½å°±æ˜¯æŠŠé©±åŠ¨ç¨‹åºæ”¾è¿›å†…æ ¸ä¸€èµ·ç¼–è¯‘ï¼Œç³»ç»Ÿå¯åŠ¨åä¹‹é—´è¢«è°ƒç”¨ã€‚é™æ€åŠ è½½çš„ç¼ºç‚¹å°±æ˜¯è°ƒ</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Linux-è§¦æ‘¸å±é©±åŠ¨</title>
    <link href="http://www.obito.top/2024/07/07/Linux-%E8%A7%A6%E6%91%B8%E5%B1%8F%E9%A9%B1%E5%8A%A8/"/>
    <id>http://www.obito.top/2024/07/07/Linux-%E8%A7%A6%E6%91%B8%E5%B1%8F%E9%A9%B1%E5%8A%A8/</id>
    <published>2024-07-07T07:37:07.000Z</published>
    <updated>2024-08-23T06:11:32.716Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux-è§¦æ‘¸å±é©±åŠ¨">Linux-è§¦æ‘¸å±é©±åŠ¨</h1><h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2><h3 id="ç¡¬ä»¶ç¯å¢ƒ">ç¡¬ä»¶ç¯å¢ƒ</h3><ul><li><strong>å¼€å‘æ¿å‹å·</strong>ï¼š<a href="https://blog.csdn.net/thisway_diy/article/details/109841372">100ask_imx6ull_pro å¼€å‘æ¿</a></li><li><strong>å¤„ç†å™¨ç±»å‹</strong>ï¼šNXP IMX6ULL</li><li><strong>å¤„ç†å™¨æ¶æ„</strong>ï¼šæ©å•æ ¸ Cortex-A7</li><li><strong>å¤„ç†å™¨ä¸»é¢‘</strong>ï¼š800MHZ</li><li><strong>å†…å­˜å®¹é‡</strong>ï¼š512 MB DDR3</li><li><strong>å­˜å‚¨ä»‹è´¨</strong>ï¼š4GB eMMC</li><li><strong>æœ¬æ¬¡æµ‹è¯•çš„é©±åŠ¨</strong>ï¼šGT911 è§¦æ‘¸å±èŠ¯ç‰‡</li></ul><h3 id="è½¯ä»¶ç¯å¢ƒ">è½¯ä»¶ç¯å¢ƒ</h3><ul><li>å®¿ä¸»æœº<ul><li><strong>å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ</strong>ï¼šUbuntu 18.04</li><li><strong>äº¤å‰ç¼–è¯‘å™¨</strong>ï¼š100ask æä¾›çš„å·¥å…·é“¾ arm-buildroot-linux-gnueabihf- <strong>æ”¯æŒçš„æœ€ä½å†…æ ¸ç‰ˆæœ¬</strong>ï¼š4.9.0</li></ul></li><li>å¼€å‘æ¿<ul><li><strong>U-Boot</strong>ï¼šä¸€å¼€å§‹ç”¨çš„ NXP å®˜æ–¹æä¾›çš„ç‰ˆæœ¬ä½†ä¸èƒ½æ­£å¸¸å¯åŠ¨å†…æ ¸ï¼Œåæ”¹ä¸º 100ask æä¾›çš„ç‰ˆæœ¬</li><li><strong>å†…æ ¸ç‰ˆæœ¬</strong>ï¼š <a href="https://github.com/nxp-imx/linux-imx/tree/imx_4.9.88_2.0.0_ga">NXP æä¾›çš„ 4.9.88 ç‰ˆæœ¬</a></li><li><strong>æ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹</strong>ï¼š<a href="https://busybox.net/downloads/">BusyBox 1.29.0</a></li></ul></li></ul><h2 id="åºè¨€">åºè¨€</h2><p>ä¸€å¼€å§‹æ˜¯ç”µé˜»è§¦æ‘¸å±ï¼Œä½†æ˜¯åªèƒ½å•ç‚¹è§¦æ‘¸ï¼Œåé¢æ¨å‡ºäº†ç”µå®¹è§¦æ‘¸å±ï¼Œæ”¯æŒå¤šç‚¹è§¦æ‘¸ï¼Œåç»­çš„ç”µé˜»è§¦æ‘¸å±ä¹Ÿæ”¯æŒå¤šç‚¹è§¦æ‘¸äº†ï¼Œä½†æ˜¯ç”µé˜»å±éœ€è¦æ‰‹æŒ‡ç»™äºˆä¸€å®šçš„å‹åŠ›æ‰æœ‰ååº”ï¼Œè€Œç”µå®¹å±åªéœ€è¦æ‰‹æŒ‡è½»è§¦å³å¯ã€‚</p><p><strong>å·¥ä½œåŸç†</strong></p><p>ç”µå®¹è§¦æ‘¸ï¼šç”µå®¹å±ä¸­æœ‰ä¸€ä¸ªæ§åˆ¶èŠ¯ç‰‡ï¼Œå®ƒä¼šå‘¨æœŸæ€§äº§ç”Ÿé©±åŠ¨ä¿¡å·ï¼Œæ¥æ”¶ç”µææ¥æ”¶åˆ°ä¿¡å·ï¼Œå¹¶å¯æµ‹é‡ç”µè·å¤§å°ã€‚å½“ç”µå®¹å±è¢«æŒ‰ä¸‹æ—¶ï¼Œç”±äºäººä½“ç”µåœºï¼Œç”¨æˆ·å’Œè§¦æ‘¸å±è¡¨é¢å½¢æˆä»¥ä¸€ä¸ª<strong>è€¦åˆç”µå®¹</strong>ï¼Œå¯¹äºé«˜é¢‘ç”µæµæ¥è¯´ï¼Œç”µå®¹æ˜¯ç›´æ¥å¯¼ä½“ï¼Œäºæ˜¯<strong>æ‰‹æŒ‡ä»æ¥è§¦ç‚¹å¸èµ°ä¸€ä¸ªå¾ˆå°çš„ç”µæµ</strong>ï¼Œä»è€Œå½±å“äº†æ¥æ”¶ç”µææ¥æ”¶åˆ°çš„ç”µè·å¤§å°ã€‚ä¸»æ§èŠ¯ç‰‡æ ¹æ®ç”µè·å¤§å°å³å¯è®¡ç®—å‡ºè§¦ç‚¹ä½ç½®ã€‚</p><p>ç”µé˜»è§¦æ‘¸ï¼šä¸»è¦æ˜¯é€šè¿‡<strong>å‹åŠ›æ„Ÿåº”åŸç†</strong>æ¥å®ç°å¯¹å±å¹•å†…å®¹çš„æ“ä½œå’Œæ§åˆ¶çš„ã€‚è¿™ç§è§¦æ‘¸å±å±ä½“éƒ¨åˆ†æ˜¯ä¸€å—ä¸æ˜¾ç¤ºå™¨è¡¨é¢éå¸¸é…åˆçš„<strong>å¤šå±‚å¤åˆè–„è†œ</strong>ï¼Œè½»è§¦è¡¨å±‚å‹ä¸‹æ—¶ï¼Œæ¥è§¦åˆ°åº•å±‚ï¼Œæ§åˆ¶å™¨åŒæ—¶ä»å››ä¸ªè§’è¯»å‡ºç›¸ç§°çš„ç”µæµåŠè®¡ç®—æ‰‹æŒ‡ä½ç½®çš„è·ç¦»ã€‚</p><p>å¦å¤–æ³¨æ„åŒºåˆ†ä¸€ä¸‹ LCD å’Œè§¦æ‘¸å±ï¼Œ<strong>LCD æ˜¯è¾“å‡ºè®¾å¤‡ï¼Œè§¦æ‘¸å±æ˜¯è¾“å…¥è®¾å¤‡</strong>ï¼Œä¸€èˆ¬æ˜¯å°†è§¦æ‘¸å±åˆ¶ä½œæˆè·Ÿ LCD ä¸€æ ·çš„å°ºå¯¸ç„¶åè¦†ç›–åœ¨ LCD ä¸Šã€‚</p><p>Linux å†…æ ¸ä¸€èˆ¬éƒ½æœ‰è®¸å¤šè§¦æ‘¸å±èŠ¯ç‰‡çš„é©±åŠ¨ï¼Œä¸€èˆ¬åªéœ€è¦æ ¹æ®é©±åŠ¨ç¨‹åºä¿®æ”¹è®¾å¤‡æ ‘ï¼Œå¹¶åœ¨å†…æ ¸ä¸­ä½¿èƒ½å…¶é©±åŠ¨å°±å¯ä»¥ä½¿ç”¨ã€‚è¿™é‡Œä¸ºäº†å­¦ä¹ è§¦æ‘¸å±èŠ¯ç‰‡é©±åŠ¨ç¼–å†™è¿‡ç¨‹ï¼Œå°†å…¶ä»–è§¦æ‘¸å±èŠ¯ç‰‡çš„é©±åŠ¨éƒ½å¤±èƒ½ã€‚</p><p>ç§»æ¤ç¬¬ä¸‰æ–¹åº“ tslib åº“å¯¹è§¦æ‘¸å±å‚æ•°è¿›è¡Œæ ¡æ­£ï¼Œæœ€åå°†æµ‹è¯•å®Œæ¯•çš„é©±åŠ¨æ”¾è¿›å†…æ ¸å¹¶ç¼–è¯‘ï¼Œå°±ä¸ç”¨æ¯æ¬¡éƒ½æ‰‹åŠ¨åŠ è½½äº†ã€‚</p><h2 id="è§¦æ‘¸å±é©±åŠ¨è§£æ">è§¦æ‘¸å±é©±åŠ¨è§£æ</h2><h3 id="å¤šç‚¹è§¦æ‘¸åè®®">å¤šç‚¹è§¦æ‘¸åè®®</h3><p>è€ç‰ˆæœ¬çš„ Linux å†…æ ¸ä¸æ”¯æŒå¤šç‚¹è§¦æ‘¸ï¼ˆMulti-touchï¼Œç®€ç§° MTï¼‰ï¼ŒMT åè®®åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šType A å’Œ Type Bã€‚</p><ul><li>Type Aï¼šé€‚ç”¨äºè§¦æ‘¸ç‚¹ä¸èƒ½è¢«åŒºåˆ†æˆ–è€…è¿½è¸ªï¼Œæ­¤ç±»å‹çš„è®¾å¤‡ä¸ŠæŠ¥åŸå§‹æ•°æ®ã€‚</li><li>Type Bï¼šé€‚ç”¨äºæœ‰ç¡¬ä»¶è¿½è¸ªå¹¶èƒ½åŒºåˆ†è§¦æ‘¸ç‚¹çš„è§¦æ‘¸è®¾å¤‡ï¼Œæ­¤ç±»å‹è®¾å¤‡é€šè¿‡ slot æ›´æ–°æŸä¸€ä¸ªè§¦æ‘¸ç‚¹çš„ä¿¡æ¯ï¼Œä¸€èˆ¬çš„å¤šç‚¹ç”µå®¹è§¦æ‘¸å± IC éƒ½æœ‰æ­¤èƒ½åŠ›ã€‚</li></ul><p>è§¦æ‘¸ç‚¹çš„ä¿¡æ¯é€šè¿‡ä¸€ç³»åˆ—çš„ <strong>ABS_MT äº‹ä»¶</strong>(æœ‰çš„èµ„æ–™ä¹Ÿå«æ¶ˆæ¯)ä¸ŠæŠ¥ç»™ linux å†…æ ¸ï¼Œåªæœ‰ ABS_MT äº‹ä»¶æ˜¯ç”¨äºå¤šç‚¹è§¦æ‘¸çš„ï¼ŒABS_MT äº‹ä»¶å®šä¹‰åœ¨æ–‡ä»¶ <code>include/uapi/linux/input-event-codes.h</code> ä¸­ï¼Œç›¸å…³äº‹ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_SLOT0x2f<span class="comment">/* MT slot being modified */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOUCH_MAJOR0x30<span class="comment">/* Major axis of touching ellipse */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOUCH_MINOR0x31<span class="comment">/* Minor axis (omit if circular) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_WIDTH_MAJOR0x32<span class="comment">/* Major axis of approaching ellipse */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_WIDTH_MINOR0x33<span class="comment">/* Minor axis (omit if circular) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_ORIENTATION0x34<span class="comment">/* Ellipse orientation */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_POSITION_X0x35<span class="comment">/* Center X touch position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_POSITION_Y0x36<span class="comment">/* Center Y touch position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOOL_TYPE0x37<span class="comment">/* Type of touching device */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_BLOB_ID0x38<span class="comment">/* Group a set of packets as a blob */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TRACKING_ID0x39<span class="comment">/* Unique ID of initiated contact */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_PRESSURE0x3a<span class="comment">/* Pressure on contact area */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_DISTANCE0x3b<span class="comment">/* Contact hover distance */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOOL_X0x3c<span class="comment">/* Center X tool position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOOL_Y0x3d<span class="comment">/* Center Y tool position */</span></span></span><br></pre></td></tr></table></figure><p>ABS_MT äº‹ä»¶ä¸­å¸¸ç”¨ä»¥ä¸‹å‡ ä¸ªï¼š</p><ul><li><p>ABS_MT_SLOTï¼šä¸ŠæŠ¥è§¦æ‘¸ç‚¹ ID</p></li><li><p>ABS_MT_POSITION_Xï¼šè§¦æ‘¸ç‚¹çš„ x åæ ‡ä¿¡æ¯</p></li><li><p>ABS_MT_POSITION_Yï¼šè§¦æ‘¸ç‚¹çš„ y åæ ‡ä¿¡æ¯</p></li><li><p>BS_MT_TRACKING_IDï¼šåŒºåˆ†è§¦æ‘¸ç‚¹</p></li></ul><p>Type A ç±»å‹çš„è®¾å¤‡ä½¿ç”¨ <code>input_mt_sync()</code>å‡½æ•°æ¥<strong>éš”ç¦»ä¸åŒçš„è§¦æ‘¸ç‚¹æ•°æ®ä¿¡æ¯</strong>ï¼Œè¯¥å‡½æ•°ä¼šè§¦æ‘¸ <code>SYN_MT_REPORT</code> äº‹ä»¶ï¼Œé€šçŸ¥æ¥æ”¶è€…è·å–å½“å‰è§¦æ‘¸æ•°æ®ï¼Œå¹¶ä¸”å‡†å¤‡æ¥æ”¶ä¸‹ä¸€ä¸ªè§¦æ‘¸ç‚¹æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_mt_sync</span><span class="params">(<span class="keyword">struct</span> input_dev *dev)</span></span><br></pre></td></tr></table></figure><p>Type B ç±»å‹çš„è®¾å¤‡ä½¿ç”¨ <code>input_mt_slot</code> å‡½æ•°ä¸ŠæŠ¥è§¦æ‘¸ç‚¹ä¿¡æ¯æ—¶<strong>å¯ä»¥åŒºåˆ†å“ªä¸€ä¸ªè§¦æ‘¸ç‚¹</strong>ï¼Œä¼šè§¦å‘ <code>ABS_MT_SLOT</code> äº‹ä»¶ï¼Œå‘Šè¯‰æ¥æ”¶è€…å½“å‰æ­£åœ¨æ›´æ–°çš„æ—¶å“ªä¸ªè§¦æ‘¸ç‚¹çš„æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_mt_slot</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">int</span> slot)</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸º input_dev è®¾å¤‡ï¼Œç¬¬äºŒå‚æ•° slot <strong>ç”¨äºæŒ‡å®šå½“å‰ä¸ŠæŠ¥çš„æ˜¯å“ªä¸ªè§¦æ‘¸ç‚¹ä¿¡æ¯</strong>ã€‚</p><h4 id="è§¦æ‘¸ç‚¹ä¿¡æ¯ä¸ŠæŠ¥æ—¶åº">è§¦æ‘¸ç‚¹ä¿¡æ¯ä¸ŠæŠ¥æ—¶åº</h4><p>è§¦æ‘¸ç‚¹ä¿¡æ¯ä¸ŠæŠ¥æ—¶åºåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šType A å’Œ Type Bã€‚</p><ul><li>Type A è®¾å¤‡ï¼š<strong>å†…æ ¸é©±åŠ¨éœ€è¦ä¸€æ¬¡æ€§å°†è§¦æ‘¸å±ä¸Šçš„æ‰€æœ‰è§¦æ‘¸ç‚¹ä¿¡æ¯å…¨éƒ¨ä¸ŠæŠ¥</strong>ï¼Œæ¯ä¸ªè§¦æ‘¸ç‚¹çš„ä¿¡æ¯åœ¨æœ¬æ¬¡ä¸ŠæŠ¥äº‹ä»¶æµä¸­çš„é¡ºåºä¸é‡è¦ï¼Œå› ä¸ºäº‹ä»¶çš„è¿‡æ»¤å’Œè§¦æ‘¸ç‚¹è·Ÿè¸ªæ˜¯åœ¨å†…æ ¸ç©ºé—´å¤„ç†çš„ã€‚</li><li>Type B è®¾å¤‡ï¼šéœ€è¦<strong>ç»™æ¯ä¸ªè¯†åˆ«å‡ºæ¥çš„è§¦æ‘¸ç‚¹åˆ†é…ä¸€ä¸ª slot</strong>ï¼Œåé¢ä½¿ç”¨è¿™ä¸ª slot æ¥ä¸ŠæŠ¥è§¦æ‘¸ç‚¹ä¿¡æ¯ã€‚</li></ul><h5 id="type-a-è§¦æ‘¸ç‚¹ä¿¡æ¯ä¸ŠæŠ¥æ—¶åº">Type A è§¦æ‘¸ç‚¹ä¿¡æ¯ä¸ŠæŠ¥æ—¶åº</h5><p>Type A ç±»å‹çš„è®¾å¤‡ï¼Œå‘é€è§¦æ‘¸ç‚¹ä¿¡æ¯æ—¶åºå¦‚ä¸‹ï¼ˆä»¥ 2 ä¸ªè§¦æ‘¸ç‚¹ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ABS_MT_POSITION_X x[<span class="number">0</span>]</span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">0</span>]</span><br><span class="line">SYN_MT_REPORT</span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">1</span>]</span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">1</span>]</span><br><span class="line">SYN_MT_REPORT</span><br><span class="line">SYN_REPORT</span><br></pre></td></tr></table></figure><ul><li>ABS_MT_POSITION_X å’Œ ABS_MT_POSITION_Y äº‹ä»¶æ˜¯é€šè¿‡ <code>input_report_abs</code> å‡½æ•°å®ç°æ¥ä¸ŠæŠ¥è§¦æ‘¸ç‚¹çš„ x åæ ‡å’Œ y åæ ‡æ•°æ®ã€‚</li><li>SYN_MT_REPORT äº‹ä»¶æ˜¯é€šè¿‡ <code>input_mt_sync</code> å‡½æ•°å®ç°çš„ã€‚</li><li>SYN_REPORT äº‹ä»¶æ˜¯é€šè¿‡ <code>input_sync</code> å‡½æ•°å®ç°çš„ã€‚æ¯ä¸ŠæŠ¥å®Œä¸€è½®è§¦æ‘¸ç‚¹ä¿¡æ¯å°±è°ƒç”¨ä¸€æ¬¡ <code>input_sync</code> å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å‘é€ä¸€ä¸ª SYN_REPORT äº‹ä»¶</li></ul><h5 id="type-b-è§¦æ‘¸ç‚¹ä¿¡æ¯ä¸ŠæŠ¥æ—¶åº">Type B è§¦æ‘¸ç‚¹ä¿¡æ¯ä¸ŠæŠ¥æ—¶åº</h5><p>Type B ç±»å‹çš„è®¾å¤‡ï¼Œå‘é€è§¦æ‘¸ç‚¹ä¿¡æ¯æ—¶åºå¦‚ä¸‹ï¼ˆä»¥ 2 ä¸ªè§¦æ‘¸ç‚¹ä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ABS_MT_SLOT <span class="number">0</span></span><br><span class="line">ABS_MT_TRACKING_ID <span class="number">45</span></span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">0</span>]</span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">0</span>]</span><br><span class="line">ABS_MT_SLOT <span class="number">1</span></span><br><span class="line">ABS_MT_TRACKING_ID <span class="number">46</span></span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">1</span>]</span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">1</span>]</span><br><span class="line">SYN_REPORT</span><br></pre></td></tr></table></figure><ul><li>ABS_MT_POSITION_X å’Œ ABS_MT_POSITION_Y äº‹ä»¶æ˜¯é€šè¿‡ <code>input_report_abs</code> å‡½æ•°å®ç°æ¥ä¸ŠæŠ¥è§¦æ‘¸ç‚¹çš„ x åæ ‡å’Œ y åæ ‡æ•°æ®ã€‚</li><li>æ¯æ¬¡ä¸ŠæŠ¥ä¸€ä¸ªè§¦æ‘¸ç‚¹åæ ‡ä¹‹å‰è¦å…ˆä½¿ç”¨ <code>input_mt_slot</code> å‡½æ•°ä¸ŠæŠ¥å½“å‰è§¦æ‘¸ç‚¹ SLOTï¼Œè§¦æ‘¸ç‚¹çš„ SLOT å…¶å®å°±æ˜¯è§¦æ‘¸ç‚¹ IDï¼Œéœ€è¦ç”±è§¦æ‘¸ IC æä¾›ã€‚</li><li>æ¯ä¸ª SLOT å¿…é¡»å…³è”ä¸€ä¸ª ABS_MT_TRACKING_IDï¼Œé€šè¿‡ä¿®æ”¹ SLOT å…³è”çš„ ABS_MT_TRACKING_ID æ¥å®Œæˆå¯¹è§¦æ‘¸ç‚¹çš„æ·»åŠ ã€æ›¿æ¢æˆ–åˆ é™¤ã€‚å…·ä½“ç”¨åˆ°çš„å‡½æ•°å°±æ˜¯ <code>input_mt_report_slot_state</code>ï¼Œå¦‚æœæ˜¯æ·»åŠ ä¸€ä¸ªæ–°çš„è§¦æ‘¸ç‚¹ï¼Œé‚£ä¹ˆæ­¤å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•° <strong>active è¦è®¾ç½®ä¸º true</strong>ï¼Œlinux å†…æ ¸ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ª ABS_MT_TRACKING_ID å€¼ï¼Œä¸éœ€è¦ç”¨æˆ·å»æŒ‡å®šå…·ä½“çš„ ABS_MT_TRACKING_ID å€¼ã€‚</li><li>SYN_REPORT äº‹ä»¶æ˜¯é€šè¿‡ <code>input_sync</code> å‡½æ•°å®ç°çš„ã€‚å½“æ‰€æœ‰çš„è§¦æ‘¸ç‚¹åæ ‡éƒ½<strong>ä¸Šä¼ å®Œæ¯•å°±è°ƒç”¨ä¸€æ¬¡</strong> <code>input_sync</code> å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å‘é€ä¸€ä¸ª <strong>SYN_REPORT äº‹ä»¶</strong></li></ul><p>å½“ä¸€ä¸ªè§¦æ‘¸ç‚¹ç§»é™¤ä»¥åï¼ŒåŒæ ·éœ€è¦é€šè¿‡ SLOT å…³è”çš„ ABS_MT_TRACKING_ID äº‹ä»¶å‘é€ä¸€ä¸ª -1 ç»™å†…æ ¸ï¼Œè°ƒç”¨</p><p><code>input_mt_report_slot_state</code> å‡½æ•°å®Œæˆï¼Œåªéœ€å°†ç¬¬ä¸‰ä¸ªå‚æ•° <strong>active è®¾ç½®ä¸º false</strong> å³å¯ã€‚</p><p>æ—¶åºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ABS_MT_TRACKING_ID <span class="number">-1</span></span><br><span class="line">SYN_REPORT</span><br></pre></td></tr></table></figure><h4 id="å¤šç‚¹è§¦æ‘¸æ‰€ä½¿ç”¨åˆ°çš„-api-å‡½æ•°">å¤šç‚¹è§¦æ‘¸æ‰€ä½¿ç”¨åˆ°çš„ API å‡½æ•°</h4><p><code>input_mt_init_slots</code> å‡½æ•°ç”¨äºåˆå§‹åŒ– MT çš„è¾“å…¥ slotsï¼Œç¼–å†™ MT é©±åŠ¨çš„æ—¶å€™å¿…é¡»å…ˆè°ƒç”¨æ­¤å‡½æ•°åˆå§‹åŒ– slotsã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/input/input-mt.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">input_mt_init_slots</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> num_slots, <span class="type">unsigned</span> <span class="type">int</span> flags)</span></span><br></pre></td></tr></table></figure><ul><li>dev ï¼šMT è®¾å¤‡å¯¹åº”çš„ input_dev</li><li>num_slotsï¼šSLOT æ•°é‡ï¼Œå³è§¦æ‘¸ç‚¹çš„æ•°é‡</li><li>è¿”å›å€¼ï¼š0 æˆåŠŸï¼Œè´Ÿå€¼å¤±è´¥</li><li>flagsï¼šå¯è®¾ç½®çš„ flags å¦‚ä¸‹ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_POINTER0x0001<span class="comment">/* pointer device, e.g. trackpad */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_DIRECT0x0002<span class="comment">/* direct device, e.g. touchscreen */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_DROP_UNUSED0x0004<span class="comment">/* drop contacts not seen in frame */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_TRACK0x0008<span class="comment">/* use in-kernel tracking */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_SEMI_MT0x0010<span class="comment">/* semi-mt device, finger count handled manually */</span></span></span><br></pre></td></tr></table></figure><p><code>input_mt_slot</code> å‡½æ•°ç”¨äº Type B ç±»å‹ï¼Œç”¨äºäº§ç”Ÿ ABS_MT_SLOT äº‹ä»¶ï¼Œå‘Šè¯‰å†…æ ¸ä¸ŠæŠ¥çš„æ˜¯å“ªä¸ªè§¦æ‘¸ç‚¹çš„åæ ‡æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/input/mt.h</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">input_mt_slot</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">int</span> slot)</span></span><br><span class="line">&#123;</span><br><span class="line">input_event(dev, EV_ABS, ABS_MT_SLOT, slot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>dev ï¼šMT è®¾å¤‡å¯¹åº”çš„ input_dev</li><li>slotï¼šå½“å‰å‘é€çš„å“ªä¸ª slot çš„åæ ‡ä¿¡æ¯</li></ul><p><code>input_mt_report_slot_state</code> å‡½æ•°æ­¤å‡½æ•°ç”¨äº Type B ç±»å‹ï¼Œç”¨äºäº§ç”Ÿ ABS_MT_TRACKING_ID å’ŒABS_MT_TOOL_TYPE äº‹ä»¶ï¼ŒABS_MT_TRACKING_ID å’Œ ABS_MT_TOOL_TYPE äº‹ä»¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/input/input-mt.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_mt_report_slot_state</span><span class="params">(<span class="keyword">struct</span> input_dev *dev,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">int</span> tool_type, <span class="type">bool</span> active)</span>;</span><br></pre></td></tr></table></figure><ul><li>dev ï¼šMT è®¾å¤‡å¯¹åº”çš„ input_dev</li><li>tool_typeï¼šè§¦æ‘¸ç±»å‹ï¼ŒMT_TOOL_FINGER(æ‰‹æŒ‡) ã€MT_TOOL_PEN(ç¬”)æˆ– MT_TOOL_PALM(æ‰‹æŒ)</li><li>activeï¼štrue ä¸ºè¿ç»­è§¦æ‘¸ï¼Œinput å­ç³»ç»Ÿå†…æ ¸ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ª ABS_MT_TRACKING_ID ç»™ slotã€‚falseï¼Œè§¦æ‘¸ç‚¹æŠ¬èµ·ï¼Œè¡¨ç¤ºæŸä¸ªè§¦æ‘¸ç‚¹æ— æ•ˆäº†ï¼Œinput å­ç³»ç»Ÿå†…æ ¸ä¼šåˆ†é…ä¸€ä¸ª -1 ç»™ slotï¼Œè¡¨ç¤ºè§¦æ‘¸ç‚¹æº¢å‡ºã€‚</li></ul><p><code>input_report_abs</code> å‡½æ•°ã€‚Type A å’Œ Type B ç±»å‹éƒ½ä½¿ç”¨æ­¤å‡½æ•°ä¸ŠæŠ¥è§¦æ‘¸ç‚¹åæ ‡ä¿¡æ¯ï¼Œé€šè¿‡ABS_MT_POSITION_X å’Œ ABS_MT_POSITION_Y äº‹ä»¶å®ç° X å’Œ Y è½´åæ ‡ä¿¡æ¯ä¸ŠæŠ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/input.h</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">input_report_abs</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br></pre></td></tr></table></figure><ul><li>dev ï¼šMT è®¾å¤‡å¯¹åº”çš„ input_devã€‚</li><li>codeï¼šè¦ä¸ŠæŠ¥ä»€ä¹ˆæ•°æ®ï¼Œå¯è®¾ç½®ä¸º ABS_MT_POSITION_Xï¼ˆ x åæ ‡ï¼‰ å’Œ ABS_MT_POSITION_Yï¼ˆ y åæ ‡ï¼‰ã€‚</li><li>valueï¼šåæ ‡çš„å€¼ã€‚</li></ul><p>å¦‚æœè¿½è¸ªåˆ°çš„è§¦æ‘¸ç‚¹æ•°é‡å¤šäºå½“å‰ä¸ŠæŠ¥çš„æ•°é‡ï¼Œé©±åŠ¨ç¨‹åºä½¿ç”¨ BTN_TOOL_TAP äº‹ä»¶æ¥é€šçŸ¥ç”¨æˆ·ç©ºé—´å½“å‰è¿½è¸ªåˆ°çš„è§¦æ‘¸ç‚¹æ€»æ•°é‡ï¼Œç„¶åè°ƒç”¨ input_mt_report_pointer_emulation å‡½æ•°å°† use_count å‚æ•°è®¾ç½®ä¸º falseã€‚å¦åˆ™çš„è¯å°† use_count å‚æ•°è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºå½“å‰çš„è§¦æ‘¸ç‚¹æ•°é‡(æ­¤å‡½æ•°ä¼šè·å–åˆ°å…·ä½“çš„è§¦æ‘¸ç‚¹æ•°é‡ï¼Œä¸éœ€è¦ç”¨æˆ·ç»™å‡º)ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/input/input-mt.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_mt_report_pointer_emulation</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">bool</span> use_count)</span></span><br></pre></td></tr></table></figure><ul><li>dev ï¼šMT è®¾å¤‡å¯¹åº”çš„ input_devã€‚</li><li>use_countï¼štrueï¼Œæœ‰æ•ˆçš„è§¦æ‘¸ç‚¹æ•°é‡ï¼›flaseï¼Œè¿½è¸ªåˆ°çš„è§¦æ‘¸ç‚¹æ•°é‡å¤šäºå½“å‰ä¸ŠæŠ¥çš„æ•°é‡</li></ul><h2 id="è§¦æ‘¸å±é©±åŠ¨ç¼–å†™">è§¦æ‘¸å±é©±åŠ¨ç¼–å†™</h2><h3 id="å¤šç‚¹ç”µå®¹è§¦æ‘¸é©±åŠ¨æ¡†æ¶">å¤šç‚¹ç”µå®¹è§¦æ‘¸é©±åŠ¨æ¡†æ¶</h3><p>æ ¹æ®èŠ¯ç‰‡æ¥å£å’Œå¤šç‚¹ç”µå®¹è§¦æ‘¸åè®®å¯çŸ¥ä¼šç”¨åˆ°ä»¥ä¸‹é©±åŠ¨æ¡†æ¶ï¼š</p><ul><li>è§¦æ‘¸èŠ¯ç‰‡çš„æ¥å£ï¼Œä¸€èˆ¬ä¸º I2C æ¥å£ï¼ŒI2C é©±åŠ¨æ¡†æ¶</li><li>linux ä¸€èˆ¬é€šè¿‡ä¸­æ–­ä¸ŠæŠ¥è§¦æ‘¸ç‚¹ä¿¡æ¯ï¼Œä¸­æ–­æ¡†æ¶</li><li>å¤šç‚¹ç”µå®¹è§¦æ‘¸å±äº input å­ç³»ç»Ÿï¼Œinput å­ç³»ç»Ÿæ¡†æ¶</li></ul><p>å¤§è‡´æµç¨‹å°±æ˜¯ä½¿ç”¨ I2C é©±åŠ¨æ¡†æ¶æ³¨å†Œ i2c_driverï¼Œä¸è®¾å¤‡æ ‘ä¸­èŠ‚ç‚¹è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸåˆ™å¯¹èŠ¯ç‰‡è¿›è¡Œåˆå§‹åŒ–ã€åˆå§‹åŒ–ä¸­æ–­ã€æ³¨å†Œ input è®¾å¤‡ï¼Œå½“æ‰‹è§¦æ‘¸å±å¹•æ—¶åˆ™äº§ç”Ÿä¸­æ–­ï¼Œè¿›å…¥ä¸­æ–­çº¿ç¨‹å‡½æ•°è¯»å–è§¦æ‘¸ç‚¹æ•°æ®å¹¶é€šè¿‡ input å­ç³»ç»Ÿä¸ŠæŠ¥ã€‚</p><h3 id="è§¦æ‘¸å±èŠ¯ç‰‡-gt911">è§¦æ‘¸å±èŠ¯ç‰‡ GT911</h3><p>100ask å¼€å‘æ¿ç”¨åˆ°çš„è§¦æ‘¸å±èŠ¯ç‰‡æ˜¯ GT911ï¼Œæ”¯æŒåŒæ—¶è¯†åˆ« 5 ä¸ªè§¦æ‘¸ç‚¹ä½çš„å®æ—¶å‡†ç¡®ä½ç½®ï¼Œç§»åŠ¨è½¨è¿¹åŠè§¦æ‘¸é¢ç§¯ã€‚</p><ul><li>I2C ä»è®¾å¤‡åœ°å€ä¸º 0x5D æˆ– 0x14</li><li>å¯„å­˜å™¨ 16 ä½ï¼Œå¯„å­˜å™¨ä½å®½ 8 ä½</li><li>é€€å‡ºä¸­æ–­æ—¶éœ€è¦å¯¹ 0x814E å¯„å­˜å™¨æ¸…é›¶ï¼Œå¦åˆ™ä¼šä¸€ç›´è§¦å‘ä¸­æ–­</li><li>å½“æœ‰è§¦æ‘¸æ—¶ï¼ŒGT911 æ¯ä¸ªæ‰«æå‘¨æœŸå‡ä¼šé€šè¿‡ INT è„šå‘å‡ºè„‰å†²ä¿¡å·ï¼Œé€šçŸ¥ä¸»è®¾å¤‡è¯»å–åæ ‡ä¿¡æ¯</li><li>ä¸­æ–­è§¦å‘æ–¹å¼ï¼šè®¾ç½®å¯„å­˜å™¨ 0x804Dï¼Œ0 ä¸ºä¸Šå‡æ²¿è§¦å‘ï¼Œ1 ä¸ºä¸‹é™æ²¿è§¦å‘ã€‚</li></ul><p>GT911 æ¥å£å¦‚ä¸‹ï¼š</p><p><img src="image-20240707222537840.png" alt="image-20240707222537840"></p><p>gt911 èŠ¯ç‰‡ä¸Šç”µæ—¶åºå›¾ï¼š0xBA/0xBB æ˜¯åŠ ä¸Šå†™æ•°æ®ä½æˆ–è¯»æ•°æ®ä½å‡‘æˆçš„ 8 ä½åœ°å€ã€‚</p><p><img src="image-20240708205427060.png" alt="image-20240708205427060"></p><p>ç‰¹åˆ«é‡è¦çš„å¯„å­˜å™¨ï¼š</p><p><img src="image-20240709201125981.png" alt="image-20240709201125981"></p><p>Bit7ï¼šbuffer statusï¼Œ1 è¡¨ç¤ºåæ ‡å·²ç»å‡†å¤‡å¥½ï¼Œä¸»æ§å¯ä»¥è¯»å–ï¼Œ0 è¡¨ç¤ºæœªå°±ç»ªï¼Œæ•°æ®æ— æ•ˆï¼Œå½“ä¸»æ§è¯»å–å®Œåæ ‡åï¼Œå¿…é¡»å°†æ­¤æ ‡å¿—ä½æˆ–æ•´ä¸ªå¯„å­˜å™¨å†™ä¸º 0ï¼Œå¦åˆ™ä¼šä¸€ç›´è§¦å‘ä¸­æ–­ã€‚</p><p>Bit3~0ï¼šä½ 4 ä½ï¼Œnumber of touch pointsï¼Œè¡¨ç¤ºæœ‰å‡ ä¸ªè§¦æ‘¸ç‚¹æ•°æ®ã€‚</p><blockquote><p><a href="https://blog.csdn.net/weixin_51226647/article/details/132299679">è§£å†³é—®é¢˜ï¼šGT911è§¦æ§èŠ¯ç‰‡ï¼Œä¸­æ–­å¼•è„šåˆå§‹åŒ–åï¼Œè‡ªåŠ¨é‡å¤çš„è¿›å…¥ä¸­æ–­_gt911ä¸€ç›´ä¸­æ–­-CSDNåšå®¢</a></p></blockquote><h3 id="ä¿®æ”¹è®¾å¤‡æ ‘">ä¿®æ”¹è®¾å¤‡æ ‘</h3><p>ç”±åŸç†å›¾å¯çŸ¥ï¼ŒGT911 èŠ¯ç‰‡ç”¨åˆ°äº† 4 ä¸ª IO å£ï¼šSDAã€SCLã€å¤ä½ IOã€ä¸­æ–­ IOã€‚</p><p>iomuxc_snvs èŠ‚ç‚¹ä¸­æ·»åŠ å¤ä½ IO</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* tsc reset pin*/</span><br><span class="line">pinctrl_tsc_reset: tscresetgrp &#123;</span><br><span class="line">fsl,pins = &lt;</span><br><span class="line">              MX6ULL_PAD_SNVS_TAMPER2__GPIO5_IO020x000110A0</span><br><span class="line">                      &gt;;</span><br></pre></td></tr></table></figure><p>iomuxc èŠ‚ç‚¹ä¸­æ·»åŠ ä¸­æ–­ IO</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/* gt911 INT io*/</span><br><span class="line">pinctrl_tsc_int: tscintgrp &#123;</span><br><span class="line">fsl,pins = &lt;</span><br><span class="line">MX6UL_PAD_GPIO1_IO05__GPIO1_IO05 0x000010B0</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>iomuxc èŠ‚ç‚¹ä¸­æ·»åŠ  I2C2 çš„ SDA å’Œ SCLï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_i2c2: i2c2grp &#123;</span><br><span class="line">fsl,pins = &lt;</span><br><span class="line">MX6UL_PAD_UART5_TX_DATA__I2C2_SCL 0x4001b8b0</span><br><span class="line">MX6UL_PAD_UART5_RX_DATA__I2C2_SDA 0x4001b8b0</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ i2c2 èŠ‚ç‚¹ä¸‹æ·»åŠ  GT911 å­èŠ‚ç‚¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c2 &#123;</span><br><span class="line">clock_frequency = &lt;100000&gt;;</span><br><span class="line">pinctrl-names = &quot;default&quot;;</span><br><span class="line">pinctrl-0 = &lt;&amp;pinctrl_i2c2&gt;;</span><br><span class="line">status = &quot;okay&quot;;</span><br><span class="line"></span><br><span class="line">codec: wm8960@1a &#123;</span><br><span class="line">compatible = &quot;wlf,wm8960&quot;;</span><br><span class="line">reg = &lt;0x1a&gt;;</span><br><span class="line">clocks = &lt;&amp;clks IMX6UL_CLK_SAI2&gt;;</span><br><span class="line">clock-names = &quot;mclk&quot;;</span><br><span class="line">wlf,shared-lrclk;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/* gt911 */</span><br><span class="line">gt911@5d &#123;</span><br><span class="line">compatible = &quot;goodix,gt911&quot;;</span><br><span class="line">reg = &lt;0x5d&gt;;</span><br><span class="line">status = &quot;okay&quot;;</span><br><span class="line">interrupt-parent = &lt;&amp;gpio1&gt;;</span><br><span class="line">interrupts = &lt;5 IRQ_TYPE_EDGE_FALLING&gt;;</span><br><span class="line">pinctrl-names = &quot;default&quot;;</span><br><span class="line">pinctrl-0 = &lt;&amp;pinctrl_tsc_reset </span><br><span class="line"> &amp;pinctrl_tsc_int&gt;;</span><br><span class="line"></span><br><span class="line">reset-gpios = &lt;&amp;gpio5 2 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">irq-gpios = &lt;&amp;gpio1 5 IRQ_TYPE_EDGE_FALLING&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ç¼–å†™å¤šç‚¹ç”µå®¹è§¦æ‘¸é©±åŠ¨">ç¼–å†™å¤šç‚¹ç”µå®¹è§¦æ‘¸é©±åŠ¨</h3><p>å¤´æ–‡ä»¶å’Œ <code>gt911_info</code> ç»“æ„ä½“å­˜æ”¾ gt911 èŠ¯ç‰‡çš„é…ç½®ä¿¡æ¯ï¼Œ<code>gt911_dev</code> ç»“æ„ä½“ç”¨äºå­˜æ”¾ä¸€äº›é‡è¦å˜é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input/mt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gt911_info</span> &#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> pid;</span><br><span class="line">    <span class="type">uint16_t</span> max_x, max_y;</span><br><span class="line">    <span class="type">uint16_t</span> version;</span><br><span class="line">    <span class="type">uint8_t</span> vendor_id;  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gt911_dev</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span>             <span class="comment">/* è®¾å¤‡èŠ‚ç‚¹ */</span>   </span><br><span class="line">    <span class="type">int</span> int_pin;                        <span class="comment">/* ä¸­æ–­IO*/</span></span><br><span class="line">    <span class="type">int</span> reset_pin;                      <span class="comment">/* å¤ä½IO*/</span></span><br><span class="line">    <span class="type">int</span> irq_num;                        <span class="comment">/* ä¸­æ–­å· */</span></span><br><span class="line">    <span class="type">void</span> *private_data;                 <span class="comment">/* ç§æœ‰æ•°æ® */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gt911_info</span> <span class="title">info</span>;</span>             <span class="comment">/* gt911çš„ä¿¡æ¯ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">input_dev</span>;</span>        <span class="comment">/* inputç»“æ„ä½“ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span>;</span>          <span class="comment">/* I2Cå®¢æˆ·ç«¯ */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GT911_CTRL_REG         0X8040  <span class="comment">/* GT911æ§åˆ¶å¯„å­˜å™¨         */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GT911_PID_REG     0X8140  <span class="comment">/* GT911äº§å“IDå¯„å­˜å™¨       */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GT911_CONFIG_DATA_REG   0x8147  <span class="comment">/* GT911é…ç½®æ–‡ä»¶ç‰ˆæœ¬å·  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GT911_COOR_REG     0X814E  <span class="comment">/* GT911å½“å‰æ£€æµ‹åˆ°çš„è§¦æ‘¸æƒ…å†µ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GT911_TP1_REG     0X814F  <span class="comment">/* ç¬¬ä¸€ä¸ªè§¦æ‘¸ç‚¹æ•°æ®åœ°å€ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SUPPORT_POINTS      5       <span class="comment">/* æœ€å¤š5ç‚¹ç”µå®¹è§¦æ‘¸ */</span></span></span><br></pre></td></tr></table></figure><p>i2c é©±åŠ¨æ¡†æ¶ï¼Œæ³¨å†Œ <code>i2c_driver</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿé©±åŠ¨åŒ¹é…è¡¨</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">gt911_id_table</span>[] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;goodix,gt911&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡æ ‘åŒ¹é…è¡¨</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">gt911_of_match_table</span>[] =</span> &#123;</span><br><span class="line">    &#123;.compatible = <span class="string">&quot;goodix,gt911&quot;</span>&#125;,</span><br><span class="line">    &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">gt911_i2c_driver</span> =</span> &#123;</span><br><span class="line">    .driver = &#123;</span><br><span class="line">        .name = <span class="string">&quot;gt911&quot;</span>,</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .of_match_table = gt911_of_match_table,</span><br><span class="line">    &#125;,</span><br><span class="line">    .id_table = gt911_id_table,</span><br><span class="line">    .probe = gt911_probe,</span><br><span class="line">    .remove = gt911_remove,        </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// é©±åŠ¨å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">gt911_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    printk(<span class="string">&quot;gt911 init\n&quot;</span>);</span><br><span class="line">    ret = i2c_add_driver(&amp;gt911_i2c_driver);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é©±åŠ¨å‡ºå£å‡½æ•°</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">gt911_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    i2c_del_driver(&amp;gt911_i2c_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(gt911_init);</span><br><span class="line">module_exit(gt911_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><p>probe å’Œ remove å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒ¹é…æˆåŠŸ</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_probe</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gt911_dev</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…å†…å­˜ï¼Œè‡ªåŠ¨é‡Šæ”¾ æ³¨æ„sizeofé‡Œé¢æ˜¯(*ts)ï¼šè¡¨ç¤ºè®¡ç®—çš„æ˜¯ç»“æ„ä½“çš„å¤§å°ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆå¤§å°</span></span><br><span class="line">    dev = devm_kzalloc(&amp;client-&gt;dev, <span class="keyword">sizeof</span>(*dev), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span>(!dev)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    </span><br><span class="line">    dev-&gt;client = client;</span><br><span class="line">    i2c_set_clientdata(client, dev); <span class="comment">// å°†devç»“æ„ä½“å®ä¾‹è·Ÿi2cè®¾å¤‡clientç»‘å®šèµ·æ¥ï¼Œä¾¿äºåç»­ä½¿ç”¨dev</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ä¸­æ–­IOå’Œå¤ä½IOç¼–å·</span></span><br><span class="line">    ret = gt911_get_gpio(dev);</span><br><span class="line">    <span class="keyword">if</span>(ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤ä½gt911</span></span><br><span class="line">    ret = gt911_reset(dev);</span><br><span class="line">    <span class="keyword">if</span>(ret)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed reset\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// æµ‹è¯•i2cé€šä¿¡</span></span><br><span class="line">    ret = gt911_i2c_test(dev-&gt;client);</span><br><span class="line">    <span class="keyword">if</span>(ret)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;I2C communication failure\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–gt911é…ç½®ä¿¡æ¯</span></span><br><span class="line">    ret = gt911_read_config(dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”³è¯·inputè®¾å¤‡</span></span><br><span class="line">    gt911_request_input_dev(dev);</span><br><span class="line">    <span class="keyword">if</span>(ret)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to request input dev\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ä¸­æ–­</span></span><br><span class="line">    ret = gt911_request_irq(dev);   <span class="comment">// è¿™é‡Œä½¿ç”¨ä¸­æ–­çº¿ç¨‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span>(ret)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to request IRQ\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    printk(<span class="string">&quot;gt911_probe end\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»é™¤</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_remove</span><span class="params">(<span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gt911_dev</span> *<span class="title">dev</span> =</span> i2c_get_clientdata(client);</span><br><span class="line">    input_unregister_device(dev-&gt;input_dev);</span><br><span class="line">    printk(<span class="string">&quot;gt911_remove\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gt911_get_gpio</code> å‡½æ•°è·å–è®¾å¤‡æ ‘ä¸­çš„ io ä¿¡æ¯ï¼ŒæŸ¥æ‰¾ i2c2 æ€»çº¿ä¸‹çš„ gt911@5d å­èŠ‚ç‚¹çš„ irq-gpios å’Œ reset-gpios å±æ€§ï¼Œä¸ºå…¶åˆ†é… gpio ç¼–å·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–gt911çš„IOä¿¡æ¯</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_get_gpio</span><span class="params">(<span class="keyword">struct</span> gt911_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    dev-&gt;int_pin = of_get_named_gpio(dev-&gt;client-&gt;dev.of_node, <span class="string">&quot;irq-gpios&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(dev-&gt;int_pin &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to get irq-gpios gpio\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> dev-&gt;int_pin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev-&gt;reset_pin = of_get_named_gpio(dev-&gt;client-&gt;dev.of_node, <span class="string">&quot;reset-gpios&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(dev-&gt;reset_pin &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to get reset-gpios gpio\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> dev-&gt;reset_pin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gt911_reset</code> å‡½æ•°è®¾ç½®å¤ä½ IO å’Œä¸­æ–­ IO ä¸º GPIOï¼Œå¹¶ä¸”æ ¹æ®æ•°æ®æ‰‹å†Œç»™å‡ºçš„èŠ¯ç‰‡ä¸Šç”µæ—¶åºï¼Œå¯¹ gt911 èŠ¯ç‰‡å¤ä½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤ä½gt911</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_reset</span><span class="params">(<span class="keyword">struct</span> gt911_dev *dev)</span></span><br><span class="line">&#123;   </span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="keyword">if</span>(gpio_is_valid(dev-&gt;reset_pin))</span><br><span class="line">    &#123;</span><br><span class="line">        ret = devm_gpio_request_one(&amp;dev-&gt;client-&gt;dev, dev-&gt;reset_pin, GPIOF_OUT_INIT_HIGH, <span class="string">&quot;gp911-reset&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(gpio_is_valid(dev-&gt;int_pin))</span><br><span class="line">    &#123;</span><br><span class="line">        ret = devm_gpio_request_one(&amp;dev-&gt;client-&gt;dev, dev-&gt;int_pin, GPIOF_OUT_INIT_HIGH, <span class="string">&quot;gp911-int&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// gt911ä¸Šç”µæ—¶åº</span></span><br><span class="line">    gpio_set_value(dev-&gt;reset_pin, <span class="number">0</span>);  </span><br><span class="line">    msleep(<span class="number">20</span>);         <span class="comment">/* 20ms T2: &gt; 10ms */</span></span><br><span class="line"></span><br><span class="line">    gpio_set_value(dev-&gt;int_pin, <span class="number">0</span>);</span><br><span class="line">    usleep_range(<span class="number">100</span>, <span class="number">2000</span>);        <span class="comment">/* 100us~2ms T3: &gt; 100us */</span></span><br><span class="line"></span><br><span class="line">    gpio_set_value(dev-&gt;reset_pin, <span class="number">1</span>);</span><br><span class="line">    usleep_range(<span class="number">6000</span>, <span class="number">10000</span>);      <span class="comment">/* 6ms~10ms T4: &gt; 5ms */</span></span><br><span class="line"></span><br><span class="line">    gpio_direction_input(dev-&gt;int_pin);     <span class="comment">// INTå¼•è„šè®¾ç½®ä¸ºè¾“å…¥</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gt911_read_reg</code> å’Œ <code>gt911_write_reg</code> å‡½æ•°æ˜¯è¯»å–å’Œå†™å…¥ gt911 èŠ¯ç‰‡æ•°æ®çš„å‡½æ•°ï¼Œè·Ÿä¹‹å‰èŠ¯ç‰‡ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªèŠ¯ç‰‡çš„å¯„å­˜å™¨åœ°å€æ˜¯ 16 ä½ï¼Œä¿®æ”¹ä¸€ä¸‹å³å¯ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : è¯»å– gt911 è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : gt911 è®¾å¤‡</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€ 16ä½</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¯»å–åˆ°çš„æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦è¯»å–çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_read_reg</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="type">uint16_t</span> reg, <span class="type">uint8_t</span> *buf, <span class="type">uint16_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line">    <span class="type">uint8_t</span> reg_16bit[<span class="number">2</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[2];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* GT911å¯„å­˜å™¨åœ°å€ä½ 16ä½ */</span></span><br><span class="line">    reg_16bit[<span class="number">0</span>] = reg &gt;&gt; <span class="number">8</span>;  <span class="comment">// é«˜8å­—èŠ‚</span></span><br><span class="line">    reg_16bit[<span class="number">1</span>] = reg &amp; <span class="number">0xFF</span>; <span class="comment">// ä½8å­—èŠ‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* msg[0]ï¼Œç¬¬ä¸€æ¡å†™æ¶ˆæ¯ï¼Œå‘é€è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€*/</span></span><br><span class="line">msg[<span class="number">0</span>].addr = client-&gt;addr;<span class="comment">// è®¾å¤‡åœ°å€</span></span><br><span class="line">msg[<span class="number">0</span>].flags = <span class="number">0</span>;<span class="comment">// å†™æ•°æ®</span></span><br><span class="line">msg[<span class="number">0</span>].buf = reg_16bit;<span class="comment">// å¯„å­˜å™¨åœ°å€</span></span><br><span class="line">msg[<span class="number">0</span>].len = <span class="number">2</span>;<span class="comment">// msgé•¿åº¦ï¼šå¯„å­˜å™¨åœ°å€é•¿åº¦ 2ä¸ªå­—èŠ‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* msg[1]ï¼Œç¬¬äºŒæ¡è¯»æ¶ˆæ¯ï¼Œè¯»å–å¯„å­˜å™¨æ•°æ®*/</span></span><br><span class="line">msg[<span class="number">1</span>].addr = client-&gt;addr;<span class="comment">// è®¾å¤‡åœ°å€</span></span><br><span class="line">msg[<span class="number">1</span>].flags = I2C_M_RD;<span class="comment">// è¯»æ•°æ®</span></span><br><span class="line">msg[<span class="number">1</span>].buf= buf;<span class="comment">// è¯»å–çš„æ•°æ®</span></span><br><span class="line">msg[<span class="number">1</span>].len = len;<span class="comment">// msgé•¿åº¦ï¼šè¯»å–æ•°æ®çš„é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">ret =  i2c_transfer(client-&gt;adapter, msg, <span class="number">2</span>);<span class="comment">// 2ä¸ªmsg</span></span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">2</span>)</span><br><span class="line">ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = -EREMOTEIO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : å‘ gt911 è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : è¦å†™å…¥çš„è®¾å¤‡ç»“æ„ä½“</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦å†™å…¥çš„å¯„å­˜å™¨é¦–åœ°å€ 16ä½</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¦å†™å…¥çš„æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦å†™å…¥çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_write_reg</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="type">uint16_t</span> reg, <span class="type">uint8_t</span> *buf, <span class="type">uint16_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> tmp[<span class="number">256</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>;</span><span class="comment">// å­˜æ”¾å¾…å†™å…¥çš„å¯„å­˜å™¨åœ°å€å’Œæ•°æ®ç­‰ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">    tmp[<span class="number">0</span>] = reg &gt;&gt; <span class="number">8</span>;               <span class="comment">// å¯„å­˜å™¨é¦–åœ°å€é«˜8ä½</span></span><br><span class="line">    tmp[<span class="number">1</span>] = reg &amp; <span class="number">0xFF</span>;             <span class="comment">// å¯„å­˜å™¨é¦–åœ°å€ä½8ä½</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;tmp[<span class="number">2</span>], buf, len);       <span class="comment">// å†™å…¥çš„æ•°æ®</span></span><br><span class="line"></span><br><span class="line">msg.addr = client-&gt;addr;<span class="comment">// è®¾å¤‡åœ°å€</span></span><br><span class="line">msg.flags = <span class="number">0</span>;<span class="comment">// å†™æ•°æ®</span></span><br><span class="line">msg.buf = tmp;<span class="comment">// å‘é€çš„æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line">msg.len = len + <span class="number">2</span>;<span class="comment">// msgé•¿åº¦ï¼šå†™å…¥çš„æ•°æ®é•¿åº¦ + å¯„å­˜å™¨åœ°å€é•¿åº¦2ä¸ªå­—èŠ‚ ï¼ˆå•ä½ï¼šå­—èŠ‚)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> i2c_transfer(client-&gt;adapter, &amp;msg, <span class="number">1</span>);<span class="comment">// 1ä¸ªmsg</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gt911_i2c_test</code> å‡½æ•°æ˜¯æµ‹è¯•èƒ½å¦ä¸ gt911 èŠ¯ç‰‡æ­£å¸¸çš„é€šä¿¡ï¼Œä¹Ÿå¯ä»¥ä¸è¦å…¶å®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æµ‹è¯•i2cé€šä¿¡</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_i2c_test</span><span class="params">(<span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> buf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–GT911_CONFIG_DATA_REGæµ‹è¯•i2cæ˜¯å¦æ­£å¸¸</span></span><br><span class="line">    <span class="keyword">while</span>(count++ &gt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = gt911_read_reg(client, GT911_CONFIG_DATA_REG, &amp;buf, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(!ret)    <span class="comment">// æˆåŠŸè¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        printk(<span class="string">&quot;gt911 i2c test attempt %d: %d\n&quot;</span>, count, ret);</span><br><span class="line">        msleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gt911_read_config</code> å‡½æ•°æ˜¯ç”¨æ¥è¯»å– gt911 èŠ¯ç‰‡ç›¸å¯¹åº”å¯„å­˜å™¨åœ°å€ï¼Œæ¥è·å– Product IDã€Firmware versionã€vendor_id ä»¥åŠè§¦æ‘¸çš„æœ€å¤§ x åæ ‡å’Œ y åæ ‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–gt911ä¿¡æ¯</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_read_config</span><span class="params">(<span class="keyword">struct</span> gt911_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">uint8_t</span> buf[<span class="number">11</span>];</span><br><span class="line">    <span class="type">uint8_t</span> pid[<span class="number">4</span>];</span><br><span class="line">    <span class="type">long</span> id;</span><br><span class="line"></span><br><span class="line">    ret = gt911_read_reg(dev-&gt;client, GT911_PID_REG, buf, <span class="number">11</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Product ID</span></span><br><span class="line">    <span class="built_in">memcpy</span>(pid, buf, <span class="number">4</span>);</span><br><span class="line">    ret = kstrtol(pid, <span class="number">10</span>, &amp;id);</span><br><span class="line">    <span class="keyword">if</span>(ret)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    dev-&gt;info.pid = (<span class="type">uint16_t</span>)id;</span><br><span class="line">    printk(<span class="string">&quot;Product ID:%d\n&quot;</span>, dev-&gt;info.pid);</span><br><span class="line">    <span class="comment">//printk(&quot;Product ID: %c%c%c%c\n&quot;, dev-&gt;info.pid[0], dev-&gt;info.pid[1], dev-&gt;info.pid[2], dev-&gt;info.pid[3]);</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Firmware version</span></span><br><span class="line">    dev-&gt;info.version = ((<span class="type">uint16_t</span>)buf[<span class="number">5</span>] &lt;&lt; <span class="number">8</span>) | buf[<span class="number">4</span>];</span><br><span class="line">    printk(<span class="string">&quot;Firmware version: %x\n&quot;</span>, dev-&gt;info.version);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–x_max y_max</span></span><br><span class="line">    dev-&gt;info.max_x = ((<span class="type">uint16_t</span>)buf[<span class="number">7</span>] &lt;&lt; <span class="number">8</span>) | buf[<span class="number">6</span>];</span><br><span class="line">    dev-&gt;info.max_y = ((<span class="type">uint16_t</span>)buf[<span class="number">9</span>] &lt;&lt; <span class="number">8</span>) | buf[<span class="number">8</span>];</span><br><span class="line">    printk(<span class="string">&quot;Max X: %d, Max Y: %d\n&quot;</span>, dev-&gt;info.max_x, dev-&gt;info.max_y);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å– vendor_id</span></span><br><span class="line">    dev-&gt;info.vendor_id = buf[<span class="number">10</span>];</span><br><span class="line">    printk(<span class="string">&quot;Vendor_id: %d\n&quot;</span>, dev-&gt;info.vendor_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gt911_request_input_dev</code> å‡½æ•°ç”¨æ¥ç”³è¯·æ³¨å†Œ input è®¾å¤‡ï¼Œå¯¹ input è®¾å¤‡è¿›è¡Œåˆå§‹åŒ–ï¼Œè®¾ç½®éœ€è¦ä¸ŠæŠ¥å“ªäº›äº‹ä»¶ï¼Œåˆå§‹åŒ–å¤šç‚¹è§¦æ‘¸åŠŸèƒ½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gt911ç”³è¯·input_dev</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_request_input_dev</span><span class="params">(<span class="keyword">struct</span> gt911_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    dev-&gt;input_dev = devm_input_allocate_device(&amp;dev-&gt;client-&gt;dev);</span><br><span class="line">    <span class="keyword">if</span>(!dev-&gt;input_dev)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to allocate input device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// input_devèµ‹å€¼</span></span><br><span class="line">    dev-&gt;input_dev-&gt;name = <span class="string">&quot;GT911 TouchScreen&quot;</span>; <span class="comment">// åå­—</span></span><br><span class="line">    dev-&gt;input_dev-&gt;phys = <span class="string">&quot;input/ts&quot;</span>;</span><br><span class="line">    dev-&gt;input_dev-&gt;id.bustype = BUS_I2C;   <span class="comment">// æ€»çº¿ç±»å‹</span></span><br><span class="line">    dev-&gt;input_dev-&gt;id.vendor = dev-&gt;info.vendor_id;</span><br><span class="line">    dev-&gt;input_dev-&gt;id.product = dev-&gt;info.pid;</span><br><span class="line">    dev-&gt;input_dev-&gt;id.version = dev-&gt;info.version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®inputè®¾å¤‡éœ€è¦ä¸ŠæŠ¥å“ªäº›äº‹ä»¶</span></span><br><span class="line">    __set_bit(EV_KEY, dev-&gt;input_dev-&gt;evbit);   <span class="comment">// æŒ‰é”®äº‹ä»¶</span></span><br><span class="line">    __set_bit(EV_ABS, dev-&gt;input_dev-&gt;evbit);   <span class="comment">// é‡å¤äº‹ä»¶</span></span><br><span class="line">    __set_bit(BTN_TOUCH, dev-&gt;input_dev-&gt;keybit);   <span class="comment">// è§¦æ‘¸æŒ‰é”®ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å¤šç‚¹è§¦æ‘¸åŠŸèƒ½</span></span><br><span class="line">    input_set_abs_params(dev-&gt;input_dev, ABS_MT_POSITION_X, <span class="number">0</span>, dev-&gt;info.max_x, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    input_set_abs_params(dev-&gt;input_dev, ABS_MT_POSITION_Y, <span class="number">0</span>, dev-&gt;info.max_y, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    input_set_abs_params(dev-&gt;input_dev, ABS_MT_TOUCH_MAJOR, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ret = input_mt_init_slots(dev-&gt;input_dev, MAX_SUPPORT_POINTS, INPUT_MT_DIRECT | INPUT_MT_DROP_UNUSED);</span><br><span class="line">    <span class="keyword">if</span>(ret)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to init mt slots\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    ret = input_register_device(dev-&gt;input_dev);</span><br><span class="line">    <span class="keyword">if</span>(ret)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(<span class="string">&quot;Failed to register input device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸­æ–­éƒ¨åˆ†ï¼šä½¿ç”¨ä¸­æ–­çº¿ç¨‹åŒ–ï¼Œåœ¨ä¸­æ–­çº¿ç¨‹å‡½æ•°ä¸­è·å–è§¦æ‘¸ç‚¹ä¿¡æ¯å¹¶ä¸ŠæŠ¥ä¿¡æ¯ï¼Œ<strong>é€€å‡ºä¸­æ–­æ—¶è¦å¯¹ 0x814E å¯„å­˜å™¨æ¸…é›¶ï¼Œå¦åˆ™ä¼šä¸€ç›´è§¦æ‘¸ä¸­æ–­ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸­æ–­çº¿ç¨‹å‡½æ•°</span></span><br><span class="line"><span class="type">static</span> <span class="type">irqreturn_t</span> <span class="title function_">gt911_irq_handler</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">uint8_t</span> data;</span><br><span class="line">    <span class="type">int</span> touch_num;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">gt911_dev</span> *<span class="title">dev</span> =</span> (<span class="keyword">struct</span> gt911_dev *)dev_id;</span><br><span class="line">    </span><br><span class="line">    ret = gt911_read_reg(dev-&gt;client, GT911_COOR_REG, &amp;data, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(data == <span class="number">0x00</span>)</span><br><span class="line">        <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">    touch_num = data &amp; <span class="number">0x0F</span>;</span><br><span class="line"></span><br><span class="line">    gt911_process_event(dev, touch_num);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†å¯„å­˜å™¨å€¼ å¦åˆ™ä¼šä¸€ç›´è§¦å‘ä¸­æ–­</span></span><br><span class="line">    data = <span class="number">0x00</span>;</span><br><span class="line">    gt911_write_reg(dev-&gt;client, GT911_COOR_REG, &amp;data, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸­æ–­åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gt911_request_irq</span><span class="params">(<span class="keyword">struct</span> gt911_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ä¸­æ–­çº¿ç¨‹åŒ–</span></span><br><span class="line">    <span class="keyword">return</span> devm_request_threaded_irq(&amp;dev-&gt;client-&gt;dev, dev-&gt;client-&gt;irq,</span><br><span class="line">            <span class="literal">NULL</span>, gt911_irq_handler, IRQ_TYPE_EDGE_FALLING | IRQF_ONESHOT,</span><br><span class="line">            dev-&gt;client-&gt;name, dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†å’Œä¸ŠæŠ¥è§¦æ‘¸æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ŠæŠ¥è§¦æ‘¸æ•°æ®</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">gt911_ts_report_touch</span><span class="params">(<span class="keyword">struct</span> gt911_dev *dev, <span class="type">uint8_t</span> *data, <span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> input_x, input_y, input_w;</span><br><span class="line">    <span class="comment">//id = data[0];</span></span><br><span class="line">    input_x = ((<span class="type">uint16_t</span>)data[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">1</span>];</span><br><span class="line">    input_y = ((<span class="type">uint16_t</span>)data[<span class="number">4</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">3</span>];</span><br><span class="line">    input_w = ((<span class="type">uint16_t</span>)data[<span class="number">6</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    input_mt_slot(dev-&gt;input_dev, i);</span><br><span class="line">    input_mt_report_slot_state(dev-&gt;input_dev, MT_TOOL_FINGER, <span class="literal">true</span>);</span><br><span class="line">    input_report_abs(dev-&gt;input_dev, ABS_MT_POSITION_X, input_x);</span><br><span class="line">    input_report_abs(dev-&gt;input_dev, ABS_MT_POSITION_Y, input_y);</span><br><span class="line">    input_report_abs(dev-&gt;input_dev, ABS_MT_TOUCH_MAJOR, input_w);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†è§¦æ‘¸æ•°æ®</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">gt911_process_event</span><span class="params">(<span class="keyword">struct</span> gt911_dev *dev, <span class="type">int</span> touch_num)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i, ret;</span><br><span class="line">    <span class="type">uint8_t</span> touch_data[<span class="number">8</span> * MAX_SUPPORT_POINTS - <span class="number">3</span>];</span><br><span class="line">    <span class="type">uint16_t</span> cur_touch = <span class="number">0</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">uint16_t</span> pre_touch = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®</span></span><br><span class="line">    ret = gt911_read_reg(dev-&gt;client, GT911_TP1_REG, touch_data, <span class="number">8</span> * MAX_SUPPORT_POINTS - <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MAX_SUPPORT_POINTS; i++) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(touch_num &amp;&amp; (i == touch_data[<span class="number">8</span> * i]))  </span><br><span class="line">        &#123;</span><br><span class="line">            gt911_ts_report_touch(dev, &amp;touch_data[<span class="number">8</span> * i], i);</span><br><span class="line">            cur_touch |= (<span class="number">0x01</span> &lt;&lt; i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(pre_touch &amp; (<span class="number">0x01</span> &lt;&lt; i))    <span class="comment">// ä¸Šä¸€æ¬¡è§¦æ‘¸å®Œè¿™æ¬¡é‡Šæ”¾äº†</span></span><br><span class="line">        &#123;</span><br><span class="line">            input_mt_slot(dev-&gt;input_dev, i);</span><br><span class="line">            input_mt_report_slot_state(dev-&gt;input_dev, MT_TOOL_FINGER, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pre_touch = cur_touch;    <span class="comment">// æ›´æ–°ä¸Šä¸€æ¬¡çš„è§¦æ‘¸çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒæ­¥æ•°æ® ä¸ŠæŠ¥å®Œæˆ</span></span><br><span class="line">    input_mt_report_pointer_emulation(dev-&gt;input_dev, <span class="literal">true</span>);</span><br><span class="line">    input_sync(dev-&gt;input_dev);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å°†é©±åŠ¨æ·»åŠ åˆ°å†…æ ¸">å°†é©±åŠ¨æ·»åŠ åˆ°å†…æ ¸</h3><p>ä¿®æ”¹ <code>drivers/input/touchscreen</code> ç›®å½•ä¸‹çš„ Makefile æ–‡ä»¶ï¼Œåœ¨æœ€ä¸‹é¢æ·»åŠ ä¸€è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-y += gt911.o</span><br></pre></td></tr></table></figure><p>æ¥ç€ç¼–è¯‘å†…æ ¸ï¼Œé‡å¯å¼€å‘æ¿ï¼Œä½¿ç”¨ hexdump å‘½ä»¤æµ‹è¯•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexdump /dev/input/event1</span><br></pre></td></tr></table></figure><p>è·¯å¾„çœ‹ä½ çš„è§¦æ‘¸å±å¯¹åº”å“ªä¸ª eventï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤çœ‹ä½ çš„è§¦æ‘¸å±å¯¹åº”å“ªä¸ª eventï¼šæŸ¥çœ‹è®¾å¤‡èŠ‚ç‚¹å¯¹åº”å“ªäº›ç¡¬ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/bus/input/devices</span><br></pre></td></tr></table></figure><h2 id="tslib-ç§»æ¤">tslib ç§»æ¤</h2><p>tslib æ˜¯ä¸€ä¸ªå¼€æºçš„ç¬¬ä¸‰æ–¹åº“ï¼Œç”¨äºè§¦æ‘¸å±æ€§èƒ½æµ‹è¯•ã€‚</p><blockquote><p><a href="https://github.com/libts/tslib">libts/tslib: Touchscreen access library (github.com)</a></p></blockquote><p>ç¼–è¯‘ tslib å‰éœ€è¦å®‰è£…ä¸€äº›æ’ä»¶ï¼Œé˜²æ­¢ç¼–è¯‘è¿‡ç¨‹å‡ºé”™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install autoconf</span><br><span class="line">sudo apt-get install automake</span><br><span class="line">sudo apt-get install libtool</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ tslibï¼šåœ¨ tslib æºç ç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./autogen.sh</span><br><span class="line">./configure --host=arm-buildroot-linux-gnueabihf --prefix=/home/router2/tslib-1.21/tmp</span><br><span class="line">make -j8</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><ul><li>host å¡«å†™è‡ªå·±äº¤å‰ç¼–è¯‘å™¨çš„åå­—</li><li>prefix ä¸ºç¼–è¯‘ç”Ÿæˆæ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œå¾—ä½¿ç”¨ç»å¯¹è·¯å¾„</li></ul><p>å°†ç”Ÿæˆçš„æ–‡ä»¶å¤åˆ¶åˆ°å¼€å‘æ¿çš„ /opt ç›®å½•ä¸‹ï¼Œæ”¾åˆ° /opt ç›®å½•ä¸‹åªæ˜¯ä¸ºäº†åŒºåˆ†ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ”¾åˆ°æ ¹ç›®å½•ä¸‹çš„ etcã€binã€includeã€libã€share ç›®å½•ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rf</span><br></pre></td></tr></table></figure><p>é…ç½® tslibï¼Œæ‰“å¼€ <code>/etc/ts.conf</code> æ–‡ä»¶ï¼Œç¡®ä¿æ”¹è¡Œæœªè¢«æ³¨é‡Šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module_raw input</span><br></pre></td></tr></table></figure><p>æ¥ç€åœ¨å¼€å‘æ¿ä¸Š <code>/etc/profile</code> æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export TSLIB_ROOT=/opt/tslib-1.21</span><br><span class="line">export TSLIB_FBDEVICE=/dev/fb0</span><br><span class="line">export TSLIB_TSDEVICE=/dev/input/event1</span><br><span class="line">export TSLIB_CONFFILE=/opt/tslib-1.21/etc/ts.conf</span><br><span class="line">export TSLIB_CALIBFILE=/etc/pointercal</span><br><span class="line">export TSLIB_PLUGINDIR=/opt/tslib-1.21/lib/ts</span><br><span class="line">export TSLIB_CONSOLEDEVICE=none</span><br><span class="line">export LD_LIBRARY_PATH=/lib:/usr/lib:/usr/local/lib:$TSLIB_ROOT/lib/</span><br></pre></td></tr></table></figure><ul><li>TSLIB_TSDEVICEï¼šæŒ‡å®šè§¦æ‘¸è®¾å¤‡çš„è®¾å¤‡èŠ‚ç‚¹</li><li>TSLIB_FBDEVICEï¼šæŒ‡å®š framebuffer è®¾å¤‡ï¼Œå³å±å¹•è®¾å¤‡èŠ‚ç‚¹</li><li>TSLIB_CALIBFILEï¼šæŒ‡å®šæ ¡å‡†ç»“æœä¿å­˜è·¯å¾„ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œä¸ç”¨æ‰‹åŠ¨åˆ›å»ºã€‚</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linux-è§¦æ‘¸å±é©±åŠ¨&quot;&gt;Linux-è§¦æ‘¸å±é©±åŠ¨&lt;/h1&gt;
&lt;h2 id=&quot;ç¯å¢ƒ&quot;&gt;ç¯å¢ƒ&lt;/h2&gt;
&lt;h3 id=&quot;ç¡¬ä»¶ç¯å¢ƒ&quot;&gt;ç¡¬ä»¶ç¯å¢ƒ&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å¼€å‘æ¿å‹å·&lt;/strong&gt;ï¼š&lt;a href=&quot;https://blog.csdn</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux åµŒå…¥å¼" scheme="http://www.obito.top/tags/Linux-%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Linuxç³»ç»Ÿç§»æ¤</title>
    <link href="http://www.obito.top/2024/06/30/Linux%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/"/>
    <id>http://www.obito.top/2024/06/30/Linux%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/</id>
    <published>2024-06-30T06:18:41.000Z</published>
    <updated>2024-07-19T09:31:36.235Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux-ç³»ç»Ÿç§»æ¤">Linux ç³»ç»Ÿç§»æ¤</h1><h2 id="åºè¨€">åºè¨€</h2><p>Linux å­¦äº†æœ‰äº›æ—¶é—´äº†ï¼Œæ‰‹ä¸Šçš„å¼€å‘æ¿å¾ˆå¤šåŠŸèƒ½éƒ½æå‰åšå¥½äº†ï¼Œå¯¹åˆå­¦è€…æŒºå‹å¥½çš„ï¼Œä½†æ˜¯ä¸ºäº†å­¦åˆ°æ›´åˆ°ä¸œè¥¿ï¼Œå°±æ¥è¯•è¯•ç§»æ¤ä¸‹æ–°çš„ Linux ç³»ç»Ÿåˆ°å¼€å‘æ¿ä¸Šã€‚</p><h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2><h3 id="ç¡¬ä»¶ç¯å¢ƒ">ç¡¬ä»¶ç¯å¢ƒ</h3><ul><li><strong>å¼€å‘æ¿å‹å·</strong>ï¼š <a href="https://blog.csdn.net/thisway_diy/article/details/109841372">100ask_imx6ull_pro å¼€å‘æ¿</a></li><li><strong>å¤„ç†å™¨ç±»å‹</strong>ï¼šNXP IMX6ULL</li><li>**å¤„ç†å™¨æ¶æ„ï¼š**æ©å•æ ¸ Cortex-A7</li><li>**å¤„ç†å™¨ä¸»é¢‘ï¼š**800MHZ</li><li><strong>å†…å­˜å®¹é‡</strong>ï¼š512 MB DDR3</li><li><strong>å­˜å‚¨ä»‹è´¨</strong>ï¼š4GB eMMC</li></ul><h3 id="è½¯ä»¶ç¯å¢ƒ">è½¯ä»¶ç¯å¢ƒ</h3><ul><li>å®¿ä¸»æœº<ul><li><strong>å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ</strong>ï¼šUbuntu 18.04</li><li><strong>äº¤å‰ç¼–è¯‘å™¨</strong>ï¼š100ask æä¾›çš„å·¥å…·é“¾ arm-buildroot-linux-gnueabihf- <strong>æ”¯æŒçš„æœ€ä½å†…æ ¸ç‰ˆæœ¬</strong>ï¼š4.9.0</li></ul></li><li>å¼€å‘æ¿<ul><li><strong>U-Boot</strong>ï¼šä¸€å¼€å§‹ç”¨çš„ NXP å®˜æ–¹æä¾›çš„ç‰ˆæœ¬ä½†ä¸èƒ½æ­£å¸¸å¯åŠ¨å†…æ ¸ï¼Œåæ”¹ä¸º 100ask æä¾›çš„ç‰ˆæœ¬</li><li><strong>å†…æ ¸ç‰ˆæœ¬</strong>ï¼š <a href="https://github.com/nxp-imx/linux-imx/tree/imx_4.9.88_2.0.0_ga">NXP æä¾›çš„ 4.9.88 ç‰ˆæœ¬</a></li><li><strong>æ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹</strong>ï¼š<a href="https://busybox.net/downloads/">BusyBox 1.29.0</a></li></ul></li></ul><h2 id="linux-ç³»ç»Ÿç§»æ¤è¿‡ç¨‹æ¦‚è¿°">Linux ç³»ç»Ÿç§»æ¤è¿‡ç¨‹æ¦‚è¿°</h2><p>Linux ç³»ç»Ÿç§»æ¤éœ€è¦ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>bootloaderï¼šç”¨äºå¯åŠ¨ Linux å†…æ ¸ã€‚å¸¸ç”¨ bootloaderï¼šU-Boot</li><li>Linux å†…æ ¸ï¼šä¸€èˆ¬ä½¿ç”¨èŠ¯ç‰‡åŸå‚æä¾›çš„æºç </li><li>æ ¹æ–‡ä»¶ç³»ç»Ÿï¼šå­˜æ”¾ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤å’Œæ–‡ä»¶</li></ul><p><strong>U-Bootã€Linux kernel å’Œ æ ¹æ–‡ä»¶ç³»ç»Ÿä¸‰è€…ä¸€èµ·æ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„ Linux ç³»ç»Ÿã€‚</strong></p><p><strong>æ­¥éª¤</strong></p><ul><li>ç§»æ¤ U-Boot</li><li>ç§»æ¤ Linux å†…æ ¸ï¼šç¼–è¯‘å†…æ ¸å¯ä»¥é€‰æ‹©æ˜¯å¦ç”Ÿæˆè®¾å¤‡æ ‘</li><li>æ ¹æ–‡ä»¶ç³»ç»Ÿ</li></ul><blockquote><p>ç§»æ¤ Linux ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆç§»æ¤ä¸€ä¸ª bootloader ä»£ç ï¼Œè¿™ä¸ª bootloader ä»£ç ç”¨äºå¯åŠ¨ Linux å†…æ ¸ï¼Œbootloader æœ‰å¾ˆå¤šï¼Œå¸¸ç”¨çš„å°±æ˜¯ U-Bootã€‚ç§»æ¤å¥½ U-Boot ä»¥åå†ç§»æ¤ Linux å†…æ ¸ï¼Œç§»æ¤å®Œ Linux å†…æ ¸ä»¥å Linux è¿˜ä¸èƒ½æ­£å¸¸å¯åŠ¨ï¼Œè¿˜éœ€è¦å†ç§»æ¤ä¸€ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿ(rootfs)ï¼Œæ ¹æ–‡ä»¶ç³»ç»Ÿé‡Œé¢åŒ…å«äº†ä¸€äº›æœ€å¸¸ç”¨çš„å‘½ä»¤å’Œæ–‡ä»¶ã€‚æ‰€ä»¥ U-Bootã€Linux kernel å’Œ rootfs è¿™ä¸‰è€…ä¸€èµ·æ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„ Linux ç³»ç»Ÿï¼Œä¸€ä¸ªå¯ä»¥æ­£å¸¸ä½¿ç”¨ã€åŠŸèƒ½å®Œå–„çš„ Linux ç³»ç»Ÿã€‚åœ¨æœ¬ç¯‡æˆ‘ä»¬å°±æ¥è®²è§£ U-Bootã€Linux Kernel å’Œ rootfs çš„ç§»æ¤ï¼Œä¸å…¶è¯´æ˜¯â€œç§»æ¤â€ï¼Œå€’ä¸å¦‚è¯´æ˜¯â€œé€‚é…â€ï¼Œå› ä¸ºå¤§éƒ¨åˆ†çš„ç§»æ¤å·¥ä½œéƒ½ç”± NXP å®Œæˆäº†ï¼Œæˆ‘ä»¬è¿™é‡Œæ‰€è°“çš„â€œç§»æ¤â€ä¸»è¦æ˜¯ä½¿å…¶èƒ½å¤Ÿåœ¨I.MX6U-ALPHA å¼€å‘æ¿ä¸Šè·‘èµ·æ¥ã€‚</p></blockquote><blockquote><p><a href="https://blog.csdn.net/m0_56694518/article/details/131463913">ç³»ç»Ÿç§»æ¤ï¼ˆç¯å¢ƒæ­å»ºã€ubootã€Linuxå†…æ ¸ã€æ ¹æ–‡ä»¶ç³»ç»Ÿï¼‰-CSDNåšå®¢</a></p></blockquote><h2 id="u-boot">U-Boot</h2><p>U-Boot çš„å…¨ç§°æ˜¯ Universal Boot Loaderï¼ŒU-Boot æ˜¯ä¸€ä¸ªéµå¾ª GPL åè®®çš„å¼€æºè½¯ä»¶ï¼ŒU-Boot æ˜¯ä¸€ä¸ªè£¸æœºä»£ç ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè£¸æœºç»¼åˆä¾‹ç¨‹</p><p>Linux ç³»ç»Ÿè¦å¯åŠ¨å°±å¿…é¡»éœ€è¦ä¸€ä¸ª bootloader ç¨‹åºï¼Œä¹Ÿå°±è¯´<strong>èŠ¯ç‰‡ä¸Šç”µä»¥åå…ˆè¿è¡Œä¸€æ®µ bootloader ç¨‹åº</strong>ã€‚è¿™æ®µbootloader ç¨‹åºä¼šå…ˆ<strong>åˆå§‹åŒ– DDR ç­‰å¤–è®¾</strong>ï¼Œç„¶åå°† Linux å†…æ ¸ä» flash(NANDï¼ŒNOR FLASHï¼ŒSDï¼ŒMMC ç­‰)<strong>æ‹·è´åˆ° DDR ä¸­</strong>ï¼Œæœ€å<strong>å¯åŠ¨ Linux å†…æ ¸</strong>ã€‚</p><p>U-Boot æˆ‘ä»¬ä¸€èˆ¬ä¸æ˜¯ä½¿ç”¨ U-Boot å®˜æ–¹çš„æºç ï¼Œè€Œæ˜¯é‡‡ç”¨å¼€å‘æ¿å¯¹åº”èŠ¯ç‰‡å‚å•†çš„å®šåˆ¶ç‰ˆæœ¬ï¼Œä¸€èˆ¬åˆ†ä¸ºä¸‰ç§ï¼š</p><table><thead><tr><th>å‚å•†</th><th>æè¿°</th></tr></thead><tbody><tr><td>U-Boot å®˜æ–¹çš„ U-Boot ä»£ç </td><td>ç”± U-Boot å®˜æ–¹ç»´æŠ¤å¼€å‘çš„ U-Boot ç‰ˆæœ¬ï¼Œç‰ˆæœ¬æ›´æ–°å¿«ï¼ŒåŸºæœ¬åŒ…å«æ‰€æœ‰å¸¸ç”¨çš„èŠ¯ç‰‡ã€‚</td></tr><tr><td>åŠå¯¼ä½“å‚å•†çš„ U-Boot ä»£ç </td><td>åŠå¯¼ä½“å‚å•†ç»´æŠ¤çš„ä¸€ä¸ª U-Bootï¼Œä¸“é—¨é’ˆå¯¹è‡ªå®¶çš„èŠ¯ç‰‡ï¼Œåœ¨å¯¹è‡ªå®¶èŠ¯ç‰‡æ”¯æŒä¸Šè¦æ¯” U-Boot å®˜æ–¹çš„å¥½ã€‚</td></tr><tr><td>å¼€å‘æ¿å‚å•†çš„ U-Boot ä»£ç </td><td>å¼€å‘æ¿å‚å•†åœ¨åŠå¯¼ä½“å‚å•†æä¾›çš„ U-Boot åŸºç¡€ä¸ŠåŠ å…¥äº†å¯¹è‡ªå®¶å¼€å‘æ¿çš„æ”¯æŒã€‚</td></tr></tbody></table><blockquote><p>U-boot å®˜æ–¹ U-Boot æºç ä¸‹è½½é¡µé¢ï¼š<a href="http://ftp.denx.de/pub/uboot/">http://ftp.denx.de/pub/uboot/</a><br>NXP å®˜æ–¹ U-Boot æºç  Git åœ°å€ï¼š<a href="https://source.codeaurora.org/external/imx/ubootimx">https://source.codeaurora.org/external/imx/ubootimx</a></p></blockquote><h3 id="u-boot-ç§»æ¤">U-Boot ç§»æ¤</h3><p>uboot ç§»æ¤çš„ä¸€èˆ¬æµç¨‹ï¼š</p><ul><li>åœ¨ uboot ä¸­æ‰¾åˆ°å‚è€ƒçš„å¼€å‘å¹³å°ï¼Œä¸€èˆ¬æ˜¯åŸå‚çš„å¼€å‘æ¿ã€‚</li><li>å‚è€ƒåŸå‚å¼€å‘æ¿ç§»æ¤ uboot åˆ°æˆ‘ä»¬æ‰€ä½¿ç”¨çš„å¼€å‘æ¿ä¸Šã€‚</li></ul><p><strong>ä¸€èˆ¬ uboot ä¸­éœ€è¦è§£å†³ä¸²å£ã€NANDã€EMMC æˆ– SD å¡ã€ç½‘ç»œå’Œ LCD é©±åŠ¨ï¼Œå› ä¸º uboot çš„ä¸»è¦ç›®çš„å°±æ˜¯å¯åŠ¨ Linux å†…æ ¸ï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘å¤ªå¤šçš„å¤–è®¾é©±åŠ¨ã€‚</strong></p><p><em><strong>PSï¼šè¿™é‡Œä½¿ç”¨ NXP å®˜æ–¹æä¾›çš„ uboot æŒ‰ç…§æ­£ç‚¹åŸå­æ•™ç¨‹ç§»æ¤åˆ° 100ask å¼€å‘æ¿åˆæ­¥æµ‹è¯•æˆåŠŸï¼Œä½†æ˜¯åç»­å¯åŠ¨ Linux å†…æ ¸æ—¶ä¼šå‡ºç° <code>data abort</code> çš„é—®é¢˜ï¼Œç›®å‰æš‚æœªè§£å†³ï¼Œæ¢æˆ 100ask æä¾›çš„ uboot åˆ™èƒ½æ­£å¸¸å¯åŠ¨ Linux å†…æ ¸ï¼Œè¿™é‡Œä¾æ—§æ˜¯ä½¿ç”¨ NXP å®˜æ–¹æä¾›çš„ uboot æºç è¿›è¡Œä¿®æ”¹æµ‹è¯•ã€‚</strong></em></p><h4 id="ç¼–è¯‘-nxp-å®˜æ–¹å¼€å‘æ¿çš„-u-boot">ç¼–è¯‘ NXP å®˜æ–¹å¼€å‘æ¿çš„ U-Boot</h4><p>æ‰¾åˆ° NXP å®˜æ–¹ I.MX6ULL EVK å¼€å‘æ¿å¯¹åº”çš„é»˜è®¤é…ç½®æ–‡ä»¶ä»¥åå°±å¯ä»¥ç¼–è¯‘ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹© EMMC ç‰ˆæœ¬çš„ <code>mx6ull_14x14_evk_emmc_defconfig</code> ï¼ŒCROSS_COMPILE é€‰æ‹©è‡ªå·±çš„äº¤å‰ç¼–è¯‘å™¨ã€‚</p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘ ubootï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- mx6ull_14x14_evk_emmc_defconfig</span><br><span class="line">make V=1 ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- -j16</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æˆåŠŸç»“æœå¦‚ä¸‹ï¼š</p><p><img src="image-20240702145611903.png" alt="image-20240702145611903"></p><h4 id="çƒ§å½•åˆ°-sd-å¡æµ‹è¯•">çƒ§å½•åˆ° SD å¡æµ‹è¯•</h4><p>å°† SD å¡æ’å…¥æŸ¥çœ‹ /dev/ ç›®å½•ä¸‹æ–°å¢å“ªä¸ªç›®å½•ï¼Œå°±æ˜¯ SD å¡çš„ç›®å½•ã€‚</p><p>**æˆ‘ä»¬ç¼–è¯‘å‡ºæ¥çš„ .bin æ–‡ä»¶ä¸èƒ½ç›´æ¥çƒ§å†™åˆ° SD å¡ä¸­ï¼Œéœ€è¦åœ¨ .bin æ–‡ä»¶å‰é¢åŠ ä¸Š IVTã€Boot Data å’Œ DCD è¿™ä¸‰ä¸ªæ•°æ®å—ã€‚**è¿™ä¸‰ä¸ªæ•°æ®å—æ˜¯æœ‰æŒ‡å®šæ ¼å¼çš„æˆ‘ä»¬å¿…é¡»æŒ‰ç…§æ ¼å¼å¡«å†™ï¼Œç„¶åå°†å…¶æ”¾åˆ° .bin æ–‡ä»¶å‰é¢ï¼Œæœ€ç»ˆåˆæˆçš„æ‰æ˜¯å¯ä»¥ç›´æ¥çƒ§å†™åˆ° SD å¡ä¸­çš„æ–‡ä»¶ã€‚</p><h5 id="æ–¹æ³•ä¸€ï¼šä½¿ç”¨-imxdownload-ç¨‹åº">æ–¹æ³•ä¸€ï¼šä½¿ç”¨ imxdownload ç¨‹åº</h5><p>ä½¿ç”¨ imxdownload ç¨‹åºå°† .binæ–‡ä»¶è½¬æ¢ä¸º .imx çƒ§å½•è¿› SD å¡ã€‚</p><p><img src="image-20240702153906291.png" alt="image-20240702153906291"></p><h5 id="æ–¹æ³•äºŒï¼šä½¿ç”¨-dd-å‘½ä»¤">æ–¹æ³•äºŒï¼šä½¿ç”¨ dd å‘½ä»¤</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd iflag=dsync oflag=dsync if=u-boot-dtb.imx of=/dev/mmcblk0 seek=2</span><br></pre></td></tr></table></figure><p>çƒ§å½•å®Œæˆåï¼Œå°†å¼€å‘æ¿å¯åŠ¨æ–¹å¼è½¬æ¢ä¸º SD å¡å¯åŠ¨ï¼Œç„¶åå¤ä½å¼€å‘æ¿ï¼Œå³å¯çœ‹è§ä¸²å£æ‰“å° uboot ä¿¡æ¯å¦‚ä¸‹ï¼š</p><p><img src="image-20240702155829913.png" alt="image-20240702155829913"></p><p>imxdownload å¤´æ–‡ä»¶å’Œæºæ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _IMXDOWNLOAD_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IMXDOWNLOAD_H</span></span><br><span class="line"><span class="comment">/* IMX6U IVT DCDè¡¨ä¿¡æ¯  æš‚æ—¶å®šä¹‰ä¸º1K Bytesï¼Œæ­¤è¡¨æ˜¯è¯»å–çš„u-boot.imxå‰1K Bytes</span></span><br><span class="line"><span class="comment"> * imx6_ivedcd_table[9]æ˜¯æŒ‡æ˜ä»£ç é•¿åº¦çš„ï¼Œæœ¬åº”è¯¥æ ¹æ®å®é™…çš„ä»£ç é•¿åº¦æ¥ä¿®æ”¹</span></span><br><span class="line"><span class="comment"> * è¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œå°±ç›´æ¥å®šä¹‰ä¸º2M Bytesï¼Œå³</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> imx6_512mb_ivtdcd_table[<span class="number">256</span>] = &#123;</span><br><span class="line"><span class="number">0X402000D1</span>,<span class="number">0X87800000</span>,<span class="number">0X00000000</span>,<span class="number">0X877FF42C</span>,<span class="number">0X877FF420</span>,<span class="number">0X877FF400</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X877FF000</span>,<span class="number">0X00200000</span>,<span class="number">0X00000000</span>,<span class="number">0X40E801D2</span>,<span class="number">0X04E401CC</span>,<span class="number">0X68400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0X6C400C02</span>,</span><br><span class="line"><span class="number">0XFFFFFFFF</span>,<span class="number">0X70400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0X74400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0X78400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0X7C400C02</span>,</span><br><span class="line"><span class="number">0XFFFFFFFF</span>,<span class="number">0X80400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0XB4040E02</span>,<span class="number">0X00000C00</span>,<span class="number">0XAC040E02</span>,<span class="number">0X00000000</span>,<span class="number">0X7C020E02</span>,</span><br><span class="line"><span class="number">0X30000000</span>,<span class="number">0X50020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X4C020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X90040E02</span>,<span class="number">0X30000000</span>,<span class="number">0X88020E02</span>,</span><br><span class="line"><span class="number">0X30000C00</span>,<span class="number">0X70020E02</span>,<span class="number">0X00000000</span>,<span class="number">0X60020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X64020E02</span>,<span class="number">0X30000000</span>,<span class="number">0XA0040E02</span>,</span><br><span class="line"><span class="number">0X30000000</span>,<span class="number">0X94040E02</span>,<span class="number">0X00000200</span>,<span class="number">0X80020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X84020E02</span>,<span class="number">0X30000000</span>,<span class="number">0XB0040E02</span>,</span><br><span class="line"><span class="number">0X00000200</span>,<span class="number">0X98040E02</span>,<span class="number">0X30000000</span>,<span class="number">0XA4040E02</span>,<span class="number">0X30000000</span>,<span class="number">0X44020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X48020E02</span>,</span><br><span class="line"><span class="number">0X30000000</span>,<span class="number">0X1C001B02</span>,<span class="number">0X00800000</span>,<span class="number">0X00081B02</span>,<span class="number">0X030039A1</span>,<span class="number">0X0C081B02</span>,<span class="number">0X0B000300</span>,<span class="number">0X3C081B02</span>,</span><br><span class="line"><span class="number">0X44014801</span>,<span class="number">0X48081B02</span>,<span class="number">0X302C4040</span>,<span class="number">0X50081B02</span>,<span class="number">0X343E4040</span>,<span class="number">0X1C081B02</span>,<span class="number">0X33333333</span>,<span class="number">0X20081B02</span>,</span><br><span class="line"><span class="number">0X33333333</span>,<span class="number">0X2C081B02</span>,<span class="number">0X333333F3</span>,<span class="number">0X30081B02</span>,<span class="number">0X333333F3</span>,<span class="number">0XC0081B02</span>,<span class="number">0X09409400</span>,<span class="number">0XB8081B02</span>,</span><br><span class="line"><span class="number">0X00080000</span>,<span class="number">0X04001B02</span>,<span class="number">0X2D000200</span>,<span class="number">0X08001B02</span>,<span class="number">0X3030331B</span>,<span class="number">0X0C001B02</span>,<span class="number">0XF3526B67</span>,<span class="number">0X10001B02</span>,</span><br><span class="line"><span class="number">0X630B6DB6</span>,<span class="number">0X14001B02</span>,<span class="number">0XDB00FF01</span>,<span class="number">0X18001B02</span>,<span class="number">0X40172000</span>,<span class="number">0X1C001B02</span>,<span class="number">0X00800000</span>,<span class="number">0X2C001B02</span>,</span><br><span class="line"><span class="number">0XD2260000</span>,<span class="number">0X30001B02</span>,<span class="number">0X23106B00</span>,<span class="number">0X40001B02</span>,<span class="number">0X4F000000</span>,<span class="number">0X00001B02</span>,<span class="number">0X00001884</span>,<span class="number">0X90081B02</span>,</span><br><span class="line"><span class="number">0X00004000</span>,<span class="number">0X1C001B02</span>,<span class="number">0X32800002</span>,<span class="number">0X1C001B02</span>,<span class="number">0X33800000</span>,<span class="number">0X1C001B02</span>,<span class="number">0X31800400</span>,<span class="number">0X1C001B02</span>,</span><br><span class="line"><span class="number">0X30802015</span>,<span class="number">0X1C001B02</span>,<span class="number">0X40800004</span>,<span class="number">0X20001B02</span>,<span class="number">0X00080000</span>,<span class="number">0X18081B02</span>,<span class="number">0X27020000</span>,<span class="number">0X04001B02</span>,</span><br><span class="line"><span class="number">0X2D550200</span>,<span class="number">0X04041B02</span>,<span class="number">0X06100100</span>,<span class="number">0X1C001B02</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> imx6_256mb_ivtdcd_table[<span class="number">256</span>] = &#123;</span><br><span class="line"><span class="number">0X402000D1</span>,<span class="number">0X87800000</span>,<span class="number">0X00000000</span>,<span class="number">0X877FF42C</span>,<span class="number">0X877FF420</span>,<span class="number">0X877FF400</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X877FF000</span>,<span class="number">0X00076000</span>,<span class="number">0X00000000</span>,<span class="number">0X40E801D2</span>,<span class="number">0X04E401CC</span>,<span class="number">0X68400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0X6C400C02</span>,</span><br><span class="line"><span class="number">0XFFFFFFFF</span>,<span class="number">0X70400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0X74400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0X78400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0X7C400C02</span>,</span><br><span class="line"><span class="number">0XFFFFFFFF</span>,<span class="number">0X80400C02</span>,<span class="number">0XFFFFFFFF</span>,<span class="number">0XB4040E02</span>,<span class="number">0X00000C00</span>,<span class="number">0XAC040E02</span>,<span class="number">0X00000000</span>,<span class="number">0X7C020E02</span>,</span><br><span class="line"><span class="number">0X30000000</span>,<span class="number">0X50020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X4C020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X90040E02</span>,<span class="number">0X30000000</span>,<span class="number">0X88020E02</span>,</span><br><span class="line"><span class="number">0X30000C00</span>,<span class="number">0X70020E02</span>,<span class="number">0X00000000</span>,<span class="number">0X60020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X64020E02</span>,<span class="number">0X30000000</span>,<span class="number">0XA0040E02</span>,</span><br><span class="line"><span class="number">0X30000000</span>,<span class="number">0X94040E02</span>,<span class="number">0X00000200</span>,<span class="number">0X80020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X84020E02</span>,<span class="number">0X30000000</span>,<span class="number">0XB0040E02</span>,</span><br><span class="line"><span class="number">0X00000200</span>,<span class="number">0X98040E02</span>,<span class="number">0X30000000</span>,<span class="number">0XA4040E02</span>,<span class="number">0X30000000</span>,<span class="number">0X44020E02</span>,<span class="number">0X30000000</span>,<span class="number">0X48020E02</span>,</span><br><span class="line"><span class="number">0X30000000</span>,<span class="number">0X1C001B02</span>,<span class="number">0X00800000</span>,<span class="number">0X00081B02</span>,<span class="number">0X030039A1</span>,<span class="number">0X0C081B02</span>,<span class="number">0X04000000</span>,<span class="number">0X3C081B02</span>,</span><br><span class="line"><span class="number">0X3C013C01</span>,<span class="number">0X48081B02</span>,<span class="number">0X38324040</span>,<span class="number">0X50081B02</span>,<span class="number">0X28304040</span>,<span class="number">0X1C081B02</span>,<span class="number">0X33333333</span>,<span class="number">0X20081B02</span>,</span><br><span class="line"><span class="number">0X33333333</span>,<span class="number">0X2C081B02</span>,<span class="number">0X333333F3</span>,<span class="number">0X30081B02</span>,<span class="number">0X333333F3</span>,<span class="number">0XC0081B02</span>,<span class="number">0X09409400</span>,<span class="number">0XB8081B02</span>,</span><br><span class="line"><span class="number">0X00080000</span>,<span class="number">0X04001B02</span>,<span class="number">0X2D000200</span>,<span class="number">0X08001B02</span>,<span class="number">0X3030331B</span>,<span class="number">0X0C001B02</span>,<span class="number">0XF352433F</span>,<span class="number">0X10001B02</span>,</span><br><span class="line"><span class="number">0X630B6DB6</span>,<span class="number">0X14001B02</span>,<span class="number">0XDB00FF01</span>,<span class="number">0X18001B02</span>,<span class="number">0X40172000</span>,<span class="number">0X1C001B02</span>,<span class="number">0X00800000</span>,<span class="number">0X2C001B02</span>,</span><br><span class="line"><span class="number">0XD2260000</span>,<span class="number">0X30001B02</span>,<span class="number">0X23104300</span>,<span class="number">0X40001B02</span>,<span class="number">0X47000000</span>,<span class="number">0X00001B02</span>,<span class="number">0X00001883</span>,<span class="number">0X90081B02</span>,</span><br><span class="line"><span class="number">0X00004000</span>,<span class="number">0X1C001B02</span>,<span class="number">0X32800002</span>,<span class="number">0X1C001B02</span>,<span class="number">0X33800000</span>,<span class="number">0X1C001B02</span>,<span class="number">0X31800400</span>,<span class="number">0X1C001B02</span>,</span><br><span class="line"><span class="number">0X30802015</span>,<span class="number">0X1C001B02</span>,<span class="number">0X40800004</span>,<span class="number">0X20001B02</span>,<span class="number">0X00080000</span>,<span class="number">0X18081B02</span>,<span class="number">0X27020000</span>,<span class="number">0X04001B02</span>,</span><br><span class="line"><span class="number">0X2D550200</span>,<span class="number">0X04041B02</span>,<span class="number">0X06100100</span>,<span class="number">0X1C001B02</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line"><span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,<span class="number">0X00000000</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imxdownload.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHELLCMD_LEN(200)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIN_OFFSET(3072)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ­¤å®æŒ‡æ˜æ˜¯å¦æ‰“å°u-boot.imxçš„IVT DCDè¡¨ä¿¡æ¯ï¼Œä¸åŒçš„å¼€å‘æ¿å…¶IVTå’ŒDCD</span></span><br><span class="line"><span class="comment"> * è¡¨çš„æ•°æ®æ˜¯ä¸åŒçš„ï¼Œå› æ­¤éœ€è¦è·å–æ‰€ä½¿ç”¨çš„å¼€å‘æ¿çš„IVTå’ŒDCDè¡¨ä¿¡æ¯ï¼Œæœ€</span></span><br><span class="line"><span class="comment"> * ç®€å•çš„æ–¹æ³•å°±æ˜¯è¯»å–å¼€å‘æ¿é…å¥—èµ„æ–™é‡Œé¢çš„u-boot.imxçš„å‰1KBæ•°æ®ï¼Œç†è®ºä¸Š</span></span><br><span class="line"><span class="comment"> * åº”è¯¥è¯»å–3KBçš„æ•°æ®ï¼Œä½†æ˜¯è¡¨ä¿¡æ¯è¿œè¿œæ²¡æœ‰3Kè¿™ä¹ˆå¤šï¼Œå› æ­¤è¯»1KBå³å¯ </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_TAB0</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä»‹ç»ï¼š æ­¤è½¯ä»¶æ˜¯é’ˆå¯¹NXPçš„IMX6Uç³»åˆ—èŠ¯ç‰‡çš„ï¼Œè½¯ä»¶ç”¨æ¥çƒ§å†™binæ–‡ä»¶åˆ°SDå¡é‡Œé¢ï¼Œ</span></span><br><span class="line"><span class="comment"> *        æœ¬è½¯ä»¶ä¼šè‡ªåŠ¨æ·»åŠ IVTã€DCDç­‰ä¿¡æ¯åˆ°åŸå§‹çš„binæ–‡ä»¶é‡Œé¢ï¼Œä¸»è¦ç”¨äºè£¸æœºå’Œubootçš„çƒ§å†™ã€‚</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨æ–¹æ³•ï¼š 1ã€ç¼–è¯‘å¥½åŸå§‹çš„äºŒè¿›åˆ¶binæ–‡ä»¶ï¼Œå¦‚ï¼Œu-boot.binç­‰ï¼Œå¹¶å°†ç¼–è¯‘å¥½çš„.binæ–‡ä»¶å’Œæœ¬</span></span><br><span class="line"><span class="comment"> *             è½¯ä»¶æ”¾ç½®åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹ï¼ï¼ï¼ï¼</span></span><br><span class="line"><span class="comment"> *        2ã€æ‰§è¡Œå‘½ä»¤sudo ./imxdownload &lt;soucre_bin&gt; &lt;sd_device&gt;</span></span><br><span class="line"><span class="comment"> *             å¦‚çƒ§å†™u-boot.binåˆ°/dev/sddä¸­å³å¯ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºå‘½ä»¤:</span></span><br><span class="line"><span class="comment"> *             sudo ./imxdownload u-boot.bin /dev/sdd</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è¾“å‡ºä¸€äº›ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">message_print</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;I.MX6ULL bin download software\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Edit by:zuozhongkai\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Date:2019/6/10\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Version:V1.1\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;log:V1.0 initial version,just support 512MB DDR3\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;    V1.1 and support 256MB DDR3\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">FILE *fp;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *cmdbuf;</span><br><span class="line"><span class="type">int</span> nbytes, filelen;</span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> ddrsize = <span class="number">0</span>; <span class="comment">/* 0ä¸º512MBï¼Œ1ä¸º256MBï¼Œ2ä¸º128MB...... */</span></span><br><span class="line"></span><br><span class="line">message_print();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((argc != <span class="number">3</span>) &amp;&amp; (argc != <span class="number">4</span>))&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Error Usage! Reference Below:\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;sudo ./%s &lt;-512m or -256m&gt; &lt;source_bin&gt; &lt;sd_device&gt;\r\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æŸ¥æ‰¾å‚æ•°ï¼Œè·å–DDRå®¹é‡ */</span></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; argc; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">char</span> *param = argv[i];</span><br><span class="line"><span class="keyword">if</span>(param[<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">strcmp</span>(param, <span class="string">&quot;-256m&quot;</span>) == <span class="number">0</span>) <span class="comment">/* 256MB */</span></span><br><span class="line">ddrsize = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(param, <span class="string">&quot;-512m&quot;</span>) == <span class="number">0</span>)<span class="comment">/* 512MB */</span></span><br><span class="line">ddrsize = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(argc == <span class="number">3</span>)<span class="comment">/* ä¸‰ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸è¾“å…¥DDRå®¹é‡çš„è¯é»˜è®¤ä¸º512MB */</span></span><br><span class="line">ddrsize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ‰“å¼€binæ–‡ä»¶ */</span></span><br><span class="line">fp = fopen(argv[<span class="number">1</span>], <span class="string">&quot;rb&quot;</span>); <span class="comment">/* ä»¥äºŒè¿›åˆ¶åªè¯»æ–¹å¼æ‰“å¼€binæ–‡ä»¶ */</span></span><br><span class="line"><span class="keyword">if</span>(fp == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t Open file %s\r\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è·å–binæ–‡ä»¶é•¿åº¦ */</span></span><br><span class="line">fseek(fp, <span class="number">0L</span>, SEEK_END);</span><br><span class="line">filelen = ftell(fp);</span><br><span class="line">fseek(fp, <span class="number">0L</span>, SEEK_SET);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;file %s size = %dBytes\r\n&quot;</span>, argv[<span class="number">1</span>], filelen);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è¯»å–binæ–‡ä»¶åˆ°ç¼“å†²åŒºbufä¸­ */</span></span><br><span class="line">buf = <span class="built_in">malloc</span>(filelen + BIN_OFFSET);</span><br><span class="line"><span class="keyword">if</span>(buf == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Mem Malloc Failed!\r\n&quot;</span>);</span><br><span class="line">fclose(fp);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0</span>, filelen + BIN_OFFSET); <span class="comment">/* æ¸…é›¶ */</span></span><br><span class="line"><span class="comment">/* è¯»å–binæºç æ–‡ä»¶ */</span></span><br><span class="line">fread(buf + BIN_OFFSET, <span class="number">1</span>, filelen, fp);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å…³é—­æ–‡ä»¶ */</span></span><br><span class="line">fclose(fp);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PRINT_TAB</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;IVT DCD Table:\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">1024</span>/<span class="number">32</span>; i++)&#123;</span><br><span class="line"><span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;0X%08X,&quot;</span>,*(<span class="type">int</span> *)(buf + BIN_OFFSET + (((i * <span class="number">8</span>) + j) * <span class="number">4</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>(buf);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ·»åŠ IVT DCDç­‰è¡¨ä¿¡æ¯åˆ°binæ–‡ä»¶é‡Œé¢ */</span></span><br><span class="line"><span class="keyword">if</span>(ddrsize == <span class="number">0</span>) &#123;<span class="comment">/* 512MB */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Board DDR SIZE: 512MB\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(buf, imx6_512mb_ivtdcd_table, <span class="keyword">sizeof</span>(imx6_512mb_ivtdcd_table));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (ddrsize == <span class="number">1</span>) &#123;<span class="comment">/* 256MB */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Board DDR SIZE: 256MB\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(buf, imx6_256mb_ivtdcd_table, <span class="keyword">sizeof</span>(imx6_256mb_ivtdcd_table));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç°åœ¨æˆ‘ä»¬å·²ç»åœ¨bufä¸­æ„å»ºå¥½äº†å¯ä»¥ç”¨äºä¸‹è½½çš„binæ–‡ä»¶ï¼Œå°†bufä¸­çš„æ•°æ®ä¿å­˜åˆ°</span></span><br><span class="line"><span class="comment"> * åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶å‘½åä¸ºload.imx</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Delete Old load.imx\r\n&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;rm -rf load.imx&quot;</span>);<span class="comment">/* å…ˆåˆ é™¤æ—§çš„load.imxæ–‡ä»¶*/</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Create New load.imx\r\n&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;touch load.imx&quot;</span>);<span class="comment">/* åˆ›å»ºæ–°çš„load.imxæ–‡ä»¶*/</span></span><br><span class="line">fp = fopen(<span class="string">&quot;load.imx&quot;</span>, <span class="string">&quot;wb&quot;</span>);<span class="comment">/* æ‰“å¼€laod.imx*/</span></span><br><span class="line"><span class="keyword">if</span>(fp == <span class="literal">NULL</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Cant&#x27;t Open load.imx!!!\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(buf);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">nbytes = fwrite(buf, <span class="number">1</span>, filelen + BIN_OFFSET, fp);</span><br><span class="line"><span class="keyword">if</span>(nbytes != (filelen + BIN_OFFSET))&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;File Write Error!\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(buf);</span><br><span class="line">fclose(fp);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>(buf);</span><br><span class="line">fclose(fp);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ„å»ºçƒ§å†™çš„shellå‘½ä»¤ */</span></span><br><span class="line">cmdbuf = <span class="built_in">malloc</span>(SHELLCMD_LEN);</span><br><span class="line"><span class="comment">//sprintf(cmdbuf, &quot;sudo dd iflag=dsync oflag=dsync if=load.imx of=%s bs=512 seek=2&quot;,argv[2]);</span></span><br><span class="line">    <span class="built_in">sprintf</span>(cmdbuf, <span class="string">&quot;dd iflag=dsync oflag=dsync if=load.imx of=%s bs=512 seek=2&quot;</span>,argv[<span class="number">2</span>]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Download load.imx to %s  ......\r\n&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ‰§è¡Œä¸Šé¢çš„shellå‘½ä»¤ */</span></span><br><span class="line">system(cmdbuf);</span><br><span class="line"><span class="built_in">free</span>(cmdbuf);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://blog.csdn.net/OnlyLove_/article/details/121843883">i.MX6ULLè£¸æœºå¼€å‘ ä¸‰ï¼šimxdownload æºç åˆ†æ-CSDNåšå®¢</a></p></blockquote><h4 id="æ£€æŸ¥é©±åŠ¨">æ£€æŸ¥é©±åŠ¨</h4><p>æ£€æŸ¥ uboot çš„é©±åŠ¨ï¼Œä¸€èˆ¬æ˜¯æ£€æŸ¥ SD å¡ã€EMMCã€LCDã€ç½‘ç»œè¿™å‡ æ–¹é¢çš„é©±åŠ¨ã€‚æ ¹æ®ä¸‹é¢æ£€æŸ¥åå¯çŸ¥ï¼ŒNXP å®˜æ–¹I.MX6ULL EVK å¼€å‘æ¿çš„ uboot åœ¨ 100ask å¼€å‘æ¿çš„è¿è¡Œæƒ…å†µï¼š</p><ul><li>uboot å¯åŠ¨æ­£å¸¸ï¼ŒDRAM è¯†åˆ«æ­£ç¡®ï¼ŒSD å¡å’Œ EMMC é©±åŠ¨æ­£å¸¸ã€‚</li><li>uboot é»˜è®¤ LCD é©±åŠ¨æ˜¯ 4.3 å¯¸ 480*272 åˆ†è¾¨ç‡çš„ï¼Œè‹¥ä½¿ç”¨å…¶ä»–å±å¹•éœ€è¦ä¿®æ”¹å‚æ•°ã€‚</li><li>ç½‘ç»œä¸èƒ½å·¥ä½œï¼Œéœ€è¦ä¿®æ”¹é©±åŠ¨ã€‚</li></ul><h5 id="sd-å¡å’Œ-emmc-é©±åŠ¨æ£€æŸ¥">SD å¡å’Œ EMMC é©±åŠ¨æ£€æŸ¥</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mmc list// åˆ—å‡ºå½“å‰çš„ MMC è®¾å¤‡</span><br><span class="line">mmc dev 0 // è½¬æ¢åˆ° MMC è®¾å¤‡ 0</span><br><span class="line">mmc info// æ‰“å° MMC è®¾å¤‡ä¿¡æ¯</span><br></pre></td></tr></table></figure><p><img src="/image-20240702154709026.png" alt="image-20240702154709026"></p><p>ä»æ‰“å°ä¿¡æ¯çœ‹å‡ºï¼Œmmc è®¾å¤‡ 0 æ˜¯ SD å¡ï¼Œå®¹é‡ä¸º 942.5 MBï¼Œä¸æˆ‘ä½¿ç”¨çš„ SD å¡ç›¸ç¬¦ï¼Œè¯´æ˜ SD å¡é©±åŠ¨æ­£å¸¸ã€‚</p><p>æ£€æŸ¥ mmc è®¾å¤‡ 1ï¼Œè¾“å…¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mmc list// åˆ—å‡ºå½“å‰çš„ MMC è®¾å¤‡</span><br><span class="line">mmc dev 1 // è½¬æ¢åˆ° MMC è®¾å¤‡ 1</span><br><span class="line">mmc info// æ‰“å° MMC è®¾å¤‡ä¿¡æ¯</span><br></pre></td></tr></table></figure><p><img src="image-20240702155007588.png" alt="image-20240702155007588"></p><p>ä»æ‰“å°ä¿¡æ¯çœ‹å‡ºï¼Œmmc è®¾å¤‡ 1 æ˜¯ EMMC å¡ï¼Œå®¹é‡ä¸º 3.6 GBï¼Œè¯´æ˜ EMMC å¡é©±åŠ¨æ­£å¸¸ã€‚</p><h5 id="lcd-é©±åŠ¨æ£€æŸ¥">LCD é©±åŠ¨æ£€æŸ¥</h5><p>ç”±ä¸Šé¢ uboot å¯åŠ¨ä¿¡æ¯å¯çŸ¥ï¼Œé»˜è®¤è®¾ç½®çš„ LCD å±å¹•å‚æ•°ä¸º NXP å®˜æ–¹ I.MX6ULL å¼€å‘æ¿çš„å±å¹•ï¼š4.3 å¯¸ 480x272 åˆ†è¾¨ç‡çš„ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹é©±åŠ¨ã€‚</p><p><img src="image-20240702155427332.png" alt="image-20240702155427332"></p><h5 id="ç½‘ç»œé©±åŠ¨">ç½‘ç»œé©±åŠ¨</h5><p>ç”±ä¸Šé¢ uboot å¯åŠ¨ä¿¡æ¯å¯çŸ¥ï¼Œç½‘ç»œé©±åŠ¨æœ‰é—®é¢˜ï¼Œè¿™æ˜¯å› ä¸º 100ask å¼€å‘æ¿çš„ç½‘ç»œèŠ¯ç‰‡å¤ä½å¼•è„šå’Œ NXP å®˜æ–¹å¼€å‘æ¿ä¸ä¸€æ ·ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹é©±åŠ¨ã€‚</p><h4 id="åœ¨-u-boot-ä¸­æ·»åŠ è‡ªå·±çš„å¼€å‘æ¿">åœ¨ U-Boot ä¸­æ·»åŠ è‡ªå·±çš„å¼€å‘æ¿</h4><p>NXP å®˜æ–¹ uboot ä¸­é»˜è®¤éƒ½æ˜¯ NXP è‡ªå·±çš„å¼€å‘æ¿ï¼Œè™½è¯´æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å®˜æ–¹çš„å¼€å‘æ¿ä¸Šç›´æ¥ä¿®æ”¹ï¼Œä½¿ uboot å¯ä»¥å®Œæ•´çš„è¿è¡Œåœ¨æˆ‘ä»¬çš„æ¿å­ä¸Šã€‚ä½†æ˜¯ä¸ºäº†å­¦ä¹ æ›´å¤šä¸œè¥¿ï¼Œæ¥ä¸‹æ¥å­¦ä¹ å¦‚ä½•åœ¨ uboot ä¸­æ·»åŠ æˆ‘ä»¬çš„å¼€å‘æ¿æˆ–å¼€å‘å¹³å°ã€‚</p><h5 id="æ·»åŠ å¼€å‘æ¿é»˜è®¤é…ç½®æ–‡ä»¶">æ·»åŠ å¼€å‘æ¿é»˜è®¤é…ç½®æ–‡ä»¶</h5><p>åœ¨ uboot æºç ä¸‹çš„ configs ç›®å½•ä¸‹åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd configs</span><br><span class="line">cp mx6ull_14x14_evk_emmc_defconfig mx6ull_obito_emmc_defconfig</span><br></pre></td></tr></table></figure><p>å¯¹ CONFIG_SYS_EXTRA_OPTIONS å’Œ CONFIG_TARGET_ ä¿®æ”¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SYS_EXTRA_OPTIONS=<span class="string">&quot;IMX_CONFIG=board/freescale/mx6ull_obito_emmc/imximage.cfg,MX6ULL_EVK_EMMC_REWORK&quot;</span> </span><br><span class="line">CONFIG_ARM=y</span><br><span class="line">CONFIG_ARCH_MX6=y</span><br><span class="line">CONFIG_TARGET_MX6ULL_OBITO_EMMC=y</span><br><span class="line">CONFIG_CMD_GPIO=y</span><br></pre></td></tr></table></figure><h5 id="æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„å¤´æ–‡ä»¶">æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„å¤´æ–‡ä»¶</h5><p>åœ¨ uboot æºç ä¸‹çš„ include/configs ç›®å½•ä¸‹æ·»åŠ è‡ªå·±å¼€å‘æ¿å¯¹åº”çš„å¤´æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp include/configs/mx6ullevk.h include/configs/mx6ull_obito_emmc.h</span><br></pre></td></tr></table></figure><p>æ‰“å¼€å¤´æ–‡ä»¶ä¿®æ”¹å®å®šä¹‰ï¼šè·Ÿæ–‡ä»¶åç›¸åŒï¼Œè¯¥æ–‡ä»¶ä¸»è¦æ˜¯ç”¨æ¥é…ç½®æˆ–è£å‰ª ubootã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿®æ”¹å‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __MX6ULLEVK_CONFIG_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __MX6ULLEVK_CONFIG_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹å</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __MX6ULL_OBITO_EMMC_CONFIG_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __MX6ULL_OBITO_EMMC_CONFIG_H</span></span><br></pre></td></tr></table></figure><h5 id="æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„æ¿çº§æ–‡ä»¶å¤¹">æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„æ¿çº§æ–‡ä»¶å¤¹</h5><p><strong>uboot ä¸­æ¯ä¸ªæ¿å­éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„æ–‡ä»¶å¤¹æ¥å­˜æ”¾æ¿çº§æ–‡ä»¶</strong>ï¼Œæ¯”å¦‚å¼€å‘æ¿ä¸Šå¤–è®¾é©±åŠ¨æ–‡ä»¶ç­‰ç­‰ã€‚NXP çš„ <a href="http://I.MX">I.MX</a> ç³»åˆ—èŠ¯ç‰‡çš„æ‰€æœ‰æ¿çº§æ–‡ä»¶å¤¹éƒ½å­˜æ”¾åœ¨ board/freescale ç›®å½•ä¸‹ï¼Œåœ¨è¿™ä¸ªç›®å½•ä¸‹æœ‰ä¸ªåä¸º mx6ullevk çš„æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹å°±æ˜¯ NXP å®˜æ–¹ I.MX6ULL EVK å¼€å‘æ¿çš„æ¿çº§æ–‡ä»¶å¤¹ã€‚å¤åˆ¶ mx6ullevkï¼Œå°†å…¶é‡å‘½åä¸ºè‡ªå·±å¼€å‘æ¿çš„åå­— mx6ull_obito_emmcï¼Œå‘½ä»¤å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd board/freescale/</span><br><span class="line">cp mx6ullevk/ -r mx6ull_obito_emmc</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶å¤¹ä¸‹æœ‰ä»¥ä¸‹æ–‡ä»¶ï¼š</p><p><img src="image-20240702204622788.png" alt="image-20240702204622788"></p><p>è¾“å…¥å‘½ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -nr <span class="string">&quot;mx6ullevk&quot;</span></span><br></pre></td></tr></table></figure><p><img src="image-20240702204827826.png" alt="image-20240702204827826"></p><p>é™¤äº† ixmimage_lpddr2.cfg æ–‡ä»¶æˆ‘ä»¬å°†å…¶ä»–æ–‡ä»¶ä¸­çš„ mx6ullevk å­—ç¬¦ä¸²è½¬æ¢æˆè‡ªå·±ç»™æ¿å­èµ·çš„åå­—ï¼šæˆ‘çš„æ˜¯ <code>mx6ull_obito_emmc</code>ï¼Œç„¶åæ‰“å¼€ Kconfig æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿®æ”¹å‰</span></span><br><span class="line"><span class="keyword">if</span> TARGET_MX6ULL_14X14_EVK || TARGET_MX6ULL_9X9_EVK</span><br><span class="line"></span><br><span class="line">config SYS_BOARD</span><br><span class="line"><span class="keyword">default</span> <span class="string">&quot;mx6ullevk&quot;</span></span><br><span class="line"></span><br><span class="line">config SYS_VENDOR</span><br><span class="line"><span class="keyword">default</span> <span class="string">&quot;freescale&quot;</span></span><br><span class="line"></span><br><span class="line">config SYS_CONFIG_NAME</span><br><span class="line"><span class="keyword">default</span> <span class="string">&quot;mx6ullevk&quot;</span></span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line">    </span><br><span class="line"><span class="comment">// ä¿®æ”¹å</span></span><br><span class="line"><span class="keyword">if</span> TARGET_MX6ULL_OBITO_EMMC</span><br><span class="line"></span><br><span class="line">config SYS_BOARD</span><br><span class="line"><span class="keyword">default</span> <span class="string">&quot;mx6ull_obito_emmc&quot;</span></span><br><span class="line"></span><br><span class="line">config SYS_VENDOR</span><br><span class="line"><span class="keyword">default</span> <span class="string">&quot;freescale&quot;</span></span><br><span class="line"></span><br><span class="line">config SYS_SOC</span><br><span class="line"><span class="keyword">default</span> <span class="string">&quot;mx6&quot;</span></span><br><span class="line"></span><br><span class="line">config SYS_CONFIG_NAME</span><br><span class="line"><span class="keyword">default</span> <span class="string">&quot;mx6ull_obito_emmc&quot;</span></span><br><span class="line"></span><br><span class="line">endif    </span><br></pre></td></tr></table></figure><h5 id="ä¿®æ”¹-u-boot-å›¾å½¢ç•Œé¢é…ç½®æ–‡ä»¶">ä¿®æ”¹ U-Boot å›¾å½¢ç•Œé¢é…ç½®æ–‡ä»¶</h5><p>ä¿®æ”¹æ–‡ä»¶ arch/arm/cpu/armv7/mx6/Kconfigï¼Œåœ¨ 207 è¡Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config TARGET_MX6ULL_OBITO_EMMC</span><br><span class="line">    <span class="type">bool</span> <span class="string">&quot;Support mx6ull_obito_emmc&quot;</span></span><br><span class="line">    select MX6ULL</span><br><span class="line">    select DM</span><br><span class="line">    select DM_THERMAL</span><br></pre></td></tr></table></figure><p>åœ¨æœ€åä¸€è¡Œçš„ #endif çš„å‰ä¸€è¡Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source <span class="string">&quot;board/freescale/mx6ull_obito_emmc/Kconfig&quot;</span></span><br></pre></td></tr></table></figure><p><img src="image-20240702210111971.png" alt="image-20240702210111971"></p><h5 id="ç¼–è¯‘æ–°çš„-u-boot-æµ‹è¯•">ç¼–è¯‘æ–°çš„ U-Boot æµ‹è¯•</h5><p>uboot æºç æ ¹ç›®å½•ä¸‹æ–°å»ºé»˜è®¤é…ç½®æ–‡ä»¶ï¼š <code>mx6ull_obito_emmc_defconfig</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">make ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- distclean</span><br><span class="line">make ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- mx6ull_obito_emmc_defconfig</span><br><span class="line">make V=1 ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- -j16</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹æƒé™å¹¶æ‰§è¡Œè„šæœ¬æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 mx6ull_obito_emmc.sh //ç»™äºˆå¯æ‰§è¡Œæƒé™ï¼Œä¸€æ¬¡å³å¯</span><br><span class="line">./mx6ull_obito_emmc.sh //è¿è¡Œè„šæœ¬ç¼–è¯‘uboot</span><br></pre></td></tr></table></figure><p>æ–°å»ºé»˜è®¤é…ç½®æ–‡ä»¶æ˜¯ä¸ºäº†æ–¹ä¾¿åç»­ä¿®æ”¹ç¼–è¯‘ ubootï¼Œç¼–è¯‘æˆåŠŸåæ˜¾ç¤ºï¼š</p><p><img src="image-20240702210559495.png" alt="image-20240702210559495"></p><h5 id="ä¿®æ”¹-lcd-é©±åŠ¨">ä¿®æ”¹ LCD é©±åŠ¨</h5><p>ä¿®æ”¹ LCD é©±åŠ¨ä¸€èˆ¬æ³¨æ„å‡ ç‚¹ï¼š</p><ul><li>LCD æ‰€ä½¿ç”¨çš„ GPIOï¼ŒæŸ¥çœ‹ uboot ä¸­ LCD çš„ IO é…ç½®æ˜¯å¦æ­£ç¡®ã€‚</li><li>LCD èƒŒå…‰å¼•è„š GPIO çš„é…ç½®ã€‚</li><li>LCD é…ç½®å‚æ•°æ˜¯å¦æ­£ç¡®ã€‚</li></ul><p>100ask å¼€å‘æ¿ LCD åŸç†å›¾å’Œ NXP å®˜æ–¹I.MX6ULL å¼€å‘æ¿ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯ LCD çš„ IO å’ŒèƒŒå…‰ IO éƒ½ä¸€æ ·çš„ï¼Œæ‰€ä»¥ IO éƒ¨åˆ†å°±ä¸ç”¨ä¿®æ”¹äº†ã€‚åªéœ€è¦ä¿®æ”¹ LCD é…ç½®å‚æ•°å³å¯ã€‚</p><p>æ‰“å¼€ä¹‹å‰æ–°å»ºçš„æ¿çº§æ–‡ä»¶å¤¹ board/freescale/mx6ull_obito_emmcï¼Œæ‰¾åˆ° <code>display_info_t</code> ç»“æ„ä½“ï¼Œä¿®æ”¹ LCD å‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿®æ”¹å‰</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">display_info_t</span> <span class="title">const</span> <span class="title">displays</span>[] =</span> &#123;&#123;</span><br><span class="line">        .bus = MX6UL_LCDIF1_BASE_ADDR,</span><br><span class="line">        .addr = <span class="number">0</span>,</span><br><span class="line">        .pixfmt = <span class="number">24</span>,</span><br><span class="line">        .detect = <span class="literal">NULL</span>,</span><br><span class="line">        .enable = do_enable_parallel_lcd,</span><br><span class="line">        .mode   = &#123;</span><br><span class="line">                .name                   = <span class="string">&quot;TFT43AB&quot;</span>,</span><br><span class="line">                .xres           = <span class="number">480</span>,</span><br><span class="line">                .yres           = <span class="number">272</span>,</span><br><span class="line">                .pixclock       = <span class="number">108695</span>,</span><br><span class="line">                .left_margin    = <span class="number">8</span>,</span><br><span class="line">                .right_margin   = <span class="number">4</span>,</span><br><span class="line">                .upper_margin   = <span class="number">2</span>,</span><br><span class="line">                .lower_margin   = <span class="number">4</span>,</span><br><span class="line">                .hsync_len      = <span class="number">41</span>,             </span><br><span class="line">                .vsync_len      = <span class="number">10</span>,</span><br><span class="line">                .sync           = <span class="number">0</span>,</span><br><span class="line">                .vmode          = FB_VMODE_NONINTERLACED</span><br><span class="line">&#125; &#125; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹å</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">display_info_t</span> <span class="title">const</span> <span class="title">displays</span>[] =</span> &#123;&#123;</span><br><span class="line">        .bus = MX6UL_LCDIF1_BASE_ADDR,</span><br><span class="line">        .addr = <span class="number">0</span>,</span><br><span class="line">        .pixfmt = <span class="number">24</span>,</span><br><span class="line">        .detect = <span class="literal">NULL</span>,</span><br><span class="line">        .enable = do_enable_parallel_lcd,</span><br><span class="line">        .mode   = &#123;</span><br><span class="line">              .name = <span class="string">&quot;TFT7016&quot;</span>,</span><br><span class="line">                .xres = <span class="number">1024</span>,</span><br><span class="line">                .yres = <span class="number">600</span>,</span><br><span class="line">                .pixclock = <span class="number">19531</span>,</span><br><span class="line">                .left_margin = <span class="number">140</span>, <span class="comment">//HBPD</span></span><br><span class="line">                .right_margin = <span class="number">160</span>, <span class="comment">//HFPD</span></span><br><span class="line">                .upper_margin = <span class="number">20</span>, <span class="comment">//VBPD</span></span><br><span class="line">                .lower_margin = <span class="number">12</span>, <span class="comment">//VFBD</span></span><br><span class="line">                .hsync_len = <span class="number">20</span>, <span class="comment">//HSPW</span></span><br><span class="line">                .vsync_len = <span class="number">3</span>, <span class="comment">//VSPW</span></span><br><span class="line">                .sync = <span class="number">0</span>,</span><br><span class="line">                .vmode = FB_VMODE_NONINTERLACED</span><br><span class="line">&#125; &#125; &#125;;</span><br></pre></td></tr></table></figure><p>æ‰“å¼€å¼€å‘æ¿å¯¹åº”çš„å¤´æ–‡ä»¶ï¼šinclude/configs/mx6ull_obito_emmc.h</p><p>å°† panel=TFT43AB å…¨éƒ¨ä¿®æ”¹ä¸º panel=TFT7016ï¼Œpanel çš„å€¼è¦ä¸ <code>display_info_t</code> ç»“æ„ä½“çš„ .name ä¸€è‡´ã€‚</p><h5 id="ä¿®æ”¹æœ‰çº¿ç½‘ç»œé©±åŠ¨">ä¿®æ”¹æœ‰çº¿ç½‘ç»œé©±åŠ¨</h5><p>æˆ‘ä»¬è¦ä¿®æ”¹ENET1 ç½‘ç»œé©±åŠ¨çš„è¯é‡ç‚¹å°±ä¸‰ç‚¹ï¼š<br>â‘ ã€ENET1 å¤ä½å¼•è„šåˆå§‹åŒ–ã€‚<br>â‘¡ã€LAN8720A çš„å™¨ä»¶IDã€‚<br>â‘¢ã€LAN8720 é©±åŠ¨</p><p>IMX6ULLæœ‰ä¸¤ä¸ªç½‘ç»œå¤–è®¾ï¼Œåˆ†åˆ«ä¸ºENET1å’ŒENET2ï¼Œ100askå¼€å‘æ¿ä½¿ç”¨LAN8720Aä½œä¸ºPHYèŠ¯ç‰‡ï¼Œæ¥åœ¨äº†ENET2ä¸Šï¼ŒLAN8720AèŠ¯ç‰‡æœ‰ä¸€ä¸ªåœ°å€å¼•è„šï¼ŒRXER/PHYAD0ï¼Œåœ¨å¼€å‘æ¿ä¸Šæ¥åˆ°äº†é«˜ç”µå¹³ï¼Œæ‰€ä»¥ LAN8720A çš„ç½‘ç»œPHYåœ°å€ä¸º1ï¼ŒRESETå¼•è„šæ¥åœ¨äº†SNVS_TAMPER6ä¸Šï¼Œç”±äºPHYç½‘ç»œèŠ¯ç‰‡æœ‰è§„å®šï¼Œæ‰€æœ‰PHYèŠ¯ç‰‡å‰16ä¸ªå¯„å­˜å™¨éƒ½æ˜¯ä¸€æ ·çš„åŠŸèƒ½ï¼Œå¹¶ä¸”ä½¿ç”¨è¿™16ä¸ªå¯„å­˜å™¨å°±å¯ä»¥è®©ç½‘ç»œæ­£å¸¸å·¥ä½œï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸‰ä¸ªåœ°æ–¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMD_NET</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_CMD_PING</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_CMD_DHCP</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_CMD_MII</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_FEC_MXC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_MII</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_FEC_ENET_DEV1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (CONFIG_FEC_ENET_DEV == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMX_FEC_BASEENET_BASE_ADDR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_FEC_MXC_PHYADDR          0x2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_FEC_XCV_TYPE             RMII</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> (CONFIG_FEC_ENET_DEV == 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IMX_FEC_BASEENET2_BASE_ADDR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_FEC_MXC_PHYADDR0x1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_FEC_XCV_TYPERMII</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_ETHPRIME<span class="string">&quot;FEC&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_PHYLIB</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_PHY_MICREL</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>setenv ipaddr 192.168.1.7 <br>setenv ethaddr 00:04:9f:04:d2:35<br>setenv gatewayip 192.168.1.1 <br>setenv netmask 255.255.255.0 <br>setenv serverip 192.168.1.5 <br>saveenv</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">setenv ipaddr 192.168.1.7 //å¼€å‘æ¿IPåœ°å€</span><br><span class="line">setenv ethaddr 00:04:9f:04:d2:35 //å¼€å‘æ¿ç½‘å¡MACåœ°å€</span><br><span class="line">setenv gatewayip 192.168.1.1 //å¼€å‘æ¿é»˜è®¤ç½‘å…³</span><br><span class="line">setenv netmask 255.255.255.0 //å¼€å‘æ¿å­ç½‘æ©ç </span><br><span class="line">setenv serverip 192.168.1.5 //æœåŠ¡å™¨åœ°å€ï¼Œä¹Ÿå°±æ˜¯Ubuntu åœ°å€</span><br><span class="line">saveenv //ä¿å­˜ç¯å¢ƒå˜é‡</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼åªèƒ½åœ¨uboot ä¸­ping å…¶ä»–çš„æœºå™¨ï¼Œå…¶ä»–æœºå™¨ä¸èƒ½ping ubootï¼Œå› ä¸ºuboot æ²¡æœ‰å¯¹ping<br>å‘½ä»¤åšå¤„ç†ï¼Œå¦‚æœç”¨å…¶ä»–çš„æœºå™¨ping uboot çš„è¯ä¼šå¤±è´¥ï¼</p><h5 id="å†æ¬¡ç¼–è¯‘çƒ§å½•-u-boot">å†æ¬¡ç¼–è¯‘çƒ§å½• U-Boot</h5><p>uboot å¯åŠ¨ä»¥åä¼šå…ˆä» EMMC ä¸­è¯»å–ç¯å¢ƒå˜é‡ï¼Œå¦‚æœ EMMC ä¸­æ²¡æœ‰ç¯å¢ƒå˜é‡çš„è¯æ‰ä¼šä½¿ç”¨ <code>mx6ull_obito_emmc.h</code> çš„é»˜è®¤ç¯å¢ƒå˜é‡ã€‚</p><p>åœ¨ uboot å‘½ä»¤æ¨¡å¼ä¸‹è¾“å…¥å¦‚ä¸‹å‘½ä»¤ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenv panel TFT7016</span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure><p>ä¿å­˜é‡å¯ ubootï¼ŒLCD é©±åŠ¨å°±èƒ½å·¥ä½œæ­£å¸¸äº†ã€‚</p><h3 id="u-boot-ä¸€äº›é‡è¦çš„ç¯å¢ƒå˜é‡">U-Boot ä¸€äº›é‡è¦çš„ç¯å¢ƒå˜é‡</h3><h4 id="bootcmd-ç¯å¢ƒå˜é‡">bootcmd ç¯å¢ƒå˜é‡</h4><p>bootcmd ä¿å­˜ U-Boot å¯åŠ¨æ—¶æ‰§è¡Œçš„çš„å‘½ä»¤åºåˆ—ï¼Œä¸€èˆ¬ç”¨æ¥å¯åŠ¨å†…æ ¸å’ŒåŠ è½½æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚è¯»å– EMMC æˆ–è€… NAND Flash ä¸­çš„ Linux å†…æ ¸é•œåƒæ–‡ä»¶å’Œè®¾å¤‡æ ‘æ–‡ä»¶åˆ° DRAM ä¸­ï¼Œç„¶åå¯åŠ¨ Linux å†…æ ¸ã€‚è‹¥ EMMC æˆ–è€… NAND ä¸­æ²¡æœ‰ä¿å­˜ bootcmd çš„å€¼ï¼Œåˆ™ uboot å°±ä¼šä» <code>include/env_default.h</code> æ–‡ä»¶ä¸­è¯»å– bootcmd çš„é»˜è®¤å€¼ã€‚</p><p>ä¾‹å¦‚ uboot ä½¿ç”¨ run å‘½ä»¤æ¥è¿è¡Œ findfdt å˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define CONFIG_BOOTCOMMAND \</span></span><br><span class="line"><span class="language-bash">           <span class="string">&quot;run findfdt;&quot;</span> \</span></span><br><span class="line"><span class="language-bash">           <span class="string">&quot;mmc dev <span class="variable">$&#123;mmcdev&#125;</span>;&quot;</span> \</span></span><br><span class="line"><span class="language-bash">           <span class="string">&quot;mmc dev <span class="variable">$&#123;mmcdev&#125;</span>; if mmc rescan; then &quot;</span> \</span></span><br><span class="line"><span class="language-bash">                   <span class="string">&quot;if run loadbootscript; then &quot;</span> \</span></span><br><span class="line"><span class="language-bash">                           <span class="string">&quot;run bootscript; &quot;</span> \</span></span><br><span class="line"><span class="language-bash">                   <span class="string">&quot;else &quot;</span> \</span></span><br><span class="line"><span class="language-bash">                           <span class="string">&quot;if run loadimage; then &quot;</span> \</span></span><br><span class="line"><span class="language-bash">                                   <span class="string">&quot;run mmcboot; &quot;</span> \</span></span><br><span class="line"><span class="language-bash">                           <span class="string">&quot;else run netboot; &quot;</span> \</span></span><br><span class="line"><span class="language-bash">                           <span class="string">&quot;fi; &quot;</span> \</span></span><br><span class="line"><span class="language-bash">                   <span class="string">&quot;fi; &quot;</span> \</span></span><br><span class="line"><span class="language-bash">           <span class="string">&quot;else run netboot; fi&quot;</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">endif</span></span><br></pre></td></tr></table></figure><p>findfdt æ˜¯ NXP è‡ªè¡Œæ·»åŠ çš„ç¯å¢ƒå˜é‡ï¼Œç”¨æ¥<strong>æŸ¥æ‰¾å¼€å‘æ¿å¯¹åº”çš„è®¾å¤‡æ ‘æ–‡ä»¶</strong>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;findfdt=&quot;\</span><br><span class="line">        &quot;if test $fdt_file = undefined; then &quot; \</span><br><span class="line">                &quot;if test $board_name = EVK &amp;&amp; test $board_rev = 9X9; then &quot; \</span><br><span class="line">                        &quot;setenv fdt_file imx6ull-9x9-evk.dtb; fi; &quot; \</span><br><span class="line">                &quot;if test $board_name = EVK &amp;&amp; test $board_rev = 14X14; then &quot; \</span><br><span class="line">                        &quot;setenv fdt_file imx6ull-14x14-evk.dtb; fi; &quot; \</span><br><span class="line">                &quot;if test $fdt_file = undefined; then &quot; \</span><br><span class="line">                        &quot;echo WARNING: Could not determine dtb to use; fi; &quot; \</span><br><span class="line">        &quot;fi;\0&quot; \</span><br></pre></td></tr></table></figure><ul><li>mmc dev ${mmcdev} ç”¨äºåˆ‡æ¢ mmc è®¾å¤‡ï¼Œmmcdev ä¸º 1ï¼Œ<code>mmc dev 1</code> åˆ‡æ¢åˆ° EMMC ä¸Šã€‚</li><li>mmc rescan æ‰«æçœ‹æœ‰æ²¡æœ‰ SD å¡æˆ–è€… EMMC å­˜åœ¨</li><li>mmc è®¾å¤‡å­˜åœ¨çš„è¯åˆ™è¿è¡Œ loadbootscript ç¯å¢ƒå˜é‡ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadbootscript=fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;loadaddr&#125; $&#123;script&#125;;</span><br></pre></td></tr></table></figure><p>mmcdev = 1ï¼Œmmcpart = 1ï¼Œloadaddr = 0x80800000ï¼Œscript = boot.scrï¼Œå±•å¼€å°±æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadbootscript=fatload mmc 1:1 0x80800000 boot.scr;</span><br></pre></td></tr></table></figure><p>loadbootscript å°±æ˜¯ä» mmc1 çš„åˆ†åŒº 1 ä¸­è¯»å–æ–‡ä»¶ boot.src åˆ° DRAM çš„ 0X80800000 å¤„ï¼ŒåŠ è½½æˆåŠŸåˆ™è¿è¡Œ bootscript ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bootscript=echo Running bootscript from mmc ...;</span><br><span class="line">source</span><br></pre></td></tr></table></figure><p>å¦‚æœ loadbootscript æ²¡æœ‰æ‰¾åˆ° boot.src åˆ™è¿è¡Œç¯å¢ƒå˜é‡ loadimageï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadimage=fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;loadaddr&#125; $&#123;image&#125;</span><br></pre></td></tr></table></figure><p>mmcdev=1ï¼Œmmcpart=1ï¼Œloadaddr=0x80800000ï¼Œimage = zImageï¼Œå±•å¼€å°±æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadimage=fatload mmc 1:1 0x80800000 zImage</span><br></pre></td></tr></table></figure><p>loadimage å°±æ˜¯ä» mmc1 çš„åˆ†åŒºä¸­è¯»å– zImage åˆ°å†…å­˜çš„ 0X80800000 å¤„ï¼ŒåŠ è½½ linux é•œåƒæ–‡ä»¶ zImage æˆåŠŸå°±è¿è¡Œç¯å¢ƒå˜é‡ mmcbootï¼šmmcargs æ˜¯ç”¨æ¥è®¾ç½® bootargs ç¯å¢ƒå˜é‡çš„ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&quot;mmcboot=echo Booting from mmc ...; &quot; \</span><br><span class="line">               &quot;run mmcargs; &quot; \</span><br><span class="line">               &quot;if test $&#123;boot_fdt&#125; = yes || test $&#123;boot_fdt&#125; = try; then &quot; \</span><br><span class="line">                       &quot;if run loadfdt; then &quot; \</span><br><span class="line">                               &quot;bootz $&#123;loadaddr&#125; - $&#123;fdt_addr&#125;; &quot; \</span><br><span class="line">                       &quot;else &quot; \</span><br><span class="line">                               &quot;if test $&#123;boot_fdt&#125; = try; then &quot; \</span><br><span class="line">                                       &quot;bootz; &quot; \</span><br><span class="line">                               &quot;else &quot; \</span><br><span class="line">                                       &quot;echo WARN: Cannot load the DT; &quot; \</span><br><span class="line">                               &quot;fi; &quot; \</span><br><span class="line">                       &quot;fi; &quot; \</span><br><span class="line">               &quot;else &quot; \</span><br><span class="line">                       &quot;bootz; &quot; \</span><br><span class="line">               &quot;fi;\0&quot; \</span><br></pre></td></tr></table></figure><p>ç¯å¢ƒå˜é‡ loadfdtï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadfdt=fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;fdt_addr&#125; $&#123;fdt_file&#125;</span><br></pre></td></tr></table></figure><p>å±•å¼€å°±æ˜¯ï¼šä»mmc1 çš„åˆ†åŒº 1 ä¸­è¯»å– imx6ull-14x14-evk.dtb æ–‡ä»¶å¹¶æ”¾åˆ°å†…å­˜çš„ 0x83000000 å¤„d</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadfdt=fatload mmc 1:1 0x83000000 imx6ull-14x14-evk.dtb</span><br></pre></td></tr></table></figure><p>è¯»å–è®¾å¤‡æ ‘æ–‡ä»¶æˆåŠŸåˆ™è°ƒç”¨å‘½ä»¤ bootz å¯åŠ¨ linuxï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootz $&#123;loadaddr&#125; - $&#123;fdt_addr&#125;</span><br></pre></td></tr></table></figure><p>å±•å¼€å°±æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootz 0x80800000 - 0x83000000 (æ³¨æ„â€˜-â€™å‰åè¦æœ‰ç©ºæ ¼)</span><br></pre></td></tr></table></figure><p>**è‡³æ­¤ Linux å†…æ ¸å¯åŠ¨å®Œæ¯•ï¼Œåˆ†æå¯çŸ¥æ­¥éª¤å¦‚ä¸‹ï¼š**4 è¡Œç²¾å</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mmc dev 1 // åˆ‡æ¢åˆ°EMMC</span><br><span class="line">fatload mmc 1:1 0x80800000 zImage // è¯»å– zImageåˆ° 0x80800000 å¤„</span><br><span class="line">fatload mmc 1:1 0x83000000 imx6ull-14x14-evk.dtb // è¯»å–è®¾å¤‡æ ‘åˆ° 0x83000000 å¤„</span><br><span class="line">bootz 0x80800000 - 0x83000000 // å¯åŠ¨Linux</span><br></pre></td></tr></table></figure><p>NXP å®˜æ–¹å°† CONFIG_BOOTCOMMAND å†™å¤æ‚æ˜¯ä¸ºäº†å…¼å®¹å¤šä¸ªæ¿å­ï¼Œå½“æˆ‘ä»¬æ˜ç¡®æ‰¾åˆ°è‡ªå·±æ‰€ä½¿ç”¨çš„æ¿å­å°±å¯ä»¥ç®€åŒ–ä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define CONFIG_BOOTCOMMAND \</span></span><br><span class="line"><span class="language-bash">    <span class="string">&quot;mmc dev 1;&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    <span class="string">&quot;fatload mmc 1:1 0x80800000 zImage;&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    <span class="string">&quot;fatload mmc 1:1 0x83000000 imx6ull-14x14-evk.dtb;&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    <span class="string">&quot;bootz 0x80800000 - 0x83000000;&quot;</span></span></span><br></pre></td></tr></table></figure><p>æˆ–è€…å¯ä»¥ç›´æ¥åœ¨ uboot å¯åŠ¨æ—¶è®¾ç½® bootcmd çš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯ç›´æ¥ä¿å­˜åˆ° EMMC ä¸­çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenv bootcmd &#x27;mmc dev 1; fatload mmc 1:1 80800000 zImage; fatload mmc 1:1 83000000 imx6ull-14x14-evk.dtb; bootz 80800000 - 83000000;&#x27;</span><br></pre></td></tr></table></figure><h4 id="bootargs-ç¯å¢ƒå˜é‡">bootargs ç¯å¢ƒå˜é‡</h4><p>bootargs ä¿å­˜ uboot ä¼ é€’ç»™ linux å†…æ ¸çš„å‚æ•°ï¼Œè¿™äº›å‚æ•°å¯ä»¥æ§åˆ¶å†…æ ¸çš„å¯åŠ¨è¡Œä¸ºï¼Œä¾‹å¦‚å†…å­˜è®¾ç½®ã€æ§åˆ¶å°é…ç½®ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹ç­‰ã€‚</p><p>bootargs ç¯å¢ƒå˜é‡æ˜¯ç”± mmcargs è®¾ç½®çš„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmcargs=setenv bootargs console=$&#123;console&#125;,$&#123;baudrate&#125; root=$&#123;mmcroot&#125;</span><br></pre></td></tr></table></figure><p>console=ttymxc0ï¼Œbaudrate=115200ï¼Œmmcroot=/dev/mmcblk1p2 rootwait rwï¼Œå±•å¼€å°±æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmcargs=setenv bootargs console=ttymxc0, 115200 root=/dev/mmcblk1p2 rootwait rw</span><br></pre></td></tr></table></figure><ul><li>console=ttymxc0, 115200ï¼šè®¾ç½® ttymxc0ï¼ˆä¸²å£ 1ï¼‰ä½œä¸º linux ç»ˆç«¯ï¼Œæ³¢ç‰¹ç‡ä¸º 115200ã€‚</li><li>root=/dev/mmcblk1p2 rootwait rwï¼šè¡¨ç¤ºæ ¹æ–‡ä»¶ç³»ç»Ÿå­˜æ”¾åœ¨ mmcblk1 è®¾å¤‡çš„åˆ†åŒº 2 ä¸­ï¼Œrootwait rw è¡¨ç¤ºç­‰å¾… mmc è®¾å¤‡åˆå§‹åŒ–å®Œæˆä»¥åå†æŒ‚è½½ï¼Œrw è¡¨ç¤ºæ ¹æ–‡ä»¶ç³»ç»Ÿå¯ä»¥è¯»å†™ã€‚</li></ul><p>bootargs å°±æ˜¯è®¾ç½®äº†å¾ˆå¤šçš„å‚æ•°çš„å€¼ï¼Œç»™ linux å†…æ ¸ç”¨ï¼Œå¸¸ç”¨å‚æ•°æœ‰ï¼š</p><ul><li>consoleï¼šlinux ç»ˆç«¯ï¼Œä¹Ÿå«æ§åˆ¶å°ï¼Œä¸€èˆ¬ uboot é»˜è®¤éƒ½æœ‰è®¾ç½®ä¸²å£ä½œä¸º linux ç»ˆç«¯ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡ä¸²å£åœ¨ PC æœºä½¿ç”¨ç»ˆç«¯è½¯ä»¶è¿›è¡Œäº¤äº’äº†ã€‚è®¾ç½® console ä¸º ttymxc0ï¼Œè¿™æ˜¯å› ä¸º linux å¯åŠ¨å å¼€å‘æ¿ä¸²å£ 1 åœ¨ linux ä¸‹çš„è®¾å¤‡æ–‡ä»¶å°±æ˜¯ /dev/ttymxc0ã€‚</li><li>root ç”¨æ¥è®¾ç½®æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ä½ç½®ã€‚</li><li>rootfstype ç”¨äºæŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œè‹¥æ ¹æ–‡ä»¶å­ç³»ç»Ÿä¸º ext æ ¼å¼ï¼Œåˆ™ä¸ç”¨è®¾ç½®ã€‚</li></ul><h3 id="u-boot-å¯åŠ¨-linux-æµ‹è¯•">U-Boot å¯åŠ¨ Linux æµ‹è¯•</h3><h4 id="ç½‘ç»œå¯åŠ¨">ç½‘ç»œå¯åŠ¨</h4><p>ç½‘ç»œå¯åŠ¨ç³»ç»Ÿä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œä¸ç”¨é¢‘ç¹åœ°çƒ§å†™ EMMCï¼ŒåŠ å¿«å¼€å‘é€Ÿåº¦ã€‚ä¸€èˆ¬ä½¿ç”¨ tftp æœåŠ¡åŠ è½½ zImage å’Œ dtb æ–‡ä»¶ï¼Œè®¾ç½® bootcmd å’Œ bootargs ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;console=ttymxc0,115200 root=/dev/mmcblk1p2 rootwait rw&#x27;</span><br><span class="line"></span><br><span class="line">setenv bootcmd &#x27;tftp 80800000 zImage; tftp 83000000 100ask_imx6ull-14x14.dtb; bootz</span><br><span class="line">80800000 - 83000000&#x27;</span><br><span class="line"></span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure><h4 id="emmc-å¯åŠ¨">EMMC å¯åŠ¨</h4><p>EMMC å¯åŠ¨çš„è¯ï¼Œéœ€è¦å‘ EMMC åˆ†åŒºæå‰å­˜æ”¾å·²çŸ¥å¥½çš„ zImage å’Œ dtb æ–‡ä»¶ï¼Œç„¶åè®¾ç½® bootcmd å’Œ bootargs ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;console=ttymxc0,115200 root=/dev/mmcblk1p2 rootwait rw&#x27;</span><br><span class="line"></span><br><span class="line">setenv bootcmd &#x27;mmc dev 1; fatload mmc 1:1 80800000 zImage; fatload mmc 1:1 83000000</span><br><span class="line">100ask_imx6ull-14x14.dtb; bootz 80800000 - 83000000;&#x27;</span><br><span class="line"></span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure><h2 id="linux-å†…æ ¸ç§»æ¤">Linux å†…æ ¸ç§»æ¤</h2><p><em><strong>ä¸€å¼€å§‹ç”¨çš„ 4.1.15 ç‰ˆæœ¬ï¼Œåé¢å‘ç° 100ask äº¤å‰ç¼–è¯‘å™¨æ”¯æŒä¸äº†è¯¥ç‰ˆæœ¬ï¼Œå¯¼è‡´æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½æ—¶ï¼Œå†…æ ¸å´©æºƒï¼Œåæ”¹ç”¨ 4.9.88 ç‰ˆæœ¬ï¼Œè¿™äº› Linux æºç éƒ½æ˜¯ NXP æ”¹ç‰ˆé€‚é…åçš„æºç ã€‚</strong></em></p><blockquote><p><a href="https://github.com/nxp-imx/linux-imx/tree/imx_4.9.88_2.0.0_ga">nxp-imx/linux-imx at imx_4.9.88_2.0.0_ga (github.com)</a></p></blockquote><p>è¯¥ç‰ˆæœ¬ä¸‹æ²¡æœ‰å¸¦ mfg çš„ imx_v7_mfg_defconfig æ–‡ä»¶ï¼Œåªæœ‰ imx_v7_defconfig æ–‡ä»¶ã€‚</p><h3 id="ç¼–è¯‘-nxp-å®˜æ–¹å¼€å‘æ¿çš„-linux-å†…æ ¸">ç¼–è¯‘ NXP å®˜æ–¹å¼€å‘æ¿çš„ Linux å†…æ ¸</h3><h4 id="ç¼–è¯‘æµ‹è¯•">ç¼–è¯‘æµ‹è¯•</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- imx_v7_defconfig // é…ç½®linuxå†…æ ¸</span><br><span class="line">make ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- -j16</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆåä¼šåœ¨ <code>arch/arm/boot</code> ç›®å½•ä¸‹ç”Ÿæˆ zImage é•œåƒæ–‡ä»¶ï¼Œå¦‚æœä½¿ç”¨è®¾å¤‡æ ‘çš„è¯è¿˜ä¼šåœ¨ <code>arh/arm/boot/dts</code> ç›®å½•ä¸‹ç”Ÿæˆå¼€å‘æ¿å¯¹åº”çš„è®¾å¤‡æ ‘æ–‡ä»¶ã€‚</p><ul><li>Linux å†…æ ¸é•œåƒæ–‡ä»¶ï¼šzImage</li><li>è®¾å¤‡æ ‘æ–‡ä»¶ï¼šimx6ull-14x14-evk.dtb</li></ul><p>å°†ä¸¤ä¸ªæ–‡ä»¶å¤åˆ¶åˆ° Ubuntu çš„ tftp ç›®å½•ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp arch/arm/boot/zImage ~/tftpboot/</span><br><span class="line">cp arch/arm/boot/dts/imx6ull-14x14-evk.dtb  ~/tftpboot/</span><br></pre></td></tr></table></figure><p>uboot å‘½ä»¤è¡Œæ¨¡å¼ä¸‹ä½¿ç”¨ tftp åŠ è½½ zImage å’Œ imx6ull-14x14-evk.dtb</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tftp 80800000 zImage</span><br><span class="line">tftp 83000000 imx6ull-14x14-evk.dtb</span><br><span class="line">bootz 80800000 - 83000000</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿˜æ²¡æœ‰æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ä¼šæ˜¾ç¤ºä»¥ä¸‹ä¿¡æ¯å¹¶å¡ä½â€”â€”Linux å†…æ ¸å´©æºƒï¼Œé‡å¯è¿›å…¥ uboot å³å¯ã€‚</p><p><img src="image-20240704163256225.png" alt="image-20240704163256225"></p><blockquote><p>ä¹Ÿå°±æ˜¯æç¤ºå†…æ ¸å´©æºƒï¼Œå› ä¸º VFS(è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ)ä¸èƒ½æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå› ä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•ä¸å­˜åœ¨ã€‚å³ä½¿æ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•å­˜åœ¨ï¼Œå¦‚æœæ ¹æ–‡ä»¶ç³»ç»Ÿç›®å½•é‡Œé¢æ˜¯ç©ºçš„ä¾æ—§ä¼šæç¤ºå†…æ ¸å´©æºƒã€‚è¿™ä¸ªå°±æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿç¼ºå¤±å¯¼è‡´çš„å†…æ ¸å´©æºƒï¼Œä½†æ˜¯å†…æ ¸æ˜¯å¯åŠ¨äº†çš„ï¼Œåªæ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿä¸å­˜åœ¨è€Œå·²ã€‚</p></blockquote><h3 id="æ·»åŠ è‡ªå·±çš„å¼€å‘æ¿">æ·»åŠ è‡ªå·±çš„å¼€å‘æ¿</h3><h4 id="æ·»åŠ å¼€å‘æ¿é»˜è®¤é…ç½®æ–‡ä»¶">æ·»åŠ å¼€å‘æ¿é»˜è®¤é…ç½®æ–‡ä»¶</h4><p>å¤åˆ¶ imx_v7_defconfig æ–‡ä»¶é‡æ–°å‘½åã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd arch/arm/configs</span><br><span class="line">cp imx_v7_defconfig imx_obito_emmc_defconfig</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„è®¾å¤‡æ ‘æ–‡ä»¶">æ·»åŠ å¼€å‘æ¿å¯¹åº”çš„è®¾å¤‡æ ‘æ–‡ä»¶</h4><p>å¤åˆ¶ imx6ull-14x14-evk.dts æ–‡ä»¶é‡æ–°å‘½åã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd arch/arm/boot/dts</span><br><span class="line">cp imx6ull-14x14-evk.dts imx6ull-obito-emmc.dts</span><br></pre></td></tr></table></figure><p>.dts æ˜¯è®¾å¤‡æ ‘æºç ï¼Œç¼–è¯‘åå˜ä¸º .dtb æ–‡ä»¶ï¼Œå› æ­¤éœ€è¦åœ¨ <code>arch/arm/boot/dts/Makefile</code> æ‰¾åˆ° <code>dtb- $(CONFIG_SOC_IMX6ULL)</code> é…ç½®é¡¹ï¼Œåœ¨æ­¤é…ç½®é¡¹ä¸­åŠ å…¥ <code>imx6ull-obito-emmc.dtb</code></p><h4 id="ç¼–è¯‘æµ‹è¯•">ç¼–è¯‘æµ‹è¯•</h4><p>æ”¾äº†æ–¹ä¾¿è°ƒè¯•ï¼Œæ–°å»ºä¸€ä¸ªç¼–è¯‘è„šæœ¬æ–‡ä»¶ <code>imx6ull_obito_emmc.sh</code> ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">make ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- distclean</span><br><span class="line">make ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- imx_obito_emmc_defconfig</span><br><span class="line">make V=1 ARCH=arm CROSS_COMPILE=arm-buildroot-linux-gnueabihf- -j16</span><br></pre></td></tr></table></figure><p>æ·»åŠ æƒé™åæ‰§è¡Œè„šæœ¬æ–‡ä»¶ç¼–è¯‘ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 imx6ull_obito_emmc.sh</span><br><span class="line">./imx6ull_obito_emmc.sh</span><br></pre></td></tr></table></figure><p>å°†ç¼–è¯‘ç”Ÿæˆ zImage å’Œè®¾å¤‡æ ‘å¤åˆ¶åˆ° tftp ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp arch/arm/boot/zImage ~/tftpboot/</span><br><span class="line">cp arch/arm/boot/dts/imx6ull-obito-emmc.dtb ~/tftpboot/</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ tftp åŠ è½½ zImage å’Œ è®¾å¤‡æ ‘</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tftp 80800000 zImage</span><br><span class="line">tftp 83000000 imx6ull-obito-emmc.dtb</span><br><span class="line">bootz 80800000 - 83000000</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æˆåŠŸè¯´æ˜å·²ç»æˆåŠŸåœ¨ NXP æä¾›çš„ Linux å†…æ ¸æºç æ·»åŠ äº†è‡ªå·±çš„å¼€å‘æ¿ã€‚åŒæ ·å› ä¸ºè¿˜æ²¡æœ‰æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œé‡å¯è¿›å…¥ uboot å³å¯ã€‚</p><h3 id="ä¿®æ”¹é©±åŠ¨">ä¿®æ”¹é©±åŠ¨</h3><h4 id="cpu-ä¸»é¢‘">CPU ä¸»é¢‘</h4><p>CPU ä¸»é¢‘è¿™é‡Œä¸ä½œä¿®æ”¹ï¼Œå¯ä»¥ä½¿ç”¨ make menuconfig è¿›å…¥ Linux å†…æ ¸å›¾å½¢åŒ–ç•Œé¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CPU Power Management</span><br><span class="line">    -&gt; CPU Frequency scaling</span><br><span class="line">    -&gt; Default CPUFreq governor</span><br></pre></td></tr></table></figure><p>CPU æ”¯æŒ 198MHzã€396MHzã€528MHz å’Œ 792MHz å››ä¸ªæ¨¡å¼ï¼š</p><ul><li>Performanceï¼šæœ€é«˜æ€§èƒ½ï¼Œç›´æ¥ç”¨æœ€é«˜é¢‘ç‡ï¼Œä¸è€ƒè™‘è€—ç”µã€‚</li><li>Interactiveï¼šä¸€å¼€å§‹ç›´æ¥ç”¨æœ€é«˜é¢‘ç‡ï¼Œç„¶åæ ¹æ® CPU è´Ÿè½½æ…¢æ…¢é™ä½ã€‚</li><li>Powersaveï¼šçœç”µæ¨¡å¼ï¼Œé€šå¸¸ä»¥æœ€ä½é¢‘ç‡è¿è¡Œï¼Œç³»ç»Ÿæ€§èƒ½ä¼šå—å½±å“ï¼Œä¸€èˆ¬ä¸ä¼šç”¨è¿™ä¸ªï¼</li><li>Userspaceï¼šå¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´æ‰‹åŠ¨è°ƒèŠ‚é¢‘ç‡ã€‚</li><li>Ondemandï¼šå®šæ—¶æ£€æŸ¥è´Ÿè½½ï¼Œç„¶åæ ¹æ®è´Ÿè½½æ¥è°ƒèŠ‚é¢‘ç‡ã€‚è´Ÿè½½ä½çš„æ—¶å€™é™ä½ CPU é¢‘ç‡ï¼Œè¿™æ ·çœç”µï¼Œè´Ÿè½½é«˜çš„æ—¶å€™æé«˜ CPU é¢‘ç‡ï¼Œå¢åŠ æ€§èƒ½ã€‚</li></ul><h4 id="ä¿®æ”¹-emmc-é©±åŠ¨">ä¿®æ”¹ EMMC é©±åŠ¨</h4><p>ç”±å¼€å‘æ¿æ ¸å¿ƒæ¿åŸç†å›¾å¯çŸ¥ç”¨åˆ°çš„ EMMC é‡‡ç”¨ 8 æ ¹æ•°æ®çº¿ï¼Œè€Œ Linux å†…æ ¸é©±åŠ¨é‡Œé¢ EMMC é»˜è®¤æ˜¯ 4 çº¿æ¨¡å¼ï¼Œè¿™æ · EMMC è¯»å†™é€Ÿåº¦ä¼šæ…¢å¾ˆå¤šï¼Œè€Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹è®¾å¤‡æ ‘ <code> imx6ull-obito-emmc.dts</code> å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// ä¿®æ”¹å‰</span><br><span class="line">&amp;usdhc2 &#123;</span><br><span class="line">pinctrl-names = &quot;default&quot;;</span><br><span class="line">pinctrl-0 = &lt;&amp;pinctrl_usdhc2&gt;;</span><br><span class="line">non-removable;</span><br><span class="line">status = &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// ä¿®æ”¹å</span><br><span class="line">&amp;usdhc2 &#123;</span><br><span class="line">pinctrl-names = &quot;default&quot;, &quot;state_100mhz&quot;, &quot;state_200mhz&quot;;</span><br><span class="line">pinctrl-0 = &lt;&amp;pinctrl_usdhc2_8bit&gt;;</span><br><span class="line">pinctrl-1 = &lt;&amp;pinctrl_usdhc2_8bit_100mhz&gt;;</span><br><span class="line">pinctrl-2 = &lt;&amp;pinctrl_usdhc2_8bit_200mhz&gt;;</span><br><span class="line">bus-width = &lt;8&gt;;</span><br><span class="line">non-removable;</span><br><span class="line">no-1-8-v;</span><br><span class="line">status = &quot;okay&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>bus-width = &lt;8&gt;ï¼šè¡¨ç¤º 8 æ ¹çº¿</li><li>no-1-8-vï¼šå…³é—­EMMC 1.8 V ä¾›ç”µé€‰é¡¹ï¼Œé˜²æ­¢å†…æ ¸è¿è¡Œæ—¶ç”¨ 1.8 V å»é©±åŠ¨ EMMC</li></ul><h4 id="ä¿®æ”¹ç½‘ç»œé©±åŠ¨">ä¿®æ”¹ç½‘ç»œé©±åŠ¨</h4><blockquote><p><strong>ä¸ºä»€ä¹ˆ uboot æœ‰ç½‘ç»œé©±åŠ¨äº†ï¼Œè¿˜è¦ä¿®æ”¹å†…æ ¸çš„ç½‘ç»œé©±åŠ¨å‘¢ï¼Ÿ</strong></p><p>uboot çš„ç½‘ç»œé©±åŠ¨ä¸»è¦ç”¨äºå®ç°ç½‘ç»œå¯åŠ¨(BOOTP æˆ– DHCP åè®®)æˆ–é€šè¿‡ TFTP ç­‰åè®®è¿›è¡Œæ–‡ä»¶çš„ä¼ è¾“ï¼Œé©±åŠ¨ç›¸å¯¹ç®€å•ï¼Œç›®çš„åœ¨äºæ–¹ä¾¿è°ƒè¯•ä¹‹ç±»çš„ã€‚</p><p>å†…æ ¸çš„ç½‘ç»œé©±åŠ¨å¤æ‚ï¼Œæ”¯æŒå„ç§ç½‘ç»œåè®®ï¼ˆTCP/IPã€Ethernetã€Wi-Fi ç­‰ï¼‰ï¼Œéœ€è¦å¤„ç†å®Œæ•´çš„ç½‘ç»œå †æ ˆå’Œå¤šç§ç½‘ç»œç¡¬ä»¶ã€‚</p></blockquote><h5 id="æ·»åŠ å¤ä½å¼•è„š">æ·»åŠ å¤ä½å¼•è„š</h5><p>ç”±äº PHY èŠ¯ç‰‡ä¸åŒï¼Œç”±å‰é¢ç§»æ¤ uboot æ—¶å¯çŸ¥ä¿®æ”¹ç½‘ç»œé©±åŠ¨ä¸»è¦æ˜¯åœ¨è®¾å¤‡æ ‘æ·»åŠ  PHY èŠ¯ç‰‡çš„å¤ä½å¼•è„šï¼Œ</p><p>æ·»åœ¨ iomuxc_sncs èŠ‚ç‚¹ä¸‹æ·»åŠ <strong>ç½‘ç»œå¤ä½å¼•è„š</strong>ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ ç½‘ç»œå¤ä½å¼•è„š</span></span><br><span class="line">pinctrl_enet_reset: enetresetgrp &#123;</span><br><span class="line">            fsl,pins = &lt;</span><br><span class="line">                MX6ULL_PAD_SNVS_TAMPER9__GPIO5_IO09     <span class="number">0x1b0b0</span> <span class="comment">/* enet1 reset */</span></span><br><span class="line">                MX6ULL_PAD_SNVS_TAMPER6__GPIO5_IO06     <span class="number">0x1b0b0</span> <span class="comment">/* enet2 reset */</span></span><br><span class="line">            &gt;;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>æ­£ç‚¹åŸå­æ•™ç¨‹ä¸­è¿˜ä¿®æ”¹äº†ç½‘ç»œæ—¶é’Ÿå¼•è„šé…ç½®ä¿¡æ¯ï¼Œå°† <code>MX6UL_PAD_ENET2_TX_CLK__ENET2_REF_CLK2</code> å’Œ <code>MX6UL_PAD_ENET1_TX_CLK__ENET1_REF_CLK1 </code>çš„å€¼ä»é»˜è®¤å€¼ 0x4001b031 ä¿®æ”¹ä¸º 0x4001b009ï¼Œä½†æ˜¯æˆ‘çœ‹ 100ask æä¾›çš„è®¾å¤‡æ ‘æ˜¯æ²¡æœ‰ä¿®æ”¹é»˜è®¤å€¼çš„ï¼Œè€Œæ˜¯å°† pinctrl_enet1èŠ‚ç‚¹çš„å†…å®¹æ”¾åˆ° pinctrl_enet2 ä¸­ã€‚</p><h5 id="ä¿®æ”¹-fec1-å’Œ-fec2-èŠ‚ç‚¹">ä¿®æ”¹ fec1 å’Œ fec2 èŠ‚ç‚¹</h5><p>ä¿®æ”¹ fec1 èŠ‚ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿®æ”¹å‰</span></span><br><span class="line">&amp;fec1 &#123;</span><br><span class="line">pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_enet1&gt;;</span><br><span class="line">phy-mode = <span class="string">&quot;rmii&quot;</span>;</span><br><span class="line">phy-handle = &lt;&amp;ethphy0&gt;;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;fec2 &#123;</span><br><span class="line">pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_enet2&gt;;</span><br><span class="line">phy-mode = <span class="string">&quot;rmii&quot;</span>;</span><br><span class="line">phy-handle = &lt;&amp;ethphy1&gt;;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">mdio &#123;</span><br><span class="line"><span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"></span><br><span class="line">ethphy0: ethernet-phy@<span class="number">2</span> &#123;</span><br><span class="line">compatible = <span class="string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;</span><br><span class="line">reg = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ethphy1: ethernet-phy@<span class="number">1</span> &#123;</span><br><span class="line">compatible = <span class="string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;</span><br><span class="line">reg = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;fec1 &#123;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_enet1&gt;;</span><br><span class="line">    phy-mode = <span class="string">&quot;rmii&quot;</span>;</span><br><span class="line">    phy-handle = &lt;&amp;ethphy0&gt;;</span><br><span class="line">    phy-reset-gpios = &lt;&amp;gpio5 <span class="number">9</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">    phy-reset-duration = &lt;<span class="number">26</span>&gt;;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿®æ”¹å</span></span><br><span class="line">&amp;fec2 &#123;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_enet2&gt;;</span><br><span class="line">    phy-mode = <span class="string">&quot;rmii&quot;</span>;</span><br><span class="line">    phy-handle = &lt;&amp;ethphy1&gt;;</span><br><span class="line">    phy-reset-gpios = &lt;&amp;gpio5 <span class="number">6</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">    phy-reset-duration = &lt;<span class="number">26</span>&gt;;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">    mdio &#123;</span><br><span class="line">        <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">        <span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"></span><br><span class="line">        ethphy0: ethernet-phy@<span class="number">0</span> &#123;</span><br><span class="line">            compatible = <span class="string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;</span><br><span class="line">            smsc,disable-energy-detect;</span><br><span class="line">            reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        &#125;;</span><br><span class="line">        ethphy1: ethernet-phy@<span class="number">1</span> &#123;</span><br><span class="line">            compatible = <span class="string">&quot;ethernet-phy-ieee802.3-c22&quot;</span>;</span><br><span class="line">            smsc,disable-energy-detect;</span><br><span class="line">            reg = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>phy-reset-duration = &lt;26&gt;ï¼šå¤ä½ä½ç”µå¹³ä¿¡å·æŒç»­æ—¶é—´ä¸º 26 ms</li><li>smsc,disable-energy-detectï¼šè¡¨ç¤º PHY èŠ¯ç‰‡æ˜¯ SMSC å…¬å¸çš„ï¼ŒLinux å†…æ ¸é€šè¿‡æ­¤ä¿¡æ¯æ‰¾åˆ°å¯¹åº” PHY èŠ¯ç‰‡é©±åŠ¨æ¥é©±åŠ¨ LAN8720A</li><li>ethernet-phy@ï¼šåé¢æ•°å­—è¡¨ç¤º PHY çš„åœ°å€</li><li>regï¼šPHY çš„åœ°å€</li></ul><h5 id="é…ç½®-linux-å†…æ ¸-ä½¿èƒ½-lan8720-é©±åŠ¨">é…ç½® Linux å†…æ ¸ï¼Œä½¿èƒ½ LAN8720 é©±åŠ¨</h5><p>Linux å†…æ ¸å·²ç»æœ‰å¤šä¸ª PHY èŠ¯ç‰‡çš„é©±åŠ¨äº†ï¼Œä½†é»˜è®¤æ˜¯ä¸ç¼–è¯‘çš„ï¼Œæˆ‘ä»¬ç”¨åˆ°çš„æ˜¯ LAN8720Aï¼ˆSMSC å…¬å¸çš„ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬è¾“å…¥ make menuconfig è¿›å…¥ Linux å›¾å½¢ç•Œé¢é…ç½®ä½¿èƒ½ LAN8720 é©±åŠ¨ï¼ŒæŒ‰ä»¥ä¸‹è·¯å¾„è¿›å…¥æ‰¾åˆ°å¹¶é€‰æ‹©ä½¿èƒ½ SMSC PHY èŠ¯ç‰‡é©±åŠ¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-&gt; Device Drivers</span><br><span class="line">-&gt; Network device support</span><br><span class="line">-&gt; PHY Device support and infrastructure</span><br><span class="line">-&gt; Drivers for SMSC PHYs</span><br></pre></td></tr></table></figure><h2 id="æ ¹æ–‡ä»¶ç³»ç»Ÿæ„å»º">æ ¹æ–‡ä»¶ç³»ç»Ÿæ„å»º</h2><h3 id="æ ¹æ–‡ä»¶ç³»ç»Ÿæ¦‚è¿°">æ ¹æ–‡ä»¶ç³»ç»Ÿæ¦‚è¿°</h3><p>æ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ Linux å†…æ ¸å¯åŠ¨ä»¥åæŒ‚è½½(mount)çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åä»æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–åˆå§‹åŒ–è„šæœ¬ï¼Œæ¯”å¦‚ rcSï¼Œinittab ç­‰ã€‚</p><p>Linuxæ“ä½œç³»ç»Ÿçš„æ ¹ç›®å½•ï¼ˆé€šå¸¸è¡¨ç¤ºä¸º&quot;/&quot;ï¼‰æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„æœ€é¡¶å±‚ç›®å½•ï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰å…¶ä»–ç›®å½•å’Œæ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ ¹ç›®å½•ä¸‹å­ç›®å½•åŠå…¶ä¸€èˆ¬ç”¨é€”çš„è§£é‡Šï¼š</p><table><thead><tr><th style="text-align:center">ç›®å½•</th><th style="text-align:center">æè¿°</th></tr></thead><tbody><tr><td style="text-align:center"><strong>/bin</strong></td><td style="text-align:center">å­˜æ”¾ç³»ç»Ÿå‘½ä»¤çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯”å¦‚<code>ls</code>ã€<code>cp</code>ç­‰</td></tr><tr><td style="text-align:center"><strong>/boot</strong></td><td style="text-align:center">åŒ…å«å¯åŠ¨ Linux ç³»ç»Ÿæ‰€éœ€çš„æ–‡ä»¶ï¼Œå¦‚å†…æ ¸å’Œå¼•å¯¼åŠ è½½ç¨‹åºã€‚</td></tr><tr><td style="text-align:center"><strong>/dev</strong></td><td style="text-align:center">åŒ…å«è®¾å¤‡æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä»£è¡¨è®¡ç®—æœºä¸Šçš„ç¡¬ä»¶è®¾å¤‡ã€‚</td></tr><tr><td style="text-align:center"><strong>/etc</strong></td><td style="text-align:center">å­˜æ”¾ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚ç½‘ç»œé…ç½®ã€æœåŠ¡é…ç½®ç­‰ã€‚</td></tr><tr><td style="text-align:center"><strong>/home</strong></td><td style="text-align:center">ç”¨æˆ·çš„ä¸ªäººç›®å½•ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½æœ‰ä¸€ä¸ªä»¥ç”¨æˆ·åå‘½åçš„å­ç›®å½•ã€‚</td></tr><tr><td style="text-align:center"><strong>/lib</strong></td><td style="text-align:center">å­˜æ”¾ç³»ç»Ÿåº“æ–‡ä»¶ï¼Œè¿™äº›æ˜¯ç¨‹åºè¿è¡Œæ—¶éœ€è¦çš„å…±äº«ä»£ç ã€‚</td></tr><tr><td style="text-align:center"><strong>/media</strong></td><td style="text-align:center">ç”¨äºè‡ªåŠ¨æŒ‚è½½å¯ç§»åŠ¨è®¾å¤‡ï¼Œå¦‚ USB é©±åŠ¨å™¨ã€‚</td></tr><tr><td style="text-align:center"><strong>/mnt</strong></td><td style="text-align:center">ç”¨äºä¸´æ—¶æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿã€‚</td></tr><tr><td style="text-align:center"><strong>/opt</strong></td><td style="text-align:center">ç”¨äºå­˜æ”¾ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…ã€‚</td></tr><tr><td style="text-align:center"><strong>/proc</strong></td><td style="text-align:center">è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…å«ç³»ç»Ÿå’Œè¿›ç¨‹ä¿¡æ¯ï¼Œ/proc æ˜¯ä¸€ç§ä¼ªæ–‡ä»¶ç³»ç»Ÿï¼ˆä¹Ÿå³è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œå­˜å‚¨çš„æ˜¯å½“å‰å†…æ ¸è¿è¡ŒçŠ¶æ€çš„ä¸€ç³»åˆ—ç‰¹æ®Šæ–‡ä»¶ã€‚</td></tr><tr><td style="text-align:center"><strong>/root</strong></td><td style="text-align:center">ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆroot ç”¨æˆ·ï¼‰çš„å®¶ç›®å½•ã€‚</td></tr><tr><td style="text-align:center"><strong>/sbin</strong></td><td style="text-align:center">å­˜æ”¾ç³»ç»Ÿç®¡ç†å‘½ä»¤çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€šå¸¸åªæœ‰ root ç”¨æˆ·æ‰èƒ½è®¿é—®ã€‚</td></tr><tr><td style="text-align:center"><strong>/srv</strong></td><td style="text-align:center">å­˜æ”¾ç³»ç»ŸæœåŠ¡çš„æ•°æ®ã€‚</td></tr><tr><td style="text-align:center"><strong>/tmp</strong></td><td style="text-align:center">å­˜æ”¾ä¸´æ—¶æ–‡ä»¶ã€‚</td></tr><tr><td style="text-align:center"><strong>/usr</strong></td><td style="text-align:center">Unix Shared Resources(å…±äº«èµ„æº) çš„ç¼©å†™ï¼Œç”¨æˆ·ç›¸å…³çš„åº”ç”¨ç¨‹åºå’Œæ–‡ä»¶ï¼Œé€šå¸¸åˆ†ä¸º /bin, /lib, /sbin ç­‰å­ç›®å½•ã€‚</td></tr><tr><td style="text-align:center"><strong>/var</strong></td><td style="text-align:center">å­˜æ”¾ç»å¸¸å˜åŒ–çš„æ–‡ä»¶ï¼Œå¦‚æ—¥å¿—æ–‡ä»¶ã€‚</td></tr><tr><td style="text-align:center"><strong>/sys</strong></td><td style="text-align:center">åŒ…å«ç³»ç»Ÿè®¾å¤‡å’Œé©±åŠ¨ç¨‹åºçš„æ¥å£ä¿¡æ¯ï¼Œç±»ä¼¼äº /procã€‚</td></tr></tbody></table><p>æ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿæœ‰è®¸å¤šå·¥å…·ï¼šBusyBoxã€Buildrootã€</p><h3 id="busybox-æ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ">BusyBox æ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ</h3><p>BusyBox æ˜¯ä¸€ä¸ªé›†æˆäº†å¤§é‡ Linux å‘½ä»¤å’Œå·¥å…·çš„è½¯ä»¶ï¼Œä½¿ç”¨æ—¶åªéœ€è¦ä¸‹è½½å…¶æºç ï¼Œç„¶åé…ç½®é€‰æ‹©è‡ªå·±éœ€è¦çš„åŠŸèƒ½ï¼Œç¼–è¯‘å³å¯ã€‚</p><blockquote><p><a href="https://busybox.net/downloads/">BusyBox Downloads</a></p></blockquote><p>ä¸€èˆ¬åœ¨å¼€å‘å‰æœŸéƒ½æ˜¯<strong>é€šè¿‡ nfs æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ</strong>çš„ï¼Œç­‰æœ€åå®Œå–„æµ‹è¯•ç¨³å®šæ‰çƒ§å½•åˆ° EMMC æˆ– NAND ä¸­çš„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è‡ªå·± Ubuntu çš„ nfs æœåŠ¡å™¨ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªå­ç›®å½•(ä¾‹å¦‚ busybox1.29.0_rootfs )æ¥å­˜æ”¾è‡ªå·±æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</p><h4 id="åˆæ­¥ç¼–è¯‘-busybox">åˆæ­¥ç¼–è¯‘ BusyBox</h4><h5 id="ä¿®æ”¹é¡¶å±‚-makefile">ä¿®æ”¹é¡¶å±‚ Makefile</h5><p>åœ¨ BusyBox é¡¶å±‚ç›®å½•ä¿®æ”¹ Makefile æ–‡ä»¶ï¼Œæ·»åŠ  ARCH å’Œ CROSS_COMPILEï¼Œæœç´¢ 164 è¡Œå’Œ 190 è¡Œä¿®æ”¹æˆè‡ªå·±çš„ç¼–è¯‘å™¨å­˜æ”¾ç›®å½•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CROSS_COMPILE ?= /home/router2/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/arm-buildroot-linux-gnueabihf-</span><br><span class="line"></span><br><span class="line">ARCH ?= arm</span><br></pre></td></tr></table></figure><h5 id="busybox-ä¸­æ–‡å­—ç¬¦æ”¯æŒ">BusyBox ä¸­æ–‡å­—ç¬¦æ”¯æŒ</h5><p>æ–°ç‰ˆæœ¬çš„ busybox é»˜è®¤ä¸æ”¯æŒä¸­æ–‡å­—ç¬¦æ˜¾ç¤ºï¼Œä¸­æ–‡å­—ç¬¦éƒ½ä¼šæ˜¾ç¤ºä¸º â€˜?â€™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ busybox æºç ï¼Œæ‰“å¼€æ–‡ä»¶ <code>libbb/printable_string.c</code> ï¼Œæ‰¾åˆ°å‡½æ•° <code>printable_string</code>ï¼Œ</p><p>å°†å­—ç¬¦å¤§äº 0x7f çš„è¯­å¥è¿›è¡Œä¿®æ”¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span>* FAST_FUNC <span class="title function_">printable_string</span><span class="params">(<span class="type">uni_stat_t</span> *stats, <span class="type">const</span> <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> *dst;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *s;</span><br><span class="line"></span><br><span class="line">        s = str;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">char</span> c = *s;</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">                        <span class="comment">/* 99+% of inputs do not need conversion */</span></span><br><span class="line">                        <span class="keyword">if</span> (stats) &#123;</span><br><span class="line">                                stats-&gt;byte_count = (s - str);</span><br><span class="line">                                stats-&gt;unicode_count = (s - str);</span><br><span class="line">                                stats-&gt;unicode_width = (s - str);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> str;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (c &lt; <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// æ³¨é‡Šä¸‹é¢ä¸¤è¡Œä»£ç </span></span><br><span class="line">                <span class="comment">/* if (c &gt;= 0x7f)</span></span><br><span class="line"><span class="comment">                        break; </span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                s++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_UNICODE_SUPPORT</span></span><br><span class="line">        dst = unicode_conv_to_printable(stats, str);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="type">char</span> *d = dst = xstrdup(str);</span><br><span class="line">                <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="type">unsigned</span> <span class="type">char</span> c = *d;</span><br><span class="line">                        <span class="keyword">if</span> (c == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        <span class="comment">// å°† c&gt;=0x7fåˆ é™¤</span></span><br><span class="line">                        <span class="comment">// if (c &lt; &#x27; &#x27; || c &gt;= 0x7f)</span></span><br><span class="line">                        <span class="keyword">if</span> (c &lt; <span class="string">&#x27;&#x27;) </span></span><br><span class="line"><span class="string">                                *d = &#x27;</span>?<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">                        d++;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">                if (stats) &#123;</span></span><br><span class="line"><span class="string">                        stats-&gt;byte_count = (d - dst);</span></span><br><span class="line"><span class="string">                        stats-&gt;unicode_count = (d - dst);</span></span><br><span class="line"><span class="string">                        stats-&gt;unicode_width = (d - dst);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">#endif</span></span><br></pre></td></tr></table></figure><p>æ¥ç€æ‰“å¼€æ–‡ä»¶ <code>libbb/unicode.c</code>ï¼Œæœç´¢å‡½æ•° <code>FAST_FUNC unicode_conv_to_printable2</code>ï¼Œå°†å­—ç¬¦å¤§äº 0x7f æ˜¾ç¤º â€˜?â€˜ åˆ é™¤ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unicode_status != UNICODE_ON) &#123;</span><br><span class="line">               <span class="type">char</span> *d;</span><br><span class="line">               <span class="keyword">if</span> (flags &amp; UNI_FLAG_PAD) &#123;</span><br><span class="line">                       d = dst = xmalloc(width + <span class="number">1</span>);</span><br><span class="line">                       <span class="keyword">while</span> ((<span class="type">int</span>)--width &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                               <span class="type">unsigned</span> <span class="type">char</span> c = *src;</span><br><span class="line">                               <span class="keyword">if</span> (c == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">                                       <span class="keyword">do</span></span><br><span class="line">                                               *d++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">                                       <span class="keyword">while</span> ((<span class="type">int</span>)--width &gt;= <span class="number">0</span>);</span><br><span class="line">                                       <span class="keyword">break</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                                <span class="comment">// ä¿®æ”¹</span></span><br><span class="line">                       <span class="comment">//      *d++ = (c &gt;= &#x27; &#x27; &amp;&amp; c &lt; 0x7f) ? c : &#x27;?&#x27;;</span></span><br><span class="line">                               *d++ = (c &gt;= <span class="string">&#x27; &#x27;</span>) ? c : <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">                               src++;</span><br><span class="line">                       &#125;</span><br><span class="line">                       *d = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       d = dst = xstrndup(src, width);</span><br><span class="line">                       <span class="keyword">while</span> (*d) &#123;</span><br><span class="line">                               <span class="type">unsigned</span> <span class="type">char</span> c = *d;</span><br><span class="line">                               <span class="comment">// ä¿®æ”¹</span></span><br><span class="line">                               <span class="comment">//if (c &lt; &#x27; &#x27; || c &gt;= 0x7f)</span></span><br><span class="line">                               <span class="keyword">if</span> (c &lt; <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                                       *d = <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">                               d++;</span><br><span class="line">                       &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (stats) &#123;</span><br><span class="line">                       stats-&gt;byte_count = (d - dst);</span><br><span class="line">                       stats-&gt;unicode_count = (d - dst);</span><br><span class="line">                       stats-&gt;unicode_width = (d - dst);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> dst;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="é…ç½®-busybox">é…ç½® busybox</h5><p>busybox æœ‰ä¸‰ç§é…ç½®é€‰é¡¹ï¼š</p><ul><li>defconfigï¼šç¼ºçœé…ç½®ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤é…ç½®é€‰é¡¹ã€‚</li><li>allyesconfigï¼Œå…¨é€‰é…ç½®ï¼Œä¹Ÿå°±æ˜¯é€‰ä¸­ busybox çš„æ‰€æœ‰åŠŸèƒ½ã€‚</li><li>allnoconfigï¼Œæœ€å°é…ç½®ã€‚</li></ul><p>è¿™é‡Œä½¿ç”¨é»˜è®¤é…ç½®å³å¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make defconfig</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p><strong>å–æ¶ˆå‹¾é€‰ <code>Build static binary (no shared libs)</code></strong> é€‰æ‹©é™æ€ç¼–è¯‘è¿˜æ˜¯åŠ¨æ€ç¼–è¯‘ï¼Œé™æ€ç¼–è¯‘ä¸éœ€è¦åº“æ–‡ä»¶ï¼Œä½†æ˜¯æ–‡ä»¶å¾ˆå¤§ï¼ŒåŠ¨æ€ç¼–è¯‘åˆ™è¦æ±‚æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰åŠ¨æ€åº“ï¼Œæ–‡ä»¶å°å¾ˆå¤šï¼Œè¿™é‡Œä½¿ç”¨åŠ¨æ€ç¼–è¯‘çš„æ–¹å¼ã€‚</p><blockquote><p>æ­£ç‚¹åŸå­æ•™ç¨‹ï¼šè¿™é‡Œæˆ‘ä»¬ä¸èƒ½é‡‡ç”¨é™æ€ç¼–è¯‘ï¼å› ä¸ºé‡‡ç”¨é™æ€ç¼–è¯‘çš„è¯ DNS ä¼šå‡ºé—®é¢˜ï¼æ— æ³•è¿›è¡ŒåŸŸåè§£æ</p></blockquote><p><img src="image-20240705145539453.png" alt="image-20240705145539453"></p><p><strong>é€‰æ‹© <code>vi-style line editing commands</code></strong></p><p><img src="image-20240705145719329.png" alt="image-20240705145719329"></p><p><strong>å–æ¶ˆå‹¾é€‰ <code>Simplified modutils</code></strong></p><p><img src="image-20240705145759319.png" alt="image-20240705145759319"></p><p>ç¡®ä¿ <code>mdev</code> é…ç½®é¡¹å…¨éƒ¨é€‰ä¸­ï¼Œé»˜è®¤éƒ½æ˜¯é€‰ä¸­çš„</p><p><img src="image-20240705145844766.png" alt="image-20240705145844766"></p><p>ä½¿èƒ½ unicode ç¼–ç ä»¥æ”¯æŒä¸­æ–‡ï¼Œç¡®ä¿ä¸¤ä¸ªé€‰ä¸­</p><p><img src="image-20240705150020698.png" alt="image-20240705150020698"></p><h5 id="ç¼–è¯‘-busybox">ç¼–è¯‘ busybox</h5><p>ç¼–è¯‘ busyboxï¼ŒCONFIG_PREFIX æŒ‡å®šç¼–è¯‘ç»“æœå­˜æ”¾ç›®å½•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j8</span><br><span class="line">make install CONFIG_PREFIX=/home/router2/100ask_imx6ull-sdk/nfs_ubuntu/busybox1.29.0_rootfs</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆç›®å½•ä¸‹å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="image-20240705150624131.png" alt="image-20240705150624131"></p><p>æœ‰ binã€sbin å’Œ usr ä¸‰ä¸ªç›®å½•ä»¥åŠ linuxrc æ–‡ä»¶ã€‚<strong>Linux å†…æ ¸ init è¿›ç¨‹</strong>æœ€åä¼šæŸ¥æ‰¾ç”¨æˆ·ç©ºé—´çš„ init ç¨‹åºï¼Œæ‰¾åˆ°ä»¥åå°±ä¼šè¿è¡Œè¿™ä¸ª<strong>ç”¨æˆ·ç©ºé—´çš„ init ç¨‹åº</strong>ï¼Œä»è€Œ<strong>åˆ‡æ¢åˆ°ç”¨æˆ·æ€</strong>ã€‚å¦‚æœ uboot ä¸­ <strong>bootargs ç¯å¢ƒå˜é‡è®¾ç½® init=/linuxrc</strong>ï¼Œé‚£ä¹ˆ linuxrc å°±æ˜¯å¯ä»¥<strong>ä½œä¸ºç”¨æˆ·ç©ºé—´çš„ init ç¨‹åº</strong>ï¼Œæ‰€ä»¥ç”¨æˆ·æ€ç©ºé—´çš„ init ç¨‹åºæ˜¯ busybox æ¥ç”Ÿæˆçš„ã€‚</p><h4 id="æ„å»ºæ•´ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿ">æ„å»ºæ•´ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿ</h4><p>å› ä¸ºå‰é¢æ˜¯ä½¿ç”¨åŠ¨æ€ç¼–è¯‘ï¼Œæ‰€ä»¥æ­¤æ—¶çš„æ ¹æ–‡ä»¶ç³»ç»Ÿè¿˜ä¸èƒ½ä½¿ç”¨ï¼Œéœ€è¦æ·»åŠ ä¸€äº›åŠ¨æ€åº“æ–‡ä»¶ç­‰æ¥å®Œå–„ã€‚</p><h5 id="æ·»åŠ -lib-ç›®å½•å¹¶æ·»åŠ åº“æ–‡ä»¶">æ·»åŠ  lib/ ç›®å½•å¹¶æ·»åŠ åº“æ–‡ä»¶</h5><p>æ·»åŠ  lib ç›®å½•ï¼Œå°†äº¤å‰ç¼–è¯‘å™¨ç›®å½•ä¸‹çš„ lib åº“æ–‡ä»¶å¤åˆ¶åˆ°è¯¥ç›®å½•ä¸‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// åˆ›å»º lib æ–‡ä»¶å¤¹</span><br><span class="line">mkdir lib</span><br><span class="line"></span><br><span class="line">// è¿›å…¥ç›®å½•</span><br><span class="line">cd /home/router2/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/lib</span><br><span class="line"></span><br><span class="line">// æ‹·è´</span><br><span class="line">cp *so* *.a /home/router2/100ask_imx6ull-sdk/nfs_ubuntu/busybox1.29.0_rootfs/lib -d </span><br></pre></td></tr></table></figure><p>cp -d è¡¨ç¤ºæ‹·è´ç¬¦å·è¿æ¥ï¼Œç›¸å½“äº Windows ç³»ç»Ÿçš„å¿«æ·æ–¹å¼ã€‚<code>ld-linux-armhf.so.3</code> åº“æ–‡ä»¶ä¹Ÿæ˜¯ç¬¦å·é“¾æ¥ï¼Œä¼šè¿æ¥åˆ°å…¶ä»–åº“æ–‡ä»¶ä¸Šï¼Œä½†æ˜¯ ld-linux-armhf.so.3 ä¸èƒ½ä½œä¸ºç¬¦å·é“¾æ¥ï¼Œå¦åˆ™æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­æ‰§è¡Œç¨‹åºæ— æ³•æ‰§è¡Œã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å…ˆåˆ é™¤è¯¥æ–‡ä»¶ï¼Œç„¶åé‡æ–°å¤åˆ¶è¯¥æ–‡ä»¶åˆ°ç›®å½•ä¸‹ï¼ˆ<strong>ä¸ä½¿ç”¨ -d å‚æ•°</strong>ï¼‰ï¼Œè½¬æ¢å‰åå¦‚ä¸‹å›¾ï¼šä¸€å¼€å§‹ä½œä¸ºç¬¦å·é“¾æ¥æ—¶æ–‡ä»¶å¾ˆå°ï¼Œå»é™¤æ‰å°±å¾ˆå¤§äº†ï¼Œæ˜¯ä¸€ä¸ªå®å®åœ¨åœ¨çš„åº“æ–‡ä»¶ã€‚</p><p><img src="/image-20240705152722827.png" alt="image-20240705152722827"></p><h5 id="æ·»åŠ -usr-lib-ç›®å½•å¹¶æ·»åŠ åº“æ–‡ä»¶">æ·»åŠ  usr/lib ç›®å½•å¹¶æ·»åŠ åº“æ–‡ä»¶</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// è¿›å…¥ç›®å½•</span><br><span class="line">cd /home/router2/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/lib</span><br><span class="line"></span><br><span class="line">// å¤åˆ¶æ–‡ä»¶</span><br><span class="line">cp *so* *.a /home/router2/100ask_imx6ull-sdk/nfs_ubuntu/busybox1.29.0_rootfs/usr/lib -d</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ du å‘½ä»¤æŸ¥çœ‹ç›®å½•å¤§å°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">du lib/ usr/lib/ -shã€</span><br><span class="line"></span><br><span class="line">12Mlib/</span><br><span class="line">270Musr/lib/</span><br></pre></td></tr></table></figure><p>å‘ç° usr/lib ç›®å½•å¾ˆå¤§ï¼Œè¿›å…¥ç›®å½•æŸ¥çœ‹æœ‰å“ªäº›åº“æ–‡ä»¶å‘ç°æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹åº“(qt åº“ã€è§†é¢‘è§£ç åº“ç­‰)ï¼Œå¯ä»¥é€‰æ‹©æ€§åˆ æ‰ä¸€äº›ä»¥å‡å°‘æ–‡ä»¶å¤§å°ï¼Œåˆ é™¤è¿™äº›åº“æ–¹ä¾¿åç»­è‡ªå·±äº¤å‰ç¼–è¯‘åº“å­¦ä¹ ï¼Œè¿™é‡Œæ‰‹åŠ¨åˆ é™¤äº†ä¸€äº›åº“å‡å°‘åˆ°äº† 70Mã€‚</p><h5 id="åˆ›å»ºå…¶ä»–æ–‡ä»¶å¤¹">åˆ›å»ºå…¶ä»–æ–‡ä»¶å¤¹</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir dev proc mmt sys tmp root</span><br></pre></td></tr></table></figure><h5 id="æµ‹è¯•æ ¹æ–‡ä»¶ç³»ç»Ÿ">æµ‹è¯•æ ¹æ–‡ä»¶ç³»ç»Ÿ</h5><p>uboot å‘½ä»¤è¡Œæ¨¡å¼ä¸‹è®¾ç½® bootargs ç¯å¢ƒå˜é‡ï¼Œè®¾ç½® root å€¼ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root=/dev/nfs nfsroot=[&lt;server-ip&gt;:]&lt;root-dir&gt;[,&lt;nfs-options&gt;] ip=&lt;client-ip&gt;:&lt;server-ip&gt;:&lt;gw-ip&gt;:&lt;netmask&gt;:&lt;hostname&gt;:&lt;device&gt;:&lt;autoconf&gt;:&lt;dns0-ip&gt;:&lt;dns1-ip&gt;</span><br></pre></td></tr></table></figure><ul><li>/dev/nfsï¼šè¡¨ç¤º nfs æŒ‚è½½</li><li>server-ipï¼šæœåŠ¡å™¨ IP åœ°å€</li><li>root-dirï¼šæ ¹æ–‡ä»¶åœ¨æœåŠ¡å™¨çš„å­˜æ”¾ç›®å½•</li><li>nfs-optionsï¼šnfs çš„å…¶ä»–å¯é€‰é¡¹</li><li>client-ipï¼šå®¢æˆ·ç«¯ IP åœ°å€ï¼Œå³å¼€å‘æ¿çš„ IP åœ°å€</li><li>gw-ipï¼šç½‘å…³åœ°å€</li><li>netmaskï¼šå­ç½‘æ©ç </li><li>hostnameï¼šä¸»æœºåï¼Œç©ºç€å³å¯</li><li>deviceï¼šè®¾å¤‡åï¼Œç½‘å¡åï¼šeth0ã€eth1 ç­‰</li><li>autoconfï¼šè‡ªåŠ¨é…ç½®ï¼Œè®¾ç½® off å³å¯</li><li>dns0-ipï¼šDNS0 æœåŠ¡å™¨ IP åœ°å€ï¼Œä¸ä½¿ç”¨</li><li>dns1-ipï¼šDNS1æœåŠ¡å™¨ IP åœ°å€ï¼Œä¸ä½¿ç”¨</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">setenv bootcmd &#x27;tftp 80800000 zImage; tftp 83000000 imx6ull-obito-emmc.dtb; bootz 80800000 - 83000000&#x27;</span><br><span class="line"></span><br><span class="line">setenv bootcmd &#x27;tftp 80800000 zImage; tftp 83000000 100ask_imx6ull-14x14.dtb; bootz 80800000 - 83000000&#x27;</span><br><span class="line"></span><br><span class="line">setenv bootargs &#x27;console=ttymxc0,115200 root=/dev/nfs nfsroot=192.168.1.5:/home/router2/100ask_imx6ull-sdk/nfs_ubuntu/busybox1.29.0_rootfs,proto=tcp rw ip=192.168.1.7:192.168.1.5:192.168.1.1:255.255.255.0::eth0:off&#x27;</span><br><span class="line"></span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure><p>proto=tcpâ€è¡¨ç¤ºä½¿ç”¨ TCP åè®®ï¼Œâ€œrwâ€è¡¨ç¤º nfs æŒ‚è½½çš„æ ¹æ–‡ä»¶ç³»ç»Ÿä¸ºå¯è¯»å¯å†™.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tftp 80800000 zImage</span><br><span class="line">tftp 83000000 imx6ull-obito-emmc.dtb</span><br><span class="line">bootz 80800000 - 83000000</span><br></pre></td></tr></table></figure><p><img src="image-20240705165000323.png" alt="image-20240705165000323"></p><p>æŒ‚è½½æˆåŠŸï¼Œä½†æç¤º <code>can't run '/etc/init.d/rcS': No such file or directory</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªè„šæœ¬æ–‡ä»¶ï¼Œç”¨æ¥è§„å®šå¯åŠ¨å“ªäº›æ–‡ä»¶çš„è„šæœ¬æ–‡ä»¶ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å®Œå–„æ ¹æ–‡ä»¶ç³»ç»Ÿäº†ã€‚</p><h4 id="å®Œå–„æ ¹æ–‡ä»¶ç³»ç»Ÿ">å®Œå–„æ ¹æ–‡ä»¶ç³»ç»Ÿ</h4><p>åœ¨å†…æ ¸æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿåï¼Œè¿è¡Œçš„ç¬¬ä¸€ä¸ªç¨‹åºæ˜¯æ ¹ç›®å½•ä¸‹çš„ linuxrcï¼Œå®é™…æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>/bin/busybox</code> çš„é“¾æ¥, ä¹Ÿå°±æ˜¯è¯´ç³»ç»Ÿèµ·æ¥åè¿è¡Œçš„ç¬¬ä¸€ä¸ªç¨‹åºæ˜¯ busybox æœ¬èº«ã€‚å…ˆæ‰§è¡Œ <code>/etc/inittab</code>ï¼Œ ç„¶åè°ƒç”¨ <code>/etc/init.d/rcS</code>ï¼Œ æœ€åæ˜¯æ‰§è¡Œ <code>/etc/profile</code>ã€‚</p><p>æ ¹æ–‡ä»¶ç³»ç»Ÿè¿˜ç¼ºå°‘ä¸€äº›è„šæœ¬æ–‡ä»¶ï¼Œæ¥ä¸‹æ¥æ·»åŠ å‡ ä¸ªè„šæœ¬æ–‡ä»¶è¿›è¡Œå®Œå–„ã€‚</p><blockquote><p><a href="https://blog.csdn.net/SuGuolin/article/details/85335965">/etc/inittab,/etc/init.d/rcSå’Œ/etc/profileåˆ†æ_linux profile å’Œinttabè°å…ˆè°ƒç”¨-CSDNåšå®¢</a></p></blockquote><h5 id="åˆ›å»º-etc-init-d-rcs-æ–‡ä»¶">åˆ›å»º /etc/init.d/rcS æ–‡ä»¶</h5><p>rcS æ˜¯ä¸€ä¸ª shell è„šæœ¬æ–‡ä»¶ï¼ŒrcS æ˜¯ç”¨æ¥è§„å®š Linux å†…æ ¸å¯åŠ¨å“ªäº›æ–‡ä»¶çš„è„šæœ¬æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/init.d/rcS</span><br></pre></td></tr></table></figure><p>rcS æ–‡ä»¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin:$PATH</span><br><span class="line">LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/lib:/usr/lib</span><br><span class="line">export PATH LD_LIBRARY_PATH</span><br><span class="line"></span><br><span class="line">mount -a</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br><span class="line">mdev -s</span><br></pre></td></tr></table></figure><ul><li>#!/bin/shï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª shell è„šæœ¬</li><li>PATHï¼šPATH ç¯å¢ƒå˜é‡ä¿å­˜<strong>å¯æ‰§è¡Œæ–‡ä»¶</strong>å¯èƒ½å­˜åœ¨çš„ç›®å½•ï¼Œå†’å·: å¯ä»¥æ·»åŠ å¤šä¸ªç›®å½•</li><li>LD_LIBRARY_PATHï¼šLD_LIBRARY_PATH ç¯å¢ƒå˜é‡ä¿å­˜<strong>åº“æ–‡ä»¶</strong>æ‰€åœ¨çš„ç›®å½•</li><li>exportï¼šå¯¼å‡ºæŒ‡å®šçš„ç¯å¢ƒå˜é‡ï¼Œç›¸å½“äºå£°æ˜ä¸€äº›å…¨å±€å˜é‡</li><li>mount å‘½ä»¤æŒ‚è½½æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™äº›æ–‡ä»¶ç³»ç»Ÿç”±æ–‡ä»¶ <code>/etc/fstab</code> æ¥æŒ‡å®š</li><li>åˆ›å»º <code>/dev/pts</code> ç›®å½•ï¼Œå°† devpts æŒ‚è½½åˆ° <code>/dev/pts</code> ç›®å½•ä¸‹</li><li>æœ€åä¸¤è¡Œä½¿ç”¨ mdev æ¥ç®¡ç†çƒ­æ’æ‹”è®¾å¤‡ï¼Œè®© linux å†…æ ¸å¯ä»¥åœ¨ /dev ç›®å½•ä¸‹è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</li></ul><p>æœ€åç»™ rcS æ–‡ä»¶åŠ æƒé™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 rcS</span><br></pre></td></tr></table></figure><h5 id="åˆ›å»º-etc-fstab-æ–‡ä»¶">åˆ›å»º /etc/fstab æ–‡ä»¶</h5><p>fstab åœ¨ Linux å¼€æœºä»¥åè‡ªåŠ¨é…ç½®å“ªäº›éœ€è¦è‡ªåŠ¨æŒ‚è½½çš„åˆ†åŒºï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;file system&gt; &lt;mount point&gt; &lt;type&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;</span><br></pre></td></tr></table></figure><ul><li>file systemï¼šè¦æŒ‚è½½çš„ç‰¹æ®Šè®¾å¤‡</li><li>mount pointï¼šæŒ‚è½½ç‚¹</li><li>typeï¼šæ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹ï¼Œä¾‹å¦‚ ext2ã€ext3ã€procã€romfsã€tmpfs ç­‰</li><li>optionsï¼šæŒ‚è½½é€‰é¡¹ï¼Œä¸€èˆ¬ä½¿ç”¨ defaultsï¼ŒåŒ…å«äº† äº† rwã€suidã€ devã€ execã€ autoã€ nouser å’Œ async</li><li>dumpï¼š1 è¡¨ç¤ºå…è®¸å¤‡ä»½ï¼Œ0 è¡¨ç¤ºä¸å¤‡ä»½ï¼Œä¸€èˆ¬ä¸å¤‡ä»½</li><li>passï¼šç£ç›˜æ£€æŸ¥è®¾ç½®ï¼Œ0 è¡¨ç¤ºä¸æ£€æŸ¥ï¼Œæ ¹ç›®å½• â€˜/â€™ è®¾ç½®ä¸º 1ï¼Œå…¶ä»–åˆ†åŒºä¸èƒ½ä¸º 1ï¼Œä» 2 å¼€å§‹ï¼Œä¸€èˆ¬ä¸åœ¨ fstab ä¸­æŒ‚è½½æ ¹ç›®å½•</li></ul><p>åœ¨ fstab æ–‡ä»¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">&lt;file system&gt; &lt;mount point&gt; &lt;<span class="built_in">type</span>&gt; &lt;options&gt; &lt;dump&gt; &lt;pass&gt;</span></span><br><span class="line">proc /proc proc defaults 0 0</span><br><span class="line">tmpfs /tmp tmpfs defaults 0 0</span><br><span class="line">sysfs /sys sysfs defaults 0 0</span><br></pre></td></tr></table></figure><h5 id="åˆ›å»º-etc-inittab-æ–‡ä»¶">åˆ›å»º /etc/inittab æ–‡ä»¶</h5><p>init ç¨‹åºä¼šè¯»å–<code>/etc/inittab</code> è¿™ä¸ªæ–‡ä»¶ï¼Œinittab ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆã€‚æ¯æ¡æŒ‡ä»¤çš„ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç”±ä»¥â€œ:â€åˆ†éš”çš„ 4 ä¸ªæ®µç»„æˆï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;id&gt;:&lt;runlevels&gt;:&lt;action&gt;:&lt;process&gt;</span><br></pre></td></tr></table></figure><ul><li>idï¼šæ¯ä¸ªæŒ‡ä»¤çš„æ ‡è¯†ç¬¦ï¼Œä¸èƒ½é‡å¤</li><li>runlevelsï¼šå¯¹ busybox æ²¡ç”¨</li><li>actionï¼šåŠ¨ä½œï¼Œç”¨äº process å¯èƒ½ç”¨åˆ°çš„åŠ¨ä½œ</li><li>processï¼šå…·ä½“çš„åŠ¨ä½œï¼Œæ¯”å¦‚ç¨‹åºã€è„šæœ¬æˆ–å‘½ä»¤ç­‰</li></ul><p>busybox æ”¯æŒçš„åŠ¨ä½œå¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">åŠ¨ä½œ</th><th style="text-align:center">æè¿°</th></tr></thead><tbody><tr><td style="text-align:center">sysinit</td><td style="text-align:center">åœ¨ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ process æ‰ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</td></tr><tr><td style="text-align:center">respawn</td><td style="text-align:center">å½“ process ç»ˆæ­¢ä»¥åé©¬ä¸Šå¯åŠ¨ä¸€ä¸ªæ–°çš„ã€‚</td></tr><tr><td style="text-align:center">askfirst</td><td style="text-align:center">å’Œ respawn ç±»ä¼¼ï¼Œåœ¨è¿è¡Œ process ä¹‹å‰åœ¨æ§åˆ¶å°ä¸Šæ˜¾ç¤ºâ€œPlease press Enter to activate this console.â€ã€‚åªè¦ç”¨æˆ·æŒ‰ä¸‹â€œEnterâ€é”®ä»¥åæ‰ä¼šæ‰§è¡Œ processã€‚</td></tr><tr><td style="text-align:center">wait</td><td style="text-align:center">å‘Šè¯‰ initï¼Œè¦ç­‰å¾…ç›¸åº”çš„è¿›ç¨‹æ‰§è¡Œå®Œä»¥åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</td></tr><tr><td style="text-align:center">once</td><td style="text-align:center">ä»…æ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸”ä¸ä¼šç­‰å¾… process æ‰§è¡Œå®Œæˆã€‚</td></tr><tr><td style="text-align:center">restart</td><td style="text-align:center">å½“ init é‡å¯çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œ proceeã€‚</td></tr><tr><td style="text-align:center">ctrlaltdel</td><td style="text-align:center">å½“æŒ‰ä¸‹ ctrl+alt+del ç»„åˆé”®æ‰ä¼šæ‰§è¡Œ processã€‚</td></tr><tr><td style="text-align:center">shutdown</td><td style="text-align:center">å…³æœºçš„æ—¶å€™æ‰§è¡Œprocessã€‚</td></tr></tbody></table><p>åœ¨ inittab æ–‡ä»¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">etc/inittab</span></span><br><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">console::askfirst:-/bin/sh</span><br><span class="line">::restart:/sbin/init</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br></pre></td></tr></table></figure><ul><li>ç³»ç»Ÿå¯åŠ¨ä»¥åè¿è¡Œ <code>/etc/init.d/rcS</code> è„šæœ¬æ–‡ä»¶</li><li>å°† console ä½œä¸ºæ§åˆ¶å°ç»ˆç«¯ï¼Œä¹Ÿå°±æ˜¯ ttymxc0ï¼Œä¸²å£</li><li>é‡å¯æ—¶è¿è¡Œ <code>/sbin/init</code> è„šæœ¬æ–‡ä»¶</li><li>æŒ‰ä¸‹ç»„åˆé”®å°±è¿è¡Œ <code>/sbin/reboot</code></li><li>å…³æœºæ—¶æ‰§è¡Œ <code>/bin/umount -a -r</code> å‘½ä»¤ï¼Œå¸è½½å„ä¸ªæ–‡ä»¶ç³»ç»Ÿ</li><li>å…³æœºæ—¶æ‰§è¡Œ <code>/sbin/swapoff -a</code> å‘½ä»¤ï¼Œå…³é—­äº¤æ¢åˆ†åŒº</li></ul><h4 id="æµ‹è¯•æ ¹æ–‡ä»¶ç³»ç»Ÿ">æµ‹è¯•æ ¹æ–‡ä»¶ç³»ç»Ÿ</h4><p>æµ‹è¯•åˆ¶ä½œå¥½çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œæµ‹è¯•è‡ªå·±ç¼–å†™çš„ç¨‹åºæ˜¯å¦èƒ½è¿è¡Œï¼Œæ˜¯å¦æ”¯æŒç¨‹åºå¼€æœºè‡ªå¯åŠ¨ï¼Œä¸­æ–‡æ”¯æŒæ˜¯å¦æ­£å¸¸ï¼Œèƒ½ä¸èƒ½é“¾æ¥ç­‰åŠŸèƒ½ã€‚</p><h5 id="ç¼–è¯‘æµ‹è¯•-hello-c">ç¼–è¯‘æµ‹è¯• hello.c</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello world!\r\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæ–‡ä»¶èƒ½å¤Ÿæ­£å¸¸å¾ªç¯æ‰“å°ï¼Œåˆ™è¯æ˜æµ‹è¯•æˆåŠŸã€‚</p><h5 id="ä¸­æ–‡æ˜¾ç¤ºæµ‹è¯•">ä¸­æ–‡æ˜¾ç¤ºæµ‹è¯•</h5><p>æ–°å»ºä¸­æ–‡åå­—çš„ç›®å½•å¹¶åœ¨æ–‡ä»¶ä¸­å†™å…¥ä¸­æ–‡ï¼Œçœ‹æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸ã€‚</p><p><img src="image-20240705182649176.png" alt="image-20240705182649176"></p><p>å¯ä»¥çœ‹åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿå¯ä»¥æ­£å¸¸æ”¯æŒä¸­æ–‡æ˜¾ç¤ºã€‚</p><h5 id="å¼€æœºè‡ªå¯åŠ¨æµ‹è¯•">å¼€æœºè‡ªå¯åŠ¨æµ‹è¯•</h5><p>è¿™é‡Œä»¥å¼€æœºè‡ªåŠ¨æ‰§è¡Œ hello ç¨‹åºä¸ºä¾‹å­åœ¨ /etc/init.d/rcS æ–‡ä»¶æ·»åŠ å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æ·»åŠ å¼€å¯è‡ªåŠ¨ç¨‹åº</span></span><br><span class="line">cd /drivers</span><br><span class="line">./hello &amp;</span><br><span class="line">cd /</span><br></pre></td></tr></table></figure><p>é‡å¯å¼€å‘æ¿ï¼Œçœ‹æ˜¯å¦è‡ªåŠ¨è¿è¡Œã€‚</p><p><img src="image-20240705183828147.png" alt="image-20240705183828147"></p><p>è¾“å…¥ ps æŸ¥çœ‹ hello ç¨‹åºçš„è¿›ç¨‹ pid å·ï¼Œè¾“å…¥å‘½ä»¤å…³é—­ç¨‹åºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 pid</span><br></pre></td></tr></table></figure><h5 id="ç½‘ç»œè¿æ¥æµ‹è¯•">ç½‘ç»œè¿æ¥æµ‹è¯•</h5><p>æµ‹è¯•å¼€å‘æ¿èƒ½ä¸èƒ½ä¸Šç½‘ï¼Œå¯¹ç™¾åº¦å®˜ç½‘è¿›è¡Œ ping å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping baidu.com</span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°æç¤º <code>ping: bad address 'baidu.com'</code>ï¼Œè¿™æ˜¯åŸŸåè§£æé”™è¯¯çš„åŸå› ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰é…ç½®åŸŸåè§£ææœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯ DNS çš„ IP åœ°å€ã€‚åœ¨æ ¹æ–‡ä»¶ç›®å½•ä¸‹æ–°å»º <code>/etc/resolv.conf</code> æ–‡ä»¶ï¼Œæ·»åŠ  DNS æœåŠ¡å™¨ï¼Œä¸€èˆ¬å¡«å†™è‡ªå·±çš„ç½‘å…³å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">namserver 192.168.1.1</span><br><span class="line">nameserver 114.114.114.114</span><br></pre></td></tr></table></figure><p>é‡æ–° ping ç™¾åº¦ç½‘ç«™æµ‹è¯•æ˜¯å¦æˆåŠŸã€‚</p><h2 id="çƒ§å†™ç³»ç»Ÿ">çƒ§å†™ç³»ç»Ÿ</h2><p>å‰é¢æµ‹è¯•ç³»ç»Ÿæ—¶éƒ½æ˜¯é€šè¿‡ç½‘ç»œè¿æ¥è¿›è¡Œæµ‹è¯•ï¼Œç­‰ç³»ç»Ÿæµ‹è¯•ç¨³å®šåï¼Œå°±å°†ç³»ç»Ÿçƒ§å½•åˆ° EMMC æˆ– NAND ä¸­ï¼Œå°±ä¸ç”¨æ¯æ¬¡éƒ½è¿›è¡Œç½‘ç»œè¿æ¥äº†ã€‚</p><p><img src="image-20240713152901946.png" alt="image-20240713152901946"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># /etc/inittab</span><br><span class="line">#</span><br><span class="line"># Copyright (C) 2001 Erik Andersen &lt;andersen@codepoet.org&gt;</span><br><span class="line">#</span><br><span class="line"># Note: BusyBox init doesn&#x27;t support runlevels.  The runlevels field is</span><br><span class="line"># completely ignored by BusyBox init. If you want runlevels, use</span><br><span class="line"># sysvinit.</span><br><span class="line">#</span><br><span class="line"># Format for each entry: &lt;id&gt;:&lt;runlevels&gt;:&lt;action&gt;:&lt;process&gt;</span><br><span class="line">#</span><br><span class="line"># id        == tty to run on, or empty for /dev/console</span><br><span class="line"># runlevels == ignored</span><br><span class="line"># action    == one of sysinit, respawn, askfirst, wait, and once</span><br><span class="line"># process   == program to run</span><br><span class="line"></span><br><span class="line"># Startup the system</span><br><span class="line">::sysinit:/bin/mount -t proc proc /proc</span><br><span class="line">::sysinit:/bin/mount -o remount,rw /</span><br><span class="line">::sysinit:/bin/mkdir -p /dev/pts /dev/shm</span><br><span class="line">::sysinit:/bin/mount -a</span><br><span class="line">::sysinit:/sbin/swapon -a</span><br><span class="line">null::sysinit:/bin/ln -sf /proc/self/fd /dev/fd</span><br><span class="line">null::sysinit:/bin/ln -sf /proc/self/fd/0 /dev/stdin</span><br><span class="line">null::sysinit:/bin/ln -sf /proc/self/fd/1 /dev/stdout</span><br><span class="line">null::sysinit:/bin/ln -sf /proc/self/fd/2 /dev/stderr</span><br><span class="line">::sysinit:/bin/hostname -F /etc/hostname</span><br><span class="line"># now run any rc scripts</span><br><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line"></span><br><span class="line"># Put a getty on the serial port</span><br><span class="line">ttymxc0::respawn:/sbin/getty -L  ttymxc0 0 vt100 # GENERIC_SERIAL</span><br><span class="line"></span><br><span class="line"># Stuff to do for the 3-finger salute</span><br><span class="line">#::ctrlaltdel:/sbin/reboot</span><br><span class="line"></span><br><span class="line"># Stuff to do before rebooting</span><br><span class="line">::shutdown:/etc/init.d/rcK</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/bin:/sbin:/usr/bin:/usr/sbin</span><br><span class="line"></span><br><span class="line">export LD_LIBRARY_PATH=/opt/qt5.15.13/lib:/opt/opencv-4.5.4-arm/lib</span><br><span class="line"></span><br><span class="line">if [ &quot;$PS1&quot; ]; then</span><br><span class="line">        if [ &quot;`id -u`&quot; -eq 0 ]; then</span><br><span class="line">                export PS1=&#x27;# &#x27;</span><br><span class="line">        else</span><br><span class="line">                export PS1=&#x27;$ &#x27;</span><br><span class="line">        fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">export PAGER=&#x27;/bin/more&#x27;</span><br><span class="line">export EDITOR=&#x27;/bin/vi&#x27;</span><br><span class="line"></span><br><span class="line"># Source configuration files from /etc/profile.d</span><br><span class="line">for i in /etc/profile.d/*.sh ; do</span><br><span class="line">        if [ -r &quot;$i&quot; ]; then</span><br><span class="line">                . $i</span><br><span class="line">        fi</span><br><span class="line">done</span><br><span class="line">unset i</span><br><span class="line">#export QT_QPA_PLATFORM=linuxfb:fb=/dev/fb0</span><br><span class="line">#export QT_QPA_FONTDIR=/usr/lib/fonts</span><br><span class="line">EVENT=$(cat /proc/bus/input/devices | grep -E &#x27;TSC2007|ft5x0x_ts|goodix-ts&#x27; -A4</span><br><span class="line">export TSLIB_ROOT=/opt/tslib1.21</span><br><span class="line">export TSLIB_TSDEVICE=/dev/input/$EVENT</span><br><span class="line">export TSLIB_CONFFILE=/opt/tslib1.21/etc/ts.conf</span><br><span class="line">export TSLIB_CALIBFILE=/etc/pointercal</span><br><span class="line">export TSLIB_PLUGINDIR=/opt/tslib1.21/lib/ts</span><br><span class="line">export TSLIB_CONSOLEDEVICE=none</span><br><span class="line">export QT_ROOT=/opt/qt5.15.13</span><br><span class="line">export QT_QPA_FONTDIR=$QT_ROOT/lib/fonts</span><br><span class="line">export QT_QPA_PLATFORM_PLUGIN_PATH=$QT_ROOT/plugins</span><br><span class="line">export QT_QPA_PLATFORM=linuxfb:fb=/dev/fb0</span><br><span class="line"></span><br><span class="line">export QT_QPA_GENERIC_PLUGINS=tslib:/dev/input/event1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HOSTNAME=&#x27;/bin/hostname:&#x27;</span><br><span class="line">PS1=&#x27;\[\e[0;32m\][\u@\h:\w]\$ \[\e[m\]&#x27;</span><br><span class="line">shopt -s checkwinsize</span><br><span class="line">resize</span><br><span class="line">export PS1 HOSTNAME</span><br><span class="line">~</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Start all init scripts in /etc/init.d</span><br><span class="line"># executing them in numerical order.</span><br><span class="line">#</span><br><span class="line">psplash -n &amp;</span><br><span class="line">for i in /etc/init.d/S??* ;do</span><br><span class="line"></span><br><span class="line">     # Ignore dangling symlinks (if any).</span><br><span class="line">     [ ! -f &quot;$i&quot; ] &amp;&amp; continue</span><br><span class="line"></span><br><span class="line">     case &quot;$i&quot; in</span><br><span class="line">        *.sh)</span><br><span class="line">            # Source shell script for speed.</span><br><span class="line">            (</span><br><span class="line">                trap - INT QUIT TSTP</span><br><span class="line">                set start</span><br><span class="line">                . $i</span><br><span class="line">            )</span><br><span class="line">            ;;</span><br><span class="line">        *)</span><br><span class="line">            # No sh extension, so fork subprocess.</span><br><span class="line">            $i start</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">/bin/hostname -F /etc/hostnames</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linux-ç³»ç»Ÿç§»æ¤&quot;&gt;Linux ç³»ç»Ÿç§»æ¤&lt;/h1&gt;
&lt;h2 id=&quot;åºè¨€&quot;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;Linux å­¦äº†æœ‰äº›æ—¶é—´äº†ï¼Œæ‰‹ä¸Šçš„å¼€å‘æ¿å¾ˆå¤šåŠŸèƒ½éƒ½æå‰åšå¥½äº†ï¼Œå¯¹åˆå­¦è€…æŒºå‹å¥½çš„ï¼Œä½†æ˜¯ä¸ºäº†å­¦åˆ°æ›´åˆ°ä¸œè¥¿ï¼Œå°±æ¥è¯•è¯•ç§»æ¤ä¸‹æ–°çš„ Linux ç³»ç»Ÿåˆ°å¼€å‘æ¿ä¸Šã€‚&lt;/p&gt;
&lt;</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux åµŒå…¥å¼" scheme="http://www.obito.top/tags/Linux-%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Linux-LCDé©±åŠ¨</title>
    <link href="http://www.obito.top/2024/06/30/Linux-LCD%E9%A9%B1%E5%8A%A8/"/>
    <id>http://www.obito.top/2024/06/30/Linux-LCD%E9%A9%B1%E5%8A%A8/</id>
    <published>2024-06-30T03:03:49.000Z</published>
    <updated>2024-08-22T12:49:46.117Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux-lcdé©±åŠ¨">Linux-LCDé©±åŠ¨</h1><h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2><h3 id="ç¡¬ä»¶ç¯å¢ƒ">ç¡¬ä»¶ç¯å¢ƒ</h3><ul><li><strong>å¼€å‘æ¿å‹å·</strong>ï¼š <a href="https://blog.csdn.net/thisway_diy/article/details/109841372">100ask_imx6ull_pro å¼€å‘æ¿</a></li><li><strong>å¤„ç†å™¨ç±»å‹</strong>ï¼šNXP IMX6ULL</li><li><strong>å¤„ç†å™¨æ¶æ„</strong>ï¼šæ©å•æ ¸ Cortex-A7</li><li><strong>å¤„ç†å™¨ä¸»é¢‘</strong>ï¼š800MHZ</li><li><strong>å†…å­˜å®¹é‡</strong>ï¼š512 MB DDR3</li><li><strong>å­˜å‚¨ä»‹è´¨</strong>ï¼š4GB eMMC</li><li><strong>æœ¬æ¬¡æµ‹è¯•çš„é©±åŠ¨</strong>ï¼š7 å¯¸ LCD å±å¹•</li></ul><h3 id="è½¯ä»¶ç¯å¢ƒ">è½¯ä»¶ç¯å¢ƒ</h3><ul><li>å®¿ä¸»æœº<ul><li><strong>å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ</strong>ï¼šUbuntu 18.04</li><li><strong>äº¤å‰ç¼–è¯‘å™¨</strong>ï¼š100ask æä¾›çš„å·¥å…·é“¾ arm-buildroot-linux-gnueabihf- <strong>æ”¯æŒçš„æœ€ä½å†…æ ¸ç‰ˆæœ¬</strong>ï¼š4.9.0</li></ul></li><li>å¼€å‘æ¿<ul><li><strong>U-Boot</strong>ï¼šä¸€å¼€å§‹ç”¨çš„ NXP å®˜æ–¹æä¾›çš„ç‰ˆæœ¬ä½†ä¸èƒ½æ­£å¸¸å¯åŠ¨å†…æ ¸ï¼Œåæ”¹ä¸º 100ask æä¾›çš„ç‰ˆæœ¬</li><li><strong>å†…æ ¸ç‰ˆæœ¬</strong>ï¼š <a href="https://github.com/nxp-imx/linux-imx/tree/imx_4.9.88_2.0.0_ga">NXP æä¾›çš„ 4.9.88 ç‰ˆæœ¬</a></li><li><strong>æ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹</strong>ï¼š<a href="https://busybox.net/downloads/">BusyBox 1.29.0</a></li></ul></li></ul><h2 id="oled-å’Œ-lcd">OLED å’Œ LCD</h2><ul><li>OLEDï¼ˆOrganic Light-Emitting Diodeï¼Œæœ‰æœºå‘å…‰äºŒæç®¡ï¼‰å±å¹•ä¸­çš„<strong>æ¯ä¸ªåƒç´ ç‚¹éƒ½èƒ½è‡ªå‘å…‰</strong>ï¼Œå½“ç”µæµé€šè¿‡æ—¶ï¼Œæœ‰æœºææ–™å±‚å‘å…‰ã€‚<ul><li>OLED å±å¹•å“åº”æ—¶é—´æ›´å¿«</li><li>OLED ä¸éœ€è¦èƒŒå…‰å±‚ï¼Œå¯ä»¥å…³é—­å¯¹åº”åƒç´ å‘å…‰ï¼Œé™ä½åŠŸè€—</li><li>OLED é¢‘é—ªç°è±¡æ˜æ˜¾ï¼Œå¯èƒ½ä¼šçƒ§å±</li></ul></li><li>LCDï¼ˆLiquid Crystal Displayï¼Œæ¶²æ™¶æ˜¾ç¤ºå™¨ï¼‰å±å¹•æœ¬èº«ä¸å‘å…‰ï¼Œéœ€è¦<strong>èƒŒå…‰å±‚æ¥æä¾›å…‰æº</strong>ï¼Œé€šè¿‡æ§åˆ¶æ¶²æ™¶åˆ†å­çš„è½¬åŠ¨æ–¹å‘æ¥è°ƒèŠ‚å…‰çº¿çš„é€è¿‡ï¼Œä»è€Œæ˜¾ç¤ºå›¾åƒã€‚<ul><li>LCD éœ€è¦èƒŒå…‰å±‚æä¾›å…‰æºï¼ŒåŠŸè€—ç›¸å¯¹è¾ƒé«˜</li><li>LCD æ— é¢‘é—ªï¼Œæ›´è€ç”¨ï¼Œå¯¿å‘½æ›´é•¿</li></ul></li></ul><blockquote><p><a href="https://www.topwaydisplay.com/cn/blog/lcd-oled-microled-comparison">https://www.topwaydisplay.com/cn/blog/lcd-oled-microled-comparison</a></p></blockquote><h2 id="lcdæ—¶åºå‚æ•°æ¦‚å¿µ">LCDæ—¶åºå‚æ•°æ¦‚å¿µ</h2><h3 id="lcd-ä¿¡å·çº¿">LCD ä¿¡å·çº¿</h3><p>LCD ä¿¡å·çº¿æœ‰ 24 æ ¹æ•°æ®çº¿å‡åˆ†ä¸ºçº¢è‰²æ•°æ®ã€ç»¿è‰²æ•°æ®å’Œè“è‰²æ•°æ®ï¼Œæ§åˆ¶çº¿æœ‰ CLKã€VSYNCã€HSYNCå’Œ DEã€‚</p><ul><li>CLKï¼šåŒæ­¥æ—¶é’Ÿä¿¡å·ã€‚</li><li>VSYNCï¼šå‚ç›´åŒæ­¥ä¿¡å·ï¼Œä¹Ÿå«å¸§åŒæ­¥ä¿¡å·ï¼Œè¡¨ç¤ºæ¶²æ™¶å±ä¸€å¸§åƒç´ æ•°æ®çš„ä¼ è¾“ç»“æŸï¼Œæ¯ä¼ è¾“å®Œæˆä¸€å¸§åƒç´ æ•°æ®æ—¶ï¼ŒVSYNC ä¼šå‘ç”Ÿç”µå¹³è·³å˜ã€‚</li><li>HSYNCï¼šæ°´å¹³åŒæ­¥ä¿¡å·ï¼Œä¹Ÿå«è¡ŒåŒæ­¥ä¿¡å·ï¼Œè¡¨ç¤ºæ¶²æ™¶å±ä¸€è¡Œåƒç´ æ•°æ®çš„ä¼ è¾“ç»“æŸï¼Œæ¯ä¼ è¾“å®Œæˆæ¶²æ™¶å±çš„ä¸€è¡Œåƒç´ æ•°æ®æ—¶ï¼ŒHSYNC ä¼šå‘ç”Ÿç”µå¹³è·³å˜ã€‚</li><li>DEï¼šæ•°æ®ä½¿èƒ½ä¿¡å·ï¼Œè¡¨ç¤ºæ•°æ®çš„æœ‰æ•ˆæ€§ï¼Œå½“ DE ä¸ºé«˜ç”µå¹³æ—¶ï¼ŒRGB ä¿¡å·çº¿è¡¨ç¤ºçš„æ•°æ®æœ‰æ•ˆã€‚</li></ul><h3 id="lcd-æ•°æ®ä¼ è¾“æ—¶åº">LCD æ•°æ®ä¼ è¾“æ—¶åº</h3><p>LCD ä¼ è¾“ä¸€å¸§å›¾å½¢æ•°æ®çš„æ—¶åºå¤§è‡´å¦‚ä¸‹ï¼š</p><p><img src="image81.jpeg" alt="image8"></p><p>LCD æ˜¾ç¤ºçš„å›¾åƒå¯çœ‹ä½œä¸€ä¸ªçŸ©å½¢ï¼Œæ¶²æ™¶å±æœ‰ä¸€ä¸ªæ˜¾ç¤ºæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘å°†è¦æ˜¾ç¤ºçš„åƒç´ ã€‚æ˜¾ç¤ºæŒ‡é’ˆçš„æ‰«ææ–¹å‘æ–¹å‘<strong>ä»å·¦åˆ°å³ã€ä»ä¸Šåˆ°ä¸‹</strong>ï¼Œä¸€ä¸ªåƒç´ ç‚¹ä¸€ä¸ªåƒç´ ç‚¹åœ°æç»˜å›¾å½¢ã€‚è¿™äº›åƒç´ ç‚¹çš„æ•°æ®é€šè¿‡ RGB æ•°æ®çº¿ä¼ è¾“è‡³æ¶²æ™¶å±ï¼Œå®ƒä»¬åœ¨åŒæ­¥æ—¶é’Ÿ CLK çš„é©±åŠ¨ä¸‹ä¸€ä¸ªä¸€ä¸ªåœ°ä¼ è¾“åˆ°æ¶²æ™¶å±ä¸­ï¼Œäº¤ç»™æ˜¾ç¤ºæŒ‡é’ˆï¼Œ<strong>ä¼ è¾“å®Œæˆä¸€è¡Œ</strong>æ—¶ï¼Œæ°´å¹³åŒæ­¥ä¿¡å· <strong>HSYNC ç”µå¹³è·³å˜ä¸€æ¬¡</strong>ï¼Œè€Œ<strong>ä¼ è¾“å®Œä¸€å¸§</strong>æ—¶ <strong>VSYNC ç”µå¹³è·³å˜ä¸€æ¬¡</strong>ã€‚</p><p><img src="image92.jpeg" alt="image9"></p><p>æ¶²æ™¶æ˜¾ç¤ºæŒ‡é’ˆ<strong>åœ¨è¡Œä¸è¡Œä¹‹é—´ï¼Œå¸§ä¸å¸§ä¹‹é—´åˆ‡æ¢æ—¶éœ€è¦å»¶æ—¶</strong>ï¼Œè€Œä¸” HSYNC åŠ VSYNC ä¿¡å·æœ¬èº«ä¹Ÿæœ‰å®½åº¦ã€‚</p><ul><li>VBPï¼šå‚ç›´åè‚©ï¼ˆvertical back porchï¼‰ï¼Œè¡¨ç¤ºä¸€å¸§å›¾åƒå¼€å§‹æ—¶ï¼Œè¿™ä¸ª VSYNC ä¿¡å·ä»¥åæ— æ•ˆçš„è¡Œæ•°ã€‚</li><li>VFPï¼šå‚ç›´å‰è‚©ï¼ˆvertical front porchï¼‰ï¼Œè¡¨ç¤ºä¸€å¸§å›¾åƒç»“æŸåï¼Œåˆ°ä¸‹ä¸€ä¸ª VSYNC ä¿¡å·æ— æ•ˆçš„è¡Œæ•°ã€‚</li><li>HBPï¼šæ°´å¹³åè‚©ï¼ˆhorizontal back porchï¼‰ï¼Œè¡¨ç¤º HSYNC ä¿¡å·å¼€å§‹åˆ°ä¸€è¡Œçš„æœ‰æ•ˆæ•°æ®å¼€å§‹ä¹‹é—´çš„ CLK ä¸ªæ•°ã€‚</li><li>HFPï¼šæ°´å¹³å‰è‚©ï¼ˆhorizontal front porchï¼‰ï¼Œè¡¨ç¤ºä¸€è¡Œçš„æœ‰æ•ˆæ•°æ®ç»“æŸåˆ°ä¸‹ä¸€ä¸ª HSYNC ä¿¡å·å¼€å§‹ä¹‹é—´çš„ CLKçš„ä¸ªæ•°ã€‚</li><li>VSWï¼šè¡¨ç¤º VSYNC ä¿¡å·çš„å®½åº¦ï¼Œå•ä½ä¸ºè¡Œã€‚</li><li>HSWï¼šè¡¨ç¤º HSYNC ä¿¡å·çš„å®½åº¦ï¼Œå•ä½ä¸º CLK çš„ä¸ªæ•°ã€‚</li></ul><blockquote><p><a href="https://doc.embedfire.com/mcu/i.mxrt/i.mxrt1052/zh/latest/doc/chapter24/chapter24.html">24. eLCDIFâ€”æ¶²æ™¶æ˜¾ç¤º â€” é‡ç« i.MX RTåº“å¼€å‘å®æˆ˜æŒ‡å—â€”â€”åŸºäºi.MXRT1052 æ–‡æ¡£ (embedfire.com)</a></p></blockquote><h2 id="linux-lcdé©±åŠ¨è§£æ">Linux-LCDé©±åŠ¨è§£æ</h2><h3 id="lcd-æ˜¾ç¤ºåŸç†">LCD æ˜¾ç¤ºåŸç†</h3><p>Linux å†…æ ¸é©±åŠ¨ç”³è¯·ä¸€ç‰‡å†…å­˜ç©ºé—´â€”â€”Framebufferï¼ŒLCD æ§åˆ¶å™¨å°† Framebuffer ä¸­çš„æ•°æ®æ‹·è´åˆ° LCD çš„ SRAM ä¸Šæ˜¾ç¤ºå›¾åƒã€‚</p><p><img src="image-20240630112737450.png" alt="image-20240630112737450"></p><h3 id="framebuffer-è®¾å¤‡">Framebuffer è®¾å¤‡</h3><p>Framebufferï¼ˆfb å¸§ç¼“å†²ï¼‰ï¼Œæ˜¯ Linux å†…æ ¸è™šæ‹Ÿå‡ºæ¥çš„ä¸€ä¸ªè®¾å¤‡ï¼Œå±äº<strong>å­—ç¬¦è®¾å¤‡</strong>ç±»å‹ã€‚ä¸»è¦ä½œç”¨æ˜¯<strong>ä¸ºåº”ç”¨å±‚æä¾›ä¸€ä¸ªç»Ÿä¸€æ ‡å‡†æ¥å£çš„æ˜¾ç¤ºè®¾å¤‡</strong>ï¼Œé€šè¿‡ fb åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥å¯¹æ˜¾å­˜è¿›è¡Œæ“ä½œã€‚ç”¨æˆ·ä¸å¿…å…³å¿ƒç‰©ç†æ˜¾å­˜çš„ä½ç½®ã€æ¢é¡µæœºåˆ¶ç­‰ç­‰å…·ä½“ç»†èŠ‚ï¼Œ è¿™äº›éƒ½æ˜¯ç”± FrameBuffer è®¾å¤‡é©±åŠ¨æ¥å®Œæˆçš„ã€‚</p><p>LCD é©±åŠ¨ç¼–å†™å®Œæˆåä¼šç”Ÿæˆä¸€ä¸ªåä¸º <code>/dev/fbX(X=0~n)</code> çš„è®¾å¤‡ï¼ŒNXP å®˜æ–¹çš„ Linux å†…æ ¸é»˜è®¤å·²ç»å¼€å¯ LCD é©±åŠ¨äº†ï¼ŒNXP å®˜æ–¹çš„è®¾å¤‡æ ‘å·²ç»æ·»åŠ äº† LCD è®¾å¤‡èŠ‚ç‚¹ï¼Œåªæ˜¯ç”¨åˆ°çš„ IO å£ä»¥åŠå±å¹•å‚æ•°å¯èƒ½ä¸åŒï¼Œ<strong>æ‰€ä»¥æˆ‘ä»¬è¦åšçš„æ˜¯åœ¨è®¾å¤‡æ ‘ä¿®æ”¹æˆè‡ªå·±ä½¿ç”¨çš„ IO å£å’Œå±å¹•å‚æ•°ã€‚</strong></p><h3 id="lcd-è®¾å¤‡æ ‘æè¿°ä¿¡æ¯è§£æ">LCD è®¾å¤‡æ ‘æè¿°ä¿¡æ¯è§£æ</h3><h4 id="lcd-å±å¹•-io-é…ç½®">LCD å±å¹• IO é…ç½®</h4><p>100ASK_IMX6ULL_PRO å¼€å‘æ¿çš„ LCD èƒŒå…‰å¼•è„šã€æ•°æ®çº¿ã€æ§åˆ¶çº¿å‡å’Œå’Œ NXP å¼€å‘æ¿çš„ä¸€æ ·ï¼Œåªæœ‰å¤ä½å¼•è„šä¸åŒï¼Œæ‰€ä»¥ <strong>IO é…ç½®éƒ¨åˆ†åªéœ€è¦ä¿®æ”¹å¤ä½å¼•è„šå³å¯ã€‚</strong></p><p>NXP å®˜æ–¹çš„è®¾å¤‡æ ‘ï¼šimx6ul-14x14-evk.dts æ–‡ä»¶ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_lcdif_dat: lcdifdatgrp &#123;</span><br><span class="line">fsl,pins = &lt;</span><br><span class="line">MX6UL_PAD_LCD_DATA00__LCDIF_DATA00  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA01__LCDIF_DATA01  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA02__LCDIF_DATA02  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA03__LCDIF_DATA03  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA04__LCDIF_DATA04  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA05__LCDIF_DATA05  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA06__LCDIF_DATA06  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA07__LCDIF_DATA07  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA08__LCDIF_DATA08  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA09__LCDIF_DATA09  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA10__LCDIF_DATA10  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA11__LCDIF_DATA11  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA12__LCDIF_DATA12  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA13__LCDIF_DATA13  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA14__LCDIF_DATA14  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA15__LCDIF_DATA15  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA16__LCDIF_DATA16  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA17__LCDIF_DATA17  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA18__LCDIF_DATA18  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA19__LCDIF_DATA19  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA20__LCDIF_DATA20  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA21__LCDIF_DATA21  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA22__LCDIF_DATA22  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_DATA23__LCDIF_DATA23  <span class="number">0x79</span></span><br><span class="line">&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">pinctrl_lcdif_ctrl: lcdifctrlgrp &#123;</span><br><span class="line">fsl,pins = &lt;</span><br><span class="line">MX6UL_PAD_LCD_CLK__LCDIF_CLK    <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_ENABLE__LCDIF_ENABLE  <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_HSYNC__LCDIF_HSYNC    <span class="number">0x79</span></span><br><span class="line">MX6UL_PAD_LCD_VSYNC__LCDIF_VSYNC    <span class="number">0x79</span></span><br><span class="line"><span class="comment">/* used for lcd reset */</span></span><br><span class="line">MX6UL_PAD_SNVS_TAMPER9__GPIO5_IO09  <span class="number">0x79</span></span><br><span class="line">&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">pinctrl_pwm1: pwm1grp &#123;</span><br><span class="line">fsl,pins = &lt;</span><br><span class="line">MX6UL_PAD_GPIO1_IO08__PWM1_OUT   <span class="number">0x110b0</span></span><br><span class="line">&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>å­èŠ‚ç‚¹ pinctrl_lcdif_dat å®šä¹‰äº† LCD å±å¹•çš„ 24 æ ¹æ•°æ®çº¿é…ç½®é¡¹</li><li>å­èŠ‚ç‚¹ pinctrl_lcdif_ctrl å®šä¹‰äº† LCD å±å¹•çš„å¤ä½å¼•è„šå’Œ 4 æ ¹æ§åˆ¶çº¿ï¼šCLKã€ENABLEã€HSYNCã€VSYNC</li><li>å­èŠ‚ç‚¹ pinctrl_pwm1 å®šä¹‰äº† LCD å±å¹•èƒŒå…‰ PWM å¼•è„šé…ç½®é¡¹</li></ul><p><strong>NXP å®˜æ–¹è®¾å¤‡æ ‘æ˜¯å°† GPIO5_9 ä½œä¸º LCD å¤ä½å¼•è„šï¼Œè·Ÿ 100ask å¼€å‘æ¿çš„å¤ä½å¼•è„šä¸åŒ</strong>ï¼Œåœ¨ iomuxc èŠ‚ç‚¹ä¸‹çš„ imx6ul-evk å­èŠ‚ç‚¹æ·»åŠ ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_lcdif_reset: lcdifresetgrp &#123;</span><br><span class="line">fsl,pins = &lt;</span><br><span class="line">/* used for lcd reset */</span><br><span class="line">MX6UL_PAD_LCD_RESET__GPIO3_IO04  0x1b0b0</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>Linux ç³»ç»Ÿå¦‚ä½•çŸ¥é“å¼•è„š PWM1_OUT æ˜¯ç”¨æ¥æ§åˆ¶ LCD èƒŒå…‰çš„å‘¢ï¼Ÿé€šè¿‡ backlight èŠ‚ç‚¹æ¥å°† LCD èƒŒå…‰å’Œå¼•è„š PWM1_OUT è¿æ¥èµ·æ¥ï¼š</strong></p><blockquote><p>backlight èŠ‚ç‚¹æè¿°å¯ä»¥å‚è€ƒ Documentation/devicetree/indings/video/backlight/pwm-backlight.txt è¿™ä¸ªæ–‡æ¡£</p></blockquote><p>NXP å®˜æ–¹çš„è®¾å¤‡æ ‘ï¼šimx6ul-14x14-evk.dts æ–‡ä»¶ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">backlight &#123;</span><br><span class="line">compatible = <span class="string">&quot;pwm-backlight&quot;</span>;</span><br><span class="line">pwms = &lt;&amp;pwm1 <span class="number">0</span> <span class="number">5000000</span>&gt;;</span><br><span class="line">brightness-levels = &lt;<span class="number">0</span> <span class="number">4</span> <span class="number">8</span> <span class="number">16</span> <span class="number">32</span> <span class="number">64</span> <span class="number">128</span> <span class="number">255</span>&gt;;</span><br><span class="line"><span class="keyword">default</span>-brightness-level = &lt;<span class="number">6</span>&gt;;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>compatible = â€œpwm-backlightâ€; åœ¨ Linux å†…æ ¸ä¸­ <code>drivers/video/backlight/pwm_bl.c</code> æ–‡ä»¶ä¸­åˆå…·ä½“çš„é©±åŠ¨ç¨‹åº</li><li>pwms å±æ€§ç”¨äºæè¿°èƒŒå…‰æ‰€ä½¿ç”¨çš„ PWM å’Œ PWM é¢‘ç‡ï¼Œ5000000 è¡¨ç¤º 5000000 nsï¼Œå³ 5 msï¼Œ1s / 5ms = 200 Hzï¼Œå³ PWM é¢‘ç‡ä¸º 200Hz</li><li>brightness-levels å±æ€§æè¿°äº®åº¦çº§åˆ«ï¼ŒèŒƒå›´ä¸º0~255ï¼Œ0 è¡¨ç¤º PWM å ç©ºæ¯”ä¸º 0%ï¼Œä¹Ÿå°±æ˜¯äº®åº¦æœ€ä½ï¼Œ255 è¡¨ç¤º 100% å ç©ºæ¯”ï¼Œä¹Ÿå°±æ˜¯äº®åº¦æœ€é«˜</li><li>default-brightness-level å±æ€§ä¸ºé»˜è®¤äº®åº¦çº§åˆ«</li></ul><h4 id="lcd-å±å¹•å‚æ•°èŠ‚ç‚¹ä¿¡æ¯">LCD å±å¹•å‚æ•°èŠ‚ç‚¹ä¿¡æ¯</h4><p>imx6ull.dtsi æ–‡ä»¶ï¼šå®šä¹‰äº† LCD èŠ‚ç‚¹é€šç”¨ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lcdif: lcdif@<span class="number">021</span>c8000 &#123;</span><br><span class="line">compatible = <span class="string">&quot;fsl,imx6ul-lcdif&quot;</span>, <span class="string">&quot;fsl,imx28-lcdif&quot;</span>;</span><br><span class="line">reg = &lt;<span class="number">0x021c8000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">interrupts = &lt;GIC_SPI <span class="number">5</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">clocks = &lt;&amp;clks IMX6UL_CLK_LCDIF_PIX&gt;,</span><br><span class="line"> &lt;&amp;clks IMX6UL_CLK_LCDIF_APB&gt;,</span><br><span class="line"> &lt;&amp;clks IMX6UL_CLK_DUMMY&gt;;</span><br><span class="line">clock-names = <span class="string">&quot;pix&quot;</span>, <span class="string">&quot;axi&quot;</span>, <span class="string">&quot;disp_axi&quot;</span>;</span><br><span class="line">status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™äº› LCD èŠ‚ç‚¹é€šç”¨ä¿¡æ¯ï¼Œé€‚ç”¨äº IMX6ULL èŠ¯ç‰‡çš„æ¿å­ï¼Œä¸æ˜¯å®Œæ•´çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œéœ€è¦æˆ‘ä»¬åœ¨è‡ªå·±æ¿å­ä¸Šçš„è®¾å¤‡æ ‘è¿›è¡Œ<strong>è¡¥å…… LCD å±å¹•ä¿¡æ¯</strong>ã€‚</p><p>NXP å®˜æ–¹çš„è®¾å¤‡æ ‘ï¼šimx6ul-14x14-evk.dtsï¼ŒLCD èŠ‚ç‚¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&amp;lcdif &#123;</span><br><span class="line">pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_lcdif_dat</span><br><span class="line">     &amp;pinctrl_lcdif_ctrl&gt;;</span><br><span class="line">display = &lt;&amp;display0&gt;;</span><br><span class="line">status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">display0: display@<span class="number">0</span> &#123;</span><br><span class="line">bits-per-pixel = &lt;<span class="number">16</span>&gt;;</span><br><span class="line">bus-width = &lt;<span class="number">24</span>&gt;;</span><br><span class="line"></span><br><span class="line">display-timings &#123;</span><br><span class="line">native-mode = &lt;&amp;timing0&gt;;</span><br><span class="line"></span><br><span class="line">timing0: timing0 &#123;</span><br><span class="line">clock-frequency = &lt;<span class="number">9200000</span>&gt;;</span><br><span class="line">hactive = &lt;<span class="number">480</span>&gt;;</span><br><span class="line">vactive = &lt;<span class="number">272</span>&gt;;</span><br><span class="line">hfront-porch = &lt;<span class="number">8</span>&gt;;</span><br><span class="line">hback-porch = &lt;<span class="number">4</span>&gt;;</span><br><span class="line">hsync-len = &lt;<span class="number">41</span>&gt;;</span><br><span class="line">vback-porch = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">vfront-porch = &lt;<span class="number">4</span>&gt;;</span><br><span class="line">vsync-len = &lt;<span class="number">10</span>&gt;;</span><br><span class="line">hsync-active = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">vsync-active = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">de-active = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">pixelclk-active = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è®¾å¤‡æ ‘ä¸‹<strong>ä¿®æ”¹æˆè‡ªå·±çš„å±å¹•ä¿¡æ¯ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&amp;lcdif &#123;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_lcdif_dat<span class="comment">/* ä½¿ç”¨åˆ°çš„IO */</span></span><br><span class="line">             &amp;pinctrl_lcdif_ctrl</span><br><span class="line">             &amp;pinctrl_lcdif_reset&gt;; </span><br><span class="line">    display = &lt;&amp;display0&gt;;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    reset-gpios = &lt;&amp;gpio3 <span class="number">4</span> GPIO_ACTIVE_LOW&gt;; <span class="comment">/* å±å¹•å¤ä½IO */</span></span><br><span class="line"></span><br><span class="line">    display0: display &#123;<span class="comment">/* LCD å±æ€§ä¿¡æ¯ */</span></span><br><span class="line">        bits-per-pixel = &lt;<span class="number">24</span>&gt;;<span class="comment">/* RGB888 ä¸€ä¸ªåƒç´ å ç”¨å‡ ä¸ªbit */</span></span><br><span class="line">        bus-width = &lt;<span class="number">24</span>&gt;;<span class="comment">/* æ€»çº¿å®½åº¦ */</span></span><br><span class="line"></span><br><span class="line">        display-timings &#123;</span><br><span class="line">            native-mode = &lt;&amp;timing0&gt;;<span class="comment">/* æ—¶åºä¿¡æ¯ */</span></span><br><span class="line"></span><br><span class="line">             timing0: timing0_1024x768 &#123;</span><br><span class="line">             clock-frequency = &lt;<span class="number">50000000</span>&gt;;<span class="comment">/* LCD åƒç´ æ—¶é’Ÿï¼Œå•ä½Hz */</span></span><br><span class="line">             hactive = &lt;<span class="number">1024</span>&gt;;<span class="comment">/* LCD X è½´åƒç´ ä¸ªæ•° */</span></span><br><span class="line">             vactive = &lt;<span class="number">600</span>&gt;;<span class="comment">/* LCD Y è½´åƒç´ ä¸ªæ•° */</span></span><br><span class="line">             hfront-porch = &lt;<span class="number">160</span>&gt;;<span class="comment">/* LCD hfp å‚æ•° */</span></span><br><span class="line">             hback-porch = &lt;<span class="number">140</span>&gt;;<span class="comment">/* LCD hbp å‚æ•° */</span></span><br><span class="line">             hsync-len = &lt;<span class="number">20</span>&gt;;<span class="comment">/* LCD hspw å‚æ•° */</span></span><br><span class="line">             vback-porch = &lt;<span class="number">20</span>&gt;;<span class="comment">/* LCD vbp å‚æ•° */</span></span><br><span class="line">             vfront-porch = &lt;<span class="number">12</span>&gt;;<span class="comment">/* LCD vfp å‚æ•° */</span></span><br><span class="line">             vsync-len = &lt;<span class="number">3</span>&gt;;<span class="comment">/* LCD vspw å‚æ•° */</span></span><br><span class="line"></span><br><span class="line">             hsync-active = &lt;<span class="number">0</span>&gt;;<span class="comment">/* hsync æ•°æ®çº¿ææ€§ */</span></span><br><span class="line">             vsync-active = &lt;<span class="number">0</span>&gt;;<span class="comment">/* vsync æ•°æ®çº¿ææ€§ */</span></span><br><span class="line">             de-active = &lt;<span class="number">1</span>&gt;;<span class="comment">/* de æ•°æ®çº¿ææ€§ */</span></span><br><span class="line">             pixelclk-active = &lt;<span class="number">0</span>&gt;;<span class="comment">/* clk æ•°æ®çº¿å…ˆææ€§ */</span></span><br><span class="line">             &#125;;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="è¿è¡Œæµ‹è¯•">è¿è¡Œæµ‹è¯•</h4><h5 id="æ·»åŠ ä¼é¹…-logo">æ·»åŠ ä¼é¹… logo</h5><p><strong>Linux å†…æ ¸å¯åŠ¨æ—¶æ˜¾ç¤ºä¼é¹… logoï¼Œæ˜¾ç¤ºè¡¨ç¤º LCD é©±åŠ¨åŸºæœ¬æ­£å¸¸</strong>ï¼Œè¿™ä¸ª logo éœ€è¦åœ¨ Linux å†…æ ¸é…ç½®å¯åŠ¨ï¼Œä¸€èˆ¬å†…æ ¸æ˜¯é»˜è®¤å¯åŠ¨çš„ã€‚</p><p>Linux å†…æ ¸ä¿®æ”¹ï¼š<strong>ä½¿èƒ½ Linux logo æ˜¾ç¤º</strong>ï¼ŒæŒ‰å¦‚ä¸‹è·¯å¾„æ‰¾åˆ°é…ç½®é¡¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Device Drivers</span></span><br><span class="line">    -&gt; Graphics support</span><br><span class="line">    -&gt; Bootup logo (LOGO [=y])</span><br><span class="line">    -&gt; Standard black and white Linux logo</span><br><span class="line">    -&gt; Standard 16-color Linux logo</span><br><span class="line">    -&gt; Standard 224-color Linux logo</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹ï¼š</p><p><img src="image-20240707143216743.png" alt="image-20240707143216743"></p><p>é»˜è®¤æ˜¯é€‰æ‹©çš„ï¼Œä¸‰ä¸ªé€‰é¡¹åˆ†åˆ«å¯¹åº”ç€é»‘ç™½ã€16 ä½ã€24 ä½è‰²å½©æ ¼å¼çš„ logoã€‚</p><h5 id="ç¼–è¯‘è®¾å¤‡æ ‘">ç¼–è¯‘è®¾å¤‡æ ‘</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make dtbs</span><br></pre></td></tr></table></figure><p>è®¾å¤‡ä¿®æ”¹å®Œæˆåï¼Œè¿›è¡Œç¼–è¯‘çƒ§å½•åˆ°å¼€å‘æ¿ã€‚</p><h5 id="lcd-èƒŒå…‰è°ƒèŠ‚">LCD èƒŒå…‰è°ƒèŠ‚</h5><p>è®¾å¤‡æ ‘èŠ‚ç‚¹è®¾ç½®äº† 8 ä¸ªç­‰çº§çš„èƒŒå…‰è°ƒèŠ‚ï¼Œå¯ä»¥è®¾ç½®ä¸º 0~7ï¼Œ<code>/sys/class/backlight/backlight</code> ç›®å½•ä¸‹å­˜æ”¾èƒŒå…‰è°ƒèŠ‚çš„ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /sys/class/backlight/backlight</span><br><span class="line">cat /sys/class/backlight/backlight</span><br></pre></td></tr></table></figure><p>brightness è¡¨ç¤ºå½“å‰äº®åº¦ç­‰çº§ï¼Œmax_brightness è¡¨ç¤ºæœ€å¤§äº®åº¦ç­‰çº§ï¼Œä½¿ç”¨ echo å‘½ä»¤å¯ä»¥ä¿®æ”¹å±å¹•äº®åº¦ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 7 &gt; brightness</span><br></pre></td></tr></table></figure><p>brigtness ä¸º 0 çš„è¯ä¼šå…³é—­ LCD èƒŒå…‰ï¼Œå³å±å¹•ä¼šç†„ç­ã€‚</p><h4 id="è®¾å¤‡-lcd-ä½œä¸ºç»ˆç«¯æ§åˆ¶å°">è®¾å¤‡ LCD ä½œä¸ºç»ˆç«¯æ§åˆ¶å°</h4><h5 id="è®¾ç½®-uboot-å¯åŠ¨å‚æ•°">è®¾ç½® uboot å¯åŠ¨å‚æ•°</h5><p>é‡å¯å¼€å‘æ¿è¿›å» uboot ç•Œé¢</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs &#x27;console=tty1 console=ttymxc0,115200 root=/dev/nfs nfsroot=192.168.1.5:/home/router2/100ask_imx6ull-sdk/nfs_ubuntu/busybox1.29.0_rootfs,proto=tcp rw ip=192.168.1.7:192.168.1.5:192.168.1.1:255.255.255.0::eth0:off&#x27;</span><br></pre></td></tr></table></figure><ul><li>console=tty1ï¼šè¡¨ç¤ºè®¾ç½® LCD å±å¹•ä¸ºæ§åˆ¶å°</li><li>console=ttymxc0,115200ï¼šè¡¨ç¤ºè®¾ç½®ä¸²å£ä¸ºæ§åˆ¶å°</li><li>åé¢æ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç­‰ä¿¡æ¯</li></ul><h5 id="ä¿®æ”¹æ ¹æ–‡ä»¶ç³»ç»Ÿ">ä¿®æ”¹æ ¹æ–‡ä»¶ç³»ç»Ÿ</h5><p>æ‰“å¼€æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ <code>/etc/inittab</code> æ–‡ä»¶ï¼Œæ·»åŠ è¿™ä¸€è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tty1::askfirst:-/bin/sh</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œæˆåä¿å­˜æ–‡ä»¶ï¼Œé‡å¯å¼€å‘æ¿ï¼Œå°±å¯ä»¥å‘ç° LCD å±å¹•ä¸Šå‘ˆç°ç³»ç»Ÿå¯åŠ¨ä¿¡æ¯äº†ã€‚</p><p>Linux å†…æ ¸é»˜è®¤ä½¿èƒ½äº† USB é”®ç›˜é©±åŠ¨ï¼Œç›´æ¥æ’ä¸Šé”®ç›˜å°±å¯ä»¥å®ç°åœ¨ MobaXterm è½¯ä»¶é€šè¿‡ä¸²å£æ“ä½œå¼€å‘æ¿ä¸€æ ·çš„æ•ˆæœäº†ï¼Œä½†æ˜¯ LCD æ§åˆ¶å°è¿˜ä¸æ”¯æŒä¸­æ–‡æ“ä½œï¼Œåç»­å†è¿›è¡Œä¼˜åŒ–ã€‚</p><p><img src="image-20240707153334139.png" alt="image-20240707153334139"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linux-lcdé©±åŠ¨&quot;&gt;Linux-LCDé©±åŠ¨&lt;/h1&gt;
&lt;h2 id=&quot;ç¯å¢ƒ&quot;&gt;ç¯å¢ƒ&lt;/h2&gt;
&lt;h3 id=&quot;ç¡¬ä»¶ç¯å¢ƒ&quot;&gt;ç¡¬ä»¶ç¯å¢ƒ&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å¼€å‘æ¿å‹å·&lt;/strong&gt;ï¼š &lt;a href=&quot;https://blog.csd</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux åµŒå…¥å¼" scheme="http://www.obito.top/tags/Linux-%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Linux-SPI-ICM20608</title>
    <link href="http://www.obito.top/2024/06/28/Linux-SPI-ICM20608/"/>
    <id>http://www.obito.top/2024/06/28/Linux-SPI-ICM20608/</id>
    <published>2024-06-28T10:28:32.000Z</published>
    <updated>2024-08-23T03:16:38.318Z</updated>
    
    <content type="html"><![CDATA[<h2 id="linux-spi-icm20608">Linux-SPI-ICM20608</h2><h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2><h3 id="ç¡¬ä»¶ç¯å¢ƒ">ç¡¬ä»¶ç¯å¢ƒ</h3><ul><li><strong>å¼€å‘æ¿å‹å·</strong>ï¼š <a href="https://blog.csdn.net/thisway_diy/article/details/109841372">100ask_imx6ull_pro å¼€å‘æ¿</a></li><li><strong>å¤„ç†å™¨ç±»å‹</strong>ï¼šNXP IMX6ULL</li><li><strong>å¤„ç†å™¨æ¶æ„</strong>ï¼šæ©å•æ ¸ Cortex-A7</li><li><strong>å¤„ç†å™¨ä¸»é¢‘</strong>ï¼š800MHZ</li><li><strong>å†…å­˜å®¹é‡</strong>ï¼š512 MB DDR3</li><li><strong>å­˜å‚¨ä»‹è´¨</strong>ï¼š4GB eMMC</li><li><strong>æœ¬æ¬¡æµ‹è¯•çš„é©±åŠ¨</strong>ï¼šICM20608 å…­è½´ä¼ æ„Ÿå™¨</li></ul><h3 id="è½¯ä»¶ç¯å¢ƒ">è½¯ä»¶ç¯å¢ƒ</h3><ul><li>å®¿ä¸»æœº<ul><li><strong>å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ</strong>ï¼šUbuntu 18.04</li><li><strong>äº¤å‰ç¼–è¯‘å™¨</strong>ï¼š100ask æä¾›çš„å·¥å…·é“¾ arm-buildroot-linux-gnueabihf- <strong>æ”¯æŒçš„æœ€ä½å†…æ ¸ç‰ˆæœ¬</strong>ï¼š4.9.0</li></ul></li><li>å¼€å‘æ¿<ul><li><strong>U-Boot</strong>ï¼šä¸€å¼€å§‹ç”¨çš„ NXP å®˜æ–¹æä¾›çš„ç‰ˆæœ¬ä½†ä¸èƒ½æ­£å¸¸å¯åŠ¨å†…æ ¸ï¼Œåæ”¹ä¸º 100ask æä¾›çš„ç‰ˆæœ¬</li><li><strong>å†…æ ¸ç‰ˆæœ¬</strong>ï¼š <a href="https://github.com/nxp-imx/linux-imx/tree/imx_4.9.88_2.0.0_ga">NXP æä¾›çš„ 4.9.88 ç‰ˆæœ¬</a></li><li><strong>æ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹</strong>ï¼š<a href="https://busybox.net/downloads/">BusyBox 1.29.0</a></li></ul></li></ul><h2 id="icm20608">ICM20608</h2><p>ICM20608 æ˜¯ç”± InvenSense å…¬å¸ç”Ÿäº§çš„ä¸€æ¬¾ 6 è½´æƒ¯æ€§æµ‹é‡å•å…ƒï¼ˆIMUï¼‰ï¼Œå®ƒé›†æˆäº† 3 è½´é™€èºä»ªå’Œ 3 è½´åŠ é€Ÿåº¦è®¡ã€‚è¿™æ¬¾ä¼ æ„Ÿå™¨å¹¿æ³›åº”ç”¨äºéœ€è¦ç²¾ç¡®è¿åŠ¨è·Ÿè¸ªçš„åœºåˆï¼Œæ¯”å¦‚æ— äººæœºã€æœºå™¨äººã€æ™ºèƒ½æ‰‹æœºå’Œå¯ç©¿æˆ´è®¾å¤‡ç­‰ã€‚</p><ul><li>é™€èºä»ªæ”¯æŒ Xï¼ŒY å’Œ Z ä¸‰è½´è¾“å‡ºï¼Œå†…éƒ¨é›†æˆ <strong>16 ä½ ADC</strong>ï¼Œæµ‹é‡èŒƒå›´å¯è®¾ç½®ï¼šÂ±250ï¼ŒÂ±500ï¼ŒÂ±1000 å’Œ Â±2000Â°/s</li><li>åŠ é€Ÿåº¦è®¡æ”¯æŒ Xï¼ŒY å’Œ Z è½´è¾“å‡ºï¼Œå†…éƒ¨é›†æˆ <strong>16 ä½ ADC</strong>ï¼Œæµ‹é‡èŒƒå›´å¯è®¾ç½®ï¼šÂ±2gï¼ŒÂ±4gï¼ŒÂ±8g å’Œ Â±16gï¼Œg è¡¨ç¤ºé‡åŠ›åŠ é€Ÿåº¦ 1g=9.8m/sÂ²ã€‚</li><li>å†…éƒ¨åŒ…å«ä¸€ä¸ª 512 å­—èŠ‚çš„ FIFO</li><li>æ”¯æŒå¿«é€Ÿ I2Cï¼Œé€Ÿåº¦å¯è¾¾ 400 KHz</li><li><strong>æ”¯æŒ SPIï¼Œé€Ÿåº¦å¯è¾¾ 8 MHz</strong></li><li>å¯„å­˜å™¨ 8 ä½ï¼Œå¯„å­˜å™¨ä½å®½ 8ä½</li></ul><p><img src="image-20240701203832248.png" alt="image-20240701203832248"></p><p>å¦‚æœä½¿ç”¨ I2C æ¥å£ï¼Œåˆ™ AD0 å¼•è„šå†³å®š I2C è®¾å¤‡åœ°å€çš„æœ€åä»¥ä¸ºï¼ŒAD0 = 0 åˆ™è®¾å¤‡åœ°å€ä¸º 0x68ï¼ŒAD0 = 1 åˆ™è®¾å¤‡åœ°å€ä¸º 0x69ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨çš„æ˜¯ SPI æ¥å£ï¼Œå°±ä¸ç”¨çº ç»“è¿™ä¸ªäº†ã€‚</p><p>ä½¿ç”¨ SPI æ¥å£è¯»å†™å¯„å­˜å™¨éœ€è¦ 16 ä¸ªæ—¶é’Ÿæˆ–è€…æ›´å¤š(å¦‚æœè¯»å†™æ“ä½œåŒ…æ‹¬å¤šä¸ªå­—èŠ‚çš„è¯)ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚åŒ…å«è¦è¯»å†™çš„å¯„å­˜å™¨åœ°å€ï¼Œ<strong>å¯„å­˜å™¨åœ°å€æœ€é«˜ä½æ˜¯è¯»å†™æ ‡å¿—ä½</strong>ï¼Œå¦‚æœæ˜¯è¯»çš„è¯å¯„å­˜å™¨åœ°å€æœ€é«˜ä½è¦ä¸º 1ï¼Œå¦‚æœæ˜¯å†™çš„è¯å¯„å­˜å™¨åœ°å€æœ€é«˜ä½è¦ä¸º 0ï¼Œå‰©ä¸‹çš„ 7 ä½æ‰æ˜¯å®é™…çš„å¯„å­˜å™¨åœ°å€ï¼Œå¯„å­˜å™¨åœ°å€åé¢è·Ÿç€çš„å°±æ˜¯è¯»å†™çš„æ•°æ®ã€‚</p><p>æœ¬æ¬¡ä½¿ç”¨åˆ°çš„ ICM20608 çš„ä¸€äº›é‡è¦å¯„å­˜å™¨å¦‚ä¸‹ï¼š</p><p><img src="image-20240701205419079.png" alt="image-20240701205419079"></p><p><img src="image-20240701205429856.png" alt="image-20240701205429856"></p><p>åŸç†å›¾å¦‚ä¸‹ï¼š</p><p><img src="image-20240701205602840.png" alt="image-20240701205602840"></p><h2 id="é©±åŠ¨ä»£ç ç¼–å†™">é©±åŠ¨ä»£ç ç¼–å†™</h2><h3 id="è®¾å¤‡æè¿°ä¿¡æ¯">è®¾å¤‡æè¿°ä¿¡æ¯</h3><h4 id="æ·»åŠ -icm20608-æ‰€ä½¿ç”¨åˆ°çš„-io">æ·»åŠ  ICM20608 æ‰€ä½¿ç”¨åˆ°çš„ IO</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&amp;iomuxc &#123;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_hog_1&gt;;</span><br><span class="line">    imx6ul-evk &#123;</span><br><span class="line">pinctrl_ecspi3: ecspi3 &#123;              </span><br><span class="line">                    fsl,pins = &lt;</span><br><span class="line">                MX6UL_PAD_UART2_CTS_B__ECSPI3_MOSI         <span class="number">0x000010B0</span></span><br><span class="line">                MX6UL_PAD_UART2_RTS_B__ECSPI3_MISO         <span class="number">0x000010B0</span></span><br><span class="line">                MX6UL_PAD_UART2_RX_DATA__ECSPI3_SCLK       <span class="number">0x000010B0</span></span><br><span class="line">                MX6UL_PAD_UART2_TX_DATA__GPIO1_IO20        <span class="number">0x000010B0</span></span><br><span class="line">            &gt;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ -ecspi3-èŠ‚ç‚¹è¿½åŠ -icm20608å­èŠ‚ç‚¹">æ·»åŠ  ecspi3 èŠ‚ç‚¹è¿½åŠ  ICM20608å­èŠ‚ç‚¹</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&amp;ecspi3 &#123; </span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_ecspi3&gt;;</span><br><span class="line">    cs-gpios = &lt;&amp;gpio1 <span class="number">20</span> GPIO_ACTIVE_LOW&gt;;     <span class="comment">// cs-gpiosè½¯ä»¶æ“ä½œç‰‡é€‰IO</span></span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cs-gpios æ˜¯æ ¹æ®é©±åŠ¨æ–‡ä»¶ä¸­çš„å‘½åè®¾ç½®çš„</span></span><br><span class="line">    spidev: icm20608@<span class="number">0</span>&#123;         <span class="comment">// 0è¡¨ç¤ºä½¿ç”¨ecspi3çš„0é€šé“ï¼Œè·Ÿregå¯¹åº”</span></span><br><span class="line">        compatible = <span class="string">&quot;invensense,icm20608&quot;</span>;</span><br><span class="line">        interrupt-parent = &lt;&amp;gpio1&gt;;</span><br><span class="line">        interrupts = &lt;<span class="number">1</span> <span class="number">1</span>&gt;;</span><br><span class="line">        spi-max-frequency = &lt;<span class="number">8000000</span>&gt;; <span class="comment">// å¯æ”¯æŒçš„æœ€é«˜é¢‘ç‡</span></span><br><span class="line">        reg = &lt;<span class="number">0</span>&gt;; </span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h4><p>åœ¨ä¿®æ”¹è®¾å¤‡æ ‘æ—¶ï¼Œè®°å¾—æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦å…¶ä»–è®¾å¤‡ä¹Ÿç”¨åˆ°äº†ç›¸åŒå¼•è„šã€‚é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯é©±åŠ¨ç¨‹åºå’Œè®¾å¤‡æ ‘çš„ compatible éƒ½ç›¸åŒï¼Œä½†æ˜¯å§‹ç»ˆå‘ç°åŒ¹é…ä¸æˆåŠŸï¼Œæ²¡æœ‰è¿›å…¥åˆ° probe å‡½æ•°ï¼Œé©±åŠ¨ç¨‹åºåŒ¹é…ä¸»è¦å°±çœ‹ compatible è¿™äº›åŒ¹é…çš„ä¿¡æ¯ï¼Œéƒ½æ— è¯¯ï¼Œäºæ˜¯æŸ¥çœ‹è®¾å¤‡æ ‘ï¼Œå‘ç°åŸæ¥æ˜¯å¼•è„šå†²çªäº†ï¼Œecspi3 å­èŠ‚ç‚¹å’Œ uart2ã€can2 å†²çªï¼Œå¿˜è®°åˆ å‡äº†ã€‚</p><p><img src="image-20240716132936690.png" alt="image-20240716132936690"></p><h3 id="driver-é©±åŠ¨ä»£ç ">driver é©±åŠ¨ä»£ç </h3><h4 id="å¯„å­˜å™¨å®šä¹‰å’Œ-icm20608-dev-ç»“æ„ä½“">å¯„å­˜å™¨å®šä¹‰å’Œ icm20608_dev ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spi/spi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span> <span class="comment">/*æ³¨å†Œè®¾å¤‡èŠ‚ç‚¹çš„æ–‡ä»¶ç»“æ„ä½“*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span> <span class="comment">// å¯¹å­—ç¬¦è®¾å¤‡ç»“æ„cdev ä»¥åŠä¸€ç³»åˆ—çš„æ“ä½œå‡½æ•°çš„å®šä¹‰ã€‚åŒ…å«äº†cdev ç»“æ„åŠç›¸å…³å‡½æ•°çš„å®šä¹‰ã€‚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span> <span class="comment">//åŒ…å«äº†deviceã€class ç­‰ç»“æ„çš„å®šä¹‰</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span> <span class="comment">//åŒ…å«äº†copy_to_userã€copy_from_user ç­‰å†…æ ¸è®¿é—®ç”¨æˆ·è¿›ç¨‹å†…å­˜åœ°å€çš„å‡½æ•°å®šä¹‰ã€‚</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ICM20608å¯„å­˜å™¨å®šä¹‰ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_PWR_MGMT_1 0x6B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_PWR_MGMT_2 0x6C</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_SMPLRT_DIV 0x19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_CONFIG 0x1A</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_GYRO_CONFIG 0x1B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_ACCEL_CONFIG 0x1C</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_ACCEL_CONFIG2 0x1D</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_LP_MODE_CFG 0x1E</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_FIFO_EN 0x23</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_WHO_AM_I 0x75</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACCEL_XOUT_H 0x3B</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_NAME <span class="string">&quot;icm20608&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icm20608_data</span> &#123;</span></span><br><span class="line"><span class="type">int16_t</span> accel_x;</span><br><span class="line"><span class="type">int16_t</span> accel_y;</span><br><span class="line"><span class="type">int16_t</span> accel_z;</span><br><span class="line"><span class="type">int16_t</span> gyro_x;</span><br><span class="line"><span class="type">int16_t</span> gyro_y;</span><br><span class="line"><span class="type">int16_t</span> gyro_z;</span><br><span class="line"><span class="type">int16_t</span> temperature;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> &#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid;<span class="comment">/* è®¾å¤‡å· */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span><span class="comment">/* cdev  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span><span class="comment">/* ç±» */</span> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span><span class="comment">/* è®¾å¤‡ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span><span class="comment">/* è®¾å¤‡èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="type">int</span> major;<span class="comment">/* ä¸»è®¾å¤‡å· */</span></span><br><span class="line"><span class="type">void</span> *private_data;<span class="comment">/* ç§æœ‰æ•°æ® */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icm20608_data</span> <span class="title">data</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> <span class="title">icm20608_dev_t</span>;</span></span><br></pre></td></tr></table></figure><h4 id="æ³¨å†Œ-æ³¨é”€-spi-driver-ç»“æ„ä½“">æ³¨å†Œ/æ³¨é”€ spi_driver ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è®¾å¤‡æ ‘compatibleåŒ¹é…è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table</span>[] =</span> &#123;</span><br><span class="line">&#123;.compatible = <span class="string">&quot;invensense,icm20608&quot;</span>&#125;, </span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ— è®¾å¤‡æ ‘çš„åŒ¹é…IDè¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device_id</span> <span class="title">id_table</span>[] =</span> &#123;</span><br><span class="line">&#123;<span class="string">&quot;invensense,icm20608&quot;</span>&#125;,</span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰i2cæ€»çº¿è®¾å¤‡ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span> <span class="title">icm20608_spi_driver</span> =</span> &#123;</span><br><span class="line">.driver = &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.name  = <span class="string">&quot;icm20608&quot;</span>,</span><br><span class="line">.of_match_table = of_match_table,</span><br><span class="line">&#125;,</span><br><span class="line">.probe= icm20608_spi_driver_probe,</span><br><span class="line">.remove = icm20608_spi_driver_remove,</span><br><span class="line">.id_table= id_table,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">icm20608_spi_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="comment">// æ³¨å†Œ spi é©±åŠ¨</span></span><br><span class="line">ret = spi_register_driver(&amp;icm20608_spi_driver);</span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;icm20608_spi_driver_init ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å‡ºå£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">icm20608_spi_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å°†å‰é¢æ³¨å†Œçš„spi_driverä¹Ÿä»Linuxå†…æ ¸ä¸­æ³¨é”€æ‰</span></span><br><span class="line">spi_unregister_driver(&amp;icm20608_spi_driver);</span><br><span class="line">printk(<span class="string">&quot;icm20608_spi_driver_exit ok\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(icm20608_spi_driver_init);</span><br><span class="line">module_exit(icm20608_spi_driver_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ å­—ç¬¦è®¾å¤‡">æ·»åŠ å­—ç¬¦è®¾å¤‡</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">icm20608_fops</span> =</span> &#123;</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">.open   = icm20608_open,</span><br><span class="line">.release  = icm20608_close,</span><br><span class="line">.read= icm20608_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_spi_driver_probe</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 1.åˆ†é…è®¾å¤‡å·</span></span><br><span class="line"><span class="keyword">if</span>(<span class="type">icm20608_dev_t</span>.major)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">icm20608_dev_t</span>.devid = MKDEV(<span class="type">icm20608_dev_t</span>.major, <span class="number">0</span>);</span><br><span class="line">register_chrdev_region(<span class="type">icm20608_dev_t</span>.devid, <span class="number">1</span>, ICM20608_NAME);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">alloc_chrdev_region(&amp;<span class="type">icm20608_dev_t</span>.devid, <span class="number">0</span>, <span class="number">1</span>, ICM20608_NAME);</span><br><span class="line"><span class="type">icm20608_dev_t</span>.major = MAJOR(<span class="type">icm20608_dev_t</span>.devid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.åˆå§‹åŒ–cdev</span></span><br><span class="line">cdev_init(&amp;<span class="type">icm20608_dev_t</span>.cdev, &amp;icm20608_fops);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.æ·»åŠ è®¾å¤‡å·åˆ°cdev</span></span><br><span class="line">cdev_add(&amp;<span class="type">icm20608_dev_t</span>.cdev, <span class="type">icm20608_dev_t</span>.devid, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.åˆ›å»ºç±»</span></span><br><span class="line"><span class="type">icm20608_dev_t</span>.class = class_create(THIS_MODULE, ICM20608_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="type">icm20608_dev_t</span>.device))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="type">icm20608_dev_t</span>.device);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.ç±»ä¸‹åˆ›å»ºè®¾å¤‡</span></span><br><span class="line"><span class="type">icm20608_dev_t</span>.device = device_create(<span class="type">icm20608_dev_t</span>.class, <span class="literal">NULL</span>, <span class="type">icm20608_dev_t</span>.devid, <span class="literal">NULL</span>, ICM20608_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="type">icm20608_dev_t</span>.device))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="type">icm20608_dev_t</span>.device);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡æ ‘è®¾ç½®è½¯ä»¶ç‰‡é€‰ï¼Œspiä¸»æ§åˆ¶å™¨ä¸ºè‡ªåŠ¨å¸®æˆ‘ä»¬æ“ä½œç‰‡é€‰IOï¼Œæ‰€ä»¥å°±ä¸éœ€è¦æ‰‹åŠ¨æ§åˆ¶äº†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–spi_deviceç»“æ„ä½“ </span></span><br><span class="line">spi-&gt;mode = SPI_MODE_0;  <span class="comment">/* MODE0ï¼ŒCPOL=0ï¼ŒCPHA=0 */</span></span><br><span class="line">spi_setup(spi);</span><br><span class="line"><span class="type">icm20608_dev_t</span>.private_data = spi;<span class="comment">/* è®¾ç½®ç§æœ‰æ•°æ® */</span></span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;icm20608_spi_driver_probe ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_spi_driver_remove</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 1.æ³¨é”€è®¾å¤‡å·</span></span><br><span class="line">unregister_chrdev_region(<span class="type">icm20608_dev_t</span>.devid, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 2.åˆ é™¤è®¾å¤‡</span></span><br><span class="line">cdev_del(&amp;<span class="type">icm20608_dev_t</span>.cdev);</span><br><span class="line"><span class="comment">// 3.æ³¨é”€è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line">device_destroy(<span class="type">icm20608_dev_t</span>.class, <span class="type">icm20608_dev_t</span>.devid);</span><br><span class="line"><span class="comment">// 4.åˆ é™¤ç±»</span></span><br><span class="line">class_destroy(<span class="type">icm20608_dev_t</span>.class);</span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;icm20608_spi_driver_remove ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ”¶å‘æ•°æ®å‡½æ•°">æ”¶å‘æ•°æ®å‡½æ•°</h4><p>å‰é¢æˆ‘ä»¬åœ¨è®¾å¤‡æ ‘ä¸­å°†ç‰‡é€‰ IO è®¾ç½®ä¸ºäº†è½¯ä¸­æ–­ï¼Œä¸” <strong>Linux å†…æ ¸ä¸­çš„ SPI ä¸»æ§åˆ¶å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ“ä½œç‰‡é€‰ IO</strong>ï¼Œå› æ­¤åœ¨æ”¶å‘æ•°æ®å‡½æ•°ä¸­æˆ‘ä»¬ä¸èƒ½æ‰‹åŠ¨æ§åˆ¶ç‰‡é€‰ IO äº†ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ <strong>SPI æ¥æ”¶çš„æ—¶å€™ä¼šå…ˆæ¥æ”¶åˆ°ä¸€ä¸ªå­—èŠ‚çš„å¯„å­˜å™¨åœ°å€</strong>ï¼Œè¯»å–æ•°æ®æ—¶æˆ‘ä»¬éœ€è¦è·³è¿‡è¯¥å­—èŠ‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : è¯»å– icm20608 è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : icm20608 è®¾å¤‡</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¯»å–åˆ°çš„æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦è¯»å–çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_read_reg</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, <span class="type">uint8_t</span> reg, <span class="type">void</span> *val, <span class="type">uint8_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">uint8_t</span> tx_data[<span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> *rx_data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> *<span class="title">t</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span> =</span> (<span class="keyword">struct</span> spi_device *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ†é…å†…å­˜ */</span></span><br><span class="line">t = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> spi_transfer), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span>(!t)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kzalloc error\n&quot;</span>);</span><br><span class="line">kfree(t);</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rx_data = kzalloc(<span class="keyword">sizeof</span>(<span class="type">uint8_t</span>) + len, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span>(!rx_data)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kzalloc error\n&quot;</span>);</span><br><span class="line">kfree(rx_data);</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å‘é€è¦è¯»å–çš„å¯„å­˜åœ°å€å’Œæ¥æ”¶è¯»å–çš„æ•°æ® */</span></span><br><span class="line">tx_data[<span class="number">0</span>] = reg | (<span class="number">0x80</span>); <span class="comment">/* è¯»æ•°æ®çš„æ—¶å€™é¦–å¯„å­˜å™¨åœ°å€bit8 è¦ç½®1 */</span></span><br><span class="line"></span><br><span class="line">t-&gt;tx_buf = tx_data;<span class="comment">/* è¦å‘é€çš„æ•°æ®ï¼šå¯„å­˜å™¨åœ°å€ */</span></span><br><span class="line">t-&gt;rx_buf = rx_data;<span class="comment">/* è¦æ¥æ”¶çš„æ•°æ® */</span></span><br><span class="line">t-&gt;len = len + <span class="number">1</span>;<span class="comment">/* t-&gt;len=å‘é€çš„é•¿åº¦+è¯»å–çš„é•¿åº¦ */</span></span><br><span class="line"></span><br><span class="line">spi_message_init(&amp;msg); <span class="comment">/* åˆå§‹åŒ–spi_message */</span></span><br><span class="line">spi_message_add_tail(t, &amp;msg);<span class="comment">/* å°†spi_transfer æ·»åŠ åˆ°spi_message é˜Ÿåˆ— */</span></span><br><span class="line">ret = spi_sync(spi, &amp;msg); <span class="comment">/* åŒæ­¥ä¼ è¾“ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SPIæ¥æ”¶æ•°æ®æ—¶ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å¯„å­˜å™¨çš„åœ°å€ï¼Œè·³è¿‡ä¸€ä¸ªå­—èŠ‚å³å¯ã€‚</span></span><br><span class="line"><span class="built_in">memcpy</span>(val, rx_data + <span class="number">1</span>, len);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é‡Šæ”¾å†…å­˜ */</span></span><br><span class="line">kfree(t);</span><br><span class="line">kfree(rx_data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : å‘ icm20608 è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : è¦å†™å…¥çš„è®¾å¤‡ç»“æ„ä½“</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦å†™å…¥çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¦å†™å…¥çš„æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦å†™å…¥çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_write_reg</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, <span class="type">uint8_t</span> reg, <span class="type">uint8_t</span> *buf, <span class="type">uint8_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"><span class="type">uint8_t</span> *tx_data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> *<span class="title">t</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span> =</span> (<span class="keyword">struct</span> spi_device *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ†é…å†…å­˜ */</span></span><br><span class="line">t = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> spi_transfer), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span>(!t)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kzalloc error\n&quot;</span>);</span><br><span class="line">kfree(t);</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tx_data = kzalloc(<span class="keyword">sizeof</span>(<span class="type">uint8_t</span>) + len, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span>(!t)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kzalloc error\n&quot;</span>);</span><br><span class="line">kfree(tx_data);</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å‘é€è¦è¯»å–çš„å¯„å­˜åœ°å€å’Œå†™å…¥çš„æ•°æ® */</span></span><br><span class="line">*tx_data = reg &amp; ~(<span class="number">0x80</span>); <span class="comment">/* å†™æ•°æ®çš„æ—¶å€™å¯„å­˜å™¨åœ°å€bit8è¦æ¸…é›¶ */</span></span><br><span class="line"><span class="built_in">memcpy</span>(tx_data + <span class="number">1</span>, buf, len);<span class="comment">/* æŠŠlen ä¸ªå¯„å­˜å™¨æ‹·è´åˆ°txdata é‡Œ */</span></span><br><span class="line"></span><br><span class="line">t-&gt;tx_buf = tx_data;<span class="comment">/* è¦å‘é€çš„æ•°æ® */</span></span><br><span class="line">t-&gt;len = len + <span class="number">1</span>;<span class="comment">/* t-&gt;len=å‘é€çš„é•¿åº¦+è¯»å–çš„é•¿åº¦ */</span></span><br><span class="line"></span><br><span class="line">spi_message_init(&amp;msg); <span class="comment">/* åˆå§‹åŒ–spi_message */</span></span><br><span class="line">spi_message_add_tail(t, &amp;msg);<span class="comment">/* å°†spi_transfer æ·»åŠ åˆ°spi_message é˜Ÿåˆ— */</span></span><br><span class="line">ret = spi_sync(spi, &amp;msg); <span class="comment">/* åŒæ­¥ä¼ è¾“ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* é‡Šæ”¾å†…å­˜ */</span></span><br><span class="line">kfree(t);</span><br><span class="line">kfree(tx_data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="open-å‡½æ•°">open å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">icm20608_deinit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> value;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”µæºç®¡ç†å¯„å­˜å™¨1 å¤ä½icm20608</span></span><br><span class="line">value = <span class="number">0x80</span>;</span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_PWR_MGMT_1, &amp;value, <span class="number">1</span>);</span><br><span class="line">mdelay(<span class="number">50</span>);</span><br><span class="line">    <span class="comment">// è‡ªåŠ¨é€‰æ‹©æœ€å¥½çš„æ—¶é’Ÿæºï¼Œå¦åˆ™é€‰æ‹©å†…éƒ¨20MHzæ™¶æŒ¯</span></span><br><span class="line">value = <span class="number">0x01</span>;</span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_PWR_MGMT_1, &amp;value, <span class="number">1</span>);</span><br><span class="line">mdelay(<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ID å¯„å­˜å™¨ï¼ŒICM-20608 çš„IDä¸º0XAF</span></span><br><span class="line">icm20608_read_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_WHO_AM_I, &amp;value, <span class="number">1</span>);</span><br><span class="line">printk(<span class="string">&quot;ICM20608 ID = %x\n&quot;</span>, value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è¾“å‡ºé€Ÿç‡åˆ†é¢‘æ•°ï¼š0å³é€Ÿç‡ä¸ºINTERNAL_SAMPLE_RATE 8kHz</span></span><br><span class="line">value = <span class="number">0x00</span>;</span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_SMPLRT_DIV, &amp;value, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®ä½é€šæ»¤æ³¢å™¨</span></span><br><span class="line">value = <span class="number">0x04</span>;</span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_CONFIG, &amp;value, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®é™€èºä»ªé‡ç¨‹ Â±2000dps</span></span><br><span class="line">value = <span class="number">0x18</span>; </span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_GYRO_CONFIG, &amp;value, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®åŠ é€Ÿåº¦è®¡çš„é‡ç¨‹ Â±16g</span></span><br><span class="line">value = <span class="number">0x18</span>;</span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_ACCEL_CONFIG, &amp;value, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®åŠ é€Ÿåº¦è®¡ä½é€šæ»¤æ³¢</span></span><br><span class="line">value = <span class="number">0x04</span>;</span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_ACCEL_CONFIG2, &amp;value, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®é™€èºä»ªä½åŠŸè€—ä¸ä½¿èƒ½</span></span><br><span class="line">value = <span class="number">0x00</span>;</span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_LP_MODE_CFG, &amp;value, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®FIFOä¸ä½¿èƒ½</span></span><br><span class="line">value = <span class="number">0x00</span>;</span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_FIFO_EN, &amp;value, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// ç”µæºç®¡ç†å¯„å­˜å™¨2 å…¨éƒ¨ä½¿èƒ½</span></span><br><span class="line">value = <span class="number">0x00</span>;</span><br><span class="line">icm20608_write_reg(&amp;<span class="type">icm20608_dev_t</span>, ICM20608_PWR_MGMT_2, &amp;value, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_open</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">file-&gt;private_data = &amp;<span class="type">icm20608_dev_t</span>;</span><br><span class="line"></span><br><span class="line">icm20608_deinit();</span><br><span class="line">printk(<span class="string">&quot;icm20608_deinit ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="read-å‡½æ•°">read å‡½æ•°</h4><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„å°±æ˜¯æ¥æ”¶åˆ°çš„æ•°æ®æ˜¯ 8 ä½çš„ï¼Œåœ¨åˆå¹¶æ•°æ®æ—¶ï¼Œæ•°æ®ç§»ä½éœ€è¦æå‰è½¬æ¢æˆ uint16_t ç±»å‹ï¼Œå¦åˆ™ä¼šä¸¢å¤±æ•°æ®ï¼Œæœ€åå°†åˆå¹¶æˆçš„æ•°æ®å­˜å…¥ kbufï¼Œä½¿ç”¨ copy_to_user å°†æ•°æ®ä¼ é€ç»™åº”ç”¨ç¨‹åºã€‚</p><p>è¿™é‡Œæ¥æ”¶çš„æ•°æ®æ˜¯ ADC æ¨¡æ‹Ÿå€¼ä¸æ˜¯å®é™…å€¼ï¼Œéœ€è¦æ ¹æ®å¯„å­˜å™¨è®¾ç½®çš„åˆ†è¾¨ç‡è¿›è¡Œè½¬æ¢ï¼Œå› ä¸º<strong>æ¶‰åŠåˆ°æµ®ç‚¹è¿ç®—ï¼Œå°±æ²¡æœ‰åœ¨é©±åŠ¨æ–‡ä»¶é‡Œé¢å†™ï¼Œåé¢å†åº”ç”¨ç¨‹åºè¿›è¡Œè¿ç®—å³å¯ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_read_data</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">uint8_t</span> data[<span class="number">14</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">ret = icm20608_read_reg(dev, ACCEL_XOUT_H, data, <span class="number">14</span>);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;icm20608_read_data failed\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dev-&gt;data.accel_x = (((<span class="type">int16_t</span>)data[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">1</span>]);</span><br><span class="line">dev-&gt;data.accel_y = (((<span class="type">int16_t</span>)data[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">3</span>]);</span><br><span class="line">dev-&gt;data.accel_z = (((<span class="type">int16_t</span>)data[<span class="number">4</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line">dev-&gt;data.temperature = (((<span class="type">int16_t</span>)data[<span class="number">6</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">7</span>]);</span><br><span class="line"></span><br><span class="line">dev-&gt;data.gyro_x = (((<span class="type">int16_t</span>)data[<span class="number">8</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">9</span>]);</span><br><span class="line">dev-&gt;data.gyro_y = (((<span class="type">int16_t</span>)data[<span class="number">10</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">11</span>]);</span><br><span class="line">dev-&gt;data.gyro_z = (((<span class="type">int16_t</span>)data[<span class="number">12</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">13</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">icm20608_read</span> <span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *<span class="type">loff_t</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">int16_t</span> kbuf[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> *<span class="title">dev</span> =</span> (<span class="keyword">struct</span> icm20608_dev *)file-&gt;private_data;</span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;icm20608_read start\n&quot;</span>);</span><br><span class="line">ret = icm20608_read_data(dev);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;icm20608_read error\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kbuf[<span class="number">0</span>] = dev-&gt;data.accel_x;</span><br><span class="line">kbuf[<span class="number">1</span>] = dev-&gt;data.accel_y;</span><br><span class="line">kbuf[<span class="number">2</span>] = dev-&gt;data.accel_z;</span><br><span class="line">kbuf[<span class="number">3</span>] = dev-&gt;data.gyro_x;</span><br><span class="line">kbuf[<span class="number">4</span>] = dev-&gt;data.gyro_y;</span><br><span class="line">kbuf[<span class="number">5</span>] = dev-&gt;data.gyro_z;</span><br><span class="line">kbuf[<span class="number">6</span>] = dev-&gt;data.temperature;</span><br><span class="line"></span><br><span class="line">ret = copy_to_user(ubuf, kbuf, <span class="keyword">sizeof</span>(kbuf));</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;copy_to_user error\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">printk(<span class="string">&quot;icm20608_read ok\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åº”ç”¨ç¨‹åºæµ‹è¯•">åº”ç”¨ç¨‹åºæµ‹è¯•</h2><p>ADC æ¨¡æ‹Ÿå€¼è½¬æ¢ä¸ºå®é™…å€¼å–å†³äºé™€èºä»ªå’ŒåŠ é€Ÿåº¦è®¡çš„åˆ†è¾¨ç‡ã€‚</p><p>ç”±äºå¯„å­˜å™¨é…ç½®æ—¶ï¼Œé™€èºä»ªå’ŒåŠ é€Ÿåº¦è®¡çš„æµ‹é‡é‡ç¨‹èŒƒå›´ä¸åŒï¼Œåˆ†è¾¨ç‡å°±ä¸åŒï¼Œæ•°æ®æ‰‹å†Œé‡Œé¢ä¸åŒæµ‹é‡é‡ç¨‹å¯¹åº”ä¸åŒçš„åˆ†è¾¨ç‡å¦‚ä¸‹ï¼š</p><p><img src="image-20240701220844905.png" alt="image-20240701220844905"></p><p><img src="image-20240701220749049.png" alt="image-20240701220749049"></p><p><img src="image-20240701220901623.png" alt="image-20240701220901623"></p><p><img src="image-20240701220800594.png" alt="image-20240701220800594"></p><p>ADC æ¨¡æ‹Ÿå€¼è½¬æ¢å®é™…å€¼è½¬æ¢è¿‡ç¨‹å¦‚ä¸‹ï¼š16 ä½ ADC</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>å®é™…å€¼</mtext><mo>=</mo><mfrac><mrow><mi>A</mi><mi>D</mi><mi>C</mi><mtext>æ¨¡æ‹Ÿå€¼</mtext></mrow><msup><mn>2</mn><mn>15</mn></msup></mfrac><mtext>æµ‹é‡é‡ç¨‹çš„æœ€å¤§å€¼</mtext></mrow><annotation encoding="application/x-tex">å®é™…å€¼ = \frac{ADCæ¨¡æ‹Ÿå€¼}{2^{15}}æµ‹é‡é‡ç¨‹çš„æœ€å¤§å€¼</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">å®</span><span class="mord cjk_fallback">é™…</span><span class="mord cjk_fallback">å€¼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord cjk_fallback">æ¨¡</span><span class="mord cjk_fallback">æ‹Ÿ</span><span class="mord cjk_fallback">å€¼</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord cjk_fallback">æµ‹</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">ç¨‹</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">æœ€</span><span class="mord cjk_fallback">å¤§</span><span class="mord cjk_fallback">å€¼</span></span></span></span></span></p><p>æœ¬è´¨ä¸Šè¯»å–çš„å€¼åœ¨ ADC æ¨¡æ‹Ÿå€¼çš„æµ‹é‡èŒƒå›´çš„ä½ç½®æ˜ å°„åˆ°å…·ä½“æµ‹é‡é‡ç¨‹çš„ä½ç½®ã€‚ï¼ˆADC æ¨¡æ‹Ÿå€¼æ²¡æœ‰å«ä¹‰éœ€è¦è½¬æ¢æˆæœ‰æ„ä¹‰çš„å€¼ï¼‰</p><p>FS_SEL = 3æ—¶ï¼Œæµ‹é‡é‡ç¨‹ä¸º Â±2000dpsæ—¶ï¼Œé™€èºä»ªè½¬æ¢å¦‚ä¸‹ï¼š</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>å®é™…å€¼</mtext><mo>=</mo><mfrac><mrow><mi>A</mi><mi>D</mi><mi>C</mi><mtext>æ¨¡æ‹Ÿå€¼</mtext></mrow><msup><mn>2</mn><mn>15</mn></msup></mfrac><mn>2000</mn><mo>=</mo><mfrac><mrow><mi>A</mi><mi>D</mi><mi>C</mi><mtext>æ¨¡æ‹Ÿå€¼</mtext></mrow><mn>16.4</mn></mfrac></mrow><annotation encoding="application/x-tex">å®é™…å€¼ = \frac{ADCæ¨¡æ‹Ÿå€¼}{2^{15}}2000=\frac{ADCæ¨¡æ‹Ÿå€¼}{16.4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">å®</span><span class="mord cjk_fallback">é™…</span><span class="mord cjk_fallback">å€¼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord cjk_fallback">æ¨¡</span><span class="mord cjk_fallback">æ‹Ÿ</span><span class="mord cjk_fallback">å€¼</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">2</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">6</span><span class="mord">.</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord cjk_fallback">æ¨¡</span><span class="mord cjk_fallback">æ‹Ÿ</span><span class="mord cjk_fallback">å€¼</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>AFS_SEL = 3æ—¶ï¼Œæµ‹é‡é‡ç¨‹ä¸º Â±16g æ—¶ï¼Œé™€èºä»ªè½¬æ¢å¦‚ä¸‹ï¼š</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>å®é™…å€¼</mtext><mo>=</mo><mfrac><mrow><mi>A</mi><mi>D</mi><mi>C</mi><mtext>æ¨¡æ‹Ÿå€¼</mtext></mrow><msup><mn>2</mn><mn>15</mn></msup></mfrac><mn>16</mn><mo>=</mo><mfrac><mrow><mi>A</mi><mi>D</mi><mi>C</mi><mtext>æ¨¡æ‹Ÿå€¼</mtext></mrow><mn>2048</mn></mfrac></mrow><annotation encoding="application/x-tex">å®é™…å€¼ = \frac{ADCæ¨¡æ‹Ÿå€¼}{2^{15}}16=\frac{ADCæ¨¡æ‹Ÿå€¼}{2048}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">å®</span><span class="mord cjk_fallback">é™…</span><span class="mord cjk_fallback">å€¼</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord cjk_fallback">æ¨¡</span><span class="mord cjk_fallback">æ‹Ÿ</span><span class="mord cjk_fallback">å€¼</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">1</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord">0</span><span class="mord">4</span><span class="mord">8</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord cjk_fallback">æ¨¡</span><span class="mord cjk_fallback">æ‹Ÿ</span><span class="mord cjk_fallback">å€¼</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>æ¸©åº¦è½¬æ¢æˆå®é™…å€¼ï¼š<code>RoomTemp_Offset</code> æ˜¯åœ¨ 25Â°C æ—¶çš„ ADCå€¼åç§»é‡ï¼Œè€Œ <code>Temp_Sensitivity</code> æ˜¯æ¸©åº¦ä¼ æ„Ÿå™¨çš„çµæ•åº¦ï¼Œè¡¨ç¤ºæ¯å•ä½æ¸©åº¦å˜åŒ–å¯¹åº”çš„ ADC è®¡æ•°å˜åŒ–ã€‚</p><p><img src="image-20240702000840441.png" alt="image-20240702000840441"></p><p>å› æ­¤è®¡ç®—æ–¹å¼ä¸ºï¼š</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>m</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>u</mi><mi>r</mi><msub><mi>e</mi><mrow><mi>a</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mfrac><mrow><mi>t</mi><mi>e</mi><mi>m</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>u</mi><mi>r</mi><msub><mi>e</mi><mrow><mi>a</mi><mi>d</mi><mi>c</mi></mrow></msub><mtext>âˆ’</mtext><mn>25</mn></mrow><mn>326.8</mn></mfrac><mo>+</mo><mn>25</mn></mrow><annotation encoding="application/x-tex">temperature_{act}=\frac{temperature_{adc}âˆ’25}{326.8}+25</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span><span class="mord">2</span><span class="mord">6</span><span class="mord">.</span><span class="mord">8</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="mord mathdefault">e</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ’</span><span class="mord">2</span><span class="mord">5</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span></span></span></span></span></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> fd, ret;</span><br><span class="line"><span class="type">int16_t</span> buf[<span class="number">7</span>];</span><br><span class="line"><span class="type">int16_t</span> accel_x_adc, accel_y_adc, accel_z_adc,</span><br><span class="line">gyro_x_adc, gyro_y_adc, gyro_z_adc,</span><br><span class="line">temperature_adc;</span><br><span class="line"><span class="type">float</span> accel_x_act, accel_y_act, accel_z_act,</span><br><span class="line">  gyro_x_act, gyro_y_act, gyro_z_act,</span><br><span class="line">  temperature_act;</span><br><span class="line"></span><br><span class="line">fd = open(<span class="string">&quot;/dev/icm20608&quot;</span>, O_RDWR);</span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;open error\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">ret = read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">accel_x_adc= buf[<span class="number">0</span>];</span><br><span class="line">accel_y_adc = buf[<span class="number">1</span>];</span><br><span class="line">accel_z_adc = buf[<span class="number">2</span>];</span><br><span class="line">gyro_x_adc = buf[<span class="number">3</span>];</span><br><span class="line">gyro_y_adc = buf[<span class="number">4</span>];</span><br><span class="line">gyro_z_adc = buf[<span class="number">5</span>];</span><br><span class="line">temperature_adc = buf[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">accel_x_act = (<span class="type">float</span>)(accel_x_adc) / <span class="number">2048</span>;</span><br><span class="line">accel_y_act = (<span class="type">float</span>)(accel_y_adc) / <span class="number">2048</span>;</span><br><span class="line">accel_z_act = (<span class="type">float</span>)(accel_z_adc) / <span class="number">2048</span>;</span><br><span class="line">gyro_x_act = (<span class="type">float</span>)(gyro_x_adc) / <span class="number">16.4</span>;</span><br><span class="line">gyro_y_act = (<span class="type">float</span>)(gyro_y_adc) / <span class="number">16.4</span>;</span><br><span class="line">gyro_z_act = (<span class="type">float</span>)(gyro_z_adc) / <span class="number">16.4</span>;</span><br><span class="line">temperature_act = (<span class="type">float</span>)(temperature_adc - <span class="number">25</span>) / <span class="number">326.8</span> + <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\r\n åŸå§‹å€¼:\r\n&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;gx = %d, gy = %d, gz = %d\r\n&quot;</span>, gyro_x_adc,gyro_y_adc, gyro_z_adc);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ax = %d, ay = %d, az = %d\r\n&quot;</span>, accel_x_adc, accel_y_adc, accel_z_adc);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;temp = %d\r\n&quot;</span>, temperature_adc);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;å®é™…å€¼:&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;act gx = %.2fÂ°/S, act gy = %.2fÂ°/S,act gz = %.2fÂ°/S\r\n&quot;</span>, gyro_x_act, gyro_y_act, gyro_z_act);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;act ax = %.2fg, act ay = %.2fg,act az = %.2fg\r\n&quot;</span>, accel_x_act, accel_y_act, accel_z_act);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;act temp = %.2fÂ°C\r\n&quot;</span>, temperature_act);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">usleep(<span class="number">100000</span>); <span class="comment">/*100ms */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">close(fd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;linux-spi-icm20608&quot;&gt;Linux-SPI-ICM20608&lt;/h2&gt;
&lt;h2 id=&quot;ç¯å¢ƒ&quot;&gt;ç¯å¢ƒ&lt;/h2&gt;
&lt;h3 id=&quot;ç¡¬ä»¶ç¯å¢ƒ&quot;&gt;ç¡¬ä»¶ç¯å¢ƒ&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å¼€å‘æ¿å‹å·&lt;/strong&gt;ï¼š &lt;a href=&quot;ht</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux" scheme="http://www.obito.top/tags/Linux/"/>
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Linux-I2C-AP3216C</title>
    <link href="http://www.obito.top/2024/06/27/Linux-I2C-AP3216C/"/>
    <id>http://www.obito.top/2024/06/27/Linux-I2C-AP3216C/</id>
    <published>2024-06-27T07:46:19.000Z</published>
    <updated>2024-08-22T14:38:39.519Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux-i2c-ap3216c">Linux-I2C-AP3216C</h1><h2 id="ç¯å¢ƒ">ç¯å¢ƒ</h2><h3 id="ç¡¬ä»¶ç¯å¢ƒ">ç¡¬ä»¶ç¯å¢ƒ</h3><ul><li><strong>å¼€å‘æ¿å‹å·</strong>ï¼š<a href="https://blog.csdn.net/thisway_diy/article/details/109841372">100ask_imx6ull_pro å¼€å‘æ¿</a></li><li><strong>å¤„ç†å™¨ç±»å‹</strong>ï¼šNXP IMX6ULL</li><li><strong>å¤„ç†å™¨æ¶æ„</strong>ï¼šæ©å•æ ¸ Cortex-A7</li><li><strong>å¤„ç†å™¨ä¸»é¢‘</strong>ï¼š800 MHZ</li><li><strong>å†…å­˜å®¹é‡</strong>ï¼š512 MB DDR3</li><li><strong>å­˜å‚¨ä»‹è´¨</strong>ï¼š4GB eMMC</li><li><strong>æœ¬æ¬¡æµ‹è¯•çš„é©±åŠ¨</strong>ï¼šAP3216C ä¼ æ„Ÿå™¨èŠ¯ç‰‡</li></ul><h3 id="è½¯ä»¶ç¯å¢ƒ">è½¯ä»¶ç¯å¢ƒ</h3><ul><li>å®¿ä¸»æœº<ul><li><strong>å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ</strong>ï¼šUbuntu 18.04</li><li><strong>äº¤å‰ç¼–è¯‘å™¨</strong>ï¼š100ask æä¾›çš„å·¥å…·é“¾ arm-buildroot-linux-gnueabihf- <strong>æ”¯æŒçš„æœ€ä½å†…æ ¸ç‰ˆæœ¬</strong>ï¼š4.9.0</li></ul></li><li>å¼€å‘æ¿<ul><li><strong>U-Boot</strong>ï¼šä¸€å¼€å§‹ç”¨çš„ NXP å®˜æ–¹æä¾›çš„ç‰ˆæœ¬ä½†ä¸èƒ½æ­£å¸¸å¯åŠ¨å†…æ ¸ï¼Œåæ”¹ä¸º 100ask æä¾›çš„ç‰ˆæœ¬</li><li><strong>å†…æ ¸ç‰ˆæœ¬</strong>ï¼š <a href="https://github.com/nxp-imx/linux-imx/tree/imx_4.9.88_2.0.0_ga">NXP æä¾›çš„ 4.9.88 ç‰ˆæœ¬</a></li><li><strong>æ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹</strong>ï¼š<a href="https://busybox.net/downloads/">BusyBox 1.29.0</a></li></ul></li></ul><h2 id="ap3216c-ä»‹ç»">AP3216C ä»‹ç»</h2><p>AP3216C æ˜¯ä¸€æ¬¾ç”±æ•¦å—ç§‘æŠ€ç ”å‘çš„é«˜åº¦é›†æˆçš„ä¸‰åˆä¸€ç¯å¢ƒä¼ æ„Ÿå™¨ç»„ä»¶ï¼Œé›†æˆäº†ç¯å¢ƒå…‰ä¼ æ„Ÿå™¨ï¼ˆALSâ€”â€”Ambient Light Sensorï¼‰ã€æ¥è¿‘ä¼ æ„Ÿå™¨ï¼ˆPSâ€”â€”Proximity Sensorï¼‰å’Œçº¢å¤– LEDï¼ˆIR LEDâ€”â€”Infrared LEDï¼‰çš„ä¸‰åˆä¸€æ•°å­—æ¨¡å—ã€‚</p><ul><li>I2C æ¥å£ï¼ˆå·¥ä½œåœ¨ FS æ¨¡å¼ï¼Œ400kHzï¼‰</li><li>ç¯å¢ƒå…‰ä¼ æ„Ÿå™¨å…·æœ‰ 16 ä½ ADC è¾“å‡ºï¼Œç¡®ä¿é«˜ç²¾åº¦çš„ç¯å¢ƒå…‰æ£€æµ‹</li><li>æ¥è¿‘ä¼ æ„Ÿå™¨å…·æœ‰ 10 ä½ ADC è¾“å‡º(0~1023)ï¼Œç”¨äºç²¾ç¡®çš„æ¥è¿‘è·ç¦»æµ‹é‡</li><li>è®¾å¤‡åœ°å€ï¼š0x1Eï¼Œå¯„å­˜å™¨ 8 ä½ï¼Œå¯„å­˜å™¨ä½å®½ 8 ä½</li></ul><p>AP3216C å¹¿æ³›åº”ç”¨äºæ‰‹æœºå’Œå¹³æ¿ç”µè„‘ç­‰ä¾¿æºå¼è®¾å¤‡ä¸­ï¼Œä¾‹å¦‚ç”¨äºè‡ªåŠ¨è°ƒèŠ‚å±å¹•èƒŒå…‰äº®åº¦ï¼ˆæ ¹æ®ç¯å¢ƒå…‰çº¿å¼ºåº¦å˜åŒ–è°ƒæ•´ï¼‰ï¼Œä»¥åŠåœ¨æ‰“ç”µè¯æ—¶æ£€æµ‹è„¸éƒ¨æ¥è¿‘çš„è·ç¦»ä»¥å®ç°ç†„å±ã€è§£é”ç­‰åŠŸèƒ½ã€‚</p><p>åŸç†å›¾å¦‚ä¸‹ï¼š</p><p><img src="image-20240628110159381.png" alt="image-20240628110159381"></p><p>æ¶‰åŠåˆ°çš„å¯„å­˜å™¨ï¼š</p><p><img src="image-20240628112648480.png" alt="image-20240628112648480"></p><p>SYSTEM_CONFIGURATION å¯„å­˜å™¨çš„é…ç½®è¡¨ï¼š</p><p><img src="image-20240628112802571.png" alt="image-20240628112802571"></p><p>å¼€å¯ä¸‰ç§æ¨¡å¼ï¼Œå¹¶ä¸”æ˜¯è¿ç»­æµ‹é‡çš„ï¼Œé‡‡é›† ALS éœ€è¦ 100 msï¼ŒPS éœ€è¦ 12.5 msï¼Œå› æ­¤åç»­åœ¨æµ‹è¯•ç¨‹åºçš„æ—¶å€™éœ€è¦é‡‡é›†é—´éš”éœ€è¦å»¶æ—¶å¤§äº 112.5 msã€‚</p><p><img src="image-20240628112905922.png" alt="image-20240628112905922"></p><p>å¤ä½ï¼Œå¤ä½åéœ€ç­‰å¾… 10 ms ä»¥ä¸Šã€‚</p><p><img src="image-20240628112914332.png" alt="image-20240628112914332"></p><p>æ¥è¿‘ç¨‹åº¦åˆ¤å®šä¾æ®æ˜¯é€šè¿‡ä¸¤ç»„ PS é«˜ä½é˜ˆå€¼å¯„å­˜å™¨å’Œ PS Data å¯„å­˜å™¨ è¿›è¡Œæ¯”å¯¹ï¼ŒPS Data é«˜äº PS High Threshold åˆ™åˆ¤å®šç‰©ä½“è¿œç¦»ï¼ŒPS Data ä½äº PS Low Threshold åˆ™åˆ¤å®šç‰©ä½“é è¿‘ã€‚</p><h2 id="é©±åŠ¨ä»£ç ç¼–å†™">é©±åŠ¨ä»£ç ç¼–å†™</h2><h3 id="è®¾å¤‡æè¿°ä¿¡æ¯">è®¾å¤‡æè¿°ä¿¡æ¯</h3><h4 id="æ— è®¾å¤‡æ ‘">æ— è®¾å¤‡æ ‘</h4><p>æ— è®¾å¤‡æ ‘çš„è¯ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>i2c_board_info</code> ç»“æ„ä½“æ·»åŠ è®¾å¤‡åå­—å’Œè®¾å¤‡åœ°å€ï¼Œæ¥ç€å°†è®¾å¤‡æŒ‚è½½åˆ°å¯¹åº” I2C æ€»çº¿ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†é…ä¸€ä¸ªi2cé€‚é…å™¨æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_adapter</span> *<span class="title">i2c_adap</span>;</span></span><br><span class="line"><span class="comment">// åˆ†é…ä¸€ä¸ªi2c_clientæŒ‡é’ˆ</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">i2c_client</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_board_info</span> <span class="title">ap3216c_info</span>[] =</span> &#123;</span><br><span class="line">&#123;I2C_BOARD_INFO(<span class="string">&quot;ap3216c&quot;</span>, <span class="number">0x1e</span>)&#125;,</span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ap3216c_i2c_client_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;ap3216c_i2c_client_init init\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸç†å›¾æ˜¯è¿æ¥åˆ°äº†I2C1 </span></span><br><span class="line"><span class="comment">// ä¼ å…¥0è¡¨ç¤º i2c1;1è¡¨ç¤ºi2c2 æ‰¾äº†åŠå¤©md</span></span><br><span class="line"><span class="comment">//è°ƒç”¨i2c_get_adapterè·å¾—ä¸€ä¸ªi2cæ€»çº¿ å°†ap3216cæŒ‚è½½åˆ°i2c1æ€»çº¿ä¸Š</span></span><br><span class="line">i2c_adap = i2c_get_adapter(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŠŠi2c clientå’Œi2cå™¨ä»¶å…³è”èµ·æ¥</span></span><br><span class="line">i2c_client = i2c_new_device(i2c_adap, ap3216c_info);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾i2cæ§åˆ¶å™¨</span></span><br><span class="line">i2c_put_adapter(i2c_adap);</span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;i2c_new_device ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å‡ºå£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">ap3216c_i2c_client_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å°†å‰é¢æ³¨å†Œçš„i2c_driver ä¹Ÿä»Linux å†…æ ¸ä¸­æ³¨é”€æ‰</span></span><br><span class="line">i2c_unregister_device(i2c_client);</span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;ap3216c_i2c_client_exit exit ok\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module_init(ap3216c_i2c_client_init);</span><br><span class="line">module_exit(ap3216c_i2c_client_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="è®¾å¤‡æ ‘">è®¾å¤‡æ ‘</h4><p>æœ‰è®¾å¤‡æ ‘çš„è¯ï¼Œåˆ™éœ€è¦åœ¨è®¾å¤‡æ ‘ä¸­çš„ I2C èŠ‚ç‚¹ä¸­æ·»åŠ è®¾å¤‡çš„ä¿¡æ¯ï¼Œæ¥ç€ç¼–è¯‘è®¾å¤‡æ ‘çƒ§å½•åˆ°å¼€å‘æ¿ä¸­ã€‚æ·»åŠ ä¿¡æ¯å¤§è‡´å¦‚ä¸‹ï¼š</p><p>ç”±åŸç†å›¾å¯çŸ¥ï¼Œè¯¥å¼€å‘æ¿çš„ AP3216C æ˜¯æŒ‚è½½åœ¨ i2c1 ä¸‹çš„ï¼Œi2c1 çš„å¼•è„šå¤ç”¨å…³ç³»å·²ç»æœ‰äº†ï¼Œå› æ­¤åªéœ€è¦åœ¨ i2c1 èŠ‚ç‚¹ä¸‹æ·»åŠ è®¾å¤‡ä¿¡æ¯å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&amp;iomuxc &#123;</span><br><span class="line">    // çœç•¥...</span><br><span class="line">pinctrl_i2c1: i2c1grp &#123;</span><br><span class="line">            fsl,pins = &lt;</span><br><span class="line">                MX6UL_PAD_UART4_TX_DATA__I2C1_SCL 0x4001b8b0</span><br><span class="line">                MX6UL_PAD_UART4_RX_DATA__I2C1_SDA 0x4001b8b0</span><br><span class="line">            &gt;;</span><br><span class="line">        &#125;;</span><br><span class="line">    // çœç•¥...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&amp;i2c1 &#123;</span><br><span class="line">    clock-frequency = &lt;100000&gt;;</span><br><span class="line">    pinctrl-names = &quot;default&quot;;</span><br><span class="line">    pinctrl-0 = &lt;&amp;pinctrl_i2c1&gt;;</span><br><span class="line">    status = &quot;okay&quot;;</span><br><span class="line"></span><br><span class="line">    ap3216c@1e &#123; </span><br><span class="line">        compatible = &quot;ap3216c&quot;; </span><br><span class="line">        reg = &lt;0x1e&gt;;</span><br><span class="line">        status = &quot;okay&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="driver-é©±åŠ¨ä»£ç ">driver é©±åŠ¨ä»£ç </h3><p>è¿™ä¸€éƒ¨åˆ†ä¸»è¦æ˜¯æ³¨å†Œ i2c_driver ç»“æ„ä½“ã€æ·»åŠ è®¾å¤‡èŠ‚ç‚¹ã€ç¼–å†™ file_operation ä¸­çš„ openã€releaseã€read æˆå‘˜ï¼Œopen å¯¹ AP3216C è¿›è¡Œåˆå§‹åŒ–â€”â€”å¤ä½å’Œè®¾ç½®æ¨¡å¼ï¼Œread è¯»å–ç›¸å¯¹åº”æ•°æ®çš„å¯„å­˜å™¨ï¼Œrelease è®¾ç½®ä¼‘çœ æ¨¡å¼ã€‚</p><h4 id="å¯„å­˜å™¨å®å®šä¹‰å’Œ-ap3216c-dev-ç»“æ„ä½“">å¯„å­˜å™¨å®å®šä¹‰å’Œ ap3216c_dev ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span> <span class="comment">/*æ³¨å†Œè®¾å¤‡èŠ‚ç‚¹çš„æ–‡ä»¶ç»“æ„ä½“*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span> <span class="comment">// å¯¹å­—ç¬¦è®¾å¤‡ç»“æ„cdev ä»¥åŠä¸€ç³»åˆ—çš„æ“ä½œå‡½æ•°çš„å®šä¹‰ã€‚åŒ…å«äº†cdev ç»“æ„åŠç›¸å…³å‡½æ•°çš„å®šä¹‰ã€‚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span> <span class="comment">//åŒ…å«äº†deviceã€class ç­‰ç»“æ„çš„å®šä¹‰</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span> <span class="comment">//åŒ…å«äº†copy_to_userã€copy_from_user ç­‰å†…æ ¸è®¿é—®ç”¨æˆ·è¿›ç¨‹å†…å­˜åœ°å€çš„å‡½æ•°å®šä¹‰ã€‚</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* å­—ç¬¦è®¾å¤‡ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_NAME <span class="string">&quot;ap3216c&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* AP3216Cå¯„å­˜å™¨ */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_SYSTEM_CONFIGURATION 0x00<span class="comment">/* é…ç½®å¯„å­˜å™¨ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_IRDATALOW 0x0A <span class="comment">/* IRæ•°æ®ä½å­—èŠ‚ */</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_IRDATAHIGH 0x0B <span class="comment">/* IRæ•°æ®é«˜å­—èŠ‚ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_ALSDATALOW 0x0C <span class="comment">/* ALSæ•°æ®ä½å­—èŠ‚ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_ALSDATAHIGH 0X0D <span class="comment">/* ALSæ•°æ®é«˜å­—èŠ‚ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_PSDATALOW 0X0E <span class="comment">/* PSæ•°æ®ä½å­—èŠ‚ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP3216C_PSDATAHIGH 0X0F<span class="comment">/* PSæ•°æ®é«˜å­—èŠ‚ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ap3216c_dev</span>&#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid;<span class="comment">/* è®¾å¤‡å· */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span><span class="comment">/* cdev  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span><span class="comment">/* ç±» */</span> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span><span class="comment">/* è®¾å¤‡ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span><span class="comment">/* è®¾å¤‡èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="type">int</span> major;<span class="comment">/* ä¸»è®¾å¤‡å· */</span></span><br><span class="line"><span class="type">void</span> *private_data;<span class="comment">/* ç§æœ‰æ•°æ® */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span> ir, als, ps;<span class="comment">/* ä¸‰ä¸ªå…‰ä¼ æ„Ÿå™¨æ•°æ® */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ap3216c_dev</span> <span class="title">ap3216c_dev_t</span>;</span></span><br></pre></td></tr></table></figure><h4 id="æ³¨å†Œ-æ³¨é”€-i2c-driverç»“æ„ä½“">æ³¨å†Œ/æ³¨é”€ i2c_driverç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è®¾å¤‡æ ‘compatibleåŒ¹é…è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table</span>[] =</span> &#123;</span><br><span class="line">&#123;.compatible = <span class="string">&quot;ap3216c&quot;</span>&#125;, </span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ— è®¾å¤‡æ ‘çš„åŒ¹é…IDè¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">id_table</span>[] =</span> &#123;</span><br><span class="line">&#123;<span class="string">&quot;ap3216c&quot;</span>&#125;,</span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰i2cæ€»çº¿è®¾å¤‡ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">ap3216c_i2c_driver</span> =</span> &#123;</span><br><span class="line">.driver = &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.name  = <span class="string">&quot;ap3216c&quot;</span>,</span><br><span class="line">.of_match_table = of_match_table,</span><br><span class="line">&#125;,</span><br><span class="line">.probe= ap3216c_i2c_driver_probe,</span><br><span class="line">.remove = ap3216c_i2c_driver_remove,</span><br><span class="line">.id_table= id_table,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ap3216c_i2c_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="comment">// æ³¨å†Œ i2c é©±åŠ¨</span></span><br><span class="line">ret = i2c_add_driver(&amp;ap3216c_i2c_driver);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å‡ºå£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">ap3216c_i2c_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å°†å‰é¢æ³¨å†Œçš„i2c_driverä¹Ÿä»Linuxå†…æ ¸ä¸­æ³¨é”€æ‰</span></span><br><span class="line">i2c_del_driver(&amp;ap3216c_i2c_driver);</span><br><span class="line">&#125;</span><br><span class="line">module_init(ap3216c_i2c_driver_init);</span><br><span class="line">module_exit(ap3216c_i2c_driver_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ å­—ç¬¦è®¾å¤‡">æ·»åŠ å­—ç¬¦è®¾å¤‡</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">ap3216c_fops</span> =</span> &#123;</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">.open   = ap3216c_open,</span><br><span class="line">.release  = ap3216c_close,</span><br><span class="line">.read= ap3216c_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_i2c_driver_probe</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *id)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 1.åˆ†é…è®¾å¤‡å·</span></span><br><span class="line"><span class="keyword">if</span>(<span class="type">ap3216c_dev_t</span>.major)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">ap3216c_dev_t</span>.devid = MKDEV(<span class="type">ap3216c_dev_t</span>.major, <span class="number">0</span>);</span><br><span class="line">register_chrdev_region(<span class="type">ap3216c_dev_t</span>.devid, <span class="number">1</span>, AP3216C_NAME);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">alloc_chrdev_region(&amp;<span class="type">ap3216c_dev_t</span>.devid, <span class="number">0</span>, <span class="number">1</span>, AP3216C_NAME);</span><br><span class="line"><span class="type">ap3216c_dev_t</span>.major = MAJOR(<span class="type">ap3216c_dev_t</span>.devid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. åˆå§‹åŒ–cdev</span></span><br><span class="line">cdev_init(&amp;<span class="type">ap3216c_dev_t</span>.cdev, &amp;ap3216c_fops);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.æ·»åŠ è®¾å¤‡å·åˆ°cdev</span></span><br><span class="line">cdev_add(&amp;<span class="type">ap3216c_dev_t</span>.cdev, <span class="type">ap3216c_dev_t</span>.devid, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. åˆ›å»ºç±»</span></span><br><span class="line"><span class="type">ap3216c_dev_t</span>.class = class_create(THIS_MODULE, AP3216C_NAME);</span><br><span class="line"><span class="keyword">if</span>(IS_ERR(<span class="type">ap3216c_dev_t</span>.class))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="type">ap3216c_dev_t</span>.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. ç±»ä¸‹åˆ›å»ºè®¾å¤‡</span></span><br><span class="line"><span class="type">ap3216c_dev_t</span>.device = device_create(<span class="type">ap3216c_dev_t</span>.class, <span class="literal">NULL</span>, <span class="type">ap3216c_dev_t</span>.devid, <span class="literal">NULL</span>, AP3216C_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="type">ap3216c_dev_t</span>.device))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="type">ap3216c_dev_t</span>.device);</span><br><span class="line"></span><br><span class="line"><span class="type">ap3216c_dev_t</span>.private_data = client;</span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;ap3216c_i2c_driver_probe ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_i2c_driver_remove</span><span class="params">(<span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 1.æ³¨é”€è®¾å¤‡å·</span></span><br><span class="line">unregister_chrdev_region(<span class="type">ap3216c_dev_t</span>.devid, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 2.åˆ é™¤è®¾å¤‡</span></span><br><span class="line">cdev_del(&amp;<span class="type">ap3216c_dev_t</span>.cdev);</span><br><span class="line"><span class="comment">// 3.æ³¨é”€è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line">device_destroy(<span class="type">ap3216c_dev_t</span>.class, <span class="type">ap3216c_dev_t</span>.devid);</span><br><span class="line"><span class="comment">// 4.åˆ é™¤ç±»</span></span><br><span class="line">class_destroy(<span class="type">ap3216c_dev_t</span>.class);</span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;ap3216c_i2c_driver_remove ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ”¶å‘æ•°æ®å‡½æ•°">æ”¶å‘æ•°æ®å‡½æ•°</h4><p>ä¸»è¦å°±æ˜¯å¡«å…… i2c_msg ç»“æ„ä½“ï¼Œä¾‹å¦‚è®¾å¤‡åœ°å€ã€å†™æ•°æ®/è¯»æ•°æ®ï¼Œå¯„å­˜å™¨çš„åœ°å€ã€msg çš„é•¿åº¦ï¼Œå†™å…¥æ•°æ®çš„ç¼“å†²åŒºå’Œè¯»å–æ•°æ®çš„ç¼“å†²åŒºï¼Œç„¶åè°ƒç”¨ i2c_transfer å‡½æ•°è¿›è¡Œä¼ è¾“æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : è¯»å–I2C è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : I2C è®¾å¤‡</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¯»å–åˆ°çš„æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦è¯»å–çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_read_reg</span><span class="params">(<span class="keyword">struct</span> ap3216c_dev *dev, <span class="type">uint8_t</span> reg, <span class="type">uint8_t</span> *val, <span class="type">uint16_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[2];</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* msg[0]ï¼Œç¬¬ä¸€æ¡å†™æ¶ˆæ¯ï¼Œå‘é€è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€*/</span></span><br><span class="line">msg[<span class="number">0</span>].addr = client-&gt;addr;<span class="comment">// è®¾å¤‡åœ°å€</span></span><br><span class="line">msg[<span class="number">0</span>].flags = <span class="number">0</span>;<span class="comment">// å†™æ•°æ®</span></span><br><span class="line">msg[<span class="number">0</span>].buf = &amp;reg;<span class="comment">// å¯„å­˜å™¨åœ°å€</span></span><br><span class="line">msg[<span class="number">0</span>].len = <span class="number">1</span>;<span class="comment">// msgé•¿åº¦ï¼šå¯„å­˜å™¨åœ°å€é•¿åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* msg[1]ï¼Œç¬¬äºŒæ¡è¯»æ¶ˆæ¯ï¼Œè¯»å–å¯„å­˜å™¨æ•°æ®*/</span></span><br><span class="line">msg[<span class="number">1</span>].addr = client-&gt;addr;<span class="comment">// è®¾å¤‡åœ°å€</span></span><br><span class="line">msg[<span class="number">1</span>].flags = I2C_M_RD;<span class="comment">// è¯»æ•°æ®</span></span><br><span class="line">msg[<span class="number">1</span>].buf= val;<span class="comment">// è¯»å–çš„æ•°æ®</span></span><br><span class="line">msg[<span class="number">1</span>].len = len;<span class="comment">// msgé•¿åº¦ï¼šè¯»å–æ•°æ®çš„é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">ret =  i2c_transfer(client-&gt;adapter, msg, <span class="number">2</span>);<span class="comment">// 2ä¸ªmsg</span></span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">2</span>)</span><br><span class="line">ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = -EREMOTEIO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : å‘ I2C è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : è¦å†™å…¥çš„è®¾å¤‡ç»“æ„ä½“</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦å†™å…¥çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¦å†™å…¥çš„æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦å†™å…¥çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_write_reg</span><span class="params">(<span class="keyword">struct</span> ap3216c_dev *dev, <span class="type">uint8_t</span> reg, <span class="type">uint8_t</span> *buf, <span class="type">uint16_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> tmp[<span class="number">256</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>;</span><span class="comment">// å­˜æ”¾å¾…å†™å…¥çš„å¯„å­˜å™¨åœ°å€å’Œæ•°æ®ç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    tmp[<span class="number">0</span>] = reg;               <span class="comment">// å¯„å­˜å™¨åœ°å€</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;tmp[<span class="number">1</span>], buf, len); <span class="comment">// å†™å…¥çš„æ•°æ®</span></span><br><span class="line"></span><br><span class="line">msg.addr = client-&gt;addr;<span class="comment">// è®¾å¤‡åœ°å€</span></span><br><span class="line">msg.flags = <span class="number">0</span>;<span class="comment">// å†™æ•°æ®</span></span><br><span class="line">msg.buf = tmp;<span class="comment">// å‘é€çš„æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line">msg.len = len + <span class="number">1</span>;<span class="comment">// msgé•¿åº¦ï¼šå†™å…¥çš„æ•°æ®é•¿åº¦ + å¯„å­˜å™¨åœ°å€é•¿åº¦ ï¼ˆå•ä½ï¼šå­—èŠ‚)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> i2c_transfer(client-&gt;adapter, &amp;msg, <span class="number">1</span>);<span class="comment">// 1ä¸ªmsg</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="open-å‡½æ•°ï¼š">open å‡½æ•°ï¼š</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_open</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> value;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.å¤ä½ </span></span><br><span class="line">file-&gt;private_data = &amp;<span class="type">ap3216c_dev_t</span>;</span><br><span class="line">value = <span class="number">0x04</span>;</span><br><span class="line">ret = ap3216c_write_reg(&amp;<span class="type">ap3216c_dev_t</span>, AP3216C_SYSTEM_CONFIGURATION, &amp;value, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;%s, %s, %d error\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.å¤ä½å®Œéœ€è¦ç­‰å¾…10msä»¥ä¸Š</span></span><br><span class="line">mdelay(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.è®¾ç½®æ¨¡å¼ä¸ºALS+PS+IR</span></span><br><span class="line">value = <span class="number">0x03</span>;</span><br><span class="line">ret = ap3216c_write_reg(&amp;<span class="type">ap3216c_dev_t</span>, AP3216C_SYSTEM_CONFIGURATION, &amp;value, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;%s, %s, %d error\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="read-å‡½æ•°">read å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : è¯»å–AP3216Cçš„æ•°æ®ï¼Œè¯»å–åŸå§‹æ•°æ®ï¼ŒåŒ…æ‹¬ALS,PSå’ŒIR, 142 </span></span><br><span class="line"><span class="comment">*   : åŒæ—¶æ‰“å¼€ALS,IR+PSçš„è¯ä¸¤æ¬¡æ•°æ®è¯»å–çš„é—´éš”è¦å¤§äº112.5ms</span></span><br><span class="line"><span class="comment">* @param - dev : ap3216c_devç»“æ„ä½“ï¼Œå­˜æ”¾ä¼ æ„Ÿå™¨æ•°æ®ï¼širã€alsã€ps</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ap3216c_read_data</span><span class="params">(<span class="keyword">struct</span> ap3216c_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="type">uint8_t</span> buf[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">ap3216c_read_reg(dev, AP3216C_IRDATALOW + i, &amp;buf[i], <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è¯»å– IR ä¼ æ„Ÿå™¨çš„æ•°æ® */</span></span><br><span class="line"><span class="keyword">if</span>(buf[<span class="number">0</span>] &amp; <span class="number">0x80</span>)</span><br><span class="line">&#123;</span><br><span class="line">dev-&gt;ir = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;<span class="comment">// éœ€è¦è½¬16ä½å†ç§»ä½ï¼Œå¦åˆ™ä¼šä¸¢å¤±æ•°æ®</span></span><br><span class="line">dev-&gt;ir = ((<span class="type">uint16_t</span>)buf[<span class="number">1</span>] &lt;&lt; <span class="number">2</span>) | (buf[<span class="number">0</span>] &amp; <span class="number">0x03</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è¯»å– ALS æ•°æ® */</span></span><br><span class="line">dev-&gt;als = ((<span class="type">uint16_t</span>)buf[<span class="number">3</span>] &lt;&lt; <span class="number">8</span>) | buf[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è¯»å– PS ä¼ æ„Ÿå™¨çš„æ•°æ® */</span></span><br><span class="line"><span class="keyword">if</span>(buf[<span class="number">4</span>] &amp; <span class="number">0x40</span>)</span><br><span class="line">&#123;</span><br><span class="line">dev-&gt;ps = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">dev-&gt;ps = (((<span class="type">uint16_t</span>)buf[<span class="number">5</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">4</span>) | (buf[<span class="number">4</span>] &amp; <span class="number">0x0F</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">ap3216c_read</span> <span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *<span class="type">loff_t</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">short</span> kbuf[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ap3216c_dev</span> *<span class="title">dev</span> =</span> file-&gt;private_data;</span><br><span class="line"></span><br><span class="line">ap3216c_read_data(dev);</span><br><span class="line">kbuf[<span class="number">0</span>] = dev-&gt;ir;</span><br><span class="line">kbuf[<span class="number">1</span>] = dev-&gt;als;</span><br><span class="line">kbuf[<span class="number">2</span>] = dev-&gt;ps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(copy_to_user(ubuf, kbuf, <span class="keyword">sizeof</span>(kbuf)) != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;%s, %s, %d error\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="release-å‡½æ•°">release å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ap3216c_close</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> value;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.ä¼‘çœ </span></span><br><span class="line">file-&gt;private_data = &amp;<span class="type">ap3216c_dev_t</span>;</span><br><span class="line">value = <span class="number">0x00</span>;</span><br><span class="line">ret = ap3216c_write_reg(&amp;<span class="type">ap3216c_dev_t</span>, AP3216C_SYSTEM_CONFIGURATION, &amp;value, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;%s, %s, %d error\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åº”ç”¨æµ‹è¯•ç¨‹åº">åº”ç”¨æµ‹è¯•ç¨‹åº</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;unistd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fcntl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> databuf[<span class="number">3</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> ir, als, ps;</span><br><span class="line">    <span class="comment">// æ‰“å¼€è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/dev/ap3216c&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open ap3216c failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = read(fd, databuf, <span class="keyword">sizeof</span>(databuf));</span><br><span class="line">        <span class="keyword">if</span>(ret == <span class="number">0</span>) </span><br><span class="line">        &#123; <span class="comment">/* æ•°æ®è¯»å–æˆåŠŸ */</span></span><br><span class="line">          ir = databuf[<span class="number">0</span>]; <span class="comment">/* ir ä¼ æ„Ÿå™¨æ•°æ® */</span></span><br><span class="line">          als = databuf[<span class="number">1</span>]; <span class="comment">/* als ä¼ æ„Ÿå™¨æ•°æ® */</span></span><br><span class="line">          ps = databuf[<span class="number">2</span>]; <span class="comment">/* ps ä¼ æ„Ÿå™¨æ•°æ® */</span></span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;ir = %d, als = %d, ps = %d\r\n&quot;</span>, ir, als, ps);</span><br><span class="line">        &#125;</span><br><span class="line">        usleep(<span class="number">200000</span>);<span class="comment">/* é—´éš”200ms ç¡®ä¿æ•°æ®å·²ç»é‡‡é›†å®Œæˆ */</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="image-20240628133137808.png" alt="image-20240628133137808"></p><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><blockquote><p><a href="https://developer.aliyun.com/article/1083178">5_2_1_å…‰ç…§ä¿¡æ¯å±_ç¡¬ä»¶è¯¦è§£|å­¦ä¹ ç¬”è®°-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://www.bilibili.com/video/BV1fJ411i7PB/?p=80">https://www.bilibili.com/video/BV1fJ411i7PB/?p=80</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linux-i2c-ap3216c&quot;&gt;Linux-I2C-AP3216C&lt;/h1&gt;
&lt;h2 id=&quot;ç¯å¢ƒ&quot;&gt;ç¯å¢ƒ&lt;/h2&gt;
&lt;h3 id=&quot;ç¡¬ä»¶ç¯å¢ƒ&quot;&gt;ç¡¬ä»¶ç¯å¢ƒ&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å¼€å‘æ¿å‹å·&lt;/strong&gt;ï¼š&lt;a href=&quot;https</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux" scheme="http://www.obito.top/tags/Linux/"/>
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Linux-SPIé©±åŠ¨</title>
    <link href="http://www.obito.top/2024/06/27/Linux-SPI%E9%A9%B1%E5%8A%A8/"/>
    <id>http://www.obito.top/2024/06/27/Linux-SPI%E9%A9%B1%E5%8A%A8/</id>
    <published>2024-06-26T16:04:47.000Z</published>
    <updated>2024-07-01T13:18:55.721Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux-spié©±åŠ¨">Linux-SPIé©±åŠ¨</h1><h2 id="åºè¨€">åºè¨€</h2><p><em><strong>SPI å…·ä½“é€šä¿¡åè®®æœ¬æ–‡ä¸æ¶‰åŠï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»åœ¨ Linux ä¸­ SPI çš„é©±åŠ¨æ¡†æ¶ã€‚</strong></em></p><p>SPI æœ‰å››æ¡çº¿ï¼šSCLKã€MOSIã€MISOã€SS/CS</p><ul><li>SCLKï¼šæ—¶é’Ÿçº¿</li><li>MOSIï¼šä¸»æœºæ•°æ®è¾“å‡ºä»æœºæ•°æ®è¾“å…¥</li><li>MISOï¼šä¸»æœºæ•°æ®è¾“å…¥ä»æœºæ•°æ®è¾“å‡º</li><li>SS/CSï¼šç‰‡é€‰ä¿¡å·ï¼Œç”±ä¸»æœºæ§åˆ¶</li></ul><p><strong>SPI é€šä¿¡æ—¶ï¼ŒSPI çš„ç‰‡é€‰ä¿¡å·å¯ä»¥ä½œä¸ºç¡¬ä»¶ç‰‡é€‰ä¸è½¯ä»¶ç‰‡é€‰ã€‚</strong></p><ul><li>ç¡¬ä»¶ç‰‡é€‰ï¼šå¦‚æœé€‰æ‹©ä½¿ç”¨ç¡¬ä»¶ç‰‡é€‰çš„æ–¹å¼ï¼Œåˆ™åœ¨æ•°æ®ä¼ è¾“æ—¶ï¼ŒCS ç‰‡é€‰ä¿¡å·çš„ç”µå¹³ç¡¬ä»¶ä¸Šä¼šæ‹‰ä½ã€‚å½“æ•°æ®ä¼ è¾“ç»“æŸåï¼Œç¡¬ä»¶ä¸ŠCSç‰‡é€‰ä¿¡å·çš„ç”µå¹³æ‹‰é«˜ã€‚</li><li>è½¯ä»¶ç‰‡é€‰ï¼šè½¯ä»¶ç‰‡é€‰å³ SPI é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œ CS ç‰‡é€‰ä¿¡å·éœ€è¦åœ¨è½¯ä»¶ä¸Šåšå¤„ç†ï¼Œä¹Ÿå°±éœ€è¦åµŒå…¥å¼å¼€å‘è€…åœ¨æ•°æ®ä¼ è¾“å‰æ‰‹åŠ¨ï¼ˆç¨‹åºä¸­ï¼‰æ‹‰ä½ CS ç‰‡é€‰ä¿¡å·çš„ç”µå¹³ï¼Œåœ¨æ•°æ®ä¼ è¾“ç»“æŸåï¼Œä¹Ÿéœ€è¦è½¯ä»¶æ‹‰é«˜ CS ç‰‡é€‰ä¿¡å·çš„ç”µå¹³ã€‚</li></ul><h2 id="spi-é©±åŠ¨æ¡†æ¶">SPI é©±åŠ¨æ¡†æ¶</h2><p>Linux SPI é©±åŠ¨å¯åˆ†ä¸ºï¼šSPI æ€»çº¿é©±åŠ¨å’Œ SPI è®¾å¤‡é©±åŠ¨ã€‚</p><ul><li>SPI æ€»çº¿é©±åŠ¨ï¼šä¸»è¦åŒ…å« SPI ç¡¬ä»¶ä½“ç³»ç»“æ„ä¸­é€‚é…å™¨(SPI æ§åˆ¶å™¨)çš„æ§åˆ¶ï¼Œç”¨äºäº§ç”Ÿ SPI è¯»å†™æ—¶åºã€‚</li><li>SPI è®¾å¤‡é©±åŠ¨ï¼šé€šè¿‡ SPI ä¸»æœºé©±åŠ¨ä¸ CPU äº¤æ¢æ•°æ®ã€‚</li></ul><p>SPI è®¾å¤‡é©±åŠ¨æ¶‰åŠå­—ç¬¦è®¾å¤‡é©±åŠ¨ã€SPI æ ¸å¿ƒå’Œ SPI ä¸»æœºé©±åŠ¨ã€‚</p><ul><li><p>å­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼šåˆ›å»ºå­—ç¬¦è®¾å¤‡ä¸åº”ç”¨ç¨‹åºè®¿é—®æ•°æ®ã€‚</p></li><li><p>SPIæ ¸å¿ƒå±‚ï¼šæä¾›SPIæ§åˆ¶å™¨é©±åŠ¨å’Œè®¾å¤‡é©±åŠ¨çš„æ³¨å†Œæ–¹æ³•ã€æ³¨é”€æ–¹æ³•ã€SPIé€šä¿¡ç¡¬ä»¶æ— å…³æ¥å£å‡½æ•°ã€‚</p></li><li><p>SPIä¸»æœºé©±åŠ¨ï¼šä¸»è¦åŒ…å«SPIç¡¬ä»¶ä½“ç³»ç»“æ„ä¸­é€‚é…å™¨(spiæ§åˆ¶å™¨)çš„æ§åˆ¶ï¼Œç”¨äºäº§ç”ŸSPI è¯»å†™æ—¶åºã€‚</p></li></ul><h3 id="spi-æ€»çº¿é©±åŠ¨">SPI æ€»çº¿é©±åŠ¨</h3><p>SPI æ€»çº¿é©±åŠ¨ä¸»è¦æ˜¯ SOC çš„ SPI æ§åˆ¶å™¨é©±åŠ¨ï¼ŒSPI æ§åˆ¶å™¨é©±åŠ¨è´Ÿè´£ä¸ç¡¬ä»¶çš„ SPI æ§åˆ¶å™¨è¿›è¡Œäº¤äº’ï¼Œå®Œæˆç¡¬ä»¶å±‚é¢çš„åˆå§‹åŒ–ã€é…ç½®å’Œæ“ä½œã€‚è¿™ä¸€éƒ¨åˆ†ä¸€èˆ¬ç”±<strong>èŠ¯ç‰‡å‚æä¾›</strong>ï¼Œä¾‹å¦‚ IMX6ULL çš„ SPI æ§åˆ¶å™¨é©±åŠ¨å·²ç»ç”± NXP å…¬å¸ç¼–å†™å¥½äº†ï¼Œè¿™ä¸€éƒ¨åˆ†åªéœ€è¦äº†è§£å†…éƒ¨å¦‚ä½•è°ƒç”¨å³å¯ã€‚</p><p>ä¸»è¦å®ç°ï¼š</p><ul><li>ç”³è¯·å¹¶åˆå§‹åŒ– <code>spi_master</code> ç»“æ„ä½“ï¼ŒåŒ I2C çš„ <code>i2c_adapter</code>ã€‚</li><li>æ¥ç€è®¾ç½® transfer å‡½æ•°ï¼ŒåŒ I2C ä¸­çš„ <code>i2c_algorithm</code> ç»“æ„ä½“ä¸­çš„ <code>master_xfer</code> å‡½æ•°ä¸€æ ·æ•°æ®ä¼ è¾“å‡½æ•°ã€‚</li><li>æœ€åé€šè¿‡ <code>spi_register_master</code> å‡½æ•°å‘ Linux å†…æ ¸æ³¨å†Œè®¾ç½®å¥½çš„ <code>spi_master</code> ç»“æ„ä½“ã€‚</li></ul><p><code>spi_master</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/spi/spi.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_master</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span><span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* other than negative (== assign one dynamically), bus_num is fully</span></span><br><span class="line"><span class="comment"> * board-specific.  usually that simplifies to being SOC-specific.</span></span><br><span class="line"><span class="comment"> * example:  one SOC has three SPI controllers, numbered 0..2,</span></span><br><span class="line"><span class="comment"> * and one board&#x27;s schematics might show it using SPI-2.  software</span></span><br><span class="line"><span class="comment"> * would normally use bus_num=2 for that controller.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">s16bus_num;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* chipselects will be integral to many controllers; some others</span></span><br><span class="line"><span class="comment"> * might use board-specific GPIOs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">u16num_chipselect;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* some SPI controllers pose alignment requirements on DMAable</span></span><br><span class="line"><span class="comment"> * buffers; let protocol drivers know about these requirements.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">u16dma_alignment;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* spi_device.mode flags understood by this controller driver */</span></span><br><span class="line">u16mode_bits;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bitmask of supported bits_per_word for transfers */</span></span><br><span class="line">u32bits_per_word_mask;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPI_BPW_MASK(bits) BIT((bits) - 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPI_BIT_MASK(bits) (((bits) == 32) ? ~0U : (BIT(bits) - 1))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPI_BPW_RANGE_MASK(min, max) (SPI_BIT_MASK(max) - SPI_BIT_MASK(min - 1))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* limits on transfer speed */</span></span><br><span class="line">u32min_speed_hz;</span><br><span class="line">u32max_speed_hz;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* other constraints relevant to this driver */</span></span><br><span class="line">u16flags;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPI_MASTER_HALF_DUPLEXBIT(0)<span class="comment">/* can&#x27;t do full duplex */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPI_MASTER_NO_RXBIT(1)<span class="comment">/* can&#x27;t do buffer read */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPI_MASTER_NO_TXBIT(2)<span class="comment">/* can&#x27;t do buffer write */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPI_MASTER_MUST_RX      BIT(3)<span class="comment">/* requires rx */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPI_MASTER_MUST_TX      BIT(4)<span class="comment">/* requires tx */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * on some hardware transfer / message size may be constrained</span></span><br><span class="line"><span class="comment"> * the limit may depend on device transfer settings</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">size_t</span> (*max_transfer_size)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line"><span class="type">size_t</span> (*max_message_size)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* I/O mutex */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span><span class="title">io_mutex</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* lock and mutex for SPI bus locking */</span></span><br><span class="line"><span class="type">spinlock_t</span>bus_lock_spinlock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span><span class="title">bus_lock_mutex</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* flag indicating that the SPI bus is locked for exclusive use */</span></span><br><span class="line"><span class="type">bool</span>bus_lock_flag;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Setup mode and clock, etc (spi driver may call many times).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * IMPORTANT:  this may be called when transfers to another</span></span><br><span class="line"><span class="comment"> * device are active.  DO NOT UPDATE SHARED REGISTERS in ways</span></span><br><span class="line"><span class="comment"> * which could break those transfers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span>(*setup)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* bidirectional bulk transfers</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * + The transfer() method may not sleep; its main role is</span></span><br><span class="line"><span class="comment"> *   just to add the message to the queue.</span></span><br><span class="line"><span class="comment"> * + For now there&#x27;s no remove-from-queue operation, or</span></span><br><span class="line"><span class="comment"> *   any other request management</span></span><br><span class="line"><span class="comment"> * + To a given spi_device, message queueing is pure fifo</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * + The master&#x27;s main job is to process its message queue,</span></span><br><span class="line"><span class="comment"> *   selecting a chip then transferring data</span></span><br><span class="line"><span class="comment"> * + If there are multiple spi_device children, the i/o queue</span></span><br><span class="line"><span class="comment"> *   arbitration algorithm is unspecified (round robin, fifo,</span></span><br><span class="line"><span class="comment"> *   priority, reservations, preemption, etc)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * + Chipselect stays active during the entire message</span></span><br><span class="line"><span class="comment"> *   (unless modified by spi_transfer.cs_change != 0).</span></span><br><span class="line"><span class="comment"> * + The message transfers use clock and SPI mode parameters</span></span><br><span class="line"><span class="comment"> *   previously established by setup() for this device</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span>(*transfer)(<span class="keyword">struct</span> spi_device *spi,</span><br><span class="line"><span class="keyword">struct</span> spi_message *mesg);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* called on release() to free memory provided by spi_master */</span></span><br><span class="line"><span class="type">void</span>(*cleanup)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Used to enable core support for DMA handling, if can_dma()</span></span><br><span class="line"><span class="comment"> * exists and returns true then the transfer will be mapped</span></span><br><span class="line"><span class="comment"> * prior to transfer_one() being called.  The driver should</span></span><br><span class="line"><span class="comment"> * not modify or store xfer and dma_tx and dma_rx must be set</span></span><br><span class="line"><span class="comment"> * while the device is prepared.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span>(*can_dma)(<span class="keyword">struct</span> spi_master *master,</span><br><span class="line">   <span class="keyword">struct</span> spi_device *spi,</span><br><span class="line">   <span class="keyword">struct</span> spi_transfer *xfer);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These hooks are for drivers that want to use the generic</span></span><br><span class="line"><span class="comment"> * master transfer queueing mechanism. If these are used, the</span></span><br><span class="line"><span class="comment"> * transfer() function above must NOT be specified by the driver.</span></span><br><span class="line"><span class="comment"> * Over time we expect SPI drivers to be phased over to this API.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span>queued;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kthread_worker</span><span class="title">kworker</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span>*<span class="title">kworker_task</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kthread_work</span><span class="title">pump_messages</span>;</span></span><br><span class="line"><span class="type">spinlock_t</span>queue_lock;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">queue</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span>*<span class="title">cur_msg</span>;</span></span><br><span class="line"><span class="type">bool</span>idling;</span><br><span class="line"><span class="type">bool</span>busy;</span><br><span class="line"><span class="type">bool</span>running;</span><br><span class="line"><span class="type">bool</span>rt;</span><br><span class="line"><span class="type">bool</span>auto_runtime_pm;</span><br><span class="line"><span class="type">bool</span>                            cur_msg_prepared;</span><br><span class="line"><span class="type">bool</span>cur_msg_mapped;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">completion</span>               <span class="title">xfer_completion</span>;</span></span><br><span class="line"><span class="type">size_t</span>max_dma_len;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*prepare_transfer_hardware)(<span class="keyword">struct</span> spi_master *master);</span><br><span class="line"><span class="type">int</span> (*transfer_one_message)(<span class="keyword">struct</span> spi_master *master,</span><br><span class="line">    <span class="keyword">struct</span> spi_message *mesg);</span><br><span class="line"><span class="type">int</span> (*unprepare_transfer_hardware)(<span class="keyword">struct</span> spi_master *master);</span><br><span class="line"><span class="type">int</span> (*prepare_message)(<span class="keyword">struct</span> spi_master *master,</span><br><span class="line">       <span class="keyword">struct</span> spi_message *message);</span><br><span class="line"><span class="type">int</span> (*unprepare_message)(<span class="keyword">struct</span> spi_master *master,</span><br><span class="line"> <span class="keyword">struct</span> spi_message *message);</span><br><span class="line"><span class="type">int</span> (*spi_flash_read)(<span class="keyword">struct</span>  spi_device *spi,</span><br><span class="line">      <span class="keyword">struct</span> spi_flash_read_message *msg);</span><br><span class="line"><span class="type">bool</span> (*flash_read_supported)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * These hooks are for drivers that use a generic implementation</span></span><br><span class="line"><span class="comment"> * of transfer_one_message() provied by the core.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> (*set_cs)(<span class="keyword">struct</span> spi_device *spi, <span class="type">bool</span> enable);</span><br><span class="line"><span class="type">int</span> (*transfer_one)(<span class="keyword">struct</span> spi_master *master, <span class="keyword">struct</span> spi_device *spi,</span><br><span class="line">    <span class="keyword">struct</span> spi_transfer *transfer);</span><br><span class="line"><span class="type">void</span> (*handle_err)(<span class="keyword">struct</span> spi_master *master,</span><br><span class="line">   <span class="keyword">struct</span> spi_message *message);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* gpio chip select */</span></span><br><span class="line"><span class="type">int</span>*cs_gpios;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* statistics */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_statistics</span><span class="title">statistics</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* DMA channels for use with core dmaengine helpers */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_chan</span>*<span class="title">dma_tx</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_chan</span>*<span class="title">dma_rx</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* dummy data for full duplex devices */</span></span><br><span class="line"><span class="type">void</span>*dummy_rx;</span><br><span class="line"><span class="type">void</span>*dummy_tx;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> (*fw_translate_cs)(<span class="keyword">struct</span> spi_master *master, <span class="type">unsigned</span> cs);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="spi-è®¾å¤‡é©±åŠ¨">SPI è®¾å¤‡é©±åŠ¨</h3><p>SPI è®¾å¤‡é©±åŠ¨ä¸»è¦æ˜¯å¡«å……ä¸¤ä¸ªé‡è¦çš„ç»“æ„ä½“ï¼š<code>spi_client</code> å’Œ <code>spi_driver</code>ï¼Œ<code>spi_client</code> æ˜¯æè¿°è®¾å¤‡ä¿¡æ¯çš„ï¼Œ<code>spi_driver</code> æ˜¯æè¿°é©±åŠ¨å†…å®¹çš„ï¼Œç±»ä¼¼äºå¹³å°æ€»çº¿é©±åŠ¨ä¸­çš„ <code>platform_device</code> å’Œ <code>platform_driver</code>ï¼Œå¦‚æœé‡‡ç”¨è®¾å¤‡æ ‘çš„è¯ï¼Œåˆ™åªéœ€è¦ç¼–å†™ <code>spi_driver</code> ç»“æ„ä½“çš„å†…å®¹å³å¯ï¼Œå› ä¸ºè®¾å¤‡æ ‘ä¸­çš„ SPI èŠ‚ç‚¹ä¼šè½¬æ¢ä¸º <code>spi_client</code> çš„å†…å®¹ã€‚</p><p><code>spi_client</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><p>Linux å†…æ ¸ç”¨ <code>spi_driver</code> ç»“æ„ä½“è¡¨ç¤º SPI è®¾å¤‡é©±åŠ¨ï¼Œ<code>spi_driver</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/spi/spi.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span> &#123;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device_id</span> *<span class="title">id_table</span>;</span></span><br><span class="line"><span class="type">int</span>(*probe)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line"><span class="type">int</span>(*remove)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line"><span class="type">void</span>(*shutdown)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span><span class="title">driver</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å‘å†…æ ¸æ³¨å†Œ <code>spi_driver</code> ç»“æ„ä½“ï¼šä½¿ç”¨ä¸€ä¸ªå®å®šä¹‰æ¥ä»£æ›¿ç›´æ¥åŒ…å«å¤´æ–‡ä»¶çš„æ–¹å¼è·å– <code>THIS_MODULE</code>ï¼Œä»è€Œé¿å…å¤´æ–‡ä»¶é“¾å¼ä¾èµ–ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/spi/spi.h</span></span><br><span class="line"><span class="comment">// drivers/spi/spi.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* use a define to avoid include chaining to get THIS_MODULE */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> spi_register_driver(driver) \</span></span><br><span class="line"><span class="meta">__spi_register_driver(THIS_MODULE, driver)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __spi_register_driver(<span class="keyword">struct</span> module *owner, <span class="keyword">struct</span> spi_driver *sdrv)</span><br><span class="line">&#123;</span><br><span class="line">sdrv-&gt;driver.owner = owner;</span><br><span class="line">sdrv-&gt;driver.bus = &amp;spi_bus_type;</span><br><span class="line"><span class="keyword">if</span> (sdrv-&gt;probe)</span><br><span class="line">sdrv-&gt;driver.probe = spi_drv_probe;</span><br><span class="line"><span class="keyword">if</span> (sdrv-&gt;remove)</span><br><span class="line">sdrv-&gt;driver.remove = spi_drv_remove;</span><br><span class="line"><span class="keyword">if</span> (sdrv-&gt;shutdown)</span><br><span class="line">sdrv-&gt;driver.shutdown = spi_drv_shutdown;</span><br><span class="line"><span class="keyword">return</span> driver_register(&amp;sdrv-&gt;driver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“æ³¨å†Œ spi_driver çš„æ³¨å†Œæµç¨‹åŒ <code>platform_driver</code> ä¸€è‡´ã€‚</p><h4 id="spi-è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…è¿‡ç¨‹">SPI è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…è¿‡ç¨‹</h4><p>SPI è®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…è¿‡ç¨‹æ˜¯ç”± SPI æ€»çº¿æ¥å®Œæˆçš„ï¼Œè¿™ç‚¹å’Œ platformã€I2C ç­‰é©±åŠ¨ä¸€æ ·ã€‚</p><p>SPI æ€»çº¿å®šä¹‰äº†ä¸€ä¸ª <code>bus_type</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/spi/spi.c</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> <span class="title">spi_bus_type</span> =</span> &#123;</span><br><span class="line">.name= <span class="string">&quot;spi&quot;</span>,</span><br><span class="line">.dev_groups= spi_dev_groups,</span><br><span class="line">.match= spi_match_device,</span><br><span class="line">.uevent= spi_uevent,</span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL_GPL(spi_bus_type);<span class="comment">// ä½¿å¾—åˆ«çš„æ¨¡å—å¯è°ƒç”¨è¯¥ç»“æ„ä½“</span></span><br></pre></td></tr></table></figure><p>åŒ¹é…å‡½æ•°ä¸º <code>spi_match_device</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spi_match_device</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span>*<span class="title">spi</span> =</span> to_spi_device(dev);</span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span>*<span class="title">sdrv</span> =</span> to_spi_driver(drv);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Attempt an OF style match */</span></span><br><span class="line"><span class="keyword">if</span> (of_driver_match_device(dev, drv))</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Then try ACPI */</span></span><br><span class="line"><span class="keyword">if</span> (acpi_driver_match_device(dev, drv))</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sdrv-&gt;id_table)</span><br><span class="line"><span class="keyword">return</span> !!spi_match_id(sdrv-&gt;id_table, spi);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">strcmp</span>(spi-&gt;modalias, drv-&gt;name) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>é¦–å…ˆ <code>of_driver_match_device</code> å‡½æ•°ç”¨äºå®Œæˆè®¾å¤‡æ ‘è®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…ï¼Œæ¯”è¾ƒè®¾å¤‡èŠ‚ç‚¹çš„ compatible å±æ€§å’Œ <code>of_device_id</code> ç»“æ„ä½“ä¸­çš„ compatible å±æ€§æ˜¯å¦ç›¸ç­‰ã€‚</p></li><li><p>è‹¥ä¸Šä¸€æ­¥åŒ¹é…å¤±è´¥ï¼Œåˆ™è¿›è¡Œ ACPI å½¢å¼çš„åŒ¹é…ã€‚</p></li><li><p>è‹¥ä¸Šä¸€åŠåŒ¹é…ä¹Ÿå¤±è´¥ï¼Œåˆ™è¿›è¡Œä¼ ç»Ÿçš„æ— è®¾å¤‡æ ‘çš„åŒ¹é…æ–¹å¼ï¼Œæ¯”è¾ƒ <code>spi_driver</code> ç»“æ„ä½“ä¸­çš„ <code>spi_device_id</code> è¡¨å’Œ  <code>spi_device</code> ç»“æ„ä½“ä¸­ <code>modalias</code> æˆå‘˜å˜é‡æ˜¯å¦æœ‰åŒ¹é…çš„ã€‚</p></li><li><p>æœ€ååˆ™æ˜¯æ¯”è¾ƒ <code>spi_device</code> ç»“æ„ä½“ä¸­ <code>modalias</code> æˆå‘˜å˜é‡å’Œ <code>device_driver</code> ä¸­çš„ <code>name</code> æˆå‘˜å˜é‡æ˜¯å¦ç›¸ç­‰ã€‚</p></li></ul><h2 id="spi-è®¾å¤‡é©±åŠ¨ä»£ç ç¼–å†™">SPI è®¾å¤‡é©±åŠ¨ä»£ç ç¼–å†™</h2><p>é¦–å…ˆæ˜¯ SPI è®¾å¤‡çš„ä¿¡æ¯ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼šæœªä½¿ç”¨è®¾å¤‡æ ‘å’Œä½¿ç”¨è®¾å¤‡æ ‘ã€‚</p><h3 id="spi-è®¾å¤‡ä¿¡æ¯æè¿°">SPI è®¾å¤‡ä¿¡æ¯æè¿°</h3><h4 id="æœªä½¿ç”¨è®¾å¤‡æ ‘">æœªä½¿ç”¨è®¾å¤‡æ ‘</h4><p>è·Ÿ I2C ç±»ä¼¼ï¼Œæ–°å»ºä¸€ä¸ªæ¨¡å—è¿›è¡Œæ³¨å†Œ <code>spi_device</code> ç»“æ„ä½“ã€‚</p><h4 id="ä½¿ç”¨è®¾å¤‡æ ‘">ä½¿ç”¨è®¾å¤‡æ ‘</h4><p>ä½¿ç”¨è®¾å¤‡æ ‘æ–‡ä»¶æ—¶ï¼Œåªéœ€è¦åœ¨è®¾å¤‡æ ‘æ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”çš„ SPI è®¾å¤‡èŠ‚ç‚¹å³å¯ä¾‹å¦‚ï¼šæ·»åŠ  icm20608 è®¾å¤‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ·»åŠ  SPI è®¾å¤‡èŠ‚ç‚¹æœ‰è¦æ±‚ï¼Œå½¢å¼å¦‚ï¼šåˆ«å:è®¾å¤‡å@é€šé“å·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&amp;iomuxc &#123;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_hog_1&gt;;</span><br><span class="line">    imx6ul-evk &#123;</span><br><span class="line">pinctrl_ecspi3: ecspi3 &#123;              </span><br><span class="line">                    fsl,pins = &lt;</span><br><span class="line">                MX6UL_PAD_UART2_CTS_B__ECSPI3_MOSI         <span class="number">0x000010B0</span></span><br><span class="line">                MX6UL_PAD_UART2_RTS_B__ECSPI3_MISO         <span class="number">0x000010B0</span></span><br><span class="line">                MX6UL_PAD_UART2_RX_DATA__ECSPI3_SCLK       <span class="number">0x000010B0</span></span><br><span class="line">                <span class="comment">//MX6UL_PAD_UART2_TX_DATA__ECSPI3_SS0        0x000010B0</span></span><br><span class="line">                MX6UL_PAD_UART2_TX_DATA__GPIO1_IO20        <span class="number">0x000010B0</span></span><br><span class="line">            &gt;;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;ecspi3 &#123; </span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_ecspi3&gt;;</span><br><span class="line">    cs-gpios = &lt;&amp;gpio1 <span class="number">20</span> GPIO_ACTIVE_LOW&gt;;<span class="comment">// ç‰‡é€‰IOç›´æ¥ç½®0</span></span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    spidev: icm20608@<span class="number">0</span>&#123;<span class="comment">// æ­¤å¤„çš„å‘½åæœ‰è¦æ±‚ï¼šè®¾å¤‡å@é€šé“å· 0è¡¨ç¤ºè¯¥è®¾å¤‡ä½¿ç”¨ ECSPI 0é€šé“</span></span><br><span class="line">        compatible = <span class="string">&quot;invensense,icm20608&quot;</span>;</span><br><span class="line">        interrupt-parent = &lt;&amp;gpio1&gt;;</span><br><span class="line">        interrupts = &lt;<span class="number">1</span> <span class="number">1</span>&gt;;</span><br><span class="line">        spi-max-frequency = &lt;<span class="number">8000000</span>&gt;; <span class="comment">// æœ€é«˜é¢‘ç‡8MHz</span></span><br><span class="line">        reg = &lt;<span class="number">0</span>&gt;; <span class="comment">// è¿™é‡Œè¡¨ç¤ºè¯¥è®¾å¤‡ä½¿ç”¨ ECSPI 0é€šé“</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>MX6UL_PAD_UART2_TX_DATA__GPIO1_IO20 è¿™ä¸ª IO æ˜¯ ICM20608 çš„ç‰‡é€‰ä¿¡å·ï¼Œè¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰å°†å…¶å¤ç”¨ä¸º ECSPI3çš„ SS0 ä¿¡å·ï¼Œè€Œæ˜¯å°†å…¶å¤ç”¨ä¸ºäº†æ™®é€šçš„ GPIO ã€‚è¿™é‡Œé€‰æ‹©è½¯ä»¶ç‰‡é€‰ä½¿ç”¨ï¼ŒNXP çš„é’ˆå¯¹ IMX6Uç³»åˆ—çš„ SPI ä¸»æœºæ§åˆ¶å™¨é©±åŠ¨ä¸­ï¼Œæœ‰å®ç° SPI çš„è½¯ä»¶ç‰‡é€‰ï¼ï¼</p><p>ä¸€å®šè¦ä½¿ç”¨ â€œcs-gpiosâ€ å±æ€§æ¥æè¿°ç‰‡é€‰å¼•è„šï¼ŒSPIä¸»æœºé©±åŠ¨å°±ä¼šæ§åˆ¶ç‰‡é€‰å¼•è„šï¼ŒSPIä¸»æœºæ§åˆ¶å™¨é©±åŠ¨å®ç°äº†SPIçš„è½¯ä»¶ç‰‡é€‰åŠŸèƒ½ï¼Œ åé¢æˆ‘ä»¬åœ¨ç¼–å†™SPIè®¾å¤‡é©±åŠ¨æ—¶ï¼Œè½¯ä»¶ä¸Šä¸ç”¨æ‰‹åŠ¨è®¾ç½®ç‰‡é€‰ç”µå¹³çš„é«˜ä½ã€‚</p><p><a href="https://blog.csdn.net/wojiaxiaohuang2014/article/details/137755653">I.MX6ULL SPI ä¸»æœºæ§åˆ¶å™¨é©±åŠ¨ï¼šè½¯ä»¶ç‰‡é€‰å¤„ç†ï¼ˆç‰‡é€‰ä¿¡å·ï¼‰_spiè½¯ä»¶ç‰‡é€‰-CSDNåšå®¢</a></p></blockquote><p>drivers/spi/spi.c ä¸­æœ‰å‡½æ•°å°†èŠ‚ç‚¹ä¸­çš„åä¸ºï¼š <code>cs-gpios</code> çš„ gpio æ·»åŠ åˆ° <code>spi_master</code> ç»“æ„ä½“çš„ <code>cs_gpios</code> æˆå‘˜ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">of_spi_register_master</span><span class="params">(<span class="keyword">struct</span> spi_master *master)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> nb, i, *cs;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span> =</span> master-&gt;dev.of_node;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!np)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">nb = of_gpio_named_count(np, <span class="string">&quot;cs-gpios&quot;</span>);</span><br><span class="line">master-&gt;num_chipselect = <span class="type">max_t</span>(<span class="type">int</span>, nb, master-&gt;num_chipselect);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Return error only for an incorrectly formed cs-gpios property */</span></span><br><span class="line"><span class="keyword">if</span> (nb == <span class="number">0</span> || nb == -ENOENT)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (nb &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> nb;</span><br><span class="line"></span><br><span class="line">cs = devm_kzalloc(&amp;master-&gt;dev,</span><br><span class="line">  <span class="keyword">sizeof</span>(<span class="type">int</span>) * master-&gt;num_chipselect,</span><br><span class="line">  GFP_KERNEL);</span><br><span class="line">master-&gt;cs_gpios = cs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!master-&gt;cs_gpios)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; master-&gt;num_chipselect; i++)</span><br><span class="line">cs[i] = -ENOENT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nb; i++)</span><br><span class="line">cs[i] = of_get_named_gpio(np, <span class="string">&quot;cs-gpios&quot;</span>, i);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>IMX6ULL çš„ ECSPI ä¸»æœºé©±åŠ¨æ–‡ä»¶ä¸º drivers/spi/spi-imx.cï¼Œæœ‰ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°å®ç°äº†è½¯ä»¶ç‰‡é€‰ IO çš„ä»£ç ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spi_imx_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// çœç•¥...</span></span><br><span class="line">master-&gt;dev.of_node = pdev-&gt;dev.of_node;</span><br><span class="line">ret = spi_bitbang_start(&amp;spi_imx-&gt;bitbang);</span><br><span class="line"><span class="keyword">if</span> (ret) &#123;</span><br><span class="line">dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;bitbang start failed with %d\n&quot;</span>, ret);</span><br><span class="line"><span class="keyword">goto</span> out_clk_put;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!master-&gt;cs_gpios) &#123;</span><br><span class="line">dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;No CS GPIOs available\n&quot;</span>);</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> out_clk_put;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; master-&gt;num_chipselect; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (!gpio_is_valid(master-&gt;cs_gpios[i]))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">ret = devm_gpio_request(&amp;pdev-&gt;dev, master-&gt;cs_gpios[i],</span><br><span class="line">DRIVER_NAME);</span><br><span class="line"><span class="keyword">if</span> (ret) &#123;</span><br><span class="line">dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Can&#x27;t get CS GPIO %i\n&quot;</span>,</span><br><span class="line">master-&gt;cs_gpios[i]);</span><br><span class="line"><span class="keyword">goto</span> out_clk_put;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;probed\n&quot;</span>);</span><br><span class="line"><span class="comment">// çœç•¥...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">spi_imx_chipselect</span><span class="params">(<span class="keyword">struct</span> spi_device *spi, <span class="type">int</span> is_active)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> active = is_active != BITBANG_CS_INACTIVE;</span><br><span class="line"><span class="type">int</span> dev_is_lowactive = !(spi-&gt;mode &amp; SPI_CS_HIGH);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!gpio_is_valid(spi-&gt;cs_gpio))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">gpio_set_value(spi-&gt;cs_gpio, dev_is_lowactive ^ active);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="spi-driver-é©±åŠ¨">SPI driver é©±åŠ¨</h3><h4 id="æ³¨å†Œ-driver-é©±åŠ¨">æ³¨å†Œ driver é©±åŠ¨</h4><p>æ³¨å†Œ <code>spi_driver</code> ç»“æ„ä½“é©±åŠ¨æ–‡ä»¶é€šç”¨ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spi/spi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xxx_dev</span> &#123;</span></span><br><span class="line"><span class="type">dev_t</span> devid;<span class="comment">/* è®¾å¤‡å· */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span><span class="comment">/* cdev  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span><span class="comment">/* ç±» */</span> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span><span class="comment">/* è®¾å¤‡ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span><span class="comment">/* è®¾å¤‡èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="type">int</span> major;<span class="comment">/* ä¸»è®¾å¤‡å· */</span></span><br><span class="line"><span class="type">void</span> *private_data;<span class="comment">/* ç§æœ‰æ•°æ® */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">xxx_dev</span> <span class="title">xxx_dev_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_spi_driver_probe</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* æ³¨å†Œå­—ç¬¦è®¾å¤‡æ“ä½œ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–spi_deviceç»“æ„ä½“ </span></span><br><span class="line">spi-&gt;mode = SPI_MODE_0;  <span class="comment">/* è®¾ç½®æ¨¡å¼ MODE0ï¼ŒCPOL=0ï¼ŒCPHA=0 */</span></span><br><span class="line">spi_setup(spi);</span><br><span class="line"><span class="type">xxx_dev_t</span>.private_data = spi;<span class="comment">/* è®¾ç½®ç§æœ‰æ•°æ® */</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_spi_driver_remove</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* æ³¨é”€å­—ç¬¦è®¾å¤‡æ“ä½œ */</span></span><br><span class="line">    </span><br><span class="line">printk(<span class="string">&quot;xxx_spi_driver_remove ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾å¤‡æ ‘compatibleåŒ¹é…è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table</span>[] =</span> &#123;</span><br><span class="line">&#123;.compatible = <span class="string">&quot;xxx&quot;</span>&#125;, </span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ— è®¾å¤‡æ ‘çš„åŒ¹é…IDè¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device_id</span> <span class="title">id_table</span>[] =</span> &#123;</span><br><span class="line">&#123;<span class="string">&quot;xxx&quot;</span>&#125;,</span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰spiæ€»çº¿è®¾å¤‡ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span> <span class="title">xxx_spi_driver</span> =</span> &#123;</span><br><span class="line">.driver = &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.name  = <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">.of_match_table = of_match_table,</span><br><span class="line">&#125;,</span><br><span class="line">.probe= xxx_spi_driver_probe,</span><br><span class="line">.remove = xxx_spi_driver_remove,</span><br><span class="line">.id_table= id_table,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxx_spi_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="comment">// æ³¨å†Œ spi é©±åŠ¨</span></span><br><span class="line">ret = spi_register_driver(&amp;xxx_spi_driver);</span><br><span class="line"></span><br><span class="line">printk(<span class="string">&quot;xxx_spi_driver_init ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å‡ºå£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">xxx_spi_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å°†å‰é¢æ³¨å†Œçš„spi_driverä¹Ÿä»Linuxå†…æ ¸ä¸­æ³¨é”€æ‰</span></span><br><span class="line">spi_unregister_driver(&amp;xxx_spi_driver);</span><br><span class="line">printk(<span class="string">&quot;xxx_spi_driver_exit ok\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(xxx_spi_driver_init);</span><br><span class="line">module_exit(xxx_spi_driver_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="æ³¨å†Œå­—ç¬¦è®¾å¤‡">æ³¨å†Œå­—ç¬¦è®¾å¤‡</h4><p>åŒ¹é…æˆåŠŸæ—¶æ³¨å†Œå­—ç¬¦è®¾å¤‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span> <span class="comment">/*æ³¨å†Œè®¾å¤‡èŠ‚ç‚¹çš„æ–‡ä»¶ç»“æ„ä½“*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span> <span class="comment">// å¯¹å­—ç¬¦è®¾å¤‡ç»“æ„cdev ä»¥åŠä¸€ç³»åˆ—çš„æ“ä½œå‡½æ•°çš„å®šä¹‰ã€‚åŒ…å«äº†cdev ç»“æ„åŠç›¸å…³å‡½æ•°çš„å®šä¹‰ã€‚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span> <span class="comment">//åŒ…å«äº†deviceã€class ç­‰ç»“æ„çš„å®šä¹‰</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">xxx_read</span> <span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *<span class="type">loff_t</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_open</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_close</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">xxx_fops</span> =</span> &#123;</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">.open   = xxx_open,</span><br><span class="line">.release  = xxx_close,</span><br><span class="line">.read= xxx_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_spi_driver_probe</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 1.åˆ†é…è®¾å¤‡å·</span></span><br><span class="line"><span class="keyword">if</span>(<span class="type">xxx_dev_t</span>.major)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">xxx_dev_t</span>.devid = MKDEV(<span class="type">xxx_dev_t</span>.major, <span class="number">0</span>);</span><br><span class="line">register_chrdev_region(<span class="type">xxx_dev_t</span>.devid, <span class="number">1</span>, xxx_NAME);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">alloc_chrdev_region(&amp;<span class="type">xxx_dev_t</span>.devid, <span class="number">0</span>, <span class="number">1</span>, xxx_NAME);</span><br><span class="line"><span class="type">xxx_dev_t</span>.major = MAJOR(<span class="type">xxx_dev_t</span>.devid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.åˆå§‹åŒ–cdev</span></span><br><span class="line">cdev_init(&amp;<span class="type">xxx_dev_t</span>.cdev, &amp;xxx_fops);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.æ·»åŠ è®¾å¤‡å·åˆ°cdev</span></span><br><span class="line">cdev_add(&amp;<span class="type">xxx_dev_t</span>.cdev, <span class="type">xxx_dev_t</span>.devid, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.åˆ›å»ºç±»</span></span><br><span class="line"><span class="type">xxx_dev_t</span>.class = class_create(THIS_MODULE, xxx_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="type">xxx_dev_t</span>.device))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="type">xxx_dev_t</span>.device);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.ç±»ä¸‹åˆ›å»ºè®¾å¤‡</span></span><br><span class="line"><span class="type">xxx_dev_t</span>.device = device_create(<span class="type">xxx_dev_t</span>.class, <span class="literal">NULL</span>, <span class="type">xxx_dev_t</span>.devid, <span class="literal">NULL</span>, xxx_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="type">xxx_dev_t</span>.device))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="type">xxx_dev_t</span>.device);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_spi_driver_remove</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 1.æ³¨é”€è®¾å¤‡å·</span></span><br><span class="line">unregister_chrdev_region(<span class="type">xxx_dev_t</span>.devid, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 2.åˆ é™¤è®¾å¤‡</span></span><br><span class="line">cdev_del(&amp;<span class="type">xxx_dev_t</span>.cdev);</span><br><span class="line"><span class="comment">// 3.æ³¨é”€è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line">device_destroy(<span class="type">xxx_dev_t</span>.class, <span class="type">xxx_dev_t</span>.devid);</span><br><span class="line"><span class="comment">// 4.åˆ é™¤ç±»</span></span><br><span class="line">class_destroy(<span class="type">xxx_dev_t</span>.class);</span><br><span class="line">printk(<span class="string">&quot;xxx_spi_driver_remove ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="spi-è®¾å¤‡æ•°æ®æ”¶å‘å’Œå¤„ç†">SPI è®¾å¤‡æ•°æ®æ”¶å‘å’Œå¤„ç†</h4><p>å®šä¹‰ä¸€ä¸ª <code>xxx_dev</code> ç»“æ„ä½“ç”¨æ¥å­˜æ”¾ä¸€äº›åˆ›å»ºè®¾å¤‡éœ€è¦çš„å˜é‡å’Œè·å–åˆ°çš„ä¿¡æ¯ï¼Œè¯»å–å’Œå†™å…¥å‡½æ•°ä¸»è¦æ˜¯å¡«å…… <code>spi_transfer</code> ç»“æ„ä½“ï¼Œæ¥ç€æ·»åŠ åˆ° <code>spi_message</code> é˜Ÿåˆ—å»ï¼Œä½¿ç”¨ <code>spi_sync</code> è¿›è¡Œå‘é€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : è¯»å– xxx è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : xxx è®¾å¤‡</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¯»å–åˆ°çš„æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦è¯»å–çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_read_reg</span><span class="params">(<span class="keyword">struct</span> xxx_dev *dev, <span class="type">uint8_t</span> reg, <span class="type">void</span> *val, <span class="type">uint8_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="type">uint8_t</span> tx_data[<span class="number">1</span>];</span><br><span class="line"><span class="type">uint8_t</span> *rx_data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> *<span class="title">t</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span> =</span> (<span class="keyword">struct</span> spi_device *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ†é…å†…å­˜ */</span></span><br><span class="line">t = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> spi_transfer), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span>(!t)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kzalloc error\n&quot;</span>);</span><br><span class="line">kfree(t);</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rx_data = kzalloc(<span class="keyword">sizeof</span>(<span class="type">uint8_t</span>) + len, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span>(!rx_data)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kzalloc error\n&quot;</span>);</span><br><span class="line">kfree(rx_data);</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å‘é€è¦è¯»å–çš„å¯„å­˜åœ°å€å’Œæ¥æ”¶è¯»å–çš„æ•°æ® */</span></span><br><span class="line">tx_data[<span class="number">0</span>] = ; <span class="comment">/* é¦–ä½1è¿˜æ˜¯0çœ‹èŠ¯ç‰‡æ‰‹å†Œ  */</span></span><br><span class="line"></span><br><span class="line">t-&gt;tx_buf = tx_data;<span class="comment">/* è¦å‘é€çš„æ•°æ®ï¼šå¯„å­˜å™¨åœ°å€ */</span></span><br><span class="line">t-&gt;rx_buf = rx_data;<span class="comment">/* è¦æ¥æ”¶çš„æ•°æ® */</span></span><br><span class="line">t-&gt;len = len + <span class="number">1</span>;<span class="comment">/* t-&gt;len=å‘é€çš„é•¿åº¦+è¯»å–çš„é•¿åº¦ */</span></span><br><span class="line"></span><br><span class="line">spi_message_init(&amp;msg); <span class="comment">/* åˆå§‹åŒ–spi_message */</span></span><br><span class="line">spi_message_add_tail(t, &amp;msg);<span class="comment">/* å°†spi_transfer æ·»åŠ åˆ°spi_message é˜Ÿåˆ— */</span></span><br><span class="line">ret = spi_sync(spi, &amp;msg); <span class="comment">/* åŒæ­¥ä¼ è¾“ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SPIæ¥æ”¶æ•°æ®æ—¶ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å¯„å­˜å™¨çš„åœ°å€ï¼Œè·³è¿‡ä¸€ä¸ªå­—èŠ‚å³å¯ã€‚</span></span><br><span class="line"><span class="built_in">memcpy</span>(val, rx_data + <span class="number">1</span>, len);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é‡Šæ”¾å†…å­˜ */</span></span><br><span class="line">kfree(t);</span><br><span class="line">kfree(rx_data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : å‘ xxx è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : è¦å†™å…¥çš„è®¾å¤‡ç»“æ„ä½“</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦å†™å…¥çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¦å†™å…¥çš„æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦å†™å…¥çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_write_reg</span><span class="params">(<span class="keyword">struct</span> xxx_dev *dev, <span class="type">uint8_t</span> reg, <span class="type">uint8_t</span> *buf, <span class="type">uint8_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"><span class="type">uint8_t</span> *tx_data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> *<span class="title">t</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> <span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span> =</span> (<span class="keyword">struct</span> spi_device *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ†é…å†…å­˜ */</span></span><br><span class="line">t = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> spi_transfer), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span>(!t)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kzalloc error\n&quot;</span>);</span><br><span class="line">kfree(t);</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tx_data = kzalloc(<span class="keyword">sizeof</span>(<span class="type">uint8_t</span>) + len, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span>(!t)</span><br><span class="line">&#123;</span><br><span class="line">printk(<span class="string">&quot;kzalloc error\n&quot;</span>);</span><br><span class="line">kfree(tx_data);</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å‘é€è¦è¯»å–çš„å¯„å­˜åœ°å€å’Œå†™å…¥çš„æ•°æ® */</span></span><br><span class="line">*tx_data = reg &amp; ~(<span class="number">0x80</span>); <span class="comment">/* å†™æ•°æ®çš„æ—¶å€™å¯„å­˜å™¨åœ°å€bit8è¦æ¸…é›¶ */</span></span><br><span class="line"><span class="built_in">memcpy</span>(tx_data + <span class="number">1</span>, buf, len);<span class="comment">/* æŠŠlen ä¸ªå¯„å­˜å™¨æ‹·è´åˆ°txdata é‡Œ */</span></span><br><span class="line"></span><br><span class="line">t-&gt;tx_buf = tx_data;<span class="comment">/* è¦å‘é€çš„æ•°æ® */</span></span><br><span class="line">t-&gt;len = len + <span class="number">1</span>;<span class="comment">/* t-&gt;len=å‘é€çš„é•¿åº¦+è¯»å–çš„é•¿åº¦ */</span></span><br><span class="line"></span><br><span class="line">spi_message_init(&amp;msg); <span class="comment">/* åˆå§‹åŒ–spi_message */</span></span><br><span class="line">spi_message_add_tail(t, &amp;msg);<span class="comment">/* å°†spi_transfer æ·»åŠ åˆ°spi_message é˜Ÿåˆ— */</span></span><br><span class="line">ret = spi_sync(spi, &amp;msg); <span class="comment">/* åŒæ­¥ä¼ è¾“ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* é‡Šæ”¾å†…å­˜ */</span></span><br><span class="line">kfree(t);</span><br><span class="line">kfree(tx_data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linux-spié©±åŠ¨&quot;&gt;Linux-SPIé©±åŠ¨&lt;/h1&gt;
&lt;h2 id=&quot;åºè¨€&quot;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;SPI å…·ä½“é€šä¿¡åè®®æœ¬æ–‡ä¸æ¶‰åŠï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»åœ¨ Linux ä¸­ SPI çš„é©±åŠ¨æ¡†æ¶ã€‚&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;SPI</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux" scheme="http://www.obito.top/tags/Linux/"/>
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Linuxè¾“å…¥å­ç³»ç»Ÿ</title>
    <link href="http://www.obito.top/2024/06/27/Linux%E8%BE%93%E5%85%A5%E5%AD%90%E7%B3%BB%E7%BB%9F/"/>
    <id>http://www.obito.top/2024/06/27/Linux%E8%BE%93%E5%85%A5%E5%AD%90%E7%B3%BB%E7%BB%9F/</id>
    <published>2024-06-26T16:04:23.000Z</published>
    <updated>2024-06-28T06:02:10.292Z</updated>
    
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux" scheme="http://www.obito.top/tags/Linux/"/>
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Linux-I2Cé©±åŠ¨</title>
    <link href="http://www.obito.top/2024/06/27/Linux-I2C%E9%A9%B1%E5%8A%A8/"/>
    <id>http://www.obito.top/2024/06/27/Linux-I2C%E9%A9%B1%E5%8A%A8/</id>
    <published>2024-06-26T16:03:52.000Z</published>
    <updated>2024-06-29T09:25:51.030Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux-i2c-é©±åŠ¨">Linux-I2C é©±åŠ¨</h1><h2 id="åºè¨€">åºè¨€</h2><p><em><strong>I2C å…·ä½“é€šä¿¡åè®®æœ¬æ–‡ä¸æ¶‰åŠï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»åœ¨ Linux ä¸­ I2C çš„é©±åŠ¨æ¡†æ¶ã€‚</strong></em></p><p>I2C æœ‰ä¸¤æ¡ä¿¡å·çº¿ï¼šSCL å’Œ SDAã€‚</p><ul><li>SCLï¼šæ—¶é’Ÿçº¿ï¼Œæ•°æ®æ”¶å‘åŒæ­¥</li><li>SDAï¼šæ•°æ®çº¿ï¼Œä¼ è¾“å…·ä½“æ•°æ®</li></ul><h2 id="i2c-é©±åŠ¨æ¡†æ¶">I2C é©±åŠ¨æ¡†æ¶</h2><p><strong>Linux I2C é©±åŠ¨ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šI2C æ ¸å¿ƒã€I2C æ€»çº¿é©±åŠ¨ã€I2C è®¾å¤‡é©±åŠ¨ã€‚</strong></p><ul><li>I2C æ ¸å¿ƒå±‚é©±åŠ¨ä½œä¸ºé¡¶å±‚é©±åŠ¨ï¼Œç®¡ç†æ•´ä¸ªI2Cå­ç³»ç»Ÿï¼Œå¹¶æä¾›äº†åŸºæœ¬çš„I2Cæ“ä½œæ¥å£ã€‚</li><li>I2C é€‚é…å™¨é©±åŠ¨è´Ÿè´£ä¸åº•å±‚ç¡¬ä»¶çš„ I2C æ§åˆ¶å™¨è¿›è¡Œäº¤äº’ï¼Œé€šè¿‡é€‚é…å™¨é©±åŠ¨ï¼ŒI2Cæ€»çº¿æ ¸å¿ƒé©±åŠ¨èƒ½å¤Ÿä¸ç¡¬ä»¶è¿›è¡Œé€šä¿¡ã€‚</li><li>I2C è®¾å¤‡é©±åŠ¨åˆ™é’ˆå¯¹å…·ä½“çš„ I2C è®¾å¤‡ç¼–å†™ï¼Œå®ç°äº†å¯¹è®¾å¤‡çš„åˆå§‹åŒ–ã€è¯»å†™æ•°æ®ç­‰æ“ä½œã€‚</li></ul><h3 id="i2c-æ ¸å¿ƒ-i2c-core-driver">I2C æ ¸å¿ƒï¼ˆI2C Core Driverï¼‰</h3><p>I2C æ ¸å¿ƒè´Ÿè´£ç®¡ç† I2C æ€»çº¿é€‚é…å™¨å’Œè®¾å¤‡ï¼Œæä¾› I2C æ€»çº¿é©±åŠ¨å’Œè®¾å¤‡é©±åŠ¨å’Œæ³¨å†Œã€æ³¨é”€æ–¹æ³•ï¼Œå®Œæˆ I2C è®¾å¤‡å’Œ I2C é©±åŠ¨åŒ¹é…è¿‡ç¨‹ã€‚è¿™ä¸€éƒ¨åˆ†ä¸æ¶‰åŠç¡¬ä»¶çš„æ“ä½œï¼Œä¸€èˆ¬ç”±<strong>ç³»ç»Ÿå‚ç¼–å†™</strong>ã€‚</p><p>I2C æ ¸å¿ƒä¸­ä¸»è¦å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.i2c_adapter æ³¨å†Œ/æ³¨é”€å‡½æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adapter)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">i2c_del_adapter</span><span class="params">(<span class="keyword">struct</span> i2c_adapter * adap)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.i2c_driver æ³¨å†Œ/æ³¨é”€å‡½æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">i2c_register_driver</span><span class="params">(<span class="keyword">struct</span> module *owner, <span class="keyword">struct</span> i2c_driver *driver)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">i2c_add_driver</span> <span class="params">(<span class="keyword">struct</span> i2c_driver *driver)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">i2c_del_driver</span><span class="params">(<span class="keyword">struct</span> i2c_driver *driver)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.åˆ›å»ºå¹¶æ³¨å†Œä¸€ä¸ªI2Cè®¾å¤‡</span></span><br><span class="line"><span class="keyword">struct</span> i2c_client *<span class="title function_">i2c_new_device</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap, <span class="keyword">struct</span> i2c_board_info <span class="type">const</span> *info)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.I2C ä¼ è¾“ã€å‘é€ã€æ¥æ”¶</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">i2c_transfer</span><span class="params">(<span class="keyword">struct</span> i2c_adapter *adap, <span class="keyword">struct</span> i2c_msg *msgs, <span class="type">int</span> num)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">i2c_master_send</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> i2c_client *client, <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">int</span> count)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">i2c_master_recv</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> i2c_client *client, <span class="type">char</span> *buf, <span class="type">int</span> count)</span></span><br></pre></td></tr></table></figure><p><code>i2c_transfer</code> å‡½æ•°å¯ä»¥è¿›è¡Œå¤æ‚çš„å¤šæ¶ˆæ¯ä¼ è¾“ï¼Œè€Œ <code>i2c_master_send</code> å’Œ <code>i2c_master_recv</code> å‡½æ•°ç”¨äºå•ä¸ªæ•°æ®æ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶ã€‚<code>i2c_transfer</code> ç”±äºå…¶çµæ´»æ€§ï¼Œé€šå¸¸è¢«ä¼˜å…ˆä½¿ç”¨ã€‚</p><h3 id="i2c-æ€»çº¿é©±åŠ¨">I2C æ€»çº¿é©±åŠ¨</h3><p>I2C æ€»çº¿é©±åŠ¨é‡ç‚¹æ˜¯ <strong>I2C é€‚é…å™¨é©±åŠ¨ï¼ˆI2C Adapter Driverï¼‰</strong>ï¼ŒI2C é€‚é…å™¨é©±åŠ¨è´Ÿè´£ä¸ç¡¬ä»¶çš„ I2C æ§åˆ¶å™¨è¿›è¡Œäº¤äº’ï¼Œå®Œæˆç¡¬ä»¶å±‚é¢çš„åˆå§‹åŒ–ã€é…ç½®å’Œæ“ä½œã€‚å®ƒå°†åº•å±‚ç¡¬ä»¶çš„ç‰¹å®šæ¥å£ä¸ I2C æ€»çº¿æ ¸å¿ƒé©±åŠ¨è¿›è¡Œè¿æ¥ï¼Œä½¿å¾—æ ¸å¿ƒé©±åŠ¨èƒ½å¤Ÿé€šè¿‡é€‚é…å™¨é©±åŠ¨æ¥è®¿é—®ç¡¬ä»¶ã€‚è¿™ä¸€éƒ¨åˆ†ä¸€èˆ¬ç”±<strong>èŠ¯ç‰‡å‚æä¾›</strong>ï¼Œä¾‹å¦‚ IMX6ULL çš„ I2C é€‚é…å™¨é©±åŠ¨å·²ç»ç”± NXP å…¬å¸ç¼–å†™å¥½äº†ã€‚</p><p>I2C é€‚é…å™¨é©±åŠ¨ä¸»è¦æ¶‰åŠä¸¤ä¸ªç»“æ„ä½“ï¼š<code>i2c_adapter</code> å’Œ <code>i2c_algorithm</code>ã€‚</p><p><code>i2c_adapter</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/i2c.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_adapter</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="class"><span class="keyword">class</span>;</span>  <span class="comment">/* classes to allow probing for */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_algorithm</span> *<span class="title">algo</span>;</span> <span class="comment">/* the algorithm to access the bus */</span></span><br><span class="line"><span class="type">void</span> *algo_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* data fields that are valid for all devices*/</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_lock_operations</span> *<span class="title">lock_ops</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rt_mutex</span> <span class="title">bus_lock</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rt_mutex</span> <span class="title">mux_lock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> timeout;<span class="comment">/* in jiffies */</span></span><br><span class="line"><span class="type">int</span> retries;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span><span class="comment">/* the adapter device */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> nr;</span><br><span class="line"><span class="type">char</span> name[<span class="number">48</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">completion</span> <span class="title">dev_released</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">userspace_clients_lock</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">userspace_clients</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_bus_recovery_info</span> *<span class="title">bus_recovery_info</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_adapter_quirks</span> *<span class="title">quirks</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>i2c_algprithm</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/i2c.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_algorithm</span> &#123;</span></span><br><span class="line"><span class="comment">/* If an adapter algorithm can&#x27;t do I2C-level access, set master_xfer</span></span><br><span class="line"><span class="comment">   to NULL. If an adapter algorithm can do SMBus access, set</span></span><br><span class="line"><span class="comment">   smbus_xfer. If set to NULL, the SMBus protocol is simulated</span></span><br><span class="line"><span class="comment">   using common I2C messages */</span></span><br><span class="line"><span class="comment">/* master_xfer should return the number of messages successfully</span></span><br><span class="line"><span class="comment">   processed, or a negative value on error */</span></span><br><span class="line"><span class="type">int</span> (*master_xfer)(<span class="keyword">struct</span> i2c_adapter *adap, <span class="keyword">struct</span> i2c_msg *msgs,</span><br><span class="line">   <span class="type">int</span> num);</span><br><span class="line"><span class="type">int</span> (*smbus_xfer) (<span class="keyword">struct</span> i2c_adapter *adap, u16 addr,</span><br><span class="line">   <span class="type">unsigned</span> <span class="type">short</span> flags, <span class="type">char</span> read_write,</span><br><span class="line">   u8 command, <span class="type">int</span> size, <span class="keyword">union</span> i2c_smbus_data *data);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* To determine what the adapter supports */</span></span><br><span class="line">u32 (*functionality) (<span class="keyword">struct</span> i2c_adapter *);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> IS_ENABLED(CONFIG_I2C_SLAVE)</span></span><br><span class="line"><span class="type">int</span> (*reg_slave)(<span class="keyword">struct</span> i2c_client *client);</span><br><span class="line"><span class="type">int</span> (*unreg_slave)(<span class="keyword">struct</span> i2c_client *client);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>master_xfer å°±æ˜¯ I2C é€‚é…å™¨çš„ä¼ è¾“å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡æ­¤å‡½æ•°æ¥å®Œæˆä¸ I2C è®¾å¤‡ä¹‹é—´çš„é€šä¿¡ã€‚</li><li>smbus_xfer å°±æ˜¯ SMBUS æ€»çº¿çš„ä¼ è¾“å‡½æ•°ã€‚</li></ul><p>I2C æ€»çº¿é©±åŠ¨ï¼Œæˆ–è€…è¯´ I2C é€‚é…å™¨é©±åŠ¨çš„ä¸»è¦å·¥ä½œå°±æ˜¯åˆå§‹åŒ– <code>i2c_adapter</code> ç»“æ„ä½“å˜é‡ï¼Œé‡Œé¢ç”±ä¸ªæˆå‘˜å˜é‡ï¼šalgorithm ä¸­å­˜åœ¨ä¸€ç³»åˆ—å‡½æ•°æŒ‡é’ˆï¼Œè¿™äº›å‡½æ•°æŒ‡é’ˆæŒ‡å‘çœŸæ­£ç¡¬ä»¶æ“ä½œä»£ç ã€‚</p><h3 id="i2c-è®¾å¤‡é©±åŠ¨-i2c-device-driver">I2C è®¾å¤‡é©±åŠ¨ï¼ˆI2C Device Driverï¼‰</h3><p>I2C è®¾å¤‡é©±åŠ¨æ˜¯é’ˆå¯¹ç‰¹å®šç±»å‹çš„ I2C è®¾å¤‡ç¼–å†™çš„é©±åŠ¨ç¨‹åºã€‚å®ƒåŒ…å«äº†å¯¹å…·ä½“è®¾å¤‡çš„æ“ä½œå’Œæ§åˆ¶é€»è¾‘ï¼Œé€šè¿‡è°ƒç”¨I2C æ€»çº¿æ ¸å¿ƒé©±åŠ¨æä¾›çš„ API å‡½æ•°ä¸è®¾å¤‡è¿›è¡Œé€šä¿¡ã€‚è®¾å¤‡é©±åŠ¨çš„ä¸»è¦ä»»åŠ¡åŒ…æ‹¬åˆå§‹åŒ–è®¾å¤‡ã€è¯»å†™æ•°æ®ã€é…ç½®è®¾å¤‡å‚æ•°ç­‰ã€‚è¿™ä¸€éƒ¨åˆ†ç”±<strong>å¼€å‘è€…ç¼–å†™</strong>ã€‚</p><p>I2C è®¾å¤‡é©±åŠ¨ä¸»è¦æ˜¯å¡«å……ä¸¤ä¸ªé‡è¦çš„ç»“æ„ä½“ï¼š<code>i2c_client</code> å’Œ <code>i2c_driver</code>ï¼Œ<code>i2c_client</code> æ˜¯æè¿°è®¾å¤‡ä¿¡æ¯çš„ï¼Œ<code>i2c_driver</code> æ˜¯æè¿°é©±åŠ¨å†…å®¹çš„ï¼Œç±»ä¼¼äºå¹³å°æ€»çº¿é©±åŠ¨ä¸­çš„ <code>platform_device</code> å’Œ <code>platform_driver</code>ï¼Œå¦‚æœé‡‡ç”¨è®¾å¤‡æ ‘çš„è¯ï¼Œåˆ™åªéœ€è¦ç¼–å†™ <code>i2c_driver</code> ç»“æ„ä½“çš„å†…å®¹å³å¯ï¼Œå› ä¸ºè®¾å¤‡æ ‘ä¸­çš„ I2C èŠ‚ç‚¹ä¼šè½¬æ¢ä¸º <code>i2c_client</code> çš„å†…å®¹ã€‚</p><p><code>i2c_client</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/i2c.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> &#123;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span> flags;<span class="comment">/* div., see below*/</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span> addr;<span class="comment">/* chip address - <span class="doctag">NOTE:</span> 7bit*/</span></span><br><span class="line"><span class="comment">/* addresses are stored in the*/</span></span><br><span class="line"><span class="comment">/* _LOWER_ 7 bits*/</span></span><br><span class="line"><span class="type">char</span> name[I2C_NAME_SIZE];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_adapter</span> *<span class="title">adapter</span>;</span><span class="comment">/* the adapter we sit on*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span><span class="comment">/* the device structure*/</span></span><br><span class="line"><span class="type">int</span> irq;<span class="comment">/* irq issued by device*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">detected</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> IS_ENABLED(CONFIG_I2C_SLAVE)</span></span><br><span class="line"><span class="type">i2c_slave_cb_t</span> slave_cb;<span class="comment">/* callback for slave mode*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>i2c_driver</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/i2c.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> &#123;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="class"><span class="keyword">class</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Notifies the driver that a new bus has appeared. You should avoid</span></span><br><span class="line"><span class="comment"> * using this, it will be removed in a near future.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> (*attach_adapter)(<span class="keyword">struct</span> i2c_adapter *) __deprecated;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Standard driver model interfaces */</span></span><br><span class="line"><span class="type">int</span> (*probe)(<span class="keyword">struct</span> i2c_client *, <span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *);</span><br><span class="line"><span class="type">int</span> (*remove)(<span class="keyword">struct</span> i2c_client *);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* driver model interfaces that don&#x27;t relate to enumeration  */</span></span><br><span class="line"><span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> i2c_client *);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Alert callback, for example for the SMBus alert protocol.</span></span><br><span class="line"><span class="comment"> * The format and meaning of the data value depends on the protocol.</span></span><br><span class="line"><span class="comment"> * For the SMBus alert protocol, there is a single bit of data passed</span></span><br><span class="line"><span class="comment"> * as the alert response&#x27;s low bit (&quot;event flag&quot;).</span></span><br><span class="line"><span class="comment"> * For the SMBus Host Notify protocol, the data corresponds to the</span></span><br><span class="line"><span class="comment"> * 16-bit payload data reported by the slave device acting as master.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> (*alert)(<span class="keyword">struct</span> i2c_client *, <span class="keyword">enum</span> i2c_alert_protocol protocol,</span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> data);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* a ioctl like command that can be used to perform specific functions</span></span><br><span class="line"><span class="comment"> * with the device.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> (*command)(<span class="keyword">struct</span> i2c_client *client, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">void</span> *arg);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span> <span class="title">driver</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> *<span class="title">id_table</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Device detection callback for automatic device creation */</span></span><br><span class="line"><span class="type">int</span> (*detect)(<span class="keyword">struct</span> i2c_client *, <span class="keyword">struct</span> i2c_board_info *);</span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> *address_list;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">clients</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="i2c-è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…è¿‡ç¨‹">I2C è®¾å¤‡å’Œé©±åŠ¨åŒ¹é…è¿‡ç¨‹</h4><p>I2C è®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…è¿‡ç¨‹æ˜¯ç”± I2C æ€»çº¿æ¥å®Œæˆçš„ï¼Œè¿™ç‚¹å’Œ platformé©±åŠ¨ä¸€æ ·ã€‚</p><p>I2c æ€»çº¿å®šä¹‰äº†ä¸€ä¸ª <code>bus_type</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// drivers/i2c/i2c-core.c</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> <span class="title">i2c_bus_type</span> =</span> &#123;</span><br><span class="line">.name= <span class="string">&quot;i2c&quot;</span>,</span><br><span class="line">.match= i2c_device_match,</span><br><span class="line">.probe= i2c_device_probe,</span><br><span class="line">.remove= i2c_device_remove,</span><br><span class="line">.shutdown= i2c_device_shutdown,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">i2c_device_match</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span>*<span class="title">client</span> =</span> i2c_verify_client(dev);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span>*<span class="title">driver</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!client)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Attempt an OF style match */</span></span><br><span class="line"><span class="keyword">if</span> (of_driver_match_device(dev, drv))</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Then ACPI style match */</span></span><br><span class="line"><span class="keyword">if</span> (acpi_driver_match_device(dev, drv))</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">driver = to_i2c_driver(drv);</span><br><span class="line"><span class="comment">/* match on an id table if there is one */</span></span><br><span class="line"><span class="keyword">if</span> (driver-&gt;id_table)</span><br><span class="line"><span class="keyword">return</span> i2c_match_id(driver-&gt;id_table, client) != <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>é¦–å…ˆ <code>of_driver_match_device</code> å‡½æ•°ç”¨äºå®Œæˆè®¾å¤‡æ ‘è®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…ï¼Œæ¯”è¾ƒè®¾å¤‡èŠ‚ç‚¹çš„ compatible å±æ€§å’Œ <code>of_device_id</code> ç»“æ„ä½“ä¸­çš„ compatible å±æ€§æ˜¯å¦ç›¸ç­‰ã€‚</p></li><li><p>è‹¥ä¸Šä¸€æ­¥åŒ¹é…å¤±è´¥ï¼Œåˆ™è¿›è¡Œ ACPI å½¢å¼çš„åŒ¹é…ã€‚</p></li><li><p>æœ€ååˆ™æ˜¯è¿›è¡Œä¼ ç»Ÿçš„æ— è®¾å¤‡æ ‘çš„åŒ¹é…æ–¹å¼ï¼Œæ¯”è¾ƒ <code>i2c_client</code> ç»“æ„ä½“ä¸­ name æˆå‘˜å˜é‡å’Œ <code>i2c_driver</code> ç»“æ„ä½“ä¸­ <code>i2c_device_id</code> è¡¨æ˜¯å¦æœ‰åŒ¹é…çš„ã€‚</p></li></ul><h2 id="i2c-è®¾å¤‡é©±åŠ¨ç¼–å†™è¿‡ç¨‹">I2C è®¾å¤‡é©±åŠ¨ç¼–å†™è¿‡ç¨‹</h2><p>é¦–å…ˆæ˜¯ I2C è®¾å¤‡çš„ä¿¡æ¯ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼šæœªä½¿ç”¨è®¾å¤‡æ ‘å’Œä½¿ç”¨è®¾å¤‡æ ‘ã€‚</p><h3 id="i2c-è®¾å¤‡ä¿¡æ¯æè¿°">I2C è®¾å¤‡ä¿¡æ¯æè¿°</h3><h4 id="æœªä½¿ç”¨è®¾å¤‡æ ‘">æœªä½¿ç”¨è®¾å¤‡æ ‘</h4><p>æœªä½¿ç”¨è®¾å¤‡æ ‘çš„è¯ï¼Œåˆ™éœ€è¦åœ¨æ–°å»ºä¸€ä¸ªæ–‡ä»¶ä¾‹å¦‚ <code>xxx_i2c_client.c</code> æ–‡ä»¶ï¼ˆå‘½åæ— è¦æ±‚ï¼‰ã€‚</p><ul><li>åœ¨è¯¥æ–‡ä»¶ä¸‹ä½¿ç”¨ <code>i2c_borad_info</code> ç»“æ„ä½“æè¿° I2C è®¾å¤‡çš„ä¿¡æ¯â€”â€”è®¾å¤‡åå­—å’Œè®¾å¤‡åœ°å€ï¼Œ</li><li>æ¥ç€å°†è¯¥è®¾å¤‡æŒ‚è½½åœ¨ç›¸å¯¹åº”çš„ I2C æ€»çº¿ä¸Š</li></ul><p><code>i2c_borad_info</code> ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/i2c.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_board_info</span> &#123;</span></span><br><span class="line"><span class="type">char</span>type[I2C_NAME_SIZE];<span class="comment">/* I2C è®¾å¤‡åå­—*/</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>flags;<span class="comment">/* æ ‡å¿—*/</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>addr;<span class="comment">/* I2C å™¨ä»¶åœ°å€*/</span></span><br><span class="line"><span class="type">void</span>*platform_data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dev_archdata</span>*<span class="title">archdata</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_node</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span> *<span class="title">fwnode</span>;</span></span><br><span class="line"><span class="type">int</span>irq;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ type å’Œ addr è¿™ä¸¤ä¸ªæˆå‘˜å˜é‡å¿…é¡»è¦è®¾ç½®ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†é…ä¸€ä¸ªi2cé€‚é…å™¨æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_adapter</span> *<span class="title">i2c_adap</span>;</span></span><br><span class="line"><span class="comment">// åˆ†é…ä¸€ä¸ªi2c_clientæŒ‡é’ˆ</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">i2c_client</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* I2C è®¾å¤‡ä¿¡æ¯ï¼šè®¾å¤‡åå­— è®¾å¤‡åœ°å€ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_board_info</span> <span class="title">xxx_board_info</span>[] =</span> &#123;</span><br><span class="line">&#123;I2C_BOARD_INFO(<span class="string">&quot;xxx@xx&quot;</span>, <span class="number">0x00</span>)&#125;,</span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxx_i2c_client_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// è°ƒç”¨i2c_get_adapterè·å¾—ä¸€ä¸ªi2cæ€»çº¿ å°†xxxæŒ‚è½½åˆ°i2c(fd+1)æ€»çº¿ä¸Š</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„fdå–å†³äºä½ çš„è®¾å¤‡æŒ‚è½½åœ¨å“ªæ ¹I2Cæ€»çº¿ä¸Šï¼ˆçœ‹åŸç†å›¾ï¼‰</span></span><br><span class="line">    <span class="comment">// æ¥ç€çœ‹ç€æ ¹I2Cæ€»çº¿åœ¨ä½ å¼€å‘æ¿ä¸­çš„è®¾å¤‡æ ‘æˆ–å†…æ ¸é…ç½®ä¸­çš„é¡ºåºç¼–å·(ä¸€èˆ¬ä»0å¼€å§‹)</span></span><br><span class="line">i2c_adap = i2c_get_adapter(fd);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠi2c clientå’Œi2cå™¨ä»¶å…³è”èµ·æ¥</span></span><br><span class="line">i2c_client = i2c_new_device(i2c_adap, xxx_info);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾i2cæ§åˆ¶å™¨</span></span><br><span class="line">i2c_put_adapter(i2c_adap);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å‡ºå£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">xxx_i2c_client_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å°†å‰é¢æ³¨å†Œçš„i2c_driver ä¹Ÿä»Linux å†…æ ¸ä¸­æ³¨é”€æ‰</span></span><br><span class="line">i2c_unregister_device(i2c_client);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(xxx_i2c_client_init);</span><br><span class="line">module_exit(xxx_i2c_client_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨è®¾å¤‡æ ‘">ä½¿ç”¨è®¾å¤‡æ ‘</h4><p>ä½¿ç”¨è®¾å¤‡æ ‘æ–‡ä»¶æ—¶ï¼Œåªéœ€è¦åœ¨è®¾å¤‡æ ‘æ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”çš„ I2C è®¾å¤‡èŠ‚ç‚¹å³å¯ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c1 &#123;</span><br><span class="line">    clock-frequency = &lt;<span class="number">100000</span>&gt;;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_i2c1&gt;;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ ä»¥ä¸‹ä¿¡æ¯å³å¯ï¼šè®¾å¤‡åå­—å’Œè®¾å¤‡åœ°å€</span></span><br><span class="line">    ap3216c@<span class="number">1</span>e &#123; </span><br><span class="line">        compatible = <span class="string">&quot;ap3216c&quot;</span>; </span><br><span class="line">        reg = &lt;<span class="number">0x1e</span>&gt;;</span><br><span class="line">        status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="i2c-driver-é©±åŠ¨">I2C driver é©±åŠ¨</h3><h4 id="æ³¨å†Œ-driver-é©±åŠ¨">æ³¨å†Œ driver é©±åŠ¨</h4><p>æ³¨å†Œ <code>i2c_driver</code> ç»“æ„ä½“é©±åŠ¨æ–‡ä»¶é€šç”¨ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_i2c_driver_probe</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* æ³¨å†Œå­—ç¬¦è®¾å¤‡æ“ä½œ */</span></span><br><span class="line">    </span><br><span class="line"> <span class="comment">// è®¾ç½®ç§æœ‰æ•°æ®</span></span><br><span class="line"><span class="type">xxx_dev_t</span>.private_data = client;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_i2c_driver_remove</span><span class="params">(<span class="keyword">struct</span> i2c_client *client)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* æ³¨é”€å­—ç¬¦è®¾å¤‡æ“ä½œ */</span></span><br><span class="line">    </span><br><span class="line">    printk(<span class="string">&quot;xxx_i2c_driver_remove ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾å¤‡æ ‘compatibleåŒ¹é…è¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">of_match_table</span>[] =</span> &#123;</span><br><span class="line">&#123;.compatible = <span class="string">&quot;xxx&quot;</span>&#125;, </span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ— è®¾å¤‡æ ‘çš„åŒ¹é…IDè¡¨ */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">id_table</span>[] =</span> &#123;</span><br><span class="line">&#123;<span class="string">&quot;xxx&quot;</span>&#125;,</span><br><span class="line">&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®šä¹‰i2cæ€»çº¿è®¾å¤‡ç»“æ„ä½“ */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">xxx_i2c_driver</span> =</span> &#123;</span><br><span class="line">.driver = &#123;</span><br><span class="line">.owner = THIS_MODULE,</span><br><span class="line">.name  = <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">.of_match_table = of_match_table,</span><br><span class="line">&#125;,</span><br><span class="line">.probe= xxx_i2c_driver_probe,</span><br><span class="line">.remove = xxx_i2c_driver_remove,</span><br><span class="line">.id_table= id_table,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å…¥å£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxx_i2c_driver_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="comment">// æ³¨å†Œ i2c é©±åŠ¨</span></span><br><span class="line">ret = i2c_add_driver(&amp;xxx_i2c_driver);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é©±åŠ¨å‡ºå£å‡½æ•° */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">xxx_i2c_driver_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// å°†å‰é¢æ³¨å†Œçš„i2c_driverä¹Ÿä»Linuxå†…æ ¸ä¸­æ³¨é”€æ‰</span></span><br><span class="line">i2c_del_driver(&amp;xxx_i2c_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(xxx_i2c_driver_init);</span><br><span class="line">module_exit(xxx_i2c_driver_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="æ³¨å†Œå­—ç¬¦è®¾å¤‡">æ³¨å†Œå­—ç¬¦è®¾å¤‡</h4><p>åŒ¹é…æˆåŠŸæ—¶æ³¨å†Œå­—ç¬¦è®¾å¤‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span> <span class="comment">/*æ³¨å†Œè®¾å¤‡èŠ‚ç‚¹çš„æ–‡ä»¶ç»“æ„ä½“*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span> <span class="comment">// å¯¹å­—ç¬¦è®¾å¤‡ç»“æ„cdev ä»¥åŠä¸€ç³»åˆ—çš„æ“ä½œå‡½æ•°çš„å®šä¹‰ã€‚åŒ…å«äº†cdev ç»“æ„åŠç›¸å…³å‡½æ•°çš„å®šä¹‰ã€‚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span> <span class="comment">//åŒ…å«äº†deviceã€class ç­‰ç»“æ„çš„å®šä¹‰</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">xxx_read</span> <span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *<span class="type">loff_t</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_open</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_close</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">xxx_fops</span> =</span> &#123;</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">.open   = xxx_open,</span><br><span class="line">.release  = xxx_close,</span><br><span class="line">.read= xxx_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_spi_driver_probe</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 1.åˆ†é…è®¾å¤‡å·</span></span><br><span class="line"><span class="keyword">if</span>(<span class="type">xxx_dev_t</span>.major)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">xxx_dev_t</span>.devid = MKDEV(<span class="type">xxx_dev_t</span>.major, <span class="number">0</span>);</span><br><span class="line">register_chrdev_region(<span class="type">xxx_dev_t</span>.devid, <span class="number">1</span>, xxx_NAME);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">alloc_chrdev_region(&amp;<span class="type">xxx_dev_t</span>.devid, <span class="number">0</span>, <span class="number">1</span>, xxx_NAME);</span><br><span class="line"><span class="type">xxx_dev_t</span>.major = MAJOR(<span class="type">xxx_dev_t</span>.devid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.åˆå§‹åŒ–cdev</span></span><br><span class="line">cdev_init(&amp;<span class="type">xxx_dev_t</span>.cdev, &amp;xxx_fops);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.æ·»åŠ è®¾å¤‡å·åˆ°cdev</span></span><br><span class="line">cdev_add(&amp;<span class="type">xxx_dev_t</span>.cdev, <span class="type">xxx_dev_t</span>.devid, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.åˆ›å»ºç±»</span></span><br><span class="line"><span class="type">xxx_dev_t</span>.class = class_create(THIS_MODULE, xxx_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="type">xxx_dev_t</span>.device))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="type">xxx_dev_t</span>.device);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.ç±»ä¸‹åˆ›å»ºè®¾å¤‡</span></span><br><span class="line"><span class="type">xxx_dev_t</span>.device = device_create(<span class="type">xxx_dev_t</span>.class, <span class="literal">NULL</span>, <span class="type">xxx_dev_t</span>.devid, <span class="literal">NULL</span>, xxx_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="type">xxx_dev_t</span>.device))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="type">xxx_dev_t</span>.device);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_spi_driver_remove</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// 1.æ³¨é”€è®¾å¤‡å·</span></span><br><span class="line">unregister_chrdev_region(<span class="type">xxx_dev_t</span>.devid, <span class="number">1</span>);</span><br><span class="line"><span class="comment">// 2.åˆ é™¤è®¾å¤‡</span></span><br><span class="line">cdev_del(&amp;<span class="type">xxx_dev_t</span>.cdev);</span><br><span class="line"><span class="comment">// 3.æ³¨é”€è®¾å¤‡èŠ‚ç‚¹</span></span><br><span class="line">device_destroy(<span class="type">xxx_dev_t</span>.class, <span class="type">xxx_dev_t</span>.devid);</span><br><span class="line"><span class="comment">// 4.åˆ é™¤ç±»</span></span><br><span class="line">class_destroy(<span class="type">xxx_dev_t</span>.class);</span><br><span class="line">printk(<span class="string">&quot;xxx_spi_driver_remove ok\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="i2c-è®¾å¤‡çš„æ•°æ®æ”¶å‘å’Œå¤„ç†">I2C è®¾å¤‡çš„æ•°æ®æ”¶å‘å’Œå¤„ç†</h4><p>å®šä¹‰ä¸€ä¸ª <code>xxx_dev</code> ç»“æ„ä½“ç”¨æ¥å­˜æ”¾ä¸€äº›åˆ›å»ºè®¾å¤‡éœ€è¦çš„å˜é‡å’Œè·å–åˆ°çš„ä¿¡æ¯ï¼Œè¯»å–å’Œå†™å…¥å‡½æ•°ä¸»è¦æ˜¯å¡«å…… <code>i2c_msg</code> ç»“æ„ä½“ï¼Œç„¶åä½¿ç”¨ <code>i2c_transfer</code> å‡½æ•°ä¼ è¾“æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xxx_dev</span> &#123;</span></span><br><span class="line">    <span class="comment">/* è®¾å¤‡å·è¿™äº›æ·»åŠ è¿›æ¥æ˜¯ä¸ºäº†æ–¹ä¾¿ç®¡ç† */</span></span><br><span class="line"><span class="type">dev_t</span> devid;<span class="comment">/* è®¾å¤‡å· */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span><span class="comment">/* cdev  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span><span class="comment">/* ç±» */</span> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span><span class="comment">/* è®¾å¤‡ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">nd</span>;</span><span class="comment">/* è®¾å¤‡èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="type">int</span> major;<span class="comment">/* ä¸»è®¾å¤‡å· */</span></span><br><span class="line"><span class="type">void</span> *private_data;<span class="comment">/* ç§æœ‰æ•°æ® ä¸€èˆ¬è½¬æ¢ä¸º struct i2c_client * */</span></span><br><span class="line"><span class="comment">/* æ•°æ® */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">xxx_dev</span> <span class="title">xxx_dev_t</span>;</span><span class="comment">// å®šä¹‰ç»“æ„ä½“</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : è¯»å–I2C è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : I2C è®¾å¤‡</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¯»å–åˆ°çš„æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦è¯»å–çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_read_reg</span><span class="params">(<span class="keyword">struct</span> xxx_dev *dev, <span class="type">uint8_t</span> reg, <span class="type">uint8_t</span> *val, <span class="type">uint16_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[2];</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* msg[0]ï¼Œç¬¬ä¸€æ¡å†™æ¶ˆæ¯ï¼Œå‘é€è¦è¯»å–çš„å¯„å­˜å™¨é¦–åœ°å€*/</span></span><br><span class="line">msg[<span class="number">0</span>].addr = client-&gt;addr;<span class="comment">// è®¾å¤‡åœ°å€</span></span><br><span class="line">msg[<span class="number">0</span>].flags = <span class="number">0</span>;<span class="comment">// å†™æ•°æ®</span></span><br><span class="line">msg[<span class="number">0</span>].buf = &amp;reg;<span class="comment">// å¯„å­˜å™¨åœ°å€</span></span><br><span class="line">msg[<span class="number">0</span>].len = <span class="number">1</span>;<span class="comment">// msgé•¿åº¦ï¼šå¯„å­˜å™¨åœ°å€é•¿åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* msg[1]ï¼Œç¬¬äºŒæ¡è¯»æ¶ˆæ¯ï¼Œè¯»å–å¯„å­˜å™¨æ•°æ®*/</span></span><br><span class="line">msg[<span class="number">1</span>].addr = client-&gt;addr;<span class="comment">// è®¾å¤‡åœ°å€</span></span><br><span class="line">msg[<span class="number">1</span>].flags = I2C_M_RD;<span class="comment">// è¯»æ•°æ®</span></span><br><span class="line">msg[<span class="number">1</span>].buf= data;<span class="comment">// è¯»å–çš„æ•°æ®</span></span><br><span class="line">msg[<span class="number">1</span>].len = len;<span class="comment">// msgé•¿åº¦ï¼šè¯»å–æ•°æ®çš„é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">ret =  i2c_transfer(client-&gt;adapter, msg, <span class="number">2</span>);<span class="comment">// 2ä¸ªmsg</span></span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">2</span>)</span><br><span class="line">ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = -EREMOTEIO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @description : å‘ I2C è®¾å¤‡å¤šä¸ªå¯„å­˜å™¨å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="comment">* @param â€“ dev : è¦å†™å…¥çš„è®¾å¤‡ç»“æ„ä½“</span></span><br><span class="line"><span class="comment">* @param â€“ reg : è¦å†™å…¥çš„å¯„å­˜å™¨é¦–åœ°å€</span></span><br><span class="line"><span class="comment">* @param â€“ val : è¦å†™å…¥çš„æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line"><span class="comment">* @param â€“ len : è¦å†™å…¥çš„æ•°æ®é•¿åº¦</span></span><br><span class="line"><span class="comment">* @return : æ“ä½œç»“æœ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">xxx_write_reg</span><span class="params">(<span class="keyword">struct</span> xxx_dev *dev, <span class="type">uint8_t</span> reg, <span class="type">uint8_t</span> *buf, <span class="type">uint16_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> tmp[<span class="number">256</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>;</span><span class="comment">// å­˜æ”¾å¾…å†™å…¥çš„å¯„å­˜å™¨åœ°å€å’Œæ•°æ®ç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *)dev-&gt;private_data;</span><br><span class="line"></span><br><span class="line">    tmp[<span class="number">0</span>] = reg;               <span class="comment">// å¯„å­˜å™¨åœ°å€</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;tmp[<span class="number">1</span>], buf, len); <span class="comment">// å†™å…¥çš„æ•°æ®</span></span><br><span class="line"></span><br><span class="line">msg.addr = client-&gt;addr;<span class="comment">// è®¾å¤‡åœ°å€</span></span><br><span class="line">msg.flags = <span class="number">0</span>;<span class="comment">// å†™æ•°æ®</span></span><br><span class="line">msg.buf = tmp;<span class="comment">// å‘é€çš„æ•°æ®ç¼“å†²åŒº</span></span><br><span class="line">msg.len = len + <span class="number">1</span>;<span class="comment">// msgé•¿åº¦ï¼šå†™å…¥çš„æ•°æ®é•¿åº¦ + å¯„å­˜å™¨åœ°å€é•¿åº¦ ï¼ˆå•ä½ï¼šå­—èŠ‚)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> i2c_transfer(client-&gt;adapter, &amp;msg, <span class="number">1</span>);<span class="comment">// 1ä¸ªmsg</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="i2c-tools">i2c-tools</h2><p>i2c-tools æ˜¯ä¸€ä¸ªä¸“é—¨è°ƒè¯• i2c çš„å¼€æºå·¥å…·ï¼Œå¯ä»¥è·å–æŒ‚è½½çš„è®¾å¤‡åŠè®¾å¤‡åœ°å€ï¼Œè¿˜å¯ä»¥è¯»å†™ I2C è®¾å¤‡å¯„å­˜å™¨ã€‚</p><p>åœ¨è°ƒè¯•æ–°çš„ I2C è®¾å¤‡é©±åŠ¨æ—¶ï¼Œéœ€è¦å¤šæ¬¡ä¿®æ”¹å¯„å­˜å™¨çœ‹ç»“æœç°è±¡ï¼Œæ­£å¸¸åšæ³•æ˜¯ä¿®æ”¹é©±åŠ¨ä»£ç å¯„å­˜å™¨å€¼â€”â€”ç¼–è¯‘çƒ§å½•â€”â€”è¿è¡Œçœ‹ç»“æœï¼Œè´¹æ—¶è´¹åŠ›ï¼Œä½¿ç”¨ i2c-tools å¯ä»¥çœå»å¾ˆå¤šæ—¶é—´ã€‚</p><blockquote><p>i2c-tools å®˜æ–¹è¯´æ˜ï¼š<a href="https://archive.kernel.org/oldwiki/i2c.wiki.kernel.org/index.php/I2C_Tools.html">I2C Tools - Linux i2c Wiki (kernel.org)</a></p></blockquote><p>i2c-tools æ˜¯é€šè¿‡æ“ä½œ /dev è·¯å¾„ i2c-Ã— è®¾å¤‡æ–‡ä»¶å®Œæˆï¼Œå› æ­¤ä½ çš„ kernel å¿…é¡»å¼€å¯ CONFIG_I2C_CHARDEV å®æ§ï¼Œå¦è€…ä¼šæŠ¥æ‰¾ä¸åˆ°èŠ‚ç‚¹ã€‚</p><p>æ£€æµ‹å¼€å‘æ¿æ˜¯å¦æœ‰ i2c-tools å·¥å…·ï¼Œæ£€æµ‹ç›¸åº”å·¥å…·æ˜¯å¦å­˜åœ¨å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2cdetect -V</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™éœ€è¦äº¤å‰å·¥å…·é“¾è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Œç¼–è¯‘ç”Ÿæˆäº”ä¸ªå·¥å…·ï¼ši2cdetectã€i2csetã€i2cgetã€i2cdumpã€i2ctransferï¼Œæ‹·è´åˆ°å¼€å‘æ¿ä¸­å°±å¯ä»¥ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŠŠ i2c-tools æºç åŒ…æ”¾åˆ°è‡ªå·±çš„æºç ä¸­ï¼Œç›´æ¥ç¼–è¯‘è¿›å›ºä»¶ã€‚</p><ul><li>i2cdetectï¼šç”¨äºæ‰«æ i2c æ€»çº¿ä¸Šçš„è®¾å¤‡ï¼Œå¹¶æ˜¾ç¤ºåœ°å€</li><li>i2csetï¼šè®¾ç½® i2c è®¾å¤‡æŸä¸ªå¯„å­˜å™¨çš„å€¼</li><li>i2cgetï¼šè¯»å– i2c è®¾å¤‡æŸä¸ªå¯„å­˜å™¨çš„å€¼</li><li>i2cdumpï¼šè¯»å–æŸä¸ª i2c è®¾å¤‡æ‰€æœ‰å¯„å­˜å™¨çš„å€¼</li><li>i2ctransferï¼šä¸€æ¬¡æ€§è¯»å†™å¤šä¸ªå­—èŠ‚</li></ul><p>æŸ¥çœ‹å·²ç»æŒ‚è½½çš„ i2c è®¾å¤‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@100ask:~]# ls /sys/bus/i2c/devices/</span><br><span class="line">1-001a  1-0039  1-005d  i2c-0  i2c-1</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹</h3><h4 id="i2cdetect">i2cdetect</h4><p>i2cdetect ç”¨äºæ‰«æ i2c æ€»çº¿ä¸Šçš„è®¾å¤‡ï¼Œå¹¶æ˜¾ç¤ºåœ°å€ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Usage: i2cdetect [-y] [-a] [-q|-r] I2CBUS [FIRST LAST]</span><br><span class="line">       i2cdetect -F I2CBUS</span><br><span class="line">       i2cdetect -l</span><br><span class="line">  I2CBUS is an integer or an I2C bus name</span><br><span class="line">  If provided, FIRST and LAST limit the probing range.</span><br><span class="line"></span><br><span class="line">I2CBUSï¼šæŒ‡å®šè¦æ‰«æçš„I2Cæ€»çº¿ç¼–å·æˆ–è€…æ€»çº¿åç§°ã€‚</span><br><span class="line">-yï¼šåœ¨æ£€æµ‹åˆ°è®¾å¤‡æ—¶è‡ªåŠ¨ç¡®è®¤ï¼Œä¸æç¤ºç”¨æˆ·è¾“å…¥ã€‚</span><br><span class="line">-aï¼šæ‰«ææ•´ä¸ªI2Cæ€»çº¿åœ°å€ç©ºé—´ï¼ŒåŒ…æ‹¬æ‰©å±•çš„åœ°å€ï¼ˆ7ä½åœ°å€ï¼‰ã€‚</span><br><span class="line">-q æˆ– -rï¼šä½¿ç”¨å¿«é€Ÿæˆ–æ…¢é€Ÿæ‰«ææ¨¡å¼ã€‚å¿«é€Ÿæ¨¡å¼ï¼ˆ-qï¼‰ä¼šæ›´å¿«åœ°æ‰«æåœ°å€ç©ºé—´ï¼Œä½†å¯èƒ½æ¼æ‰ä¸€äº›æ…¢å“åº”çš„è®¾å¤‡ã€‚æ…¢é€Ÿæ¨¡å¼ï¼ˆ-rï¼‰ä¼šç­‰å¾…æ›´é•¿çš„æ—¶é—´æ¥æ£€æµ‹æ¯ä¸ªåœ°å€ï¼Œç¡®ä¿æ£€æµ‹åˆ°æ‰€æœ‰è®¾å¤‡ã€‚</span><br><span class="line">-Fï¼šå½“ä¸ I2CBUS ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œi2cdetect å°†å°è¯•æ£€æµ‹æ€»çº¿ä¸Šçš„æ¯ä¸ªè®¾å¤‡çš„åŠŸèƒ½æ€§ã€‚</span><br><span class="line">-lï¼šåˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„I2Cæ€»çº¿ã€‚</span><br><span class="line">FIRST LASTï¼šæ‰«æçš„åœ°å€èŒƒå›´</span><br></pre></td></tr></table></figure><p><code>i2cdetect -l</code> æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„ i2c æ€»çº¿ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">100</span>ask:~]# i2cdetect -l</span><br><span class="line">i2c<span class="number">-1</span>   i2c             <span class="number">21</span>a4000.i2c                             I2C adapter</span><br><span class="line">i2c<span class="number">-0</span>   i2c             <span class="number">21</span>a0000.i2c                             I2C adapter</span><br></pre></td></tr></table></figure><p><code>i2cdetect -y 0</code> æ˜¾ç¤ºæŒ‡å®š i2c æ€»çº¿æŒ‚è½½è®¾å¤‡çš„æƒ…å†µï¼š</p><p><img src="/image-20240628120005177.png" alt="image-20240628120005177"></p><p>â€“ è¡¨ç¤ºè¯¥åœ°å€è¢«æ£€æµ‹ï¼Œä½†æ˜¯æ— è®¾å¤‡åº”ç­”ï¼ŒUU è¡¨ç¤ºè¯¥åœ°å€è¢«å½“å‰å†…æ ¸é©±åŠ¨ä½¿ç”¨ï¼Œç”±ä¸Šå›¾å¯çŸ¥ i2c-1 æ€»çº¿å½“å‰æœ‰ä¸‰ä¸ªè¢«å†…æ ¸é©±åŠ¨ä½¿ç”¨çš„è®¾å¤‡ï¼Œè®¾å¤‡åœ°å€ä¸ºï¼š0x1aã€0x39ã€0x5dã€‚å¦å¤–è¿˜æ˜¾ç¤ºäº†ä¸¤ä¸ªè®¾å¤‡çš„å…·ä½“åœ°å€ï¼Œè¡¨ç¤ºç¡¬ä»¶ä¸Šè¿æ¥äº† i2c æ€»çº¿ï¼Œåªæ˜¯æ²¡æœ‰è¢«å†…æ ¸é©±åŠ¨ä½¿ç”¨ã€‚</p><h4 id="i2cset">i2cset</h4><p>i2csetï¼šè®¾ç½® i2c è®¾å¤‡æŸä¸ªå¯„å­˜å™¨çš„å€¼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Usage: i2cset [-f] [-y] [-m MASK] [-r] [-a] I2CBUS CHIP-ADDRESS DATA-ADDRESS [VALUE] ... [MODE]</span><br><span class="line">  I2CBUS is an integer or an I2C bus name</span><br><span class="line">  ADDRESS is an integer (0x03 - 0x77, or 0x00 - 0x7f if -a is given)</span><br><span class="line">  MODE is one of:</span><br><span class="line">    c (byte, no value)</span><br><span class="line">    b (byte data, default)</span><br><span class="line">    w (word data)</span><br><span class="line">    i (I2C block data)</span><br><span class="line">    s (SMBus block data)</span><br><span class="line">    Append p for SMBus PEC</span><br><span class="line">    </span><br><span class="line">-fï¼šå¼ºåˆ¶æ‰§è¡Œï¼Œå³ä½¿åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸å®‰å…¨ã€‚</span><br><span class="line">-yï¼šè‡ªåŠ¨åº”ç­”ï¼Œä¸æç¤ºç”¨æˆ·ç¡®è®¤ã€‚</span><br><span class="line">-m MASKï¼šå¯¹æ•°æ®åº”ç”¨æ©ç ã€‚åªæœ‰æ©ç ä¸­ä¸º1çš„ä½ä¼šè¢«å†™å…¥ï¼Œå…¶ä½™ä½ä¿æŒä¸å˜ã€‚</span><br><span class="line">-rï¼šå¦‚æœè®¾ç½®äº†ï¼Œå¹¶ä¸”æŒ‡å®šäº†æ¨¡å¼ cï¼ˆå³æ— å€¼çš„å­—èŠ‚å‘½ä»¤ï¼‰ï¼Œåˆ™åœ¨å†™å…¥å‘½ä»¤åç«‹å³è¯»å–ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚</span><br><span class="line">-aï¼šå…è®¸10ä½åœ°å€çš„è®¾å¤‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œi2cset åªå¤„ç†7ä½åœ°å€çš„è®¾å¤‡ã€‚</span><br><span class="line">I2CBUSï¼šæŒ‡å®šI2Cæ€»çº¿çš„ç¼–å·æˆ–åç§°ã€‚</span><br><span class="line">CHIP-ADDRESSï¼ši2cè®¾å¤‡åœ°å€ã€‚</span><br><span class="line">DATA-ADDRESSï¼ši2cå¯„å­˜å™¨åœ°å€</span><br><span class="line">VALUEï¼šè¦å†™å…¥çš„æ•°æ®å€¼ã€‚å…·ä½“éœ€è¦æ ¹æ®åé¢æŒ‡å®šçš„ MODE æ¥ç¡®å®šæ•°æ®æ ¼å¼ã€‚</span><br><span class="line">MODEï¼šæŒ‡å®šæ•°æ®ä¼ è¾“çš„æ¨¡å¼ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹å‡ ç§ä¹‹ä¸€ï¼š</span><br><span class="line">    cï¼šå‘é€ä¸€ä¸ªæ— æ•°æ®çš„å­—èŠ‚å‘½ä»¤ã€‚</span><br><span class="line">    bï¼šå‘é€ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰ã€‚</span><br><span class="line">    wï¼šå‘é€ä¸€ä¸ªå­—ï¼ˆ16ä½ï¼‰çš„æ•°æ®ã€‚</span><br><span class="line">    iï¼šå‘é€I2Cå—æ•°æ®ã€‚</span><br><span class="line">    sï¼šå‘é€SMBuså—æ•°æ®ã€‚</span><br></pre></td></tr></table></figure><p>è®¾ç½® i2c-0 æ€»çº¿ä¸Š 0x1E è®¾å¤‡çš„ 0x00 å¯„å­˜å™¨å€¼ä¸º 0x03ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2cset -f -y 0 0x1e 0x00 0x03</span><br></pre></td></tr></table></figure><h4 id="i2cget">i2cget</h4><p>i2cgetï¼šè¯»å– i2c è®¾å¤‡æŸä¸ªå¯„å­˜å™¨çš„å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Usage: i2cget [-f] [-y] [-a] I2CBUS CHIP-ADDRESS [DATA-ADDRESS [MODE]]</span><br><span class="line">  I2CBUS is an integer or an I2C bus name</span><br><span class="line">  ADDRESS is an integer (0x03 - 0x77, or 0x00 - 0x7f if -a is given)</span><br><span class="line">  MODE is one of:</span><br><span class="line">    b (read byte data, default)</span><br><span class="line">    w (read word data)</span><br><span class="line">    c (write byte/read byte)</span><br><span class="line">    Append p for SMBus PEC</span><br><span class="line">-fï¼šå¼ºåˆ¶æ‰§è¡Œï¼Œå³ä½¿åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¸å®‰å…¨ã€‚</span><br><span class="line">-yï¼šè‡ªåŠ¨åº”ç­”ï¼Œä¸æç¤ºç”¨æˆ·ç¡®è®¤ã€‚</span><br><span class="line">-aï¼šå…è®¸10ä½åœ°å€çš„è®¾å¤‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œi2cset åªå¤„ç†7ä½åœ°å€çš„è®¾å¤‡ã€‚</span><br><span class="line">I2CBUSï¼šæŒ‡å®šI2Cæ€»çº¿çš„ç¼–å·æˆ–åç§°ã€‚</span><br><span class="line">CHIP-ADDRESSï¼ši2cè®¾å¤‡åœ°å€ã€‚</span><br><span class="line">DATA-ADDRESSï¼ši2cå¯„å­˜å™¨åœ°å€</span><br><span class="line">MODEï¼šæŒ‡å®šæ•°æ®ä¼ è¾“çš„æ¨¡å¼ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹å‡ ç§ä¹‹ä¸€ï¼š</span><br><span class="line">    cï¼šå‘é€ä¸€ä¸ªæ— æ•°æ®çš„å­—èŠ‚å‘½ä»¤ã€‚</span><br><span class="line">    bï¼šå‘é€ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰ã€‚</span><br><span class="line">    wï¼šå‘é€ä¸€ä¸ªå­—ï¼ˆ16ä½ï¼‰çš„æ•°æ®ã€‚</span><br><span class="line">    iï¼šå‘é€I2Cå—æ•°æ®ã€‚</span><br><span class="line">    sï¼šå‘é€SMBuså—æ•°æ®ã€‚</span><br></pre></td></tr></table></figure><p>è·å– i2c-0 æ€»çº¿ä¸Š 0x1E è®¾å¤‡çš„ 0x00 å¯„å­˜å™¨çš„å€¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2cget -f -y 0 0x1e 0x00</span><br></pre></td></tr></table></figure><h4 id="i2cdump">i2cdump</h4><p>i2cdumpï¼šè¯»å–æŸä¸ª i2c è®¾å¤‡æ‰€æœ‰å¯„å­˜å™¨çš„å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Usage: i2cdump [-f] [-y] [-r first-last] [-a] I2CBUS ADDRESS [MODE [BANK [BANKREG]]]</span><br><span class="line">  I2CBUS is an integer or an I2C bus name</span><br><span class="line">  ADDRESS is an integer (0x03 - 0x77, or 0x00 - 0x7f if -a is given)</span><br><span class="line">  MODE is one of:</span><br><span class="line">    b (byte, default)</span><br><span class="line">    w (word)</span><br><span class="line">    W (word on even register addresses)</span><br><span class="line">    s (SMBus block)</span><br><span class="line">    i (I2C block)</span><br><span class="line">    c (consecutive byte)</span><br><span class="line">    Append p for SMBus PEC</span><br><span class="line">-fï¼šå¼ºåˆ¶æ‰§è¡Œï¼Œå³ä½¿å¯èƒ½å­˜åœ¨é£é™©çš„æ“ä½œä¹Ÿä¼šæ‰§è¡Œã€‚</span><br><span class="line">-yï¼šè‡ªåŠ¨åº”ç­”ï¼Œä¸æç¤ºç”¨æˆ·ç¡®è®¤ã€‚</span><br><span class="line">-r first-lastï¼šæŒ‡å®šè¦è¯»å–çš„å¯„å­˜å™¨åœ°å€èŒƒå›´ã€‚first æ˜¯èµ·å§‹åœ°å€ï¼Œlast æ˜¯ç»“æŸåœ°å€ã€‚</span><br><span class="line">-aï¼šå…è®¸ä½¿ç”¨10ä½åœ°å€çš„è®¾å¤‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œi2cdump åªå¤„ç†7ä½åœ°å€çš„è®¾å¤‡ã€‚</span><br><span class="line">I2CBUSï¼šæŒ‡å®šè¦è¯»å–çš„I2Cæ€»çº¿çš„ç¼–å·æˆ–åç§°ã€‚</span><br><span class="line">ADDRESSï¼ši2cè®¾å¤‡åœ°å€</span><br><span class="line">MODEï¼šæŒ‡å®šè¯»å–æ•°æ®çš„æ¨¡å¼ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹å‡ ç§ä¹‹ä¸€ï¼š</span><br><span class="line">    bï¼šæŒ‰å­—èŠ‚è¯»å–ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰ã€‚</span><br><span class="line">    wï¼šæŒ‰å­—ï¼ˆ16ä½ï¼‰è¯»å–ã€‚</span><br><span class="line">    Wï¼šæŒ‰å­—ï¼ˆ16ä½ï¼‰è¯»å–ï¼Œä½†åªåœ¨å¶æ•°å¯„å­˜å™¨åœ°å€ä¸Šè¯»å–ã€‚</span><br><span class="line">    sï¼šSMBuså—æ•°æ®è¯»å–ã€‚</span><br><span class="line">    iï¼šI2Cå—æ•°æ®è¯»å–ã€‚</span><br><span class="line">    cï¼šè¿ç»­å­—èŠ‚è¯»å–ã€‚</span><br><span class="line">BANKï¼šå¯¹äºéœ€è¦åˆ‡æ¢å¯„å­˜å™¨é“¶è¡Œçš„è®¾å¤‡ï¼ŒæŒ‡å®šè¦è¯»å–çš„å¯„å­˜å™¨é“¶è¡Œã€‚</span><br><span class="line">BANKREGï¼šå¯„å­˜å™¨é“¶è¡Œåˆ‡æ¢å¯„å­˜å™¨çš„åœ°å€ã€‚</span><br><span class="line">PECï¼šå¦‚æœæ¨¡å¼ä»¥ p ç»“å°¾ï¼Œè¡¨ç¤ºå¯ç”¨SMBusæ•°æ®åŒ…é”™è¯¯æ ¡æ­£ï¼ˆPECï¼‰ã€‚</span><br></pre></td></tr></table></figure><p>è·å– i2c-0 æ€»çº¿ä¸Š 0x1E è®¾å¤‡æ‰€æœ‰å¯„å­˜å™¨çš„å€¼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2cdump -f -y 0 0x1e</span><br></pre></td></tr></table></figure><h4 id="i2ctransfer">i2ctransfer</h4><p>i2ctransferï¼šä¸€æ¬¡æ€§è¯»å†™å¤šä¸ªå­—èŠ‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Usage: i2ctransfer [-f] [-y] [-v] [-V] [-a] I2CBUS DESC [DATA] [DESC [DATA]]...</span><br><span class="line">  I2CBUS is an integer or an I2C bus name</span><br><span class="line">  DESC describes the transfer in the form: &#123;r|w&#125;LENGTH[@address]</span><br><span class="line">    1) read/write-flag 2) LENGTH (range 0-65535) 3) I2C address (use last one if omitted)</span><br><span class="line">  DATA are LENGTH bytes for a write message. They can be shortened by a suffix:</span><br><span class="line">    = (keep value constant until LENGTH)</span><br><span class="line">    + (increase value by 1 until LENGTH)</span><br><span class="line">    - (decrease value by 1 until LENGTH)</span><br><span class="line">    p (use pseudo random generator until LENGTH with value as seed)</span><br><span class="line"></span><br><span class="line">Example (bus 0, read 8 byte at offset 0x64 from EEPROM at 0x50):</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">i2ctransfer 0 w1@0x50 0x64 r8</span></span><br><span class="line">Example (same EEPROM, at offset 0x42 write 0xff 0xfe ... 0xf0):</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">i2ctransfer 0 w17@0x50 0x42 0xff-</span></span><br><span class="line"></span><br><span class="line">-fï¼šå¼ºåˆ¶æ‰§è¡Œï¼Œç”¨äºè¦†ç›–æŸäº›å®‰å…¨é™åˆ¶ã€‚</span><br><span class="line">-yï¼šè‡ªåŠ¨åº”ç­”ï¼Œä¸æç¤ºç”¨æˆ·ç¡®è®¤ã€‚</span><br><span class="line">-vï¼šå¢åŠ è¾“å‡ºçš„è¯¦ç»†ç¨‹åº¦ï¼Œæ˜¾ç¤ºæ›´å¤šçš„ä¿¡æ¯ã€‚</span><br><span class="line">-Vï¼šæ˜¾ç¤ºç¨‹åºç‰ˆæœ¬ä¿¡æ¯ã€‚</span><br><span class="line">-aï¼šå…è®¸ä½¿ç”¨10ä½åœ°å€çš„è®¾å¤‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œi2ctransfer åªå¤„ç†7ä½åœ°å€çš„è®¾å¤‡ã€‚</span><br><span class="line">I2CBUSï¼šæŒ‡å®šI2Cæ€»çº¿çš„ç¼–å·æˆ–åç§°ã€‚</span><br><span class="line">DESCï¼šæè¿°ä¼ è¾“æ“ä½œï¼Œæ ¼å¼ä¸º &#123;r|w&#125;LENGTH[@address]ï¼Œå…¶ä¸­ï¼š</span><br><span class="line">r è¡¨ç¤ºè¯»å–æ•°æ®ã€‚</span><br><span class="line">w è¡¨ç¤ºå†™å…¥æ•°æ®ã€‚</span><br><span class="line">LENGTH æ˜¯è¦ä¼ è¾“çš„æ•°æ®é•¿åº¦ï¼ŒèŒƒå›´ä»0åˆ°65535ã€‚</span><br><span class="line">@address æ˜¯I2Cè®¾å¤‡çš„å¯„å­˜å™¨åœ°å€ï¼Œå¦‚æœçœç•¥ï¼Œå°†ä½¿ç”¨ä¸Šä¸€ä¸ªæ“ä½œçš„åœ°å€ã€‚</span><br><span class="line">DATAï¼šå¯¹äºå†™æ“ä½œï¼ŒDATA æ˜¯è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯ä¸€ç³»åˆ—çš„å­—èŠ‚ã€å­—æˆ–å—æ•°æ®ã€‚æ•°æ®å¯ä»¥é€šè¿‡åç¼€è¿›ä¸€æ­¥å®šä¹‰æ¨¡å¼ï¼š</span><br><span class="line">= è¡¨ç¤ºä¿æŒå½“å‰å€¼ä¸å˜ï¼Œç›´åˆ°è¾¾åˆ° LENGTHã€‚</span><br><span class="line">+ è¡¨ç¤ºä»å½“å‰å€¼å¼€å§‹é€’å¢ï¼Œç›´åˆ°è¾¾åˆ° LENGTHã€‚</span><br><span class="line">- è¡¨ç¤ºä»å½“å‰å€¼å¼€å§‹é€’å‡ï¼Œç›´åˆ°è¾¾åˆ° LENGTHã€‚</span><br><span class="line">p è¡¨ç¤ºä½¿ç”¨ä¼ªéšæœºç”Ÿæˆå™¨ï¼Œä½¿ç”¨å½“å‰å€¼ä½œä¸ºç§å­ï¼Œç›´åˆ°è¾¾åˆ° LENGTHã€‚</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2><blockquote><p><a href="https://blog.csdn.net/qq_45172832/article/details/131221971">https://blog.csdn.net/qq_45172832/article/details/131221971</a></p><p><a href="https://www.51cto.com/article/706269.html">æ‰‹æŠŠæ‰‹æ•™ä½ ä½¿ç”¨ i2c-tools-i2c-toolsä½¿ç”¨ (51cto.com)</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;linux-i2c-é©±åŠ¨&quot;&gt;Linux-I2C é©±åŠ¨&lt;/h1&gt;
&lt;h2 id=&quot;åºè¨€&quot;&gt;åºè¨€&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;I2C å…·ä½“é€šä¿¡åè®®æœ¬æ–‡ä¸æ¶‰åŠï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»åœ¨ Linux ä¸­ I2C çš„é©±åŠ¨æ¡†æ¶ã€‚&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;I</summary>
      
    
    
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
    <category term="Linux" scheme="http://www.obito.top/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/Linux/"/>
    
    
    <category term="Linux" scheme="http://www.obito.top/tags/Linux/"/>
    
    <category term="åµŒå…¥å¼" scheme="http://www.obito.top/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
  </entry>
  
</feed>
