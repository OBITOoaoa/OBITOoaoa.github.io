<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>U-Boot知识扫盲 | Obito Blog</title><meta name="author" content="Obito"><meta name="copyright" content="Obito"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="U-Boot知识扫盲 序言 U-Boot 是什么 BootLoader 是引导加载程序，uboot 是其中较为常用的一个， uboot 就是一个裸机程序，一般用为初始化硬件设备为启动系统做准备，一般主要工作是初始化 DDR，但是 IMX6ULL 的 DDR 不是在 uboot 实现的。 U-Boot 源码目录解析 分析前需要先编译 uboot 源码，才会生成一些文件，源码会有许多目录，一般我们只需">
<meta property="og:type" content="article">
<meta property="og:title" content="U-Boot知识扫盲">
<meta property="og:url" content="http://www.obito.top/2024/07/29/U-Boot%E7%9F%A5%E8%AF%86%E6%89%AB%E7%9B%B2/index.html">
<meta property="og:site_name" content="Obito Blog">
<meta property="og:description" content="U-Boot知识扫盲 序言 U-Boot 是什么 BootLoader 是引导加载程序，uboot 是其中较为常用的一个， uboot 就是一个裸机程序，一般用为初始化硬件设备为启动系统做准备，一般主要工作是初始化 DDR，但是 IMX6ULL 的 DDR 不是在 uboot 实现的。 U-Boot 源码目录解析 分析前需要先编译 uboot 源码，才会生成一些文件，源码会有许多目录，一般我们只需">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.obito.top/img/background.jpg">
<meta property="article:published_time" content="2024-07-29T05:57:40.000Z">
<meta property="article:modified_time" content="2025-08-05T15:23:54.071Z">
<meta property="article:author" content="Obito">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.obito.top/img/background.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.obito.top/2024/07/29/U-Boot%E7%9F%A5%E8%AF%86%E6%89%AB%E7%9B%B2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":60,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.min.js',
      css: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'U-Boot知识扫盲',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-05 23:23:54'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/rightmenu.css"><span id="fps"></span><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Obito Blog" type="application/atom+xml">
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='null'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">49</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/notes/"><i class="fa-fw fa fa-sticky-note"></i><span> Notes</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i><span> About</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about-me/"><i class="fa-fw fa-fw fas fa-medal"></i><span> AboutMe</span></a></li><li><a class="site-page child" href="/about-website/"><i class="fa-fw fa-fw fas fa-envelope-open-text"></i><span> Statement</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/background.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Obito Blog"><span class="site-name">Obito Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/notes/"><i class="fa-fw fa fa-sticky-note"></i><span> Notes</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i><span> About</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about-me/"><i class="fa-fw fa-fw fas fa-medal"></i><span> AboutMe</span></a></li><li><a class="site-page child" href="/about-website/"><i class="fa-fw fa-fw fas fa-envelope-open-text"></i><span> Statement</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">U-Boot知识扫盲</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-29T05:57:40.000Z" title="发表于 2024-07-29 13:57:40">2024-07-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-05T15:23:54.071Z" title="更新于 2025-08-05 23:23:54">2025-08-05</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>67分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="U-Boot知识扫盲"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="u-boot知识扫盲">U-Boot知识扫盲</h1>
<h2 id="序言">序言</h2>
<h2 id="u-boot-是什么">U-Boot 是什么</h2>
<p>BootLoader 是引导加载程序，uboot 是其中较为常用的一个， uboot 就是一个裸机程序，一般用为初始化硬件设备为启动系统做准备，一般主要工作是初始化 DDR，但是 IMX6ULL 的 DDR 不是在 uboot 实现的。</p>
<h2 id="u-boot-源码目录解析">U-Boot 源码目录解析</h2>
<p>分析前需要先编译 uboot 源码，才会生成一些文件，源码会有许多目录，一般我们只需要重点关注一下目录即可：</p>
<ul>
<li>
<p><code>arch/</code>：存放一些与架构相关的文件。</p>
</li>
<li>
<p><code>board/</code>：board 目录是与具体的板子相关的，我们关注下面的 freescale 目录即可。</p>
</li>
<li>
<p><code>configs/</code>：uboot 配置文件以 <code>defconfig</code> 结尾，不同板子对应不同配置文件，我们在编译 uboot 之前都是先输入命令 <code>make xxx_defconfig</code> 命令进行配置 uboot。</p>
</li>
<li>
<p>顶层目录下有 <code>README</code> 文件，该文件描述了 uboot 的详细信息和如何编译 uboot、uboot 中各目录的含义、相应的命令等。</p>
</li>
<li>
<p>arch/arm/cpu/u-boot.lds 是整个 uboot 的连接脚本</p>
</li>
<li>
<p>board/freescale/mx6ullevk</p>
</li>
<li>
<p>configs 目录是 uboot 的默认配置文件目录，文件以 defconfig 结尾，不同的配置文件对应不同的板子。</p>
</li>
</ul>
<p>所有使用 freescale 芯片的板子都放到此文件夹（<code>board/freescale</code>）中，<a target="_blank" rel="noopener" href="http://I.MX">I.MX</a> 系列以前属于 freescale，只是 freescale 后来被 NXP 收购了。</p>
<h2 id="u-boot-顶层-makefile-分析">U-Boot 顶层 Makefile 分析</h2>
<p>分析 uboot 源码顶层目录 Makefile 文件可以快速理清 uboot 编译流程。使用 VSCode 进行分析，因为 uboot 源码目录下兼容了许多架构和板子，但是我们这里只关注 IMX6ULL 相应的目录即可，所以可以<strong>使用 VSCode 对一些无关的目录进行屏蔽（不是删除）</strong>。</p>
<p>新建 <code>.vscode</code> 目录添加 <code>settings.json</code> 文件按需添加内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;search.exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="attr">&quot;**/node_modules&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;**/bower_components&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/*.o&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/*.su&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/*.cmd&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arc&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/avr32&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/blackfin&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/m68k&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/microblaze&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/mips&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/nds32&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/nios2&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/openrisc&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/powerpc&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/sandbox&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/sh&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/sparc&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/x86&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/mach*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/arm11*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/arm720t&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/arm9*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/armv7m&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/armv8&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/pxa&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/sa1100&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/[a-e]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/[g-z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/[0-9]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/[A-Z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/fir*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/b*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/l*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/m5*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mp*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/c29*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/cor*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx7*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx2*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx3*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx5*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/p*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/q*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/t*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/v*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/imx8*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx6d*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx6q*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx6s*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mult*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/s32*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx6ul_*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/[a-l]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/[n-z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/[A-Z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/M[a-z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/M[A-Z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/M[0-9]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/m[a-w]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/m[0-9]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/[0-9]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx6c*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx6d*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx6q*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx6s*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx7*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx8*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx23*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx25*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx28*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx31*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx35*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx51*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx53*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>        </span><br><span class="line">        <span class="attr">&quot;configs/mx6ul_*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;include/configs/[a-l]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;include/configs/[n-z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;include/configs/[A-Z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;include/configs/m[a-w]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;files.exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;**/.git&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/.svn&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/.hg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;**/CVS&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;**/.DS_Store&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/*.o&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/*.su&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;**/*.cmd&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arc&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/avr32&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/blackfin&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/m68k&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/microblaze&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/mips&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/nds32&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/nios2&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/openrisc&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/powerpc&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/sandbox&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/sh&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/sparc&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/x86&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/mach*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/arm11*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/arm720t&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/arm9*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/armv7m&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/armv8&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/pxa&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arch/arm/cpu/sa1100&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/[a-e]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/[g-z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/[0-9]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/[A-Z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/fir*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/b*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/l*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/m5*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mp*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/c29*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/cor*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx7*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx2*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx3*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx5*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/p*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/q*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/t*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/v*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/imx8*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx6d*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx6q*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx6s*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mult*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/s32*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;board/freescale/mx6ul_*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/[a-l]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/[n-z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/[A-Z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/M[a-z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/M[A-Z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/M[0-9]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/m[a-w]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/m[0-9]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/[0-9]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx6c*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx6d*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx6q*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx6s*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx7*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx8*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx23*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx25*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx28*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx31*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx35*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx51*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;configs/mx53*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>        </span><br><span class="line">        <span class="attr">&quot;configs/mx6ul_*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>        </span><br><span class="line">        <span class="attr">&quot;include/configs/[a-l]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;include/configs/[n-z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;include/configs/[A-Z]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;include/configs/m[a-w]*&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span>    </span><br></pre></td></tr></table></figure>
<p>其中 <code>search.exclude</code> 里面是需要在搜索结果中排除的文件或者文件夹，<code>files.exclude</code> 是左侧工程目录中需要排除的文件或者文件夹。</p>
<h3 id="一些重要的变量">一些重要的变量</h3>
<h4 id="版本号">版本号</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="makeflags">MAKEFLAGS</h4>
<h4 id="命令输出">命令输出</h4>
<h4 id="静默输出">静默输出</h4>
<h2 id="u-boot-启动流程">U-Boot 启动流程</h2>
<h3 id="重定位的相关知识">重定位的相关知识</h3>
<p>位置相关码、位置无关码、代码段(text 段)、数据段(data 段)、BSS 段。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/schips/p/12348703.html">uboot 与 代码重定位 - schips - 博客园 (cnblogs.com)</a></p>
</blockquote>
<h3 id="链接器和链接脚本">链接器和链接脚本</h3>
<p>我们知道源代码编译成可执行文件的步骤为：预处理、编译、汇编、链接。最后一步链接就是把一个或多个输入文件合并成一个输出文件，输入文件是目标文件或链接脚本文件，输出文件是目标文件或者可执行文件，这部分是由链接器执行的，负责从链接脚本读完一个 section 后，将定位器符号的值增加该 section 的大小。</p>
<p><strong>链接脚本：<strong>链接脚本的一个主要目的是</strong>描述输入文件中的各个段(数据段,代码段,堆,栈,bss)如何被映射到输出文件中,并控制输出文件的各部分在程序地址空间内的布局</strong>，地址空间包括 ROM 和 RAM。<br>
链接器总是使用链接脚本的，如果你不提供，则链接器会使用一个<strong>缺省的脚本</strong>，这个脚本是被编译进链接器可执行文件的。</p>
<h3 id="链接脚本-u-boot-lds">链接脚本 u-boot.lds</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Luckiers/article/details/127346876">链接脚本.lds（详细）总结附实例快速掌握-CSDN博客</a></p>
</blockquote>
<p>没有编译过 uboot 的话链接脚本为 <code>arch/arm/cpu/u-boot.lds</code>，编译之后就会在这个脚本基础上在根目录下生成最终的脚本文件 <code>u-boot.lds</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_FORMAT(<span class="string">&quot;elf32-littlearm&quot;</span><span class="punctuation">,</span> <span class="string">&quot;elf32-littlearm&quot;</span><span class="punctuation">,</span> <span class="string">&quot;elf32-littlearm&quot;</span>)</span><br><span class="line">OUTPUT_ARCH(arm)</span><br><span class="line">ENTRY(_start)</span><br><span class="line">SECTIONS</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> . = <span class="number">0x00000000</span>;</span><br><span class="line"> . = ALIGN(<span class="number">4</span>);</span><br><span class="line"> .text <span class="punctuation">:</span></span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.__image_copy_start)</span><br><span class="line">  *(.vectors)</span><br><span class="line">  arch/arm/cpu/armv7/start.o (.text*)</span><br><span class="line">  *(.text*)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> . = ALIGN(<span class="number">4</span>);</span><br><span class="line"> .rodata <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(SORT_BY_ALIGNMENT(SORT_BY_NAME(.rodata*))) <span class="punctuation">&#125;</span></span><br><span class="line"> . = ALIGN(<span class="number">4</span>);</span><br><span class="line"> .data <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.data*)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> . = ALIGN(<span class="number">4</span>);</span><br><span class="line"> . = .;</span><br><span class="line"> . = ALIGN(<span class="number">4</span>);</span><br><span class="line"> .u_boot_list <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  KEEP(*(SORT(.u_boot_list*)));</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> . = ALIGN(<span class="number">4</span>);</span><br><span class="line"> .__efi_runtime_start <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.__efi_runtime_start)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .efi_runtime <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  *(efi_runtime_text)</span><br><span class="line">  *(efi_runtime_data)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .__efi_runtime_stop <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.__efi_runtime_stop)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .efi_runtime_rel_start <span class="punctuation">:</span></span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.__efi_runtime_rel_start)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .efi_runtime_rel <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.relefi_runtime_text)</span><br><span class="line">  *(.relefi_runtime_data)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .efi_runtime_rel_stop <span class="punctuation">:</span></span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.__efi_runtime_rel_stop)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> . = ALIGN(<span class="number">8</span>);</span><br><span class="line"> .image_copy_end <span class="punctuation">:</span></span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.__image_copy_end)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .rel_dyn_start <span class="punctuation">:</span></span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.__rel_dyn_start)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .rel.dyn <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.rel*)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .rel_dyn_end <span class="punctuation">:</span></span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.__rel_dyn_end)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .end <span class="punctuation">:</span></span><br><span class="line"> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.__end)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> _image_binary_end = .;</span><br><span class="line"> . = ALIGN(<span class="number">4096</span>);</span><br><span class="line"> .mmutable <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.mmutable)</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .bss_start __rel_dyn_start (OVERLAY) <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  KEEP(*(.__bss_start));</span><br><span class="line">  __bss_base = .;</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .bss __bss_base (OVERLAY) <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  *(.bss*)</span><br><span class="line">   . = ALIGN(<span class="number">4</span>);</span><br><span class="line">   __bss_limit = .;</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .bss_end __bss_limit (OVERLAY) <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  KEEP(*(.__bss_end));</span><br><span class="line"> <span class="punctuation">&#125;</span></span><br><span class="line"> .dynsym _image_binary_end <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.dynsym) <span class="punctuation">&#125;</span></span><br><span class="line"> .dynbss <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.dynbss) <span class="punctuation">&#125;</span></span><br><span class="line"> .dynstr <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.dynstr*) <span class="punctuation">&#125;</span></span><br><span class="line"> .dynamic <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.dynamic*) <span class="punctuation">&#125;</span></span><br><span class="line"> .plt <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.plt*) <span class="punctuation">&#125;</span></span><br><span class="line"> .interp <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.interp*) <span class="punctuation">&#125;</span></span><br><span class="line"> .gnu.hash <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.gnu.hash) <span class="punctuation">&#125;</span></span><br><span class="line"> .gnu <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.gnu*) <span class="punctuation">&#125;</span></span><br><span class="line"> .ARM.exidx <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.ARM.exidx*) <span class="punctuation">&#125;</span></span><br><span class="line"> .gnu.linkonce.armexidx <span class="punctuation">:</span> <span class="punctuation">&#123;</span> *(.gnu.linkonce.armexidx.*) <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>u-boot.map</code> 是 uboot 的映射文件，这个文件可以看出各个文件或函数链接的地址。</p>
<p><code>u-boot.lds</code> 中有一些跟地址相关的重要变量，可以在 <code>u-boot.map</code> 中找到对应地址：</p>
<table>
<thead>
<tr>
<th style="text-align:center">变量</th>
<th style="text-align:center">数值</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">__image_copy_start</td>
<td style="text-align:center">0x87800000</td>
<td style="text-align:center">uboot 拷贝的首地址</td>
</tr>
<tr>
<td style="text-align:center">__image_copy_end</td>
<td style="text-align:center">0x8786ba30</td>
<td style="text-align:center">uboot 拷贝的结束地址</td>
</tr>
<tr>
<td style="text-align:center">__rel_dyn_start</td>
<td style="text-align:center">0x8786ba30</td>
<td style="text-align:center">.rel.dyn 段起始地址</td>
</tr>
<tr>
<td style="text-align:center">__rel_dyn_end</td>
<td style="text-align:center">0x87875f68</td>
<td style="text-align:center">.rel.dyn 段结束地址</td>
</tr>
<tr>
<td style="text-align:center">_image_binary_end</td>
<td style="text-align:center">0x87875f68</td>
<td style="text-align:center">镜像结束地址</td>
</tr>
<tr>
<td style="text-align:center">__bss_start</td>
<td style="text-align:center">0x8786ba30</td>
<td style="text-align:center">.bss 段起始地址</td>
</tr>
<tr>
<td style="text-align:center">__bss_end</td>
<td style="text-align:center">0x878a3930</td>
<td style="text-align:center">.bss 段结束地址</td>
</tr>
</tbody>
</table>
<p>其中只有 <code>__image_copy_start</code> 的地址是固定的 <code>0x87800000</code>，其余的变量会根据 uboot 的配置改变。</p>
<h3 id="u-boot-启动流程详解">U-Boot 启动流程详解</h3>
<p>从 <code>u-boot.lds</code> 中可以得知入口点是 <code>arch/arm/lib/vectors.S</code> 文件中的 <code>_start</code>，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> *************************************************************************</span><br><span class="line"> *</span><br><span class="line"> * Exception vectors as described in ARM reference manuals</span><br><span class="line"> *</span><br><span class="line"> * Uses indirect branch to allow reaching handlers anywhere in memory.</span><br><span class="line"> *</span><br><span class="line"> *************************************************************************</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_SYS_DV_NOR_BOOT_CFG</span><br><span class="line">	.word	CONFIG_SYS_DV_NOR_BOOT_CFG	/* .word表示四字节对齐 */</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	b	reset						/* 跳转到reset处，b为的无条件跳转 */</span><br><span class="line">	ldr	pc, _undefined_instruction	/* 未定义指令异常向量 */</span><br><span class="line">	ldr	pc, _software_interrupt		/* 预取指令异常向量 */</span><br><span class="line">	ldr	pc, _prefetch_abort			/* 预取指令异常向量 */</span><br><span class="line">	ldr	pc, _data_abort				/* 数据操作异常向量 */</span><br><span class="line">	ldr	pc, _not_used				/* 没有使用 */</span><br><span class="line">	ldr	pc, _irq					/* irq中断向量 */</span><br><span class="line">	ldr	pc, _fiq					/* fiq中断向量 */</span><br></pre></td></tr></table></figure>
<p>当 cpu 产生异常时，便会将对应的异常入口地址加载到 pc 中，进而处理相应的异常处理程序。 各个异常向量具体描述如下表格所示：</p>
<table>
<thead>
<tr>
<th>地址</th>
<th>异常</th>
<th>进入模式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00000000</td>
<td>复位</td>
<td>特权模式(SVC)</td>
<td>位电平有效时，产生复位异常，程序跳转到复位处理程序处执行</td>
</tr>
<tr>
<td>0x00000004</td>
<td>未定义指令</td>
<td>未定义指令中止模式(Undef)</td>
<td>遇到不能处理的指令时，产生未定义指令异</td>
</tr>
<tr>
<td>0x00000008</td>
<td>软件中断</td>
<td>特权模式(SVC)</td>
<td>执行 SWI 指令产生，用于用户模式下的程序调用特权操作指令</td>
</tr>
<tr>
<td>0x0000000c</td>
<td>预存指令</td>
<td>中止模式</td>
<td>处理器预取指令的地址不存在，或该地址不允许当前指令访问，产生指令预取中止异常</td>
</tr>
<tr>
<td>0x00000010</td>
<td>数据操作</td>
<td>中止模式</td>
<td>处理器数据访问指令的地址不存在，或该地址不允许当前指令访问时，产生数据中止异常</td>
</tr>
<tr>
<td>0x00000014</td>
<td>未使用</td>
<td>未使用</td>
<td>未使用</td>
</tr>
<tr>
<td>0x00000018</td>
<td>IRQ</td>
<td>外部中断模式(IRQ)</td>
<td>外部中断请求有效，且 CPSR 中的 I 位为 0时，产生 IRQ 异常</td>
</tr>
<tr>
<td>0x0000001c</td>
<td>FIQ</td>
<td>快速中断模式(FIQ)</td>
<td>快速中断请求引脚有效，且 CPSR 中的 F 位为 0 时，产生 FIQ 异常</td>
</tr>
</tbody>
</table>
<p>其中<strong>复位异常向量指令</strong> <code>b reset</code> 决定 uboot 启动或者复位后自动跳转到 reset 标志处执行，搜索可知 reset 在 <code>arch/arm/cpu/armv7/start.S</code> 文件中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/*************************************************************************</span><br><span class="line"> *</span><br><span class="line"> * Startup Code (reset vector)</span><br><span class="line"> *</span><br><span class="line"> * Do important init only if we don&#x27;t start from memory!</span><br><span class="line"> * Setup memory and board specific bits prior to relocation.</span><br><span class="line"> * Relocate armboot to ram. Setup stack.</span><br><span class="line"> *</span><br><span class="line"> *************************************************************************/</span><br><span class="line"></span><br><span class="line">	.globl	reset</span><br><span class="line">	.globl	save_boot_params_ret</span><br><span class="line">reset:</span><br><span class="line">	/* Allow the board to save important registers */</span><br><span class="line">	b	save_boot_params</span><br><span class="line">save_boot_params_ret:</span><br></pre></td></tr></table></figure>
<p>reset 只有一条跳转指令 <code>b save_boot_params</code>，搜索得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/*************************************************************************</span><br><span class="line"> *</span><br><span class="line"> * void save_boot_params(u32 r0, u32 r1, u32 r2, u32 r3)</span><br><span class="line"> *	__attribute__((weak));</span><br><span class="line"> *</span><br><span class="line"> * Stack pointer is not yet initialized at this moment</span><br><span class="line"> * Don&#x27;t save anything to stack even if compiled with -O0</span><br><span class="line"> *</span><br><span class="line"> *************************************************************************/</span><br><span class="line">ENTRY(save_boot_params)</span><br><span class="line">	b	save_boot_params_ret		@ back to my caller</span><br></pre></td></tr></table></figure>
<p>又是一条跳转指令 <code>b save_boot_params_ret</code> 标志代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">save_boot_params_ret:</span><br><span class="line">	/*</span><br><span class="line">	 * disable interrupts (FIQ and IRQ), also set the cpu to SVC32 mode,</span><br><span class="line">	 * except if in HYP mode already</span><br><span class="line">	 */</span><br><span class="line">	mrs	r0, cpsr</span><br><span class="line">	and	r1, r0, #0x1f		@ mask mode bits</span><br><span class="line">	teq	r1, #0x1a		@ test for HYP mode</span><br><span class="line">	bicne	r0, r0, #0x1f		@ clear all mode bits</span><br><span class="line">	orrne	r0, r0, #0x13		@ set SVC mode</span><br><span class="line">	orr	r0, r0, #0xc0		@ disable FIQ and IRQ</span><br><span class="line">	msr	cpsr,r0</span><br></pre></td></tr></table></figure>
<p><strong>主要工作：设置 cpsr(Current Program Status Register)的值，将 CPU 模式设置为 SVC32 模式，禁止 FIQ 和 IRQ。</strong></p>
<p>打开《arm_architecture_reference_manual ARMv7-A and ARMv7-R edition》ARMv7架构参考手册，具体看下 cpsr 的位域结构，如下图所示：</p>
<p><img src="uboot_pro002.png" alt=""></p>
<p>红色方框是 <code>save_boot_params_ret</code> 标志要设置的位域，位域 M[4:0] 决定了当前 cpu 的工作模式，而位域F[6] 为 FIQ 中断屏蔽位，位域 I[7] 为 IRQ 中断屏蔽位，位域 T[5] 为 Thumb 执行状态位（此位没有设置，可忽略），模式位域 M[4:0] 详情如下表格所示：</p>
<p><img src="uboot_pro003.png" alt=""></p>
<p>接着执行后续代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Setup vector:</span><br><span class="line"> * (OMAP4 spl TEXT_BASE is not 32 byte aligned.</span><br><span class="line"> * Continue to use ROM code vector only in OMAP4 spl)</span><br><span class="line"> */</span><br><span class="line">#if !(defined(CONFIG_OMAP44XX) &amp;&amp; defined(CONFIG_SPL_BUILD))</span><br><span class="line">	/* Set V=0 in CP15 SCTLR register - for VBAR to point to vector */</span><br><span class="line">	mrc	p15, 0, r0, c1, c0, 0	@ Read CP15 SCTLR Register</span><br><span class="line">	bic	r0, #CR_V		@ V = 0</span><br><span class="line">	mcr	p15, 0, r0, c1, c0, 0	@ Write CP15 SCTLR Register</span><br><span class="line"></span><br><span class="line">	/* Set vector address in CP15 VBAR register */</span><br><span class="line">	ldr	r0, =_start</span><br><span class="line">	mcr	p15, 0, r0, c12, c0, 0	@Set VBAR</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p><strong>主要工作：将 SCTLR 中位域 V[13] 清零，使得软件可以重定位向量表，然后设置 VBAR 指向向量表以实现向量表定位到 0x87800000 地址处。</strong></p>
<p>由注释可知这段代码要设置 SCTLR（系统控制寄存器）</p>
<p><img src="/uboot_pro004.png" alt="未找到图片04|"></p>
<p>SCTLR 寄存器用于控制标准内存和系统设备，并且为在硬件内核中实现的功能提供状态信息，其中<strong>位域 V[13] 的作用是选择异常向量表的基地址</strong>，根据 ARMv7 架构参考手册描述可知，<strong>当往 V[13] 填 0 时，异常向量表的基地址=0x00000000，并且该地址可以被 re-mapped（重映射）</strong>；当往 V[13] 填 1 时，异常向量表的基地址=0xffff0000，此时该地址不能被重映射。 源码中大量用到了 mrc 和 mcr 指令，<strong>mrc 为协处理器寄存器到 ARM 处理器寄存器的数据传送指令，mcr 为 ARM 处理器寄存器到协处理器寄存器的数据传送指令。</strong></p>
<p>接着后续代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	/* the mask ROM code should have PLL and others stable */</span><br><span class="line">#ifndef CONFIG_SKIP_LOWLEVEL_INIT</span><br><span class="line">	bl	cpu_init_cp15</span><br><span class="line">#ifndef CONFIG_SKIP_LOWLEVEL_INIT_ONLY</span><br><span class="line">	bl	cpu_init_crit</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>搜索 <code>cpu_init_cp15</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">/*************************************************************************</span><br><span class="line"> *</span><br><span class="line"> * cpu_init_cp15</span><br><span class="line"> *</span><br><span class="line"> * Setup CP15 registers (cache, MMU, TLBs). The I-cache is turned on unless</span><br><span class="line"> * CONFIG_SYS_ICACHE_OFF is defined.</span><br><span class="line"> *</span><br><span class="line"> *************************************************************************/</span><br><span class="line">ENTRY(cpu_init_cp15)</span><br><span class="line">	/*</span><br><span class="line">	 * Invalidate L1 I/D</span><br><span class="line">	 */</span><br><span class="line">	mov	r0, #0			@ set up for MCR</span><br><span class="line">	mcr	p15, 0, r0, c8, c7, 0	@ invalidate TLBs</span><br><span class="line">	mcr	p15, 0, r0, c7, c5, 0	@ invalidate icache</span><br><span class="line">	mcr	p15, 0, r0, c7, c5, 6	@ invalidate BP array</span><br><span class="line">	mcr     p15, 0, r0, c7, c10, 4	@ DSB</span><br><span class="line">	mcr     p15, 0, r0, c7, c5, 4	@ ISB</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * disable MMU stuff and caches</span><br><span class="line">	 */</span><br><span class="line">	mrc	p15, 0, r0, c1, c0, 0</span><br><span class="line">	bic	r0, r0, #0x00002000	@ clear bits 13 (--V-)</span><br><span class="line">	bic	r0, r0, #0x00000007	@ clear bits 2:0 (-CAM)</span><br><span class="line">	orr	r0, r0, #0x00000002	@ set bit 1 (--A-) Align</span><br><span class="line">	orr	r0, r0, #0x00000800	@ set bit 11 (Z---) BTB</span><br><span class="line">#ifdef CONFIG_SYS_ICACHE_OFF</span><br><span class="line">	bic	r0, r0, #0x00001000	@ clear bit 12 (I) I-cache</span><br><span class="line">#else</span><br><span class="line">	orr	r0, r0, #0x00001000	@ set bit 12 (I) I-cache</span><br><span class="line">#endif</span><br><span class="line">	mcr	p15, 0, r0, c1, c0, 0</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_716044</span><br><span class="line">	mrc	p15, 0, r0, c1, c0, 0	@ read system control register</span><br><span class="line">	orr	r0, r0, #1 &lt;&lt; 11	@ set bit #11</span><br><span class="line">	mcr	p15, 0, r0, c1, c0, 0	@ write system control register</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if (defined(CONFIG_ARM_ERRATA_742230) || defined(CONFIG_ARM_ERRATA_794072))</span><br><span class="line">	mrc	p15, 0, r0, c15, c0, 1	@ read diagnostic register</span><br><span class="line">	orr	r0, r0, #1 &lt;&lt; 4		@ set bit #4</span><br><span class="line">	mcr	p15, 0, r0, c15, c0, 1	@ write diagnostic register</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_743622</span><br><span class="line">	mrc	p15, 0, r0, c15, c0, 1	@ read diagnostic register</span><br><span class="line">	orr	r0, r0, #1 &lt;&lt; 6		@ set bit #6</span><br><span class="line">	mcr	p15, 0, r0, c15, c0, 1	@ write diagnostic register</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_751472</span><br><span class="line">	mrc	p15, 0, r0, c15, c0, 1	@ read diagnostic register</span><br><span class="line">	orr	r0, r0, #1 &lt;&lt; 11	@ set bit #11</span><br><span class="line">	mcr	p15, 0, r0, c15, c0, 1	@ write diagnostic register</span><br><span class="line">#endif</span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_761320</span><br><span class="line">	mrc	p15, 0, r0, c15, c0, 1	@ read diagnostic register</span><br><span class="line">	orr	r0, r0, #1 &lt;&lt; 21	@ set bit #21</span><br><span class="line">	mcr	p15, 0, r0, c15, c0, 1	@ write diagnostic register</span><br><span class="line">#endif</span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_845369</span><br><span class="line">	mrc	p15, 0, r0, c15, c0, 1	@ read diagnostic register</span><br><span class="line">	orr	r0, r0, #1 &lt;&lt; 22	@ set bit #22</span><br><span class="line">	mcr	p15, 0, r0, c15, c0, 1	@ write diagnostic register</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	mov	r5, lr			@ Store my Caller</span><br><span class="line">	mrc	p15, 0, r1, c0, c0, 0	@ r1 has Read Main ID Register (MIDR)</span><br><span class="line">	mov	r3, r1, lsr #20		@ get variant field</span><br><span class="line">	and	r3, r3, #0xf		@ r3 has CPU variant</span><br><span class="line">	and	r4, r1, #0xf		@ r4 has CPU revision</span><br><span class="line">	mov	r2, r3, lsl #4		@ shift variant field for combined value</span><br><span class="line">	orr	r2, r4, r2		@ r2 has combined CPU variant + revision</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_798870</span><br><span class="line">	cmp	r2, #0x30		@ Applies to lower than R3p0</span><br><span class="line">	bge	skip_errata_798870      @ skip if not affected rev</span><br><span class="line">	cmp	r2, #0x20		@ Applies to including and above R2p0</span><br><span class="line">	blt	skip_errata_798870      @ skip if not affected rev</span><br><span class="line"></span><br><span class="line">	mrc	p15, 1, r0, c15, c0, 0  @ read l2 aux ctrl reg</span><br><span class="line">	orr	r0, r0, #1 &lt;&lt; 7         @ Enable hazard-detect timeout</span><br><span class="line">	push	&#123;r1-r5&#125;			@ Save the cpu info registers</span><br><span class="line">	bl	v7_arch_cp15_set_l2aux_ctrl</span><br><span class="line">	isb				@ Recommended ISB after l2actlr update</span><br><span class="line">	pop	&#123;r1-r5&#125;			@ Restore the cpu info - fall through</span><br><span class="line">skip_errata_798870:</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_801819</span><br><span class="line">	cmp	r2, #0x24		@ Applies to lt including R2p4</span><br><span class="line">	bgt	skip_errata_801819      @ skip if not affected rev</span><br><span class="line">	cmp	r2, #0x20		@ Applies to including and above R2p0</span><br><span class="line">	blt	skip_errata_801819      @ skip if not affected rev</span><br><span class="line">	mrc	p15, 0, r0, c0, c0, 6	@ pick up REVIDR reg</span><br><span class="line">	and	r0, r0, #1 &lt;&lt; 3		@ check REVIDR[3]</span><br><span class="line">	cmp	r0, #1 &lt;&lt; 3</span><br><span class="line">	beq	skip_errata_801819	@ skip erratum if REVIDR[3] is set</span><br><span class="line"></span><br><span class="line">	mrc	p15, 0, r0, c1, c0, 1	@ read auxilary control register</span><br><span class="line">	orr	r0, r0, #3 &lt;&lt; 27	@ Disables streaming. All write-allocate</span><br><span class="line">					@ lines allocate in the L1 or L2 cache.</span><br><span class="line">	orr	r0, r0, #3 &lt;&lt; 25	@ Disables streaming. All write-allocate</span><br><span class="line">					@ lines allocate in the L1 cache.</span><br><span class="line">	push	&#123;r1-r5&#125;			@ Save the cpu info registers</span><br><span class="line">	bl	v7_arch_cp15_set_acr</span><br><span class="line">	pop	&#123;r1-r5&#125;			@ Restore the cpu info - fall through</span><br><span class="line">skip_errata_801819:</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_454179</span><br><span class="line">	cmp	r2, #0x21		@ Only on &lt; r2p1</span><br><span class="line">	bge	skip_errata_454179</span><br><span class="line"></span><br><span class="line">	mrc	p15, 0, r0, c1, c0, 1	@ Read ACR</span><br><span class="line">	orr	r0, r0, #(0x3 &lt;&lt; 6)	@ Set DBSM(BIT7) and IBE(BIT6) bits</span><br><span class="line">	push	&#123;r1-r5&#125;			@ Save the cpu info registers</span><br><span class="line">	bl	v7_arch_cp15_set_acr</span><br><span class="line">	pop	&#123;r1-r5&#125;			@ Restore the cpu info - fall through</span><br><span class="line"></span><br><span class="line">skip_errata_454179:</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_430973</span><br><span class="line">	cmp	r2, #0x21		@ Only on &lt; r2p1</span><br><span class="line">	bge	skip_errata_430973</span><br><span class="line"></span><br><span class="line">	mrc	p15, 0, r0, c1, c0, 1	@ Read ACR</span><br><span class="line">	orr	r0, r0, #(0x1 &lt;&lt; 6)	@ Set IBE bit</span><br><span class="line">	push	&#123;r1-r5&#125;			@ Save the cpu info registers</span><br><span class="line">	bl	v7_arch_cp15_set_acr</span><br><span class="line">	pop	&#123;r1-r5&#125;			@ Restore the cpu info - fall through</span><br><span class="line"></span><br><span class="line">skip_errata_430973:</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_ARM_ERRATA_621766</span><br><span class="line">	cmp	r2, #0x21		@ Only on &lt; r2p1</span><br><span class="line">	bge	skip_errata_621766</span><br><span class="line"></span><br><span class="line">	mrc	p15, 0, r0, c1, c0, 1	@ Read ACR</span><br><span class="line">	orr	r0, r0, #(0x1 &lt;&lt; 5)	@ Set L1NEON bit</span><br><span class="line">	push	&#123;r1-r5&#125;			@ Save the cpu info registers</span><br><span class="line">	bl	v7_arch_cp15_set_acr</span><br><span class="line">	pop	&#123;r1-r5&#125;			@ Restore the cpu info - fall through</span><br><span class="line"></span><br><span class="line">skip_errata_621766:</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	mov	pc, r5			@ back to my caller</span><br><span class="line">ENDPROC(cpu_init_cp15)</span><br></pre></td></tr></table></figure>
<p><strong>主要工作：关闭 ICache 和 MMU。</strong></p>
<blockquote>
<p>到这里我们再总结一下上面这段代码的功能含义，首先，我们为何要关闭mmu？mmu负责从虚拟地址到物理地址之间的转换，但是我们现在的汇编都是直接操作物理寄存器， 此时如果打开了mmu，而我们并没有有效的TLB，这样cpu可以说是胡乱运行的，所以我们需要关闭mmu，不需要它转换地址，直接操作寄存器方便快捷。 然后，再发出灵魂拷问，为何要关闭cache？因为cache和MMU是通过cp15管理的，刚上电的时候，CPU并不能管理他们。所以上电的时候mmu必须关闭，指令cache可关闭，可不关闭，但数据cache一定要关闭， 否则可能导致刚开始的代码里面，去取数据的时候，从cache里面取，而这时候RAM中数据还没有cache过来，导致数据预取异常</p>
</blockquote>
<p>搜索 <code>cpu_init_crit</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#if !defined(CONFIG_SKIP_LOWLEVEL_INIT) &amp;&amp; \</span><br><span class="line">	!defined(CONFIG_SKIP_LOWLEVEL_INIT_ONLY)</span><br><span class="line">/*************************************************************************</span><br><span class="line"> *</span><br><span class="line"> * CPU_init_critical registers</span><br><span class="line"> *</span><br><span class="line"> * setup important registers</span><br><span class="line"> * setup memory timing</span><br><span class="line"> *</span><br><span class="line"> *************************************************************************/</span><br><span class="line">ENTRY(cpu_init_crit)</span><br><span class="line">	/*</span><br><span class="line">	 * Jump to board specific initialization...</span><br><span class="line">	 * The Mask ROM will have already initialized</span><br><span class="line">	 * basic memory. Go here to bump up clock rate and handle</span><br><span class="line">	 * wake up conditions.</span><br><span class="line">	 */</span><br><span class="line">	b	lowlevel_init		@ go setup pll,mux,memory</span><br><span class="line">ENDPROC(cpu_init_crit)</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h4 id="lowlevel-init-函数">lowlevel_init 函数</h4>
<p>跳转到 <code>lowlevel_init</code> 函数(<code>arch/arm/cpu/armv7/lowlevel_init.S</code>)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(lowlevel_init)</span><br><span class="line">	/*</span><br><span class="line">	 * Setup a temporary stack. Global data is not available yet.</span><br><span class="line">	 */</span><br><span class="line">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span><br><span class="line">	ldr	sp, =CONFIG_SPL_STACK</span><br><span class="line">#else</span><br><span class="line">	ldr	sp, =CONFIG_SYS_INIT_SP_ADDR</span><br><span class="line">#endif</span><br><span class="line">	bic	sp, sp, #7 /* 8-byte alignment for ABI compliance */</span><br><span class="line">#ifdef CONFIG_SPL_DM</span><br><span class="line">	mov	r9, #0</span><br><span class="line">#else</span><br><span class="line">	/*</span><br><span class="line">	 * Set up global data for boards that still need it. This will be</span><br><span class="line">	 * removed soon.</span><br><span class="line">	 */</span><br><span class="line">#ifdef CONFIG_SPL_BUILD</span><br><span class="line">	ldr	r9, =gdata</span><br><span class="line">#else</span><br><span class="line">	sub	sp, sp, #GD_SIZE</span><br><span class="line">	bic	sp, sp, #7</span><br><span class="line">	mov	r9, sp</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line">	/*</span><br><span class="line">	 * Save the old lr(passed in ip) and the current lr to stack</span><br><span class="line">	 */</span><br><span class="line">	push	&#123;ip, lr&#125;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Call the very early init function. This should do only the</span><br><span class="line">	 * absolute bare minimum to get started. It should not:</span><br><span class="line">	 *</span><br><span class="line">	 * - set up DRAM</span><br><span class="line">	 * - use global_data</span><br><span class="line">	 * - clear BSS</span><br><span class="line">	 * - try to start a console</span><br><span class="line">	 *</span><br><span class="line">	 * For boards with SPL this should be empty since SPL can do all of</span><br><span class="line">	 * this init in the SPL board_init_f() function which is called</span><br><span class="line">	 * immediately after this.</span><br><span class="line">	 */</span><br><span class="line">	bl	s_init</span><br><span class="line">	pop	&#123;ip, pc&#125;</span><br><span class="line">ENDPROC(lowlevel_init)</span><br></pre></td></tr></table></figure>
<p>其中 sp 指向 <code>CONFIG_SYS_INIT_SP_ADDR</code> 这个地址，<code>CONFIG_SYS_INIT_SP_ADDR</code> 在 <code>include/configs/mx6ullevk.h</code> 文件中定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_SDRAM_BASE		PHYS_SDRAM</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_INIT_RAM_ADDR	IRAM_BASE_ADDR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_INIT_RAM_SIZE	IRAM_SIZE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_INIT_SP_OFFSET \</span></span><br><span class="line"><span class="meta">	(CONFIG_SYS_INIT_RAM_SIZE - GENERATED_GBL_DATA_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_SYS_INIT_SP_ADDR \</span></span><br><span class="line"><span class="meta">	(CONFIG_SYS_INIT_RAM_ADDR + CONFIG_SYS_INIT_SP_OFFSET)</span></span><br></pre></td></tr></table></figure>
<p><code>IRAM_BASE_ADDR</code>  和 <code>IRAM_SIZE</code> 在 <code>arch/arm/include/asm/arch-mx6/imx-regs.h</code> 文件中定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRAM_BASE_ADDR			0x00900000</span></span><br><span class="line"></span><br><span class="line">······</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !(defined(CONFIG_MX6SX) || defined(CONFIG_MX6UL) || \</span></span><br><span class="line"><span class="meta">	defined(CONFIG_MX6SLL) || defined(CONFIG_MX6SL))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRAM_SIZE                    0x00040000</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRAM_SIZE                    0x00020000</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>因为在根目录下 <code>.config</code> 文件中配置了 <code>CONFIG_MX6UL=y</code> 选项，所以最终 IRAM_SIZE = 0x00020000，IRAM_BASE_ADDR = 0x00900000。</p>
<p><code>GENERATED_GBL_DATA_SIZE</code> 在 <code>include/generated/generic-asm-offsets.h</code> 文件中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __GENERIC_ASM_OFFSETS_H__</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * DO NOT MODIFY.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This file was generated by Kbuild</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_GBL_DATA_SIZE 256 <span class="comment">/* (sizeof(struct global_data) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GENERATED_BD_INFO_SIZE 80 <span class="comment">/* (sizeof(struct bd_info) + 15) &amp; ~15	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_SIZE 248 <span class="comment">/* sizeof(struct global_data)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_BD 0 <span class="comment">/* offsetof(struct global_data, bd)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_MALLOC_BASE 188 <span class="comment">/* offsetof(struct global_data, malloc_base)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOCADDR 48 <span class="comment">/* offsetof(struct global_data, relocaddr)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_RELOC_OFF 68 <span class="comment">/* offsetof(struct global_data, reloc_off)	@ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GD_START_ADDR_SP 64 <span class="comment">/* offsetof(struct global_data, start_addr_sp)	@ */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>可知 <code>GENERATED_GBL_DATA_SIZE = 256 = 0x00000100</code>，由此可得：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SYS_INIT_SP_OFFSET = <span class="number">0x00020000</span> – <span class="number">0x00000100</span> = <span class="number">0x0001FF00</span>。</span><br><span class="line">CONFIG_SYS_INIT_SP_ADDR = <span class="number">0x00900000</span> + <span class="number">0X0001FF00</span> = <span class="number">0X0091FF00</span>，</span><br></pre></td></tr></table></figure>
<p>由注释 <code>8-byte alignment for ABI compliance</code> 可知 <code>CONFIG_SYS_INIT_SP_ADDR</code> 需要遵从 ABI 的 8 字节对齐。</p>
<p>接下来是 s_init 函数，在文件 <code>arhc/arm/cpu/armv7/mx6/soc.c</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">s_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">anatop_regs</span> *<span class="title">anatop</span> =</span> (<span class="keyword">struct</span> anatop_regs *)ANATOP_BASE_ADDR;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mxc_ccm_reg</span> *<span class="title">ccm</span> =</span> (<span class="keyword">struct</span> mxc_ccm_reg *)CCM_BASE_ADDR;</span><br><span class="line">	u32 mask480;</span><br><span class="line">	u32 mask528;</span><br><span class="line">	u32 reg, periph1, periph2;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ANDROID_SUPPORT)</span></span><br><span class="line">        <span class="comment">/* Enable RTC */</span></span><br><span class="line">        writel(<span class="number">0x21</span>, <span class="number">0x020cc038</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span> (is_mx6sx() || is_mx6ul() || is_mx6ull() || is_mx6sll())</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Due to hardware limitation, on MX6Q we need to gate/ungate all PFDs</span></span><br><span class="line"><span class="comment">	 * to make sure PFD is working right, otherwise, PFDs may</span></span><br><span class="line"><span class="comment">	 * not output clock after reset, MX6DL and MX6SL have added 396M pfd</span></span><br><span class="line"><span class="comment">	 * workaround in ROM code, as bus clock need it</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	mask480 = ANATOP_PFD_CLKGATE_MASK(<span class="number">0</span>) |</span><br><span class="line">		ANATOP_PFD_CLKGATE_MASK(<span class="number">1</span>) |</span><br><span class="line">		ANATOP_PFD_CLKGATE_MASK(<span class="number">2</span>) |</span><br><span class="line">		ANATOP_PFD_CLKGATE_MASK(<span class="number">3</span>);</span><br><span class="line">	mask528 = ANATOP_PFD_CLKGATE_MASK(<span class="number">1</span>) |</span><br><span class="line">		ANATOP_PFD_CLKGATE_MASK(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	reg = readl(&amp;ccm-&gt;cbcmr);</span><br><span class="line">	periph2 = ((reg &amp; MXC_CCM_CBCMR_PRE_PERIPH2_CLK_SEL_MASK)</span><br><span class="line">		&gt;&gt; MXC_CCM_CBCMR_PRE_PERIPH2_CLK_SEL_OFFSET);</span><br><span class="line">	periph1 = ((reg &amp; MXC_CCM_CBCMR_PRE_PERIPH_CLK_SEL_MASK)</span><br><span class="line">		&gt;&gt; MXC_CCM_CBCMR_PRE_PERIPH_CLK_SEL_OFFSET);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Checking if PLL2 PFD0 or PLL2 PFD2 is using for periph clock */</span></span><br><span class="line">	<span class="keyword">if</span> ((periph2 != <span class="number">0x2</span>) &amp;&amp; (periph1 != <span class="number">0x2</span>))</span><br><span class="line">		mask528 |= ANATOP_PFD_CLKGATE_MASK(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((periph2 != <span class="number">0x1</span>) &amp;&amp; (periph1 != <span class="number">0x1</span>) &amp;&amp;</span><br><span class="line">		(periph2 != <span class="number">0x3</span>) &amp;&amp; (periph1 != <span class="number">0x3</span>))</span><br><span class="line">		mask528 |= ANATOP_PFD_CLKGATE_MASK(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	writel(mask480, &amp;anatop-&gt;pfd_480_set);</span><br><span class="line">	writel(mask528, &amp;anatop-&gt;pfd_528_set);</span><br><span class="line">	writel(mask480, &amp;anatop-&gt;pfd_480_clr);</span><br><span class="line">	writel(mask528, &amp;anatop-&gt;pfd_528_clr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出如果 CPU 为 MX6SX、MX6UL、MX6ULL 或 MX6SLL中的任意一种，那么就会直接返回，相当于什么都没做。</p>
<p>cpu_init_crit 函数执行完接着进入 _main 函数，该函数主要是初始化 C 语言的运行环境。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bl	_main</span><br></pre></td></tr></table></figure>
<p>搜索 _main，在 <code>arch/arm/lib/crt0.S</code> 中定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(_main)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Set up initial C runtime environment and call board_init_f(0).</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span><br><span class="line">	ldr	sp, =(CONFIG_SPL_STACK)</span><br><span class="line">#else</span><br><span class="line">	ldr	sp, =(CONFIG_SYS_INIT_SP_ADDR)</span><br><span class="line">#endif</span><br><span class="line">#if defined(CONFIG_CPU_V7M)	/* v7M forbids using SP as BIC destination */</span><br><span class="line">	mov	r3, sp</span><br><span class="line">	bic	r3, r3, #7</span><br><span class="line">	mov	sp, r3</span><br><span class="line">#else</span><br><span class="line">	bic	sp, sp, #7	/* 8-byte alignment for ABI compliance */</span><br><span class="line">#endif</span><br><span class="line">	mov	r0, sp</span><br><span class="line">	bl	board_init_f_alloc_reserve</span><br><span class="line">	mov	sp, r0</span><br><span class="line">	/* set up gd here, outside any C code */</span><br><span class="line">	mov	r9, r0</span><br><span class="line">	bl	board_init_f_init_reserve</span><br><span class="line"></span><br><span class="line">	mov	r0, #0</span><br><span class="line">	bl	board_init_f</span><br></pre></td></tr></table></figure>
<p><code>board_init_f_alloc_reserve</code> 函数在 <code>common/init/board_init.c</code> 文件定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ulong <span class="title function_">board_init_f_alloc_reserve</span><span class="params">(ulong top)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* Reserve early malloc arena */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_MALLOC_F)</span></span><br><span class="line">	top -= CONFIG_SYS_MALLOC_F_LEN;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* LAST : reserve GD (rounded up to a multiple of 16 bytes) */</span></span><br><span class="line">	top = rounddown(top-<span class="keyword">sizeof</span>(<span class="keyword">struct</span> global_data), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> top;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据 ARM 函数调用规则，<strong>top=r0=0x0091FF00</strong>，该函数主要作用是<strong>保留早期 malloc 区域，且为 GD（全局数据区）留出空间</strong>，返回值也是 <strong>r0 = 0x0091FA00</strong>，其中 <code>CONFIG_SYS_MALLOC_F_LEN = 0X400</code> ( 在文件<code>include/generated/autoconf.h</code> 中定义) ，<code>sizeof(struct global_data) = 248(GD_SIZE 值) = 0x100</code>，计算可得 <code>r0 = 0x0091FF00 - 0x400 - 0x100 = 0x0091FA00</code>。</p>
<p><code>mov	r9, r0</code> 将 r0 寄存器的值写到寄存器 r9 里面，因为 <strong>r9 寄存器存放着全局变量 gd 的地址</strong>，<br>
在文件 <code>arch/arm/include/asm/global_data.h</code> 定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_GLOBAL_DATA_PTR		register volatile gd_t *gd asm (<span class="string">&quot;r9&quot;</span>)</span></span><br></pre></td></tr></table></figure>
<p>可知 uboot 定义了一个指向 gd_t 的指针 gd，gd 存放在寄存器 r9，也就是说 <strong>gd 是个全局变量</strong>。gd_t 是一个结构体在 <code>include/asm-generic/global_data.h</code> 文件中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> &#123;</span></span><br><span class="line">	<span class="type">bd_t</span> *bd;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> baudrate;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> cpu_clk;		<span class="comment">/* CPU clock in Hz!		*/</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bus_clk;</span><br><span class="line">	<span class="comment">/* We cannot bracket this with CONFIG_PCI due to mpc5xxx */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> pci_clk;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> mem_clk;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_LCD) || defined(CONFIG_VIDEO)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> fb_base;		<span class="comment">/* Base address of framebuffer mem */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_POST) || defined(CONFIG_LOGBUFFER)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> post_log_word;	<span class="comment">/* Record POST activities */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> post_log_res;	<span class="comment">/* success of POST test */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> post_init_f_time;	<span class="comment">/* When post_init_f started */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOARD_TYPES</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> board_type;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> have_console;	<span class="comment">/* serial_init() was called */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IS_ENABLED(PRE_CONSOLE_BUFFER)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> precon_buf_idx;	<span class="comment">/* Pre-Console buffer index */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> env_addr;		<span class="comment">/* Address  of Environment struct */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> env_valid;	<span class="comment">/* Checksum of Environment valid? */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ram_top;		<span class="comment">/* Top address of RAM used by U-Boot */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> relocaddr;	<span class="comment">/* Start address of U-Boot in RAM */</span></span><br><span class="line">	<span class="type">phys_size_t</span> ram_size;		<span class="comment">/* RAM size */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> mon_len;		<span class="comment">/* monitor len */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> irq_sp;		<span class="comment">/* irq stack pointer */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> start_addr_sp;	<span class="comment">/* start_addr_stackpointer */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> reloc_off;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> *<span class="title">new_gd</span>;</span>	<span class="comment">/* relocated global data */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">udevice</span>	*<span class="title">dm_root</span>;</span>	<span class="comment">/* Root instance for Driver Model */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">udevice</span>	*<span class="title">dm_root_f</span>;</span>	<span class="comment">/* Pre-relocation root instance */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">uclass_root</span>;</span>	<span class="comment">/* Head of core tree */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TIMER</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">udevice</span>	*<span class="title">timer</span>;</span>		<span class="comment">/* Timer instance for Driver Model */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">void</span> *fdt_blob;		<span class="comment">/* Our device tree, NULL if none */</span></span><br><span class="line">	<span class="type">void</span> *new_fdt;			<span class="comment">/* Relocated FDT */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> fdt_size;		<span class="comment">/* Space reserved for relocated FDT */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">jt_funcs</span> *<span class="title">jt</span>;</span>		<span class="comment">/* jump table */</span></span><br><span class="line">	<span class="type">char</span> env_buf[<span class="number">32</span>];		<span class="comment">/* buffer for getenv() before reloc. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TRACE</span></span><br><span class="line">	<span class="type">void</span>		*trace_buff;	<span class="comment">/* The trace buffer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_I2C)</span></span><br><span class="line">	<span class="type">int</span>		cur_i2c_bus;	<span class="comment">/* current used i2c bus */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_I2C_MXC</span></span><br><span class="line">	<span class="type">void</span> *srdata[<span class="number">10</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> timebase_h;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> timebase_l;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_MALLOC_F_LEN</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> malloc_base;	<span class="comment">/* base address of early malloc() */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> malloc_limit;	<span class="comment">/* limit address */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> malloc_ptr;	<span class="comment">/* current address */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pci_controller</span> *<span class="title">hose</span>;</span>	<span class="comment">/* PCI hose for early use */</span></span><br><span class="line">	<span class="type">phys_addr_t</span> pci_ram_top;	<span class="comment">/* top of region accessible to PCI */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI_BOOTDELAY</span></span><br><span class="line">	<span class="type">int</span> pcidelay_done;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">udevice</span> *<span class="title">cur_serial_dev</span>;</span>	<span class="comment">/* current serial device */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">arch_global_data</span> <span class="title">arch</span>;</span>	<span class="comment">/* architecture-specific data */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CONSOLE_RECORD</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">membuff</span> <span class="title">console_out</span>;</span>	<span class="comment">/* console output */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">membuff</span> <span class="title">console_in</span>;</span>	<span class="comment">/* console input */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DM_VIDEO</span></span><br><span class="line">	ulong video_top;		<span class="comment">/* Top of video frame buffer area */</span></span><br><span class="line">	ulong video_bottom;		<span class="comment">/* Bottom of video frame buffer area */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; <span class="type">gd_t</span>;</span><br></pre></td></tr></table></figure>
<p>gd_t 和 bd_t 都 uboot 中两个重要的数据结构，在初始化操作很多都要靠这两个数据结构来保存或传递，bd_t 结构体在 <code>include/asm-generic/u-boot.h</code> 文件中声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">bd_info</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_memstart;	<span class="comment">/* start of DRAM memory */</span></span><br><span class="line">	<span class="type">phys_size_t</span>	bi_memsize;	<span class="comment">/* size	 of DRAM memory in bytes */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_flashstart;	<span class="comment">/* start of FLASH memory */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_flashsize;	<span class="comment">/* size	 of FLASH memory */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_flashoffset; <span class="comment">/* reserved area for startup monitor */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_sramstart;	<span class="comment">/* start of SRAM memory */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_sramsize;	<span class="comment">/* size	 of SRAM memory */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AVR32</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>   bi_phy_id[<span class="number">4</span>];   <span class="comment">/* PHY address for ATAG_ETHERNET */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>   bi_board_number;<span class="comment">/* ATAG_BOARDINFO */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARM</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_arm_freq; <span class="comment">/* arm frequency */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_dsp_freq; <span class="comment">/* dsp core frequency */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_ddr_freq; <span class="comment">/* ddr frequency */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_5xx) || defined(CONFIG_8xx) || defined(CONFIG_MPC8260) \</span></span><br><span class="line"><span class="meta">	|| defined(CONFIG_E500) || defined(CONFIG_MPC86xx)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_immr_base;	<span class="comment">/* base of IMMR register */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MPC5xxx) || defined(CONFIG_M68K)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_mbar_base;	<span class="comment">/* base of internal registers */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MPC83xx)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_immrbar;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_bootflags;	<span class="comment">/* boot / reboot flag (Unused) */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_ip_addr;	<span class="comment">/* IP Address */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>	bi_enetaddr[<span class="number">6</span>];	<span class="comment">/* OLD: see README.enetaddr */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>	bi_ethspeed;	<span class="comment">/* Ethernet speed in Mbps */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_intfreq;	<span class="comment">/* Internal Freq, in MHz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_busfreq;	<span class="comment">/* Bus Freq, in MHz */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CPM2)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_cpmfreq;	<span class="comment">/* CPM_CLK Freq, in MHz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_brgfreq;	<span class="comment">/* BRG_CLK Freq, in MHz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_sccfreq;	<span class="comment">/* SCC_CLK Freq, in MHz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_vco;		<span class="comment">/* VCO Out from PLL, in MHz */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MPC512X)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_ipsfreq;	<span class="comment">/* IPS Bus Freq, in MHz */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_MPC512X */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MPC5xxx) || defined(CONFIG_M68K)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_ipbfreq;	<span class="comment">/* IPB Bus Freq, in MHz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	bi_pcifreq;	<span class="comment">/* PCI Bus Freq, in MHz */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_EXTRA_CLOCK)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bi_inpfreq;	<span class="comment">/* input Freq in MHz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bi_vcofreq;	<span class="comment">/* vco Freq in MHz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bi_flbfreq;	<span class="comment">/* Flexbus Freq in MHz */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_405)   || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_405GP) || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_405EP) || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_405EZ) || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_405EX) || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_440)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>	bi_s_version[<span class="number">4</span>];	<span class="comment">/* Version of this structure */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>	bi_r_version[<span class="number">32</span>];	<span class="comment">/* Version of the ROM (AMCC) */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>	bi_procfreq;	<span class="comment">/* CPU (Internal) Freq, in Hz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>	bi_plb_busfreq;	<span class="comment">/* PLB Bus speed, in Hz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>	bi_pci_busfreq;	<span class="comment">/* PCI Bus speed, in Hz */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>	bi_pci_enetaddr[<span class="number">6</span>];	<span class="comment">/* PCI Ethernet MAC address */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAS_ETH1</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>   bi_enet1addr[<span class="number">6</span>];	<span class="comment">/* OLD: see README.enetaddr */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAS_ETH2</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>	bi_enet2addr[<span class="number">6</span>];	<span class="comment">/* OLD: see README.enetaddr */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAS_ETH3</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>   bi_enet3addr[<span class="number">6</span>];	<span class="comment">/* OLD: see README.enetaddr */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAS_ETH4</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>   bi_enet4addr[<span class="number">6</span>];	<span class="comment">/* OLD: see README.enetaddr */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAS_ETH5</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>   bi_enet5addr[<span class="number">6</span>];	<span class="comment">/* OLD: see README.enetaddr */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_405GP) || defined(CONFIG_405EP) || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_405EZ) || defined(CONFIG_440GX) || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_440EP) || defined(CONFIG_440GR) || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_440EPX) || defined(CONFIG_440GRX) || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_460EX) || defined(CONFIG_460GT)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>	bi_opbfreq;		<span class="comment">/* OPB clock in Hz */</span></span><br><span class="line">	<span class="type">int</span>		bi_iic_fast[<span class="number">2</span>];		<span class="comment">/* Use fast i2c mode */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_4xx)</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_440GX) || \</span></span><br><span class="line"><span class="meta">		defined(CONFIG_460EX) || defined(CONFIG_460GT)</span></span><br><span class="line">	<span class="type">int</span>		bi_phynum[<span class="number">4</span>];           <span class="comment">/* Determines phy mapping */</span></span><br><span class="line">	<span class="type">int</span>		bi_phymode[<span class="number">4</span>];          <span class="comment">/* Determines phy mode */</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_405EP) || defined(CONFIG_405EX) || defined(CONFIG_440)</span></span><br><span class="line">	<span class="type">int</span>		bi_phynum[<span class="number">2</span>];           <span class="comment">/* Determines phy mapping */</span></span><br><span class="line">	<span class="type">int</span>		bi_phymode[<span class="number">2</span>];          <span class="comment">/* Determines phy mode */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="type">int</span>		bi_phynum[<span class="number">1</span>];           <span class="comment">/* Determines phy mapping */</span></span><br><span class="line">	<span class="type">int</span>		bi_phymode[<span class="number">1</span>];          <span class="comment">/* Determines phy mode */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* defined(CONFIG_4xx) */</span></span></span><br><span class="line">	ulong	        bi_arch_number;	<span class="comment">/* unique id for this board */</span></span><br><span class="line">	ulong	        bi_boot_params;	<span class="comment">/* where this board expects params */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NR_DRAM_BANKS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span>			<span class="comment">/* RAM configuration */</span></span><br><span class="line">		<span class="type">phys_addr_t</span> start;</span><br><span class="line">		<span class="type">phys_size_t</span> size;</span><br><span class="line">	&#125; bi_dram[CONFIG_NR_DRAM_BANKS];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_NR_DRAM_BANKS */</span></span></span><br><span class="line">&#125; <span class="type">bd_t</span>;</span><br></pre></td></tr></table></figure>
<p>看完这两个结构体再回头看 _main 函数后这部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov	r0, sp</span><br><span class="line">bl	board_init_f_alloc_reserve</span><br><span class="line">mov	sp, r0</span><br><span class="line">/* set up gd here, outside any C code */</span><br><span class="line">mov	r9, r0</span><br></pre></td></tr></table></figure>
<p><strong>主要作用就是：保留早期 malloc 区域，且为 GD（全局数据区）留出空间，并设置 gd 所指向的位置为 0x0091FA00。</strong></p>
<p>接着继续后续代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bl  board_init_f_init_reserve</span><br></pre></td></tr></table></figure>
<p><code>board_init_f_init_reserve</code> 函数再 <code>common/init/board_init.c</code> 文件中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_f_init_reserve</span><span class="params">(ulong base)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> *<span class="title">gd_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * clear GD entirely and set it up.</span></span><br><span class="line"><span class="comment">	 * Use gd_ptr, as gd may not be properly set yet.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	gd_ptr = (<span class="keyword">struct</span> global_data *)base;</span><br><span class="line">	<span class="comment">/* zero the area */</span></span><br><span class="line">	<span class="built_in">memset</span>(gd_ptr, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(*gd));</span><br><span class="line">	<span class="comment">/* set GD unless architecture did it already */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM)</span></span><br><span class="line">	arch_setup_gd(gd_ptr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* next alloc will be higher by one GD plus 16-byte alignment */</span></span><br><span class="line">	base += roundup(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> global_data), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * record early malloc arena start.</span></span><br><span class="line"><span class="comment">	 * Use gd as it is now properly set for all architectures.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_MALLOC_F)</span></span><br><span class="line">	<span class="comment">/* go down one &#x27;early malloc arena&#x27; */</span></span><br><span class="line">	gd-&gt;malloc_base = base;</span><br><span class="line">	<span class="comment">/* next alloc will be higher by one &#x27;early malloc arena&#x27; size */</span></span><br><span class="line">	base += CONFIG_SYS_MALLOC_F_LEN;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，该函数用于初始化 gd（清零处理），此函数还设置了 gd-&gt;malloc_base 为 gd 基地址+ gd 大小=0X0091FA00+248=0X0091FAF8，在做 <strong>16 字节对齐</strong>，最终 <strong>gd-&gt;malloc_base=0X0091FB00</strong>，这个也就是early malloc 的起始地址。</p>
<p><img src="image-20240731213212871.png" alt="image-20240731213212871"></p>
<p>接着 _main 函数后续代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">    mov	r0, #0</span><br><span class="line">    bl	board_init_f</span><br><span class="line"></span><br><span class="line">#if ! defined(CONFIG_SPL_BUILD)</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * Set up intermediate environment (new sp and gd) and call</span><br><span class="line"> * relocate_code(addr_moni). Trick here is that we&#x27;ll return</span><br><span class="line"> * &#x27;here&#x27; but relocated.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">	ldr	sp, [r9, #GD_START_ADDR_SP]	/* sp = gd-&gt;start_addr_sp */</span><br><span class="line">#if defined(CONFIG_CPU_V7M)	/* v7M forbids using SP as BIC destination */</span><br><span class="line">	mov	r3, sp</span><br><span class="line">	bic	r3, r3, #7</span><br><span class="line">	mov	sp, r3</span><br><span class="line">#else</span><br><span class="line">	bic	sp, sp, #7	/* 8-byte alignment for ABI compliance */</span><br><span class="line">#endif</span><br><span class="line">	ldr	r9, [r9, #GD_BD]		/* r9 = gd-&gt;bd */</span><br><span class="line">	sub	r9, r9, #GD_SIZE		/* new GD is below bd */</span><br><span class="line"></span><br><span class="line">	adr	lr, here</span><br><span class="line">	ldr	r0, [r9, #GD_RELOC_OFF]		/* r0 = gd-&gt;reloc_off */</span><br><span class="line">	add	lr, lr, r0</span><br><span class="line">#if defined(CONFIG_CPU_V7M)</span><br><span class="line">	orr	lr, #1				/* As required by Thumb-only */</span><br><span class="line">#endif</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]		/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	b	relocate_code</span><br><span class="line">here:</span><br><span class="line">/*</span><br><span class="line"> * now relocate vectors</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">	bl	relocate_vectors</span><br><span class="line"></span><br><span class="line">/* Set up final (full) environment */</span><br><span class="line"></span><br><span class="line">	bl	c_runtime_cpu_setup	/* we still call old routine here */</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>这一部分代码的主要工作：<strong>初始化 gd 的所有成员变量，重新设置环境（sp 和 gd）并且将 uboot 拷贝到新的存放地址（原来的起始地址为 0x87800000，目的地址为 0x9FF47000）。</strong></p>
<p>函数 board_init_f 中会初始化 gd 的所有成员变量，其中 gd-&gt;start_addr_sp=0X9EF44E90， 所以这里相当于设置 sp=gd-&gt;start_addr_sp=0X9EF44E90。0X9EF44E90 是DDR 中的地址，<strong>说明新的 sp 和 gd 将会存放到 DDR 中，而不是内部的RAM 了</strong>。</p>
<p><code>board_init_f</code> 函数是初始化 DDR和定时器等功能，后面分析。</p>
<p><code>relocate_code</code> 函数是代码重定位函数：负责将 uboot 拷贝到新的地址，后续分析。</p>
<p><code>relocate_vectors</code> 函数是对中断向量表做重定位，后续分析。</p>
<p>接着看 _main 函数后续的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ldr	r0, =__bss_start	/* this is auto-relocated! */</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_USE_ARCH_MEMSET</span><br><span class="line">	ldr	r3, =__bss_end		/* this is auto-relocated! */</span><br><span class="line">	mov	r1, #0x00000000		/* prepare zero to clear BSS */</span><br><span class="line"></span><br><span class="line">	subs	r2, r3, r0		/* r2 = memset len */</span><br><span class="line">	bl	memset</span><br><span class="line">#else</span><br><span class="line">	ldr	r1, =__bss_end		/* this is auto-relocated! */</span><br><span class="line">	mov	r2, #0x00000000		/* prepare zero to clear BSS */</span><br><span class="line"></span><br><span class="line">clbss_l:cmp	r0, r1			/* while not at end of BSS */</span><br><span class="line">#if defined(CONFIG_CPU_V7M)</span><br><span class="line">	itt	lo</span><br><span class="line">#endif</span><br><span class="line">	strlo	r2, [r0]		/* clear 32-bit BSS word */</span><br><span class="line">	addlo	r0, r0, #4		/* move to next */</span><br><span class="line">	blo	clbss_l</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>这部分代码主要是用来清除 BSS 段。</p>
<h4 id="board-init-f-函数">board_init_f 函数</h4>
<ul>
<li>初始化一系列外设：串口、定时器等</li>
<li>初始化 gd 的各个成员变量，uboot 会将自己重定位到 DRAM 最后面的地址区域，也就是将自己拷贝到 DRAM 最后面的内存区域中。目的是给 Linux 腾出空间，防止 Linux kernel 覆盖掉 uboot，将 DRAM 前面的区域完整的空出来。</li>
</ul>
<p>board_init_f 函数 <code>common/board_f.c</code> 文件中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_f</span><span class="params">(ulong boot_flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYS_GENERIC_GLOBAL_DATA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For some architectures, global data is initialized and used before</span></span><br><span class="line"><span class="comment">	 * calling this function. The data should be preserved. For others,</span></span><br><span class="line"><span class="comment">	 * CONFIG_SYS_GENERIC_GLOBAL_DATA should be defined and use the stack</span></span><br><span class="line"><span class="comment">	 * here to host global data until relocation.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">gd_t</span> data;</span><br><span class="line"></span><br><span class="line">	gd = &amp;data;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Clear global data before it is accessed at debug print</span></span><br><span class="line"><span class="comment">	 * in initcall_run_list. Otherwise the debug print probably</span></span><br><span class="line"><span class="comment">	 * get the wrong value of gd-&gt;have_console.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	zero_global_data();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	gd-&gt;flags = boot_flags;</span><br><span class="line">	gd-&gt;have_console = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (initcall_run_list(init_sequence_f))</span><br><span class="line">		hang();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_SANDBOX) &amp;&amp; \</span></span><br><span class="line"><span class="meta">		!defined(CONFIG_EFI_APP) &amp;&amp; !CONFIG_IS_ENABLED(X86_64)</span></span><br><span class="line">	<span class="comment">/* NOTREACHED - jump_to_copy() does not return */</span></span><br><span class="line">	hang();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置 gd 的 have_console 为 0，表示还没有初始化串口，接着调用 initcall_run_list 函数来运行初始化序列 init_sequence_f，其里面包含了一系列初始化函数。</p>
<p>initcall_run_list 函数在文件 <code>include/initcall.h</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">DECLARE_GLOBAL_DATA_PTR;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">initcall_run_list</span><span class="params">(<span class="type">const</span> <span class="type">init_fnc_t</span> init_sequence[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">init_fnc_t</span> *init_fnc_ptr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (init_fnc_ptr = init_sequence; *init_fnc_ptr; ++init_fnc_ptr) &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> reloc_ofs = <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_RELOC)</span><br><span class="line">			reloc_ofs = gd-&gt;reloc_off;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EFI_APP</span></span><br><span class="line">		reloc_ofs = (<span class="type">unsigned</span> <span class="type">long</span>)image_base;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		debug(<span class="string">&quot;initcall: %p&quot;</span>, (<span class="type">char</span> *)*init_fnc_ptr - reloc_ofs);</span><br><span class="line">		<span class="keyword">if</span> (gd-&gt;flags &amp; GD_FLG_RELOC)</span><br><span class="line">			debug(<span class="string">&quot; (relocated to %p)\n&quot;</span>, (<span class="type">char</span> *)*init_fnc_ptr);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			debug(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		ret = (*init_fnc_ptr)();</span><br><span class="line">		<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;initcall sequence %p failed at call %p (err=%d)\n&quot;</span>,</span><br><span class="line">			       init_sequence,</span><br><span class="line">			       (<span class="type">char</span> *)*init_fnc_ptr - reloc_ofs, ret);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>遍历执行函数指针数组 init_sequence[] 里面放的所有函数并测试其返回值。</p>
<p>init_sequence_f 序列在文件 <code>common/board_f.c</code> 中定义：去除一些条件编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">init_fnc_t</span> init_sequence_f[] = &#123;</span><br><span class="line">   setup_mon_len,          <span class="comment">/* 设置gd-&gt;mon_len为编译出来的u-boot.bin+bss段的大小 */</span></span><br><span class="line">   fdtdec_setup,           <span class="comment">/* 和设备树有关 */</span></span><br><span class="line">   initf_malloc,           <span class="comment">/* 初始化并设置内存池 */</span></span><br><span class="line">   initf_console_record,   <span class="comment">/* 平台信息记录初始化 */</span></span><br><span class="line">   arch_cpu_init,                  <span class="comment">/* 空函数 */</span></span><br><span class="line">   mach_cpu_init,                  <span class="comment">/* 空函数 */</span></span><br><span class="line">   initf_dm,               <span class="comment">/* 驱动模型初始化 */</span></span><br><span class="line">   arch_cpu_init_dm,       <span class="comment">/* 空函数 */</span></span><br><span class="line">   mark_bootstage, 			<span class="comment">/* need timer, go after init dm */</span></span><br><span class="line">   board_early_init_f,     <span class="comment">/* 设置时钟和GPIO */</span></span><br><span class="line">   timer_init,                        <span class="comment">/* 定时器初始化 */</span></span><br><span class="line">   board_postclk_init,		<span class="comment">/* 设置VDDSOC电压 */</span></span><br><span class="line">   get_clocks,</span><br><span class="line">   env_init,                  <span class="comment">/* 找到最适合存放环境变量的地址，并初始化 */</span></span><br><span class="line">   init_baud_rate,              <span class="comment">/* 波特率初始化 */</span></span><br><span class="line">   serial_init,                    <span class="comment">/* 串口初始化 */</span></span><br><span class="line">   console_init_f,              <span class="comment">/* 使能在重定位之前用的串口功能 gd-&gt;have_console = 1 */</span></span><br><span class="line">   display_options,        <span class="comment">/* 显示banner，如u-boot版本、编译时间等信息 */</span></span><br><span class="line">   display_text_info,           <span class="comment">/* 显示调试信息 */</span></span><br><span class="line">   print_cpuinfo,                  <span class="comment">/* 显示cpu信息，如cpu速度 */</span></span><br><span class="line">   show_board_info,        <span class="comment">/* 显示板子信息 */</span></span><br><span class="line">   INIT_FUNC_WATCHDOG_INIT,</span><br><span class="line">   INIT_FUNC_WATCHDOG_RESET,</span><br><span class="line">   init_func_i2c,</span><br><span class="line">   announce_dram_init,     <span class="comment">/* 准备显示DRAM大小，在u-boot启动时可以看到DRAM大小的信息 */</span></span><br><span class="line">   dram_init,                         <span class="comment">/* DRAM初始化，对于本imx6ull设置dg-&gt;ram_size = 512 MiB */</span></span><br><span class="line">   setup_dest_addr,        <span class="comment">/* 设置重定位地址，gd-&gt;relocaddr = gd-&gt;ram_top */</span></span><br><span class="line">   reserve_round_4k,       <span class="comment">/* 4字节对齐，将内存指针调到下一个4 kB */</span></span><br><span class="line">   reserve_mmu,            <span class="comment">/* 为mmu区域腾出空间 */</span></span><br><span class="line">   reserve_video,          <span class="comment">/* 预留video显示内存 */</span></span><br><span class="line">   reserve_trace,</span><br><span class="line">   reserve_uboot,          <span class="comment">/* 预留U-Boot代码、data和bss区  */</span></span><br><span class="line">   reserve_malloc,         <span class="comment">/* 预留malloc区 */</span></span><br><span class="line">   reserve_board,          <span class="comment">/* 预留存放板子信息区 */</span></span><br><span class="line">   setup_machine,          <span class="comment">/* 板子ID，这里没有用到 */</span></span><br><span class="line">   reserve_global_data,    <span class="comment">/* 预留GD区域，栈gd-&gt;start_addr_sp指向gd段基地址*/</span></span><br><span class="line">   reserve_fdt,            <span class="comment">/* 预留设备树区域 */</span></span><br><span class="line">   reserve_bootstage,</span><br><span class="line">   reserve_bloblist,</span><br><span class="line">   reserve_arch,           <span class="comment">/* 架构相关预留区 */</span></span><br><span class="line">   reserve_stacks,         <span class="comment">/* 预留栈区，gd-&gt;start_addr_sp指向栈底基地址 */</span></span><br><span class="line">   setup_dram_config,     <span class="comment">/* DRAM的大小初始化 */</span></span><br><span class="line">   show_dram_config,       <span class="comment">/* 显示DRAM的配置 */</span></span><br><span class="line">   display_new_sp,         <span class="comment">/* 显示新的栈地址 */</span></span><br><span class="line">   reloc_fdt,              <span class="comment">/* 和设备树有关 */</span></span><br><span class="line">   reloc_bootstage,        <span class="comment">/* 和u-boot阶段有关 */</span></span><br><span class="line">   reloc_bloblist,         <span class="comment">/* 和blob列表有关 */</span></span><br><span class="line">   setup_reloc,            <span class="comment">/* 重定位 */</span></span><br><span class="line">   <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>setup_mon_len</code> 函数设置 gd 的 mon_len 成员变量为 <code>__bss_end - _start</code>，也就是整个 uboot 的大小，便于后续重定位 uboot。</li>
<li><code>initf_malloc</code> 函数初始化并设置内存池。</li>
<li><code>initf_console_record</code> 函数，IMX6ULL 的 uboot 没有定义宏 CONFIG_CONSOLE_RECORD，所以此函数直接返回 0。</li>
<li><code>board_early_init_f</code> 设置时钟和 GPIO。</li>
<li><code>timer_init</code> 定时器初始化。</li>
<li><code>get_clocks</code> 获取一些时钟值，imx6ull 获取的是 sdhc_clk 时钟—— SD 卡外设的时钟。</li>
<li><code>env_init</code> 设置 gd 的 env_addr 成员变量，即环境变量的保存地址。</li>
<li><code>init_baud_rate</code> 初始化波特率，根据环境变量 baudrate 来初始化 gd-&gt;baudrate。</li>
<li><code>serial_init</code> 串口初始化。</li>
<li><code>console_init_f</code> 设置 gd-&gt;have_console 为1，表示有个控制台，将前面暂存在缓冲区中的数据通过控制台打印出来。</li>
<li><code>display_options</code> 显示 banner，如 u-boot版本、编译时间等信息。</li>
<li><code> display_text_info</code>  显示调试信息。</li>
<li><code>print_cpuinfo</code> 显示cpu信息，如cpu速度。</li>
<li><code>show_board_info</code>  显示板子信息。</li>
<li><code>INIT_FUNC_WATCHDOG_INIT</code> 和 <code>INIT_FUNC_WATCHDOG_RESET</code> 用来初始化和复位看门狗，对于 imx6ull 为空函数。</li>
<li><code>announce_dram_init</code> 输出字符串 <code>DRAM:</code>。</li>
<li><code>dram_init</code> DRAM 初始化，设置 DDR 的大小。</li>
<li><code>setup_dest_add</code> <strong>设置重定位地址</strong>，gd-&gt;relocaddr = gd-&gt;ram_top。</li>
<li><code>reserve_round_4k </code>对 gd-&gt;relocaddr 做 4KB 对齐。</li>
<li><code>setup_machine</code> 设置机器ID，linux 启动的时候会和这个机器 ID 匹配，如果匹配的话 linux 就会启动正常。但是 I.MX6ULL 不用这种方式了，这是以前<strong>老版本的 uboot 和 linux 使用的</strong>，新版本使用设备树了，因此<strong>此函数无效</strong>。</li>
<li><code>setup_dram_config</code> 设置 gd-&gt;bd-&gt;bi_dram[0].start 和 gd-&gt;bd-&gt;bi_dram[0].size，<strong>告诉 Linux DRAM 的起始地址和大小</strong>。</li>
</ul>
<p>可以看出这个数组存放的一系列函数的主要工作：设置和初始化一些设备的信息（如 malloc 内存池大小、MMU、定时器、GPIO、DRAM 等）、打印设备的相关信息、提前保留一些设备的内存区域、设置重定位后一些重要的地址为接下来的重定位 uboot 做准备。简单来说就是内存分配的一些东西。</p>
<p><img src="image-20240802153258986.png" alt="image-20240802153258986"></p>
<h4 id="relocate-code-函数">relocate_code 函数</h4>
<p>relocate_code 函数在 <code>arch/arm/lib/relocate.S </code>文件中定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * void relocate_code(addr_moni)</span><br><span class="line"> *</span><br><span class="line"> * This function relocates the monitor code.</span><br><span class="line"> *</span><br><span class="line"> * NOTE:</span><br><span class="line"> * To prevent the code below from containing references with an R_ARM_ABS32</span><br><span class="line"> * relocation record type, we never refer to linker-defined symbols directly.</span><br><span class="line"> * Instead, we declare literals which contain their relative location with</span><br><span class="line"> * respect to relocate_code, and at run time, add relocate_code back to them.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">ENTRY(relocate_code)</span><br><span class="line">	ldr	r1, =__image_copy_start	/* r1 &lt;- SRC &amp;__image_copy_start */</span><br><span class="line">	subs	r4, r0, r1		/* r4 &lt;- relocation offset */</span><br><span class="line">	beq	relocate_done		/* skip relocation */</span><br><span class="line">	ldr	r2, =__image_copy_end	/* r2 &lt;- SRC &amp;__image_copy_end */</span><br><span class="line"></span><br><span class="line">copy_loop:</span><br><span class="line">	ldmia	r1!, &#123;r10-r11&#125;		/* copy from source address [r1]    */</span><br><span class="line">	stmia	r0!, &#123;r10-r11&#125;		/* copy to   target address [r0]    */</span><br><span class="line">	cmp	r1, r2			/* until source end address [r2]    */</span><br><span class="line">	blo	copy_loop</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * fix .rel.dyn relocations</span><br><span class="line">	 */</span><br><span class="line">	ldr	r2, =__rel_dyn_start	/* r2 &lt;- SRC &amp;__rel_dyn_start */</span><br><span class="line">	ldr	r3, =__rel_dyn_end	/* r3 &lt;- SRC &amp;__rel_dyn_end */</span><br><span class="line">fixloop:</span><br><span class="line">	ldmia	r2!, &#123;r0-r1&#125;		/* (r0,r1) &lt;- (SRC location,fixup) */</span><br><span class="line">	and	r1, r1, #0xff</span><br><span class="line">	cmp	r1, #R_ARM_RELATIVE</span><br><span class="line">	bne	fixnext</span><br><span class="line"></span><br><span class="line">	/* relative fix: increase location by offset */</span><br><span class="line">	add	r0, r0, r4</span><br><span class="line">	ldr	r1, [r0]</span><br><span class="line">	add	r1, r1, r4</span><br><span class="line">	str	r1, [r0]</span><br><span class="line">fixnext:</span><br><span class="line">	cmp	r2, r3</span><br><span class="line">	blo	fixloop</span><br><span class="line"></span><br><span class="line">relocate_done:</span><br><span class="line"></span><br><span class="line">#ifdef __XSCALE__</span><br><span class="line">	/*</span><br><span class="line">	 * On xscale, icache must be invalidated and write buffers drained,</span><br><span class="line">	 * even with cache disabled - 4.2.7 of xscale core developer&#x27;s manual</span><br><span class="line">	 */</span><br><span class="line">	mcr	p15, 0, r0, c7, c7, 0	/* invalidate icache */</span><br><span class="line">	mcr	p15, 0, r0, c7, c10, 4	/* drain write buffer */</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	/* ARMv4- don&#x27;t know bx lr but the assembler fails to see that */</span><br><span class="line"></span><br><span class="line">#ifdef __ARM_ARCH_4__</span><br><span class="line">	mov	pc, lr</span><br><span class="line">#else</span><br><span class="line">	bx	lr</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_code)</span><br></pre></td></tr></table></figure>
<p>r0 是传入参数为前面计算好的重定位后的目标地址 gd-&gt;relocaddr。</p>
<p>copy_loop 函数完成代码拷贝工作，从 <code>__image_copy_start</code> 地址开始到 <code> __image_copy_end</code> 地址的 uboot 代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">copy_loop:</span><br><span class="line">	ldmia	r1!, &#123;r10-r11&#125;		/* copy from source address [r1]    */</span><br><span class="line">	stmia	r0!, &#123;r10-r11&#125;		/* copy to   target address [r0]    */</span><br><span class="line">	cmp	r1, r2			/* until source end address [r2]    */</span><br><span class="line">	blo	copy_loop</span><br></pre></td></tr></table></figure>
<p>解析：将 r1 指向的地址加载数据寄存器 r10 和 r11，再将数据存放到 r0，比较 r1 和 r2 的地址，r1 &lt; r2 则继续循环，其中感叹号 ! 表示指向完该指令后地址会自增。</p>
<p>fixloop 函数是重定位 .rel_dyn 段，.rel_dyn 段是存放 .text 段中需要重定位地址的集合。重定位就是 uboot 将自身拷贝到 DRAM 的另一个地址去继续运行(DRAM 的高地址处)。</p>
<h4 id="relocate-vectors-函数">relocate_vectors 函数</h4>
<p>relocate_vectors 函数在 <code>arch/arm/lib/relocate.S </code>文件中定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(relocate_vectors)</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_CPU_V7M</span><br><span class="line">	/*</span><br><span class="line">	 * On ARMv7-M we only have to write the new vector address</span><br><span class="line">	 * to VTOR register.</span><br><span class="line">	 */</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]	/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	ldr	r1, =V7M_SCB_BASE</span><br><span class="line">	str	r0, [r1, V7M_SCB_VTOR]</span><br><span class="line">#else</span><br><span class="line">#ifdef CONFIG_HAS_VBAR</span><br><span class="line">	/*</span><br><span class="line">	 * If the ARM processor has the security extensions,</span><br><span class="line">	 * use VBAR to relocate the exception vectors.</span><br><span class="line">	 */</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]	/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	mcr     p15, 0, r0, c12, c0, 0  /* Set VBAR */</span><br><span class="line">#else</span><br><span class="line">	/*</span><br><span class="line">	 * Copy the relocated exception vectors to the</span><br><span class="line">	 * correct address</span><br><span class="line">	 * CP15 c1 V bit gives us the location of the vectors:</span><br><span class="line">	 * 0x00000000 or 0xFFFF0000.</span><br><span class="line">	 */</span><br><span class="line">	ldr	r0, [r9, #GD_RELOCADDR]	/* r0 = gd-&gt;relocaddr */</span><br><span class="line">	mrc	p15, 0, r2, c1, c0, 0	/* V bit (bit[13]) in CP15 c1 */</span><br><span class="line">	ands	r2, r2, #(1 &lt;&lt; 13)</span><br><span class="line">	ldreq	r1, =0x00000000		/* If V=0 */</span><br><span class="line">	ldrne	r1, =0xFFFF0000		/* If V=1 */</span><br><span class="line">	ldmia	r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">	stmia	r1!, &#123;r2-r8,r10&#125;</span><br><span class="line">	ldmia	r0!, &#123;r2-r8,r10&#125;</span><br><span class="line">	stmia	r1!, &#123;r2-r8,r10&#125;</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line">	bx	lr</span><br><span class="line"></span><br><span class="line">ENDPROC(relocate_vectors)</span><br></pre></td></tr></table></figure>
<p>该函数主要工作就是<strong>实现异常向量表的重定位，拷贝到正确的地址中</strong>。Cortex-A7 是支持向量表偏移的，需要将新的向量表首地址写入到寄存器 VBAR 中，设置向量表偏移。</p>
<h4 id="board-init-r-函数">board_init_r 函数</h4>
<p>board_init_r 函数在 <code>common/board_r.c</code> 文件中定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">void board_init_r(gd_t *new_gd, ulong dest_addr)</span><br><span class="line">&#123;</span><br><span class="line">	/*</span><br><span class="line">	 * Set up the new global data pointer. So far only x86 does this</span><br><span class="line">	 * here.</span><br><span class="line">	 * TODO(sjg@chromium.org): Consider doing this for all archs, or</span><br><span class="line">	 * dropping the new_gd parameter.</span><br><span class="line">	 */</span><br><span class="line">#if CONFIG_IS_ENABLED(X86_64)</span><br><span class="line">	arch_setup_gd(new_gd);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_NEEDS_MANUAL_RELOC</span><br><span class="line">	int i;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_AVR32</span><br><span class="line">	mmu_init_r(dest_addr);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if !defined(CONFIG_X86) &amp;&amp; !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_ARM64)</span><br><span class="line">	gd = new_gd;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_NEEDS_MANUAL_RELOC</span><br><span class="line">	for (i = 0; i &lt; ARRAY_SIZE(init_sequence_r); i++)</span><br><span class="line">		init_sequence_r[i] += gd-&gt;reloc_off;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	if (initcall_run_list(init_sequence_r))</span><br><span class="line">		hang();</span><br><span class="line"></span><br><span class="line">	/* NOTREACHED - run_main_loop() does not return */</span><br><span class="line">	hang();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断板子使用的架构，最后使用 initcall_run_list 函数来执行初始化序列 init_sequence_r。</p>
<p>init_sequence_r 序列在文件 <code>common/board_r.c</code> 中定义：去除一些条件编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Over time we hope to remove these functions with code fragments and</span></span><br><span class="line"><span class="comment"> * stub funtcions, and instead call the relevant function directly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We also hope to remove most of the driver-related init and do it if/when</span></span><br><span class="line"><span class="comment"> * the driver is later used.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span> perhaps reset the watchdog in the initcall function after each call?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">init_fnc_t</span> init_sequence_r[] = &#123;</span><br><span class="line">   initr_trace,               <span class="comment">/* 初始化与跟踪调试相关部分 */</span></span><br><span class="line">   initr_reloc,               <span class="comment">/* 标记重定位完成 */</span></span><br><span class="line">   initr_caches,              <span class="comment">/* 使能cache */</span></span><br><span class="line">   initr_reloc_global_data,   <span class="comment">/* 初始化重定位后的gd成员 */</span></span><br><span class="line">   initr_barrier,             <span class="comment">/* imx6ull未用到 */</span></span><br><span class="line">   initr_malloc,              <span class="comment">/* 初始化malloc */</span></span><br><span class="line">   log_init,                  <span class="comment">/* log初始化 */</span></span><br><span class="line">   initr_bootstage,  <span class="comment">/* Needs malloc() but has its own timer */</span></span><br><span class="line">   initr_console_record,      <span class="comment">/* 初始化控台 */</span></span><br><span class="line">   bootstage_relocate,</span><br><span class="line">   initr_dm,                  <span class="comment">/* 设备模型初始化 */</span></span><br><span class="line">   board_init,                <span class="comment">/* 板级初始化 */</span></span><br><span class="line">   efi_memory_init,           <span class="comment">/* efi_memory初始化 */</span></span><br><span class="line">   stdio_init_tables,         <span class="comment">/* 标准输入输出及标准错误等初始化 */</span></span><br><span class="line">   initr_serial,              <span class="comment">/* 串口初始化 */</span></span><br><span class="line">   initr_announce,            <span class="comment">/* 跟调试相关 */</span></span><br><span class="line">   power_init_board,          <span class="comment">/* 电源芯片初始化 */</span></span><br><span class="line">   initr_nand,                <span class="comment">/* nandflash初始化 */</span></span><br><span class="line">   initr_mmc,                 <span class="comment">/* mmc初始化 */</span></span><br><span class="line">   initr_env,                 <span class="comment">/* 环境变量初始化 */</span></span><br><span class="line">   initr_secondary_cpu,       <span class="comment">/* 其他cpu初始化，由于imx6ull为单核cpu故忽略 */</span></span><br><span class="line">   stdio_add_devices,         <span class="comment">/* 输入输出设备初始化 */</span></span><br><span class="line">   initr_jumptable,           <span class="comment">/* 初始化跳转表 */</span></span><br><span class="line">   console_init_r,                 <span class="comment">/* 控制台初始化 */</span></span><br><span class="line">   interrupt_init,            <span class="comment">/* 中断初始化 */</span></span><br><span class="line">   initr_enable_interrupts,   <span class="comment">/* 中断使能 */</span></span><br><span class="line">   <span class="comment">/* PPC has a udelay(20) here dating from 2002. Why? */</span></span><br><span class="line">   initr_ethaddr,             <span class="comment">/* 网络初始化 */</span></span><br><span class="line">   board_late_init,           <span class="comment">/* 板子后续初始化 */</span></span><br><span class="line">   initr_fastboot_setup,</span><br><span class="line">   initr_net,                 <span class="comment">/* 网络初始化 */</span></span><br><span class="line">   initr_check_fastboot,</span><br><span class="line">   run_main_loop,             <span class="comment">/* 运行主循环 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="run-main-loop-函数">run_main_loop 函数</h4>
<p>run_main_loop 函数在文件 <code>common/board_r.c</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">run_main_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SANDBOX</span></span><br><span class="line">	sandbox_main_loop_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* main_loop() can return to retry autoboot, if so just run it again */</span></span><br><span class="line">	<span class="keyword">for</span> (;;)</span><br><span class="line">		main_loop();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一个死循环，如果 main_loop 中启动不成功，就会不断重新启动。</p>
<p>main_loop 函数在文件 <code>common/main.c</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We come here after U-Boot is initialised and ready to process commands */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *s;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 打印启动进度</span></span><br><span class="line">	bootstage_mark_name(BOOTSTAGE_ID_MAIN_LOOP, <span class="string">&quot;main_loop&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印uboot版本号</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_VERSION_VARIABLE</span></span><br><span class="line">	setenv(<span class="string">&quot;ver&quot;</span>, version_string);  <span class="comment">/* set version variable */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_VERSION_VARIABLE */</span></span></span><br><span class="line"></span><br><span class="line">	cli_init();</span><br><span class="line"></span><br><span class="line">	run_preboot_environment_command();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_UPDATE_TFTP)</span></span><br><span class="line">	update_tftp(<span class="number">0UL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_UPDATE_TFTP */</span></span></span><br><span class="line"></span><br><span class="line">	s = bootdelay_process();</span><br><span class="line">	<span class="keyword">if</span> (cli_process_fdt(&amp;s))</span><br><span class="line">		cli_secure_boot_cmd(s);</span><br><span class="line"></span><br><span class="line">	autoboot_command(s);</span><br><span class="line"></span><br><span class="line">	cli_loop();</span><br><span class="line">	panic(<span class="string">&quot;No CLI available&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>cli_init 函数，跟命令初始化有关，初始化 hush shell 相关的变量。</li>
<li>run_preboot_environment_command 函数，获取环境变量 perboot 的内容，perboot 是一些预启动命令，一般不使用这个环境变量。</li>
<li>bootdelay_process 函数，此函数会读取环境变量 bootdelay 和 bootcmd 的内容，然后将 bootdelay 的值赋值给全局变量 stored_bootdelay，返回值为环境变量 bootcmd 的值。</li>
<li>autoboot_command 函数，此函数就是检查倒计时是否结束？倒计时结束之前有没有被打断？</li>
</ul>
<p>autoboot_command 函数在 <code>common/autoboot.c</code> 文件中定义：去除条件编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">autoboot_command</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span></span><br><span class="line">&#123;</span><br><span class="line">	debug(<span class="string">&quot;### main_loop: bootcmd=\&quot;%s\&quot;\n&quot;</span>, s ? s : <span class="string">&quot;&lt;UNDEFINED&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (stored_bootdelay != <span class="number">-1</span> &amp;&amp; s &amp;&amp; !abortboot(stored_bootdelay)) &#123;</span><br><span class="line">		run_command_list(s, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>条件主要看最后一个，abortboot 函数在 <code>common/autoboot.c</code> 文件中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">abortboot</span><span class="params">(<span class="type">int</span> bootdelay)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> <span class="built_in">abort</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bootdelay &gt;= <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">abort</span> = __abortboot(bootdelay);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SILENT_CONSOLE</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">abort</span>)</span><br><span class="line">		gd-&gt;flags &amp;= ~GD_FLG_SILENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">abort</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>__abortboot 函数也在该文件中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __abortboot(<span class="type">int</span> bootdelay)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> <span class="built_in">abort</span> = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ts;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Hit any key to stop autoboot: %2d &quot;</span>, bootdelay);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Check if key already pressed</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (tstc()) &#123;	<span class="comment">/* we got a key press	*/</span></span><br><span class="line">		(<span class="type">void</span>) getc();  <span class="comment">/* consume input	*/</span></span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;\b\b\b 0&quot;</span>);</span><br><span class="line">		<span class="built_in">abort</span> = <span class="number">1</span>;	<span class="comment">/* don&#x27;t auto boot	*/</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((bootdelay &gt; <span class="number">0</span>) &amp;&amp; (!<span class="built_in">abort</span>)) &#123;</span><br><span class="line">		--bootdelay;</span><br><span class="line">		<span class="comment">/* delay 1000 ms */</span></span><br><span class="line">		ts = get_timer(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (tstc()) &#123;	<span class="comment">/* we got a key press	*/</span></span><br><span class="line">				<span class="built_in">abort</span>  = <span class="number">1</span>;	<span class="comment">/* don&#x27;t auto boot	*/</span></span><br><span class="line">				bootdelay = <span class="number">0</span>;	<span class="comment">/* no more delay	*/</span></span><br><span class="line">				(<span class="type">void</span>) getc();  <span class="comment">/* consume input	*/</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			udelay(<span class="number">10000</span>);</span><br><span class="line">		&#125; <span class="keyword">while</span> (!<span class="built_in">abort</span> &amp;&amp; get_timer(ts) &lt; <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\b\b\b%2d &quot;</span>, bootdelay);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	putc(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">abort</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码主要工作就是判断键盘是否有按下，按下就设置 abort 为 1，bootdelay 为 0，并跳出循环返回 abort 为 1；若 bootdelay 自然减到 0 也会退出，返回 abort，此时为 0。</p>
<p>回到 autoboot_command 函数中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">autoboot_command</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span></span><br><span class="line">&#123;</span><br><span class="line">	debug(<span class="string">&quot;### main_loop: bootcmd=\&quot;%s\&quot;\n&quot;</span>, s ? s : <span class="string">&quot;&lt;UNDEFINED&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (stored_bootdelay != <span class="number">-1</span> &amp;&amp; s &amp;&amp; !abortboot(stored_bootdelay)) &#123;</span><br><span class="line">		run_command_list(s, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 abort 为 0 即倒计时为自然结束，条件成立，执行函数 run_command_list，会执行参数 s 指定的一系列命令——环境变量 bootcmd 的命令，bootcmd 保存默认的启动命令，接着就会启动 linux 内核。</li>
<li>如果 abort 为 1 即在倒计时结束前按下了键盘的按键，条件不成立，autoboot_command 相当于空函数。</li>
</ul>
<p>再往回到 main_loop 函数中，倒计时结束前按下键盘的按键，就会执行 cli_loop 函数——命令处理函数，负责接收好处理输入的命令。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">cli_loop</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HUSH_PARSER</span></span><br><span class="line">	parse_file_outer();</span><br><span class="line">	<span class="comment">/* This point is never reached */</span></span><br><span class="line">	<span class="keyword">for</span> (;;);</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_CMDLINE)</span></span><br><span class="line">	cli_simple_loop();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;## U-Boot command line is disabled. Please enable CONFIG_CMDLINE\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/*CONFIG_HUSH_PARSER*/</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CONFIG_HUSH_PARSER 在 <code>include/generated/autoconf.h</code> 文件中有定义。</p>
<p>parse_file_outer 函数在 <code>common/cli_hush.c</code> 文件中定义：去除条件编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">parse_file_outer</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> rcode;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">in_str</span> <span class="title">input</span>;</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 初始化input成员变量</span></span><br><span class="line">	setup_file_in_str(&amp;input);</span><br><span class="line">	rcode = parse_stream_outer(&amp;input, FLAG_PARSE_SEMICOLON);</span><br><span class="line">	<span class="keyword">return</span> rcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>parse_stream_outer 函数是 hush shell 的命令解释器，负责接收命令行输入，然后解析并执行相应的命令，该函数也在该文件下定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* most recursion does not come through here, the exeception is</span></span><br><span class="line"><span class="comment"> * from builtin_source() */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">parse_stream_outer</span><span class="params">(<span class="keyword">struct</span> in_str *inp, <span class="type">int</span> flag)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">p_context</span> <span class="title">ctx</span>;</span></span><br><span class="line">	o_string temp=NULL_O_STRING;</span><br><span class="line">	<span class="type">int</span> rcode;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __U_BOOT__</span></span><br><span class="line">	<span class="type">int</span> code = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		ctx.type = flag;</span><br><span class="line">		initialize_context(&amp;ctx);</span><br><span class="line">		update_ifs_map();</span><br><span class="line">		<span class="keyword">if</span> (!(flag &amp; FLAG_PARSE_SEMICOLON) || (flag &amp; FLAG_REPARSING)) mapset((uchar *)<span class="string">&quot;;$&amp;|&quot;</span>, <span class="number">0</span>);</span><br><span class="line">		inp-&gt;promptmode=<span class="number">1</span>;</span><br><span class="line">		rcode = parse_stream(&amp;temp, &amp;ctx, inp,</span><br><span class="line">				     flag &amp; FLAG_CONT_ON_NEWLINE ? <span class="number">-1</span> : <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __U_BOOT__</span></span><br><span class="line">		<span class="keyword">if</span> (rcode == <span class="number">1</span>) flag_repeat = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">if</span> (rcode != <span class="number">1</span> &amp;&amp; ctx.old_flag != <span class="number">0</span>) &#123;</span><br><span class="line">			syntax();</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __U_BOOT__</span></span><br><span class="line">			flag_repeat = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (rcode != <span class="number">1</span> &amp;&amp; ctx.old_flag == <span class="number">0</span>) &#123;</span><br><span class="line">			done_word(&amp;temp, &amp;ctx);</span><br><span class="line">			done_pipe(&amp;ctx,PIPE_SEQ);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __U_BOOT__</span></span><br><span class="line">			run_list(ctx.list_head);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">			code = run_list(ctx.list_head);</span><br><span class="line">			<span class="keyword">if</span> (code == <span class="number">-2</span>) &#123;	<span class="comment">/* exit */</span></span><br><span class="line">				b_free(&amp;temp);</span><br><span class="line">				code = <span class="number">0</span>;</span><br><span class="line">				<span class="comment">/* XXX hackish way to not allow exit from main loop */</span></span><br><span class="line">				<span class="keyword">if</span> (inp-&gt;peek == file_peek) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;exit not allowed from main input shell.\n&quot;</span>);</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (code == <span class="number">-1</span>)</span><br><span class="line">			    flag_repeat = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (ctx.old_flag != <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">free</span>(ctx.<span class="built_in">stack</span>);</span><br><span class="line">				b_reset(&amp;temp);</span><br><span class="line">			&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __U_BOOT__</span></span><br><span class="line">			<span class="keyword">if</span> (inp-&gt;__promptme == <span class="number">0</span>) <span class="built_in">printf</span>(<span class="string">&quot;&lt;INTERRUPT&gt;\n&quot;</span>);</span><br><span class="line">			inp-&gt;__promptme = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">			temp.nonnull = <span class="number">0</span>;</span><br><span class="line">			temp.quote = <span class="number">0</span>;</span><br><span class="line">			inp-&gt;p = <span class="literal">NULL</span>;</span><br><span class="line">			free_pipe_list(ctx.list_head,<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		b_free(&amp;temp);</span><br><span class="line">	<span class="comment">/* loop on syntax errors, return on EOF */</span></span><br><span class="line">	&#125; <span class="keyword">while</span> (rcode != <span class="number">-1</span> &amp;&amp; !(flag &amp; FLAG_EXIT_FROM_LOOP) &amp;&amp;</span><br><span class="line">		(inp-&gt;peek != static_peek || b_peek(inp)));</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __U_BOOT__</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> (code != <span class="number">0</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __U_BOOT__ */</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="command-process-函数">command_process 函数</h4>
<p>uboot 中使用 U_BOOT_CMD 来定义一个命令，最终的目的就是为了定义一个 cmd_tbl_t 类型的变量，并初始化这个变量的各个成员。uboot 中的每个命令都存储在 .u_boot_list 段中，每个命令都有一个名为 do_xxx(xxx 为具体的命令名)的函数，这个 do_xxx 函数就是具体的命令处理函数。</p>
<h2 id="u-boot-启动-linux-内核过程">U-Boot 启动 Linux 内核过程</h2>
<p>U-Boot 启动 Linux 内核有 bootz 和 bootm 两种方法，这里只介绍 bootz。</p>
<p>bootz 和 bootm 命令都用到了一个重要的全局变量：images，在文件 <code>cmd/bootm.c</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bootm_headers_t</span> images; <span class="comment">/* pointers to os/initrd/fdt images */</span></span><br></pre></td></tr></table></figure>
<p>bootm_headers_t 结构体在文件 <code>include/images.h</code> 中定义：去除条件编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Legacy and FIT format headers used by do_bootm() and do_bootm_&lt;os&gt;()</span></span><br><span class="line"><span class="comment"> * routines.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">bootm_headers</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Legacy os image header, if it is a multi component image</span></span><br><span class="line"><span class="comment">	 * then boot_get_ramdisk() and get_fdt() will attempt to get</span></span><br><span class="line"><span class="comment">	 * data from second and third component accordingly.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">image_header_t</span>	*legacy_hdr_os;		<span class="comment">/* image header pointer */</span></span><br><span class="line">	<span class="type">image_header_t</span>	legacy_hdr_os_copy;	<span class="comment">/* header copy */</span></span><br><span class="line">	ulong		legacy_hdr_valid;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> USE_HOSTCC</span></span><br><span class="line">	<span class="type">image_info_t</span>	os;		<span class="comment">/* os image info */</span></span><br><span class="line">	ulong		ep;		<span class="comment">/* entry point of OS */</span></span><br><span class="line"></span><br><span class="line">	ulong		rd_start, rd_end;<span class="comment">/* ramdisk start/end */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">char</span>		*ft_addr;	<span class="comment">/* flat dev tree address */</span></span><br><span class="line">	ulong		ft_len;		<span class="comment">/* length of flat device tree */</span></span><br><span class="line"></span><br><span class="line">	ulong		initrd_start;</span><br><span class="line">	ulong		initrd_end;</span><br><span class="line">	ulong		cmdline_start;</span><br><span class="line">	ulong		cmdline_end;</span><br><span class="line">	<span class="type">bd_t</span>		*kbd;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span>		verify;		<span class="comment">/* getenv(&quot;verify&quot;)[0] != &#x27;n&#x27; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_START	(0x00000001)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_FINDOS	(0x00000002)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_FINDOTHER	(0x00000004)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_LOADOS	(0x00000008)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_RAMDISK	(0x00000010)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_FDT		(0x00000020)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_OS_CMDLINE	(0x00000040)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_OS_BD_T	(0x00000080)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_OS_PREP	(0x00000100)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_OS_FAKE_GO	(0x00000200)	<span class="comment">/* &#x27;Almost&#x27; run the OS */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	BOOTM_STATE_OS_GO	(0x00000400)</span></span><br><span class="line">	<span class="type">int</span>		state;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LMB</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lmb</span>	<span class="title">lmb</span>;</span>		<span class="comment">/* for memory mgmt */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; <span class="type">bootm_headers_t</span>;</span><br></pre></td></tr></table></figure>
<p>其中 BOOTM_STATE_ 开头的宏定义为 boot 的不同阶段。</p>
<p>image_info_t 类型为<strong>系统镜像信息结构体</strong>，在文件 <code>include/image.h</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">image_info</span> &#123;</span></span><br><span class="line">	ulong		start, end;		<span class="comment">/* start/end of blob */</span></span><br><span class="line">	ulong		image_start, image_len; <span class="comment">/* start of image within blob, len of image */</span></span><br><span class="line">	ulong		load;			<span class="comment">/* load addr for the image */</span></span><br><span class="line">	<span class="type">uint8_t</span>		comp, type, os;		<span class="comment">/* compression, type of image, os type */</span></span><br><span class="line">	<span class="type">uint8_t</span>		arch;			<span class="comment">/* CPU architecture */</span></span><br><span class="line">&#125; <span class="type">image_info_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="bootz-启动-linux-内核过程">bootz 启动 Linux 内核过程</h3>
<h4 id="do-bootz-函数">do_bootz 函数</h4>
<p>bootz 命令的执行函数为 do_bootz ，在文件 <code>cmd/bootz.c</code> 或者 <code>cmd/bootm.c</code> 中定义：去除条件编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">do_bootz</span><span class="params">(<span class="type">cmd_tbl_t</span> *cmdtp, <span class="type">int</span> flag, <span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Consume &#x27;bootz&#x27; */</span></span><br><span class="line">	argc--; argv++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bootz_start(cmdtp, flag, argc, argv, &amp;images))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We are doing the BOOTM_STATE_LOADOS state ourselves, so must</span></span><br><span class="line"><span class="comment">	 * disable interrupts ourselves</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	bootm_disable_interrupts();</span><br><span class="line"></span><br><span class="line">	images.os.os = IH_OS_LINUX;</span><br><span class="line">	ret = do_bootm_states(cmdtp, flag, argc, argv,</span><br><span class="line">			      BOOTM_STATE_OS_PREP | BOOTM_STATE_OS_FAKE_GO |</span><br><span class="line">			      BOOTM_STATE_OS_GO,</span><br><span class="line">			      &amp;images, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>调用 bootz_start 函数，后续分析。</p>
</li>
<li>
<p>调用 bootm_disable_interrupts 函数关闭中断。</p>
</li>
<li>
<p>设置 images.os.os 为 IH_OS_LINUX，也就是<strong>设置系统镜像为 Linux</strong>，<strong>表示我们要启动的是 Linux 系统</strong>！</p>
</li>
<li>
<p>调用 do_bootm_states 函数执行 boot 阶段三个阶段：BOOTM_STATE_OS_PREP、BOOTM_STATE_OS_FAKE_GO 和 BOOTM_STATE_OS_GO。</p>
</li>
</ul>
<h4 id="bootz-start-函数">bootz_start 函数</h4>
<p>bootz_start 函数在文件 <code>cmd/bootz.c</code> 或者 <code>cmd/bootm.c</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * zImage booting support</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bootz_start</span><span class="params">(<span class="type">cmd_tbl_t</span> *cmdtp, <span class="type">int</span> flag, <span class="type">int</span> argc,</span></span><br><span class="line"><span class="params">			<span class="type">char</span> * <span class="type">const</span> argv[], <span class="type">bootm_headers_t</span> *images)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	ulong zi_start, zi_end;</span><br><span class="line"></span><br><span class="line">	ret = do_bootm_states(cmdtp, flag, argc, argv, BOOTM_STATE_START,</span><br><span class="line">			      images, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Setup Linux kernel zImage entry point */</span></span><br><span class="line">	<span class="keyword">if</span> (!argc) &#123;</span><br><span class="line">		images-&gt;ep = load_addr;</span><br><span class="line">		debug(<span class="string">&quot;*  kernel: default image load address = 0x%08lx\n&quot;</span>,</span><br><span class="line">				load_addr);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		images-&gt;ep = simple_strtoul(argv[<span class="number">0</span>], <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">		debug(<span class="string">&quot;*  kernel: cmdline image address = 0x%08lx\n&quot;</span>,</span><br><span class="line">			images-&gt;ep);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = bootz_setup(images-&gt;ep, &amp;zi_start, &amp;zi_end);</span><br><span class="line">	<span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	lmb_reserve(&amp;images-&gt;lmb, images-&gt;ep, zi_end - zi_start);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Handle the BOOTM_STATE_FINDOTHER state ourselves as we do not</span></span><br><span class="line"><span class="comment">	 * have a header that provide this informaiton.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (bootm_find_images(flag, argc, argv))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用函数 do_bootm_states，执行 BOOTM_STATE_START 阶段。</li>
<li>设置 images 的 ep 成员变量，也就是<strong>系统镜像的入口点</strong>，使用 bootz 命令启动系统的时候就会<strong>设置系统在 DRAM 中的存储位置</strong>，这个<strong>存储位置就是系统镜像的入口点</strong>，因此 <strong>images-&gt;ep=0X80800000</strong>。</li>
<li>调用 bootz_setup 函数，此函数会<strong>判断当前的系统镜像文件是否为 Linux 的镜像文件，并且会打印出镜像相关信息</strong>。</li>
<li>调用函数 bootm_find_images 查找 ramdisk 和设备树(dtb)文件，但是没有用到 ramdisk，所以仅仅是查找设备树文件。</li>
</ul>
<h4 id="bootz-setup-函数">bootz_setup 函数</h4>
<p>bootz_setup 函数在文件 <code>arch/arm/lib/bootm.c</code> 中定义：去除条件编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">bootz_setup</span><span class="params">(ulong image, ulong *start, ulong *end)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">arm_z_header</span> *<span class="title">zi</span> =</span> (<span class="keyword">struct</span> arm_z_header *)image;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (zi-&gt;zi_magic != LINUX_ARM_ZIMAGE_MAGIC) &#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Bad Linux ARM zImage magic!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*start = zi-&gt;zi_start;</span><br><span class="line">	*end = zi-&gt;zi_end;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Kernel image @ %#08lx [ %#08lx - %#08lx ]\n&quot;</span>,</span><br><span class="line">	       image, *start, *end);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>宏 LINUX_ARM_ZIMAGE_MAGIC 是 ARM Linux 系统魔术数/幻数，linux 内核镜像文件 zImage 的魔术数/幻数为 0x016f2818，在第 36 个字节处。</p>
<blockquote>
<p>系统的魔术数通常指的是文件系统中的文件类型标识符，它用于识别文件的类型，比如是可执行文件、脚本文件、库文件等。在 Linux系统中，这些魔术数通常存储在文件的头部，由文件系统或程序用来确定文件的类型。</p>
</blockquote>
<p>该函数通过传递进来的 image，即系统镜像地址中获取 zImage 头，接着根据结构体中的魔术数判断是否为 Linux 系统镜像，不是就直接返回，打印 <code>Bad Linux ARM zImage magic!</code>；如果是就初始化参数 start 和 end，并打印启动信息。</p>
<h4 id="bootm-find-images-函数">bootm_find_images 函数</h4>
<p>bootm_find_images 函数在文件 <code>common/bootm.c</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * bootm_find_images - wrapper to find and locate various images</span></span><br><span class="line"><span class="comment"> * @flag: Ignored Argument</span></span><br><span class="line"><span class="comment"> * @argc: command argument count</span></span><br><span class="line"><span class="comment"> * @argv: command argument list</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * boot_find_images() will attempt to load an available ramdisk,</span></span><br><span class="line"><span class="comment"> * flattened device tree, as well as specifically marked</span></span><br><span class="line"><span class="comment"> * &quot;loadable&quot; images (loadables are FIT only)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note: bootm_find_images will skip an image if it is not found</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return:</span></span><br><span class="line"><span class="comment"> *     0, if all existing images were loaded correctly</span></span><br><span class="line"><span class="comment"> *     1, if an image is found but corrupted, or invalid</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bootm_find_images</span><span class="params">(<span class="type">int</span> flag, <span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* find ramdisk */</span></span><br><span class="line">	ret = boot_get_ramdisk(argc, argv, &amp;images, IH_INITRD_ARCH,</span><br><span class="line">			       &amp;images.rd_start, &amp;images.rd_end);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Ramdisk image is corrupt or invalid\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> IMAGE_ENABLE_OF_LIBFDT</span></span><br><span class="line">	<span class="comment">/* find flattened device tree */</span></span><br><span class="line">	ret = boot_get_fdt(flag, argc, argv, IH_ARCH_DEFAULT, &amp;images,</span><br><span class="line">			   &amp;images.ft_addr, &amp;images.ft_len);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Could not find a valid device tree\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	set_working_fdt_addr((ulong)images.ft_addr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>boot_get_fdt 函数查找设备树文件并将设备树的起始地址和长度分别写入 images 的 ft_addr 和 ft_len 成员变量中。</p>
<h4 id="do-bootm-states-函数">do_bootm_states 函数</h4>
<p>do_bootm_states 函数在文件 <code>common/bootm.c</code> 中定义：去除条件编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Execute selected states of the bootm command.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note the arguments to this state must be the first argument, Any &#x27;bootm&#x27;</span></span><br><span class="line"><span class="comment"> * or sub-command arguments must have already been taken.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that if states contains more than one flag it MUST contain</span></span><br><span class="line"><span class="comment"> * BOOTM_STATE_START, since this handles and consumes the command line args.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Also note that aside from boot_os_fn functions and bootm_load_os no other</span></span><br><span class="line"><span class="comment"> * functions we store the return value of in &#x27;ret&#x27; may use a negative return</span></span><br><span class="line"><span class="comment"> * value, without special handling.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param cmdtp		Pointer to bootm command table entry</span></span><br><span class="line"><span class="comment"> * @param flag		Command flags (CMD_FLAG_...)</span></span><br><span class="line"><span class="comment"> * @param argc		Number of subcommand arguments (0 = no arguments)</span></span><br><span class="line"><span class="comment"> * @param argv		Arguments</span></span><br><span class="line"><span class="comment"> * @param states	Mask containing states to run (BOOTM_STATE_...)</span></span><br><span class="line"><span class="comment"> * @param images	Image header information</span></span><br><span class="line"><span class="comment"> * @param boot_progress 1 to show boot progress, 0 to not do this</span></span><br><span class="line"><span class="comment"> * @return 0 if ok, something else on error. Some errors will cause this</span></span><br><span class="line"><span class="comment"> *	function to perform a reboot! If states contains BOOTM_STATE_OS_GO</span></span><br><span class="line"><span class="comment"> *	then the intent is to boot an OS, so this function will not return</span></span><br><span class="line"><span class="comment"> *	unless the image type is standalone.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">do_bootm_states</span><span class="params">(<span class="type">cmd_tbl_t</span> *cmdtp, <span class="type">int</span> flag, <span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[],</span></span><br><span class="line"><span class="params">		    <span class="type">int</span> states, <span class="type">bootm_headers_t</span> *images, <span class="type">int</span> boot_progress)</span></span><br><span class="line">&#123;</span><br><span class="line">	boot_os_fn *boot_fn;</span><br><span class="line">	ulong iflag = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>, need_boot_fn;</span><br><span class="line"></span><br><span class="line">	images-&gt;state |= states;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Work through the states and see how far we get. We stop on</span></span><br><span class="line"><span class="comment">	 * any error.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (states &amp; BOOTM_STATE_START)</span><br><span class="line">		ret = bootm_start(cmdtp, flag, argc, argv);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_FINDOS))</span><br><span class="line">		ret = bootm_find_os(cmdtp, flag, argc, argv);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_FINDOTHER))</span><br><span class="line">		ret = bootm_find_other(cmdtp, flag, argc, argv);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Load the OS */</span></span><br><span class="line">	<span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_LOADOS)) &#123;</span><br><span class="line">		ulong load_end;</span><br><span class="line"></span><br><span class="line">		iflag = bootm_disable_interrupts();</span><br><span class="line">		ret = bootm_load_os(images, &amp;load_end, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">			lmb_reserve(&amp;images-&gt;lmb, images-&gt;os.load,</span><br><span class="line">				    (load_end - images-&gt;os.load));</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret &amp;&amp; ret != BOOTM_ERR_OVERLAP)</span><br><span class="line">			<span class="keyword">goto</span> err;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret == BOOTM_ERR_OVERLAP)</span><br><span class="line">			ret = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> IMAGE_ENABLE_OF_LIBFDT &amp;&amp; defined(CONFIG_LMB)</span></span><br><span class="line">	<span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_FDT)) &#123;</span><br><span class="line">		boot_fdt_add_mem_rsv_regions(&amp;images-&gt;lmb, images-&gt;ft_addr);</span><br><span class="line">		ret = boot_relocate_fdt(&amp;images-&gt;lmb, &amp;images-&gt;ft_addr,</span><br><span class="line">					&amp;images-&gt;ft_len);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* From now on, we need the OS boot function */</span></span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	boot_fn = bootm_os_get_boot_func(images-&gt;os.os);</span><br><span class="line">	need_boot_fn = states &amp; (BOOTM_STATE_OS_CMDLINE |</span><br><span class="line">			BOOTM_STATE_OS_BD_T | BOOTM_STATE_OS_PREP |</span><br><span class="line">			BOOTM_STATE_OS_FAKE_GO | BOOTM_STATE_OS_GO);</span><br><span class="line">	<span class="keyword">if</span> (boot_fn == <span class="literal">NULL</span> &amp;&amp; need_boot_fn) &#123;</span><br><span class="line">		<span class="keyword">if</span> (iflag)</span><br><span class="line">			enable_interrupts();</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ERROR: booting os &#x27;%s&#x27; (%d) is not supported\n&quot;</span>,</span><br><span class="line">		       genimg_get_os_name(images-&gt;os.os), images-&gt;os.os);</span><br><span class="line">		bootstage_error(BOOTSTAGE_ID_CHECK_BOOT_OS);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Call various other states that are not generally used */</span></span><br><span class="line">	<span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_OS_CMDLINE))</span><br><span class="line">		ret = boot_fn(BOOTM_STATE_OS_CMDLINE, argc, argv, images);</span><br><span class="line">	<span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_OS_BD_T))</span><br><span class="line">		ret = boot_fn(BOOTM_STATE_OS_BD_T, argc, argv, images);</span><br><span class="line">	<span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_OS_PREP)) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SILENT_CONSOLE) &amp;&amp; !defined(CONFIG_SILENT_U_BOOT_ONLY)</span></span><br><span class="line">		<span class="keyword">if</span> (images-&gt;os.os == IH_OS_LINUX)</span><br><span class="line">			fixup_silent_linux();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">		ret = boot_fn(BOOTM_STATE_OS_PREP, argc, argv, images);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TRACE</span></span><br><span class="line">	<span class="comment">/* Pretend to run the OS, then run a user command */</span></span><br><span class="line">	<span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_OS_FAKE_GO)) &#123;</span><br><span class="line">		<span class="type">char</span> *cmd_list = getenv(<span class="string">&quot;fakegocmd&quot;</span>);</span><br><span class="line"></span><br><span class="line">		ret = boot_selected_os(argc, argv, BOOTM_STATE_OS_FAKE_GO,</span><br><span class="line">				images, boot_fn);</span><br><span class="line">		<span class="keyword">if</span> (!ret &amp;&amp; cmd_list)</span><br><span class="line">			ret = run_command_list(cmd_list, <span class="number">-1</span>, flag);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Check for unsupported subcommand. */</span></span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;subcommand not supported\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now run the OS! We hope this doesn&#x27;t return */</span></span><br><span class="line">	<span class="keyword">if</span> (!ret &amp;&amp; (states &amp; BOOTM_STATE_OS_GO))</span><br><span class="line">		ret = boot_selected_os(argc, argv, BOOTM_STATE_OS_GO,</span><br><span class="line">				images, boot_fn);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Deal with any fallout */</span></span><br><span class="line">err:</span><br><span class="line">	<span class="keyword">if</span> (iflag)</span><br><span class="line">		enable_interrupts();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret == BOOTM_ERR_UNIMPLEMENTED)</span><br><span class="line">		bootstage_error(BOOTSTAGE_ID_DECOMP_UNIMPL);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (ret == BOOTM_ERR_RESET)</span><br><span class="line">		do_reset(cmdtp, flag, argc, argv);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据不同的 boot 状态执行不同的代码段。</p>
<h4 id="bootm-os-get-boot-func-函数">bootm_os_get_boot_func 函数</h4>
<p>其中 bootm_os_get_boot_func 函数是用来查找对应系统的启动函数，在文件 <code>common/bootm_os.c</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">boot_os_fn *<span class="title function_">bootm_os_get_boot_func</span><span class="params">(<span class="type">int</span> os)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">	<span class="type">static</span> <span class="type">bool</span> relocated;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!relocated) &#123;</span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* relocate boot function table */</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(boot_os); i++)</span><br><span class="line">			<span class="keyword">if</span> (boot_os[i] != <span class="literal">NULL</span>)</span><br><span class="line">				boot_os[i] += gd-&gt;reloc_off;</span><br><span class="line"></span><br><span class="line">		relocated = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> boot_os[os];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>条件编译：判断是否需要手动重定位，这里没有用到，所以直接返回 boot_os[os] ，**boot_os 数组存放着不同系统对应的启动函数，**在文件 <code>common/bootm_os.c</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> boot_os_fn *boot_os[] = &#123;</span><br><span class="line">	[IH_OS_U_BOOT] = do_bootm_standalone,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOTM_LINUX</span></span><br><span class="line">	[IH_OS_LINUX] = do_bootm_linux,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOTM_NETBSD</span></span><br><span class="line">	[IH_OS_NETBSD] = do_bootm_netbsd,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LYNXKDI</span></span><br><span class="line">	[IH_OS_LYNXOS] = do_bootm_lynxkdi,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOTM_RTEMS</span></span><br><span class="line">	[IH_OS_RTEMS] = do_bootm_rtems,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BOOTM_OSE)</span></span><br><span class="line">	[IH_OS_OSE] = do_bootm_ose,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BOOTM_PLAN9)</span></span><br><span class="line">	[IH_OS_PLAN9] = do_bootm_plan9,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_BOOTM_VXWORKS) &amp;&amp; \</span></span><br><span class="line"><span class="meta">	(defined(CONFIG_PPC) || defined(CONFIG_ARM))</span></span><br><span class="line">	[IH_OS_VXWORKS] = do_bootm_vxworks,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_ELF)</span></span><br><span class="line">	[IH_OS_QNX] = do_bootm_qnxelf,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_INTEGRITY</span></span><br><span class="line">	[IH_OS_INTEGRITY] = do_bootm_integrity,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOOTM_OPENRTOS</span></span><br><span class="line">	[IH_OS_OPENRTOS] = do_bootm_openrtos,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="do-bootm-linux-函数">do_bootm_linux 函数</h4>
<p>do_bootm_linux 函数在文件 <code>arch/arm/lib/bootm.c</code> 中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Main Entry point for arm bootm implementation</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Modeled after the powerpc implementation</span></span><br><span class="line"><span class="comment"> * DIFFERENCE: Instead of calling prep and go at the end</span></span><br><span class="line"><span class="comment"> * they are called if subcommand is equal 0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">do_bootm_linux</span><span class="params">(<span class="type">int</span> flag, <span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[],</span></span><br><span class="line"><span class="params">		   <span class="type">bootm_headers_t</span> *images)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* No need for those on ARM */</span></span><br><span class="line">	<span class="keyword">if</span> (flag &amp; BOOTM_STATE_OS_BD_T || flag &amp; BOOTM_STATE_OS_CMDLINE)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flag &amp; BOOTM_STATE_OS_PREP) &#123;</span><br><span class="line">		boot_prep_linux(images);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flag &amp; (BOOTM_STATE_OS_GO | BOOTM_STATE_OS_FAKE_GO)) &#123;</span><br><span class="line">		boot_jump_linux(images, flag);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	boot_prep_linux(images);</span><br><span class="line">	boot_jump_linux(images, flag);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>boot_selected_os 函数会将 flag 设置为 BOOTM_STATE_OS_GO，执行函数 boot_jump_linux 在文件<code>arch/arm/lib/bootm.c</code> 中定义：去除条件编译</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Subcommand: GO */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">boot_jump_linux</span><span class="params">(<span class="type">bootm_headers_t</span> *images, <span class="type">int</span> flag)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> machid = gd-&gt;bd-&gt;bi_arch_number;</span><br><span class="line">	<span class="type">char</span> *s;</span><br><span class="line">	<span class="type">void</span> (*kernel_entry)(<span class="type">int</span> zero, <span class="type">int</span> arch, uint params);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r2;</span><br><span class="line">	<span class="type">int</span> fake = (flag &amp; BOOTM_STATE_OS_FAKE_GO);</span><br><span class="line"></span><br><span class="line">	kernel_entry = (<span class="type">void</span> (*)(<span class="type">int</span>, <span class="type">int</span>, uint))images-&gt;ep;</span><br><span class="line"></span><br><span class="line">	s = getenv(<span class="string">&quot;machid&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (s) &#123;</span><br><span class="line">		<span class="keyword">if</span> (strict_strtoul(s, <span class="number">16</span>, &amp;machid) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			debug(<span class="string">&quot;strict_strtoul failed!\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Using machid 0x%lx from environment\n&quot;</span>, machid);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	debug(<span class="string">&quot;## Transferring control to Linux (at address %08lx)&quot;</span> \</span><br><span class="line">		<span class="string">&quot;...\n&quot;</span>, (ulong) kernel_entry);</span><br><span class="line">	bootstage_mark(BOOTSTAGE_ID_RUN_OS);</span><br><span class="line">	announce_and_cleanup(fake);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IMAGE_ENABLE_OF_LIBFDT &amp;&amp; images-&gt;ft_len)</span><br><span class="line">		r2 = (<span class="type">unsigned</span> <span class="type">long</span>)images-&gt;ft_addr;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		r2 = gd-&gt;bd-&gt;bi_boot_params;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!fake) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARMV7_NONSEC</span></span><br><span class="line">			kernel_entry(<span class="number">0</span>, machid, r2);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>变量 machid 保存机器 ID，如果不使用设备树的话这个机器 ID 会被传递给 Linux 内核，Linux 内核会在自己的机器 ID 列表里面查找是否存在与 uboot 传递进来的 machid 匹配的项目，如果存在就说明 Linux 内核支持这个机器，那么 Linux 就会启动！如<strong>果使用设备树的话这个 machid 就无效了</strong>，设备树存有一个“兼容性”这个属性，Linux 内核会比较“兼容性”属性的值(字符串)来查看是否支持这个机器。</p>
</li>
<li>
<p>kernel_entry 函数是进入 Linux 内核，三个参数 zero、arch 和 params，arch 为机器 ID，第三个参数为 ATAGS 或者设备树首地址，ATAGS 是传统的方法，用于传递一些命令行信息。</p>
</li>
<li>
<p>函数 kernel_entry 并不是 uboot 定义的，而是 Linux 内核定义的，Linux 内核镜像文件的第一行代码就是函数 kernel_entry，而 images-&gt;ep 保存着 Linux 内核镜像的起始地址，起始地址保存的正是 Linux 内核第一行代码。<strong>kernel_entry 函数进入内核后，uboot 的使命就完成了。</strong></p>
</li>
</ul>
<p>函数 announce_and_cleanup 来打印一些信息并做一些清理工作，此函数文件 <code>arch/arm/lib/bootm.c</code> 中定义，</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="obito.top">Obito</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.obito.top/2024/07/29/U-Boot%E7%9F%A5%E8%AF%86%E6%89%AB%E7%9B%B2/">http://www.obito.top/2024/07/29/U-Boot知识扫盲/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.obito.top" target="_blank">Obito Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/background.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/08/11/Linux-V4L2-USB-Camera/" title="Linux-V4L2-USB-Camera"><img class="cover" src="/img/background.jpg" onerror="onerror=null;src='/img/error.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux-V4L2-USB-Camera</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/22/%E4%BD%BF%E7%94%A8EMQX%E6%90%AD%E5%BB%BAMQTT%E6%9C%8D%E5%8A%A1%E5%99%A8/" title="使用EMQX搭建MQTT服务器"><img class="cover" src="/img/scenery_01.webp" onerror="onerror=null;src='/img/error.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">使用EMQX搭建MQTT服务器</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/null'" alt="avatar"/></div><div class="author-info__name">Obito</div><div class="author-info__description">保持初心</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">49</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/OBITOoaoa"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#u-boot%E7%9F%A5%E8%AF%86%E6%89%AB%E7%9B%B2"><span class="toc-text">U-Boot知识扫盲</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E8%A8%80"><span class="toc-text">序言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u-boot-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">U-Boot 是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u-boot-%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95%E8%A7%A3%E6%9E%90"><span class="toc-text">U-Boot 源码目录解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u-boot-%E9%A1%B6%E5%B1%82-makefile-%E5%88%86%E6%9E%90"><span class="toc-text">U-Boot 顶层 Makefile 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E9%87%8D%E8%A6%81%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-text">一些重要的变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-text">版本号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#makeflags"><span class="toc-text">MAKEFLAGS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%BE%93%E5%87%BA"><span class="toc-text">命令输出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%99%E9%BB%98%E8%BE%93%E5%87%BA"><span class="toc-text">静默输出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u-boot-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-text">U-Boot 启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%9A%84%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86"><span class="toc-text">重定位的相关知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E5%99%A8%E5%92%8C%E9%93%BE%E6%8E%A5%E8%84%9A%E6%9C%AC"><span class="toc-text">链接器和链接脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5%E8%84%9A%E6%9C%AC-u-boot-lds"><span class="toc-text">链接脚本 u-boot.lds</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u-boot-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-text">U-Boot 启动流程详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#lowlevel-init-%E5%87%BD%E6%95%B0"><span class="toc-text">lowlevel_init 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#board-init-f-%E5%87%BD%E6%95%B0"><span class="toc-text">board_init_f 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#relocate-code-%E5%87%BD%E6%95%B0"><span class="toc-text">relocate_code 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#relocate-vectors-%E5%87%BD%E6%95%B0"><span class="toc-text">relocate_vectors 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#board-init-r-%E5%87%BD%E6%95%B0"><span class="toc-text">board_init_r 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#run-main-loop-%E5%87%BD%E6%95%B0"><span class="toc-text">run_main_loop 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#command-process-%E5%87%BD%E6%95%B0"><span class="toc-text">command_process 函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#u-boot-%E5%90%AF%E5%8A%A8-linux-%E5%86%85%E6%A0%B8%E8%BF%87%E7%A8%8B"><span class="toc-text">U-Boot 启动 Linux 内核过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bootz-%E5%90%AF%E5%8A%A8-linux-%E5%86%85%E6%A0%B8%E8%BF%87%E7%A8%8B"><span class="toc-text">bootz 启动 Linux 内核过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#do-bootz-%E5%87%BD%E6%95%B0"><span class="toc-text">do_bootz 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bootz-start-%E5%87%BD%E6%95%B0"><span class="toc-text">bootz_start 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bootz-setup-%E5%87%BD%E6%95%B0"><span class="toc-text">bootz_setup 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bootm-find-images-%E5%87%BD%E6%95%B0"><span class="toc-text">bootm_find_images 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#do-bootm-states-%E5%87%BD%E6%95%B0"><span class="toc-text">do_bootm_states 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bootm-os-get-boot-func-%E5%87%BD%E6%95%B0"><span class="toc-text">bootm_os_get_boot_func 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#do-bootm-linux-%E5%87%BD%E6%95%B0"><span class="toc-text">do_bootm_linux 函数</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/background.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Obito</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa-solid fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa-solid fa-arrow-rotate-right"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa-solid fa-arrow-right"></i></a><a class="rightMenu-item" id="menu-radompage" href="javascript:window.location.href = window.location.origin;"><i class="fa-solid fa-house"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa-solid fa-copy"></i><span>复制</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchDarkMode();"><i class="fa-solid fa-circle-half-stroke"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:toRandomPost();"><i class="fa-solid fa-bus"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa-solid fa-book"></i><span>阅读模式</span></a><a class="rightMenu-item" href="javascript:window.location.href = window.location.origin + '/archives/';"><i class="fa-solid fa-archive"></i><span>文章归档</span></a><a class="rightMenu-item" href="javascript:window.location.href = window.location.origin + '/categories/';"><i class="fa-solid fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item" href="javascript:window.location.href = window.location.origin + '/tags/';"><i class="fa-solid fa-tags"></i><span>文章标签</span></a><a class="rightMenu-item" href="javascript:window.location.href = window.location.origin + '/about-website/';"><i class="fa-solid fa-envelope-open-text"></i><span>网站声明</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.obito.top/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.obito.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.textContent = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('/pluginsSrc/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><canvas id="universe"></canvas><script src="/js/universe.js"></script><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script src="/js/rightmenu.js"></script><script async src="/js/fps.js"></script><script src="/random.js"></script><script id="click-heart" src="/pluginsSrc/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script src="/pluginsSrc/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = 'b16a1fa0e63c46a4b8f28abfb06ae3fe';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><!-- hexo injector body_end end --></body></html>